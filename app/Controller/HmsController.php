<?php
App::import('Helper', 'Currency');
class HmsController extends AppController {
var $helpers = array('Html', 'Form','Js','Number','Currency');

public $components = array(
'Paginator',
'Session','Cookie','RequestHandler'
);
var $name = 'Hms';


function member_search(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
}

function member_search_ajax($value=null,$field=null){
	$this->layout=null;
	if(!empty($value) and !empty($field)){ 
		$search=new MongoRegex("/^$value/i");
		if($field=="name"){
			$search=new MongoRegex("/$value/i");
			$conditions=array("user_name"=>$search,"active"=>"yes");
		}
		if($field=="email"){
			$conditions=array("email"=>$search,"active"=>"yes");
		}
		if($field=="mobile"){
			$conditions=array("mobile"=>$search,"active"=>"yes");
		}
		//pr($conditions);
		$this->loadmodel("user");
		$result_user=$this->user->find("all",array("conditions"=>$conditions));
	
		$arranged_users=array();
		foreach($result_user as $data){
			
			$user_id=(int)$data['user']['user_id'];
			$society_id=(int)@$data['user']['society_id'];
			$user_name=$data["user"]["user_name"];
			$user_type=$data["user"]["user_type"];
			$mobile=$data["user"]["mobile"];
			$email=$data["user"]["email"];
			$validation_status=@$data["user"]["validation_status"];
			
			if(is_array($society_id)){
				$society_id=$society_id[0];
			}else{
				$society_id;
			}

			$society_name=$this->requestAction(array('controller' => 'Fns', 'action' => 'society_name_via_society_id'), array('pass' => array($society_id)));

			
		if($user_type=="member" or $user_type=="family_member"){
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id_and_society_id'),array('pass'=>array($user_id,$society_id)));
			$flats=array(); 
			
			foreach($user_flat_info as $user_flat){
				 $user_flat_id=$user_flat["user_flat"]["user_flat_id"];
				$wing=$user_flat["user_flat"]["wing"];
				$flat=$user_flat["user_flat"]["flat"];
				$owner=@$user_flat["user_flat"]["owner"];
				$exited=$user_flat["user_flat"]["exited"];
				if($exited=="no"){
					$this->loadmodel('wing');
					$conditions=array("wing_id"=>$wing);
					$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
					$wing_name=@$wing_info[0]["wing"]["wing_name"];
					
					$this->loadmodel('flat');
					$conditions=array("flat_id"=>$flat);
					$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
					$flat_name=ltrim(@$flat_info[0]["flat"]["flat_name"],'0');
					$flats[$user_flat_id]=$wing_name.' - '.$flat_name;
									
				}
				
			} 
		}else{
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id_and_society_id'),array('pass'=>array($user_id,$society_id)));
			$user_flat_id=@$user_flat_info[0]["user_flat"]["user_flat_id"];
			$flats=array();
			}
		
			
		$this->loadmodel('user_role');
		$conditions=array("user_id"=>$user_id,"society_id"=>$society_id);
		$user_role_info=$this->user_role->find('all',array('conditions'=>$conditions));
		$roles=array();
		foreach($user_role_info as $user_role){
			$role_id=$user_role["user_role"]["role_id"];
			
			$this->loadmodel('role');
			$conditions=array("role_id"=>$role_id);
			$role_info=$this->role->find('all',array('conditions'=>$conditions));
			$roles[]=$role_info[0]["role"]["role_name"];
			
		}
		$roles=implode(',',$roles);
		
		$arranged_users[$user_id]=array("user_name"=>$user_name,"wing_flat"=>$flats,"roles"=>$roles,"mobile"=>$mobile,"email"=>$email,"validation_status"=>$validation_status,"society_name"=>$society_name,"user_flat_id"=>$user_flat_id);	
				
		}
		
		
		$this->set(compact('arranged_users'));
		
	}
}

function bank_reconciliation(){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$this->loadmodel("ledger_sub_account");
	$conditions=array("society_id"=>$s_society_id,"ledger_id"=>33);
    $result_ledger_sub_account=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
	$this->set(compact('result_ledger_sub_account'));
	
	
	if(isset($this->request->data['submit'])){
		
		 $deposit_amounts=$this->request->data['deposit_amount'];
		 
		 $bank_names=$this->request->data['bank_name'];
		 $passbook_dates=$this->request->data['passbook_date'];
		 $cheque_numbers=$this->request->data['cheque_number'];
		 $withdraw_amounts=$this->request->data['withdraw_amount'];
		 $narrations=$this->request->data['narration'];
		
		 $i=0;
		 foreach($passbook_dates as $passbook_date){ 
			  $amount_credit=null;$amount_debit=null; $transection_type="";
			  $passbook_date=date('Y-m-d',strtotime($passbook_date));
			  $passbook_date=strtotime($passbook_date);
			  $bank_name=(int)$bank_names[$i];
			  $cheque_number=$cheque_numbers[$i];
			  $deposit_amount=$deposit_amounts[$i];
			  $withdraw_amount=$withdraw_amounts[$i];
			  $narration=$narrations[$i];
			  
			 if(!empty($deposit_amount) and empty($withdraw_amount)){
				 $amount_credit=$deposit_amount; 
				 $transection_type='Deposit';
			 }elseif(empty($deposit_amount) and !empty($withdraw_amount)){
				 $amount_debit=$withdraw_amount;
				 $transection_type='Withdraw';
			  }
			  			 
				$this->loadmodel('bank_reconciliation');
				$auto_id=$this->autoincrement('bank_reconciliation','auto_id');
				$this->bank_reconciliation->saveAll(Array( Array("auto_id" => $auto_id, "transection_type" => $transection_type,"society_id" => $s_society_id, "transaction_date" => $passbook_date, "cheque_number" =>$cheque_number,"narration" =>$narration,"ledger_sub_account_id"=>$bank_name,'table_name'=>'reconciliation','flag'=>2,'credit'=>@$amount_credit,'debit'=>@$amount_debit))); 
			$i++;	
		 }
		 
    	
	}
	
	
}

function bank_reconciliation_submit(){
	$this->layout=null;	
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	 $deposit_amounts=$this->request->data['deposit_amount'];
		 
		 $bank_names=$this->request->data['bank_name'];
		 $passbook_dates=$this->request->data['passbook_date'];
		 $cheque_numbers=$this->request->data['cheque_number'];
		 $withdraw_amounts=$this->request->data['withdraw_amount'];
		 $narrations=$this->request->data['narration'];
		
		 $i=0;
		 foreach($passbook_dates as $passbook_date){ 
			  $amount_credit=null;$amount_debit=null; $transection_type="";
			  $passbook_date=date('Y-m-d',strtotime($passbook_date));
			  $passbook_date=strtotime($passbook_date);
			  $bank_name=(int)$bank_names[$i];
			  $cheque_number=$cheque_numbers[$i];
			  $deposit_amount=$deposit_amounts[$i];
			  $withdraw_amount=$withdraw_amounts[$i];
			  $narration=$narrations[$i];
			  
			 if(!empty($deposit_amount) and empty($withdraw_amount)){
				 $amount_credit=$deposit_amount; 
				 $transection_type='Deposit';
			 }elseif(empty($deposit_amount) and !empty($withdraw_amount)){
				 $amount_debit=$withdraw_amount;
				 $transection_type='Withdraw';
			  }
			  			 
				$this->loadmodel('bank_reconciliation');
				$auto_id=$this->autoincrement('bank_reconciliation','auto_id');
				$this->bank_reconciliation->saveAll(Array( Array("auto_id" => $auto_id, "transection_type" => $transection_type,"society_id" => $s_society_id, "transaction_date" => $passbook_date, "cheque_number" =>$cheque_number,"narration" =>$narration,"ledger_sub_account_id"=>$bank_name,'table_name'=>'reconciliation','flag'=>2,'credit'=>@$amount_credit,'debit'=>@$amount_debit))); 
			$i++;	
		 } 
		echo"ok"; 
	
}


function bank_reconciliation_ajax($ledger_sub_ac_id=null,$to=null){
		$this->layout="blank";	
		$this->ath();
		//$from = date("Y-m-d",strtotime($from));
		$to = date("Y-m-d",strtotime($to));
	    $s_society_id = $this->Session->read('hm_society_id');
		
		$this->loadmodel("ledger_sub_account");
		$conditions=array("society_id"=>$s_society_id,"ledger_id"=>33);
		$result_ledger_sub_account=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
		$this->set(compact('result_ledger_sub_account'));
		
		
	    $this->loadmodel('ledger');
		//$conditions=array('society_id'=>$s_society_id,"ledger_account_id"=>33,"ledger_sub_account_id"=>(int)$ledger_sub_ac_id,'transaction_date'=>array('$gte'=>strtotime($from),'$lte'=>strtotime($to)));
		
		$conditions=array('society_id'=>$s_society_id,"ledger_account_id"=>33,
		"ledger_sub_account_id"=>(int)$ledger_sub_ac_id,
		'transaction_date'=>array('$lte'=>strtotime($to)));
		
		$order=array('ledger.transaction_date'=>'ASC');
		$result_ledger=$this->ledger->find('all',array('conditions'=>$conditions,'order'=>$order));
		
		foreach($result_ledger as $data){
			$transaction_date=$data['ledger']['transaction_date'];
			$debit=$data['ledger']['debit'];
			$credit=$data['ledger']['credit'];
			$table_name=$data['ledger']['table_name'];
			$element_id=(int)$data['ledger']['element_id'];
			$this->loadmodel('bank_reconciliation');
			$conditions=array('society_id'=>$s_society_id,"ledger_account_id"=>33,"ledger_sub_account_id"=>(int)$ledger_sub_ac_id,'transaction_date'=>$transaction_date,'element_id'=>$element_id);
		     $count=$this->bank_reconciliation->find('count',array('conditions'=>$conditions)); 
			if($count==0){
				$this->loadmodel('bank_reconciliation');
				$auto_id=$this->autoincrement('bank_reconciliation','auto_id');
				$this->bank_reconciliation->saveAll(Array( Array("auto_id" => $auto_id, "table_name" => $table_name,"society_id" => $s_society_id, "transaction_date" => $transaction_date, "credit" =>$credit,"debit" =>$debit,"element_id" =>$element_id,"flag"=>0,"ledger_account_id"=>33,"ledger_sub_account_id"=>(int)$ledger_sub_ac_id))); 
			}
			
		}
		
		$this->loadmodel('bank_reconciliation');
		$conditions=array('society_id'=>$s_society_id,"ledger_account_id"=>33,
		"ledger_sub_account_id"=>(int)$ledger_sub_ac_id,"flag"=>0,
		'transaction_date'=>array('$lte'=>strtotime($to)));
		
		//$conditions=array('society_id'=>$s_society_id,"ledger_account_id"=>33,"ledger_sub_account_id"=>(int)$ledger_sub_ac_id,"flag"=>0,'transaction_date'=>array('$gte'=>strtotime($from),'$lte'=>strtotime($to)));
		
		$order=array('bank_reconciliation.transaction_date'=>'ASC');
		$result_bank_reconciliation=$this->bank_reconciliation->find('all',array('conditions'=>$conditions,'order'=>$order));
		$this->set(compact('result_bank_reconciliation'));
	
}

function bank_reconciliation_update($auto_id=null,$date=null){
	$this->layout=null;
	$this->loadmodel('bank_reconciliation');
	$this->bank_reconciliation->updateAll(array("pass_book_date"=>$date,"flag"=>1),array("auto_id"=>(int)$auto_id));
	echo "done";
}

function reconciliation_match_report(){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	
	$s_society_id = $this->Session->read('hm_society_id');
	$this->loadmodel("ledger_sub_account");
	$conditions=array("society_id"=>$s_society_id,"ledger_id"=>33);
    $result_ledger_sub_account=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
	$this->set(compact('result_ledger_sub_account'));
	
}


function reconciliation_match_report_ajax($from=null,$to=null,$ledger_sub_account_id=null){
	
	    $this->ath();
	    $s_society_id = $this->Session->read('hm_society_id');
		$this->loadmodel('bank_reconciliation');
		$conditions=array('society_id'=>$s_society_id,"flag"=>1,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'transaction_date'=>array('$gte'=>strtotime($from),'$lte'=>strtotime($to)));
		$order=array('bank_reconciliation.transaction_date'=>'ASC');
		$result_bank_reconciliation=$this->bank_reconciliation->find('all',array('conditions'=>$conditions,'order'=>$order));
		$this->set(compact('result_bank_reconciliation'));
	
}

function reconciliation_form(){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	
	$s_society_id = $this->Session->read('hm_society_id');
	$this->loadmodel("ledger_sub_account");
	$conditions=array("society_id"=>$s_society_id,"ledger_id"=>33);
    $result_ledger_sub_account=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
	$this->set(compact('result_ledger_sub_account'));
	
	
	if(isset($this->request->data['submit'])){
		/*
		 $deposit_amounts=$this->request->data['deposit_amount'];
		 
		 $bank_names=$this->request->data['bank_name'];
		 $passbook_dates=$this->request->data['passbook_date'];
		 $cheque_numbers=$this->request->data['cheque_number'];
		 $withdraw_amounts=$this->request->data['withdraw_amount'];
		 $narrations=$this->request->data['narration'];
		
		 $i=0;
		 foreach($passbook_dates as $passbook_date){ 
			  $amount_credit=null;$amount_debit=null; $transection_type="";
			  $passbook_date=date('Y-m-d',strtotime($passbook_date));
			  $passbook_date=strtotime($passbook_date);
			  $bank_name=(int)$bank_names[$i];
			  $cheque_number=$cheque_numbers[$i];
			  $deposit_amount=$deposit_amounts[$i];
			  $withdraw_amount=$withdraw_amounts[$i];
			  $narration=$narrations[$i];
			  
			 if(!empty($deposit_amount) and empty($withdraw_amount)){
				 $amount_credit=$deposit_amount; 
				 $transection_type='Deposit';
			 }elseif(empty($deposit_amount) and !empty($withdraw_amount)){
				 $amount_debit=$withdraw_amount;
				 $transection_type='Withdraw';
			  }
			  			 
				$this->loadmodel('bank_reconciliation');
				$auto_id=$this->autoincrement('bank_reconciliation','auto_id');
				$this->bank_reconciliation->saveAll(Array( Array("auto_id" => $auto_id, "transection_type" => $transection_type,"society_id" => $s_society_id, "transaction_date" => $passbook_date, "cheque_number" =>$cheque_number,"narration" =>$narration,"ledger_sub_account_id"=>$bank_name,'table_name'=>'reconciliation','flag'=>2,'credit'=>@$amount_credit,'debit'=>@$amount_debit))); 
			$i++;	
		 }
		 
    	*/
	}

}

function reconciliation_report(){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$this->loadmodel("ledger_sub_account");
	$conditions=array("society_id"=>$s_society_id,"ledger_id"=>33);
    $result_ledger_sub_account=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
	$this->set(compact('result_ledger_sub_account'));
}


function reconciliation_report_ajax($ledger_sub_account_id=null,$to=null){
	
	$this->layout=null;
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	
	$this->loadmodel("ledger_sub_account");
	$conditions=array("society_id"=>$s_society_id,"ledger_id"=>33,"auto_id"=>(int)$ledger_sub_account_id);
    $result_ledger_sub=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
	$bank_name=$result_ledger_sub[0]['ledger_sub_account']['name'];
	
	$this->loadmodel("society");
	$conditions=array("society_id"=>$s_society_id);
    $result_society=$this->society->find('all',array('conditions'=>$conditions));
	$society_name=$result_society[0]['society']['society_name'];
	$this->set(compact('society_name'));
	$this->set(compact('bank_name'));
	$this->set(compact('to'));
	
	$debit=0;$credit=0;
	$this->loadmodel('ledger');
	$conditions=array("society_id"=>$s_society_id,"ledger_account_id"=>33,"ledger_sub_account_id"=>(int)$ledger_sub_account_id,'transaction_date'=>array('$lte'=>strtotime($to)));
    $result_ledger=$this->ledger->find('all',array('conditions'=>$conditions));
	foreach($result_ledger as $data){
		$debit+=$data['ledger']['debit'];
		$credit+=$data['ledger']['credit'];
	}
	$closing_balance= $debit-$credit;
	$this->set(compact('closing_balance'));
	
		$this->loadmodel('bank_reconciliation');
	
		//$conditions =array( '$or' => array(array('society_id'=>$s_society_id,"flag"=>0,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'transaction_date'=>array('$gte'=>strtotime($from),'$lte'=>strtotime($to))),array('society_id'=>$s_society_id,"flag"=>2,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'transaction_date'=>array('$gte'=>strtotime($from),'$lte'=>strtotime($to)))));
		//$order=array('bank_reconciliation.transaction_date'=>'ASC');
		//$result_bank_reconciliation=$this->bank_reconciliation->find('all',array('conditions'=>$conditions));
				
		$conditions =array( '$or' => array(array('society_id'=>$s_society_id,"flag"=>0,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'credit'=>null,'transaction_date'=>array('$lte'=>strtotime($to))),array('society_id'=>$s_society_id,"flag"=>2,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'credit'=>null,'transaction_date'=>array('$lte'=>strtotime($to)))));
		$order=array('bank_reconciliation.transaction_date'=>'ASC');
		$result_bank_reconciliation_debit=$this->bank_reconciliation->find('all',array('conditions'=>$conditions));
		
		
		$conditions =array( '$or' => array(array('society_id'=>$s_society_id,"flag"=>0,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'debit'=>null,'transaction_date'=>array('$lte'=>strtotime($to))),array('society_id'=>$s_society_id,"flag"=>2,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'debit'=>null,'transaction_date'=>array('$lte'=>strtotime($to)))));
		$order=array('bank_reconciliation.transaction_date'=>'ASC');
		$result_bank_reconciliation_credit=$this->bank_reconciliation->find('all',array('conditions'=>$conditions));
		
		
	//	$conditions =array( '$or' => array(array('society_id'=>$s_society_id,"flag"=>0,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'transaction_date'=>array('$lte'=>strtotime($to))),array('society_id'=>$s_society_id,"flag"=>2,'ledger_sub_account_id'=>(int)$ledger_sub_account_id,'transaction_date'=>array('$lte'=>strtotime($to)))));
	//	$order=array('bank_reconciliation.transaction_date'=>'ASC');
	//	$result_bank_reconciliation=$this->bank_reconciliation->find('all',array('conditions'=>$conditions));
		
		$this->set(compact('result_bank_reconciliation_debit'));
		$this->set(compact('result_bank_reconciliation_credit'));
	
}

function auto_backup_data(){
	
  $this->layout=null;
	App::import('Vendor', 'PhpMailer', array('file' => 'phpmailer' . DS . 'class.phpmailer.php')); 

		$output1 = shell_exec('/usr/bin/mongodump --db housingmatters 2>&1');
		$output1 = shell_exec('/usr/bin/zip -r dump.zip dump 2>&1');
	
		global $error;
		
		
		$to="admin@housingmatters.in";  //admin@housingmatters.in
		$from="alerts@housingmatters.in";
		$from_name="Housingmatters";						
		$subject="Backup of database";
		$message_web="Backup of HousingMatters database";

		$file='/var/www/html/new_hm/app/webroot/dump.zip';
		
		$mail = new PHPMailer();
		$mail->IsSMTP();
		$mail->CharSet = 'UTF-8';
		$mail->SMTPAuth = true;
		$mail->SMTPSecure = 'ssl'; 
		$mail->Host = 'email-smtp.us-west-2.amazonaws.com';
		$mail->Port = 465;  
		$mail->Username = 'AKIAI7T4AF3TM3UDL2HA';  
		$mail->Password = 'AhrW2AEFouYGi1f1M3rB7tGhnsoJfr+2iU2eUuWT/hKz';
		$mail->SMTPDebug = 1; 
		$mail->From = $from;
		$mail->AddAttachment($file, 'file.zip');
		$HTML = true;	 
		$mail->WordWrap = 50; // set word wrap
		$mail->IsHTML($HTML);

		
		$mail->FromName= $from_name;

	$mail->Subject = $subject;
	$mail->Body = $message_web;
	if(!empty($reply))
	{
		$mail->AddReplyTo($reply ,"HousingMatters");
	}
	$mail->addAddress($to);
	$mail->addBCC('ankit@phppoets.com');
	$mail->addBCC('ankit.sisodiya27@gmail.com');
		if(!$mail->Send()) {
			$error = 'Mail error: '.$mail->ErrorInfo;
			return false;
		} else {
			$error = 'Message sent!';
			return true;
		}
	
	echo "Backup sent to admin@housingmatters.in";
}

function check_charecter_name($name){
$dd=explode(' ',$name);
     for($i=0;$i<sizeof($dd);$i++){
    $r=strtr($dd[$i], array('.' => '', ',' => ''));
    if(strlen($r)>2){
	return $dd[$i];
    }
	}
}

function check_sms_count($str,$member){
	
	$mem=sizeof($member);
	$value=strlen($str);
	if($value<153) { $c = 1; }
	if($value>=153 && $value<306) { $c = 2; }
	if($value>=306 && $value<=459) { $c = 3; }
	return $c*$mem;
	
}


function check_sms_allow_for_generate($sms_limit,$credit,$generate){
	
	 $total_generate=$credit+$generate;
	 $sms_limit;
	if($total_generate<=$sms_limit){
		return 'yes';
	}else{
		return 'no';
	}
	
}

function find_society_name($search=null){
	
$this->loadmodel('society'); 
$conditions=array("society_name"=> new MongoRegex('/^' . $search . '/i'));
$result_society_name=$this->society->find('all',array('conditions'=>$conditions));
	foreach($result_society_name as $data){ 
	$society_id=(int)$data['society']['society_id'];
	?>
			<li class="change_society" society="<?php echo $society_id; ?>"  style="background-color:#fff; width: 212px;background-color: #ffffff;padding: 3px 4px 8px;overflow: hidden;margin-top: -9px !important;margin-left: -24px; "><?php echo $data['society']['society_name']; ?></li>

<?php	}	
}

function regular_bill_echo(){
	$this->layout=null;
	?>
	<table border="1">
		<tr>
			<th>auto_id</th>
			<th>bill_number</th>
			<th>edit_text</th>
			<th>ledger_sub_account_id</th>
			<th>noc_charge</th>
			<th>total</th>
			<th>intrest_on_arrears</th>
			<th>credit_stock</th>
			<th>due_for_payment</th>
			<th>society_id</th>
			<th>start_date</th>
			<th>due_date</th>
			<th>end_date</th>
			<th>edited</th>
			<th>description</th>
			<th>billing_cycle</th>
			<th>created_by</th>
			<th>current_date</th>
			<th>arrear_principle</th>
			<th>arrear_intrest</th>
		</tr>
	<?php
	$this->loadmodel('new_regular_bill');
	$conditions=array("edit_status" => "NO");
	$bills = $this->new_regular_bill->find('all',array('conditions'=>$conditions));
	foreach($bills as $bill){
		$auto_id=$bill["new_regular_bill"]["auto_id"];
		$bill_no=$bill["new_regular_bill"]["bill_no"];
		$bill_no=explode('-',$bill_no);
		if(sizeof($bill_no)==2){ $edit_text="-R"; }else{ $edit_text=""; }
		
		$flat_id=(int)$bill["new_regular_bill"]["flat_id"];
			$this->loadmodel('ledger_sub_account');
			$conditions=array("flat_id" => $flat_id);
			$ledger_sub_accounts = $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
			$ledger_sub_account_id=$ledger_sub_accounts[0]['ledger_sub_account']['auto_id'];
			
		$noc_charge=$bill["new_regular_bill"]["noc_charges"];
		$total=$bill["new_regular_bill"]["total"];
		$intrest_on_arrears=$bill["new_regular_bill"]["intrest_on_arrears"];
		$credit_stock=$bill["new_regular_bill"]["credit_stock"];
		$due_for_payment=$bill["new_regular_bill"]["due_for_payment"];
		$society_id=$bill["new_regular_bill"]["society_id"];
		$society_id=$bill["new_regular_bill"]["society_id"];
		$start_date=$bill["new_regular_bill"]["bill_start_date"];
		$due_date=$bill["new_regular_bill"]["due_date"];
		$bill_end_date=$bill["new_regular_bill"]["bill_end_date"];
		$description=$bill["new_regular_bill"]["description"];
		$description=$bill["new_regular_bill"]["description"];
		$created_by=@$bill["new_regular_bill"]["created_by"];
		$current_date=@$bill["new_regular_bill"]["current_date"];
		$arrear_maintenance=@$bill["new_regular_bill"]["arrear_maintenance"];
		$arrear_intrest=@$bill["new_regular_bill"]["arrear_intrest"];
		?>
		<tr>
			<td><?php echo $auto_id; ?></td>
			<td><?php echo $bill_no[0]; ?></td>
			<td><?php echo $edit_text; ?></td>
			<td><?php echo $ledger_sub_account_id; ?></td>
			<td><?php echo $noc_charge; ?></td>
			<td><?php echo $total; ?></td>
			<td><?php echo $intrest_on_arrears; ?></td>
			<td><?php echo $credit_stock; ?></td>
			<td><?php echo $due_for_payment; ?></td>
			<td><?php echo $society_id; ?></td>
			<td><?php echo $start_date; ?></td>
			<td><?php echo $due_date; ?></td>
			<td><?php echo $bill_end_date; ?></td>
			<td>no</td>
			<td><?php echo $description; ?></td>
			<td>3</td>
			<td><?php echo $created_by; ?></td>
			<td><?php echo $current_date; ?></td>
			<td><?php echo $arrear_maintenance; ?></td>
			<td><?php echo $arrear_intrest; ?></td>
		</tr>
		<?php
	}
	?>
	</table>
	<?php
}

function update_regular_bills(){
	$this->layout=null;
	
	$this->loadmodel('regular_bill');
	$conditions=array("start_date" => 1459449000);
	$bills = $this->regular_bill->find('all',array('conditions'=>$conditions));
	foreach($bills as $bill){
		$auto_id=$bill["regular_bill"]["auto_id"];
		$ledger_sub_account_id=$bill["regular_bill"]["ledger_sub_account_id"];
		
		$this->loadmodel('ledger');
		$conditions=array('transaction_date'=>array('$lt'=>1459449000),'ledger_sub_account_id'=>$ledger_sub_account_id);
		$ledger_result = $this->ledger->find('all',array('conditions'=>$conditions));
		$total_maint=0;
		$total_non_maint=0;
		$total_interest=0;
		$total_receipt=0;
		foreach($ledger_result as $data){
			$debit=$data["ledger"]["debit"];
			$credit=$data["ledger"]["credit"];
			$table_name=$data["ledger"]["table_name"];
			$intrest_on_arrears=@$data["ledger"]["intrest_on_arrears"];
			if(($table_name=="regular_bill" and $intrest_on_arrears!="YES") or ($table_name=="opening_balance" and $intrest_on_arrears!="YES")){
				$total_maint+=$debit-$credit;
			}
			if(($table_name=="regular_bill" and $intrest_on_arrears=="YES") or ($table_name=="opening_balance" and $intrest_on_arrears=="YES")){
				$total_interest+=$debit-$credit;
			}
			if($table_name=="supplimentry_bill" or $table_name=="journal"){
				$total_non_maint+=$debit-$credit;
			}
			if($table_name=="cash_bank"){
				$total_receipt+=$debit-$credit;
			}
		}
		$total_receipt=abs($total_receipt);
		if($total_non_maint<0){
			$total_non_maint=abs($total_non_maint);
			$reminder=$total_non_maint-$total_interest;
			if($reminder<=0){
				$total_non_maint=0;
				$total_interest=abs($reminder);
			}else{
				$total_non_maint=abs($reminder);
				$total_interest=0;
				
				$reminder=$total_non_maint-$total_maint;
				if($reminder<=0){
					$total_non_maint=0;
					$total_maint=abs($reminder);
				}else{
					$total_non_maint=abs($reminder);
					$total_maint=0;
					
					$total_receipt=$total_receipt+$reminder;
				}
			}
		}
		
		$reminder=$total_receipt-$total_non_maint;
		if($reminder<=0){
			$total_receipt=0;
			$total_non_maint=abs($reminder);
		}else{
			$total_non_maint=0;
			$total_receipt=abs($reminder);
			
			$reminder=$total_receipt-$total_interest;
			if($reminder<=0){
				$total_receipt=0;
				$total_interest=abs($reminder);
			}else{
				$total_interest=0;
				$total_receipt=abs($reminder);
				
				$reminder=$total_receipt-$total_maint;
				if($reminder<=0){
					$total_receipt=0;
					$total_maint=abs($reminder);
				}else{
					$total_receipt=abs($reminder);
					$total_maint=0;
					
					$total_maint=-$total_receipt;
				}
			}
		}
		
		
		
		//$this->loadmodel('regular_bill');
		//$this->regular_bill->updateAll(array('maint_arrear'=>$total_maint,'non_maint_arrear'=>$total_non_maint),array('auto_id'=>(int)$auto_id));
	}
}

function cash_bank_echo(){
	$this->layout=null;
	?>
	<table border="1">
		<tr>
			<th>transaction_id</th>
			<th>source</th>
			<th>transaction_date</th>
			<th>deposited_in</th>
			<th>receipt_mode</th>
			<th>cheque_number</th>
			<th>date</th>
			<th>drown_in_which_bank</th>
			<th>branch_of_bank</th>
			<th>received_from</th>
			<th>ledger_sub_account_id</th>
			<th>amount</th>
			<th>narration</th>
			<th>society_id</th>
			<th>created_by</th>
			<th>receipt_number</th>
			<th>edit_text</th>
			<th>bill_reference</th>
			<th>created_on</th>
			<th>sundry_creditor_id</th>
			<th>invoice_reference</th>
			<th>receipt_instruction</th>
			<th>account_head</th>
			<th>tds_tax_amount</th>
			<th>account_type</th>
		</tr>
	<?php
	$this->loadmodel('new_cash_bank');
	
	$receipts = $this->new_cash_bank->find('all');
	foreach($receipts as $receipt){
		$transaction_id=$receipt["new_cash_bank"]["transaction_id"];
		$receipt_source=(int)$receipt["new_cash_bank"]["receipt_source"];
		$amount=$receipt["new_cash_bank"]["amount"];
		$narration=@$receipt["new_cash_bank"]["narration"];
		$society_id=(int)$receipt["new_cash_bank"]["society_id"];
		$created_by=(int)@$receipt["new_cash_bank"]["prepaired_by"];
		$receipt_id=$receipt["new_cash_bank"]["receipt_id"];
		$receipt_id=explode('-',$receipt_id);
		if(sizeof($receipt_id)==2){ $edit_text="-R"; }else{ $edit_text=""; }
		$current_date=$receipt["new_cash_bank"]["current_date"];
		
		if($receipt_source==1){
			$source="bank_receipt";
			$transaction_date=(int)$receipt["new_cash_bank"]["receipt_date"];
			$deposited_in=(int)$receipt["new_cash_bank"]["deposited_bank_id"];
			$receipt_mode=strtolower($receipt["new_cash_bank"]["receipt_mode"]);
			$cheque_number=$receipt["new_cash_bank"]["cheque_number"];
			$cheque_date=$receipt["new_cash_bank"]["cheque_date"];
			$drown_in_which_bank=@$receipt["new_cash_bank"]["drawn_on_which_bank"];
			$bank_branch=@$receipt["new_cash_bank"]["bank_branch"];
			$member_type=(int)$receipt["new_cash_bank"]["member_type"];
			
			$edit_status=$receipt["new_cash_bank"]["edit_status"];
			if($edit_status=="YES"){
				continue;
			}
			
			if($member_type==1){
				$received_from="residential";
			}
			if($member_type==2){
				$received_from="non_residential";
			}
			$flat_id=(int)$receipt["new_cash_bank"]["flat_id"];
			
			$this->loadmodel('ledger_sub_account');
			$conditions=array("flat_id" => $flat_id);
			$ledger_sub_accounts = $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
			$ledger_sub_account_id=$ledger_sub_accounts[0]['ledger_sub_account']['auto_id'];
			
			$bill_reference=@$receipt["new_cash_bank"]["bill_reference"];
			$sundry_creditor_id="";
			$invoice_reference="";
			$receipt_instruction="";
			$account_head="";
			$tds_tax_amount="";
			$account_type="";
		}
		if($receipt_source==2){
			$source="bank_payment";
			$transaction_date=(int)$receipt["new_cash_bank"]["transaction_date"];
			$deposited_in="";
			$receipt_mode=strtolower($receipt["new_cash_bank"]["receipt_mode"]);
			$cheque_number="";
			$cheque_date="";
			$drown_in_which_bank="";
			$bank_branch="";
			$received_from="";
			$ledger_sub_account_id="";
			$bill_reference="";
			$sundry_creditor_id=$receipt["new_cash_bank"]["user_id"];
			$invoice_reference=$receipt["new_cash_bank"]["invoice_reference"];
			$receipt_instruction=$receipt["new_cash_bank"]["receipt_instruction"];
			$account_head=$receipt["new_cash_bank"]["account_head"];
			$tds_tax_amount=$receipt["new_cash_bank"]["tds_tax_amount"];
			$account_type=$receipt["new_cash_bank"]["account_type"];
		}
		if($receipt_source==3){$source="petty_cash_receipt";}
		if($receipt_source==4){
			$source="petty_cash_payment";
			$transaction_date=(int)$receipt["new_cash_bank"]["transaction_date"];
			$deposited_in="";
			$receipt_mode="";
			$cheque_number="";
			$cheque_date="";
			$drown_in_which_bank="";
			$bank_branch="";
			$received_from="";
			$ledger_sub_account_id="";
			$bill_reference="";
			$sundry_creditor_id=$receipt["new_cash_bank"]["user_id"];
			$invoice_reference="";
			$receipt_instruction="";
			$account_head=$receipt["new_cash_bank"]["account_head"];
			$tds_tax_amount="";
			$account_type=$receipt["new_cash_bank"]["account_type"];
		}
		?>
		<tr>
			<td><?php echo $transaction_id; ?></td>
			<td><?php echo $source; ?></td>
			<td><?php echo $transaction_date; ?></td>
			<td><?php echo $deposited_in; ?></td>
			<td><?php echo $receipt_mode; ?></td>
			<td><?php echo $cheque_number; ?></td>
			<td><?php echo $cheque_date; ?></td>
			<td><?php echo $drown_in_which_bank; ?></td>
			<td><?php echo $bank_branch; ?></td>
			<td><?php echo $received_from; ?></td>
			<td><?php echo $ledger_sub_account_id; ?></td>
			<td><?php echo $amount; ?></td>
			<td><?php echo $narration; ?></td>
			<td><?php echo $society_id; ?></td>
			<td><?php echo $created_by; ?></td>
			<td><?php echo $receipt_id[0]; ?></td>
			<td><?php echo $edit_text; ?></td>
			<td><?php echo $bill_reference; ?></td>
			<td><?php echo $current_date; ?></td>
			<td><?php echo $sundry_creditor_id; ?></td>
			<td><?php echo $invoice_reference; ?></td>
			<td><?php echo $receipt_instruction; ?></td>
			<td><?php echo $account_head; ?></td>
			<td><?php echo $tds_tax_amount; ?></td>
			<td><?php echo $account_type; ?></td>
		</tr>
		<?php
	}
	?>
	</table>
	<?php
}

function change_role_member(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id = (int)$this->Session->read('hm_user_id');
	
	$result_user_role=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_all_role_via_user_id'), array('pass' => array($s_user_id)));
	$this->set(compact('result_user_role'));
	
		if($this->request->is('post')){
			
			$auto_id= (int)$this->request->data['role_change'];
			$this->loadmodel('user_role');
			$this->user_role->updateAll(array("default"=>""),array("user_id"=>$s_user_id,"society_id"=>$s_society_id));
			$this->user_role->updateAll(array("default"=>"yes"),array("auto_id"=>$auto_id));
			
			$this->loadmodel('user_role');
			$result_user_roles=$this->user_role->find('all',array('conditions'=>array('auto_id'=>$auto_id)));
			$role_id=$result_user_roles[0]['user_role']['role_id'];
			$this->Session->write('role_id', $role_id);
			$this->redirect(array('action' => 'dashboard'));
		}
	
}



function unit_configuration_sample(){
	
	$this->layout="";
	$filename="unit_configuration_import";
	header ("Expires: 0");
	header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
	header ("Cache-Control: no-cache, must-revalidate");
	header ("Pragma: no-cache");
	header ("Content-type: application/vnd.ms-excel");
	header ("Content-Disposition: attachment; filename=".$filename.".csv");
	header ("Content-Description: Generated Report" );
	$s_society_id = (int)$this->Session->read('hm_society_id');
	
	$excel = "Wing,Flat Number,Flat Type,Flat Area (Sq. Ft.) \n";
				
		$flat_type=""; $flat_area="";
		$this->loadmodel('wing');
        $condition=array('society_id'=>$s_society_id);
        $order=array('wing.wing_name'=>'ASC');
        $wings=$this->wing->find('all',array('conditions'=>$condition,'order'=>$order));
        foreach($wings as $data){
            $wing_id=$data["wing"]["wing_id"];
			$wing_name=$data["wing"]["wing_name"];
            $this->loadmodel('flat');
            $condition=array('society_id'=>$s_society_id,'wing_id'=>$wing_id);
            $order=array('flat.flat_name'=>'ASC');
            $flats=$this->flat->find('all',array('conditions'=>$condition,'order'=>$order));
            foreach($flats as $data2){
                $flat_id=$data2["flat"]["flat_id"];
				$flat_name=$data2["flat"]["flat_name"];
				
				$excel.= "$wing_name,$flat_name,$flat_type,$flat_area\n";
			}
		}
		echo $excel;
	
}

function unit_configuration_excel(){
	
	$this->layout="";
	$filename="unit_configuration_import";
	header ("Expires: 0");
	header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
	header ("Cache-Control: no-cache, must-revalidate");
	header ("Pragma: no-cache");
	header ("Content-type: application/vnd.ms-excel");
	header ("Content-Disposition: attachment; filename=".$filename.".csv");
	header ("Content-Description: Generated Report" );
	$s_society_id = (int)$this->Session->read('hm_society_id');
	
	$excel = "Wing,Flat Number,Flat Type,Flat Area (Sq. Ft.) \n";
				
		$flat_type=""; $flat_area="";
		$this->loadmodel('wing');
        $condition=array('society_id'=>$s_society_id);
        $order=array('wing.wing_name'=>'ASC');
        $wings=$this->wing->find('all',array('conditions'=>$condition,'order'=>$order));
        foreach($wings as $data){
            $wing_id=$data["wing"]["wing_id"];
			$wing_name=$data["wing"]["wing_name"];
            $this->loadmodel('flat');
            $condition=array('society_id'=>$s_society_id,'wing_id'=>$wing_id);
            $order=array('flat.flat_name'=>'ASC');
            $flats=$this->flat->find('all',array('conditions'=>$condition,'order'=>$order));
				foreach($flats as $data2){
					$flat_id=$data2["flat"]["flat_id"];
					$flat_name=$data2["flat"]["flat_name"];
					$flat_type_id=(int)$data2["flat"]["flat_type_id"];
					$flat_area=$data2["flat"]["flat_area"];
					$result_flat_name = $this->requestAction(array('controller' => 'Fns', 'action' => 'flat_type_name_via_flat_type_id'),array('pass'=>array($flat_type_id)));
					
					$excel.= "$wing_name,$flat_name,$result_flat_name,$flat_area\n";
				}
		}
		echo $excel;
	
}


function cancel_unit_configuration(){

	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$this->loadmodel('unit_configuration_csv_converted');
	$conditions4=array('society_id'=>$s_society_id);
	$this->unit_configuration_csv_converted->deleteAll($conditions4);

	$this->loadmodel('unit_configuration_info_csv');
	$conditions4=array('society_id'=>$s_society_id);
	$this->unit_configuration_info_csv->deleteAll($conditions4);

	$this->loadmodel('import_unit_configuration_record');
	$conditions4=array("society_id" => $s_society_id, "module_name" => "UC");
	$this->import_unit_configuration_record->deleteAll($conditions4);
	echo"ok";
	
}



function unit_configuration_import(){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->loadmodel('import_unit_configuration_record');
	$conditions=array("society_id" => $s_society_id,"module_name" => "UC");
	$import_unit_configuration_record = $this->import_unit_configuration_record->find('all',array('conditions'=>$conditions));
	$this->set('result_import_record',$import_unit_configuration_record);
	
	foreach($import_unit_configuration_record as $data_import){
		$step1=(int)@$data_import["import_unit_configuration_record"]["step1"];
		$step2=(int)@$data_import["import_unit_configuration_record"]["step2"];
		$step3=(int)@$data_import["import_unit_configuration_record"]["step3"];
		$step4=(int)@$data_import["import_unit_configuration_record"]["step4"];
	}
		$process_status= @$step1+@$step2+@$step3+@$step4;
	if(@$process_status==2){
			$this->loadmodel('unit_configuration_info_csv');
			$conditions=array("society_id" => $s_society_id,"is_converted" => "YES");
			$total_converted_records = $this->unit_configuration_info_csv->find('count',array('conditions'=>$conditions));
			
			$this->loadmodel('unit_configuration_info_csv');
			$conditions=array("society_id" => $s_society_id);
			$total_records = $this->unit_configuration_info_csv->find('count',array('conditions'=>$conditions));
			
			$this->set("converted_per",($total_converted_records*100)/$total_records);
		}
		
		
		if(@$process_status==4){
			$this->loadmodel('unit_configuration_csv_converted');
			$conditions=array("society_id" => $s_society_id,"is_imported" => "YES");
			$total_converted_records = $this->unit_configuration_csv_converted->find('count',array('conditions'=>$conditions));
			
			$this->loadmodel('unit_configuration_csv_converted');
			$conditions=array("society_id" => $s_society_id);
			$total_records = $this->unit_configuration_csv_converted->find('count',array('conditions'=>$conditions));
			
			$this->set("converted_per_im",($total_converted_records*100)/$total_records);
		}
	
}

function Upload_unit_configuration_csv_file(){
	
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id'); 
	$this->ath();
	if(isset($_FILES['file'])){
	
		$file_name=$s_society_id.".csv";
		$file_tmp_name =$_FILES['file']['tmp_name'];
		$target = "unit_configuration/";
		$target=@$target.basename($file_name);
		move_uploaded_file($file_tmp_name,@$target);
		
		
		$today = date("d-M-Y");
		
		$this->loadmodel('import_unit_configuration_record');
		$auto_id=$this->autoincrement('import_unit_configuration_record','auto_id');
		$this->import_unit_configuration_record->saveAll(Array( Array("auto_id" => $auto_id, "file_name" => $file_name,"society_id" => $s_society_id, "user_id" => $s_user_id, "module_name" => "UC", "step1" => 1,"date"=>$today))); 
		
		die(json_encode("UPLOADED"));
		
	}
	
	
}


function read_unit_configuration_csv(){
	
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$f = fopen('unit_configuration/'.$s_society_id.'.csv', 'r') or die("ERROR OPENING DATA");
	$batchcount=0;
	$records=0;
	while (($line = fgetcsv($f, 4096, ';')) !== false) {
	$numcols = count($line);
	$test[]=$line;
	++$records;
	}
	$i=0;

	foreach($test as $child){ $i++;
			if($i>1){
				$child_ar=explode(',',$child[0]);
				$wing_name=$child_ar[0];
				$flat_name=$child_ar[1];
				$flat_type=$child_ar[2];
				$flat_area=$child_ar[3];
				$flat_name=str_pad($flat_name,10,"0",STR_PAD_LEFT);
				$this->loadmodel('unit_configuration_info_csv');
				$auto_id=$this->autoincrement('unit_configuration_info_csv','auto_id');
				$this->unit_configuration_info_csv->saveAll(Array(Array("auto_id" => $auto_id, "wing_name" => $wing_name, "flat_name" => $flat_name, "flat_type" => $flat_type, "flat_area" => $flat_area,"society_id"=>$s_society_id,"is_converted"=>"NO")));
			}
	}
		$this->loadmodel('import_unit_configuration_record');
		$this->import_unit_configuration_record->updateAll(array("step2" => 1),array("society_id" => $s_society_id));
		die(json_encode("READ"));
	
}

function convert_unit_configuration_info_data(){
	
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$this->loadmodel('unit_configuration_info_csv');
	$conditions=array("society_id" => $s_society_id,"is_converted" => "NO");
	$result_import_record = $this->unit_configuration_info_csv->find('all',array('conditions'=>$conditions,'limit'=>10));
		foreach($result_import_record as $import_record){
					$user_info_csv_id=$import_record["unit_configuration_info_csv"]["auto_id"];
					$flat_type=trim($import_record["unit_configuration_info_csv"]["flat_type"]);
					$wing_name=trim($import_record["unit_configuration_info_csv"]["wing_name"]);
					$flat_name=trim($import_record["unit_configuration_info_csv"]["flat_name"]);
					$flat_area=$import_record["unit_configuration_info_csv"]["flat_area"];
					$this->loadmodel('wing'); 
					$conditions=array("wing_name"=> new MongoRegex('/^' . $wing_name . '$/i'),"society_id"=>$s_society_id);
					$result_ac=$this->wing->find('all',array('conditions'=>$conditions));
					if(sizeof($result_ac)>0){
						foreach($result_ac as $collection){
							$wing_id = (int)$collection['wing']['wing_id'];
						}
					}else{
						$wing_id=0;
					}
						
	
					$this->loadmodel('flat'); 
					$conditions=array("flat_name"=> new MongoRegex('/^' . $flat_name . '$/i'),"society_id"=>$s_society_id,"wing_id"=>$wing_id);
					$result_ac_flat=$this->flat->find('all',array('conditions'=>$conditions));
					if(sizeof($result_ac_flat)>0){
						foreach($result_ac_flat as $collection){
							$flat_id = (int)$collection['flat']['flat_id'];
						}
					}else{
						$flat_id=0;
					}
					
					$this->loadmodel('flat_type_name'); 
					$conditions=array("flat_name"=> new MongoRegex('/^' . $flat_type . '$/i'));
					$result_ac_flat_type=$this->flat_type_name->find('all',array('conditions'=>$conditions));
					if(sizeof($result_ac_flat_type)>0){
						foreach($result_ac_flat_type as $collection){
							$flat_type_id = (int)$collection['flat_type_name']['auto_id'];
						}
					}else{
						$flat_type_id=0;
					}
				

				$this->loadmodel('unit_configuration_csv_converted');
				$auto_id=$this->autoincrement('unit_configuration_csv_converted','auto_id');
				$this->unit_configuration_csv_converted->saveAll(Array( Array("auto_id" => $auto_id,"society_id" => $s_society_id, "flat_area" => $flat_area,"flat_type"=>$flat_type_id,"wing"=>$wing_id,"flat"=>$flat_id,"is_imported"=>"NO"))); 		

				$this->loadmodel('unit_configuration_info_csv');
				$this->unit_configuration_info_csv->updateAll(array("is_converted" => "YES"),array("auto_id" => $user_info_csv_id));				
					
		}
		
				$this->loadmodel('unit_configuration_info_csv');
				$conditions=array("society_id" => $s_society_id,"is_converted" => "YES");
				$total_converted_records = $this->unit_configuration_info_csv->find('count',array('conditions'=>$conditions));

				$this->loadmodel('unit_configuration_info_csv');
				$conditions=array("society_id" => $s_society_id);
				$total_records = $this->unit_configuration_info_csv->find('count',array('conditions'=>$conditions));

				$converted_per=($total_converted_records*100)/$total_records;
				if($converted_per==100){ $again_call_ajax="NO"; 
					$this->loadmodel('import_unit_configuration_record');
					$this->import_unit_configuration_record->updateAll(array("step3" => 1),array("society_id" => $s_society_id, "module_name" => "UC"));
				}else{
					$again_call_ajax="YES"; 

				}
				die(json_encode(array("again_call_ajax"=>$again_call_ajax,"converted_per"=>$converted_per)));
	
	
}

function modify_unit_configuration_csv($page=null){
	
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$this->ath();
	
	
	$s_society_id = $this->Session->read('hm_society_id'); 
	$page=(int)$page;
	$this->set('page',$page);
	
	$this->loadmodel('import_unit_configuration_record');
	$conditions=array("society_id" => $s_society_id,"module_name" => "UC");
	$import_unit_configuration_record = $this->import_unit_configuration_record->find('all',array('conditions'=>$conditions));
	$this->set('result_import_record',$import_unit_configuration_record);
	foreach($import_unit_configuration_record as $data_import){
		$step1=(int)@$data_import["import_unit_configuration_record"]["step1"];
		$step2=(int)@$data_import["import_unit_configuration_record"]["step2"];
		$step3=(int)@$data_import["import_unit_configuration_record"]["step3"];
		
	}
	$process_status= @$step1+@$step2+@$step3;
	
	if($process_status==3){
		$this->loadmodel('unit_configuration_csv_converted'); 
		$conditions=array("society_id"=>(int)$s_society_id);
		$unit_configuration_csv_converted=$this->unit_configuration_csv_converted->find('all',array('conditions'=>$conditions,"limit"=>50,"page"=>$page));
		$this->set('unit_configuration_csv_converted',$unit_configuration_csv_converted);
		
		$this->loadmodel('unit_configuration_csv_converted'); 
		$conditions=array("society_id"=>(int)$s_society_id);
		$count_user_enrollment_csv_converted=$this->unit_configuration_csv_converted->find('count',array('conditions'=>$conditions));
		$this->set('count_user_enrollment_csv_converted',$count_user_enrollment_csv_converted);
	}
	
		$this->loadmodel('wing');
		$condition=array('society_id'=>$s_society_id);
		$order=array('wing.wing_name'=>'ASC');
		$result_wing=$this->wing->find('all',array('conditions'=>$condition,'order'=>$order));
		foreach($result_wing as $data){
			$wing_name=$data['wing']['wing_name'];
			$wing_id=(int)$data['wing']['wing_id'];
			
			$this->loadmodel('flat');
			$conditions=array("wing_id" => $wing_id,'society_id'=>$s_society_id);
			$order=array('flat.flat_name'=> 'ASC');
			$result_flat=$this->flat->find('all',array('conditions'=>$conditions,'order' =>$order));
			foreach($result_flat as $data){
				$flat_name=$data['flat']['flat_name'];
				$flat_name=ltrim($flat_name,'0');
				$flat_id=$data['flat']['flat_id'];
				$flat_set[$wing_id.','.$flat_id]=$wing_name.'-'.$flat_name;
			}
		}
		
		$this->set('flat_set',$flat_set);
		$this->loadmodel('flat_type_name'); 

		$result_flat_type=$this->flat_type_name->find('all');
		$this->set(compact('result_flat_type'));
}


function auto_save_unit_configuration($record_id=null,$field=null,$value=null){
		
	$this->layout=null;

	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$record_id=(int)$record_id; 

		if($field=="flat_area"){
			if(empty($value)){ echo "F";}
			else{
				
					if (!is_numeric($value)) {
							echo "F";
						
						}else{
							$this->loadmodel('unit_configuration_csv_converted');
							$this->unit_configuration_csv_converted->updateAll(array("flat_area" => $value),array("auto_id" => $record_id));
							echo "T";
					}	
			}
		}	
	
		if($field=="flat"){
			
			$wing_flat=explode(',',$value);
			$wing_id=(int)$wing_flat[0];
			$flat_id=(int)$wing_flat[1];
			$this->loadmodel('unit_configuration_csv_converted');
			$this->unit_configuration_csv_converted->updateAll(array("wing" => $wing_id,"flat"=>$flat_id),array("auto_id" => $record_id));
			$conditions=array('wing'=>$wing_id,"flat"=>$flat_id,"society_id"=>$s_society_id);
			$count=$this->unit_configuration_csv_converted->find('count',array('conditions'=>$conditions));
			if($count==2){
				echo "F";
			}else{
				echo "T";
			}
		}
		
		if($field=="flat_type"){
			
			if(empty($value)){ echo "F";}
			else{
				$this->loadmodel('unit_configuration_csv_converted');
				$this->unit_configuration_csv_converted->updateAll(array("flat_type" => $value),array("auto_id" => $record_id));
				echo "T";
			}
		}	
	
}


function allow_unit_configuration(){
	
		$this->layout=null;
	
		$this->ath();
		$s_society_id = $this->Session->read('hm_society_id'); 
		
		$this->loadmodel('import_unit_configuration_record');
		$this->import_unit_configuration_record->updateAll(array("step4" => 1),array("society_id" => $s_society_id, "module_name" => "UC"));
		echo "T"; die;
	
	
	
}

function delete_unit_configuration_row($record_id=null){
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->loadmodel('unit_configuration_csv_converted');
	$conditions4=array("auto_id" => (int)$record_id);
	$this->unit_configuration_csv_converted->deleteAll($conditions4);
	
	
	
}


function final_import_unit_configuration(){
	
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->loadmodel('import_unit_configuration_record');
	$conditions=array("society_id" => $s_society_id,"module_name" => "UC");
	$import_unit_configuration_record = $this->import_unit_configuration_record->find('all',array('conditions'=>$conditions));
	
	foreach($import_unit_configuration_record as $data_import){
		$step1=(int)@$data_import["import_unit_configuration_record"]["step1"];
		$step2=(int)@$data_import["import_unit_configuration_record"]["step2"];
		$step3=(int)@$data_import["import_unit_configuration_record"]["step3"];
		$step4=(int)@$data_import["import_unit_configuration_record"]["step4"];
	}
		$process_status= @$step1+@$step2+@$step3+@$step4;
		if($process_status==4){
			
					$this->loadmodel('unit_configuration_csv_converted');
					$conditions=array("society_id"=>(int)$s_society_id,"is_imported" => "NO");
					$unit_configuration_csv_converted=$this->unit_configuration_csv_converted->find('all',array('conditions'=>$conditions,'limit'=>10));
					foreach($unit_configuration_csv_converted as $unit_configuration_csv_converted){ 
					$auto_id=$unit_configuration_csv_converted["unit_configuration_csv_converted"]["auto_id"];
					$flat_area=$unit_configuration_csv_converted["unit_configuration_csv_converted"]["flat_area"];
					$flat_type=(int)$unit_configuration_csv_converted["unit_configuration_csv_converted"]["flat_type"];
					$wing=(int)$unit_configuration_csv_converted["unit_configuration_csv_converted"]["wing"];
					$flat=(int)$unit_configuration_csv_converted["unit_configuration_csv_converted"]["flat"];
			
					$this->loadmodel('flat');
					$this->flat->updateAll(array("flat_area"=>$flat_area,"flat_type_id"=>$flat_type),array("flat_id"=>$flat,"society_id"=>$s_society_id));
					$this->loadmodel('unit_configuration_csv_converted');
					$this->unit_configuration_csv_converted->updateAll(array("is_imported" => "YES"),array("auto_id" => $auto_id));
			
				}
				$this->loadmodel('unit_configuration_csv_converted');
				$conditions=array("society_id" => $s_society_id,"is_imported" => "YES");
				$total_converted_records = $this->unit_configuration_csv_converted->find('count',array('conditions'=>$conditions));

				$this->loadmodel('unit_configuration_csv_converted');
				$conditions=array("society_id" => $s_society_id);
				$total_records = $this->unit_configuration_csv_converted->find('count',array('conditions'=>$conditions));
				$converted_per=($total_converted_records*100)/$total_records;
				if($converted_per==100){ $again_call_ajax="NO"; 

						$this->loadmodel('unit_configuration_csv_converted');
						$conditions4=array('society_id'=>$s_society_id);
						$this->unit_configuration_csv_converted->deleteAll($conditions4);

						$this->loadmodel('unit_configuration_info_csv');
						$conditions4=array('society_id'=>$s_society_id);
						$this->unit_configuration_info_csv->deleteAll($conditions4);

						$this->loadmodel('import_unit_configuration_record');
						$conditions4=array("society_id" => $s_society_id, "module_name" => "UC");
						$this->import_unit_configuration_record->deleteAll($conditions4);
				}else{
						$again_call_ajax="YES"; 
				}

				die(json_encode(array("again_call_ajax"=>$again_call_ajax,"converted_per_im"=>$converted_per)));

				
		}
}
function import_user_enrollment(){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->loadmodel('import_user_enrollment_record');
	$conditions=array("society_id" => $s_society_id,"module_name" => "UE");
	$import_user_enrollment_record = $this->import_user_enrollment_record->find('all',array('conditions'=>$conditions));
	$this->set('result_import_record',$import_user_enrollment_record);
	foreach($import_user_enrollment_record as $data_import){
		$step1=(int)@$data_import["import_user_enrollment_record"]["step1"];
		$step2=(int)@$data_import["import_user_enrollment_record"]["step2"];
		$step3=(int)@$data_import["import_user_enrollment_record"]["step3"];
		$step4=(int)@$data_import["import_user_enrollment_record"]["step4"];
	}
		$process_status= @$step1+@$step2+@$step3+@$step4;
		
		if(@$process_status==2){
			$this->loadmodel('user_enrollment_info_csv');
			$conditions=array("society_id" => $s_society_id,"is_converted" => "YES");
			$total_converted_records = $this->user_enrollment_info_csv->find('count',array('conditions'=>$conditions));
			
			$this->loadmodel('user_enrollment_info_csv');
			$conditions=array("society_id" => $s_society_id);
			$total_records = $this->user_enrollment_info_csv->find('count',array('conditions'=>$conditions));
			
			$this->set("converted_per",($total_converted_records*100)/$total_records);
		}
		
		if(@$process_status==4){
			$this->loadmodel('user_enrollment_csv_converted');
			$conditions=array("society_id" => $s_society_id,"is_imported" => "YES");
			$total_converted_records = $this->user_enrollment_csv_converted->find('count',array('conditions'=>$conditions));
			
			$this->loadmodel('user_enrollment_csv_converted');
			$conditions=array("society_id" => $s_society_id);
			$total_records = $this->user_enrollment_csv_converted->find('count',array('conditions'=>$conditions));
			
			$this->set("converted_per_im",($total_converted_records*100)/$total_records);
		}
	
}

function Upload_user_enrollment_csv_file(){
	
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->ath();
	if(isset($_FILES['file'])){
		
		$file_name=$s_society_id.".csv";
		$file_tmp_name =$_FILES['file']['tmp_name'];
		$target = "new_user_enrollment_csv/";
		$target=@$target.basename($file_name);
		move_uploaded_file($file_tmp_name,@$target);
		
		
		$today = date("d-M-Y");
		
		$this->loadmodel('import_user_enrollment_record');
		$auto_id=$this->autoincrement('import_user_enrollment_record','auto_id');
		$this->import_user_enrollment_record->saveAll(Array( Array("auto_id" => $auto_id, "file_name" => $file_name,"society_id" => $s_society_id, "user_id" => $s_user_id, "module_name" => "UE", "step1" => 1,"date"=>$today))); 
		
		die(json_encode("UPLOADED"));
		
	}
	
}

function read_user_enrollment_csv(){
	
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$f = fopen('new_user_enrollment_csv/'.$s_society_id.'.csv', 'r') or die("ERROR OPENING DATA");
	$batchcount=0;
	$records=0;
	while (($line = fgetcsv($f, 4096, ';')) !== false) {
	$numcols = count($line);
	$test[]=$line;
	++$records;
	}
	$i=0;
	foreach($test as $child){ $i++;
			if($i>1){
				$child_ar=explode(',',$child[0]);
				$name=$child_ar[0];
				$wing_name=$child_ar[1];
				$flat_name=$child_ar[2];
				$email=$child_ar[3];
				$mobile=$child_ar[4];
				$owner_tenant=$child_ar[5];
				$committee=$child_ar[6];
				$flat_name=str_pad($flat_name,10,"0",STR_PAD_LEFT);
				$this->loadmodel('user_enrollment_info_csv');
				$auto_id=$this->autoincrement('user_enrollment_info_csv','auto_id');
				$this->user_enrollment_info_csv->saveAll(Array(Array("auto_id" => $auto_id, "name" => $name,"wing_name" => $wing_name, "flat_name" => $flat_name, "owner_tenant" => $owner_tenant, "email" => $email, "mobile" => $mobile,"society_id"=>$s_society_id,"committee"=>$committee,"is_converted"=>"NO")));
			}
	}
		$this->loadmodel('import_user_enrollment_record');
		$this->import_user_enrollment_record->updateAll(array("step2" => 1),array("society_id" => $s_society_id));
		die(json_encode("READ"));
	
}

function convert_user_enrollment_info_data(){
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$this->loadmodel('user_enrollment_info_csv');
	$conditions=array("society_id" => $s_society_id,"is_converted" => "NO");
	$result_import_record = $this->user_enrollment_info_csv->find('all',array('conditions'=>$conditions,'limit'=>10));
		foreach($result_import_record as $import_record){
		$user_info_csv_id=$import_record["user_enrollment_info_csv"]["auto_id"];
		$name=trim($import_record["user_enrollment_info_csv"]["name"]);
		$wing_name=trim($import_record["user_enrollment_info_csv"]["wing_name"]);
		$flat_name=trim($import_record["user_enrollment_info_csv"]["flat_name"]);
		$owner_tenant=trim($import_record["user_enrollment_info_csv"]["owner_tenant"]);
		$committee=trim($import_record["user_enrollment_info_csv"]["committee"]);
		$email=trim($import_record["user_enrollment_info_csv"]["email"]);
		$mobile=trim($import_record["user_enrollment_info_csv"]["mobile"]);
		
				$committee=strtolower($committee);
				$owner_tenant=strtolower($owner_tenant);
				$this->loadmodel('wing'); 
				$conditions=array("wing_name"=> new MongoRegex('/^' . $wing_name . '$/i'),"society_id"=>$s_society_id);
				$result_ac=$this->wing->find('all',array('conditions'=>$conditions));
				if(sizeof($result_ac)>0){
					foreach($result_ac as $collection){
						$wing_id = (int)$collection['wing']['wing_id'];
					}
				}else{
					$wing_id=0;
				}
	
	
					$this->loadmodel('flat'); 
					$conditions=array("flat_name"=> new MongoRegex('/^' . $flat_name . '$/i'),"society_id"=>$s_society_id,"wing_id"=>$wing_id);
					$result_ac_flat=$this->flat->find('all',array('conditions'=>$conditions));
					if(sizeof($result_ac_flat)>0){
						foreach($result_ac_flat as $collection){
							$flat_id = (int)$collection['flat']['flat_id'];
						}
					}else{
						$flat_id=0;
					}
				
					$this->loadmodel('user_enrollment_csv_converted');
					$auto_id=$this->autoincrement('user_enrollment_csv_converted','auto_id');
					$this->user_enrollment_csv_converted->saveAll(Array( Array("auto_id" => $auto_id, "name" => $name,"society_id" => $s_society_id, "email" => $email, "mobile" => $mobile,"owner"=>$owner_tenant,"committee"=>$committee,"wing"=>$wing_id,"flat"=>$flat_id,"is_imported"=>"NO"))); 		
				
			$this->loadmodel('user_enrollment_info_csv');
			$this->user_enrollment_info_csv->updateAll(array("is_converted" => "YES"),array("auto_id" => $user_info_csv_id));
		}
		
				$this->loadmodel('user_enrollment_info_csv');
				$conditions=array("society_id" => $s_society_id,"is_converted" => "YES");
				$total_converted_records = $this->user_enrollment_info_csv->find('count',array('conditions'=>$conditions));

				$this->loadmodel('user_enrollment_info_csv');
				$conditions=array("society_id" => $s_society_id);
				$total_records = $this->user_enrollment_info_csv->find('count',array('conditions'=>$conditions));

				$converted_per=($total_converted_records*100)/$total_records;
				if($converted_per==100){ $again_call_ajax="NO"; 
					$this->loadmodel('import_user_enrollment_record');
					$this->import_user_enrollment_record->updateAll(array("step3" => 1),array("society_id" => $s_society_id, "module_name" => "UE"));
				}else{
					$again_call_ajax="YES"; 

				}
				die(json_encode(array("again_call_ajax"=>$again_call_ajax,"converted_per"=>$converted_per)));
}



function modify_user_enrollment_csv($page=null){
	
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$this->ath();
	
	
	$s_society_id = $this->Session->read('hm_society_id'); 
	$page=(int)$page;
	$this->set('page',$page);
	
	$this->loadmodel('import_user_enrollment_record');
	$conditions=array("society_id" => $s_society_id,"module_name" => "UE");
	$import_user_enrollment_record = $this->import_user_enrollment_record->find('all',array('conditions'=>$conditions));
	$this->set('result_import_record',$import_user_enrollment_record);
	foreach($import_user_enrollment_record as $data_import){
		$step1=(int)@$data_import["import_user_enrollment_record"]["step1"];
		$step2=(int)@$data_import["import_user_enrollment_record"]["step2"];
		$step3=(int)@$data_import["import_user_enrollment_record"]["step3"];
		
	}
	$process_status= @$step1+@$step2+@$step3;
	
	if($process_status==3){
		$this->loadmodel('user_enrollment_csv_converted'); 
		$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
		$conditions=array("society_id"=>(int)$s_society_id);
		$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,"limit"=>50,"page"=>$page,'order' =>$order));
		$this->set('user_enrollment_csv_converted',$user_enrollment_csv_converted);
		
		$this->loadmodel('user_enrollment_csv_converted'); 
		$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
		$conditions=array("society_id"=>(int)$s_society_id);
		$count_user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('count',array('conditions'=>$conditions,'order' =>$order));
		$this->set('count_user_enrollment_csv_converted',$count_user_enrollment_csv_converted);
	}
		$this->loadmodel('wing');
		$condition=array('society_id'=>$s_society_id);
		$order=array('wing.wing_name'=>'ASC');
		$result_wing=$this->wing->find('all',array('conditions'=>$condition,'order'=>$order));
		foreach($result_wing as $data){
			$wing_name=$data['wing']['wing_name'];
			$wing_id=(int)$data['wing']['wing_id'];
			
			$this->loadmodel('flat');
			$conditions=array("wing_id" => $wing_id,'society_id'=>$s_society_id);
			$order=array('flat.flat_name'=> 'ASC');
			$result_flat=$this->flat->find('all',array('conditions'=>$conditions,'order' =>$order));
			foreach($result_flat as $data){
				$flat_name=$data['flat']['flat_name'];
				$flat_name=ltrim($flat_name,'0');
				$flat_id=$data['flat']['flat_id'];
				$flat_set[$wing_id.','.$flat_id]=$wing_name.'-'.$flat_name;
			}
		}
		
		$this->set('flat_set',$flat_set);
	
}


function check_user_enrollment_validation($page=null){
	
	$this->layout=null;
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id'); 
	$page=(int)$page;
	
		$this->loadmodel('user_enrollment_csv_converted'); 
		$conditions=array("society_id"=>(int)$s_society_id);
		$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,"limit"=>50,"page"=>$page));
	 foreach($user_enrollment_csv_converted as $user_enrollment_converted){ 
		$auto_id=$user_enrollment_converted["user_enrollment_csv_converted"]["auto_id"];
		$name=$user_enrollment_converted["user_enrollment_csv_converted"]["name"];
		$wing=(int)$user_enrollment_converted["user_enrollment_csv_converted"]["wing"];
		$email=$user_enrollment_converted["user_enrollment_csv_converted"]["email"];
		$mobile=$user_enrollment_converted["user_enrollment_csv_converted"]["mobile"];
		 $owner=$user_enrollment_converted["user_enrollment_csv_converted"]["owner"];
		 $committee=$user_enrollment_converted["user_enrollment_csv_converted"]["committee"];
		$flat=(int)$user_enrollment_converted["user_enrollment_csv_converted"]["flat"];
		if(empty($name)){ $name_v=1;   }else{  $name_v=0; }
		if(empty($flat)){ $flat_v=1;   }else{  $flat_v=0; }
		
		
		if(!filter_var($email, FILTER_VALIDATE_EMAIL) && !empty($email)) { $email_v=1; 
		}else{
			
				$this->loadmodel('user_temp');
				$conditions=array("email" => $email,'reject'=>0);
				$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
				$n3 = sizeof($result3);
				$this->loadmodel('user');
				$conditions=array("email" => $email);
				$result4 = $this->user->find('all',array('conditions'=>$conditions));
				$n4 = sizeof($result4);
				$e=$n3+$n4;
				if($e>0){
					$email_v=1;
				}else{ $email_v=0; }
		}
		
			if(!preg_match ( '/^\\d{10}$/',$mobile) && !empty($mobile)) {
				$mobile_v=1;
			}else{
					$this->loadmodel('user_temp');
					$conditions=array("mobile" => $mobile,'reject'=>0);
					$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
					$n3 = sizeof($result3);
					$this->loadmodel('user');
					$conditions=array("mobile" => $mobile,'user_id'=>array('$ne'=>1));
					$result4 = $this->user->find('all',array('conditions'=>$conditions));
					$n4 = sizeof($result4);
					$e=$n3+$n4;
					if($e>0){
						$mobile_v=1;
					}else{ $mobile_v=0; }
			}
		
	}
	
}

function auto_save_user_enrollment($record_id=null,$field=null,$value=null){
	
	$this->layout=null;

	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$record_id=(int)$record_id; 

		if($field=="name"){
				$this->loadmodel('user_enrollment_csv_converted');
				$this->user_enrollment_csv_converted->updateAll(array("name" => $value),array("auto_id" => $record_id));
				echo "T";
		}	
		
		if($field=="email"){
				$this->loadmodel('user_enrollment_csv_converted');
				$this->user_enrollment_csv_converted->updateAll(array("email" => $value),array("auto_id" => $record_id));
				echo "T";
		}	
		if($field=="mobile"){
				$this->loadmodel('user_enrollment_csv_converted');
				$this->user_enrollment_csv_converted->updateAll(array("mobile" => $value),array("auto_id" => $record_id));
				echo "T";
		}	
				
		if($field=="flat"){
			$wing_flat=explode(',',$value);
			$wing_id=(int)$wing_flat[0];
			$flat_id=(int)$wing_flat[1];
			$this->loadmodel('user_enrollment_csv_converted');
			$this->user_enrollment_csv_converted->updateAll(array("wing"=>$wing_id,"flat"=>$flat_id),array("auto_id"=>$record_id));
		}
		
		if($field=="owner"){
			$this->loadmodel('user_enrollment_csv_converted');
			$this->user_enrollment_csv_converted->updateAll(array("owner"=>$value),array("auto_id"=>$record_id));
			echo "T";
		}
		
		if($field=="committee"){
			$this->loadmodel('user_enrollment_csv_converted');
			$this->user_enrollment_csv_converted->updateAll(array("committee"=>$value),array("auto_id"=>$record_id));
			echo "T";
		}
	
}
//Start allow_user_enrollment// 
function allow_user_enrollment(){
	$this->layout=null;
		$this->ath();
			$s_society_id=(int)$this->Session->read('hm_society_id'); 
	$wing_flat_array=array();
	$email_array=array();
	$mobile_array=array();
	$this->loadmodel('user_enrollment_csv_converted');
	$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
	$conditions=array("society_id"=>(int)$s_society_id);
	$result_user_enrollment_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'order'=>$order));
	 foreach($result_user_enrollment_converted as $data){
		$email_idd=$data['user_enrollment_csv_converted']['email'];
		$mobile_no=$data['user_enrollment_csv_converted']['mobile'];
		$wingg=(int)$data["user_enrollment_csv_converted"]['wing'];	
        $flatt=(int)$data["user_enrollment_csv_converted"]['flat'];		
			if($email_idd==""){
				}else{
					$email_array[]=$email_idd;	
				}
					if($mobile_no==""){
					}else{
					$mobile_array[]=$mobile_no;	
					}				
			$wing_flat_array[]=array($wingg,$flatt);	
	 }	  
	
	
	 
		
	 
		
	
	
	$empty_validate=0;
	$wing_flat=0;
	$this->loadmodel('user_enrollment_csv_converted');
	$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
	$conditions=array("society_id"=>(int)$s_society_id);
	$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'order'=>$order));
	foreach($user_enrollment_csv_converted as $user_enrollment_converted){ 
		$auto_id=$user_enrollment_converted["user_enrollment_csv_converted"]["auto_id"];
		$name=$user_enrollment_converted["user_enrollment_csv_converted"]["name"];
		$wing=(int)$user_enrollment_converted["user_enrollment_csv_converted"]["wing"];
		$email=$user_enrollment_converted["user_enrollment_csv_converted"]["email"];
		$mobile=$user_enrollment_converted["user_enrollment_csv_converted"]["mobile"];
		$owner=$user_enrollment_converted["user_enrollment_csv_converted"]["owner"];
		$committee=$user_enrollment_converted["user_enrollment_csv_converted"]["committee"];
		$flat=(int)$user_enrollment_converted["user_enrollment_csv_converted"]["flat"];
		if(empty($wing) && empty($flat)){
		 $wing_flat=1;	
		}
		if(empty($name) || empty($owner)){
		$empty_validate=1;	
		}
		
		if($email==""){
		}else{
			if(!filter_var($email, FILTER_VALIDATE_EMAIL)) {
				$empty_validate=1;	
			}	
			$this->loadmodel('user');
				$result_user=$this->user->find('all');
					foreach($result_user as $data){
						$email_id=$data['user']['email'];
							if($email_id==$email){
								$empty_validate=1;	
						}					  
					}
					$n=0;
					for($k=0; $k<sizeof($email_array); $k++){
						$email_from_array=$email_array[$k];
							if($email_from_array==$email){
								$n++;
							}
						}	
						if($n>1){
							$empty_validate=1;
			}			
			}
             if($mobile=="")
			 {}else{
				
					if(is_numeric($mobile)){ 
					}else{
					$empty_validate=1;	
					} 
				
				$this->loadmodel('user');
					$result_user=$this->user->find('all');
						foreach($result_user as $dataa){
							$mobile_number=$dataa['user']['mobile'];
								if($mobile_number==$mobile){
									$empty_validate=1;
						    }					  
						}
						$m=0;
						for($x=0; $x<sizeof($mobile_array); $x++){
							$mobil_from_array=$mobile_array[$x];
								if($mobil_from_array==$mobile){
									$m++;
								}
							}	
							if($m>1){
								$empty_validate=1; 
							}		
		}
				$this->loadmodel('flat');
				$conditions=array("flat_id"=>$flat);
				$result_flat=$this->flat->find('all',array('conditions'=>$conditions));
					foreach($result_flat as $dataa){
						$flat_type=(int)$dataa['flat']['noc_ch_tp'];	
					}
						if($flat_type == 1){
							if($owner=='no'){
								$empty_validate=1; 
						}
					}
			$this->loadmodel('user_flat');
			$conditions=array("flat"=>$flat,"owner"=>array('$ne'=>null));
			$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions));
				$n4 = sizeof($result_user_flat); 
					if($n4==1){
						$tenant=$result_user_flat[0]['user_flat']['owner'];
							if($tenant=='yes'){
								if($tenant==$owner){
									$empty_validate=1; 	
								}
								}else{
									if($tenant==$owner){
										$empty_validate=1; 
									}
								}
							} 
							if($n4==2)
							{
							$empty_validate=1;	
					}
        $g=0;
		for($j=0; $j<sizeof($wing_flat_array); $j++){
	       $wing_flat_sub_array=$wing_flat_array[$j];
		   $wing_id_from_array=(int)$wing_flat_sub_array[0];
		   $flat_id_from_array=(int)$wing_flat_sub_array[1];
		   if($wing_id_from_array==$wing && $flat_id_from_array==$flat){
			 $g++;  
		   }
		}
	if($g>1){
	$empty_validate=1;		
	} 
	}		
		
$total_validation=$wing_flat+$empty_validate;	
		
if($total_validation>0){		
echo "not_validate";
}		
	$this->loadmodel('import_user_enrollment_record');
	$this->import_user_enrollment_record->updateAll(array("step4" => 1),array("society_id" => $s_society_id, "module_name" => "UE"));
			
}
//End allow_user_enrollment// 
function final_import_user_enrollment(){
	
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->loadmodel('import_user_enrollment_record');
	$conditions=array("society_id" => $s_society_id,"module_name" => "UE");
	$import_user_enrollment_record = $this->import_user_enrollment_record->find('all',array('conditions'=>$conditions));
	
	foreach($import_user_enrollment_record as $data_import){
		$step1=(int)@$data_import["import_user_enrollment_record"]["step1"];
		$step2=(int)@$data_import["import_user_enrollment_record"]["step2"];
		$step3=(int)@$data_import["import_user_enrollment_record"]["step3"];
		$step4=(int)@$data_import["import_user_enrollment_record"]["step4"];
	}
		$process_status= @$step1+@$step2+@$step3+@$step4;
		if($process_status==4){
		
			$res_society=$this->society_name($s_society_id);
			foreach($res_society as $data){
			$society_name=$data['society']['society_name'];
			$access_tenant=(int)@$data['society']['access_tenant'];

			} 
			$s_n='';
			$sco_na=$society_name;
			$dd=explode(' ',$sco_na);
			$first=$dd[0];
			@$two=$dd[1];
			@$three=$dd[2];
			$s_n.=" $first $two $three ";

			date_default_timezone_set('Asia/kolkata');
			$date=date("d-m-Y");
			$time=date('h:i:a',time());
			$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip')); 
		
		
		$this->loadmodel('user_enrollment_csv_converted');
		$conditions=array("society_id"=>(int)$s_society_id,"is_imported" => "NO");
		$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'limit'=>10));
		foreach($user_enrollment_csv_converted as $user_enrollment_converted){ 
			$auto_id=$user_enrollment_converted["user_enrollment_csv_converted"]["auto_id"];
			$name=$user_enrollment_converted["user_enrollment_csv_converted"]["name"];
			$wing=(int)$user_enrollment_converted["user_enrollment_csv_converted"]["wing"];
			$email=$user_enrollment_converted["user_enrollment_csv_converted"]["email"];
			$mobile=$user_enrollment_converted["user_enrollment_csv_converted"]["mobile"];
			$owner=strtolower($user_enrollment_converted["user_enrollment_csv_converted"]["owner"]);
			$committee_n=strtolower($user_enrollment_converted["user_enrollment_csv_converted"]["committee"]);
			$flat=(int)$user_enrollment_converted["user_enrollment_csv_converted"]["flat"];
			
				if($owner=="yes"){
					$type = "yes";
					$type_owner="Owner";
					$committee=$committee_n;
					$role_new_id=3;
					$email_content="owner/resident/staff";
				}
				else{
					$type = "no";
					$type_owner="Tenant";
					$committee="no";
					$role_new_id=4;
					$email_content="Tenant/resident/staff";
				}

				$this->loadmodel('user');
				$i=$this->autoincrement('user','user_id');
				
				$random1=mt_rand(1000000000,9999999999);
				$random2=mt_rand(1000000000,9999999999);
				$random=$random1.$random2 ;	
				$de_user_id=$this->encode($i,'housingmatters');
				$random=$de_user_id.'/'.$random;
			
	if(($access_tenant==1 && $type_owner=="Tenant") || $type_owner=="Owner"){
		if(!empty($mobile) && empty($email)){
			$r_sms=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_sms_ip')); 
			
			$working_key=$r_sms->working_key;
			$sms_sender=$r_sms->sms_sender;
			$sms_allow=(int)$r_sms->sms_allow;
			$random=(string)mt_rand(1000,9999);
			if($sms_allow==1){
				
				$user_name_short=$this->check_charecter_name($name);
				$sms="".$user_name_short.", Your housing society ".$s_n." has enrolled you in HousingMatters portal. Pls log into www.housingmatters.in One Time Password ".$random."";
				$sms1=str_replace(" ", '+', $sms);
				$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
			}
		}
	}
	
			$this->user->saveAll(array('user_id' => $i,'user_name' => $name,'email' => $email, 'password' => @$random, 'mobile' => $mobile,'society_id' => $s_society_id,'date' => $date, 'time' => $time,'signup_random'=>$random,'active'=>'yes','user_type'=>'member','profile_pic'=>'blank.jpg'));	
			
			$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
			$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>$s_society_id,'wing'=>$wing,'flat'=>$flat,'exited'=>'no','owner'=>$type));
			
			$auto_role_id=$this->autoincrement('user_role','auto_id');
			$this->user_role->saveAll(array('auto_id'=>$auto_role_id,'user_id'=>$i,'role_id'=>$role_new_id,'default'=>'yes','society_id'=>$s_society_id));
			
			if($committee=="yes"){
				$auto_role_id=$this->autoincrement('user_role','auto_id');
				$this->user_role->saveAll(array('auto_id'=>$auto_role_id,'user_id'=>$i,'role_id'=>2,'society_id'=>$s_society_id));
			}
			if($owner=="yes"){
				$this->loadmodel('ledger_sub_account');
				$j=$this->autoincrement('ledger_sub_account','auto_id');
				$this->ledger_sub_account->saveAll(array('auto_id'=>$j,'ledger_id'=>34,'name'=>$name,'society_id' => $s_society_id,'user_id'=>$i,'user_flat_id'=>$user_flat_id,'exited'=>'no'));
			}
			
			$this->loadmodel('user_enrollment_csv_converted');
			$this->user_enrollment_csv_converted->updateAll(array("is_imported" => "YES"),array("auto_id" => $auto_id));
			
			if(!empty($email) && !empty($mobile)){
				$page_name="send_sms_for_verify_mobile";
			}elseif(!empty($email) && empty($mobile)){
				$page_name="set_new_password";
			}
			
			
	$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an '.$email_content.' of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/'.@$page_name.'?q='.$random.'"> Click here </a> for one time verification of your email and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';


			$from_name="HousingMatters";
			$reply="support@housingmatters.in";
			$to=$email;
			$this->loadmodel('email');
			$conditions=array("auto_id" => 4);
			$result_email = $this->email->find('all',array('conditions'=>$conditions));
			foreach ($result_email as $collection) 
			{
			 $from=$collection['email']['from'];
			}
			 $subject="Welcome to ".$society_name." portal ";
			if(($access_tenant==1 && $type_owner=="Tenant") || $type_owner=="Owner"){
				if(!empty($email)){	
				
						$this->send_email($to,$from,$from_name,$subject,@$message_web,$reply);
					}
			}
		
				$this->loadmodel('email');	
				$conditions=array('notification_id'=>1);
				$result_email=$this->email->find('all',array('conditions'=>$conditions));
				foreach($result_email as $data){
					
					$auto_id_n = (int)$data['email']['auto_id'];
					$this->loadmodel('notification_email');
					$lo=$this->autoincrement('notification_email','notification_id');
					$this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id_n , "user_id" => $i,'chk_status'=>0));
				}
	}

		$this->loadmodel('user_enrollment_csv_converted');
		$conditions=array("society_id" => $s_society_id,"is_imported" => "YES");
		$total_converted_records = $this->user_enrollment_csv_converted->find('count',array('conditions'=>$conditions));
		
		$this->loadmodel('user_enrollment_csv_converted');
		$conditions=array("society_id" => $s_society_id);
		$total_records = $this->user_enrollment_csv_converted->find('count',array('conditions'=>$conditions));
		$converted_per=($total_converted_records*100)/$total_records;
		if($converted_per==100){ $again_call_ajax="NO"; 
			
			$this->loadmodel('user_enrollment_csv_converted');
			$conditions4=array('society_id'=>$s_society_id);
			$this->user_enrollment_csv_converted->deleteAll($conditions4);
			
			$this->loadmodel('user_enrollment_info_csv');
			$conditions4=array('society_id'=>$s_society_id);
			$this->user_enrollment_info_csv->deleteAll($conditions4);
			
			$this->loadmodel('import_user_enrollment_record');
			$conditions4=array("society_id" => $s_society_id, "module_name" => "UE");
			$this->import_user_enrollment_record->deleteAll($conditions4);
		}else{
				$again_call_ajax="YES"; 
			}
			
		die(json_encode(array("again_call_ajax"=>$again_call_ajax,"converted_per_im"=>$converted_per)));

} 
}

function cancel_user_enrollment(){
	
	$this->layout=null;
	 $s_society_id = $this->Session->read('hm_society_id');	
	
		    $this->loadmodel('user_enrollment_csv_converted');
			$conditions4=array('society_id'=>$s_society_id);
			$this->user_enrollment_csv_converted->deleteAll($conditions4);
			
			$this->loadmodel('user_enrollment_info_csv');
			$conditions4=array('society_id'=>$s_society_id);
			$this->user_enrollment_info_csv->deleteAll($conditions4);
			
			$this->loadmodel('import_user_enrollment_record');
			$conditions4=array("society_id" => $s_society_id, "module_name" => "UE");
			$this->import_user_enrollment_record->deleteAll($conditions4);
			echo"ok";
		

}

function delete_user_enrollment_row($record_id=null){
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->loadmodel('user_enrollment_csv_converted');
	$conditions4=array("auto_id" => (int)$record_id);
	$this->user_enrollment_csv_converted->deleteAll($conditions4);
	//echo "1";
	
	
}

function workflow_setting(){
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
   $s_society_id=(int)$this->Session->read('hm_society_id');	
   $this->ath();
  
if(isset($this->request->data['sub'])){
	$user=@$this->request->data['multi'];
	$this->loadmodel('society');
	$this->society->updateAll(array('help_desk_raised_ticket'=>@$user),array('society_id'=>$s_society_id));
}
   
   $this->loadmodel('society');
   $result_society=$this->society->find('all',array('conditions'=>array('society_id'=>$s_society_id)));
   $ticket_raised_by=@$result_society[0]['society']['help_desk_raised_ticket'];
   if(empty($ticket_raised_by)){ $ticket_raised_by=array(); } 
   $this->set(compact('ticket_raised_by')); 

   $this->loadmodel('user');
	$conditions2=array("society_id"=>$s_society_id,'active'=>'yes');
	$result_user=$this->user->find('all',array('conditions'=>$conditions2));
	//pr($result_user);
	
	foreach($result_user as $data){
				$user_id=$data['user']['user_id'];
				$user_name=$data['user']['user_name'];
			
				$this->loadmodel('user_flat');
				$conditions1=array("user_id"=>$user_id);
				$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions1));
				foreach($result_user_flat as $data){
							$user_flat_id=$data["user_flat"]["user_flat_id"];
							$wing=@$data["user_flat"]["wing"];
							$flat=@$data["user_flat"]["flat"];

							$this->loadmodel('wing');
							$conditions=array("wing_id"=>$wing);
							$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
							@$wing_name=$wing_info[0]["wing"]["wing_name"];

							$this->loadmodel('flat');
							$conditions=array("flat_id"=>$flat);
							$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
							@$flat_name=ltrim($flat_info[0]["flat"]["flat_name"],'0');
							$flats=$wing_name.' - '.$flat_name;
					}
				
				$this->loadmodel('user_role');
				$conditions3=array("user_id"=>$user_id,'role_id'=>2);
				$result_user_role=$this->user_role->find('all',array('conditions'=>$conditions3));
				if(!empty($result_user_role)){
						$result_users_com[]=array('user_name'=>$user_name,'wing_flat'=>$flats,'user_id'=>$user_id,'user_flat_id'=>$user_flat_id);
					}
				
	}
	
	$this->set(compact('result_users_com'));
	
}


function email_mobile_update(){
	
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
   $s_society_id=$this->Session->read('hm_society_id');	
   $this->ath();
   
		$this->loadmodel('user_info_import_record');
		$conditions=array("society_id" => $s_society_id);
		$result_import_record = $this->user_info_import_record->find('all',array('conditions'=>$conditions));
		$this->set('result_import_record',$result_import_record);
			foreach($result_import_record as $data_import){
			$step1=(int)@$data_import["user_info_import_record"]["step1"];
			$step2=(int)@$data_import["user_info_import_record"]["step2"];
			$step3=(int)@$data_import["user_info_import_record"]["step3"];
			$step4=(int)@$data_import["user_info_import_record"]["step4"];
			$date=@$data_import["user_info_import_record"]["date"];
			$this->set("date",$date);
			}
	  $process_status= @$step1+@$step2+@$step3+@$step4;
	  $this->set("process_status",$process_status);
}

function Upload_user_info_csv_file(){
	
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->ath();
	
		if(isset($_FILES['file'])){
		$file_name=$s_society_id.".csv";
		$file_tmp_name =$_FILES['file']['tmp_name'];
		$target = "user_email_mobile_csv/";
		$target=@$target.basename($file_name);
		move_uploaded_file($file_tmp_name,@$target);
		
		$today = date("d-M-Y");
		
$this->loadmodel('user_info_import_record');
$auto_id=$this->autoincrement('user_info_import_record','auto_id');
$this->user_info_import_record->saveAll(Array( Array("auto_id" => $auto_id, "file_name" => $file_name,"society_id" => $s_society_id, "user_id" => $s_user_id, "step1" => 1,"date"=>$today))); 
		
    die(json_encode("UPLOADED"));
	}
}

function read_user_info_csv_file(){
	
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	
		$f = fopen('user_email_mobile_csv/'.$s_society_id.'.csv', 'r') or die("ERROR OPENING DATA");
		$batchcount=0;
		$records=0;
		while (($line = fgetcsv($f, 4096, ';')) !== false) {
		$numcols = count($line);
		$test[]=$line;
		++$records;
		}
	
	$i=0;
	foreach($test as $child){ $i++;
			if($i>1){
				$child_ar=explode(',',$child[0]);
				$name=$child_ar[0];
				$wing_name=$child_ar[1];
				$flat_name=$child_ar[2];
				$owner_tenant=$child_ar[3];
				$email=$child_ar[4];
				$mobile=$child_ar[5];
							
				$this->loadmodel('user_info_csv');
				$auto_id=$this->autoincrement('user_info_csv','auto_id');
				$this->user_info_csv->saveAll(Array(Array("auto_id" => $auto_id, "name" => $name,"wing_name" => $wing_name, "flat_name" => $flat_name, "owner_tenant" => $owner_tenant, "email" => $email, "mobile" => $mobile,"society_id"=>$s_society_id,"is_converted"=>"NO")));
			}
	}
		$this->loadmodel('user_info_import_record');
		$this->user_info_import_record->updateAll(array("step2" => 1),array("society_id" => $s_society_id));
		die(json_encode("READ"));
}

function convert_user_info_data(){
	
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	
	$this->loadmodel('user_info_csv');
	$conditions=array("society_id" => $s_society_id,"is_converted" => "NO");
	$result_import_record = $this->user_info_csv->find('all',array('conditions'=>$conditions,'limit'=>10));
		foreach($result_import_record as $import_record){
		$user_info_csv_id=$import_record["user_info_csv"]["auto_id"];
		$name=trim($import_record["user_info_csv"]["name"]);
		$wing_name=trim($import_record["user_info_csv"]["wing_name"]);
		$flat_name=trim($import_record["user_info_csv"]["flat_name"]);
		$flat_name = str_pad($flat_name,10,"0",STR_PAD_LEFT);  

		$owner_tenant=trim($import_record["user_info_csv"]["owner_tenant"]);
		$email=trim($import_record["user_info_csv"]["email"]);
		$mobile=trim($import_record["user_info_csv"]["mobile"]);
		
				$this->loadmodel('wing'); 
				$conditions=array("wing_name"=> $wing_name,"society_id"=>$s_society_id);
				$result_ac=$this->wing->find('all',array('conditions'=>$conditions));
				if(sizeof($result_ac)>0){
				foreach($result_ac as $collection){
				 $wing_id = (int)$collection['wing']['wing_id'];
				}
				}else{
				 $wing_id=0;
				}
		
		$this->loadmodel('flat'); 
		$conditions=array("flat_name"=>$flat_name,"wing_id"=>$wing_id,"society_id"=>$s_society_id);
		$result_ac=$this->flat->find('all',array('conditions'=>$conditions));
			if(sizeof($result_ac)>0){
			foreach($result_ac as $collection){
			 $flat_id = (int)$collection['flat']['flat_id'];
			}
			}else{
			$flat_id=0;
			}
		
		if($owner_tenant=="owner"){ 
		  $tenant="yes"; 
		}elseif($owner_tenant=="tenant"){ 
		 $tenant="no";
		}else{
		 $tenant=null;
		}
		
			$this->loadmodel('user_flat'); 
			$conditions=array("wing"=>$wing_id,"flat"=>$flat_id,"owner"=>$tenant,"exited"=>"no");
			$result_user=$this->user_flat->find('all',array('conditions'=>$conditions));
			$user_id =0;
			foreach($result_user as $collection){
			$user_id = (int)$collection['user_flat']['user_id'];
			$user_flat_id = (int)$collection['user_flat']['user_flat_id'];
			}

	$emailErr = 1;
	if(!empty($email)){
	if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
	$emailErr = 0;
	}else{
	$this->loadmodel('user'); 
	$conditions=array("email"=>$email);
	$result_user_count=$this->user->find('count',array('conditions'=>$conditions));

	$this->loadmodel('user_info_csv_converted'); 
	$conditions=array("email"=>$email);
	$result_user_info_csv_converted_count=$this->user_info_csv_converted->find('count',array('conditions'=>$conditions));

	if($result_user_count>1 or $result_user_info_csv_converted_count>1){
	$emailErr = 0;
	}
	}
}

	$mobileErr = 1;
	if(!empty($mobile)){
	$mob="/([0-9]{10})/"; 
	if(!preg_match($mob, $mobile) && strlen($mobile)!=10 ) {
	$mobileErr = 0;
	}else{
		
	$this->loadmodel('user'); 
	$conditions=array("mobile"=>$mobile);
	$result_user_count=$this->user->find('count',array('conditions'=>$conditions));
				
		$this->loadmodel('user_info_csv_converted'); 
		$conditions=array("mobile"=>$mobile);
		$result_user_info_csv_converted_count=$this->user_info_csv_converted->find('count',array('conditions'=>$conditions));
		if($result_user_count>1 or $result_user_info_csv_converted_count>1){
		$mobileErr = 0;
		}
		}
}
		 
			
		$this->loadmodel('user_info_csv_converted');
		$auto_id=$this->autoincrement('user_info_csv_converted','auto_id');
		$this->user_info_csv_converted->saveAll(Array(Array("auto_id" => $auto_id,"user_id" => $user_id, "email" => $email, "mobile" => $mobile,"emailErr" => $emailErr,"mobileErr" => $mobileErr,"user_id"=>$user_id,"society_id"=>$s_society_id,"is_imported"=>"NO","user_flat_id"=>$user_flat_id)));
		
		$this->loadmodel('user_info_csv');
		$this->user_info_csv->updateAll(array("is_converted" => "YES"),array("auto_id" => $user_info_csv_id));
	}
	
	$this->loadmodel('user_info_csv');
	$conditions=array("society_id" => $s_society_id,"is_converted" => "YES");
	$total_converted_records = $this->user_info_csv->find('count',array('conditions'=>$conditions));
	
	$this->loadmodel('user_info_csv');
	$conditions=array("society_id" => $s_society_id);
	$total_records = $this->user_info_csv->find('count',array('conditions'=>$conditions));
	
	$converted_per=($total_converted_records*100)/$total_records;
	if($converted_per==100){ $again_call_ajax="NO"; 
		$this->loadmodel('user_info_import_record');
		$this->user_info_import_record->updateAll(array("step3" => 1),array("society_id" => $s_society_id));
	}else{
		$again_call_ajax="YES"; 
		}
		
	die(json_encode(array("again_call_ajax"=>$again_call_ajax,"converted_per"=>$converted_per)));
}

function check_user_info_before_submit(){
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	
	$this->loadmodel('user_info_csv_converted');
	$conditions =array( '$or' => array( 
	array('emailErr' =>0,'mobileErr' =>0),
	array('emailErr' =>1,'mobileErr' =>0),
	array('emailErr' =>0,'mobileErr' =>1)
	));
	$result_count = $this->user_info_csv_converted->find('count',array('conditions'=>$conditions));
	if($result_count==0){ 
		$this->loadmodel('user_info_import_record');
		$this->user_info_import_record->updateAll(array("step4" => 1),array("society_id" => $s_society_id));
		
		die(json_encode(true)); 
	}
}

function modify_user_info_csv_data($page=null){
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$page=(int)$page;
	$this->set('page',$page);
	
	$this->loadmodel('user_info_import_record');
	$conditions=array("society_id" => $s_society_id);
	$result_import_record = $this->user_info_import_record->find('all',array('conditions'=>$conditions));
	$this->set('result_import_record',$result_import_record);
	foreach($result_import_record as $data_import){
		$step1=(int)@$data_import["user_info_import_record"]["step1"];
		$step2=(int)@$data_import["user_info_import_record"]["step2"];
		$step3=(int)@$data_import["user_info_import_record"]["step3"];
	}
	$process_status= @$step1+@$step2+@$step3;
	if($process_status==3){
		$this->loadmodel('user_info_csv_converted'); 
		$conditions=array("society_id"=>(int)$s_society_id);
		$result_user_info_csv_converted=$this->user_info_csv_converted->find('all',array('conditions'=>$conditions,"limit"=>10,"page"=>$page));
		$this->set('result_user_info_csv_converted',$result_user_info_csv_converted);
		
		$this->loadmodel('user_info_csv_converted'); 
		$conditions=array("society_id"=>(int)$s_society_id);
		$count_user_info_csv_converted=$this->user_info_csv_converted->find('count',array('conditions'=>$conditions));
		$this->set('count_user_info_csv_converted',$count_user_info_csv_converted);
	}
	
			
}

function check_user_info_csv_validation($id=null,$field=null,$val=null){
	$this->layout=null;
	
	
		
	if($field=="email"){
		$emailErr = 1;
		$email=$val;
		
		$this->loadmodel('user_info_csv_converted');
		$this->user_info_csv_converted->updateAll(array("email" => $email),array("auto_id" => (int)$id));
		
		 if(!empty($email)){
			 if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
			   $emailErr = 0;
			 }else{
				$this->loadmodel('user'); 
				$conditions=array("email"=>$email);
				$result_user_count=$this->user->find('count',array('conditions'=>$conditions));
				
				
				
				$this->loadmodel('user_info_csv_converted'); 
				$conditions=array("email"=>$email);
				$result_user_info_csv_converted_count=$this->user_info_csv_converted->find('count',array('conditions'=>$conditions));
				
				if($result_user_count>1 or $result_user_info_csv_converted_count>1){
					 $emailErr = 0;
				}
			 }
		 }
		 
		$this->loadmodel('user_info_csv_converted');
		$this->user_info_csv_converted->updateAll(array("emailErr" => $emailErr),array("auto_id" => (int)$id));
		
		if($emailErr==0){ die(json_encode(false)); }else{ die(json_encode(true)); }
	}
	
	if($field=="mobile"){
		$mobileErr = 1;
		$mobile=$val;
		
		$this->loadmodel('user_info_csv_converted');
		$this->user_info_csv_converted->updateAll(array("mobile" => $mobile),array("auto_id" => (int)$id));
		
		 if(!empty($mobile)){
			 $mob="/([0-9]{10})/"; 
			 if(!preg_match($mob, $mobile) ) {
				 $mobileErr = 0;
			}else{
				$this->loadmodel('user'); 
				$conditions=array("mobile"=>$mobile);
				$result_user_count=$this->user->find('count',array('conditions'=>$conditions));
				
				$this->loadmodel('user_info_csv_converted'); 
				$conditions=array("mobile"=>$mobile);
				$result_user_info_csv_converted_count=$this->user_info_csv_converted->find('count',array('conditions'=>$conditions));
				
				if($result_user_count>1 or $result_user_info_csv_converted_count>1){
					 $mobileErr = 0;
				}
			}
		 }
		 
		$this->loadmodel('user_info_csv_converted');
		$this->user_info_csv_converted->updateAll(array("mobileErr" => $mobileErr),array("auto_id" => (int)$id));
		
		if($mobileErr==0){ die(json_encode(false)); }else{ die(json_encode(true));}
	}

}

function final_import_user_info_ajax(){
	$this->layout=null;
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	
	$this->loadmodel('user_info_import_record');
	$conditions=array("society_id" => $s_society_id);
	$result_import_record = $this->user_info_import_record->find('all',array('conditions'=>$conditions));
	$this->set('result_import_record',$result_import_record);
	foreach($result_import_record as $data_import){
		$step1=(int)@$data_import["user_info_import_record"]["step1"];
		$step2=(int)@$data_import["user_info_import_record"]["step2"];
		$step3=(int)@$data_import["user_info_import_record"]["step3"];
		$step4=(int)@$data_import["user_info_import_record"]["step4"];
	}
	$process_status= @$step1+@$step2+@$step3+@$step4;
	if($process_status==4){
		
		$this->loadmodel('user_info_csv_converted');
		$conditions=array("society_id" => $s_society_id,"is_imported" => "NO");
		$result_import_converted = $this->user_info_csv_converted->find('all',array('conditions'=>$conditions,'limit'=>2));
		
		foreach($result_import_converted as $data){
			
			$auto_id=$data["user_info_csv_converted"]["auto_id"];
			$user_id=$data["user_info_csv_converted"]["user_id"];
			$email=$data["user_info_csv_converted"]["email"];
			$mobile=$data["user_info_csv_converted"]["mobile"];
			
			$this->loadmodel('user');
			$conditions=array("user_id" => $user_id);
			$result_user = $this->user->find('all',array('conditions'=>$conditions));
			foreach($result_user as $data2){
				$al_email=$data2["user"]["email"];
				$al_mobile=$data2["user"]["mobile"];
			}
			
			if($email!=$al_email){
				
				$this->loadmodel('user');
				$this->user->updateAll(array("email" => $email),array("user_id" => (int)$user_id));
			}
			if($mobile!=$al_mobile){
				$this->loadmodel('user');
				$this->user->updateAll(array("mobile" => $mobile),array("user_id" => (int)$user_id));
			}
			
						
			$this->loadmodel('user_info_csv_converted');
			$this->user_info_csv_converted->updateAll(array("is_imported" => "YES"),array("auto_id" => (int)$auto_id));
			
		}
		
		
		
		$this->loadmodel('user_info_csv_converted');
		$conditions=array("society_id" => $s_society_id,"is_imported" => "YES");
		$total_converted_records = $this->user_info_csv_converted->find('count',array('conditions'=>$conditions));
		
		$this->loadmodel('user_info_csv_converted');
		$conditions=array("society_id" => $s_society_id);
		$total_records = $this->user_info_csv_converted->find('count',array('conditions'=>$conditions));
		
		$converted_per=($total_converted_records*100)/$total_records;
		
		
		if($converted_per==100){ $again_call_ajax="NO"; 
			
			$this->loadmodel('user_info_csv_converted');
			$conditions4=array('society_id'=>$s_society_id);
			$this->user_info_csv_converted->deleteAll($conditions4);
			
			$this->loadmodel('user_info_csv_converted');
			$conditions4=array('society_id'=>$s_society_id);
			$this->user_info_csv_converted->deleteAll($conditions4);
			
			$this->loadmodel('user_info_import_record');
			$conditions4=array("society_id" => $s_society_id);
			$this->user_info_import_record->deleteAll($conditions4);
		}else{
			$again_call_ajax="YES"; 
			}
		die(json_encode(array("again_call_ajax"=>$again_call_ajax,"converted_per_im"=>$converted_per)));
	}
}

function user_info_delete_row($auto_id=null){
	$this->layout=null;	
	$this->loadmodel('user_info_csv_converted');
	$this->user_info_csv_converted->deleteAll(array('auto_id'=>(int)$auto_id));
}

function user_info_delete_all(){
	$this->layout=null;
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$this->loadmodel('user_info_csv_converted');
	$this->user_info_csv_converted->deleteAll(array('society_id'=>$s_society_id));
	$this->loadmodel('user_info_csv');
	$this->user_info_csv->deleteAll(array('society_id'=>$s_society_id));
	$this->loadmodel('user_info_import_record');
	$this->user_info_import_record->deleteAll(array('society_id'=>$s_society_id));
	
	$this->redirect(array('action' => 'email_mobile_update'));
}

function email_mobile_import_file(){
	$this->layout="";
	$filename="email_mobile_import_file";
	header ("Expires: 0");
	header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
	header ("Cache-Control: no-cache, must-revalidate");
	header ("Pragma: no-cache");
	header ("Content-type: application/vnd.ms-excel");
	header ("Content-Disposition: attachment; filename=".$filename.".csv");
	header ("Content-Description: Generated Report" );

	$s_role_id=$this->Session->read('role_id');
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id = (int)$this->Session->read('hm_user_id');
	
	$output= "Name,wing,unit,owner/tenant/family member,email,mobile \n";
	
	
	$this->loadmodel('user');
	$conditions=array("society_id" => $s_society_id,"active"=>"yes");
	$order=array('user.user_name'=>'ASC');
	$result_users=$this->user->find('all',array('conditions'=>$conditions,'order'=>$order));
	
	foreach($result_users as $user_info){
		$user_name=$user_info["user"]["user_name"];
		$user_id=(int)$user_info["user"]["user_id"];
		$email=$user_info["user"]["email"];
		$mobile=$user_info["user"]["mobile"];
		$user_type=$user_info["user"]["user_type"];
		if($user_type=="member" or $user_type=="family_member"){
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'),array('pass'=>array($user_id)));
				foreach($user_flat_info as $user_flat){
					$user_flat_id=$user_flat["user_flat"]["user_flat_id"];
					$wing=$user_flat["user_flat"]["wing"];
					$flat=$user_flat["user_flat"]["flat"];
					$owner=@$user_flat["user_flat"]["owner"];
					$exited=@$user_flat["user_flat"]["exited"];
					if($exited=="no"){
					$this->loadmodel('wing');
					$conditions=array("wing_id"=>$wing);
					$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
					$wing_name=@$wing_info[0]["wing"]["wing_name"];
					
					$this->loadmodel('flat');
					$conditions=array("flat_id"=>$flat);
					$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
					$flat_name=ltrim(@$flat_info[0]["flat"]["flat_name"],'0');
				 
					if($owner=="yes"){
						$ownership="owner";
					}elseif($owner=="no"){
						$ownership="tenant";
					}else{
						$ownership="family member";
					}
	
						$output.= $user_name.",".$wing_name.",".$flat_name.",".$ownership.",".$email.",".$mobile." \n";
				} 
			}
		}
	}
	echo $output;
}
		


function import_email_mobile_update(){
	
$this->layout=null;	
$s_society_id=$this->Session->read('society_id');	
$this->loadmodel('user');
	$conditions=array("society_id" => $s_society_id);
	$result_user = $this->user->find('all',array('conditions'=>$conditions));
	$this->set('result_user',$result_user);

	if(isset($_FILES['file1'])){
	
	   $file_name=$_FILES['file1']['name']; 
		$file_tmp_name =$_FILES['file1']['tmp_name'];
		$target = "csv_file/";
		$target=@$target.basename($file_name);
		move_uploaded_file($file_tmp_name,@$target);
		
		$f = fopen('csv_file/'.$file_name, 'r') or die("ERROR OPENING DATA");
		$batchcount=0;
		$records=0;
		while (($line = fgetcsv($f, 4096, ';')) !== false) {
		// skip first record and empty ones
		$numcols = count($line);

		$test[]=$line;

		//echo $col = $line[0];
		//echo $batchcount++.". ".$col."\n";


		++$records;
		}

		fclose($f);
		$records;
	}
	
	$i=0;
	
	foreach($test as $child){
		if($i>0){
			$child_ex=explode(',',$child[0]);
			 $name=trim($child_ex[0]);
			 $email=trim($child_ex[1]);
			 $mobile=trim($child_ex[2]);
			
			$this->loadmodel('user'); 
			$conditions=array("society_id"=>$s_society_id,"user_name"=> new MongoRegex('/^' .  $name . '$/i'));
			$result_user=$this->user->find('all',array('conditions'=>$conditions));
		
			$result_user_count=sizeof($result_user);
			if($result_user_count>0){
					 $user_id=@$result_user[0]['user']['user_id'];	
				}
			$table[]=array(@$user_id,$email,$mobile);
		}
			$i++;
	}
	
	$this->set('table',$table);
	
}

////// End 


////// End 


function griter_notification($id)
{

	if($id=="society_detail"){
		$this->Session->delete('society_detail');
	}	
	if($id=="remove_change_pass"){
			$this->Session->delete('change_pass');
		}	
	if($id=="bank_receipt_cancel"){
		$this->Session->delete('bank_receipt_cancel');
	}

	if($id=="bank_receipt"){
		$this->Session->delete('bank_receipt');
	}
	if($id=="bank_receipt_updated"){
		$this->Session->delete('bank_receipt_updated');
	}
	if($id=="notice_create"){
		$this->Session->delete('create_notice');
	}
	
	if($id=="contact_handbook"){
		$this->Session->delete('contact_create');
	}
	
	if($id=="draft_notice_griter"){
		$this->Session->delete('draft_notice');
	}
	
	if($id=="bank_payment"){
		$this->Session->delete('bank_payment');	
	}
	if($id=="supplimentry_bill"){
		$this->Session->delete('supplimentry_bill');	
	}
	if($id=="bank_payment_update"){
		$this->Session->delete('bank_payment_update');	
	}
	if($id=="petty_cash_payment"){
		$this->Session->delete('petty_cash_payment');	
	}
	if($id=="petty_cash_payment_update"){
		$this->Session->delete('petty_cash_payment_update');	
	}
	if($id=="petty_cash_receipt"){
		$this->Session->delete('petty_cash_receipt');	
	}
	if($id=="petty_cash_receipt_update"){
		$this->Session->delete('petty_cash_receipt_update');	
	}
	if($id=="financial_status"){
		$this->Session->delete('financial_status');	
	}
	if($id=="bill_update"){
		$this->Session->delete('bill_update_status');
	}
	if($id=="group_create"){
		$this->Session->delete('group_status');
	}
    if($id=="fix_deposit_reading"){
		$this->Session->delete('fix_deposit_reading');
	}
	if($id=="fix_deposit_renew"){
		$this->Session->delete('fix_deposit_renew');
	}
	if($id=="fix_deposit_edit"){
		$this->Session->delete('fix_deposit_edit');
	}
	if($id=="fix_deposit_reverse"){
		$this->Session->delete('fix_deposit_reverse');
	}
	
	
	
	
	
	if($id==4)
	{
		$this->Session->delete('document_status');
		$this->Session->delete('document_status1');
	}
	
//////////////////// end ///////////////////////////

////////////////// Start Profile /////////////////////////

	if($id==101)
	{
		$this->Session->delete('profile_status');
	}
	
//////////////////// end ///////////////////////////

////////////////// Start Invitation /////////////////////////
	
	if($id==17)
	{
		$this->Session->delete('invite_status');
	}

//////////////////// end ///////////////////////////

////////////////// Start Poll /////////////////////////	

	if($id==7)
	{
		$this->Session->delete('poll_status');
		$this->Session->delete('poll_status1');
	}
	
//////////////////// end ///////////////////////////	


////////////////// Start Poll /////////////////////////	

	if($id==1)
	{
		$this->Session->delete('help_desk_status');
		$this->Session->delete('help_desk_draft_status');
		
	}
	
//////////////////// end ///////////////////////////


///////////////// Start discussion forum /////////////////

if($id==3)
	{
		$this->Session->delete('discussion_forum_status');
		$this->Session->delete('discussion_forum_status1');
		
	}
	



/////////////////////  End ///////////////////////////////


///////////////// Start Feedback /////////////////

if($id==102)
	{
		$this->Session->delete('feedback_status');
		
		
	}

/////////////////////  End ///////////////////////////////
//bill update//
if($id==1111){
	$this->Session->delete('bill_updated');
}
if($id==11){
	$this->Session->delete('bank_rrr');
}

if($id==111){
	$this->Session->delete('bank_rrr2');
}
if($id==1101){
 $this->Session->delete('bank_ppp');
}

if($id==1102){
 $this->Session->delete('bank_ppp2');
}


if($id==1301){
 $this->Session->delete('petty_cc_rr');
}

if($id==1401){
 $this->Session->delete('petty_cc_pp');
}

if($id==1501){
 $this->Session->delete('fix_ddd');
}

if($id==1601){
 $this->Session->delete('journll');
}

if($id==1701){
 $this->Session->delete('exp_ttt');
}

if($id==1801){
 $this->Session->delete('fix_assset');
}
if($id==1901){
 $this->Session->delete('incttt');
}
if($id==2101){
 $this->Session->delete('suppll');
}

if($id==3101){
 $this->Session->delete('ledd_accc');
}
if($id==3102){
 $this->Session->delete('ledgrr_sub_accc');
}
if($id==3103){
 $this->Session->delete('remindrrr');
}

if($id==3104){
 $this->Session->delete('ffyyyy');
}
if($id==5511){
 $this->Session->delete('bank_eddd');
}
if($id==5512){
 $this->Session->delete('new_bank_rrr');
}
if($id==5513){
 $this->Session->delete('opnn_bll');
}

if($id==5514){
 $this->Session->delete('fix_asst');
}

/////////////////////// End session_code //////////////////
	
}

function visible_subvisible($visible,$sub_visible) {
$s_user_id=$this->Session->read('user_id');
if($visible==1){	
$result_user=$this->all_user_deactive();

foreach($result_user as $data){
$da_to[$data['user']['user_id']]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

}
if($visible==4){	
$result_user=$this->all_owner_deactive();
foreach($result_user as $data){
$da_to[$data['user']['user_id']]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
}
	if($visible==5){
		$result_user=$this->all_tenant_deactive();
		foreach($result_user as $data){
			$da_to[$data['user']['user_id']]=$data['user']['email'];
			$da_user_name[]=$data['user']['user_name'];
			$da_user_id[]=$data['user']['user_id'];
		}
	}
	if($visible==2){	
		foreach ($sub_visible as $role_id){
			$role_id=(int)$role_id;
			$result_user=$this->all_role_wise_deactive($role_id);
			foreach($result_user as $data){
				$da_to[$data['user']['user_id']]=$data['user']['email'];
				$da_user_name[]=$data['user']['user_name'];
				$da_user_id[]=$data['user']['user_id'];
			}
		}
	}
	if($visible==3){	
		foreach ($sub_visible as $wing_id){
			$wing_id=(int)$wing_id;
			$result_user=$this->all_wing_wise_deactive($wing_id);
			foreach($result_user as $data){
				$da_to[$data['user']['user_id']]=$data['user']['email'];
				$da_user_name[]=$data['user']['user_name'];
				$da_user_id[]=$data['user']['user_id'];
			}
		}
	}

	///////// creator send email code //////////////////
	$result_user=$this->profile_picture($s_user_id);
	foreach($result_user as $data){
			 $da_to[]=$data['user']['email'];
			 $da_user_name[]=$data['user']['user_name'];
			 $da_user_id[]=$data['user']['user_id'];
		}
	////////////end code ///////////////////////////////
	$da_to=array_unique(array_filter($da_to));
	$da_user_name=array_unique(array_filter($da_user_name));
	$da_user_id=array_unique(array_filter($da_user_id));
	
	
	if($visible==1){ $send='All Users'; }
	if($visible==2){ $send='Roll Wise'; }
	if($visible==3){ $send='Wing Wise'; }
	if($visible==4){ $send='All Owners'; }
	if($visible==5){ $send='All Tenants'; }
		
		
	return $send_info=array($da_to,$da_user_name,$da_user_id,$send);
}


function encode($string,$key) {
$key = sha1($key);
$strLen = strlen($string);
$keyLen = strlen($key);
for ($i = 0; $i < $strLen; $i++) {
$ordStr = ord(substr($string,$i,1));
if (@$j == $keyLen) { $j = 0; }
$ordKey = ord(substr($key,@$j,1));
@$j++;
@$hash .= strrev(base_convert(dechex($ordStr + $ordKey),16,36));
}
return @$hash;
}

function decode($string,$key) {
$key = sha1($key);
$strLen = strlen($string);
$keyLen = strlen($key);
for ($i = 0; $i < $strLen; $i+=2) {
$ordStr = hexdec(base_convert(strrev(substr($string,$i,2)),36,16));
if (@$j == $keyLen) { @$j = 0; }
$ordKey = ord(substr($key,@$j,1));
@$j++;
@$hash .= chr($ordStr - $ordKey);
}
return @$hash;
}


function webroot_path() {
	$this->loadmodel('user');
	$conditions=array("email" => "housingmatters.in@gmail.com");
	$resultwebroot_path=$this->user->find('all',array('conditions'=>$conditions));
	return @$resultwebroot_path[0]['user']['webroot_path'];
}







function cronjob()
{

	$this->layout=null;
	$this->loadmodel('email_request');
	$conditions=array('flag'=>0);
	$result1_email=$this->email_request->find('all',array('conditions'=>$conditions,'limit'=>1));
	foreach($result1_email as $data)
	{
		$e_id=(int)$data['email_request']['e_id'];
		$to=$data['email_request']['to'];
		$from=$data['email_request']['from'];
		$from_name=$data['email_request']['from_name'];
		$subject=$data['email_request']['subject'];
		$message_web=$data['email_request']['message_web'];
		$reply=$data['email_request']['reply'];
		
		$mail_result=$this->smtpmailer($to,$from,$from_name,$subject,$message_web,$reply);
		
		if($mail_result = true){
			$this->loadmodel('email_request');
			$this->email_request->updateAll(array('flag'=>1),array('e_id'=>$e_id));
		}
		
	} 
	
}

function content_moderation_society($content_check)
{
	$content_check=explode(' ',$content_check);
	$s_society_id=$this->Session->read('society_id');
	
	$this->loadmodel('society');
	$conditions=array('society_id'=>$s_society_id);
	$result1=$this->society->find('all',array('conditions'=>$conditions));
	foreach($result1 as $data)
	{
		  $content=@$data['society']['content_moderation'];

	}
	if(!empty($content)){
		 $content=array_map('trim',$content);
	
	   
		foreach($content_check as $c_moda)
		{	
		
				if(in_array($c_moda,$content))
				{
					
				 return 0;
					
				}
	
		}
		}
	
		return 1;
	
}

function content_check_des()
{
	$this->layout='blank';
	$description=$this->request->query['description'];
	$des=explode(' ',$description);
	$r=$this->content_moderation_society($des);
	
	if($r==0)
	{
	echo "false";
	}
	else
	{
	echo "true";
	}
	
}

function ath()
{
 $hm_user_id=$this->Session->read('hm_user_id'); 
if(empty($hm_user_id))
{
$this->Session->destroy();
 $actual_link = "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
$actual_link = urlencode($actual_link); 
$this->response->header('Location', $this->webroot.'hms/index?next='.$actual_link);
}
date_default_timezone_set('Asia/Kolkata');	
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);

}

function send_email($to,$from,$from_name,$subject,$message_web,$reply)
{
//$this->layout='session';
$this->loadmodel('email_request');
$er=(int)$this->autoincrement('email_request','e_id');
$this->email_request->saveAll(array('e_id' => $er, 'to' => $to, 'from' => $from, 'from_name' => $from_name, 'subject' => $subject,'message_web' => $message_web, 'reply' => $reply, 'flag' => 0));
}
function logout() 
{
$this->layout='blank';
$this->Session->destroy();
$this->redirect(array('action' => 'index'));
}


function beforeFilter(){
	//Configure::write('debug', 0);
}


function menus_from_role_privileges()
{
$this->layout='blank';
$s_society_id=$this->Session->read('society_id');
$this->set('s_society_id',$s_society_id);
$s_role_id=$this->Session->read('role_id');
$this->set('s_role_id',$s_role_id);

$this->loadmodel('role_privileges');
$conditions=array("society_id" => $s_society_id,"role_id" => $s_role_id);
$this->set('result',$this->role_privileges->find('all',array('conditions'=>$conditions)));
return $this->role_privileges->find('all',array('conditions'=>$conditions));
}


function fetch_submoduleid_usermanagement($module_id) 
{
$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id');

$this->loadmodel('role_privilege');
$conditions=array("module_id" => $module_id,"society_id" => $s_society_id,"role_id" => $s_role_id);
$order=array('role_privilege.sub_module_id'=> 'ASC');
return $result=$this->role_privilege->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1));
}

function count_receipt_against_bill($regular_bill_one_time_id,$flat_id) 
{
$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id');


$this->loadmodel('new_cash_bank');
$conditions=array("bill_one_time_id" => $regular_bill_one_time_id,"flat_id" => $flat_id,"society_id" => $s_society_id);
return $this->new_cash_bank->find('count',array('conditions'=>$conditions));

}

function fetch_module_type_id($module_id) 
{
$this->loadmodel('main_module');
$conditions=array("auto_id" => $module_id);
$result_moduletype_id=$this->main_module->find('all',array('conditions'=>$conditions));
foreach ($result_moduletype_id as $ddq) 
{
return $mt_id=$ddq["main_module"]["mt_id"];
}
}

function fetch_module_type_name($result_moduletype_id) 
{
$this->loadmodel('module_type');
$conditions=array("module_type_id" => $result_moduletype_id);
return $this->module_type->find('all',array('conditions'=>$conditions));

}

function new_cash_bank_detail_via_transaction_id($value)
{
$s_society_id=$this->Session->read('hm_society_id');

$this->loadmodel('cash_bank');
$conditions=array("society_id"=>$s_society_id,"transaction_id"=>$value);
return $this->cash_bank->find('all',array('conditions'=>$conditions));
}


function fetch_module_name($module_type)
{

	$this->loadmodel('main_module');
	$order=array('main_module.module_name'=>'ASC');
	$conditions=array("mt_id" => $module_type);
	return $result_moduletype_id=$this->main_module->find('all',array('conditions'=>$conditions,'order'=>$order));

	
}

function fetch_pagename_usermanagement($sub_module_id) 
{
$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id');

$this->loadmodel('page');
$conditions=array("sub_module_id" => $sub_module_id);
return $result=$this->page->find('all',array('conditions'=>$conditions,'limit'=>1));
}

function fetch_pagename_main_module_usermanagement($module_id,$sub_module_id) 
{
$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id');

$this->loadmodel('page');
$conditions=array("module_id" => $module_id,"sub_module_id" => $sub_module_id);
return $result=$this->page->find('all',array('conditions'=>$conditions,'limit'=>1));
}

function fetch_sub_module_id_from_role_prvg($module_id){
	$s_society_id=$this->Session->read('society_id');
	$s_role_id=$this->Session->read('role_id');

	$this->loadmodel('role_privilege');
	$conditions=array("module_id" => $module_id,"society_id"=>$s_society_id,"role_id" => $s_role_id);
	return $result=$this->role_privilege->find('all',array('conditions'=>$conditions,'limit'=>1));
}

function fetch_mainmodulename_usermanagement($module_id) 
{
$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id');

$this->loadmodel('main_module');
$conditions=array("auto_id" => $module_id);
return $result=$this->main_module->find('all',array('conditions'=>$conditions));
}

function fetch_rolename_via_roleid($s_role_id) 
{
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('role');
$conditions=array("society_id"=>$s_society_id,"role_id"=>$s_role_id);
$result=$this->role->find('all',array('conditions'=>$conditions));
foreach ($result as $dd) 
{
return $role_name=$dd["role"]["role_name"];
}
}

function fetch_wingname_via_wingid($wing_id) 
{
$s_society_id=$this->Session->read('society_id');

$this->loadmodel('wing');
$conditions=array("society_id"=>$s_society_id,"wing_id"=>$wing_id);
$result=$this->wing->find('all',array('conditions'=>$conditions));
foreach ($result as $dd) 
{
return $wing_name=$dd["wing"]["wing_name"];
}
}


function fetch_flatname_via_flatid($flat_id) 
{
$s_society_id=$this->Session->read('society_id');

$this->loadmodel('flat');
$conditions=array("society_id"=>$s_society_id,"flat_id"=>$flat_id);
$result=$this->flat->find('all',array('conditions'=>$conditions));
foreach ($result as $dd) 
{
return $flat_name=$dd["flat"]["flat_name"];
}
}

function fetch_users_role() 
{
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('user');
$conditions=array("user_id"=>$s_user_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
foreach($result as $data)
{
return @$data['user']['role_id'];	 

}	
}

function fetch_all_flat_via_wing_id($wing){
	$s_society_id=$this->Session->read('hm_society_id');
	$this->loadmodel('flat');
	$conditions=array("wing_id" => $wing,'society_id'=>$s_society_id);
	$order=array('flat.flat_name'=> 'ASC');
	return $this->flat->find('all',array('conditions'=>$conditions,'order' =>$order));
} 


///////////////////////////////////////////////// Help Desk  Model Start //////////////////////////////////// //////////////////////////////////////////





function help_desk_r_open_ticket()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');


$this->loadmodel('help_desk');
$conditions=array("help_desk_status" => 0,"society_id" => $s_society_id,"user_id" => $s_user_id,'help_desk_draft'=>0);
$order=array('help_desk.ticket_id'=> 'DESC');
$result=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order));
$this->set('result_help_desk',$result);


}






function help_desk_r_close_ticket()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('help_desk');
$conditions=array("help_desk_status" => 1,"society_id" => $s_society_id,"user_id" => $s_user_id,'help_desk_draft'=>0);
$order=array('help_desk.ticket_id'=> 'DESC');
$result=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order));
$this->set('result_help_desk',$result);

}

function help_desk_r_all_ticket()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('help_desk');
$conditions=array("society_id" => $s_society_id,"user_id" => $s_user_id,'help_desk_draft'=>0);
$order=array('help_desk.ticket_id'=> 'DESC');
$result=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order));
$this->set('result_help_desk',$result);


}

function help_desk_r_draft_ticket()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();	
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->loadmodel('help_desk');
$conditions=array("help_desk_draft" =>1,"user_id" => $s_user_id);
$order=array('help_desk.help_desk_id'=> 'DESC');
$result=$this->help_desk->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set('result_help_desk_draft',$result);
}


function help_desk_draft_delete()
{
$this->layout='blank';
$id=(int)$this->request->query('con');
$this->loadmodel('help_desk');
$this->help_desk->updateAll(array("help_desk_draft" =>2),array("help_desk_id" => $id));
$this->response->header('Location:help_desk_r_draft_ticket');

}





function help_desk_sm_open_ticket()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('help_desk');
$conditions=array("help_desk_status" => 0,"society_id" => $s_society_id,'help_desk_draft'=>0);
$order=array('help_desk.ticket_id'=> 'DESC');
$result_help_desk=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order));
$this->set('result_help_desk',$result_help_desk);
foreach ($result_help_desk as $collection) 
{

$d_user_id=(int)$collection['help_desk']['user_id'];
$ticket_priority=$collection['help_desk']['ticket_priority'];
$ticket_id=(int)$collection['help_desk']['ticket_id'];
$help_generate_date=$collection['help_desk']['help_desk_date'];
$help_desk_description=$collection['help_desk']['help_desk_description'];
$da_society_id=(int)$collection['help_desk']['society_id'];

$result_user = $this->profile_picture($d_user_id);
foreach ($result_user as $collection) 
{
$user_name=$collection['user']['user_name'];
$email=$collection['user']['email'];
}
}




////////////////////////////////////////////////////////
////////////////////close ticket///////////////////////
///////////////////////////////////////////////////////
if (isset($this->request->data['close'])) 
{
	
	$ip=$this->hms_email_ip();
	
$hd_id=(int)$this->request->data['hd_id'];
$close_date=date("d-m-y");
$massage_close=htmlspecialchars($_POST['close_msg']);
$to= $email;
if($ticket_priority==1)
{
$ticket_priority="Urgent";
}
else
{
$ticket_priority="Normal";
}

$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $user_name,</p><br/>
<p>Your helpdesk ticket has been resolved & closed.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>HelpDesk Ticket</td>
<td>Priority </td>
<td>Ticket Date</td>
<td>Closure Date</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$ticket_id</td>
<td>$ticket_priority</td>
<td>$help_generate_date</td>
<td>$close_date</td>
</tr>
</table>
<div>
<p style='font-size:16px;'> <strong>Ticket Description:</strong></p>
<p style='font-size:15px;'>$help_desk_description</p> <br/>
<p style='font-size:16px;'> <strong>Closure Comments:</strong></p>
<p style='font-size:15px;'>$massage_close</p>
<br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div>
</div>";


$reply="donotreply@housingmatters.in";
$from_name="HousingMatters";

$this->loadmodel('email');
$conditions=array("auto_id" => 1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}

$society_result=$this->society_name($da_society_id);
foreach($society_result as $data)
{
$society_name=$data['society']['society_name'];
}
$this->loadmodel('notification_email');
$conditions=array("module_id" =>1,"user_id"=>$d_user_id,'chk_status'=>0);
$n=$this->notification_email->find('count',array('conditions'=>$conditions));
if($n>0)
{
@$subject.= ''. $society_name . '' . ' Closure of Helpdesk Ticket #'. '' .$ticket_id.'';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}
$close_date;
$massage_close;
$this->loadmodel('help_desk');
$this->help_desk->updateAll(array("help_desk_close_comment" => $massage_close,"help_desk_close_date"=>$close_date,"help_desk_status" => 1),array("help_desk_id" => $hd_id));
$this->response->header('Location:help_desk_sm_close_ticket');

}
//////////////////////////////////////////////close ticket///////////////////////////////////////////////////
}

function assign_ticket()
{
$this->layout='blank';
}


function help_desk_sm_close_ticket()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->loadmodel('help_desk');
$conditions=array("help_desk_status" =>1,"society_id" => $s_society_id,'help_desk_draft'=>0);
$order=array('help_desk.ticket_id'=> 'DESC');
$result=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order));
$this->set('result_help_desk',$result);


}





function help_desk_sm_all_ticket()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();
 

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('help_desk');
$conditions=array("society_id" => $s_society_id,'help_desk_draft'=>0);
$order=array('help_desk.ticket_id'=> 'DESC');
$result=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order));
$this->set('result_help_desk',$result);
foreach ($result as $collection) 
{
$d_user_id=(int)$collection['help_desk']['user_id'];
$ticket_priority=$collection['help_desk']['ticket_priority'];
$ticket_id=(int)$collection['help_desk']['ticket_id'];
$help_generate_date=$collection['help_desk']['help_desk_date'];
$help_desk_description=$collection['help_desk']['help_desk_description'];
$da_society_id=(int)$collection['help_desk']['society_id'];
$result_user = $this->profile_picture($d_user_id);
foreach ($result_user as $collection) 
{
$user_name=$collection['user']['user_name'];
$email=$collection['user']['email'];
}




}
/////////////////////////////////////////////////////// Close Ticket code and Email Code ///////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
if(isset($this->request->data['close'])) 
{
	$ip=$this->hms_email_ip();
	
$hd_id=(int)$this->request->data['hd_id'];
$close_date=date("d-m-y");
$massage_close=htmlspecialchars($_POST['close_msg']);
$to= $email;
if($ticket_priority==1)
{
$ticket_priority="Urgent";
}
else
{
$ticket_priority="Normal";
}
$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $user_name,</p><br/>
<p>Your helpdesk ticket has been resolved & closed.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>HelpDesk Ticket</td>
<td>Priority </td>
<td>Ticket Date</td>
<td>Closure Date</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$ticket_id</td>
<td>$ticket_priority</td>
<td>$help_generate_date</td>
<td>$close_date</td>
</tr>
</table>
<div>
<p style='font-size:16px;'> <strong>Ticket Description:</strong></p>
<p style='font-size:15px;'>$help_desk_description</p> <br/>
<p style='font-size:16px;'> <strong>Closure Comments:</strong></p>
<p style='font-size:15px;'>$massage_close</p>
<br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div>
</div>";

$reply="donotreply@housingmatters.in";
$from_name="HousingMatters";

$this->loadmodel('email');
$conditions=array("auto_id" => 1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}

$society_result=$this->society_name($da_society_id);
foreach($society_result as $data)
{
	$society_name=$data['society']['society_name'];
}

$this->loadmodel('notification_email');
$conditions=array("module_id" =>1,"user_id"=>$d_user_id,'chk_status'=>0);
$n=$this->notification_email->find('count',array('conditions'=>$conditions));
if($n>0)
{
@$subject.= ''. $society_name . '' . ' Closure of Helpdesk Ticket #'. '' .$ticket_id.'';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}
$close_date;
$massage_close;
$this->loadmodel('help_desk');
$this->help_desk->updateAll(array("help_desk_close_comment" => $massage_close,"help_desk_close_date"=>$close_date,"help_desk_status" => 1),array("help_desk_id" => $hd_id));
$this->response->header('Location:help_desk_sm_close_ticket');
}
//////////////////////////////////////////////////////End close ticket code and Email functionality ///////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}




function help_desk_r_view()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$hd_id=(int)$this->request->query('id');
$this->set('hd_id',$hd_id);
$status=(int)$this->request->query('status');
$this->set('status',$status);

$this->seen_notification(1,$hd_id);

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('help_desk');
$conditions=array("help_desk_id" => $hd_id);
$result=$this->help_desk->find('all',array('conditions'=>$conditions));
foreach ($result as $collection) 
{
$this->set('help_desk_description',$collection['help_desk']['help_desk_description']);
$this->set('help_desk_file',$collection['help_desk']['help_desk_file']);
$this->set('ticket_id',(int)$collection['help_desk']['ticket_id']);
$this->set('help_desk_close_date',@$collection['help_desk']['help_desk_close_date']);
$this->set('help_desk_close_comment',@$collection['help_desk']['help_desk_close_comment']);
$help_desk_complain_type_id=(int)$collection['help_desk']['help_desk_complain_type_id'];
$this->set('help_desk_complain_type_id',$help_desk_complain_type_id);
$this->set('help_desk_date',$collection['help_desk']['help_desk_date']);
$this->set('help_desk_time',$collection['help_desk']['help_desk_time']);
}

$this->loadmodel('help_desk_category');
$conditions=array("help_desk_category_id" => 5);
$cursor=$this->help_desk_category->find('all',array('conditions'=>$conditions));
foreach ($cursor as $collection2) 
{
$this->set('help_desk_category_name',$collection2['help_desk_category']['help_desk_category_name']);
}

$this->loadmodel('help_desk_reply');
$conditions=array("help_desk_id" => $hd_id);
$this->set('result_reply',$this->help_desk_reply->find('all',array('conditions'=>$conditions)));

}


function help_desk_sm_view()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();

$hd_id=(int)$this->request->query('id');
$this->set('hd_id',$hd_id);
$status=(int)$this->request->query('status');
$this->set('status',$status);

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->seen_notification(1,$hd_id);
////////////////////////////////////////////////////////
////////////////////close ticket///////////////////////
///////////////////////////////////////////////////////
$this->loadmodel('help_desk');
$conditions=array("help_desk_id" => $hd_id);
$result_help_desk=$this->help_desk->find('all',array('conditions'=>$conditions));
$this->set('result_help_desk',$result_help_desk);
foreach ($result_help_desk as $collection) 
{

$d_user_id=(int)$collection['help_desk']['user_id'];
$ticket_priority=$collection['help_desk']['ticket_priority'];
$ticket_id=(int)$collection['help_desk']['ticket_id'];
$help_generate_date=$collection['help_desk']['help_desk_date'];
$help_desk_description=$collection['help_desk']['help_desk_description'];
$da_society_id=(int)$collection['help_desk']['society_id'];

$result_user = $this->profile_picture($d_user_id);
foreach ($result_user as $collection) 
{
$user_name=$collection['user']['user_name'];
$email=$collection['user']['email'];
}
}
if (isset($this->request->data['close'])) 
{
	$ip=$this->hms_email_ip();
$close_date=date("d-m-y");
$massage_close=htmlspecialchars($_POST['close_msg']);
$to= $email;
if($ticket_priority==1)
{
$ticket_priority="Urgent";
}
else
{
$ticket_priority="Normal";
}
$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $user_name,</p><br/>
<p>Your helpdesk ticket has been resolved & closed.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>HelpDesk Ticket</td>
<td>Priority </td>
<td>Ticket Date</td>
<td>Closure Date</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$ticket_id</td>
<td>$ticket_priority</td>
<td>$help_generate_date</td>
<td>$close_date</td>
</tr>
</table>
<div>
<p style='font-size:16px;'> <strong>Ticket Description:</strong></p>
<p style='font-size:15px;'>$help_desk_description</p> <br/>
<p style='font-size:16px;'> <strong>Ticket Description by user:</strong></p>
<p style='font-size:15px;'>$massage_close</p>
<br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div>
</div>";


$reply="donotreply@housingmatters.in";
$from_name="HousingMatters";

$this->loadmodel('email');
$conditions=array("auto_id" => 1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}

$society_result=$this->society_name($da_society_id);
foreach($society_result as $data)
{
$society_name=$data['society']['society_name'];
}
$this->loadmodel('notification_email');
$conditions=array("module_id" =>1,"user_id"=>$d_user_id,'chk_status'=>0);
$n=$this->notification_email->find('count',array('conditions'=>$conditions));
if($n>0)
{
@$subject.= ''. $society_name . '' . ' Closure of Helpdesk Ticket #'. '' .$ticket_id.'';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}
$close_date;
$massage_close;
$this->loadmodel('help_desk');
$this->help_desk->updateAll(array("help_desk_close_comment" => $massage_close,"help_desk_close_date"=>$close_date,"help_desk_status" => 1),array("help_desk_id" => $hd_id));



$this->response->header('Location:help_desk_sm_close_ticket');
}
////////////////////////////////////////////////////////
////////////////////close ticket///////////////////////
///////////////////////////////////////////////////////
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('help_desk');
$conditions=array("help_desk_id" => $hd_id);
$result=$this->help_desk->find('all',array('conditions'=>$conditions));
foreach ($result as $collection) 
{
$this->set('help_desk_description',$collection['help_desk']['help_desk_description']);
$this->set('help_desk_file',$collection['help_desk']['help_desk_file']);
$this->set('ticket_id',(int)$collection['help_desk']['ticket_id']);
$this->set('help_desk_close_date',@$collection['help_desk']['help_desk_close_date']);
$this->set('help_desk_close_comment',@$collection['help_desk']['help_desk_close_comment']);
$help_desk_complain_type_id=(int)$collection['help_desk']['help_desk_complain_type_id'];
$this->set('help_desk_complain_type_id',$help_desk_complain_type_id);
$this->set('help_desk_date',$collection['help_desk']['help_desk_date']);
$this->set('help_desk_time',$collection['help_desk']['help_desk_time']);
$this->set('d_user_id',$collection['help_desk']['user_id']);
$this->set('help_desk_status',$collection['help_desk']['help_desk_status']);
$this->set('hd_sp_id',(int)$collection['help_desk']['help_desk_service_provider_id']);
$this->set('help_desk_assign_date',$collection['help_desk']['help_desk_assign_date']);
}

$this->loadmodel('help_desk_category');
$conditions=array("help_desk_category_id" => $help_desk_complain_type_id);
$cursor=$this->help_desk_category->find('all',array('conditions'=>$conditions));
foreach ($cursor as $collection2) 
{
$this->set('help_desk_category_name',$collection2['help_desk_category']['help_desk_category_name']);
}

$this->loadmodel('help_desk_reply');
$conditions=array("help_desk_id" => $hd_id);
$this->set('result_reply',$this->help_desk_reply->find('all',array('conditions'=>$conditions)));

$this->loadmodel('vendor');
$conditions=array("category_id" => $help_desk_complain_type_id);
$result_vendor=$this->vendor->find('all',array('conditions'=>$conditions));
$this->set('result_vendor',$result_vendor);
foreach ($result_vendor as $collection)
{
$vendor_id = (int)$collection['vendor']['vendor_id'];
}

$result_sp2=$this->fetch_service_provider_info_via_vendor_id($vendor_id);
foreach ($result_sp2 as $collection3)
{
$this->set('sp_name',$collection3['service_provider']['sp_name']);
}
}

//Start help_desk_reports//
function help_desk_reports()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	
$this->ath();
}
//End help_desk_reports//
function help_desk_report_1()
{
$this->layout='blank';
$this->ath();

$s_society_id=$this->Session->read('hm_society_id');

$d1=$this->request->query('d1');
$d2=$this->request->query('d2');
if(empty($d1) || empty($d2)) { echo '<span style="color:red;">Please select Date-period.</span>'; exit;}
if(strtotime($d1)>strtotime($d2)) { echo '<span style="color:red;">Please select valid Date-period.</span>'; exit;}
$d1=date("Y-m-d",strtotime($d1));
$d2=date("Y-m-d",strtotime($d2));
$this->set('d1',$d1);
$this->set('d2',$d2);

	$this->loadmodel('help_desk');
	$conditions=array("society_id" => $s_society_id);
	$result_help_desk_report1=$this->help_desk->find('all',array('conditions'=>$conditions));
	$this->set('result_help_desk_report1',$result_help_desk_report1);
}

function help_desk_report_2()
{
$this->layout='blank';
$this->ath();

$s_society_id=$this->Session->read('hm_society_id');

$d1=$this->request->query('d1');
$d2=$this->request->query('d2');
if(empty($d1) || empty($d2)) { echo '<span style="color:red;">Please select Date-period.</span>'; exit;}
if(strtotime($d1)>strtotime($d2)) { echo '<span style="color:red;">Please select valid Date-period.</span>'; exit;}
$d1=date("Y-m-d",strtotime($d1));
$d2=date("Y-m-d",strtotime($d2));
$this->set('d1',$d1);
$this->set('d2',$d2);

	$this->loadmodel('help_desk');
	$conditions=array("society_id" => $s_society_id,"help_desk_status" => 1);
	$result_help_desk_report1=$this->help_desk->find('all',array('conditions'=>$conditions));
	$this->set('result_help_desk_report1',$result_help_desk_report1);
}


function help_desk_report_3()
{
$this->layout='blank';
$this->ath();

$s_society_id=$this->Session->read('hm_society_id');

$d1=$this->request->query('d1');
$d2=$this->request->query('d2');
if(empty($d1) || empty($d2)) { echo '<span style="color:red;">Please select Date-period.</span>'; exit;}
if(strtotime($d1)>strtotime($d2)) { echo '<span style="color:red;">Please select valid Date-period.</span>'; exit;}
$d1=date("Y-m-d",strtotime($d1));
$d2=date("Y-m-d",strtotime($d2));
$this->set('d1',$d1);
$this->set('d2',$d2);

	$this->loadmodel('help_desk');
	$conditions=array("society_id" => $s_society_id);
	$result_help_desk_report1=$this->help_desk->find('all',array('conditions'=>$conditions));
	$this->set('result_help_desk_report1',$result_help_desk_report1);
}

function help_desk_report_4()
{
$this->layout='blank';
$this->ath();

$s_society_id=$this->Session->read('hm_society_id');

$d1=$this->request->query('d1');
$d2=$this->request->query('d2');
if(empty($d1) || empty($d2)) { echo '<span style="color:red;">Please select Date-period.</span>'; exit;}
if(strtotime($d1)>strtotime($d2)) { echo '<span style="color:red;">Please select valid Date-period.</span>'; exit;}
$d1=date("Y-m-d",strtotime($d1));
$d2=date("Y-m-d",strtotime($d2));
$this->set('d1',$d1);
$this->set('d2',$d2);

	$this->loadmodel('help_desk');
	$conditions=array("society_id" => $s_society_id);
	$result_help_desk_report1=$this->help_desk->find('all',array('conditions'=>$conditions));
	$this->set('result_help_desk_report1',$result_help_desk_report1);
}


function save_reply_resident()
{
$this->layout='blank';
$reply=htmlentities($this->request->query('reply'));
$reply=nl2br($reply);
$rep=explode(' ',$reply);

$r=$this->content_moderation_society($rep);



	
	
$hd_id=(int)$this->request->query('id');

$s_user_id=$this->Session->read('user_id');

$date=date("d-m-y");
$time=date('h:i:a',time());

$t=$this->autoincrement('help_desk_reply','hd_reply_id');
$this->loadmodel('help_desk_reply');
$multipleRowData = Array( Array("hd_reply_id" => $t, "reply" => $reply , "help_desk_id" => $hd_id, "date" => $date,"time" => $time,"class" => "outt","user_id"=>$s_user_id));
if($r==0)
{
	echo'<span style="color:red;font-size:14px;">You have enter wrong word.</span>';	

}
else
{
 $this->help_desk_reply->saveAll($multipleRowData); 
}
$this->loadmodel('help_desk_reply');
$conditions=array("help_desk_id" => $hd_id);
$order=array('help_desk_reply.hd_reply_id'=>'ASC');
$this->set('result_reply',$this->help_desk_reply->find('all',array('conditions'=>$conditions,'order'=>$order)));


}



///////////////////////////////////////////////// Service Provider ///////////////////////////////...............................////////////////////////
function service_provider_add()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('help_desk_category');	
$order=array('help_desk_category.help_desk_category_name'=>'ASC');
$result=$this->help_desk_category->find('all',array('order'=>$order));
$this->set('result_help_desk_category',$result);
if($this->request->is('post')) 
{
@$file_upload=$this->request['form']['file']['name'];
$text=htmlentities($this->request->data['name']);	
$name=wordwrap($text, 25, " ", true);
$text1=htmlentities($this->request->data['person']);
$person = wordwrap($text1, 25, " ", true);
$mobile=$this->request->data['mobile'];
$email=$this->request->data['email'];
@$cont_start=$this->request->data['cont_start'];
@$cont_end=$this->request->data['cont_end'];

if(!empty($cont_start))
{
$contract_type="AMC";	
}
else
{
$contract_type="Adhoc";
}

$this->loadmodel('service_provider');
$i=$this->autoincrement('service_provider','sp_id');
date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$this->service_provider->saveAll(array("sp_id" => $i, "sp_attachment" => $file_upload , "sp_name" => $name,"sp_date"=>$date,"user_id"=>$s_user_id,"society_id"=>$s_society_id,"sp_time"=>$time,"sp_delete"=>0,"sp_cont_start"=>$cont_start,"sp_cont_end"=>$cont_end,"sp_person"=>$person,"sp_email"=>$email,"sp_mobile"=>$mobile,"sp_contract_type"=>$contract_type));

$this->loadmodel('help_desk_category');
$result=$this->help_desk_category->find('all');
foreach ($result as $collection)
{ 
$id=$collection['help_desk_category']['help_desk_category_id'];
$servies=$collection['help_desk_category']['help_desk_category_name'];
@$check_id=(int)$this->request->data[$id];
if(!empty($check_id))
{
$this->loadmodel('vendor');
$j=$this->autoincrement('vendor','auto_id');
$this->vendor->saveAll(array("auto_id" => $j, "vendor_id" => $i, "category_id" =>  $check_id));
}
}

?>

<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Successfully add service provider.
</div> 
<div class="modal-footer">
<a href="service_provider_view" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php			
}
}
function service_provider_vendor($auto_id)
{


$this->loadmodel('vendor');
$conditions=array("vendor_id" =>  $auto_id);
return $this->vendor->find('all',array('conditions'=>$conditions));                  


}

function service_provider_view()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$this->set('role_id',$s_role_id=$this->Session->read('role_id'));
$this->loadmodel('service_provider');
$condition=array("sp_delete"=>0,"society_id"=>$s_society_id);
$this->set('result_service_provider',$this->service_provider->find('all',array('conditions'=>$condition)));

}
function service_provider_delete()
{
$this->layout='blank';	
$id=(int)$this->request->query('con');
$this->loadmodel('service_provider');
$this->service_provider->updateAll(array('sp_delete'=>1),array('sp_id'=>$id));
$this->response->header('Location', 'service_provider_view');
}

function service_provider_mail()
{

$this->layout='blank';
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$society_result= $this->society_name($s_society_id);
foreach($society_result as $data)
{
	$society_name=$data['society']['society_name'];
}
$subject=$society_name;
$text=htmlentities($this->request->query('con2'));
$message_web = wordwrap($text, 25, " ", true);
$to=$this->request->query('con3');
$this->loadmodel('user');
$conditions=array("user_id"=>$s_user_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
foreach ($result as $collection) 
{ 

$email=$collection['user']["email"];
}


$from_name="HousingMatters";
$from="support@housingmatters.in";
$reply=$email;
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);

}

function service_provider_edit()
{
$this->layout='session';
$id=(int)$this->request->query('con');
$this->loadmodel('service_provider');
$conditions=array("sp_id"=> $id);
$res= $this->service_provider->find('all',array('conditions'=>$conditions));
foreach ($res as $collection) 
{
$attachment=$collection['service_provider']['sp_attachment'];
$Contract_start=$collection['service_provider']['sp_cont_start'];
$Contract_end=$collection['service_provider']['sp_cont_end'];
}
$this->set('result_sp',$this->service_provider->find('all',array('conditions'=>$conditions))); 
if($this->request->is('post'))
{
@$file_upload=$this->request['form']['file']['name'];
if(empty($file_upload))
{
$file_upload=$attachment;
}
$text=htmlentities($this->request->data['name']);	
$name=wordwrap($text, 25, " ", true);
$text1=htmlentities($this->request->data['person']);
$person = wordwrap($text1, 25, " ", true);
$mobile=$this->request->data['mobile'];
$email=$this->request->data['email'];
@$cont_start=$this->request->data['cont_start'];
@$cont_end=$this->request->data['cont_end'];
$radio=$this->request->data['amc'];
if($radio==1)
{
$Contract_type="AMC";
}
else
{
$Contract_type="Adhoc";
}
if(empty($cont_start))
{
$cont_start= $Contract_start;
$cont_end= $Contract_end;
}
$this->loadmodel('service_provider');
$this->service_provider->updateAll(array("sp_name" => $name,"sp_mobile"=>$mobile,'sp_person'=> $person,"sp_email"=>$email,"sp_attachment"=>$file_upload,'sp_cont_start'=>$cont_start,'sp_cont_end'=> $cont_end,'sp_contract_type'=> $Contract_type),array("sp_id" => $id));
$this->response->header('location:service_provider_view');			

}

}
///////////////////////////////////////////////// Service Provider End ///////////////////////////////...............................////////////////////////
/////////////////////////////////////////////////////End Help Desk /////////////////////////




/////////////////// Help desk some function //////////////

function help_desk_category_name($complain_type_id)
{

$this->loadmodel('help_desk_category');
$conditions=array("help_desk_category_id" => $complain_type_id);
$result_category=$this->help_desk_category->find('all',array('conditions'=>$conditions));

foreach ($result_category as $collection) 
{
return $help_desk_category_name=$collection['help_desk_category']['help_desk_category_name'];
}
}
function regular_bill_check_due_date($d_user_id)
{
$date=date('d-m-Y');
$current_date_for = new MongoDate(strtotime(date("Y-m-d", strtotime($date))));
$this->loadmodel('regular_bill');
$conditions=array('bill_for_user'=>$d_user_id,'status'=>0,'remaining_amount'=>array('$gte'=>0),'due_date'=>array('$lte'=>$current_date_for));	
return $result_bill=$this->regular_bill->find('all',array('conditions'=>$conditions));	
}


function fetch_service_provider_info_via_vendor_id($vendor_id){
	$s_society_id=$this->Session->read('hm_society_id');
	$this->loadmodel('service_provider');
	$conditions=array("sp_id" => $vendor_id,"society_id" => $s_society_id);
	return $this->service_provider->find('all',array('conditions'=>$conditions));
}

////////////////////// end help desk function /////////////////////////////////////////

//////////////////////////////// Parking Managment System start /////////////////////


function sm_parking_slot()
{
	$this->layout='session';
	$s_society_id=$this->Session->read('society_id'); 
	$this->ath();
	$this->check_user_privilages();
	
	
	/*
	
	$this->loadmodel('parking');
	$conditions=array('society_id'=>$s_society_id,'type'=>2);
	$result=$this->parking->find('all',array('conditions'=>$conditions));
	$c=sizeof($result);
	foreach($result as $data)
	{
		$first=$data['parking']['slot_no'];
		 break;
	}
	@$r=explode('-',$first);
	@$r1=$r[1];
	$this->set('num2',$c);
	$this->set('start2',$r1);
	$this->loadmodel('parking');
	$conditions1=array('society_id'=>$s_society_id,'type'=>4);
	$result1=$this->parking->find('all',array('conditions'=>$conditions1));
	$c1=sizeof($result1);
	foreach($result1 as $data)
	{
		 $first1=$data['parking']['slot_no'];
		break;
	}
	@$r3= explode('-',$first1);
	@$r4=$r3[1];
	$this->set('num4',$c1);
	$this->set('start4',$r4);
	
	*/
	
	if($this->request->is('post'))
	{
		$this->loadmodel('parking');
		//$conditions4=array('society_id'=>$s_society_id);
		//$this->parking->deleteAll($conditions4);
		 $two_slot=$this->request->data['two_slot'];
		 $two_start=$this->request->data['two_start'];
		 $to_r=$two_slot+$two_start;
		 $four_slot=$this->request->data['four_slot'];
		 $four_start=$this->request->data['four_start'];
		 $four_r=$four_slot+$four_start;
		for($i=$two_start;$i<$to_r; $i++)
		{
			$j=$this->autoincrement('parking','parking_id');
			 $to_flot= '2-'.$i ;
			 $this->loadmodel('parking');
			 $this->parking->saveAll(array('parking_id'=>$j,'slot_no'=>$to_flot,'type'=>2,'society_id'=>$s_society_id,'status'=>0));
		}
		
		for($k=$four_start;$k<$four_r; $k++)
		{
			$j=$this->autoincrement('parking','parking_id');
			 $fo_flot= '4-'.$k ;
			 $this->loadmodel('parking');
			 $this->parking->saveAll(array('parking_id'=>$j,'slot_no'=>$fo_flot,'type'=>4,'society_id'=>$s_society_id,'status'=>0));
		}
		
		 //$this->response->header('location','parking_system_view');
		 
		 ?>
		 
		 
				<!----alert-------------->
				<div class="modal-backdrop fade in"></div>
				<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
				<div class="modal-body" style="font-size:16px;">
				Successfully add parking slot.
				</div> 
				<div class="modal-footer">
				<a href="parking_system_view" class="btn green">OK</a>
				</div>
				</div>
				<!----alert-------------->
								
                
		 
		 
		 
		 
		 
		 <?php
		
		
		
	}
}








function sm_parking_slot123()
{
	$this->layout='session';
	$s_society_id=$this->Session->read('society_id'); 
	
	
	$this->loadmodel('parking');
	$conditions=array('society_id'=>$s_society_id,'type'=>2);
	$result=$this->parking->find('all',array('conditions'=>$conditions));
	$c=sizeof($result);
	foreach($result as $data)
	{
		$first=$data['parking']['slot_no'];
		 break;
	}
	@$r=explode('-',$first);
	@$r1=$r[1];
	$this->set('num2',$c);
	$this->set('start2',$r1);
	$this->loadmodel('parking');
	$conditions1=array('society_id'=>$s_society_id,'type'=>4);
	$result1=$this->parking->find('all',array('conditions'=>$conditions1));
	$c1=sizeof($result1);
	foreach($result1 as $data)
	{
		 $first1=$data['parking']['slot_no'];
		break;
	}
	@$r3= explode('-',$first1);
	@$r4=$r3[1];
	$this->set('num4',$c1);
	$this->set('start4',$r4);
	
	
	
	if($this->request->is('post'))
	{
		$this->loadmodel('parking');
		$conditions4=array('society_id'=>$s_society_id);
		$this->parking->deleteAll($conditions4);
		 $two_slot=$this->request->data['two_slot'];
		 $two_start=$this->request->data['two_start'];
		 $to_r=$two_slot+$two_start;
		 $four_slot=$this->request->data['four_slot'];
		 $four_start=$this->request->data['four_start'];
		 $four_r=$four_slot+$four_start;
		for($i=$two_start;$i<$to_r; $i++)
		{
			$j=$this->autoincrement('parking','parking_id');
			 $to_flot= '2-'.$i ;
			 $this->loadmodel('parking');
			 $this->parking->saveAll(array('parking_id'=>$j,'slot_no'=>$to_flot,'type'=>2,'society_id'=>$s_society_id,'status'=>0));
		}
		
		for($k=$four_start;$k<$four_r; $k++)
		{
			$j=$this->autoincrement('parking','parking_id');
			 $fo_flot= '4-'.$k ;
			 $this->loadmodel('parking');
			 $this->parking->saveAll(array('parking_id'=>$j,'slot_no'=>$fo_flot,'type'=>4,'society_id'=>$s_society_id,'status'=>0));
		}
		 $this->response->header('location','sm_parking_slot');
		
		
		
	}
}


function parking_system_view()
{
	$this->layout="session";
	$this->ath();
	$this->check_user_privilages();
	$s_society_id=$this->Session->read('society_id');
	$this->loadmodel('parking');
	$conditions1=array('society_id'=>$s_society_id);
	$result1=$this->parking->find('all',array('conditions'=>$conditions1));
	$this->set('result_parking',$result1);
	$this->loadmodel('parking');
	$conditions2=array('society_id'=>$s_society_id,'type'=>2);
	$result2=$this->parking->find('all',array('conditions'=>$conditions2));
	$n=sizeof($result2);
	$this->set('two_n',$n);
	$this->loadmodel('parking');
	$conditions3=array('society_id'=>$s_society_id,'type'=>4);
	$result3=$this->parking->find('all',array('conditions'=>$conditions3));
	$n2=sizeof($result3);
	$this->set('four_n',$n2);
	
}


function sm_assign_parking_system()
{
	$this->layout="session";
	$this->ath();
	$this->check_user_privilages();
	$s_society_id=$this->Session->read('society_id');
	$s_user_id=$this->Session->read('user_id');
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id);
	$result=$this->user->find('all',array('conditions'=>$conditions));
	$this->set('result_user',$result);
	$this->loadmodel('parking');
	$conditions2=array('society_id'=>$s_society_id,'type'=>2,'status'=>0);
	$result2=$this->parking->find('all',array('conditions'=>$conditions2));
	$this->set('result_parking2',$result2);
	$this->loadmodel('parking');
	$conditions4=array('society_id'=>$s_society_id,'type'=>4,'status'=>0);
	$result4=$this->parking->find('all',array('conditions'=>$conditions4));
	$this->set('result_parking4',$result4);
	if($this->request->is('post'))
	{
		$user=(int)$this->request->data['sel_user'];
		$type=$this->request->data['wheeler'];
		$vehicle=$this->request->data['vehicle'];
		if($type==2)
		{
			$slot=$this->request->data['sel_slot2'];
		}
		if($type==4)
		{
			$slot=$this->request->data['sel_slot4'];
		}
		
			$this->loadmodel('user');
			$conditions=array('user_id'=>$user);
			$result7=$this->user->find('all',array('conditions'=>$conditions));
			
		foreach($result7 as $data)
		{
		@$parking=$data['user']['parking'];	
		}
		
		

if(sizeof($parking)==0)
{
$parking[]=array($slot,$vehicle);
}
else
{
$t=array($slot,$vehicle);
array_push($parking,$t);
}
$this->loadmodel('parking');
$this->parking->updateAll(array('status'=>1),array('parking_id'=>(int)$slot));
$this->loadmodel('user');
$this->user->updateAll(array('parking'=>$parking),array('user_id'=>$user));
//$this->response->header('location','parking_assign_user_view');



?>


	<!----alert-------------->
	<div class="modal-backdrop fade in"></div>
	<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
	<div class="modal-body" style="font-size:16px;">
	Successfully assign parking slot user.
	</div> 
	<div class="modal-footer">
	<a href="parking_assign_user_view" class="btn green">OK</a>
	</div>
	</div>
	<!----alert-------------->





<?php

	}
}

function parking_assign_user_view()
{

	$this->layout="session";
	$this->ath();
	$this->check_user_privilages();
	$s_society_id=$this->Session->read('society_id');
	$s_user_id=$this->Session->read('user_id');	
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id,'user.parking'=>array('$ne'=>null));
	$result=$this->user->find('all',array('conditions'=>$conditions));
	$this->set('result_user',$result);
	
}


function parking_slot($park)
{
	
	$this->loadmodel('parking');
	$conditions=array('parking_id'=>$park);
	return $result=$this->parking->find('all',array('conditions'=>$conditions));
	
	
}

//////////////////////////////// End Parking system ////////////////////////////////




function change_role() 
{
$this->layout='blank';
$role=(int)$this->request->query('role');
$this->Session->write('role_id', $role);
$this->redirect(array('controller' => 'Hms','action' => 'dashboard'));
}


function change_society() 
{
$this->layout='blank';
$s_login_id=(int)$this->Session->read('login_id');
$society=(int)$this->request->query('society');
$this->loadmodel('user');
$conditions=array('login_id'=>$s_login_id,'society_id'=>$society);
$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$user_id=$data['user']['user_id'];
	$user_name=$data['user']['user_name'];
	$wing=$data['user']['wing'];
	$tenant=$data['user']['tenant'];
	$role_id=$data['user']['default_role_id'];
	}

$this->Session->write('user_id', $user_id);
$this->Session->write('role_id', $role_id);
$this->Session->write('user_name', $user_name);
$this->Session->write('wing', $wing);
$this->Session->write('tenant', $tenant);
$this->Session->write('society_id', $society);
$this->redirect(array('action' => 'dashboard'));
}


function submenu()
{
$this->layout=null;
$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id');

$page_namr_url=pathinfo($_SERVER[ 'REQUEST_URI'],PATHINFO_FILENAME);
$url = parse_url($page_namr_url) ;
$page_namr_url=  $url['path'];
$this->loadmodel('page');
$conditions=array("page_name" => $page_namr_url);
$cursor=$this->page->find('all',array('conditions'=>$conditions));
foreach ($cursor as $collection) 
{					
$module_id=$collection["page"]["module_id"];
$sub_module_id=$collection["page"]["sub_module_id"];
}

$this->loadmodel('role_privilege');
$conditions=array("module_id" => @$module_id,"society_id" => $s_society_id,"role_id" => $s_role_id);
$cursor=$this->role_privilege->find('all',array('conditions'=>$conditions));
sort($cursor);
if(sizeof($cursor)>1)
{ 
?>
<div align="center">
<?php
foreach ($cursor as $collection) 
{			
$sub_module_id=$collection["role_privilege"]["sub_module_id"];

$this->loadmodel('page');
$conditions=array("sub_module_id" => $sub_module_id);
$cursor_page=$this->page->find('all',array('conditions'=>$conditions,'limit'=>1));
foreach ($cursor_page as $collection) 
{					
$page_name=$collection["page"]["page_name"];
$controller=$collection['page']['controller'];
}

$this->loadmodel('sub_module');
$conditions=array("auto_id" => $sub_module_id);
$cursor_sub_module=$this->sub_module->find('all',array('conditions'=>$conditions,'limit'=>1));
foreach ($cursor_sub_module as $collection) 
{					
$sub_module_name=$collection["sub_module"]["sub_module_name"];
}
$sub_module_id_fix="fix".$sub_module_id;
echo '<a href='.$this->webroot.@$controller.'/'.$page_name.' id='.$sub_module_id_fix.' class="btn blue allsubmenu" style="margin-left: 2px;margin-bottom: 4px;" rel="tab">'.$sub_module_name.' </a>';
}
?>
</div>
<?php
}
}


function submenu_as_per_role_privilage(){
	$this->layout=null;
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');

$user_detail=$this->requestAction(array('controller' => 'Fns', 'action'=> 'user_info_via_user_id'),array('pass'=>array($s_user_id)));
foreach($user_detail as $dataa)
{
 $user_type = $dataa['user']['user_type'];	
}
if($user_type == "hm_child"){
	$default_role= $this->requestAction(array('controller' => 'Fns', 'action'=> 'fetch_default_role_via_user_id_hm'),array('pass'=>array($s_user_id)));
	$page_namr_url=pathinfo($_SERVER[ 'REQUEST_URI'],PATHINFO_FILENAME);
	$url = parse_url($page_namr_url) ;
	$page_namr_url=  $url['path'];
	
	$this->loadmodel('page');
	$conditions=array("page_name" => $page_namr_url);
	$cursor=$this->page->find('all',array('conditions'=>$conditions));
	foreach ($cursor as $collection){
		$module_id=$collection["page"]["module_id"];
		$sub_module_id_page=$collection["page"]["sub_module_id"];
	}

	$this->loadmodel('role_privilege_hm');
	$conditions=array("module_id" => @$module_id,"role_id" => $default_role);
	$cursor=$this->role_privilege_hm->find('all',array('conditions'=>$conditions));
	sort($cursor);
	if(sizeof($cursor)>1){
		foreach ($cursor as $collection){
			$sub_module_id=$collection["role_privilege_hm"]["sub_module_id"];

			$this->loadmodel('page');
			$conditions=array("sub_module_id" => $sub_module_id);
			$cursor_page=$this->page->find('all',array('conditions'=>$conditions,'limit'=>1));
			foreach ($cursor_page as $collection){			
				$page_name=$collection["page"]["page_name"];
				$controller=$collection['page']['controller'];
			}
			$this->loadmodel('sub_module');
			$conditions=array("auto_id" => $sub_module_id);
			$cursor_sub_module=$this->sub_module->find('all',array('conditions'=>$conditions,'limit'=>1));
			foreach ($cursor_sub_module as $collection){					
				$sub_module_name=$collection["sub_module"]["sub_module_name"];
			}

			$sub_module_id_fix="fix".$sub_module_id;
			if($sub_module_id_page==$sub_module_id){
				echo '<a href='.$this->webroot.@$controller.'/'.$page_name.' class="btn red allsubmenu hide_at_print" style="margin-left: 2px;margin-bottom: 4px;" rel="tab">'.$sub_module_name.' </a>';
			}else{
				echo '<a href='.$this->webroot.@$controller.'/'.$page_name.' class="btn blue allsubmenu hide_at_print" style="margin-left: 2px;margin-bottom: 4px;" rel="tab">'.$sub_module_name.' </a>';
			}
		}
	}	
}else{
	$default_role= $this->requestAction(array('controller' => 'Fns', 'action'=> 'fetch_default_role_via_user_id'),array('pass'=>array($s_user_id)));
	$page_namr_url=pathinfo($_SERVER[ 'REQUEST_URI'],PATHINFO_FILENAME);
	$url = parse_url($page_namr_url) ;
	$page_namr_url=  $url['path'];
	
	$this->loadmodel('page');
	$conditions=array("page_name" => $page_namr_url);
	$cursor=$this->page->find('all',array('conditions'=>$conditions));
	foreach ($cursor as $collection){
		$module_id=$collection["page"]["module_id"];
		$sub_module_id_page=$collection["page"]["sub_module_id"];
	}
	
		$this->loadmodel('role_privilege');
		$conditions=array("module_id" => @$module_id,"society_id"=>$s_society_id,"role_id" => $default_role);
		$cursor=$this->role_privilege->find('all',array('conditions'=>$conditions));
	
		sort($cursor);
		
		
		if(sizeof($cursor)>1){
			echo '<div align="center" class="mobile-align">';
			foreach ($cursor as $collection){
				$sub_module_id=$collection["role_privilege"]["sub_module_id"];

				$this->loadmodel('page');
				$conditions=array("sub_module_id" => $sub_module_id);
				$cursor_page=$this->page->find('all',array('conditions'=>$conditions,'limit'=>1));
				foreach ($cursor_page as $collection){			
					$page_name=$collection["page"]["page_name"];
					$controller=$collection['page']['controller'];
				}

				
				
				
				$this->loadmodel('sub_module');
				$conditions=array("auto_id" => $sub_module_id);
				$cursor_sub_module=$this->sub_module->find('all',array('conditions'=>$conditions,'limit'=>1));
				foreach ($cursor_sub_module as $collection){					
					$sub_module_name=$collection["sub_module"]["sub_module_name"];
				}
			
				$sub_module_id_fix="fix".$sub_module_id;
				if($sub_module_id_page==$sub_module_id){
					echo '<a href='.$this->webroot.@$controller.'/'.$page_name.' class="btn red allsubmenu hide_at_print" style="margin-left: 2px;margin-bottom: 4px;" rel="tab">'.$sub_module_name.' </a>';
				}else{
					echo '<a href='.$this->webroot.@$controller.'/'.$page_name.' class="btn blue allsubmenu hide_at_print" style="margin-left: 2px;margin-bottom: 4px;" rel="tab">'.$sub_module_name.' </a>';
				}
			
			}
		echo '</div>';
	}
}
}

function check_housingmatters_privilages()
{
$s_society_id=$this->Session->read('society_id');
if($s_society_id!=0)
{
$this->layout='resricted';
?>
<div style="min-height: 85%;margin-top: 60px; " align="center">
<h2>Sorry<br/>You are not allowed to access this page.</h2>
<img src="<?php echo $this->webroot ; ?>/as/hm/hm-logo.png" alt="logo" >
<br/><h4>Back to <a href="<?php echo $webroot_path; ?>Hms/dashboard">Dashboard</a></h4>
</div>
<?php
}
}


function check_user_privilages()
{



}

function rendom_color($last_color) 
{
$allcolors=array('#285e8e','#398439','#269abc','#d58512','#ac2925','#45b6af','#3ea7a0','#9b59b6');
$key = array_search($last_color,$allcolors);
if($key!==false){
unset($allcolors[$key]);
}
return $allcolors[array_rand($allcolors)];
}

function random_color_part() {
return str_pad( dechex( mt_rand( 0, 255 ) ), 2, '0', STR_PAD_LEFT);
}
function rendom_color_new() 
{
//$allcolors=array('#285e8e','#398439','#269abc','#d58512','#ac2925','#45b6af','#3ea7a0','#9b59b6');
//return $allcolors[array_rand($allcolors)];
return '#'.$this->random_color_part() . $this->random_color_part() . $this->random_color_part();
}



function autoincrement($table,$field) 
{

$this->loadmodel($table);
$order=array($table.'.'.$field=>'DESC');

$cursor=$this->$table->find('all',array('order'=>$order,'limit'=>1));

foreach ($cursor as $collection) 
{
$last=@$collection[$table][$field];
}

if(empty($last))
{
$auto=0;
}
else
{
$auto=$last;	
}

return ++$auto;

}

function autoincrement_with_society($table,$field) 
{
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel($table);
$conditions=array("society_id" => $s_society_id);
$order=array($table.'.'.$field=>'DESC');
$cursor=$this->$table->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1));
foreach ($cursor as $collection) 
{
$last=$collection[$table][$field];
}
if(empty($last))
{
$auto2=0;
}
else
{
$auto2=$last;	
}
return ++$auto2;

}

function autoincrement_with_society_ticket($table,$field) 
{
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel($table);
$conditions=array("society_id" => $s_society_id);
$order=array($table.'.'.$field=>'DESC');
$cursor=$this->$table->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1));
foreach ($cursor as $collection) 
{
$last=$collection[$table][$field];
}
if(empty($last))
{
$auto2=1000;
}
else
{
$auto2=$last;	
}
return ++$auto2;
}


function autoincrement_with_receipt_source($table,$field,$source) 
{
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel($table);
$conditions=array("society_id" => $s_society_id,"source"=>$source);
$order=array($table.'.'.$field=>'DESC');
$cursor=$this->$table->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1));
foreach ($cursor as $collection) 
{
$last=$collection[$table][$field]; 
}
if(empty($last))
{
$auto2=1000;
}
else
{
$auto2=$last;	
}
return ++$auto2;
}


function autoincrement_with_fixed_deposit($table,$field) 
{
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel($table);
$conditions=array("society_id" => $s_society_id,"auto_inc"=>"YES");
$order=array($table.'.'.$field=>'DESC');
$cursor=$this->$table->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1));
foreach ($cursor as $collection) 
{
$last=$collection[$table][$field]; 
}
if(empty($last))
{
$auto2=1000;
}
else
{
$auto2=$last;	
}
return ++$auto2;
}


function unit_configuration()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
$this->ath();
$this->check_user_privilages();
$s_society_id=(int)$this->Session->read('hm_society_id');
$s_user_id=(int)$this->Session->read('hm_user_id');

if(isset($this->request->data['sssbbb']))
{
$valll = $this->request->data['arra_typpp'];
$this->loadmodel('society');
$this->society->updateAll(array("area_scale" => $valll),array('society_id'=> $s_society_id));	
}

$this->loadmodel('society');
$condition=array('society_id'=>$s_society_id);
$cursor11 = $this->society->find('all',array('conditions'=>$condition)); 
$this->set('cursor11',$cursor11);

$this->loadmodel('flat');
$conditions=array("society_id" => $s_society_id);
$cursor1 = $this->flat->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);

$this->loadmodel('wing');
$order=array('wing.wing_name'=> 'ASC');
$conditions=array("society_id" => $s_society_id);
$cursor2 = $this->wing->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set('cursor2',$cursor2);	

$this->loadmodel('flat_type_name');
$cursor3 = $this->flat_type_name->find('all');
$this->set('cursor3',$cursor3);	

}
///////////////////////////// Setting ///////////////////////////////

function society_settings()
{
	
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
	$this->ath();
	$s_society_id=$this->Session->read('hm_society_id');
	
	$this->set('s_user_id',$this->Session->read('hm_user_id'));
	$this->set('role_id',$this->Session->read('role_id'));
	if(isset($this->request->data['sub']))
	{
	
	        @$reminder_status = $this->request->data['remndrr'];
			@$signup_auto=$this->request->data['signup'];
			@$help_desk=$this->request->data['help_desk'];
			@$family_member=(int)$this->request->data['family_member'];
			@$family_member_tenant=(int)$this->request->data['family_member_tenant']; 
			@$notice=$this->request->data['notice'];
			@$document=$this->request->data['document'];
			@$discussion_forum=$this->request->data['discussion_forum'];
			@$discussion_forum_email=$this->request->data['discussion_forum1'];
			@$poll=$this->request->data['poll'];
			@$account_email=$this->request->data['account1'];
			@$account_sms=$this->request->data['account2'];
			@$account_zero_ammount=$this->request->data['account3'];
			//@$merge_receipt=(int)$this->request->data['merge_receipt'];
			@$access_tenant=(int)$this->request->data['access_tenant'];
			
			@$banned_word=$this->request->data['banned'];
			@$banned_word= explode(",",$banned_word);
			//$society_pan=$this->request->data['pan'];
			//$society_tax=$this->request->data['tax_num'];
			if(empty($signup_auto))
			{
				$signup_auto=0;
				
			}
	    	if(empty($help_desk))
			{
				$help_desk=0;
				
			}
			if(empty($notice))
			{
				$notice=0;
				
			}
			if(empty($document))
			{
				$document=0;
				
			}
			if(empty($discussion_forum))
			{
				$discussion_forum=0;
				
			}
			if(empty($discussion_forum_email))
			{
				$discussion_forum_email=0;
				
			}
			if(empty($poll))
			{
				$poll=0;
				
			}
			if(empty($account_email))
			{
				$account_email=0;
				
			}
			if(empty($account_sms))
			{
				$account_sms=0;
				
			}
			if(empty($family_member))
			{
				$family_member=0;
				
			}
			if(empty($account_zero_ammount))
			{
				$account_zero_ammount=0;
			}
			if(empty($reminder_status))
			{
			$reminder_status = 0;
			}
			$this->loadmodel('society');
			$this->society->updateAll(array('signup'=>$signup_auto,'help_desk'=>$help_desk,'notice'=>$notice,'document'=>$document,'discussion_forum'=>$discussion_forum,'discussion_forum_email'=>$discussion_forum_email,'poll'=>$poll,'account_email'=>$account_email,'account_sms'=>$account_sms,'account_zero_ammount'=>$account_zero_ammount,'content_moderation'=>$banned_word,'family_member'=>$family_member,"reminder_status"=>$reminder_status,'access_tenant'=>$access_tenant,'family_member_tenant'=>$family_member_tenant),array('society_id'=>$s_society_id));
					
	}
	
	$this->loadmodel('society');
	$result=$this->society->find('all',array('conditions'=>array('society_id'=>$s_society_id)));
	$this->set('result_society',$result);

}
///////////////////////// end Setting /////////////////////////////


///////////////////////   Deactive functionality start   //////////////////////////////////////



function add_field(){
		
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
	$this->ath();
		
	$s_society_id=$this->Session->read('hm_society_id');	

	
//cancel sms schedule api 
	
			$ge=file_get_contents('http://api-alerts.solutionsinfini.com/v4/?method=sms.schedule&api_key=149981t853o14262m1119&groupid=4643913769'); 	

			$test=json_decode($ge);
			pr($test);
			pr($ge);
			echo"hello";
			
///
	
		$this->loadmodel('regular_ledger_posting');
		//$conditions=array('element_id'=>$element_id,'table_name'=>'regular_bill','society_id'=>$society_id);
		$regular_ledger_posting=$this->regular_ledger_posting->find('all');
		$this->set('regular_ledger_posting',$regular_ledger_posting);
		
		
	//end code 	
	
	
		if(isset($this->request->data['sub'])){ 
		
			 $password = $this->request->data['password'];
			 $user_dat_id_new=$this->request->data['user_dat_id'];
			  $validation_status = $this->request->data['validation_status'];
			 $i=0;
			foreach($user_dat_id_new as $user_dat_id){
				 $user_dat_id=(int)$user_dat_id; 
				 $pass=$password[$i]; 
				 $validation_statu=$validation_status[$i]; 
				 if($validation_statu=='done'){

					 $this->loadmodel('user');
					 $this->user->updateAll(array('password'=>$pass,'validation_status'=>'done','signup_random'=>''),array('user_id'=>(int)$user_dat_id));
					
				 }
				$i++;
			}
	
		}
		$this->loadmodel('user');
		$conditions=array('active'=>'yes','society_id'=>$s_society_id);
		$result_user=$this->user->find('all',array('conditions'=>$conditions));
		$this->set('result_user',$result_user);
		 
		/*this code to run production system 
		 $multiple_flat=@$data['user']['multiple_flat'];
		if(!empty($multiple_flat)){
			
			foreach($multiple_flat as $dd){
				
				 $wing_id=$dd[0];
				 $flat_id=$dd[1];
				 $this->loadmodel('user_flat');
				 $i=$this->autoincrement('user_flat','user_flat_id');
				 $this->user_flat->saveAll(array('user_flat_id'=>$i,'user_id'=>$user_id,'society_id'=>$society_id,'flat_id'=>$flat_id,'status'=>$tenant,'active'=>0,'exit_date'=>'','time'=>''));
			}	
			
			
		}else{
			
		
				 $this->loadmodel('user_flat');
				 $i=$this->autoincrement('user_flat','user_flat_id');
				 $this->user_flat->saveAll(array('user_flat_id'=>$i,'user_id'=>$user_id,'society_id'=>$society_id,'flat_id'=>$flat,'status'=>$tenant,'active'=>0,'exit_date'=>'','time'=>''));
			
		}
		
	} */
	
	/*
	$this->loadmodel('flat');
	
	$result_flat=$this->flat->find('all');
	//pr($result_flat);
	foreach($result_flat as $data){
		
		   $flat_id=(int)$data['flat']['flat_id'];
		   $flat_name=$data['flat']['flat_name'];
		   $this->loadmodel('flat');
		  $this->flat->updateAll(array('flat_name'=>(int)$flat_name),array('flat_id'=>$flat_id));
		  
		  //$this->flat->updateAll(array('flat_name'=>$flat_name),array('flat_id'=>$flat_id));
		
	}
	
	
	echo $bill_html='<div style="margin: 0px;">
        <table style="padding:24px;background-color:#34495e" align="center" border="0" cellpadding="0" cellspacing="0" width="100%" class="main_table">
            <tbody><tr>
                <td>
                    <table style="padding:38px 30px 30px 30px;background-color:#fafafa" align="center" border="0" cellpadding="0" cellspacing="0" width="540">
                        <tbody>
						<tr>
							<td height="10">
							<table width="100%" class="hmlogobox">
								<tr>
									<td width="50%" style="padding: 10px 0px 0px 10px;"><img src="/Housingmatters//Housingmatters//as/hm/hm-logo.png" style="max-height: 60px; " height="60px" /></td>
									<td width="50%" align="right" valign="middle"  style="padding: 7px 10px 0px 0px;">
									<a href="https://www.facebook.com/HousingMatters.co.in"><img src="/Housingmatters//Housingmatters//as/hm/SMLogoFB.png"    style="max-height: 30px; height: 30px; width: 30px; max-width: 30px;" height="30px" width="30px" /></a>
									</td>
								</tr>
							</table>
							</td>
						</tr>
						<tr>
							<td height="10"></td>
						</tr>
                        <tr>
                            <td colspan="2" style="font-size:12px;line-height:1.4;font-family:Arial,Helvetica,sans-serif;color:#34495e;border: solid 1px #767575;">
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding:2px;background-color:rgb(0,141,210);color:#fff" align="center" width="100%"><b>THARWANI HERITAGE CHS LTD</b></td>
								</tr>
							</tbody></table>
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody>
								<tr>
									<td width="30%" style="border-bottom: solid 1px #767575;    border-top: solid 1px #767575;"></td>
									<td style="padding:5px;border-bottom: solid 1px #767575;    border-top: solid 1px #767575;"  width="70%" align="right">
									<span style="color: rgb(100, 100, 99); ">Regn# &nbsp; NBOM/CIDCO/HSG (OH)/2780/JTR/2008-09</span><br>
									<span style="color: rgb(100, 100, 99); ">Plot 24, Sector 7, Kharghar, Navi Mumbai 410 210</span><br><span>Email:</span><a href="mailto:tharwaniheritage@yahoo.in" target="_blank" style="color:#000 !important;text-decoration: none;">tharwaniheritage@yahoo.in</a> | <span>Phone : 022 27741211</span>
									</td>
								</tr>
								</tbody>
							</table>
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding: 0px 0 0 5px;"><b>Name:</b></td>
									<td>Anmol Singh</td>
									<td><b>Flat/Shop No.:</b></td>
									<td></td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Bill No.:</b></td>
									<td>1203</td>
									<td><b>Area (sq.ft.):</b></td>
									<td>545</td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Bill Date:</b></td>
									<td>01-04-2015</td>
									<td><b>Billing Period:</b></td>
									<td>Apr - Jun  2015</td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Due Date:</b></td>
									<td>01-05-2015</td>
									<td><b>Description:</b></td>
									<td></td>
								</tr>
							</tbody></table>
							<table style="font-size:12px;border-bottom: solid 1px #767575;" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding: 0 0 0 5px;background-color:rgb(0,141,210);color:#fff;border-top: solid 1px #767575;border-bottom: solid 1px #767575;border-right: solid 1px #FFFFFF;" align="left" width="60%"><b>Particulars of charges</b></td>
									<td style="padding: 0 5px 0 0;background-color:rgb(0,141,210);color:#fff;border-top: solid 1px #767575;border-bottom: solid 1px #767575;" align="right" width="40%"><b>Amount (Rs.)</b> </td>
								</tr><tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >CIDCO Service charges</td>
										<td align="right" style="padding: 0 5px 0 0;">572</td>
									</tr><tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >Maintenance charges</td>
										<td align="right" style="padding: 0 5px 0 0;">2520</td>
									</tr><tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >Repair Fund</td>
										<td align="right" style="padding: 0 5px 0 0;">621</td>
									</tr><tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >Sinking Fund</td>
										<td align="right" style="padding: 0 5px 0 0;">196</td>
									</tr><tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >Fire Equipt. Maint Charges</td>
										<td align="right" style="padding: 0 5px 0 0;">156</td>
									</tr></tbody></table>
							<table style="font-size:12px;border-bottom: solid 1px #767575;" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="60%" valign="top" style="border-right: solid 1px #767575;">
										<table style="font-size:11px" width="100%">
											<tbody>
											<tr>
												<td colspan="2" style="padding: 0 0 0 5px;">Cheque/NEFT payment instructions:</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Account Name:</b></td>
												<td width="60%"></td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Account No.:</b></td>
												<td width="60%"></td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Bank Name:</b></td>
												<td width="60%"></td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Branch Name:</b></td>
												<td width="60%"></td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>IFSC no.:</b></td>
												<td width="60%"></td>
											</tr>
										</tbody></table>
									</td>
									<td width="40%" valign="top">
										<table style="font-size:12px" width="100%">
											<tbody><tr>
												<td align="right" width="70%">Total:</td>
												<td align="right" width="30%" style="padding: 0 5px 0 0;">4065</td>
											</tr>
											<tr>
												<td align="right">Interest on arrears:</td>
												<td align="right" style="padding: 0 5px 0 0;">0</td>
											</tr>
											<tr>
												<td align="right">Arrears-Principal:</td>
												<td align="right" style="padding: 0 5px 0 0;">0</td>
											</tr>
											<tr>
												<td align="right">Arrears-Interest:</td>
												<td align="right" style="padding: 0 5px 0 0;">0</td>
											</tr><tr>
												<td align="right" width="60%">Credit/Adjustment:</td>
												<td align="right" width="40%" style="padding: 0 5px 0 0;">0</td>
											</tr><tr>
												<td align="right" width="60%"><b>Due For Payment:</b></td>
												<td align="right" width="40%" style="padding: 0 5px 0 0;">4065</td>
											</tr>
										</tbody></table>
									</td>
								</tr>
							</tbody></table><table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="100%" style="font-size:12px;border-bottom: solid 1px #767575;padding: 0 0 0 5px;"><b>Due For Payment (in words) :</b> Rupees Four Thousand And Sixty-five Only</td>
								</tr>
							</tbody></table><table style="font-size:12px;border-bottom: dotted 1px;" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="50%" style="padding:5px;" valign="top">
									<span>Remarks:</span><br><span>1. Please pay by due date to avoid penal interest.</span><br></td>
									<td align="center" width="50%" style="padding:5px;" valign="top">
									For  <b>Tharwani Heritage CHS Ltd</b><br><br><br>
									<div><span style="border-top:solid 1px #424141">Society Manager</span></div>
									</td>
								</tr>
							</tbody></table>
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td align="center" width="100%">Note: This is a computer generated bill hence no signature required.</td>
								</tr>
							</tbody></table>
							
                            </td>
                        </tr>
                        
                        <tr>
                            <td colspan="2" >
                                <table style="background-color: #008DD2;font-size:11px;color:#FFF;border: solid 1px #767575;border-top:none;" width="100%" cellspacing="0">
                                 <tbody>
								 
									<tr>
                                        <td  align="center" colspan="7"><b>
										Your Society is empowered by HousingMatters - <b/> <i>"Making Life Simpler"</i>
										</td>
                                    </tr>
									<tr>
                                        <td width="50" align="right"><b>Email :</b></td>
                                        <td  width="120" style="color:#FFF !important;"> 
										<a href="mailto:support@housingmatters.in" target="_blank" style="color:#FFF !important;"><b>support@housingmatters.in</b></a>
                                        </td>
										<td align="center"></td>
                                        <td align="right" width="50"><b>Phone :</b></td>
                                        <td width="84" style="color:#FFF !important;text-decoration: none;"><b>022-41235568</b></td>
										<td align="center"></td>
                                        <td width="100" style="padding-right: 10px;text-decoration: none;"> <a href="http://www.housingmatters.in" target="_blank" style="color:#FFF !important;"><b>www.housingmatters.in</b></a></td>
                                    </tr>
                                    <tr>
                                        <td  align="center" colspan="7"><b>
										9887779123 </td>
                                    </tr>
                                    
                                </tbody>
							</table>
                            </td>
                        </tr>
                        <tr>
							<td align="center"><div class="hmlogobox" ><a href="mailto:Support@housingmatters.in">Do not miss important e-mails from HousingMatters,  add us to your address book</a></div></td>
						</tr>
                    </tbody></table>
                </td>
            </tr>
        </tbody></table>
                   
            </div>';
						
	
		

	//exit; 
	$this->loadmodel('society');
	$conditions=array('society_id'=>$s_society_id);
	$result_society=$this->society->find('all',array('conditions'=>$conditions));
	foreach($result_society as $data){
		$society_name=$data["society"]["society_name"];
		$society_reg_num=$data["society"]["society_reg_num"];
		$society_address=$data["society"]["society_address"];
		$society_email=$data["society"]["society_email"];
		$society_phone=$data["society"]["society_phone"];
		//$terms_conditions=$data["society"]["terms_conditions"];
		
		$sig_title=$data["society"]["sig_title"];
		$neft_type = @$data["society"]["neft_type"];
		$neft_detail = @$data["society"]["neft_detail"];
		$society_logo = @$data["society"]["logo"];
		$area_scale = (int)@$data["society"]["area_scale"];
		$email_is_on_off=(int)@$data["society"]["account_email"];
		$sms_is_on_off=(int)@$data["society"]["account_sms"];
}
if($area_scale==0 or $area_scale==null){
	$area_scale_text="sq.ft.";
}
if($area_scale==1){
	$area_scale_text="sq.mtr.";
}
	
	$this->loadmodel('regular_bill');
	$conditions=array('society_id'=>$s_society_id,'edited'=>"no");
	$order=array('regular_bill.bill_number'=>'DESC');
	$regular_bills=$this->regular_bill->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1)); 
	
foreach($regular_bills as $data){
					$auto_id=$data["regular_bill"]["auto_id"];
					$bill_number=$data["regular_bill"]["bill_number"];
					$edit_text=@$data["regular_bill"]["edit_text"];
					 $ledger_sub_account_id=(int)$data["regular_bill"]["ledger_sub_account_id"];
					$billing_cycle=$data["regular_bill"]["billing_cycle"];	
					$income_head_array=$data["regular_bill"]["income_head_array"];
					$income_head_for_rate=@$data["regular_bill"]["income_head_for_rate"];
					$noc_charge=$data["regular_bill"]["noc_charge"];
					$other_charge=$data["regular_bill"]["other_charge"];
					$total=$data["regular_bill"]["total"];
					$arrear_principle=$data["regular_bill"]["arrear_principle"];
					$arrear_intrest=$data["regular_bill"]["arrear_intrest"];
					$intrest_on_arrears=$data["regular_bill"]["intrest_on_arrears"];
					$credit_stock=$data["regular_bill"]["credit_stock"];
					$due_for_payment=$data["regular_bill"]["due_for_payment"];
					$start_date=$data["regular_bill"]["start_date"];
					$end_date=$data["regular_bill"]["end_date"];
					$due_date=$data["regular_bill"]["due_date"];
					$description=$data["regular_bill"]["description"];
					$terms_condition_id=@$data["regular_bill"]["terms_condition_id"];
					$terms_condition_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_terms_condition'), array('pass' => array($terms_condition_id)));
					$terms_conditions=@$terms_condition_info[0]["terms_condition"]["terms_conditions"];
					if(empty($terms_conditions)){
						$terms_conditions=array();
					}
					$result_member_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'member_info_via_ledger_sub_account_id'), array('pass' => array($ledger_sub_account_id))); 
				
						 $user_name=$result_member_info["user_name"];
						 $wing_name=$result_member_info["wing_name"];
						 $flat_name=$result_member_info["flat_name"];
						 $wing_flat=$wing_name.'-'.$flat_name;
						 $email=$result_member_info["email"];
						 $mobile=$result_member_info["mobile"];
						 $wing_id=$result_member_info["wing_id"];
						
					$result_flat_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'flat_info_via_ledger_sub_account_id'), array('pass' => array($ledger_sub_account_id))); 
					$flat_area=$result_flat_info[0]['flat']['flat_area'];
					
					if($neft_type ==  "ALL"){
						$account_name = @$neft_detail['account_name'];	
						$bank_name = @$neft_detail['bank_name'];
						$account_number = @$neft_detail['account_number'];
						$branch = @$neft_detail['branch'];
						$ifsc_code = @$neft_detail['ifsc_code'];	
					}
					if($neft_type ==  "WW"){			
						$neft_detail2 = @$neft_detail[$wing_id];
						$account_name = @$neft_detail2['account_name'];	
						$bank_name = @$neft_detail2['bank_name'];
						$account_number = @$neft_detail2['account_number'];
						$branch = @$neft_detail2['branch'];
						$ifsc_code = @$neft_detail2['ifsc_code'];		
					}
		
					
					if($billing_cycle!=1){
						$billing_period_text=date("M",$start_date).' - '.date("M",$end_date).'  '.date("Y",$end_date);
					}else{
						$billing_period_text=date("M-Y",$start_date);
					}
/// start Html generate for bill//
	 $ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip')); 
		$bill_html='<div style="margin: 0px;">
        <table style="padding:24px;background-color:#34495e" align="center" border="0" cellpadding="0" cellspacing="0" width="100%" class="main_table">
            <tbody><tr>
                <td>
                    <table style="padding:38px 30px 30px 30px;background-color:#fafafa" align="center" border="0" cellpadding="0" cellspacing="0" width="540">
                        <tbody>
						<tr>
							<td height="10">
							<table width="100%" class="hmlogobox">
								<tr>
									<td width="50%" style="padding: 10px 0px 0px 10px;"><img src="'.$ip.$this->webroot.'/as/hm/hm-logo.png" style="max-height: 60px; " height="60px" /></td>
									<td width="50%" align="right" valign="middle"  style="padding: 7px 10px 0px 0px;">
									<a href="https://www.facebook.com/HousingMatters.co.in"><img src="'.$ip.$this->webroot.'/as/hm/SMLogoFB.png"    style="max-height: 30px; height: 30px; width: 30px; max-width: 30px;" height="30px" width="30px" /></a>
									</td>
								</tr>
							</table>
							</td>
						</tr>
						<tr>
							<td height="10"></td>
						</tr>
                        <tr>
                            <td colspan="2" style="font-size:12px;line-height:1.4;font-family:Arial,Helvetica,sans-serif;color:#34495e;border: solid 1px #767575;">
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding:2px;background-color:rgb(0,141,210);color:#fff" align="center" width="100%"><b>'.strtoupper($society_name).'</b></td>
								</tr>
							</tbody></table>
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody>
								<tr>
									<td width="30%" style="border-bottom: solid 1px #767575;    border-top: solid 1px #767575;">';
									if(!empty($society_logo)){
									$bill_html.='<img src="'.$webroot_path.'/logo/'.$society_logo.'"  height="45px" width="45px">';	
									}
						$bill_html.='</td>
									<td style="padding:5px;border-bottom: solid 1px #767575;    border-top: solid 1px #767575;"  width="70%" align="right">
									<span style="color: rgb(100, 100, 99); ">Regn# &nbsp; '.$society_reg_num.'</span><br>
									<span style="color: rgb(100, 100, 99); ">'.$society_address.'</span><br><span>Email :</span><a href="mailto:'.$society_email.'" target="_blank" style="color:#000 !important;text-decoration: none;"> '.$society_email.'</a> | <span>Phone : '.$society_phone.'</span>
									</td>
								</tr>
								</tbody>
							</table>
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding: 0px 0 0 5px;"><b>Name:</b></td>
									<td>'.$user_name.'</td>
									<td><b>Flat/Shop No.:</b></td>
									<td>'.$wing_flat.'</td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Bill No.:</b></td>
									<td>'.$bill_number.$edit_text.'</td>
									<td><b>Area ('.$area_scale_text.'):</b></td>
									<td>'.$flat_area.'</td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Bill Date:</b></td>
									<td>'.date("d-m-Y",$start_date).'</td>
									<td><b>Billing Period:</b></td>
									<td>'.$billing_period_text.'</td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Due Date:</b></td>
									<td>'.date("d-m-Y",$due_date).'</td>
									<td><b>Description:</b></td>
									<td>'.$description.'</td>
								</tr>
							</tbody></table>
							<table style="font-size:12px;border-bottom: solid 1px #767575;" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding: 0 0 0 5px;background-color:rgb(0,141,210);color:#fff;border-top: solid 1px #767575;border-bottom: solid 1px #767575;border-right: solid 1px #FFFFFF;" align="left" width="60%"><b>Particulars of charges</b></td>
									<td style="padding: 0 5px  0;background-color:rgb(0,141,210);color:#fff;border-top: solid 1px #767575;border-bottom: solid 1px #767575;border-right: solid 1px #FFFFFF;" align="center" width="20%"><b>Rate (sq.ft.)</b> </td>
									<td style="padding: 0 5px 0 0;background-color:rgb(0,141,210);color:#fff;border-top: solid 1px #767575;border-bottom: solid 1px #767575;" align="right" width="20%"><b>Amount (Rs.)</b> </td>
								</tr>';
								
								
							foreach($income_head_array as $key=>$value){ 
							$result_income_head = $this->requestAction(array('controller' => 'hms', 'action' => 'ledger_account_fetch2'),array('pass'=>array($key)));	
								foreach($result_income_head as $data2){ 
									$income_head_name = $data2['ledger_account']['ledger_name'];
								}
								if(!empty($value)){
									$bill_html.='<tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >'.$income_head_name.'</td>
										<td align="center" style="border-right: solid 1px #767575;padding: 0 0 0 5px;">';if(!empty($income_head_for_rate[$key])){ $size_of= explode('.',$income_head_for_rate[$key]); if(strlen($size_of[1])>2){ $bill_html.=''.number_format($income_head_for_rate[$key] ,3).''; }else{ $bill_html.=''.number_format($income_head_for_rate[$key] ,2).'';} } $bill_html.=' </td>
										<td align="right" style="padding: 0 5px 0 0;">'.$value.'</td>
									</tr>';
								}
							}
							
							
							if(!empty($noc_charge)){
							$bill_html.='<tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >Non Occupancy charges</td>
										<td align="center" style="border-right: solid 1px #767575;padding: 0 0 0 5px;"></td>
										<td align="right" style="padding: 0 5px 0 0;">'.$noc_charge.'</td>
									</tr>';
							}
							
							foreach($other_charge as $key=>$vlaue){
								$income_head_name = $this->requestAction(array('controller' => 'Fns', 'action' => 'income_head_name_via_income_head_id'),array('pass'=>array($key)));	
																
								$bill_html.='<tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >'.$income_head_name.'</td>
										<td align="center" style="border-right: solid 1px #767575;padding: 0 0 0 5px;"></td>
										<td align="right" style="padding: 0 5px 0 0;">'.$vlaue.'</td>
									</tr>';
							} 
							
							
							$bill_html.='</tbody></table>
							<table style="font-size:12px;border-bottom: solid 1px #767575;" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="60%" valign="top" style="border-right: solid 1px #767575;">
										<table style="font-size:11px" width="100%">
											<tbody>
											<tr>
												<td colspan="2" style="padding: 0 0 0 5px;"><b>Cheque/NEFT payment instructions:</b></td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Account Name:</b></td>
												<td width="60%">'.$account_name.'</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Account No.:</b></td>
												<td width="60%">'.$account_number.'</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Bank Name:</b></td>
												<td width="60%">'.$bank_name.'</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Branch Name:</b></td>
												<td width="60%">'.$branch.'</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>IFSC no.:</b></td>
												<td width="60%">'.$ifsc_code.'</td>
											</tr>
										</tbody></table>
									</td>
									<td width="40%" valign="top">
										<table style="font-size:12px" width="100%">
											<tbody><tr>
												<td align="right" width="70%">Total:</td>
												<td align="right" width="30%" style="padding: 0 5px 0 0;">'.$total.'</td>
											</tr>
											<tr>
												<td align="right">Interest on arrears:</td>
												<td align="right" style="padding: 0 5px 0 0;">'.$intrest_on_arrears.'</td>
											</tr>
											<tr>
												<td align="right">Arrears-Principal:</td>
												<td align="right" style="padding: 0 5px 0 0;">'.$arrear_principle.'</td>
											</tr>
											<tr>
												<td align="right">Arrears-Interest:</td>
												<td align="right" style="padding: 0 5px 0 0;">'.$arrear_intrest.'</td>
											</tr>';
								
								$credit_stock_text=$credit_stock;
								$bill_html.='<tr>
												<td align="right" width="60%">Credit/Adjustment:</td>
												<td align="right" width="40%" style="padding: 0 5px 0 0;">'.$credit_stock_text.'</td>
											</tr>';
								$bill_html.='<tr>
												<td align="right" width="60%"><b>Due For Payment:</b></td>
												<td align="right" width="40%" style="padding: 0 5px 0 0;">'.$due_for_payment.'</td>
											</tr>
										</tbody></table>
									</td>
								</tr>
							</tbody></table>';
							$due_for_payment = str_replace( ',', '', $due_for_payment );
							if($due_for_payment<0){
							$write_am_word="Nil";
							}else{
								
							$am_in_words=ucwords(strtolower($this->requestAction(array('controller' => 'Hms', 'action' => 'convert_number_to_words'),array('pass'=>array($due_for_payment)))));
							$write_am_word="Rupees ".$am_in_words." Only";
							}
							$bill_html.='<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="100%" style="font-size:12px;border-bottom: solid 1px #767575;padding: 0 0 0 5px;"><b>Due For Payment (in words) :</b> '.$write_am_word.'</td>
								</tr>
							</tbody></table>';
							$bill_html.='<table style="font-size:12px;border-bottom:1px solid;" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="100%" style="padding:5px;" valign="top">
									<span>Remarks:</span><br>';
									$inc_t_c=0;
									foreach($terms_conditions as $t_c){ $inc_t_c++;
										$bill_html.='<span>'.$inc_t_c.'. '.$t_c.'</span><br>';
									}
									
									$bill_html.='</td>
								</tr>
							</tbody></table>';
							/// Receipt code start //
							$result_last_receipt=$this->requestAction(array('controller' => 'Incometrackers', 'action' => 'print_show_last_receipt'), array('pass' => array($ledger_sub_account_id)));
							if(sizeof($result_last_receipt)>0){ 
							$bill_html.='<table style="font-size:12px;" width="100%" cellspacing="0">
									<tbody><tr>
										<td style="padding:2px;background-color:rgb(0,141,210);color:#fff" align="center" width="100%"><b>R E C E I P T</b></td>
									</tr>
								</tbody></table>
								<table style="font-size:12px;border-bottom:1px solid;" width="100%" cellspacing="0">
									<tbody>
									<tr>
										<td style="padding:5px;border-top:solid 1px #767575" width="100%" align="left">
										<span style="color:rgb(100,100,99)">
										There are showing last three receipt. to Details of last three payments received.<br/>
										Received with thanks from: <b>'.$user_name.' '.$wing_flat.'</b>
										
										</span>
										</td>
									</tr>
									</tbody>
								</table>
								<table style="font-size:12px;border-bottom:1px solid;" width="100%" cellspacing="0">
								<thead>
								<th style="border-bottom: solid 1px;border-right: solid 1px;">Date</th>
								<th style="border-bottom: solid 1px;border-right: solid 1px;">Receipt# </th>
								<th style="border-bottom: solid 1px;border-right: solid 1px;">Cheque/Neft </th>
								<th style="border-bottom: solid 1px;border-right: solid 1px;">Drawee Bank</th>
								<th style="border-bottom: solid 1px;">Amount(Rs.)</th>
								
								</thead>
								<tbody>';
								
								 
	// pr($result_last_receipt);
	
		$total_receipt=0;
			foreach($result_last_receipt as $receipt){

				$auto_id=$receipt["cash_bank"]["transaction_id"];
				$receipt_number=$receipt["cash_bank"]["receipt_number"];
				$transaction_date=$receipt["cash_bank"]["transaction_date"];
				$received_from=$receipt["cash_bank"]["received_from"];
				$date=date("d-m-Y",$transaction_date);			
				$cheque_number=$receipt["cash_bank"]["cheque_number"];
				$narration=$receipt["cash_bank"]["narration"];
				$amount=$receipt["cash_bank"]["amount"];
				$drown_in_which_bank=$receipt["cash_bank"]["drown_in_which_bank"];
				$cheque_date=$receipt["cash_bank"]["date"];
				
			    $total_receipt+=$amount;
				
				// start Email & Sms code
				$bill_html.='<tr>
								<td style="text-align:center;border-right: solid 1px;">'.$date.'</td>
								<td style="text-align:center;border-right: solid 1px;">'.$receipt_number.'</td>
								<td style="border-right: solid 1px;" align="right">'.$cheque_number.'</td>
								<td style="text-align:center;border-right: solid 1px;">'.$drown_in_which_bank.'</td>
								<td align="right" style="padding-right: 6px;">'.$amount.'</td>
								</tr>';
								
								
		
	   }
	
				$total_receipt = str_replace( ',', '', $total_receipt );
					$am_in_words=ucwords($this->requestAction(array('controller' => 'hms', 'action' => 'convert_number_to_words'), array('pass' => array($total_receipt))));
								
						$bill_html.='</tbody></table>
						<table style="font-size:12px;border-bottom:1px solid" width="100%" cellspacing="0">
									<tbody>
									<tr>
										<td style="padding:0px 0 2px 5px"  colspan="4">Rupees '.$am_in_words.' Only </td>
										<td align="right"><b>Total: '.$total_receipt.'</b></td>
									</tr>';
								
									
									$bill_html.='
									
									
									
								</tbody></table>';	
							}								
								
							$bill_html.='<table style="font-size:12px;border-bottom: dotted 1px;" width="100%" cellspacing="0">
								<tbody><tr>
								<td align="right" width="60%" style="padding:5px;" valign="top">
									<br/>For  <b>'.$society_name.'</b>: <span >'.$sig_title.'</span>
									
									</td>
									<td align="right" width="40%" style="padding:0px 20px 5px 20px;" valign="bottom">
									<br/><div style="border-bottom:solid 1px #424141"></div>
									</td>
								</tr>
							</tbody></table>
							
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td align="center" width="100%">Note: This is a computer generated bill hence no signature required.</td>
								</tr>
							</tbody></table>
							
                            </td>
                        </tr>
                        
                        <tr>
                            <td colspan="2" >
                                <table style="background-color: #008DD2;font-size:11px;color:#FFF;border: solid 1px #767575;border-top:none;" width="100%" cellspacing="0">
                                 <tbody>
								 
									<tr>
                                        <td  align="center" colspan="7"><b>
										Your Society is empowered by HousingMatters - <b/> <i>"Making Life Simpler"</i>
										</td>
                                    </tr>
									<tr>
                                        <td width="20" align="right"><b></b></td>
                                        <td  width="120" style="color:#FFF !important;"> 
										<a href="mailto:support@housingmatters.in" target="_blank" style="color:#FFF !important;"><b>support@housingmatters.in</b></a>
                                        </td>
										<td align="center"></td>
                                        <td align="right" width="50"><b><a href="intent://send/+919869157561#Intent;scheme=smsto;package=com.whatsapp;action=android.intent.action.SENDTO;end"  style="display:none;"><img src="'.$ip.$this->webroot.'/as/hm/whatsup.png"  width="18px" /></a></b></td>
                                        <td width="104" style="color:#FFF !important;text-decoration: none;"><b  style="display:none;">+91-9869157561</b></td>
										<td align="center"></td>
                                        <td width="100" style="padding-right: 10px;text-decoration: none;"> <a href="http://www.housingmatters.in" target="_blank" style="color:#FFF !important;"><b>www.housingmatters.in</b></a></td>
                                    </tr>
                                                                       
                                </tbody>
							</table>
                            </td>
                        </tr>
                        <tr>
							<td align="center"><div class="hmlogobox" ><a href="mailto:Support@housingmatters.in">Do not miss important e-mails from HousingMatters,  add us to your address book</a></div></td>
						</tr>
                    </tbody></table>
                </td>
            </tr>
        </tbody></table>
                   
            </div>';
	
	
	}
$bill='<div style="margin: 0px;">
        <table style="padding:24px;background-color:#34495e" align="center" border="0" cellpadding="0" cellspacing="0" width="100%" class="main_table">
            <tbody><tr>
                <td>
                    <table style="padding:38px 30px 30px 30px;background-color:#fafafa" align="center" border="0" cellpadding="0" cellspacing="0" width="540">
                        <tbody>
						<tr>
							<td height="10">
							<table width="100%" class="hmlogobox">
								<tr>
									<td width="50%" style="padding: 10px 0px 0px 10px;"><img src="http://app.housingmatters.co.in/new_hm//as/hm/hm-logo.png" style="max-height: 60px; " height="60px" /></td>
									<td width="50%" align="right" valign="middle"  style="padding: 7px 10px 0px 0px;">
									<a href="https://www.facebook.com/HousingMatters.co.in"><img src="http://app.housingmatters.co.in/new_hm//as/hm/SMLogoFB.png"    style="max-height: 30px; height: 30px; width: 30px; max-width: 30px;" height="30px" width="30px" /></a>
									</td>
								</tr>
							</table>
							</td>
						</tr>
						<tr>
							<td height="10"></td>
						</tr>
                        <tr>
                            <td colspan="2" style="font-size:12px;line-height:1.4;font-family:Arial,Helvetica,sans-serif;color:#34495e;border: solid 1px #767575;">
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding:2px;background-color:rgb(0,141,210);color:#fff" align="center" width="100%"><b>SKYLARK CHS LTD</b></td>
								</tr>
							</tbody></table>
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody>
								<tr>
									<td width="30%" style="border-bottom: solid 1px #767575;    border-top: solid 1px #767575;"></td>
									<td style="padding:5px;border-bottom: solid 1px #767575;    border-top: solid 1px #767575;"  width="70%" align="right">
									<span style="color: rgb(100, 100, 99); ">Regn# &nbsp; NBOM/CIDCO/HSG(OH)/2821/JTR/2008-09</span><br>
									<span style="color: rgb(100, 100, 99); ">Sector-6 Plot no. 8- B Kharghar Navi Mumbai -410210</span><br><span>Email :</span><a href="mailto:jaisonkamble@yahoo.com" target="_blank" style="color:#000 !important;text-decoration: none;"> jaisonkamble@yahoo.com</a> | <span>Phone : 9322851515</span>
									</td>
								</tr>
								</tbody>
							</table>
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding: 0px 0 0 5px;"><b>Name:</b></td>
									<td>Harichha Joshi & Jethalal C Joshi</td>
									<td><b>Flat/Shop No.:</b></td>
									<td>Flat-102</td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Bill No.:</b></td>
									<td>1131</td>
									<td><b>Area (sq.ft.):</b></td>
									<td>889</td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Bill Date:</b></td>
									<td>01-01-2017</td>
									<td><b>Billing Period:</b></td>
									<td>Jan - Mar  2017</td>
								</tr>
								<tr>
									<td style="padding: 0px 0 0 5px;"><b>Due Date:</b></td>
									<td>15-02-2017</td>
									<td><b>Description:</b></td>
									<td></td>
								</tr>
							</tbody></table>
							<table style="font-size:12px;border-bottom: solid 1px #767575;" width="100%" cellspacing="0">
								<tbody><tr>
									<td style="padding: 0 0 0 5px;background-color:rgb(0,141,210);color:#fff;border-top: solid 1px #767575;border-bottom: solid 1px #767575;border-right: solid 1px #FFFFFF;" align="left" width="60%"><b>  B I L L - Particulars of charges</b></td>
									<td style="padding: 0 5px  0;background-color:rgb(0,141,210);color:#fff;border-top: solid 1px #767575;border-bottom: solid 1px #767575;border-right: solid 1px #FFFFFF;" align="center" width="20%"><b>Rate (sq.ft.)</b> </td>
									<td style="padding: 0 5px 0 0;background-color:rgb(0,141,210);color:#fff;border-top: solid 1px #767575;border-bottom: solid 1px #767575;" align="right" width="20%"><b>Amount (Rs.)</b> </td>
								</tr><tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >Building Painting Fund</td>
										<td align="center" style="border-right: solid 1px #767575;padding: 0 0 0 5px;">1.20 </td>
																	
										<td align="right" style="padding: 0 5px 0 0;">3200</td>
									</tr><tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >Maintenance charges</td>
										<td align="center" style="border-right: solid 1px #767575;padding: 0 0 0 5px;">1.95 </td>
																	
										<td align="right" style="padding: 0 5px 0 0;">5201</td>
									</tr><tr>
										<td align="left" style="border-right: solid 1px #767575;padding: 0 0 0 5px;" >Sinking Fund</td>
										<td align="center" style="border-right: solid 1px #767575;padding: 0 0 0 5px;">0.65 </td>
																	
										<td align="right" style="padding: 0 5px 0 0;">1734</td>
									</tr></tbody></table>
							<table style="font-size:12px;border-bottom: solid 1px #767575;" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="60%" valign="top" style="border-right: solid 1px #767575;">
										<table style="font-size:11px" width="100%">
											<tbody>
											<tr>
												<td colspan="2" style="padding: 0 0 0 5px;"><b>Cheque/NEFT payment instructions:</b></td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Account Name:</b></td>
												<td width="60%">Skylark CHS Ltd</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Current account no.:</b></td>
												<td width="60%">056011100002832</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Bank Name:</b></td>
												<td width="60%">ABHYUDAYA CO-OP BANK LTD</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>Branch Name:</b></td>
												<td width="60%">KHARGHAR</td>
											</tr>
											<tr>
												<td width="40%" style="padding: 0 0 0 5px;"><b>IFSC no.:</b></td>
												<td width="60%">ABHY0065042</td>
											</tr>
										</tbody></table>
									</td>
									<td width="40%" valign="top">
										<table style="font-size:12px" width="100%">
											<tbody><tr>
												<td align="right" width="70%">Sub-total:</td>
												<td align="right" width="30%" style="padding: 0 5px 0 0;">10135</td>
											</tr>
											<tr>
												<td align="right">Interest on arrears:</td>
												<td align="right" style="padding: 0 5px 0 0;">0</td>
											</tr>
											<tr>
												<td align="right">Arrears-Principal:</td>
												<td align="right" style="padding: 0 5px 0 0;">10135</td>
											</tr>
											<tr>
												<td align="right">Arrears-Interest:</td>
												<td align="right" style="padding: 0 5px 0 0;">0</td>
											</tr><tr>
												<td align="right" width="60%">Credit/Adjustment:</td>
												<td align="right" width="40%" style="padding: 0 5px 0 0;">0</td>
											</tr><tr>
												<td align="right" width="60%"><b>Due For Payment:</b></td>
												<td align="right" width="40%" style="padding: 0 5px 0 0;">20270</td>
											</tr>
										</tbody></table>
									</td>
								</tr>
							</tbody></table><table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="100%" style="font-size:12px;border-bottom: solid 1px #767575;padding: 0 0 0 5px;"><b>Due For Payment (in words) :</b> Rupees Twenty Thousand  Two Hundred And Seventy Only</td>
								</tr>
							</tbody></table><table style="font-size:12px;border-bottom: dotted 1px;" width="100%" cellspacing="0">
								<tbody><tr>
									<td width="100%" style="padding:5px;" valign="top">
									<span>Remarks:</span><br><span>1. Please promptly pay by due date.</span><br><span>2. Late payment charges @21% p.a.</span><br><span>3. Pay by a/c payee cheque or bank transfers. Kindly update Society office for direct deposits/bank transfers.</span><br><span>4. All payments till 30.09.2016 are accounted in this bill. Subsequent payments will be reflected/credited in next quarter bills.</span><br><span>5. Go green, keep our society neat and clean!</span><br></td>
								</tr>
							</tbody></table><table style="font-size:12px;" width="100%" cellspacing="0">
									<tbody><tr>
										<td style="padding:2px;background-color:rgb(0,141,210);color:#fff" align="center" width="100%"><b>R E C E I P T</b></td>
									</tr>
								</tbody></table>
								<table style="font-size:12px;border-bottom:1px solid;" width="100%" cellspacing="0">
								   <tbody>
									<tr>
										<td style="padding:5px;border-top:solid 1px #767575" width="100%" align="left">
										<span style="color:rgb(100,100,99)">
										Received with thanks from: <b>Harichha Joshi & Jethalal C Joshi Flat-102</b>
										 <br/>
										Details of last three payments received before 01-01-2017
										</span>
										</td>
									</tr>
									</tbody>
								</table>
								<table style="font-size:12px;border-bottom:1px solid;" width="100%" cellspacing="0">
								<thead>
								<th style="border-bottom: solid 1px;border-right: solid 1px;">Date</th>
								<th style="border-bottom: solid 1px;border-right: solid 1px;">Receipt# </th>
								<th style="border-bottom: solid 1px;border-right: solid 1px;">Cheque/Neft </th>
								<th style="border-bottom: solid 1px;border-right: solid 1px;">Drawee Bank</th>
								<th style="border-bottom: solid 1px;">Amount (Rs.)</th>
								
								</thead>
								<tbody><tr>
								<td style="text-align:center;border-right: solid 1px;">27-09-2016</td>
								<td style="text-align:center;border-right: solid 1px;">1043</td>
								<td style="border-right: solid 1px;padding-right: 6px;" align="right">301336</td>
								<td style="text-align:center;border-right: solid 1px;">IDBI</td>
								<td align="right" style="padding-right: 6px;">10137</td>
								</tr><tr>
								<td style="text-align:center;border-right: solid 1px;">27-05-2016</td>
								<td style="text-align:center;border-right: solid 1px;">1002</td>
								<td style="border-right: solid 1px;padding-right: 6px;" align="right">604376</td>
								<td style="text-align:center;border-right: solid 1px;">NA</td>
								<td align="right" style="padding-right: 6px;">10137</td>
								</tr></tbody></table>
						<table style="font-size:12px;border-bottom:1px solid" width="100%" cellspacing="0">
									<tbody>
									<tr>
										<td style="padding:0px 0 2px 5px"  colspan="4">Rupees Twenty Thousand  Two Hundred And Seventy-four Only </td>
										<td align="right" style="padding-right: 6px;"><b>Total: Rs 20274</b></td>
									</tr>
									
									
									
								</tbody></table><table style="font-size:12px;border-bottom: dotted 1px;" width="100%" cellspacing="0">
								<tbody><tr>
								<td align="right" width="60%" style="padding:5px;" valign="top">
									<br/>For  <b>Skylark CHS Ltd</b>: <span >Treasurer</span>
									
									</td>
									<td align="right" width="40%" style="padding:0px 20px 5px 20px;" valign="bottom">
									<br/><div style="border-bottom:solid 1px #424141"></div>
									</td>
								</tr>
							</tbody></table>
							<table style="font-size:12px" width="100%" cellspacing="0">
								<tbody><tr>
									<td align="center" width="100%">Note: This is a computer generated bill hence no signature required.</td>
								</tr>
							</tbody></table>
							
                            </td>
                        </tr>
                        
                        <tr>
                            <td colspan="2" >
                                <table style="background-color: #008DD2;font-size:11px;color:#FFF;border: solid 1px #767575;border-top:none;" width="100%" cellspacing="0">
                                 <tbody>
								 
									<tr>
                                        <td  align="center" colspan="7"><b>
										Your Society is empowered by HousingMatters - <b/> <i>"Making Life Simpler"</i>
										</td>
                                    </tr>
									<tr>
                                        <td width="20" align="right"><b></b></td>
                                        <td  width="120" style="color:#FFF !important;"> 
										<a href="mailto:support@housingmatters.in" target="_blank" style="color:#FFF !important;"><b>support@housingmatters.in</b></a>
                                        </td>
										<td align="center"></td>
                                        <td align="right" width="50"><b></b></td>
                                        <td width="104" style="color:#FFF !important;text-decoration: none;"></td>
										<td align="center"></td>
                                        <td width="100" style="padding-right: 10px;text-decoration: none;"> <a href="http://www.housingmatters.in" target="_blank" style="color:#FFF !important;"><b>www.housingmatters.in</b></a></td>
                                    </tr>
                                                                       
                                </tbody>
							</table>
                            </td>
                        </tr>
                        <tr>
							<td align="center"><div class="hmlogobox" ><a href="mailto:Support@housingmatters.in">Do not miss important e-mails from HousingMatters,  add us to your address book</a></div></td>
						</tr>
                    </tbody></table>
                </td>
            </tr>
        </tbody></table>
                   
            </div>';
	
	$to="rohitkumarjoshi43@gmail.com";
	$reply="rohitkumarjoshi43@gmail.com";
	$from="alerts@housingmatters.in";
	$from_name="Bill and receipt responsive";
	$subject="Bill and receipt responsive";
	//$this->smtpmailer($to,$from,$from_name,$subject,$bill,$reply);
	
	
	*/
	
	
	
}



function user_deactive()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();	

$s_society_id=$this->Session->read('society_id');	
$this->loadmodel('society');	
$conditions=array('society_id'=>$s_society_id);	
$this->set('result_society',$this->society->find('all',array('conditions'=>$conditions)));


$this->loadmodel('user');
$conditions=array('society_id'=>$s_society_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
$this->set('result_user_deactive',$result);
}

function user_deactive_ajax()
{
		$this->layout="blank_signup";
		$s_society_id=$this->Session->read('society_id');
		$user_id=(int)$this->request->query['t']; 
		 $user_flat_id=(int)$this->request->query['user_flat_id'];
		 $status=(int)$this->request->query['d'];
		
		$this->loadmodel('user_flat');
		$conditions6=array('user_flat_id'=>$user_flat_id);
		$result_user_f=$this->user_flat->find('all',array('conditions'=>$conditions6));
		$flat_id=$result_user_f[0]['user_flat']['flat_id'];
		
	  $this->set('user_id',$user_id);
	 $this->set('det',$status);
	 if($status==0)
	 {
		
		date_default_timezone_set('Asia/kolkata');
		$date=date("d-m-Y");
		$time=date('h:i:a',time());
		$exit_date1 = date('Y-m-d',strtotime($date));
		//$exit_date1 = "2015-2-5";
		//$exit_date1 = date('Y-m-d',strtotime($exit_date1));
		$exit_date = strtotime($exit_date1); 
		$this->loadmodel('user_flat');
		$this->user_flat->updateAll(array('active'=>1,'exit_date'=>$exit_date,'time'=>$time),array('user_flat_id'=>$user_flat_id));
		
		
		$this->loadmodel('log');
		$i=$this->autoincrement('log','log_id');
		$this->log->save(array('log_id'=>$i,'user_id'=>$user_id,'society_id'=>$s_society_id,'deactive_date'=>$date,'deactive_time'=>$time,'status'=>1));
		
		$this->loadmodel('ledger_sub_account');
		$this->ledger_sub_account->updateAll(array('deactive'=>1,"exit_date"=>$exit_date),array('user_id'=>$user_id,'flat_id'=>$flat_id));
		
		
		$this->loadmodel('user_flat');
		$conditions=array('user_id'=>$user_id,'active'=>0);
		$result_user=$this->user_flat->find('count',array('conditions'=>$conditions));
		
			if($result_user==0){
			$this->loadmodel('user');
			$this->user->updateAll(array('deactive'=>1),array('user_id'=>$user_id));
			}
	 }
	 
	 
	 if($status==1)
	 {
		 
		
		date_default_timezone_set('Asia/kolkata');
		$date=date("d-m-Y");
		$time=date('h:i:a',time());
		$exit_date1 = date('Y-m-d',strtotime($date));
		$exit_date = strtotime($exit_date1); 
		
		$this->loadmodel('user_flat');
		$conditions=array('flat_id'=>$flat_id,'active'=>0);
		$result_user=$this->user_flat->find('count',array('conditions'=>$conditions));
		if($result_user==0){
		
		$this->loadmodel('user_flat');
		$this->user_flat->updateAll(array('active'=>0,'exit_date'=>$exit_date,'time'=>$time),array('user_flat_id'=>$user_flat_id));
		
		$this->loadmodel('user');
		$this->user->updateAll(array('deactive'=>0),array('user_id'=>$user_id));
		
		$this->loadmodel('log');
		$i=$this->autoincrement('log','log_id');
		$this->log->save(array('log_id'=>$i,'user_id'=>$user_id,'society_id'=>$s_society_id,'active_date'=>$date,'active_time'=>$time,'status'=>2));
		
		$this->loadmodel('ledger_sub_account');
		$this->ledger_sub_account->updateAll(array('deactive'=>0,"exit_date"=>$exit_date),array('user_id'=>$user_id,'flat_id'=>$flat_id)); 
		$output = json_encode(array('report_type'=>'done', 'text' => ''));
		die($output);
		
		}else{
			$output = json_encode(array('report_type'=>'exits', 'text' => ''));
			die($output);
			
		}
	 }
		
}

	function all_user_deactive(){
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id,'active'=>'yes');
	return $result_user=$this->user->find('all',array('conditions'=>$conditions));
	}


	function all_owner_deactive(){
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
		$this->loadmodel('user');
		$conditions=array('society_id'=>$s_society_id,'active'=>'yes');
		$result_users=$this->user->find('all',array('conditions'=>$conditions));
		foreach($result_users as $result_user){
			$user_id=(int)$result_user['user']['user_id'];	
		}
	
	
	
	
	
	}


function all_tenant_deactive()
{
	$s_society_id=$this->Session->read('society_id');
	$s_user_id=$this->Session->read('user_id');
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id,'tenant'=>2,'deactive'=>0);
	return $result_user=$this->user->find('all',array('conditions'=>$conditions));
}



function all_role_wise_deactive($role_id)
{
	
	$s_society_id=$this->Session->read('society_id');
	$s_user_id=$this->Session->read('user_id');
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id,'role_id'=>(int)$role_id,'deactive'=>0);
	return $result_user=$this->user->find('all',array('conditions'=>$conditions));
}


function all_wing_wise_deactive($wing_id)
{
	$s_society_id=$this->Session->read('society_id');
	$s_user_id=$this->Session->read('user_id');
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id,'wing'=>(int)$wing_id,'deactive'=>0);
	return $result_user=$this->user->find('all',array('conditions'=>$conditions));
}

//Start multiple_flat//
function multiple_flat()
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
	$this->ath();
	$this->check_user_privilages();	
	$s_society_id=(int)$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->set('s_society_id',$s_society_id);
	$this->seen_alert(105,$s_user_id);
	
	/*$this->loadmodel('ledger_sub_account');
	$condition=array('society_id'=>$s_society_id,'ledger_id'=>34);
	$members=$this->ledger_sub_account->find('all',array('conditions'=>$condition));
	foreach($members as $data3){
	$ledger_sub_account_ids[]=$data3["ledger_sub_account"]["auto_id"];
	}
 $this->loadmodel('wing');
        $condition=array('society_id'=>$s_society_id);
        $order=array('wing.wing_name'=>'ASC');
        $wings=$this->wing->find('all',array('conditions'=>$condition,'order'=>$order));
        foreach($wings as $data){
			$wing_id=$data["wing"]["wing_id"];
			$this->loadmodel('flat');
			$condition=array('society_id'=>$s_society_id,'wing_id'=>$wing_id);
			$order=array('flat.flat_name'=>'ASC');
			$flats=$this->flat->find('all',array('conditions'=>$condition,'order'=>$order));
			foreach($flats as $data2){
				$flat_id=$data2["flat"]["flat_id"];
				$ledger_sub_account_id = $this->requestAction(array('controller' => 'Fns', 'action' => 'ledger_sub_account_id_via_wing_id_and_flat_id'),array('pass'=>array($wing_id,$flat_id)));
				if(!empty($ledger_sub_account_id)){
					if (in_array($ledger_sub_account_id, $ledger_sub_account_ids)){
						$members_for_billing[]=$ledger_sub_account_id;
					}
				}
			}
		}*/
		$this->set(compact("members_for_billing"));	

		if($this->request->is('post')){
		   $user_sel=(int)$this->request->data['resident_id'];
		   $wing=(int)$this->request->data['wing'];
		   $flat=(int)$this->request->data['fflt'];
	 
$user_data = $this->requestAction(array('controller' => 'Fns', 'action' => 'user_info_via_user_id'),array('pass'=>array($user_sel)));
foreach($user_data as $data){
$user_name = $data['user']['user_name'];
}

$this->loadmodel('user_flat');
$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$user_sel,'society_id'=>$s_society_id,'flat'=>$flat,'wing'=>$wing,'exited'=>'no','owner'=>'yes'));

$this->loadmodel('ledger_sub_account');
$j=$this->autoincrement('ledger_sub_account','auto_id');
$this->ledger_sub_account->save(array('auto_id'=>$j,'ledger_id'=>34,'name'=>$user_name,'society_id' => $s_society_id,'user_id'=>$user_sel,'user_flat_id'=>$user_flat_id,'exited'=>'no'));
?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Successfully add multiple flat
</div> 
<div class="modal-footer">
<a href="multiple_flat" class="btn green">OK</a>
</div>
</div>
<!----alert--------------><?php
}	
	$this->loadmodel('wing');
	$conditions=array("society_id"=>$s_society_id);
	$cursor1 = $this->wing->find('all',array('conditions'=>$conditions));
	$this->set('wing_data',$cursor1);
	
	$this->loadmodel('user');
	$conditions=array("society_id"=>$s_society_id);
	$user_data = $this->user->find('all',array('conditions'=>$conditions));
	$this->set('user_data',$user_data);
	
	$this->loadmodel('user');
	$conditions=array("society_id"=>$s_society_id,"active"=>"yes");
	$order=array('user.user_name'=>'ASC');	
	$users=$this->user->find('all',array('conditions'=>$conditions,'order'=>$order));
	foreach($users as $user_info){
		$user_id=$user_info["user"]["user_id"];
		$user_name=$user_info["user"]["user_name"];
		$user_type=$user_info["user"]["user_type"];
		$mobile=$user_info["user"]["mobile"];
		$email=$user_info["user"]["email"];
		$validation_status=@$user_info["user"]["validation_status"];
		$date=$user_info["user"]["date"];
		
		if($user_type=="member" or $user_type=="family_member"){
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'),array('pass'=>array($user_id)));
			$flats=array(); $resident=array();	$flats1=array();
			foreach($user_flat_info as $user_flat){
				$user_flat_id=$user_flat["user_flat"]["user_flat_id"];
				$wing=$user_flat["user_flat"]["wing"];
				$flat=$user_flat["user_flat"]["flat"];
				$owner=@$user_flat["user_flat"]["owner"];
				$exited=$user_flat["user_flat"]["exited"];
					if($exited=="no"){
					$this->loadmodel('wing');
					$conditions=array("wing_id"=>$wing);
					$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
					$wing_name=@$wing_info[0]["wing"]["wing_name"];
					
					$this->loadmodel('flat');
					$conditions=array("flat_id"=>$flat);
					$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
					$flat_name=ltrim(@$flat_info[0]["flat"]["flat_name"],'0');
					$flat_name_new=@$flat_info[0]["flat"]["flat_name"];
					$flats[$user_flat_id]=$wing_name.' - '.$flat_name;
					$flats1[$user_flat_id]=$wing_name.' - '.$flat_name_new;
					if($owner=="yes" && (!empty($wing) && !empty($flat))){
								$this->loadmodel('flat');
								$conditions=array("wing_id"=>$wing,"flat_id"=>$flat);
								$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
								
								$noc_status=@$flat_info[0]["flat"]["noc_ch_tp"];
								if($noc_status==1){
									$resident[$user_flat_id]=1;
								}
							}elseif($owner=="no" && (!empty($wing) && !empty($flat))){
								$resident[$user_flat_id]=1;
							}
					
					
					
					
					
				}
				
			} 
			
		$this->loadmodel('user_role');
		$conditions=array("user_id"=>$user_id,"society_id"=>$s_society_id);
		$user_role_info=$this->user_role->find('all',array('conditions'=>$conditions));
		$roles=array(); $count_member_owner=0;
		$count_member_tenant=0; $count_member_family=0;$count_member_family_owner=0;$count_member_family_tenant=0;
		
		$x=0;$z=0;$y=0;$f=0;
		foreach($user_role_info as $user_role){
			$role_id=$user_role["user_role"]["role_id"];
			
			$this->loadmodel('role');
			$conditions=array("role_id"=>$role_id);
			$role_info=$this->role->find('all',array('conditions'=>$conditions));
			$roles[]=$role_info[0]["role"]["role_name"];
			
			if($role_id==3){
				$x++;
				$count_member_owner+=$x;
			}
			
			if($role_id==4){
				$z++;
				$count_member_tenant+=$z;
			}
			
			if($role_id==5){
				$f++;
				$count_member_family_owner+=$f;
			}
			if($role_id==6){
				$y++;
				$count_member_family_tenant+=$y;
			}
		}
		$roles=implode(',',$roles);
		
		$arranged_users[$user_id]=array("user_name"=>$user_name,"wing_flat"=>$flats,"roles"=>$roles,"mobile"=>$mobile,"email"=>$email,"validation_status"=>$validation_status,"date"=>$date,"user_flat_id"=>$user_flat_id,"count_member_owner"=>$count_member_owner,"count_member_tenant"=>$count_member_tenant,"count_member_family_owner"=>$count_member_family_owner,"count_member_family_tenant"=>$count_member_family_tenant,'resident_member'=>$resident,'user_id'=>$user_id,'flat_asc'=>$flats1,);
			
			
			
			
		}
		
		
	}
	
	
	$this->set('multiple_member_info',$arranged_users);
	
}

//End multiple_flat//
//Start Multiple Flat Ajax1//
function multiple_flat_ajax1()
{
    $this->layout="blank";
	 $flat_id=(int)$this->request->query('vb');	
	 $this->loadmodel('flat');
	 $this->set('result_flat',$this->flat->find('all',array('conditions'=>array('wing_id'=>$flat_id))));
	
}
//End Multiple Flat Ajax1//
//Start Multiple_flat_ajax//
function multiple_flat_ajax()
{
		$this->layout="blank";
		$s_society_id=$this->Session->read('hm_society_id');
		$wing_id = (int)$this->request->query('wngg');
	    $value = $this->request->query('vv');	
        $this->set('value',$value);
				
		if(!empty($value)){
			$this->loadmodel('user_flat');
			$conditions=array('user_id'=>$wing_id,"society_id"=>$s_society_id,'exited'=>'no');
			$result2=$this->user_flat->find('all',array('conditions'=>$conditions));
			$this->set('user_flat_data',$result2);
		}
		
		$this->loadmodel('flat');
		$conditions=array('wing_id'=>$wing_id,"society_id"=>$s_society_id);
		$result=$this->flat->find('all',array('conditions'=>$conditions));
		
		$this->set('flat_data',$result);

}	
//End Multiple_flat_ajax//
//Start flat_name_via_wing_id//
function flat_name_via_wing_id($wing_id)
{
$s_society_id=(int)$this->Session->read('society_id');
$this->loadmodel('flat');
$conditions=array("wing_id" =>(int)$wing_id,"society_id"=>$s_society_id);
$order=array('flat.flat_name'=>'ASC');
return $this->flat->find('all',array('conditions'=>$conditions,'order'=>$order));
}
//End flat_name_via_wing_id//
//Start profile_picture// 
function profile_picture($user_id)
{
$this->loadmodel('user');
$conditions=array("user_id" => $user_id);
return $this->user->find('all',array('conditions'=>$conditions));
}
//End profile_picture// 
function wing_flat($wing_id,$flat_id)
{
$this->loadmodel('wing');
$conditions=array("wing_id" => $wing_id);
$result=$this->wing->find('all',array('conditions'=>$conditions));
foreach($result as $data)
{
$wing_name=$data['wing']['wing_name'];
}
$this->loadmodel('flat');
$conditions=array("flat_id" => $flat_id);
$result2=$this->flat->find('all',array('conditions'=>$conditions));
foreach($result2 as $data)
{
$flat_name=$data['flat']['flat_name'];
$flat_name=ltrim($flat_name,'0');
}
if(!empty($wing_name) && !empty($flat_name))
{
return @$wing_name.'-'.@$flat_name;
}
}

///////////////////////// Start wing flat with bracket ///////////////////////////////////
function wing_flat_with_brackets($wing_id,$flat_id)
{
$this->loadmodel('wing');
$conditions=array("wing_id" => $wing_id);
$result=$this->wing->find('all',array('conditions'=>$conditions));
foreach($result as $data)
{
$wing_name=$data['wing']['wing_name'];
}

$this->loadmodel('flat');
$conditions=array("flat_id" => $flat_id);
$result2=$this->flat->find('all',array('conditions'=>$conditions));
foreach($result2 as $data)
{
$flat_name=$data['flat']['flat_name'];
}
if(!empty($wing_name) && !empty($flat_name))
{
$wing_flat = "( " .$wing_name." - ".$flat_name." )";
return $wing_flat;
}
}

function fetch_flat_detail_via_flat_type_id($flat_type_id){
	$s_society_id=$this->Session->read('society_id');
	$this->loadmodel('flat');
	$conditions=array("flat_type_id" => $flat_type_id,"society_id"=>$s_society_id);
	return $this->flat->find('all',array('conditions'=>$conditions));
}



///////////////////// End wing flat with bracket ////////////////////////////////// 

function fetch_subLedger_detail_via_flat_id($flat_id){
	$s_society_id=$this->Session->read('hm_society_id');
	$this->loadmodel('ledger_sub_account');
	$conditions=array("user_flat_id" => $flat_id,"society_id"=>$s_society_id);
	return $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
}

function fetch_wing_id_via_flat_id($flat_id){
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$flat_id = (int)$flat_id;
	$this->loadmodel('flat');
	$conditions=array("flat_id" =>$flat_id,"society_id" => $s_society_id);
	return $this->flat->find('all',array('conditions'=>$conditions));
}

function fetch_user_info_via_flat_id($wing,$flat){
	$s_society_id=$this->Session->read('hm_society_id');
	$this->loadmodel('user_flat');
	/*$conditions =array( '$or' => array( 
	array('wing' =>$wing,'flat' =>$flat),
	array('multiple_flat' => array('$in' => array(array((int)$wing,(int)$flat))))
	)); */
	
	$conditions=array('flat_id'=>$flat,'status'=>1,'active'=>0);
	$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions));
	$user_id=@$result_user_flat[0]['user_flat']['user_id'];
	return $this->profile_picture((int)$user_id);
	
}

function fetch_user_info_via_flat_id2($flat){
	$s_society_id=$this->Session->read('society_id');
	$this->loadmodel('user_flat');
	$conditions=array('flat_id'=>$flat,'active'=>0);
	$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions));
	$user_id=$result_user_flat[0]['user_flat']['user_id'];
	return $this->profile_picture((int)$user_id);
	
}


function wing_flat_new($wing_id,$flat_id)
{
$this->loadmodel('wing');
$conditions=array("wing_id"=>$wing_id);
$result=$this->wing->find('all',array('conditions'=>$conditions));
foreach($result as $data){
$wing_name=$data['wing']['wing_name'];
}
$this->loadmodel('flat');
$conditions=array("flat_id"=>$flat_id);
$result2=$this->flat->find('all',array('conditions'=>$conditions));
foreach($result2 as $data){
$flat_name=$data['flat']['flat_name'];
}
$flat_name=ltrim($flat_name,'0');
if(!empty($wing_name) && !empty($flat_name)){
return @$wing_name.' '.@$flat_name;
}
}


function csv_import()
{
$this->layout='session';
if ($this->request->is('post')) 
{

$file=$this->request->form['file']['name'];

$dir='C:\xampp\htdocs\cakephp\app\webroot\csv_file';

$target = "csv_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target);

$f = fopen('csv_file/'.$file, 'r') or die("ERROR OPENING DATA");
$batchcount=0;
$records=0;
while (($line = fgetcsv($f, 4096, ';')) !== false) {
// skip first record and empty ones
$numcols = count($line);

$test[]=$line;

//echo $col = $line[0];
//echo $batchcount++.". ".$col."\n";


++$records;
}

fclose($f);
$records;


for($i=1;$i<sizeof($test);$i++)
{
$r=explode(',',$test[$i][0]);

if(!empty($r[0])) {	$ok1=2; }
else { $ok1=1; $error_msg[]="UserName should not be empty";	}

if(!empty($r[1]))
{	
$ok2=2; 

if(eregi("^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,3})$", $r[1])) {
$ok3=2;
}
else {
$ok3=1; $error_msg[]="Email Id is not valid.";
}

}
else { $ok2=1; $error_msg[]="Email should not be empty";	}

if(!empty($r[2])) {	$ok4=2; }
else { $ok4=1; $error_msg[]="Password should not be empty";	}


if($ok1==2 && $ok2==2 && $ok3==2 && $ok4==2)
{

}	

}

$this->set('error_msg',@$error_msg);

$this->set('ok1',$ok1);
$this->set('ok2',$ok2);
$this->set('ok3',$ok3);
$this->set('ok4',$ok4);

if($ok1==2 && $ok2==2 && $ok3==2 && $ok4==2)
{
//$cmd='cmd.exe /c C:\\mongodb\bin\mongoimport -d test -c test  -type csv -f name,age  '.$dir.'/'.$file;
//$cmd='cmd.exe /c C:\\mongodb\bin\mongoimport -d test -c test  -type csv  '.$dir.'/'.$file.' --headerline';
//exec($cmd,$output,$err);

for($i=1;$i<sizeof($test);$i++)
{
$r=explode(',',$test[$i][0]);
$u=$this->autoincrement('user','user_id');
$this->loadmodel('user');
$this->user->saveAll(array('user_id' => $u, 'user_name' => $r[0],'email' => $r[1], 'password' => $r[2], 'mobile' => "",  'society_id' => 0, 'role_id' => array(2), 'committee' => 2 , 'tenant' => 1, 'wing' => 0, 'flat' => 0,'residing' => 1,'default_role_id'=>2,'profile_pic'=>"blank.jpg"));
}

$this->set('sucess','Csv Imported successfully.');
}

}
}


function VerifyMailAddress($address) 
{
$Syntax='#^[w.-]+@[w.-]+.[a-zA-Z]{2,5}$#';
if (!filter_var($address, FILTER_VALIDATE_EMAIL)) {
return 0;
}
else
{ return 1; }
}


function VerifyMobileNo($number) 
{
if (preg_match('/^\d{10}$/', $number)) {
return 1;
} else {
return 0;
}
}






function csv_import_signup()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
$this->check_user_privilages();
$s_society_id=$this->Session->read('society_id');
$soc_result=$this->society_name($s_society_id);
foreach($soc_result as $data)
{
	$society_name=$data['society']['society_name'];
	
}
if ($this->request->is('post')) 
{
@$ip=$this->hms_email_ip();
date_default_timezone_set('Asia/kolkata');
 $date=date("d-m-Y");
 $time=date('h:i:a',time());
$file=$this->request->form['file']['name'];
$extension = pathinfo($file, PATHINFO_EXTENSION);
if($extension!='csv') { echo '<script>alert("file extension should be csv." ); location="csv_import_signup"; </script>';	exit; }


$dir='C:\xampp\htdocs\cakephp\app\webroot\csv_file';

$target = "csv_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target);

$f = fopen('csv_file/'.$file, 'r') or die("ERROR OPENING DATA");
$batchcount=0;
$records=0;
while (($line = fgetcsv($f, 4096, ';')) !== false) {
// skip first record and empty ones
$numcols = count($line);

$test[]=$line;

//echo $col = $line[0];
//echo $batchcount++.". ".$col."\n";


++$records;
}

fclose($f);
$records;


for($i=1;$i<sizeof($test);$i++)
{
$row_no=$i+1;
$r=explode(',',$test[$i][0]);
$username=trim($r[0]);
$wing=trim($r[1]); 
$flat=trim($r[2]);
$email=trim($r[3]);
if($i==1) { $email_current=array(); }
$mobile=trim($r[4]);
$owner=trim($r[5]);
$committee=trim($r[6]);
$residing =trim($r[7]);
$imported_data=$test;

if(!empty($username)) {	$ok=2; }
else { $ok=1; $error_msg[]="UserName should not be empty in row ".$row_no.".";	break;}

$this->loadmodel('wing'); 
$conditions=array("society_id"=>$s_society_id,"wing_name"=> new MongoRegex('/^' .  $wing . '$/i'));
$result_wing=$this->wing->find('all',array('conditions'=>$conditions));
$result_wing_count=sizeof($result_wing);

if($result_wing_count>0) 
{	
$ok=2; 
$wing_id=$result_wing[0]['wing']['wing_id'];
$wing_id_d[]=$wing_id;
}
else { $ok=1; $error_msg[]="Wing name is not right in row ".$row_no."."; break;}

$this->loadmodel('flat'); 
$conditions=array("wing_id"=>$wing_id,"flat_name"=> new MongoRegex('/^' .  $flat . '$/i'));
$result_flat=$this->flat->find('all',array('conditions'=>$conditions));
$result_flat_count=sizeof($result_flat);

if($result_flat_count>0) 
{ 
$ok=2; 		
$flat_id=$result_flat[0]['flat']['flat_id'];	
$flat_id_d[]=$flat_id;
}
else { $ok=1; $error_msg[]="Flat name is not right in row ".$row_no.".";  break;}


if(!empty($email))
{
$email_varify=$this->VerifyMailAddress($email);
if($email_varify==1) 
{
$this->loadmodel('user'); 
$conditions=array("email"=>$email);
$result_email=$this->user->find('all',array('conditions'=>$conditions));
$result_email_count=sizeof($result_email);


if (in_array($email, $email_current))
{
$ok=1; $error_msg[]="Email Id can't be same in row ".$row_no.".";  break;
}
$email_current[]=$email;   
if($result_email_count==0) 
{ 
$ok=2; 	
}

else { $ok=1; $error_msg[]="Email Id is already exist in row ".$row_no.".";  break;}
}
else { $ok=1; $error_msg[]="Email Id format is not valid in row ".$row_no.".";  break;}
}
else { $ok=1; $error_msg[]="Email Id should not be empty in row ".$row_no.".";  break;}




if(!empty($mobile))
{
	
$ok=2; 
$mobile_varify=$this->VerifyMobileNo($mobile);
if($mobile_varify==1)
{
$this->loadmodel('user'); 
$conditions=array("mobile"=>$mobile);
$result_mobile=$this->user->find('all',array('conditions'=>$conditions));
$result_mobile_count=sizeof($result_mobile);	
if($result_mobile_count==0)
{	
	
$ok=2; 
}
else{ $ok=1; $error_msg[]="Mobile Number is already exist in row ".$row_no.".";  break; }

}
else { $ok=1; $error_msg[]="Mobile format is not valid in row ".$row_no.".";  break;}

}
else { $ok=1; $error_msg[]="Mobile should not be empty in row ".$row_no.".";  break;}



if(!empty($owner))
{
$result_owner_yes = strcasecmp($owner, 'yes');
$result_owner_no = strcasecmp($owner, 'no');
if ($result_owner_yes == 0 || $result_owner_no == 0) 
{

$ok=2;
} 
else { $ok=1; $error_msg[]="Owner should be yes or no in row ".$row_no.".";  break;}
}
else { $ok=1; $error_msg[]="Owner should not be empty in row ".$row_no.".";  break;}



if(!empty($committee))
{
$result_committee_yes = strcasecmp($committee, 'yes');
$result_committee_no = strcasecmp($committee, 'no');
if ($result_committee_yes == 0 || $result_committee_no == 0) 
{
$ok=2;
} 
else { $ok=1; $error_msg[]="Committee should be yes or no in row ".$row_no.".";  break;}
}
else { $ok=1; $error_msg[]="Committee should not be empty in row ".$row_no.".";  break;}


if(!empty($residing))
{
$result_residing_yes = strcasecmp($residing, 'yes');
$result_residing_no = strcasecmp($residing, 'no');
if ($result_residing_yes == 0 || $result_residing_no == 0) 
{

$ok=2;
} 
else { $ok=1; $error_msg[]="Residing should be yes or no in row ".$row_no.".";  break;}
}
else { $ok=1; $error_msg[]="Residing should not be empty in row ".$row_no.".";  break;}


}

$this->set('error_msg',@$error_msg);

$this->set('ok',$ok);


if($ok==2)
{

//$cmd='cmd.exe /c C:\\mongodb\bin\mongoimport -d test -c test  -type csv -f name,age  '.$dir.'/'.$file;
//$cmd='cmd.exe /c C:\\mongodb\bin\mongoimport -d test -c test  -type csv  '.$dir.'/'.$file.' --headerline';
//exec($cmd,$output,$err);
$this->set('imported_data',$imported_data);
for($i=1;$i<sizeof($test);$i++)
{
$r=explode(',',$test[$i][0]);

$ii=$i-1;
$username=$r[0];
$email=trim($r[3]);
$mobile=trim($r[4]);

$owner=trim($r[5]);
$result_owner_yes = strcasecmp($owner, 'yes');
$result_owner_no = strcasecmp($owner, 'no');
if ($result_owner_yes == 0) { $result_owner=1; }
if ($result_owner_no == 0) { $result_owner=2; }

$committee=trim($r[6]);
$result_committee_yes = strcasecmp($committee, 'yes');
$result_committee_no = strcasecmp($committee, 'no');
if ($result_committee_yes == 0) { $result_committee=1; }
if ($result_committee_no == 0) { $result_committee=2; }
if ($result_owner==2) { $result_committee=2; }

$residing =trim($r[7]);
$result_residing_yes = strcasecmp($residing, 'yes');
$result_residing_no = strcasecmp($residing, 'no');
if ($result_residing_yes == 0) { $result_residing=1; }
if ($result_residing_no == 0) { $result_residing=2; }	

$u=$this->autoincrement('user','user_id');
$log_i=$this->autoincrement('login','login_id');
$random1=mt_rand(1000000000,9999999999);
$random2=mt_rand(1000000000,9999999999);
$random=$random1.$random2 ;	
$de_user_id=$this->encode($u,'housingmatters');
$random=$de_user_id.'/'.$random;
$role_id[]=2;
if($result_committee==1)
{
 $role_id[]=1;
}
///////////////// insert user table /////////////////////////////

$this->loadmodel('user');
$this->user->saveAll(array('user_id' => $u, 'user_name' => $username,'email' => $email, 'password' => @$random, 'mobile' => $mobile,  'society_id' => $s_society_id, 'role_id' => $role_id,'tenant' => $result_owner, 'wing' => $wing_id_d[$ii], 'flat' => $flat_id_d[$ii],'residing' => $result_residing,'default_role_id'=>2,'profile_pic'=>"blank.jpg",'date' => $date, 'time' => $time,'sex'=>'','signup_random'=>$random,'deactive'=>0,'login_id'=>$log_i,'s_default'=>1));

///////////////////////// end //////////////////////////////////////

////////////////////  insert login table  ///////////////////

$this->loadmodel('login');
$this->login->saveAll(array('login_id'=>$log_i,'user_name'=>$email,'password'=>$random,'signup_random'=>$random,'mobile'=>$mobile));

////////////////////////////////////////////////////////////////// 


$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $username,</p>
<p>'We at $society_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.</p>
<p>As you are an owner/resident/staff of $society_name, we have added your email address in HousingMatters portal.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>
<p>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</p>
<p>You can receive important SMS & emails from your committee.</p>
<br/>				
<p><b>
<a href='$ip".$this->webroot."/hms/send_sms_for_verify_mobile?q=$random'>Click here</a> for one time verification of your mobile number and Login into HousingMatters  for making life simpler for all your housing matters!</b></p>
<br/>
<p>Pls add www.housingmatters.co.in in your favorite bookmarks for future use.</p>
<p>Regards,</p>	
<p>Administrator of $society_name</p><br/>
www.housingmatters.co.in
</div >
</div>";

$from_name="HousingMatters";
$reply="support@housingmatters.in";
$to=$email;
$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$subject="Welcome to ".$society_name." portal ";
$this->send_email($to,$from,$from_name,$subject,@$message_web,$reply);



///////////////  Insert code ledger Sub Accounts //////////////////////

 $this->loadmodel('ledger_sub_account');
 $j=$this->autoincrement('ledger_sub_account','auto_id');
 $this->ledger_sub_account->saveAll(array('auto_id'=>$j,'ledger_id'=>34,'name'=>$username,'society_id' => $s_society_id,'user_id'=>$u,'deactive'=>0));

/////////////  End code ledger sub accounts //////////////////////////




////////////////Notification email user all checked code  //////////////////////////
$this->loadmodel('email');	
$conditions=array('notification_id'=>1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach($result_email as $data)
{
  $auto_id = (int)$data['email']['auto_id'];
  $this->loadmodel('notification_email');
  $lo=$this->autoincrement('notification_email','notification_id');
  $this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id , "user_id" => $u,'chk_status'=>0));
}

//////////////// End all checked code   //////////////////////////

unset($role_id);
}

$this->set('sucess','Csv Imported successfully.');
}

}
}


//Start society_name//
function society_name($d_society_id){
$this->loadmodel('society');
$conditions=array("society_id"=>(int)$d_society_id);
return $this->society->find('all',array('conditions'=>$conditions));
} 
//End society_name//

function cron_email() {
/*
$this->layout='blank';

$this->loadmodel('email_request');
$conditions=array("flag"=>0);
$result_cron=$this->email_request->find('all',array('conditions'=>$conditions,'limit'=>3));
foreach($result_cron as $data4)
{
echo $to=$data4['email_request']['to'];
echo $from=$data4['email_request']['from'];
echo $from_name=$data4['email_request']['from_name'];
echo $subject=$data4['email_request']['subject'];
$message_web=$data4['email_request']['message_web'];
echo $reply=$data4['email_request']['reply'];

$this->smtpmailer($to, $from, $from_name, $subject, $message_web,$reply);
}
//$this->smtpmailer('abhilashlohar01@gmail.com', 'alerts@housingmatters.in', 'housingmatters', 'testing','hello','alerts@housingmatters.in');
*/
}


function notifications_count() 
{
$this->layout=null;
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');

$this->loadmodel('notification');
$conditions=array('users' =>array('$in' => array($s_user_id)),'seen_users' =>array('$nin' => array($s_user_id)));
$result_notifications_count=$this->notification->find('count',array('conditions'=>$conditions));
	if($result_notifications_count!=0)
	{
	echo $result_notifications_count; 
	}
}

function notifications() 
{
$this->layout="full_blank";

date_default_timezone_set('Asia/Kolkata');
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');

$this->loadmodel('notification');
$conditions=array('users' =>array('$in' => array($s_user_id)),'seen_users' =>array('$nin' => array($s_user_id)));
$order=array('notification.notification_id'=>'DESC');
$this->set('result_notifications',$this->notification->find('all',array('conditions'=>$conditions,'order'=>$order)));


}

function mark_all_as_read_notifications(){
	$this->layout="full_blank";

	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');

	$this->loadmodel('notification');
	$conditions=array('users' =>array('$in' => array($s_user_id)),'seen_users' =>array('$nin' => array($s_user_id)));
	$result_notifications=$this->notification->find('all',array('conditions'=>$conditions));
	
	foreach($result_notifications as $notification){
		$notification_id=$notification["notification"]["notification_id"];
		
		$seen_users=@$notification['notification']['seen_users'];
	
		if(is_array($seen_users)){
			
			if(sizeof($seen_users)==0)	{ $seen_users=array(); }

			if (!in_array($s_user_id, $seen_users)){
				
				if(sizeof($seen_users)==0)
				{
				$seen_users[]=$s_user_id;
				
				}
				else
				{
				$t=$s_user_id;
				array_push($seen_users,$t);
				}
				
				$this->notification->updateAll(array('seen_users'=>$seen_users),array('notification.notification_id'=>$notification_id));
			}
		}
	}
}

function see_all_notifications(){
		if($this->RequestHandler->isAjax()){
		$this->layout='blank';
		}else{
		$this->layout='session';
		}
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');

	$this->loadmodel('notification');
	$conditions=array('users' =>array('$in' => array($s_user_id)),'seen_users' =>array('$nin' => array($s_user_id)));
	$order=array('notification.notification_id'=>'DESC');
	$result_notifications=$this->notification->find('all',array('conditions'=>$conditions,'order'=>$order));
	$this->set('result_notifications',$result_notifications);
	
}

function send_notification($icon,$text,$url,$by_user,$users) 
{
$s_society_id=$this->Session->read('hm_society_id');

date_default_timezone_set('Asia/Kolkata');
$now=date('Y-m-d');
$seen=array();
$notification_id=$this->autoincrement('notification','notification_id');
$this->loadmodel('notification');
$this->notification->saveAll(array('notification_id' => $notification_id,'icon' => $icon,'text' => $text, 'url' =>$url, 'by_user' =>$by_user, 'users' =>$users, 'society_id' =>$s_society_id, 'date' =>strtotime($now),'seen_users'=>$seen));
}


function seen_notification($notification_id) 
{
	$notification_id=(int)$notification_id;
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');

	$this->loadmodel('notification');
	$conditions=array("notification_id" => $notification_id);
	$notification_result=$this->notification->find('all', array('conditions' => $conditions));
	
	
	foreach($notification_result as $notification_result_data)
	{
		 $seen_users=@$notification_result_data['notification']['seen_users'];
	
	if(is_array($seen_users))	{  
	if(sizeof($seen_users)==0)	{ $seen_users=array(); }
	
	if (!in_array($s_user_id, $seen_users))
	{
	  
		if(sizeof($seen_users)==0)
		{
		$seen_users[]=$s_user_id;
		
		}
		else
		{
		$t=$s_user_id;
		array_push($seen_users,$t);
		}
		
		
		$this->notification->updateAll(array('seen_users'=>$seen_users),array('notification.notification_id'=>$notification_id));
	}
	
	}
	}
	
	
}



function seen_alert($module_id,$element_id) 
{
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

	$this->loadmodel('alert');
	$conditions=array("module_id" => $module_id,"element_id" => $element_id);
	$alert_result=$this->alert->find('all', array('conditions' => $conditions));
	
	foreach($alert_result as $alert_result_data)
	{
		$seen_users=@$alert_result_data['alert']['seen_users'];
		
	if(sizeof($seen_users)==0)	{ $seen_users=array(); }
	
	if (!in_array($s_user_id, $seen_users))
	{
	
		if(sizeof($seen_users)==0)
		{
		$seen_users[]=$s_user_id;
		
		}
		else
		{
		$t=$s_user_id;
		array_push($seen_users,$t);
		}
		
		
		$this->alert->updateAll(array('seen_users'=>$seen_users),array('alert.module_id'=>$module_id,'alert.element_id'=>$element_id));
	}
	
	}
	
	
}

function recent_activities($icon,$by_user,$text,$url,$users,$module_id) 
{


$s_society_id=$this->Session->read('society_id');

$now=date('Y-m-d');

$activity_id=$this->autoincrement('activity','activity_id');
$this->loadmodel('activity');
$this->activity->saveAll(array('activity_id' => $activity_id,'icon' => $icon,'by_user' =>$by_user,'text' => $text, 'url' =>$url,'users' =>$users,'module_id' =>$module_id ,'society_id' =>$s_society_id, 'date' =>$now));
}

function alerts_count() 
{
$this->layout=null;
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('alert');
$conditions=array('users' =>array('$in' => array($s_user_id)),'seen_users' =>array('$nin' => array($s_user_id)));
$order=array('alert.alert_id'=>'DESC');
$this->set('result_alerts_count',$this->alert->find('count',array('conditions'=>$conditions,'order'=>$order)));
}

function alerts()
{
$this->layout=null;
 $s_society_id=$this->Session->read('society_id');
  $s_user_id=$this->Session->read('user_id');

date_default_timezone_set('Asia/Kolkata');	
$now=date('d-m-Y');
$now_for_search=date('Y-m-d', strtotime('-1 day', strtotime(date('Y-m-d'))));


$current_date_for_search = new MongoDate(strtotime($now_for_search)); 

////////////////notice//////////////////////////////////////
$this->loadmodel('notice');
$conditions=array("n_draft_id" => 0, "n_delete_id" => 0,"society_id"=> $s_society_id,'n_expire_date' => array('$gte'=>$current_date_for_search));
$notice_result=$this->notice->find('all',array('conditions'=>$conditions));

foreach($notice_result as $data1)
{
$notice_id=$data1['notice']['notice_id'];
$n_subject=$data1['notice']['n_subject'];

$visible_user_id=$data1['notice']['visible_user_id'];



$n_expire_date=$data1['notice']['n_expire_date'];
$n_expire_date= date('d-m-Y',$n_expire_date->sec);

$datediff = strtotime($n_expire_date) - strtotime($now);

$remening_days=floor($datediff/(60*60*24));

	if($remening_days<=15)
	{
	
	$this->loadmodel('alert');
	$conditions=array("module_id" => 2, "element_id" => $notice_id);
	$alert_result_count=$this->alert->find('count',array('conditions'=>$conditions));
	
		if($alert_result_count==0)
		{
		$this->send_alert('<span class="label label-info" ><i class="icon-bullhorn"></i></span>','Notice - <b>'.$n_subject.'</b> will expire on <b>'.$n_expire_date.'</b>',2,$notice_id,$this->webroot.'Notices/notice_publish_view/'.$notice_id,$visible_user_id);
		}
	
	}
}

////////////////notice//////////////////////////////////////


////////////////Events//////////////////////////////////////
$this->loadmodel('event');
$conditions=array("society_id"=> $s_society_id);
$result_event=$this->event->find('all',array('conditions'=>$conditions));

foreach($result_event as $data1)
{
$event_id=$data1['event']['event_id'];
$e_name=$data1['event']['e_name'];

$visible_user_id=$data1['event']['visible_user_id'];


$date_to=$data1['event']['date_to'];
$date_to= date('d-m-Y',$date_to->sec);

$datediff = strtotime($date_to) - strtotime($now);

$remening_days=floor($datediff/(60*60*24));

	if($remening_days<=3 and $remening_days>=0)
	{
	$this->loadmodel('alert');
	$conditions=array("module_id" => 6, "element_id" => $event_id);
	$alert_result_count=$this->alert->find('count',array('conditions'=>$conditions));
	
		if($alert_result_count==0)
		{
		$this->send_alert('<span class="label" style="background-color:#44b6ae;" ><i class="icon-gift"></i></span>','Event - <b>'.$e_name.'</b> will expire on <b>'.$date_to.'</b>',6,$event_id,$this->webroot.'Events/event_info/'.$event_id,$visible_user_id);
		}
	
	}
	if($remening_days<0)
	{
	$this->loadmodel('alert');
	$conditions=array("module_id" => 6, "element_id" => $event_id);
	$alert_result_count=$this->alert->find('count',array('conditions'=>$conditions));
	
		if($alert_result_count==0)
		{
		$this->send_alert('<span class="label" style="background-color:#44b6ae;" ><i class="icon-gift"></i></span>','Event - <b>'.$e_name.'</b> have been expired on <b>'.$date_to.'</b>',6,$event_id,$this->webroot.'Events/event_info/'.$event_id,$visible_user_id);
		}
	
	}

}

////////////////Events//////////////////////////////////////

////////////////Polls//////////////////////////////////////
$this->loadmodel('poll');
$conditions=array("society_id"=> $s_society_id);
$result_poll=$this->poll->find('all',array('conditions'=>$conditions));
foreach($result_poll as $data1)
{
  $poll_id=$data1['poll']['poll_id'];
  $question=$data1['poll']['question'];

@$visible_user_id=$data1['poll']['visible_user_id'];


$close_date=$data1['poll']['close_date'];
$close_date= date('d-m-Y',$close_date->sec);

$datediff = strtotime($close_date) - strtotime($now);

$remening_days=floor($datediff/(60*60*24));

	if(($remening_days<=3 or $remening_days<=7) and ($remening_days>=0))
	{
	$this->loadmodel('alert');
	$conditions=array("module_id" => 7, "element_id" => $poll_id);
	$alert_result_count=$this->alert->find('count',array('conditions'=>$conditions));
	
		if($alert_result_count==0)
		{
		$this->send_alert('<span class="label" style="background-color:#6d1b81;" ><i class="icon-question-sign"></i></span>','Voting for Poll - <b>'.$question.'</b> will close on <b>'.$close_date.'</b>',7,$poll_id,$this->webroot.'Polls/polls',$visible_user_id);
		}
	
	}
	if($remening_days<0)
	{
	$this->loadmodel('alert');
	$conditions=array("module_id" => 7, "element_id" => $poll_id);
	$alert_result_count=$this->alert->find('count',array('conditions'=>$conditions));
	
		if($alert_result_count==0)
		{
		$this->send_alert('<span class="label" style="background-color:#6d1b81;" ><i class="icon-question-sign"></i></span>','Voting for Poll - <b>'.$question.'</b> have been closed on <b>'.$close_date.'</b>',7,$poll_id,$this->webroot.'Polls/closed_polls',$visible_user_id);
		}
	
	}

}

////////////////Polls//////////////////////////////////////

////////////////profile incompleteness//////////////////////////////////////
$this->loadmodel('user');
$conditions=array("user_id"=> $s_user_id);
$result_user=$this->user->find('all',array('conditions'=>$conditions));
foreach ($result_user as $collection)   
{
$c_email = $collection['user']['email'];
$c_mobile = $collection['user']['mobile'];
$c_name = $collection['user']['user_name'];
@$profile_pic = $collection['user']['profile_pic'];
$c_sex = (int)@$collection['user']['sex'];
$c_wing_id = (int)$collection['user']['wing'];
 $c_flat_id = (int)$collection['user']['flat'];
$da_dob=@$collection['user']['dob'];
$per_address=@$collection['user']['per_address'];
$com_address=@$collection['user']['comm_address'];
$hobbies=@$collection['user']['hobbies'];
$private_field=@$collection['user']['private'];

}

$flat = $this->wing_flat($c_wing_id,$c_flat_id);

$ccc=0;
	if(!empty($c_email))
	{
		$ccc++;
	}
	if(!empty($c_mobile))
	{
		$ccc++;
	}
	if(!empty($c_name))
	{
		$ccc++;
	}
	if(!empty($profile_pic))
	{
		$ccc++;
	}
	if(!empty($c_sex))
	{
		$ccc++;
	}
	if(!empty($c_wing_id))
	{
		$ccc++;
	}
	if(!empty($c_flat_id))
	{
		$ccc++;
	}
	if(!empty($da_dob))
	{
		$ccc++;
	}
	if(!empty($per_address))
	{
		$ccc++;
	}
	if(!empty($com_address))
	{
		$ccc++;
	}
	if(!empty($hobbies))
	{
		$ccc++;
	}
$progres=$ccc*100/11;
$progres=round($progres);
$incomplete=100-$progres;

	if($incomplete!=100)
	{
	$this->loadmodel('alert');
	$conditions=array("module_id" => 101, "element_id" => $s_user_id);
	$alert_result_count=$this->alert->find('count',array('conditions'=>$conditions));

		if($alert_result_count==0)
		{
		$this->send_alert('<span class="label label-success"><i class="icon-user"></i></span>','Your Profile is <b>'.$incomplete.'%</b> incomplete',101,$s_user_id,$this->webroot.Hms.'/profile',array($s_user_id));
		}

	}

////////////////profile incompleteness//////////////////////////////////////


$this->loadmodel('alert');
$conditions=array('users' =>array('$in' => array($s_user_id)),'seen_users' =>array('$nin' => array($s_user_id)));
$order=array('alert.alert_id'=>'DESC');
$this->set('result_alerts',$this->alert->find('all',array('conditions'=>$conditions,'order'=>$order)));
}

function send_alert($icon,$text,$module_id,$element_id,$url,$users)
{
$this->layout='blank';

$s_society_id=$this->Session->read('society_id');

$now=date('Y-m-d');

$alert_id=$this->autoincrement('alert','alert_id');
$this->loadmodel('alert');
$this->alert->saveAll(array('alert_id' => $alert_id,'icon' => $icon,'module_id' => $module_id,'element_id' => $element_id,'text' => $text, 'url' =>$url, 'users' =>$users, 'society_id' =>$s_society_id, 'date' =>$now));
}

function set_default_hm_child_society(){

$this->layout='without_session';	
$s_user_id=(int)$this->Session->read('hm_user_id');	

	$result_hms_right=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_society_hm_child_user_id'), array('pass' => array($s_user_id)));
	
		if(sizeof($result_hms_right)>1){
			
			$this->set(compact('result_hms_right'));
			
		}else{
			
			$society_id=(int)$result_hms_right[0]['hms_right']['society_id'];
			$this->Session->write('hm_society_id', $society_id);
			$this->redirect(array('action' => 'dashboard'));
		}

		

		if($this->request->is('post')){
			
				$society_id=(int)$this->request->data["society"];
				$this->Session->write('hm_society_id', $society_id);
				$this->redirect(array('action' => 'dashboard'));
		}
}

function index()
{
//$this->Session->destroy();	
$ua=$this->Cookie->read('username');
$pa=$this->Cookie->read('password');
$this->set('bgColor',$ua);
$this->set('txtColor',$pa);
$this->layout='without_session';
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);

		

		$fb_user_name=@$this->request->query['aqazp2yd'];
		$uid=@$this->request->query['uid'];
		
		$source=@$this->request->query['source'];
		if(!empty($fb_user_name)){
			$fb_user_name=$this->decode($fb_user_name,'Housingmatters_facebook');
			
			$this->loadmodel('user');
			$conditions=array("email" => $fb_user_name);
			$result_user=$this->user->find('all',array('conditions'=>$conditions));
			$count=sizeof($result_user); 
			if($count>0){
				foreach($result_user as $data){
					$user_id=(int)$data['user']['user_id'];
					$society_id=$data['user']['society_id'];
					$user_type=$data['user']['user_type'];
					
				}
				
				if(!empty($uid) && $source=="f"){
					$this->loadmodel('user');
					$this->user->updateAll(array("f_profile_pic" => "https://graph.facebook.com/".$uid."/picture"),array("user_id" => (int)$user_id));
				}
				if(!empty($uid) && $source=="g"){
					$this->loadmodel('user');
					$this->user->updateAll(array("g_profile_pic" => $uid),array("user_id" => (int)$user_id));
				}
				 
					date_default_timezone_set('Asia/kolkata');
					$date=date("d-m-Y");
					$time=date('h:i:a',time());
					$this->loadmodel('log');
					$i=$this->autoincrement('log','log_id');
					$this->log->save(array('log_id'=>$i,'user_id'=>$user_id,'society_id'=>$society_id,'date'=>$date,'time'=>$time,'status'=>0));
					
					if($user_type=="third_party" or $user_type=="member" or $user_type=="family_member"){

						/*$role_id=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_role_via_user_id'), array('pass' => array($user_id)));
						$this->Session->write('role_id', $role_id);
						*/
						
						$role_id=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_role_via_user_id_and_society_id'), array('pass' => array($user_id,$society_id))); 
					   $this->Session->write('role_id', $role_id);
					}
					
					$user_flat_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'), array('pass' => array($user_id)));
					$user_flat_id=$user_flat_info[0]["user_flat"]["user_flat_id"]; 

					$this->Session->write('hm_user_id', $user_id);
					$this->Session->write('hm_user_flat_id', $user_flat_id);
					$this->Session->write('hm_society_id', $society_id);
					$this->redirect(array('action' => 'dashboard'));
			}else{
			 if($source=="f"){
				 $this->set('wrong_fb', 'It seems you have not sign up with HousingMatters or your Facebook email is not matching with our system.'); 
			 }
			elseif($source=="g"){
				 $this->set('wrong_fb', 'It seems you have not sign up with HousingMatters or your Google email is not matching with our system.'); 
			 }
		 }
		}
		
	
if($this->request->is('post'))
{
	
	  $username=htmlentities($this->request->data["username"]);
	  $password=htmlentities($this->request->data["password"]); 
	 $rememberme=htmlentities(@$this->request->data["rememberme"]);
	 
	$this->loadmodel('user');
		$conditions =array( '$or' => array( 
		array("email" => $username, "password" => $password),
		array("mobile" => $username, "password" => $password),
	));
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	$user_id=(int)$result_user[0]["user"]["user_id"];
	$society_id=(int)@$result_user[0]["user"]["society_id"];
	$user_type=@$result_user[0]["user"]["user_type"];
	echo $signup_random=@$result_user[0]["user"]["signup_random"];
	exit;
	$user_flat_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'), array('pass' => array($user_id)));
	$user_flat_id=$user_flat_info[0]["user_flat"]["user_flat_id"]; 
	
	$this->Session->write('hm_user_id', $user_id);
	$this->Session->write('hm_user_flat_id', $user_flat_id);
	
		if($user_type=="hm_child"){
			 $this->redirect(array('action' => 'set_default_hm_child_society'));
		}
      
	
	
	
	$this->Session->write('hm_society_id', $society_id);
	if($signup_random==$password){
						$de_user_id=$this->encode($user_id,'housingmatters');
						$random=$de_user_id.'/'.$password;
						$this->response->header('Location', $this->webroot.'hms/set_new_password?q='.$random.' ');
		
	}else{
	
		$this->redirect(array('action' => 'dashboard'));
	}
}
	
}

function submit_login(){
	
	$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path'));
	$username=htmlentities($this->request->data["username"]);
	 $password=htmlentities($this->request->data["password"]);
	 $rememberme=htmlentities(@$this->request->data["rememberme"]);
	 
	 $next=@$this->request->query['next'];
	 
	$this->loadmodel('user');
		$conditions =array( '$or' => array( 
		array("email" => new MongoRegex('/^' .  $username . '$/i'), "password" => $password,"active"=>'yes'),
		array("mobile" => $username, "password" => $password,"active"=>'yes'),
		array("mobile" => $username, "password" => (int)$password,"active"=>'yes')
	));
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	if(sizeof($result_user)==1){
		$user_id=(int)$result_user[0]["user"]["user_id"];
		$society_id=@$result_user[0]["user"]["society_id"];
		$user_type=@$result_user[0]["user"]["user_type"];
		$signup_random=@$result_user[0]["user"]["signup_random"];
		if(is_array($society_id)){
				$society_id = reset($society_id); 
			}
		if($user_type=="hm"){

			$society_id=(int)$society_id;
		}		

		
		$verify_set_new_password=(int)@$result_user[0]["user"]["verify_set_new_password"]; 
		
		
			if($verify_set_new_password==0){
				
					$de_user_id=$this->encode($user_id,'housingmatters');
					$random=$de_user_id.'/'.$password;

					echo $output=json_encode(array('url' => $webroot_path.'hms/set_new_password?q='.$random.'','action' => 'redirect','result' => 'success'));
					exit;
			}
		
		if($rememberme==1){
				$this->Cookie->write('username',$username,3600);
				$this->Cookie->write('password',$password,3600);
			}
			else{
				$this->Cookie->delete('username');
				$this->Cookie->delete('password');
			}
		
		$user_flat_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id_and_society_id'), array('pass' => array($user_id,$society_id)));
		
		$user_flat_id=@$user_flat_info[0]["user_flat"]["user_flat_id"]; 
		$owner=@$user_flat_info[0]["user_flat"]["owner"];
				
		if($owner=="yes"){ $type="Owner"; }elseif($owner=="no"){ $type="Tenant"; }
		
			date_default_timezone_set('Asia/kolkata');
			 $date2=date("d-m-Y");

				$result_society= $this->society_name($society_id);
				
				 $access_tenant=@$result_society[0]['society']['access_tenant']; 
				 $society_user_id=@$result_society[0]['society']['user_id'];
				if(empty($access_tenant) and !empty($type)){
					
					if($access_tenant==0 && $type=="Tenant"){
						echo $output=json_encode(array('result' => 'error','message' => 'Tenant have not login access.'));
						die();
					}
				}
				
				
				if($owner=="no"){
						$result_tenant=$this->requestAction(array('controller' => 'Fns', 'action' => 'tenancy_agreement_via_user_fetch'), array('pass' => array($society_id,$user_id)));
						
					if(!empty($result_tenant)){
							$t_end_date=$result_tenant[0]['tenant']['t_end_date'];
						if(strtotime($t_end_date)<strtotime($date2)){
								echo $output=json_encode(array('result' => 'error','message' => 'Your tenancy agreement is finished so you are not allowed login access.'));
							    die();
						}
					}
				}
				
				if($user_type=="third_party" or $user_type=="member" or $user_type=="family_member"){
					
					$role_id=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_role_via_user_id_and_society_id'), array('pass' => array($user_id,$society_id))); 
					$this->Session->write('role_id', $role_id);
				
				if(empty($role_id) || $role_id==""){
					echo $output=json_encode(array('result' => 'error','message' => 'Please asign role'));
					die();
				
				}
				
				
				}
				
				date_default_timezone_set('Asia/kolkata');
				$date=date("d-m-Y");
				$time=date('h:i:a',time());
				$this->loadmodel('log');
				$i=$this->autoincrement('log','log_id');
				$this->log->save(array('log_id'=>$i,'user_id'=>$user_id,'society_id'=>$society_id,'date'=>$date,'time'=>$time,'status'=>0));
				
				$this->Session->write('hm_user_id', $user_id);
				$this->Session->write('hm_user_flat_id', $user_flat_id);
				$this->Session->write('hm_society_id', $society_id);
				
				if($user_type=="hm_child"){
					
					$this->loadmodel('hms_right');
					$conditions =array('user_id' =>(int)$user_id);
					$hms_rights=$this->hms_right->find('all',array('conditions'=>$conditions));
					$society_id=$hms_rights[0]["hms_right"]["society_id"];
					$this->Session->write('hm_society_id', $society_id);
					echo $output=json_encode(array('url' => $webroot_path.'hms/set_default_hm_child_society','action' => 'redirect','result' => 'success'));
					die();
						//$this->redirect(array('action' => 'set_default_hm_child_society'));
				}
	
				
				if($signup_random==$password){
					
						$de_user_id=$this->encode($user_id,'housingmatters');
						$random=$de_user_id.'/'.$password;

						echo $output=json_encode(array('url' => $webroot_path.'hms/set_new_password?q='.$random.'','action' => 'redirect','result' => 'success'));
				}else{
						if(empty($next)){
							echo $output=json_encode(array('url' => $webroot_path.'hms/dashboard','action' => 'redirect','result' => 'success'));
							
						}else{
							
							echo $output=json_encode(array('url' => $next,'action' => 'redirect','result' => 'success'));
						}
						
				}
	
	
	
	}else{
		echo $output=json_encode(array('result' => 'error','message' => 'Username and password is wrong.'));
	}
	
}

function login_user_id($login_id)
{
	$this->loadmodel('user');
	$conditions=array('login_id'=>$login_id);
	return $this->user->find('all',array('conditions'=>$conditions));
	
}


function index23() 
{	
$ua=$this->Cookie->read('username');
$pa=$this->Cookie->read('password');
$this->set('bgColor',$ua);
$this->set('txtColor',$pa);
$this->layout='without_session';
if ($this->request->is('post')) 
{
 $username=htmlentities($this->request->data["username"]);
 $password=htmlentities($this->request->data["password"]);
$rememberme=htmlentities(@$this->request->data["rememberme"]);
$this->loadmodel('user');
$conditions =array( '$or' => array( 
array("email" => $username, "password" => $password,'deactive'=>0),
array("mobile" => $username, "password" => $password,'deactive'=>0),
));
$result = $this->user->find('all',array('conditions'=>$conditions));
$n = sizeof($result);

if($n>0)
{
if($rememberme==1)
{
$this->Cookie->write('username',$username,3600);
$this->Cookie->write('password',$password,3600);
}
else
{
$this->Cookie->delete('username');
$this->Cookie->delete('password');
}
foreach($result as $data)
{
	
$user_id=$data['user']['user_id'];
$society_id=$data['user']['society_id'];
$user_name=$data['user']['user_name'];
$wing=$data['user']['wing'];
$tenant=$data['user']['tenant'];
$role_id=$data['user']['default_role_id'];
$profile=@$data['user']['profile_status'];
}

$this->loadmodel('user');
$conditions5=array('signup_random'=>$password);
$res_n=$this->user->find('all',array('conditions'=>$conditions5));
$result_no=sizeof($res_n);
if($result_no>0)
{
	$de_user_id=$this->encode($user_id,'housingmatters');
	$random=$de_user_id.'/'.$password;
	$this->response->header('Location', $this->webroot.'hms/set_new_password?q='.$random.' ');
}
else
{
$this->loadmodel('user');
if($profile==2)
{
$conditions =array( '$or' => array( 
array("email" => $username, "password" => $password,"profile_status" =>2),
array("mobile" => $username, "password" => $password,"profile_status" =>2),
));
}
else
{
$conditions =array( '$or' => array( 
array("email" => $username, "password" => $password,"profile_status" =>1),
array("mobile" => $username, "password" => $password,"profile_status" =>1),
));	
}
$result = $this->user->find('all',array('conditions'=>$conditions));
$pro = sizeof($result);
if($pro==0)
{
$this->loadmodel('user');
$this->user->updateAll(array('profile_status'=>1),array('user_id'=>$user_id));
}
else
{
$this->loadmodel('user');
$this->user->updateAll(array('profile_status'=>2),array('user_id'=>$user_id));
}

date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$this->loadmodel('log');
$i=$this->autoincrement('log','log_id');
$this->log->save(array('log_id'=>$i,'user_id'=>$user_id,'society_id'=>$society_id,'date'=>$date,'time'=>$time,'status'=>0));
$this->Session->write('user_id', $user_id);
$this->Session->write('role_id', $role_id);

$this->Session->write('society_id', $society_id);
$this->Session->write('user_name', $user_name);
$this->Session->write('wing', $wing);
$this->Session->write('tenant', $tenant);
$this->redirect(array('action' => 'dashboard'));
}
}
else
{
$this->loadmodel('user');
$conditions =array( '$or' => array( 
array("email" => $username, 'deactive'=>0),
array("mobile" => $username, 'deactive'=>0),
));
$result1 = $this->user->find('all',array('conditions'=>$conditions));
$n1 = sizeof($result1);
if($n1>0)
{ 
$this->set('wrong', 'Password is Incorrect');
}
else
{
$this->loadmodel('user');
$conditions=array("password" => $password,'deactive'=>0);
$result2 = $this->user->find('all',array('conditions'=>$conditions));
$n2 = sizeof($result2);
if($n2>0)
{ 
$this->set('wrong', 'Username is Incorrect');
}
else
{
$this->set('wrong', 'Username and Password are Incorrect');
}
}
}
}
}

function sign_up()
{
$this->layout='without_session';
App::import('', 'sendsms.php');
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);
if ($this->request->is('POST')) 
{

date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$name=htmlentities($this->request->data['name']);
$email=htmlentities($this->request->data['email']);
$mobile=htmlentities($this->request->data['mobile']);
$i=$this->autoincrement('user_temp','user_temp_id');
$this->loadmodel('user_temp');
$this->user_temp->save(array('user_temp_id' => $i, 'user_name' => $name,'email' => $email, 'mobile' => $mobile,'complete_signup' => 0 , 'reply_mail' => "", 'date' => $date, 'time' => $time,'reject' =>0 ));
$this->response->header('Location', 'sign_up_next?user='.$i.' ');


}
}




function sign_up_next()
{
$this->layout='without_session';
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);	
$user=$this->request->query['user'];
$this->set('user', $user);
}

//Start Resident Signup//

function resident_signup()
{
$this->layout='without_session';
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);
$user=(int)$this->request->query['user'];
$this->set('user_id', $user);
$this->loadmodel('society');
$this->set('result', $this->society->find('all'));
if($this->request->is('post')){ 
		
			$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip')); 
			
		$society_id=(int)$this->request->data['society_id']; 
		$tenant=$this->request->data['tenant'];
		if($tenant=="yes"){
			$committe=$this->request->data['committe'];
		}else{
			$committe="no";
		}
	$wing=(int)$this->request->data['wing'];
	$flat=(int)$this->request->data['flat'];
	
///// flat alerdy exits
	
	$this->loadmodel('flat');
	$conditions=array("flat_id" =>$flat);
	$result_flat = $this->flat->find('all',array('conditions'=>$conditions));
	foreach($result_flat as $data_flat){
	  $flat_type = (int)$data_flat['flat']['noc_ch_tp'];	
	}
	if($flat_type == 1)
		{
			if($tenant == 'no')
			{
			 	
			   $this->set('tenant_allow','Flat is self Occupied');
				goto a;
			}
			
		}
		

$this->loadmodel('user_flat');
$conditions2=array('flat'=>$flat,'society_id'=>$society_id,'exited'=>'no');
 $result_user=$this->user_flat->find('all',array('conditions'=>$conditions2));
  $n5=sizeof($result_user); 
if($n5==1){
	 $tenant_database=$result_user[0]['user_flat']['owner'];
	if($tenant_database=='yes'){
		if($tenant_database==$tenant){
			
			$this->set('tenant_allow','Flat is Already Exist owner.');
			goto a;
			
		}
		
		
	}else{
		
		if($tenant_database==$tenant){
			
			$this->set('tenant_allow','Flat is Already Exist tenant.');
			goto a;
			
		}
		
		
		
	}
	
}
if($n5==2){
	$this->set('tenant_allow','Flat is Already Exist.');
	goto a;
	
}
	
////end validation	
	
$this->loadmodel('user_temp');
$this->user_temp->updateAll(array("society_id" => $society_id,"committee" => $committe, 
'owner' => $tenant, 'wing' => $wing, 'flat' => $flat,"role"=>2,"complete_signup"=>1,'user_type'=>"member"),array("user_temp.user_temp_id" => $user));


$this->loadmodel('user_temp');
$conditions=array("user_temp_id" => $user);
$result_user=$this->user_temp->find('all',array('conditions'=>$conditions));

foreach($result_user as $data1)
{
$user_name_post=$data1['user_temp']['user_name'];
}
$wing_flat=$this->wing_flat($wing,$flat);

$this->loadmodel('user');
$conditions=array("society_id" => $society_id,'role_id' =>array('$in' => array(3)));
$result_user_admin=$this->user->find('all',array('conditions'=>$conditions));
foreach($result_user_admin as $data2)
{
$admin_user_id[]=$data2['user']['user_id'];
}

////////////////////////////////// mail functionality //////////////////////////////////////////////////////////////////////
$this->loadmodel('society');
$conditions=array("society_id" => $society_id);
$result_society = $this->society->find('all',array('conditions'=>$conditions));
foreach ($result_society as $collection) 
{
$user_id=$collection['society']['user_id'];
$society_name3=$collection['society']['society_name'];
}
$this->loadmodel('user');
$conditions=array("user_id" => $user_id);
$result_user = $this->user->find('all',array('conditions'=>$conditions));
foreach ($result_user as $collection) 
{
$email=$collection['user']['email'];
$mobile=$collection['user']['mobile'];
}
$this->loadmodel('user_temp');
$conditions=array("user_temp_id" => $user);
$result_user_temp = $this->user_temp->find('all',array('conditions'=>$conditions));
foreach ($result_user_temp as $collection) 
{
$mobile1=$collection['user_temp']['mobile'];
$user_name1=$collection['user_temp']['user_name'];
}
$this->loadmodel('wing');
$conditions=array("wing_id" => $wing);
$result_wing = $this->wing->find('all',array('conditions'=>$conditions));
foreach ($result_wing as $collection) 
{
$wing_name=$collection['wing']['wing_name'];
}
$this->loadmodel('wing');
$conditions=array("wing_id" => $wing);
$result_wing = $this->wing->find('all',array('conditions'=>$conditions));
foreach ($result_wing as $collection) 
{
$wing_name=$collection['wing']['wing_name'];
}
$this->loadmodel('flat');
$conditions=array("flat_id" => $flat);
$result_flat = $this->flat->find('all',array('conditions'=>$conditions));
foreach ($result_flat as $collection) 
{
$flat_name=$collection['flat']['flat_name'];
}
$flat_name = ltrim($flat_name,0);
$wing_flat = $wing_name.'-'.$flat_name;

$r_sms=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_sms_ip')); 
$working_key=$r_sms->working_key;
$sms_sender=$r_sms->sms_sender; 
$sms_allow=(int)$r_sms->sms_allow;


$z=1;
if($z==1)
{

if($sms_allow==1){
	
$user_name_short=$this->check_charecter_name($user_name1);
	
$sms='Hello!+New+User+request+:+'.$user_name_short.'+'.$wing_flat.'+'.$tenant.'+Please+log+into+HousingMatters+for+further+action.';
$sms1=str_replace(' ', '+', $sms);
$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
}

$to=$email;

 

 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear Administrator, </span> <br>
										</td>
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)">One new user request in your society has been received for your approval. </span>
									</td>
																
								</tr>
								
								
								<tr>
									<td>
									
										<table  cellpadding="5" cellspacing="0" width="100%;"border="1" style="border:1px solid #e5e5e5;">
						
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" width="200" >Flat</td>
										<td align="left" style="background-color:#f8f8f8;" width="600" >'.$wing_flat.'</td>
										</tr>
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Name</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$user_name1.'</td>
										</tr>
										
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Mobile</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$mobile1.'</td>
										</tr>
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Owner</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$tenant.'</td>
										</tr>
									
										</table> 
									
									</td>
								
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> <p>Kindly log into <a href="http://www.housingmatters.co.in"> HousingMatters portal </a> and review </p>
											<p>the request under " Admin -> Resident Approve " for further action at your end.</p>
											<p>For any assistance, please email us on support@housingmatters.in</p>
											</span>
									</td>
																
								</tr>
					
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
								</tr>
					</table>
				</td>
			</tr>
        </tbody>
</table>';



$from_name="HousingMatters";
$reply="support@housingmatters.in";
$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$subject="[$society_name3]-New User Request for approval";
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$z++;			
}


if($z==2)
{

$this->loadmodel('user_temp');
$conditions=array("user_temp_id" => $user);
$result_user_temp = $this->user_temp->find('all',array('conditions'=>$conditions));
foreach ($result_user_temp as $collection) 
{
$email1=$collection['user_temp']['email'];
$user_name=$collection['user_temp']['user_name'];
$mobile1=$collection['user_temp']['mobile'];
}

$dd=explode(' ',$user_name);
$user_name1=$dd[0];
$user_name1=ucfirst($user_name1);
$to=$email1;
  
 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify">Hi '.$user_name1.', </span> <br>
										</td>
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> <p align="justify">Thank for Signing up with Housing Matters. Your Application is under review. We will get back to you with further details within 24 Hrs.</p> </span>
									</td>
																
								</tr>
								
								

								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> <p align="justify">To know more about Housing Matters, <a href="http://www.housingmatters.co.in">Click here</a></p>
											<p>For any assistance, Email us on support@housingmatters.in</p>
											</span>
									</td>
																
								</tr>
					
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>

								

					
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
	
	
$from_name="HousingMatters";
$reply="support@housingmatters.in";

$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$subject="Lets get going with setting up your society and Housing Matters";
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		


	
$this->response->header('Location', 'r_ack');

a:

}
}





function r_ack()
{
$this->layout='without_session';	
}

function society_signup()
{
App::import('', 'sendsms.php');
App::import('phpmailer', 'mail.php');
$this->layout='without_session';
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);	
$user=(int)$this->request->query['user'];
$this->set('user_id', $user);
$this->loadmodel('user_temp');
$conditions=array("user_temp_id" => $user);
$result_user_temp = $this->user_temp->find('all',array('conditions'=>$conditions));
foreach ($result_user_temp as $collection) 
{
$email_temp=$collection['user_temp']['email'];
$mobile_temp=$collection['user_temp']['mobile'];
$user_name_temp=$collection['user_temp']['user_name'];
}
if($this->request->is('post')) 
{
	$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

$society_name=htmlentities($this->request->data['society_name']);
$pin_code=htmlentities($this->request->data['pin_code']);
$association=htmlentities($this->request->data['association']);
$no_flat=htmlentities($this->request->data['no_flat']);
$i=$this->autoincrement('society','society_id');

$this->loadmodel('society');
$this->society->save(array('society_id' => $i, 'society_name' => $society_name, 
'association_formed' => $association, 'user_id' => $user,"aprvl_status"=>0,"pin_code"=>$pin_code,"flats"=>$no_flat));
$this->loadmodel('user_temp');
$this->user_temp->updateAll(array("society_id" => $i,"role" => 1,"complete_signup"=>1,"user_type"=>"third_party"),array("user_temp.user_temp_id" => $user));

//////////////////////mail functionality//////////////////////////////////////////////////////////////////////////////////////////


$z=1;
if($z==1)
{

$this->loadmodel('user');
$conditions=array("user_id" => 1);
$result2 = $this->user->find('all',array('conditions'=>$conditions));
foreach ($result2 as $collection) 
{
$mobile=$collection['user']['mobile'];
}
////////////////////////////// Sms functionality ////////////////////////////////////////////////////////////	

$r=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_sms_ip')); 
$working_key=$r->working_key;
$sms_sender=$r->sms_sender; 
$sms_allow=(int)$r->sms_allow;
if($sms_allow==1){
$sms='New Request for Society registration into HousingMatters. Kindly approve the request.';
$sms1=str_replace(' ', '+', $sms);
$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
}
////////////////////////////////////////// ////////////////////////////////////////////////////// ///////////////////////////////////////////////////////////// ////		
$to="admin@housingmatters.in";
$reply="support@housingmatters.in";



  $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> <p align="justify">Society Name: '.$society_name.' </p> </span> 
										</td>
								
								
								</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> <p align="justify">Pincode: '.$pin_code.'</p> </span> 
										</td>
								
								
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> <p align="justify">User Name: '.$user_name_temp.'</p> </span> 
										</td>
								
								
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> <p align="justify">Mobile: '.$mobile_temp.'</p> </span> 
										</td>
								
								
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> <p align="justify">Email: '.$email_temp.'</p> </span> 
										</td>
								
								
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> <p align="justify"> New Request for Society registration into HousingMatters. Kindly approve the request. </p> </span> 
										</td>
								
								
								</tr>
								
								
								
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';



$from_name="HousingMatters";

$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
$sub=$collection['email']['subject'];
}

$subject='New Society  Set up in HousingMatters:   [' . $society_name . ']';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$z++;
}

if($z==2)
{
$this->loadmodel('user_temp');
$conditions=array("user_temp_id" => $user);
$result_user_temp = $this->user_temp->find('all',array('conditions'=>$conditions));
foreach ($result_user_temp as $collection) 
{
$email=$collection['user_temp']['email'];
$mobile1=$collection['user_temp']['mobile'];
}
$to=$email;



   $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> <p align="justify"> We have received your application. <br/> We will review and get back to you in 24 Hours. </p> </span> 
										</td>
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
	
	
$from_name="HousingMatters";
$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result1_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result1_email as $collection) 
{
$from=$collection['email']['from'];
$sub=$collection['email']['subject'];
}
$reply="support@housingmatters.in";
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
$this->response->header('Location', 'r_ack');

}
}


function resident_signup_ajax()
{
$this->layout='blank';	
$so_id=(int)$this->request->query['con1'];
$this->loadmodel('wing');
$conditions=array("society_id" => $so_id);
$result = $this->wing->find('all',array('conditions'=>$conditions));
$this->set('result3',$result);
}


function resident_signup_wing_flat_ajax()
{
$this->layout='blank';	
$wing_id=(int)$this->request->query['con2'];
$this->loadmodel('flat');
$conditions=array("wing_id" => $wing_id);
$result = $this->flat->find('all',array('conditions'=>$conditions));
$this->set('result3',$result);
}


function fix_deposit_count_via_maturity_date($from,$to)
{
$s_user_id=$this->Session->read('user_id');
$s_society_id= (int)$this->Session->read('society_id');
$this->ath();


$this->loadmodel('fix_deposit');
$conditions=array("society_id" =>$s_society_id,"matured_status"=>1,'fix_deposit.maturity_date'=>array('$gte'=>$from,'$lte'=>$to));
return $this->fix_deposit->find('all',array('conditions'=>$conditions));
}


function return_flat_via_wing_id()
{
$this->layout='blank';	
$wing_id=(int)$this->request->query['con2'];
$i=(int)$this->request->query['con1'];
$this->set('i',$i);
$this->loadmodel('flat');
$conditions=array("wing_id" => $wing_id);
$result = $this->flat->find('all',array('conditions'=>$conditions));
$this->set('result3',$result);
}

function return_flat_via_wing_id3()
{
$this->layout='blank';	
$wing_id=(int)$this->request->query['con2'];
$i=(int)$this->request->query['con1'];
$this->set('i',$i);
$this->loadmodel('flat');
$conditions=array("wing_id" => $wing_id);
$result = $this->flat->find('all',array('conditions'=>$conditions));
$this->set('result3',$result);
}


function flat_already_exits()
{
$this->layout='blank_signup';
//$flat=(int)$this->request->query['flat'];
$society=(int)$this->request->data['society'];
$flat=(int)$this->request->data['flat'];
$tenant_fetch=$this->request->data['tenant'];
$this->loadmodel('user_flat');
$conditions=array("flat" => $flat,'society_id'=>$society,"exited"=>"no","owner"=>array('$ne'=>null));
$result4 = $this->user_flat->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);

if($n4==0){
	
	echo'true';
	
}elseif($n4==1){
	
	foreach($result4 as $data){
		
		$database_tenat=$data['user_flat']['owner'];
		if($database_tenat=='yes'){
			
			if($tenant_fetch==$database_tenat){
				
				echo'false';
				
			}else{
				echo'true';
				
			}
			
			
		}else{
			
			if($tenant_fetch==$database_tenat){
				
				echo'false';
				
			}else{
				
				echo'true';
				
			}
			
			
		}
		
	}
		
}elseif($n4==2){
	
	echo'false';
	
}
/*
$this->loadmodel('flat');
$conditions=array("flat_id" => $flat);
$result66 = $this->flat->find('all',array('conditions'=>$conditions));
foreach($result66 as $dataa)
{
$flat_type = (int)$dataa['flat']['noc_ch_tp'];	
}
if($flat_type == 1)
{
if($tenant_fetch == 'no')
{
echo'false';	
}
}
*/

}


function signup_emilexits()
{
$this->layout='blank_signup';
$email=$this->request->query['email'];
$this->loadmodel('user_temp');
$conditions=array("email" => $email,'reject'=>0);
$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
$n3 = sizeof($result3);
$this->loadmodel('user');
$conditions=array("email" => $email);
$result4 = $this->user->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);
$e=$n3+$n4;
if ($e > 0) {
echo "false";
} else {
echo "true";
}
}

function signup_mobileexit()
{
$this->layout='blank_signup';
$mobile=$this->request->query['mobile'];
$this->loadmodel('user_temp');
$conditions=array("mobile" => $mobile,'reject'=>0);
$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
$n3 = sizeof($result3);
$this->loadmodel('user');
$conditions=array("mobile" => $mobile,"user_id"=>array('$ne'=>1));
$result4 = $this->user->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);
$e=$n4;

if ($e > 0) {
echo "false";
} else {
echo "true";
}
}

function profile_mobile_check()
{
$this->layout='blank_signup';
$s_user_id=$this->Session->read('hm_user_id');	
$mobile=$this->request->query['mobile1'];

$this->loadmodel('user');
$conditions=array("mobile" => $mobile,'user_id'=>$s_user_id);
$result4 = $this->user->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);
$e=$n4;
if ($e > 0) {
echo "true";
} else {
		$this->loadmodel('user_temp');
		$conditions=array("mobile" => $mobile,'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("mobile" => $mobile);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n4 = sizeof($result4);
		$e=$n3+$n4;

		if ($e > 0) {
		echo"false";
		} else {
		echo"true";
		}
	
}	



	
}



function profile_email_check()
{
$this->layout='blank_signup';
$s_user_id=$this->Session->read('hm_user_id');
$email=$this->request->query['email'];
$this->loadmodel('user');
$conditions=array("email" => $email,'user_id'=>$s_user_id);
$result4 = $this->user->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);
$e=$n4;
if ($e > 0) {
echo "true";
} else {

		$this->loadmodel('user_temp');
		$conditions=array("email" => $email,'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("email" => $email);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n5 = sizeof($result4);	
		$e1=$n3+$n5;
		if ($e1 > 0) {
		echo "false";
		} else {
		echo "true";	
		}

		}
}

function forget_check_email_exits(){
	
	$this->layout=null;
	$email=$this->request->query['email'];
		$this->loadmodel('user');
		$conditions=array("email" => $email);
		$result3 = $this->user->find('all',array('conditions'=>$conditions));
		
		$n = sizeof($result3);
		if($n>0){ 
			echo "true";
		}else{
			echo "false";
		}			
	
}

function forget_check_mobile_exits(){
	
	$this->layout=null;
	$mobile=$this->request->query['mobile'];
		$this->loadmodel('user');
		$conditions=array("mobile" => $mobile);
		$result3 = $this->user->find('all',array('conditions'=>$conditions));
		
		$n = sizeof($result3);
		if($n>0){ 
			echo "true";
		}else{
			echo "false";
		}			
	
}

function forget() 
{
$this->layout='without_session';
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path'));
$this->set('webroot_path',$webroot_path);
if ($this->request->is('POST')) 
{
$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

 $forget_type=$this->request->data['forget_type'];
if($forget_type=='email'){
		$to=$this->request->data['email'];
		$this->loadmodel('user');
		$conditions=array("email" => $to);
		$result3 = $this->user->find('all',array('conditions'=>$conditions));
		
		$n = sizeof($result3);
		if($n>0)
		{ 
	
		foreach($result3 as $collection)
		{
		$username=$collection['user']['user_name'];
		$user_id=$collection['user']['user_id'];
		$user_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'member_info_via_user_id'),array('pass'=>array($user_id)));
		$wing_flat=@$user_info["wing_flat"][$user_id];

		$society_id=$collection['user']['society_id'];
		}
		$result_society=$this->society_name($society_id);
		$society_name=$result_society[0]['society']['society_name'];

		$random=mt_rand(10000,99999);
		$this->loadmodel('user');
		$this->user->updateAll(array('password'=>$random),array('user.email'=>$to));
		$from_name="HousingMatters Support Team";
		 $subject="[".$society_name."] OTP for password reset";



		  $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
				  <tbody>
					<tr>
						<td>
							<table width="100%" cellpadding="0" cellspacing="0">
								<tbody>
								
										<tr>
											<td colspan="2">
												<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
												<tbody>
												<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
												<tr>
												<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
												<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
												<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
												<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
													
												</td>
												</tr>
												<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
												</tbody>
												</table>
											</td>
										</tr>
																
										
								</tbody>
							</table>
							
							<table width="100%" cellpadding="0" cellspacing="0">
								<tbody>
								
										
										
										<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Hello '.$username.' '.$wing_flat.', </span> 
										</td>
																		
										</tr>
										
										
										<tr>
												<td style="padding:5px;" width="100%" align="left">
												<span style="color:rgb(100,100,99)" align="justify">It seems that you or someone requested to reset your login password. </span> 
												</td>
																		
										</tr>
										
										<tr>
												<td style="padding:5px;" width="100%" align="left">
												<span style="color:rgb(100,100,99)" align="justify">We have generated a One Time Password (OTP). </span> 
												</td>
																		
										</tr>
										
										
										<tr>
												<td style="padding:5px;" width="100%" align="left">
												<span style="color:rgb(100,100,99)" align="justify">
												<b> Username: </b> = '.$to.'<br/>
												<b>Your OTP to reset your password </b> = '.$random.'  </span> 
												</td>
																		
										</tr>

										
										<tr>
											<td style="padding:5px;" width="100%" align="left">
													<span style="color:rgb(100,100,99)"> 
														Thank you.<br/>
														HousingMatters (Support Team)<br/>
														www.housingmatters.in
													</span>
											</td>
																		
										</tr>
							
							</table>
							
						</td>
					</tr>

				</tbody>
		</table>';

		$this->loadmodel('email');
		$conditions=array('auto_id'=>4);
		$result_email=$this->email->find('all',array('conditions'=>$conditions));
		foreach ($result_email as $collection) 
		{
		$from=$collection['email']['from'];
		}
		$reply=$from;
		//$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
		$this->smtpmailer($to,$from,$from_name,$subject,$message_web,$reply);
		$this->response->header('Location', 'verification?con='.$to.'&em=em ');
		}
		else
		{ 
			$this->set('wrong','This Email is not exist');

		}
}else{
	
	    $mobile=$this->request->data['mobile'];
		$this->loadmodel('user');
		$conditions=array("mobile" => $mobile);
		$result_user = $this->user->find('all',array('conditions'=>$conditions));
		$n = sizeof($result_user);
		if($n>0){ 
			$user_id=(int)$result_user [0]['user']['user_id'];
		
			$random=mt_rand(10000,99999);
			
			$r_sms=$this->requestAction(array('controller'=>'Fns','action'=>'hms_sms_ip'));
			$working_key=$r_sms->working_key;
			$sms_sender=$r_sms->sms_sender; 
			$sms_allow=(int)$r_sms->sms_allow; 
			if($sms_allow==1){
			
					$sms="Your 5 digit random code is ".$random." for verification";
					$sms1=str_replace(" ", '+', $sms);
					$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');

					$this->loadmodel('user');
					$this->user->updateAll(array('password'=>$random),array('user.user_id'=>$user_id));
					$this->response->header('Location', 'verification?con='.$mobile.'&em=m ');
			}
			
			
			
			
		}else{
			$this->set('wrong','This Mobile number is not exist');
		}
	
}

}

}

function verification_check_code(){
	$this->layout=null;
	$user_id=(int)$this->request->data['user_id'];
	$code=(int)$this->request->data['email'];
	
	$this->loadmodel('user');
	$conditions =array('user_id'=> $user_id,'password'=>$code);

	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	$n= sizeof($result_user); 
	if($n>0){
		echo"true";
	}else{
		echo"false";
	}
	
}


function verification() 
{
$this->layout='without_session';
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path'));
$this->set(compact('webroot_path'));
$emil=$this->request->query['con'];
$type=$this->request->query['em'];
$this->set('type',$type);


$this->loadmodel('user');
$conditions =array( '$or' => array(array('email'=> $emil),array('mobile'=> $emil)));

$result_user=$this->user->find('all',array('conditions'=>$conditions));
$n= sizeof($result_user); 
if($n>0)
{
	$user_id=$result_user[0]['user']['user_id'];
	$this->set('user_id',$user_id);
}

if ($this->request->is('POST')) 
{
$verification=(int)$this->request->data['email'];
$this->loadmodel('user');
$conditions =array( '$or' => array( 
array('email'=> $emil,'password'=>$verification),
array('mobile'=> $emil,'password'=>$verification)
));

$result_user=$this->user->find('all',array('conditions'=>$conditions));
$n= sizeof($result_user); 
if($n>0)
{
$this->response->header('Location', $this->webroot.'hms/change_password?con='.$emil.' ');

}
else
{
$this->set('wrong','This verification is not exist');
}

}

}


function change_new_password(){
	
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$user_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'member_info_via_user_id'),array('pass'=>array($s_user_id)));
	
	$username=$user_info['user_name'];
	$to=$user_info['email'];
	$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));
	if($this->request->is('POST')) {
		$pass=$this->request->data['pass'];
		  $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
				  <tbody>
					<tr>
						<td>
							<table width="100%" cellpadding="0" cellspacing="0">
								<tbody>
								
										<tr>
											<td colspan="2">
												<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
												<tbody>
												<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
												<tr>
												<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
												<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
												<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
												<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
													
												</td>
												</tr>
												<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
												</tbody>
												</table>
											</td>
										</tr>
																
										
								</tbody>
							</table>
							
							<table width="100%" cellpadding="0" cellspacing="0">
								<tbody>
								
										
										
										<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Hi '.$username.',  </span> 
										</td>
																		
										</tr>
										
										
										<tr>
												<td style="padding:5px;" width="100%" align="left">
												<span style="color:rgb(100,100,99)" align="justify">The password for your HousingMatters Account '.$to.' was recently changed </span> 
												</td>
																		
										</tr>
										
										
										<tr>
											<td style="padding:5px;" width="100%" align="left">
													<span style="color:rgb(100,100,99)"> 
														Thank you.<br/>
														HousingMatters (Support Team)<br/>
														www.housingmatters.in
													</span>
											</td>
																		
										</tr>
							
							</table>
							
						</td>
					</tr>

				</tbody>
		</table>';
		
		$this->loadmodel('email');
		$conditions=array('auto_id'=>4);
		$result_email=$this->email->find('all',array('conditions'=>$conditions));
		foreach ($result_email as $collection) 
		{
		$from=$collection['email']['from'];
		}
		$reply=$from;
		$subject="Your Password changed";
		$from_name="HousingMatters";
		$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
		//$this->smtpmailer($to,$from,$from_name,$subject,$message_web,$reply);
		
		$this->loadmodel('user');
		$this->user->updateAll(array('password'=>$pass),array('user.user_id'=>$s_user_id));
		
		$this->Session->write('change_pass', 1);
		$this->redirect(array('action' => 'dashboard'));
	}
	
}

function check_current_password(){
	$this->layout=null;	
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$current_password=$this->request->query['current_password'];
	$this->loadmodel('user');
	$conditions=array('user_id'=>$s_user_id,'password'=>$current_password);
	$count=$this->user->find('count',array('conditions'=>$conditions));
	if($count>0){
		echo"true";
	}else{
		echo"false";
	}
	
	
}

function change_password() 
{
$this->layout='without_session';
$emil=$this->request->query['con'];
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path'));
$this->set(compact('webroot_path'));
if ($this->request->is('POST')) 
{
$pass=$this->request->data['pass'];
$this->loadmodel('user');
$conditions=array('email'=> $emil);

$conditions =array( '$or' => array(array('email'=> $emil),array('mobile'=> $emil)));

$result_user=$this->user->find('all',array('conditions'=>$conditions));
$n= sizeof($result_user); 
if($n>0)
{ 
foreach ($result_user as $collection) 
{
$user_id=$collection['user']["user_id"];
$society_id=$collection['user']["society_id"];
$user_name=$collection['user']["user_name"];
 $role_id=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_role_via_user_id'), array('pass' => array($user_id)));
}
$user_flat_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'), array('pass' => array($user_id)));
$user_flat_id=$user_flat_info[0]["user_flat"]["user_flat_id"]; 
		
$this->Session->write('hm_user_id', $user_id);
$this->Session->write('role_id', $role_id);
$this->Session->write('hm_society_id', $society_id);
$this->Session->write('hm_user_flat_id', $user_flat_id);
$this->loadmodel('user');
$this->user->updateAll(array('password'=>$pass),array('user.user_id'=>$user_id));
$this->redirect(array('action' => 'dashboard'));
}

}
}


function dashboard2() 
{
Configure::version();

if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
}

function role_security_dashboard($scoiety_id,$role_id,$module_id){
	
	$this->loadmodel('role_privilege');
	$conditions=array("society_id"=>$scoiety_id,"role_id"=>$role_id,"module_id"=>$module_id);
	return $this->role_privilege->find('all',array('conditions'=>$conditions));
	
}

function role_security_dashboard_sub($scoiety_id,$role_id,$module_id,$sub_module_id){
	
	$this->loadmodel('role_privilege');
	$conditions=array("society_id"=>$scoiety_id,"role_id"=>$role_id,"module_id"=>$module_id,'sub_module_id'=>$sub_module_id);
	return $this->role_privilege->find('all',array('conditions'=>$conditions));
	
}
	
function tenant_access(){ 
	
	$this->layout='without_session';	
	
}

function supplimentry_bill_table(){
	
	$this->layout='blank';	
	$this->ath();
	?>
	<table border="1">
	<tr>
	  <th>supplimentry_bill_id</th>
		<th>receipt_id</th>
		<th>company_name</th>
		<th>ledger_sub_account_id</th>
		<th>description</th>
		<th>date</th>
		<th>society_id</th>
		<th>total_amount</th>
		<th>income_head</th>
		<th>created_by</th>
		<th>due_date</th>
		<th>supplimentry_bill_type</th>
		<th>transaction_date</th>
		
	</tr>
	<?php
		$this->loadmodel("adhoc_bill");
		$result_adhoc_bill=$this->adhoc_bill->find('all');
		foreach($result_adhoc_bill as $data){
		$supplimentry_bill_id=(int)$data['adhoc_bill']['adhoc_bill_id'];
		$receipt_id=$data['adhoc_bill']['receipt_id'];
		$company_name=$data['adhoc_bill']['company_name'];
		$description=$data['adhoc_bill']['description'];
		$date=$data['adhoc_bill']['date'];
		$society_id=$data['adhoc_bill']['society_id'];
		$g_total=$data['adhoc_bill']['g_total'];
		$income_head=$data['adhoc_bill']['income_head'];
		$created_by=@$data['adhoc_bill']['created_by'];
		$due_date=@$data['adhoc_bill']['due_date'];
		$bill_daterange_from=@$data['adhoc_bill']['bill_daterange_from'];
		
		if(!empty($due_date)){
			$due_date= date("Y-m-d", strtotime($due_date)); 
			$due_date= strtotime($due_date);
		}
		$flat_id=$data['adhoc_bill']['person_name'];
		$this->loadmodel("ledger_sub_account");
		$result_ledger_sub_accounts=$this->ledger_sub_account->find('all',array('conditions'=>array('flat_id'=>$flat_id)));
		$ledger_sub_account_id=(int)$result_ledger_sub_accounts[0]['ledger_sub_account']['auto_id'];
	?>
	<tr>
	<td> <?php echo $supplimentry_bill_id; ?></td>
	<td> <?php echo $receipt_id; ?></td>
	<td> <?php echo $company_name; ?></td>
	<td> <?php echo $ledger_sub_account_id; ?></td>
	<td> <?php echo $description; ?></td>
	<td> <?php echo $date; ?></td>
	<td> <?php echo $society_id; ?></td>
	<td> <?php echo $g_total; ?></td>
	<td> <?php echo $income_head; ?></td>
	<td> <?php echo $created_by; ?></td>
	<td> <?php echo $due_date; ?></td>
	<td> resident</td>
	<td> <?php echo $bill_daterange_from; ?></td>
	</tr>
	<?php
	}
	?>
	</table>
	<?php
}
function committee_member_list(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id = $this->Session->read('hm_user_id'); 
	$role_id = $this->Session->read('role_id');	
	
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id,'active'=>'yes');
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data){
				$user_id=$data['user']['user_id'];
				$user_name=$data['user']['user_name'];
				$email=$data['user']['email'];
				$mobile=$data['user']['mobile'];
				$designation_id=@$data['user']['designation_id'];
				
				$this->loadmodel('governance_designation');
				$conditions=array("society_id" => $s_society_id,"governance_designation_id"=>$designation_id);
				$result_designation=$this->governance_designation->find('all',array('conditions'=>$conditions));
				$designation_name=@$result_designation[0]['governance_designation']['designation_name'];
				$this->loadmodel('user_flat');
				$conditions1=array("user_id"=>$user_id);
				$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions1));
				foreach($result_user_flat as $data){
							$user_flat_id=$data["user_flat"]["user_flat_id"];
							$wing=@$data["user_flat"]["wing"];
							$flat=@$data["user_flat"]["flat"];

							$this->loadmodel('wing');
							$conditions=array("wing_id"=>$wing);
							$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
							@$wing_name=$wing_info[0]["wing"]["wing_name"];

							$this->loadmodel('flat');
							$conditions=array("flat_id"=>$flat);
							$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
							@$flat_name=ltrim($flat_info[0]["flat"]["flat_name"],'0');
							$flats=$wing_name.' - '.$flat_name;
					}
				
				$this->loadmodel('user_role');
				$conditions3=array("user_id"=>$user_id,'role_id'=>2);
				$result_user_role=$this->user_role->find('all',array('conditions'=>$conditions3));
				if(!empty($result_user_role)){
					$result_users_com[]=array('user_name'=>$user_name,'wing_flat'=>$flats,'email'=>$email,'mobile'=>$mobile,'user_id'=>$user_id,'user_flat_id'=>$user_flat_id,'designation_name'=>$designation_name);
				}
				
	}
	$this->set('result_committee_member',$result_users_com);
}

function member_update_status_profile($user_id=null){
	
 $this->layout=null;	
 $this->loadmodel("user");
 $this->user->updateAll(array('profile_status_user'=>1),array('user_id'=>(int)$user_id));
 echo"done";
}


function hm_sms_allow_society(){
	
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	
	$this->loadmodel('society');
	$result_society=$this->society->find('all',array('conditions'=>array('aprvl_status'=>1)));
	$this->set(compact('result_society'));
}


function hm_sms_allow_society_ajax($id=null,$value=null){
		
		$this->loadmodel('society');
		$this->society->updateAll(array('sms_limit'=>$value),array("society_id"=>(int)$id));

}

function trial_balance_report_up($from=null,$to=null){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	
	$this->ath();
	$from=date('Y-m-d',strtotime($from));
	$from=strtotime($from);
	
	$to=date('Y-m-d',strtotime($to));
	$to=strtotime($to);
	
	$this->loadmodel('trial_balance_report');
	$today = date("d-M-Y");
	$this->loadmodel('trial_balance_report');
	$auto_id=$this->autoincrement('trial_balance_report','auto_id');
	$this->trial_balance_report->saveAll(Array( Array("auto_id" => $auto_id,"module_name" => "TB", "step1" => 1,"date"=>$today,"from"=>$from,"to"=>$to))); 
	die(json_encode("UPLOADED"));
	
}

function trial_balance_report_read(){

if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->loadmodel('trial_balance_report');
    $conditions=array("module_name" => "TB");
	$result_trial_report=$this->trial_balance_report->find('all',array("conditions"=>$conditions));
	$from=$result_trial_report[0]['trial_balance_report']['from'];
	$to=$result_trial_report[0]['trial_balance_report']['to'];
	$date=$result_trial_report[0]['trial_balance_report']['date'];
	$this->loadmodel("society");
	$result_society=$this->society->find('all',array('conditions'=>array('aprvl_status'=>1)));	
	foreach($result_society as $data){
		$society_id=(int)$data['society']['society_id'];
		$society_name=$data['society']['society_name'];
		
		$this->loadmodel('trial_balance_report_read');
		$auto_id=$this->autoincrement('trial_balance_report_read','auto_id');
		$this->trial_balance_report_read->saveAll(Array(Array("auto_id" => $auto_id,"society_name"=>$society_name,"society_id"=> $society_id,"is_converted"=>"NO","from"=>$from,"to"=>$to,"date"=>$date)));
	}
	$this->loadmodel('trial_balance_report');
	$this->trial_balance_report->updateAll(array("step2" => 1),array("module_name" => "TB"));
	die(json_encode("READ"));	
}


function trial_balance_converted(){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	
	$this->loadmodel('trial_balance_report_read');
	$conditions=array("is_converted" => "NO");
	$result_import_record = $this->trial_balance_report_read->find('all',array('conditions'=>$conditions,'limit'=>1));
	foreach($result_import_record as $import_record){
		
		$auto_id=(int)$import_record['trial_balance_report_read']['auto_id'];
		$society_id=(int)$import_record['trial_balance_report_read']['society_id'];
		$society_name=$import_record['trial_balance_report_read']['society_name'];
		$from=$import_record['trial_balance_report_read']['from'];
		$to=$import_record['trial_balance_report_read']['to'];
		$date=$import_record['trial_balance_report_read']['date'];
		
			$result_ledger_account=array();	
			$this->loadmodel('accounts_category');
			$result_accounts_category=$this->accounts_category->find('all');
			foreach($result_accounts_category as $data){
				$accounts_category_id=(int)$data["accounts_category"]["auto_id"];

				$this->loadmodel('accounts_group');
				$conditions2=array("accounts_id" => $accounts_category_id);
				$result_accounts_group=$this->accounts_group->find('all',array('conditions'=>$conditions2));
				foreach($result_accounts_group as $data2){
					$accounts_group_ids[]=(int)$data2["accounts_group"]["auto_id"];
				}

				foreach($accounts_group_ids as $accounts_group_id){
					$condition_array[]=array("group_id" => $accounts_group_id,"society_id" => $society_id);
					$condition_array[]=array("group_id" => $accounts_group_id,"society_id" => 0);
				}


				$this->loadmodel('ledger_account');
				$conditions =array( '$or' =>$condition_array);

				$order=array('ledger_account.ledger_name'=> 'ASC');
				$result_ledger_account_1=$this->ledger_account->find('all',array('conditions'=>$conditions,'order'=>$order));


				$result_ledger_account=array_merge($result_ledger_account,$result_ledger_account_1);

				unset($accounts_group_ids); unset($condition_array);
			}
		
			$total_cb_debit=0; $total_cb_credit=0;
			foreach($result_ledger_account as $ledger_account){ 
				$ledger_account_id=(int)$ledger_account["ledger_account"]["auto_id"];
			
				$trail_balance=$this->calculate_opening_balance_for_trail_balance_society($society_id,$from,$to,$ledger_account_id);
				
				if($trail_balance["closing_balance"][1]=="Dr"){
					$total_cb_debit+=$trail_balance["closing_balance"][0];
				}
				
				if($trail_balance["closing_balance"][1]=="Cr"){
					$total_cb_credit+=$trail_balance["closing_balance"][0];
				}
			}	
		
		
			$this->loadmodel('trial_balance_converted');
			$auto_id_n=$this->autoincrement('trial_balance_converted','auto_id');
			$this->trial_balance_converted->saveAll(Array(Array("auto_id" => $auto_id_n,"society_id"=>$society_id,'society_name'=>$society_name,"is_imported"=>"NO",'closing_debit'=>$total_cb_debit,'closing_credit'=>$total_cb_credit,'date'=>$date)));
		
		$this->loadmodel('trial_balance_report_read');
		$this->trial_balance_report_read->updateAll(array("is_converted" => "YES"),array("auto_id" => $auto_id));
		
		
	}
	
	$this->loadmodel('trial_balance_report_read');
	$conditions=array("is_converted" => "YES");
	$total_converted_records = $this->trial_balance_report_read->find('count',array('conditions'=>$conditions));
	
	$this->loadmodel('trial_balance_report_read');
	//$conditions=array("society_id" => $s_society_id);
	$total_records = $this->trial_balance_report_read->find('count');
	
	$converted_per=($total_converted_records*100)/$total_records;
	if($converted_per==100){ $again_call_ajax="NO"; 
		$this->loadmodel('trial_balance_report');
		$this->trial_balance_report->updateAll(array("step3" => 1),array("module_name" => "TB"));
	}else{
		$again_call_ajax="YES"; 
			
		}
	die(json_encode(array("again_call_ajax"=>$again_call_ajax,"converted_per"=>$converted_per)));
	
}

function trial_balance_report_modify(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$this->loadmodel('trial_balance_report');
	$result_trial_balance_report=$this->trial_balance_report->find('all');
	$date=@$result_trial_balance_report[0]['trial_balance_report']['date'];
	$from=@$result_trial_balance_report[0]['trial_balance_report']['from'];
	$to=@$result_trial_balance_report[0]['trial_balance_report']['to'];
	$this->set(compact('date'));
	$this->set(compact('from'));
	$this->set(compact('to'));
	$this->loadmodel('trial_balance_converted');
	$result_trial_balance=$this->trial_balance_converted->find('all');
	$this->set(compact('result_trial_balance'));
}

function trial_balance_report_closed(){
	
	$this->layout=null ;
	
	$this->loadmodel('trial_balance_report');
	$this->loadmodel('trial_balance_report_read');
	$this->loadmodel('trial_balance_converted');
	$this->trial_balance_report->deleteAll(array('module_name'=>'TB'));
	$this->trial_balance_report_read->deleteAll(array('is_converted'=>'YES'));
	$this->trial_balance_converted->deleteAll(array('is_imported'=>'NO'));
	$this->response->header('location','trial_balance_report_society_wise');
}

function trial_balance_report_send_email(){
	
	 $mes=$this->request->query('con');
	 $ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip')); 
	 
	// $to="rohitkumarjoshi43@gmail.com";
	 $to="admin@housingmatters.in";
	 $from_name="HousingMatters Support Team";
	 $subject="All Society Report";
		$this->loadmodel('email');
		$conditions=array('auto_id'=>4);
		$result_email=$this->email->find('all',array('conditions'=>$conditions));
		foreach ($result_email as $collection) {
			$from=$collection['email']['from'];
		}
		$reply=$from;
		
		 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
				  <tbody>
					<tr>
						<td>
							<table width="100%" cellpadding="0" cellspacing="0">
								<tbody>
								
										<tr>
											<td colspan="2">
												<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
												<tbody>
												<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
												<tr>
												<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
												<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
												<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
												<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
													
												</td>
												</tr>
												
												</tbody>
												</table>
											</td>
										</tr>
																
										
								</tbody>
							</table>
						</td>	
							
					</tr>

				</tbody>
		</table>';
		 $message_web.=$mes;
		
	  $this->send_email($to,$from,$from_name,$subject,$message_web,$reply);	
		$this->loadmodel('trial_balance_report');
		$this->loadmodel('trial_balance_report_read');
		$this->loadmodel('trial_balance_converted');
		$this->trial_balance_report->deleteAll(array('module_name'=>'TB'));
		$this->trial_balance_report_read->deleteAll(array('is_converted'=>'YES'));
		$this->trial_balance_converted->deleteAll(array('is_imported'=>'NO')); 
	
	    die(json_encode("SEND"));
}

function trial_balance_report_society_wise(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	
	
	$this->loadmodel('trial_balance_report');
	$conditions=array("module_name" => "TB");
	$result_import_record = $this->trial_balance_report->find('all',array('conditions'=>$conditions));
	$this->set('result_import_record',$result_import_record);
	foreach($result_import_record as $data_import){
		$step1=(int)@$data_import["trial_balance_report"]["step1"];
		$step2=(int)@$data_import["trial_balance_report"]["step2"];
		$step3=(int)@$data_import["trial_balance_report"]["step3"];
		$step4=(int)@$data_import["trial_balance_report"]["step4"];
	}
	$process_status= @$step1+@$step2+@$step3+@$step4;

	if(@$process_status==2){
		$this->loadmodel('trial_balance_report_read');
		$conditions=array("is_converted" => "YES");
		$total_converted_records = $this->trial_balance_report_read->find('count',array('conditions'=>$conditions));
		
		$this->loadmodel('trial_balance_report_read');
		
		$total_records = $this->trial_balance_report_read->find('count');
		
		$this->set("converted_per",($total_converted_records*100)/$total_records);
	}
	/* if(@$process_status==4){
		$this->loadmodel('bank_receipt_csv_converted');
		$conditions=array("society_id" => $s_society_id,"is_imported" => "YES");
		$total_converted_records = $this->bank_receipt_csv_converted->find('count',array('conditions'=>$conditions));
		
		$this->loadmodel('bank_receipt_csv_converted');
		$conditions=array("society_id" => $s_society_id);
		$total_records = $this->bank_receipt_csv_converted->find('count',array('conditions'=>$conditions));
		
		$this->set("converted_per_im",($total_converted_records*100)/$total_records);
	}
	*/
	
	
	
	/*$this->loadmodel('society');
	$result_society=$this->society->find('all',array('conditions'=>array('aprvl_status'=>1)));
	foreach($result_society as $data){
			$s_society_id=$data['society']['society_id'];
			$society_name=$data['society']['society_name'];

			$result_ledger_account=array();	
			$this->loadmodel('accounts_category');
			$result_accounts_category=$this->accounts_category->find('all');
	  foreach($result_accounts_category as $data){
			$accounts_category_id=(int)$data["accounts_category"]["auto_id"];
		
			$this->loadmodel('accounts_group');
			$conditions2=array("accounts_id" => $accounts_category_id);
			$result_accounts_group=$this->accounts_group->find('all',array('conditions'=>$conditions2));
		foreach($result_accounts_group as $data2){
				$accounts_group_ids[]=(int)$data2["accounts_group"]["auto_id"];
			}
		
		  foreach($accounts_group_ids as $accounts_group_id){
				$condition_array[]=array("group_id" => $accounts_group_id,"society_id" => $s_society_id);
				$condition_array[]=array("group_id" => $accounts_group_id,"society_id" => 0);
			}
		
		
			$this->loadmodel('ledger_account');
			$conditions =array( '$or' =>$condition_array);

			$order=array('ledger_account.ledger_name'=> 'ASC');
			$result_ledger_account_1=$this->ledger_account->find('all',array('conditions'=>$conditions,'order'=>$order));


			$result_ledger_account=array_merge($result_ledger_account,$result_ledger_account_1);

			unset($accounts_group_ids); unset($condition_array);
	   }
	$from="01-04-2016";$to="2017-03-31";
	$total_ob_debit=0; $total_ob_credit=0; $total_debit=0; $total_credit=0; $total_cb_debit=0; $total_cb_credit=0;
		foreach($result_ledger_account as $ledger_account){ 
			$ledger_account_id=(int)$ledger_account["ledger_account"]["auto_id"];
			
			 $trail_balance=$this->requestAction(array('controller' => 'Hms', 'action' => 'calculate_opening_balance_for_trail_balance'),array('pass'=>array($s_society_id,$from,$to,$ledger_account_id)));
				
				if($trail_balance["closing_balance"][1]=="Dr"){
					$total_cb_debit+=$trail_balance["closing_balance"][0];
				}
				
				if($trail_balance["closing_balance"][1]=="Cr"){
					$total_cb_credit+=$trail_balance["closing_balance"][0];
				}
		}			
	
				
		$report_trial_balance[]=array("society_name"=>$society_name,"debit"=>$total_cb_debit,"credit"=>$total_cb_credit); 
		 pr($report_trial_balance); exit; 
		
	}
	
 pr($report_trial_balance);
	//pr($trail_balance);
	*/
}


function calculate_opening_balance_for_trail_balance_society($society_id=null,$from=null,$to=null,$ledger_account_id=null){
	$this->ath();
	
	$s_society_id = (int)$society_id;
	//$from=date('Y-m-d',strtotime($from));
	
	$this->loadmodel('ledger');
	$conditions=array('society_id'=>$s_society_id,'ledger_account_id'=>$ledger_account_id,'transaction_date'=>array('$lt'=>$from));
	$ledger_result_ob=$this->ledger->find('all',array('conditions'=>$conditions));
	
	$credit_ob=0; $debit_ob=0;
	foreach($ledger_result_ob as $data_ob){
		$debit_ob+=$data_ob["ledger"]["debit"];
		$credit_ob+=$data_ob["ledger"]["credit"];
	}
	$difference_ob=$debit_ob-$credit_ob;
	if($difference_ob>0){
		$type_ob="Dr";
	}
	if($difference_ob<0){
		$type_ob="Cr";
	}
	if($difference_ob==0){
		$type_ob=null;
	}
	
	$this->loadmodel('ledger');
	$conditions2=array('society_id'=>$s_society_id,'ledger_account_id'=>$ledger_account_id,'transaction_date'=>array('$gte'=>$from,'$lte'=>$to));	
	$ledger_result_dc=$this->ledger->find('all',array('conditions'=>$conditions2));
	$credit_dc=0; $debit_dc=0;
	foreach($ledger_result_dc as $data_dc){
		$debit_dc+=$data_dc["ledger"]["debit"];
		$credit_dc+=$data_dc["ledger"]["credit"];
	}
	
	
	$difference_cb=$debit_dc-$credit_dc;
	
	
	
	$close_bal=$difference_ob+$difference_cb;
	
	if($close_bal>0){
		$type_cb="Dr";
	}
	if($close_bal<0){
		$type_cb="Cr";
	}
	if($close_bal==0){
		$type_cb=null;
	}
	
	$trail_balance=array(
		"opening_balance"=>array(abs($difference_ob),$type_ob),
		"debit"=>$debit_dc,
		"credit"=>$credit_dc,
		"closing_balance"=>array(abs($close_bal),$type_cb)
		);
	return $trail_balance; 
	
}


function dashboard(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();

	//$Currency = new CurrencyHelper(new View());
	//$Currency->formatCurrency("987541", "INR");
	
	$s_society_id = $this->Session->read('hm_society_id');
	$profile_status_user = $this->Session->read('profile_status_user');
	$s_user_id = $this->Session->read('hm_user_id'); 
	$role_id = $this->Session->read('role_id');
	$this->set('role_id',$role_id);
	$this->set('s_society_id',$s_society_id);
	$this->set('profile_status_user',$profile_status_user);

	$user_type=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_user_type_via_user_id'), array('pass' => array($s_user_id)));
	
	$this->set('user_type',$user_type);
	 
		//////////////Help-desk  last 3 tickets///////////////// 
		$this->loadmodel('help_desk');
		if($role_id==1) { 
		$conditions=array("society_id" => $s_society_id);
		}

		if($role_id!=1) {
		
		$conditions=array("society_id" => $s_society_id,"user_id" => $s_user_id);
		}

		$order=array('help_desk.ticket_id'=> 'DESC');
		$result_help_desk=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order,'limit' =>3));
		$this->set('result_help_desk',$result_help_desk);
		
		//////////////Help-desk  last 3 tickets///////////////// 
				
		//////////////discussion  last 3 topic///////////////// 
		$this->loadmodel('discussion_post');
		$conditions =array('society_id' =>$s_society_id,'delete' =>'no',"status"=>0,'users_have_access' =>$s_user_id);
		$order=array('discussion_post.discussion_post_id'=>'DESC');
		$this->set('result_discussion_topics',$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order,'limit' =>3)));
		//////////////discussion  last 3 topic///////////////// 

		
		//////////////event  last 3///////////////// 
		$this->loadmodel('event');
		$conditions=array("society_id" => $s_society_id,"visible_user_id" =>array('$in' => array($s_user_id)));
		$order=array('event.event_id'=>'DESC');
		$this->set('result_event_last',$this->event->find('all', array('conditions' => $conditions,'order' => $order,'limit' =>3)));
		//////////////event  last 3 topic///////////////// 
				
			
	//////////////polls  last 3///////////////// 
	$current_date3=date("Y-m-d");
	$current_date3 = new MongoDate(strtotime($current_date3)); 
	$this->loadmodel('poll');
	$conditions=array("society_id" => $s_society_id,"visible_user_id" =>array('$in' => array($s_user_id)),"deleted" => 0,'close_date' => array('$gt' => $current_date3));
	$order=array('poll.poll_id'=>'DESC');
	$this->set('result_poll_last',$this->poll->find('all', array('conditions' => $conditions,'order' => $order,'limit' =>3)));

	//////////////polls  last 3///////////////// 
	
  //log report clean 1 month latter

	  $new_date=date("Y-m-d");
	  $new_s=strtotime($new_date);
	  $final = date("Y-m-d", strtotime("-1 month", $new_s));
	  $clean_date=strtotime($final);
	  $this->loadmodel('log');
      $conditions=array('society_id'=>$s_society_id);
	  $res= $this->log->find('all', array('conditions' => $conditions));
	  foreach($res as $data){
			 $log_id=$data['log']['log_id'];
			 $date=@$data['log']['date']; 
			 $date_convert=date("Y-m-d",strtotime($date));
			 $date_convert=strtotime($date_convert);
			 $this->log->updateAll(array("date_convert"=>$date_convert),array("log_id"=>$log_id));
		 }
		 
		  $this->loadmodel('log');
	      $conditions=array('society_id'=>$s_society_id,'date_convert'=>array('$lt'=>$clean_date));
		  $this->log->deleteAll($conditions);

  //////End ///
		  
		  
		//////////////documents  last 3///////////////// 
		$this->loadmodel('resource');
	
		$conditions=array('society_id'=>$s_society_id,'user_access'=>$s_user_id);
	
		$order=array('resource.resource_id'=>'DESC');
		$result_resource_last=$this->resource->find('all',array('conditions'=>$conditions,'order' => $order,'limit' =>3));
		$this->set('result_resource_last',$result_resource_last);
		
		//////////////documents  last 3///////////////// 

		//////////////notice///////////////// 
		$current_date2=date("Y-m-d");
    	$current_date2 = new MongoDate(strtotime($current_date2)); 
		$this->loadmodel('notice');
		$result_notice_visible_last=array();
		$conditions=array("n_draft_id" => 0, "n_delete_id" => 0,"society_id"=> $s_society_id,'n_expire_date' => array('$gte'=>$current_date2),'visible_user_id'=>$s_user_id);
		$order=array('notice.notice_id'=>'DESC');
		$result_notice_visible_last=$this->notice->find('all', array('conditions' => $conditions,'order' => $order,'limit' =>3));

		$this->set('result_notice_visible_last',$result_notice_visible_last);
		
	//// bill code
	
	$this->loadmodel('regular_bill_temp');
	$result_regular_temp=$this->regular_bill_temp->find('all');
	
		
		foreach($result_regular_temp as $data){
			$due_payment=0;
			$auto_id=(int)$data['regular_bill_temp']['auto_id'];
			$arrear_intrest=$data['regular_bill_temp']['arrear_intrest'];
			$arrear_principle=$data['regular_bill_temp']['arrear_principle'];
			$intrest_on_arrears=$data['regular_bill_temp']['intrest_on_arrears'];
			$total=$data['regular_bill_temp']['total'];
			$due_payment=$total+$arrear_principle+$arrear_intrest+$intrest_on_arrears;
			$this->loadmodel('regular_bill_temp');
			$this->regular_bill_temp->updateAll(array('due_for_payment'=>$due_payment),array('auto_id'=>$auto_id));
			
		}
		
		
	
	/*
		user role table to put society id for all entry
		
		$this->loadmodel('user_role');
		$result_user_role=$this->user_role->find('all');
		foreach($result_user_role as $data){
			$auto_id=(int)$data['user_role']['auto_id'];
			$user_id=(int)$data['user_role']['user_id'];
			$this->loadmodel('user');
		    $result_user=$this->user->find('all',array('conditions'=>array('user_id'=>$user_id)));
			$society_id=(int)$result_user[0]['user']['society_id'];
			$this->user_role->updateAll(array("society_id"=>$society_id),array("auto_id"=>$auto_id));
		} 
	
	$this->loadmodel('regular_bill');
	$conditions=array("start_date" => 1459449000,'society_id'=>8);
	$regular_bills = $this->regular_bill->find('all',array('conditions'=>$conditions));
	foreach($regular_bills as $data){
		$auto_id=(int)$data['regular_bill']['auto_id'];
		$ledger_sub_account_id=(int)$data['regular_bill']['ledger_sub_account_id'];
		
		
		
			$this->loadmodel('ledger');
			$conditions=array('transaction_date'=>array('$lt'=>1459449000),'ledger_sub_account_id'=>$ledger_sub_account_id,'society_id'=>8);
			$ledger_result = $this->ledger->find('all',array('conditions'=>$conditions));
			//pr($ledger_result);
			$total_maint=0; $total_non_maint=0; $total_interest=0; $total_receipt=0;
			foreach($ledger_result as $data){
				
				$table_name=$data['ledger']['table_name'];
				$debit=$data['ledger']['debit'];
				$credit=$data['ledger']['credit'];
				$intrest_on_arrears=@$data['ledger']['intrest_on_arrears'];
				
				if(($table_name=="regular_bill" and $intrest_on_arrears!="YES") or ($table_name=="opening_balance" and $intrest_on_arrears!="YES")){
					$total_maint+=$debit-$credit;
				}
				if(($table_name=="regular_bill" and $intrest_on_arrears=="YES") or ($table_name=="opening_balance" and $intrest_on_arrears=="YES")){
					$total_interest+=$debit-$credit;
				}
				if($table_name=="supplimentry_bill" or $table_name=="journal"){
					$total_non_maint+=$debit-$credit;
				}
				
				if($table_name=="cash_bank"){
					$total_receipt+=$debit-$credit;
				}
				
			}
			
		
	
	   $total_receipt=abs($total_receipt);
		
	   $reminder=$total_receipt-$total_interest;
		if($reminder<=0){
			$total_receipt=0;
			$total_interest=abs($reminder);
		}else{
			$total_interest=0;
			$total_receipt=abs($reminder);
			
			$reminder=$total_receipt-$total_non_maint;
			if($reminder<=0){
				$total_receipt=0;
				$total_non_maint=abs($reminder);
			}else{
				$total_non_maint=0;
				$total_receipt=abs($reminder);
				
				$reminder=$total_receipt-$total_maint;
				if($reminder<=0){
					$total_receipt=0;
					$total_maint=abs($reminder);
				}else{
					$total_receipt=abs($reminder);
					$total_maint=0;
					
					$total_maint=-$total_receipt;
				}
			}
		}
		
		
		/*
		
		$reminder=$total_receipt-$total_non_maint;
		if($reminder<=0){
			$total_receipt=0;
			$total_non_maint=abs($reminder);
		}else{
			$total_non_maint=0;
			$total_receipt=abs($reminder);
			
			$reminder=$total_receipt-$total_interest;
			if($reminder<=0){
				$total_receipt=0;
				$total_interest=abs($reminder);
			}else{
				$total_interest=0;
				$total_receipt=abs($reminder);
				
				$reminder=$total_receipt-$total_maint;
				if($reminder<=0){
					$total_receipt=0;
					$total_maint=abs($reminder);
				}else{
					$total_receipt=abs($reminder);
					$total_maint=0;
					
					$total_maint=-$total_receipt;
				}
			}
		} */
		
		//$this->loadmodel('regular_bill');
		//$this->regular_bill->updateAll(array('maint_arrear'=>$total_maint,'non_maint_arrear'=>$total_non_maint,'intrest_on_arrears'=>$total_interest),array('auto_id'=>(int)$auto_id));
		
	
	
	
	
	
	

		/*$this->loadmodel("discussion_comment");
		$result_discussion_comment=$this->discussion_comment->find('all');
		foreach($result_discussion_comment as $data){
				$auto_id=(int)$data['discussion_comment']['discussion_comment_id'];
				$current_date=$data['discussion_comment']['date']; 
				$date2= date("d-m-y",strtotime($current_date)); 
				$date23= date("Y-m-d",strtotime($date2));
				$this->loadmodel("discussion_comment");
				$this->discussion_comment->updateAll(array('date'=>$date23),array('discussion_comment_id'=>$auto_id));
    		}
		exit;
				$this->loadmodel("user");
		$conditions=array('user_type'=>'family_member');
		$result_user=$this->user->find('all',array('conditions'=>$conditions));
		
		
		foreach($result_user as $data){
				$user_id=(int)$data['user']['user_id'];
				$this->loadmodel("user_flat");
				$conditions=array('user_id'=>$user_id);
				$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions));
				
				foreach($result_user_flat as $data){
					$user_flat_id=$data['user_flat']['user_flat_id'];
					$owner=@$data['user_flat']['owner'];
					$this->user_flat->updateAll(array('owner'=>null),array('user_flat_id'=>$user_flat_id));
				}
				
				
		}
		
		
	    //////////////notice  last 3///////////////// 
				// $date2= date("Y-m-d", strtotime($date2)); 
				//$dat1= strtotime($date2);
/*		$this->loadmodel("journal");
		$result_journal=$this->journal->find('all');
		foreach($result_journal as $data){
			$auto_id=(int)$data['journal']['journal_id'];
			 echo $current_date=$data['journal']['current_date'];
			//echo $date2= date("d-m-Y",$current_date); 
			
			echo"<br/>";
		}
		exit;
	$this->loadmodel("financial_year");
	$result_financial_years=$this->financial_year->find('all');
		foreach($result_financial_years as $data){
				$auto_id=(int)$data['financial_year']['auto_id'];
				$from=$data['financial_year']['from'];
				$to=$data['financial_year']['to'];
				$from1=date('Y-m-d',$from->sec) ;
				$to1=date('Y-m-d',$to->sec) ;
				$from2=strtotime($from1);
				$to2=strtotime($to1);
//$date2= date("d-m-y", strtotime($date)); 
				// $date2= date("Y-m-d", strtotime($date2)); 
				//$dat1= strtotime($date2);
			$this->financial_year->updateAll(array('from'=>$from2,'to'=>$to2),array('auto_id'=>$auto_id));
		}  


	$this->loadmodel("user");
	$user_profile=$this->user->find('all');
		foreach($user_profile as $data){
			$user_id=(int)$data['user']['user_id'];
			$mobile=(string)$data['user']['mobile'];
			$this->user->updateAll(array('mobile'=>$mobile),array('user_id'=>$user_id));
		}
	*/
	
//replace comma in amount

  // $a = str_replace(',', '', $amount);
  
//////End
	/* $this->loadmodel("ledger_account");
	$result_ledger_account=$this->ledger_account->find('all');
	foreach($result_ledger_account as $data){
			$auto_id=(int)$data['ledger_account']['auto_id'];
			$group_id=(int)$data['ledger_account']['group_id'];
			$ledger_name=trim($data['ledger_account']['ledger_name']);
			$this->ledger_account->updateAll(array('auto_id'=>$auto_id,'group_id'=>$group_id,'ledger_name'=>$ledger_name),array('auto_id'=>$auto_id));
	}
	
	
	$this->loadmodel("ledger_account");
		$result_ledger_account=$this->ledger_account->find('all');
		foreach($result_ledger_account as $data){
				$auto_id=(int)$data['ledger_account']['auto_id'];
				$group_id=$data['ledger_account']['group_id']; 
				
				$this->loadmodel("ledger_account");
				$this->ledger_account->updateAll(array('group_id'=>(int)$group_id),array('auto_id'=>$auto_id));
    		}
		*/
		
	$this->loadmodel('test');
	//$this->test->saveAll(array('auto_id'=>3,'name'=>'raju','due_amount'=>2000,'pri_amount'=>9000));
	
	$this->set('result_test',$this->test->find('all'));
		
}
function reject_notification($id,$change)
{
	if($change==1)
	{
	$this->loadmodel('notice');
	$this->notice->updateAll(array('n_draft_id'=>6),array('notice_id'=>$id));
	}
	if($change==2)
	{
	$this->loadmodel('discussion_post');
	$this->discussion_post->updateAll(array('delete_id'=>6),array('discussion_post_id'=>$id));
	}
	if($change==3)
	{
	$this->loadmodel('poll');
	$this->poll->updateAll(array('deleted'=>6),array('poll_id'=>$id));
	}
	if($change==4)
	{
		$this->loadmodel('resource');
		$this->resource->updateAll(array('resource_delete'=>6),array('resource_id'=>$id));

	}
	
}


function dashboard_old() 
{
if ($this->request->isAjax()){
        $this->layout = 'blank';
        $this->view = 'view_ajax'; //Other view that doesn't needs layout, only if necessary 
		}else{
		$this->layout='session';
		}
   
	

$this->ath();
$r=$this->request->query('try');
$s_user_id=$this->Session->read('user_id');
$s_society_id=$this->Session->read('society_id');

if(!empty($r))
{
$this->loadmodel('user');
$this->user->updateAll(array('profile_status'=>2),array('user_id'=>$s_user_id));
$this->redirect(array('action' => 'dashboard'));
}
$this->loadmodel('user');
$conditions=array("user_id" => $s_user_id);
$this->set('result_user',$this->user->find('all',array('conditions'=>$conditions))); 

//--------notice view------------//
$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$wing=$this->Session->read('wing');

$current_date = new MongoDate(strtotime(date("Y-m-d")));

$this->loadmodel('notice');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'visible' =>1,'sub_visible' =>array('$in' => array($tenant)),'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'visible' =>2,'sub_visible' =>array('$in' => array($role_id)),'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'visible' =>3,'sub_visible' =>array('$in' => array($wing)),'n_expire_date' => array('$gte'=>$current_date))
));
$order=array('notice.notice_id'=>'DESC');
$this->set('result_notice_visible',$this->notice->find('all', array('conditions' => $conditions,'order' => $order,'limit'=>5)));
//--------notice view end------------//



//--------notice view------------//
$this->loadmodel('event');
$conditions=array("society_id" => $s_society_id,"visible_user_id" =>array('$in' => array($s_user_id)));
$order=array('event.event_id'=>'DESC');
$this->set('result_event',$this->event->find('all', array('conditions' => $conditions,'order' => $order)));
//--------notice view end------------//

//--------notice view------------//
$this->loadmodel('discussion_post');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>1),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>4),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>5)
));
$order=array('discussion_post.discussion_post_id'=>'DESC');
$this->set('result_discussion_last',$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>5)));
//--------notice view end------------//


//help_desk//
$this->loadmodel('help_desk');
$conditions=array("society_id" => $s_society_id,"user_id" => $s_user_id);
$order=array('help_desk.ticket_id'=> 'DESC');
$result=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order,'limit' =>5));
$this->set('result_help_desk',$result);
//help_desk//

//polls//
$this->loadmodel('poll');
$conditions=array("society_id" => $s_society_id,"visible_user_id" =>array('$in' => array($s_user_id)));
$order=array('poll.poll_id'=>'DESC');
$this->set('result_poll',$this->poll->find('all', array('conditions' => $conditions,'order' => $order,'limit' =>5)));
//polls//

//resource//
$this->loadmodel('resource');
$conditions=array("resource_delete"=>0,"society_id"=>$s_society_id);
$result=$this->resource->find('all',array('conditions'=>$conditions,'limit' =>5));
$this->set('result_resource',$result);
//resource//

//event//
$this->loadmodel('event');
$conditions=array("society_id" => $s_society_id,"visible_user_id" =>array('$in' => array($s_user_id)));
$order=array('event.event_id'=>'DESC');
$this->set('result_event',$this->event->find('all', array('conditions' => $conditions,'order' => $order,'limit' =>5)));
//event//
}

//////////////////// Start notice Board ///////////////////////////////
function notice_category_name($category_id)
{

$this->loadmodel('master_notice_category');
$conditions=array("category_id" => $category_id);
$result_category=$this->master_notice_category->find('all',array('conditions'=>$conditions));
foreach ($result_category as $collection) 
{
return $notice_category_name=$collection['master_notice_category']['category_name'];
}

}

function notice_approval()
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
    $this->check_user_privilages();	
	$s_society_id=$this->Session->read('society_id'); 
	$this->loadmodel('notice');
	$conditions=array("n_draft_id" => 4, "n_delete_id" => 0,"society_id"=> $s_society_id);
	$order=array('notice_id'=>'DESC');
	$res_notice=$this->notice->find('all',array('conditions'=>$conditions,'order'=>$order));
	
	foreach($res_notice as $dda)
			{
				$id=(int)$dda['notice']['notice_id'];
				$this->seen_notification(2,$id);

			}

	$this->set('result_notice_publish',$res_notice);	

}

function notice_approval_ajax()
{
	$this->layout='blank';
	$id=(int)$this->request->query('con');
	$s_society_id=$this->Session->read('society_id'); 
	$ip=$this->hms_email_ip();
	$this->loadmodel('notice');
	$conditions=array('notice_id'=>$id);
	$result=$this->notice->find('all',array('conditions'=>$conditions));
	foreach($result as $data)
	{
		
		$category=$data['notice']['n_category_id'];
		$user_id=$data['notice']['user_id'];
		$sub=$data['notice']['n_subject'];
		$notice_subject=html_entity_decode($sub);
		$date=$data['notice']['n_date'];
		$visible=(int)$data['notice']['visible'];
		$sub_visible=$data['notice']['sub_visible'];
		$message=$data['notice']['n_message'];
		$file_name=$data['notice']['n_attachment'];
		if(!empty($file_name))
				{
				//@$file_att='<br/><a href="'.$ip.'/'.$this->webroot.'notice_file/'.$file_name.'" download>Download attachment</a><br/><br/>';
				}
		
		
		
		if($visible==1)
		{	
		$send='All Users'; 
		$visible=1;
		$sub_visible[]=0;
		/////////////////////////////////////////// All user ////////////////////////////
		$result_user= $this->all_user_deactive();
		foreach($result_user as $data)
		{
		$da_to[]=$data['user']['email'];
		$da_user_name[]=$data['user']['user_name'];
		$da_user_id[]=$data['user']['user_id'];
		}
		/////////////////////////////////////////// All user ////////////////////////////
		}
		if($visible==4)
		{	
		$send='All Owners';
		$visible=4;
		$sub_visible=1;
		/////////////////////////////////////////// All Owners ////////////////////////////

		$result_user=$this->all_owner_deactive();
		foreach($result_user as $data)
		{
		$da_to[]=$data['user']['email'];
		$da_user_name[]=$data['user']['user_name'];
		$da_user_id[]=$data['user']['user_id'];
		}
		/////////////////////////////////////////// All Owners ////////////////////////////
		}

		if($visible==5)
		{
		 $send='All Tenants'; 
		$visible=5;
		$sub_visible=2;
		/////////////////////////////////////////// All Tenant ////////////////////////////

		$result_user=$this->all_tenant_deactive();
		foreach($result_user as $data)
		{
		$da_to[]=$data['user']['email'];
		$da_user_name[]=$data['user']['user_name'];
		$da_user_id[]=$data['user']['user_id'];
		}
		/////////////////////////////////////////// All Tenant ////////////////////////////
		}


		if($visible==2)
		{
			$send='Roll Wise'; 			
		$visible=2;
		foreach ($sub_visible as $collection) 
		{
		$role_id=$collection;
		/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////

		$result_user=$this->all_role_wise_deactive($role_id);
		foreach($result_user as $data)
		{
		$da_to[]=$data['user']['email'];
		$da_user_name[]=$data['user']['user_name'];
		$da_user_id[]=$data['user']['user_id'];
		}

		//////////////////////////////// end mail ////////////////////////////////////////////////////////	

		}
		$da_to=array_unique($da_to);
		}



		if($visible==3)
		{
		$send='Wing Wise'; 
		$visible=3;
		foreach ($sub_visible as $collection) 
		{
		$wing_id=$collection;

		/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////

		$result_user=$this->all_wing_wise_deactive($wing_id);
		foreach($result_user as $data)
		{
		$da_to[]=$data['user']['email'];
		$da_user_name[]=$data['user']['user_name'];
		$da_user_id[]=$data['user']['user_id'];
		}

		//////////////////////////////// end mail ////////////////////////////////////////////////////////	

		}

		}
		
		 $da_to11=array_unique($da_user_id);

			$this->loadmodel('email');
			$conditions=array('auto_id'=>2);
			$result_email=$this->email->find('all',array('conditions'=>$conditions));
			foreach ($result_email as $collection) 
			{
			 $from=$collection['email']['from'];
			}
			$from_name="HousingMatters";
			$reply="donotreply@housingmatters.in";
			$category_name=$this->notice_category_name($category);
			$society_result=$this->society_name($s_society_id);
			foreach($society_result as $data)
			{
			  $society_name=$data['society']['society_name'];
			}
			for($k=0;$k<sizeof(@$da_to);$k++)
			{
			$to = @$da_to[$k];
			$d_user_id = @$da_user_id[$k];	 
			$user_name = @$da_user_name[$k];	

			
		/* $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td width="40%" style="padding: 10px 0px 0px 10px;"><img src="'.$ip.$this->webroot.'as/hm/hm-logo.png" style="max-height: 60px; " height="50px" width="150" /></td>
									<td width="60%" align="right" valign="middle"  style="padding: 7px 10px 0px 0px;">
									<a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/fb.png"></a>
									<a href="#" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/tw.png"></a>
									<a href=""><img src="'.$ip.$this->webroot.'as/hm/ln.png" class="test" style="margin-left:5px;"></a>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear  '.$user_name.' </span> <br>
										</td>
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> A new notice has been posted on your society Notice Board. </span>
									</td>
																
								</tr>
								
								
								<tr>
									<td>
									
										<table  cellpadding="5" cellspacing="0" width="100%;"border="1" style="border:1px solid #e5e5e5;">
						
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Date</td>
										<td align="left" style="background-color:#f8f8f8;font-size:12px;" >'.$date.'</td>
										</tr>
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Subject</td>
										<td align="left" style="background-color:#f8f8f8;font-size:12px;" >'.$sub.'</td>
										</tr>
										
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Category</td>
										<td align="left" style="background-color:#f8f8f8;font-size:12px;" >'.$category_name.'</td>
										</tr>
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Sent to</td>
										<td align="left" style="background-color:#f8f8f8;font-size:12px;" >'.$send.'</td>
										</tr>
									
										</table> 
									
									</td>
								
								
								
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<p style="font-size:16px;"> <strong>Notice Description:</strong></p>
										<p align="justify">'.$message.'</p>
										</td>
								</tr>
					
								<tr>
										<td style="padding:5px;" width="100%" align="center">
										<span style="color:rgb(100,100,99)">To view / respond <a href="'.$ip.$this->webroot.'" style="width:100px; height:30px;"><span style="background-color:#00A0E3;color:white;"><button style="width:100px; height:30px;  background-color:#00A0E3;color:white" id="bg_color_m"> Click Here </button> </span></a> </span>
										</td>
								</tr>
					

								<tr>
								<td style="font-size:12px;" width="100%" align="left">
								<P align="justify">For any software related queries, please contact <span style="color:#00A0E3;"> support@housingmatters.in </span></p>
								<p align="justify">	www.housingmatters.co.in </p>
								</td>
								</tr>

					
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
*/

	  $message_web='<div style="margin:0;padding:0" dir="ltr" bgcolor="#ffffff"><div class="adM">
	</div><table style="border-collapse:collapse" border="0" cellpadding="0" cellspacing="0" width="100%;">
		<tbody>
			<tr>
				<td style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;background:#ffffff">
					<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
						<tbody>
							<tr>
								<td style="line-height:20px" colspan="3" height="20">&nbsp;</td>
							</tr>
							<tr>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td>
								<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
								<tbody>
								<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								<tr>
								<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150cd117ec15fdb9_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td width="100%"><a href="#150cd117ec15fdb9_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
								<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
									
								</td>
								</tr>
								<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								</tbody>
								</table>
								</td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
							</tr>
							<tr>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="line-height:28px" height="28">&nbsp;</td></tr><tr><td><span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:16px;line-height:21px;color:#141823">Hello  '.$user_name.'<br>A new notice has been posted on your society Notice Board.</span></td></tr><tr><td style="line-height:14px" height="14">&nbsp;</td></tr><tr><td><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;border:solid 1px #e5e5e5;border-radius:2px;display:block"><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="padding:5px 10px;background:#269abc;border-top:#cccccc 1px solid;border-bottom:#cccccc 1px solid"><span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:16px;line-height:19px;color:#fff">'.$sub.'</span></td></tr><tr>
								<td style="padding:5px">
								
								<table style="border-collapse:collapse" cellpadding="0" cellspacing="0">
									<tr>
										<td>
										<span style="color:#adabab;font-size:12px">Category : '.$category_name.'  </span>
										</td>
										<td>&nbsp;&nbsp;|&nbsp;&nbsp;</td>
										<td>
										<span style="color:#adabab;font-size:12px">Sent to : '.$send.'  </span>
										</td>
										<td>&nbsp;&nbsp;|&nbsp;&nbsp;</td>
										<td>
										<span style="color:#adabab;font-size:12px">Date :'.$date.'</span>
										</td>
										<td></td>
									</tr>
								</table>
								</td>
							</tr>
							<tr>
								<td style="padding:5px" height="10">'.$message.'</td>
							</tr>
						</tbody>
					</table></td></tr></tbody></table></td></tr><tr><td style="line-height:14px" height="14">&nbsp;</td></tr></tbody></table></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
</tr>						<tr>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td>
									<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="line-height:2px" colspan="3" height="2">&nbsp;</td></tr><tr><td><a href="#150cd117ec15fdb9_" style="color:#3b5998;text-decoration:none"><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="border-collapse:collapse;border-radius:2px;text-align:center;display:block;border:1px solid #026a9e;background:#008ed5;padding:7px 16px 11px 16px"><a href="'.$ip.$this->webroot.'Notices/notice_publish_view/'.$id.'" style="color:#3b5998;text-decoration:none;display:block" target="_blank"><center><font size="3"><span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;white-space:nowrap;font-weight:bold;vertical-align:middle;color:#ffffff;font-size:14px;line-height:14px">View on HousingMatters</span></font></center></a></td></tr></tbody></table></a></td><td style="display:block;width:10px" width="10">&nbsp;&nbsp;&nbsp;</td><td><a href="#150cd117ec15fdb9_" style="color:#3b5998;text-decoration:none"><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr></tr></tbody></table></a></td><td width="100%"></td></tr><tr><td style="line-height:32px" colspan="3" height="32">&nbsp;</td></tr></tbody></table>
								</td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
							</tr>
							
						<tr>
								<td  width="15">&nbsp;&nbsp;&nbsp;</td>
						<td>
						<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
							<tbody>
								
								<tr>
								<td  align="left" valign="middle" width=""> 
								Thank you <br/>HousingMatters (Support Team)<br/>www.housingmatters.in
								
								</td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								
								
								</tr>
								
								</tbody>
						</table>
						</td>
								
					</tr>
							
							
							
						</tbody>
					</table>
				</td>
			</tr>
		</tbody>
	</table><div class="yj6qo"></div><div class="adL">
</div></div>';
			
			$this->loadmodel('notification_email');
			$conditions7=array("module_id" =>1,"user_id"=>$d_user_id,'chk_status'=>0);
			$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
			$n=sizeof($result5);
				if($n>0)
				{
				
					@$subject.= '['. $society_name . ']  - '.' New Notice : '.'     '.''.$notice_subject.'';
					$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
					$subject="";
				}	
	}
			
			
////////// Send Notification code start ///////////////////////////////////////







//////////// End code notification ////////////////////////////			
			
		$this->loadmodel('notice');
		$this->notice->updateAll(array('visible_user_id' => $da_to11,'n_draft_id'=>0),array('notice_id'=>$id));
		$this->response->header('location','notice_approval');
		
	}
	
	
}

function notice_approval_reject()
{
	$this->layout="blank";
	$n_id=(int)$this->request->query['con'];
	$this->loadmodel(notice);
	$this->notice->updateAll(array('n_draft_id'=>5),array('notice_id'=>$n_id));
	$this->response->header('location','notice_approval');
}



function notice_approval_view()
{
	
		if($this->RequestHandler->isAjax()){
		$this->layout='blank';
		}else{
		$this->layout='session';
		}
		$this->ath();
		 $n_id=(int)$this->request->query['con'];
		$this->set('n_id',$n_id);
		$this->loadmodel('notice');
		$conditions=array("notice_id" => $n_id);
		$this->set('result_view', $this->notice->find('all',array('conditions'=>$conditions)));
		$this->loadmodel('notice_board_reply');
		$conditions=array("notice_id" => $n_id);
		$this->set('result_reply',$this->notice_board_reply->find('all',array('conditions'=>$conditions)));

}


function create_notice() 
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();
$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id'); 
$this->loadmodel('master_notice_category');
$this->set('result1', $this->master_notice_category->find('all'));
$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('role_result',$role_result);
$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
$this->set('wing_result',$wing_result);
$s_user_id=$this->Session->read('user_id');
$date=date('d-m-Y');
$time = date(' h:i a', time());

$result=$this->society_name($s_society_id);
	foreach($result as $data)
	{
	@$notice=$data['society']['notice'];

	}
	if($notice==1 && $s_role_id!=3)
	{
		
		if(isset($this->request->data['publish']))
		{
			$category_id=(int)$this->request->data['notice_category'];
			$text=htmlentities($this->request->data['notice_subject']);
			$sub = wordwrap($text, 25, " ", true);
			$expire_date = new MongoDate(strtotime(date("Y-m-d", strtotime($this->request->data['notice_expire_date']))));
			 $message=$this->request->data['description'];
			$visible=(int)$this->request->data['visible'];
			$att=$this->request->form['file']['name'];
					if($visible==1)
					{	
					$visible=1;
					$sub_visible[]=0;
					}
					
					if($visible==4)
					{	
					$visible=4;
					$sub_visible=1;
					}
					
					if($visible==5)
					{
					$visible=5;
					$sub_visible=2;
					}
					
					if($visible==2)
					{	
						$visible=2;
						foreach ($role_result as $collection) 
						{
							$role_id=$collection["role"]["role_id"];

							$role_id=@(int)$this->request->data['role'.$role_id];
							if(!empty($role_id))
							{
							$sub_visible[]=(int)$role_id;
							}
						}
					}
					if($visible==3)
					{	
					 $visible=3;
						foreach ($wing_result as $collection) 
						{
							$wing_id=(int)$collection["wing"]["wing_id"];

							$wing=@(int)$this->request->data['wing'.$wing_id];
							if(!empty($wing))
							{
								$sub_visible[]=(int)$wing;
							}
						}
					}
					
						$target = "notice_file/";
						$target=@$target.basename( @$this->request->form['file']['name']);
						$ok=1;
						move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 
						$notice_id=$this->autoincrement('notice','notice_id');
						$this->loadmodel('notice');
						$this->notice->save(array('notice_id' => $notice_id, 'user_id' => $s_user_id, 'society_id' => $s_society_id, 'n_category_id' => $category_id ,'n_subject' => $sub , 'n_expire_date' => $expire_date, 'n_attachment' => $att , 'n_message' => $message,'n_date' => $date, 'n_time' => $time, 'n_delete_id' => 0,'n_draft_id' => 4,'visible' => $visible,'sub_visible' => $sub_visible));

					?>
                
				<!----alert-------------->
				<div class="modal-backdrop fade in"></div>
				<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
				<div class="modal-body" style="font-size:16px;">
				Notices are sent for approval
				</div> 
				<div class="modal-footer">
				<a href="create_notice" class="btn green">OK</a>
				</div>
				</div>
				<!----alert-------------->
				
                <?php		
			
					
					
			
		}
	}	
	else
	{
		
		
if(isset($this->request->data['publish']))
{
	@$ip=$this->hms_email_ip();
$category_id=(int)$this->request->data['notice_category'];
$text=htmlentities($this->request->data['notice_subject']);
$sub = wordwrap($text, 25, " ", true);
$expire_date = new MongoDate(strtotime(date("Y-m-d", strtotime($this->request->data['notice_expire_date']))));
$message=$this->request->data['description'];

$visible=(int)$this->request->data['visible'];
$att=$this->request->form['file']['name'];

if($visible==1)
{	
$visible=1;
$sub_visible[]=0;
/////////////////////////////////////////// All user ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_user_deactive();

foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}


/////////////////////////////////////////// All user ////////////////////////////
}

if($visible==4)
{	
$visible=4;
$sub_visible=1;
/////////////////////////////////////////// All Owners ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_owner_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Owners ////////////////////////////
}

if($visible==5)
{
$visible=5;
$sub_visible=2;
/////////////////////////////////////////// All Tenant ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_tenant_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Tenant ////////////////////////////
}


if($visible==2)
{	
$visible=2;
foreach ($role_result as $collection) 
{
$role_id=$collection["role"]["role_id"];

$role_id=@(int)$this->request->data['role'.$role_id];
if(!empty($role_id))
{
$sub_visible[]=(int)$role_id;

/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_role_wise_deactive($role_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	


}
}
$da_to=array_unique($da_to);
}

if($visible==3)
{	
$visible=3;
foreach ($wing_result as $collection) 
{
$wing_id=(int)$collection["wing"]["wing_id"];

$wing=@(int)$this->request->data['wing'.$wing_id];
if(!empty($wing))
{
$sub_visible[]=(int)$wing;
/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('wing'=>$wing_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_wing_wise_deactive($wing_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
//////////////////////////////// end mail ////////////////////////////////////////////////////////	

}
}

}


///////// creator send email code //////////////////

$result_user=$this->profile_picture($s_user_id);
foreach($result_user as $data)
{
	 $c_email=$data['user']['email'];
	 $c_user_id=$data['user']['user_id'];
	 $c_user_name=$data['user']['user_name'];
	
}
$da_to[]=$c_email;
$da_user_name[]=$c_user_name;
$da_user_id[]=$c_user_id;

$da_to=array_unique($da_to);
$da_user_name=array_unique($da_user_name);
$da_user_id=array_unique($da_user_id);

/////////////////////////  end code ////////////////////////////////


$da_to11=array_unique($da_user_id);

$target = "notice_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 
$notice_id=$this->autoincrement('notice','notice_id');
$this->loadmodel('notice');
$this->notice->save(array('notice_id' => $notice_id, 'user_id' => $s_user_id, 'society_id' => $s_society_id, 'n_category_id' => $category_id ,'n_subject' => $sub , 'n_expire_date' => $expire_date, 'n_attachment' => $att , 'n_message' => $message,'n_date' => $date, 'n_time' => $time, 'n_delete_id' => 0,'n_draft_id' => 0,'visible' => $visible,'sub_visible' => $sub_visible,'visible_user_id' => $da_to11 ));

////////////////////////////////////////////// Email Code Start ////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
$this->loadmodel('email');
$conditions=array('auto_id'=>2);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$from_name="HousingMatters";
$reply="donotreply@housingmatters.in";
$category_name=$this->notice_category_name($category_id);
$society_result=$this->society_name($s_society_id);
foreach($society_result as $data)
{
$society_name=$data['society']['society_name'];
}

if($visible==1)
{
$send='All Users'; 
}
if($visible==2)
{
$send='Roll Wise'; 
}
if($visible==3)
{
$send='Wing Wise'; 
}

if($visible==4)
{
$send='All Owners'; 
}

if($visible==5)
{
$send='All Tenants'; 
}

for($k=0;$k<sizeof(@$da_to);$k++)
{
$to = @$da_to[$k];
$d_user_id = @$da_user_id[$k];	 
$user_name = @$da_user_name[$k];	

 $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>

</br><p>Dear  $user_name,</p>
<p>A new notice has been posted on your society Notice Board.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>Date</td>
<td>Subject</td>
<td>Category</td>
<td>Sent to</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$date</td>
<td>$sub</td>
<td>$category_name</td>
<td>$send</td>
</tr>
</table>
<div>
<p style='font-size:16px;'> <strong>Notice Description:</strong></p>
<p style='font-size:15px;'>$message</p><br/><br/>
<center><p>To view / respond
<a href='$ip".$this->webroot."hms'><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'> Click Here </button></a></p></center><br/>
<br/>
<p>For any software related queries, please contact <span style='color:#00A0E3;'> support@housingmatters.in </span></p>
www.housingmatters.co.in
</div>
</div>";
$this->loadmodel('notification_email');
$conditions7=array("module_id" =>1,"user_id"=>$d_user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
$n=sizeof($result5);
if($n>0)
{
@$subject.= ''. $society_name . '' .' New Notice '.'     '.''.$sub.'';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}	
}



?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Notice has been Published.
</div> 
<div class="modal-footer">
<a href="notice_publish" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php	

}

		
		
}



if(isset($this->request->data['draft'])) 
{
$category_id=$this->request->data['notice_category'];
$text=htmlentities($this->request->data['notice_subject']);
$sub = wordwrap($text, 25, " ", true);
$expire_date = new MongoDate(strtotime(date("Y-m-d", strtotime($this->request->data['notice_expire_date']))));
$message=$this->request->data['description'];
$visible=(int)$this->request->data['visible'];
$att=$this->request->form['file']['name'];
if($visible==1)
{
$visible=1;
$sub_visible[]=0;
}
if($visible==4)
{
$visible=1;
$sub_visible=1;
}
if($visible==5)
{
$visible=1;
$sub_visible=2;
}
if($visible==2)
{	
$visible=2;
foreach ($role_result as $collection) 
{
$role_id=$collection["role"]["role_id"];

$role_id=@(int)$this->request->data['role'.$role_id];
if(!empty($role_id))
{
$sub_visible[]=(int)$role_id;
}
}

}



if($visible==3)
{	
$visible=3;
foreach ($wing_result as $collection) 
{
$wing_id=$collection["wing"]["wing_id"];
$wing=@(int)$this->request->data['wing'.$wing_id];
if(!empty($wing))
{
$sub_visible[]=(int)$wing;
}
}
}
$target = "notice_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 
$notice_id=$this->autoincrement('notice','notice_id');	
$this->loadmodel('notice');
$this->notice->save(array('notice_id' => $notice_id, 'user_id' => $s_user_id, 'society_id' => $s_society_id, 'n_category_id' => $category_id ,'n_subject' => $sub , 'n_expire_date' => $expire_date, 'n_attachment' => $att , 'n_message' => $message,'n_date' => $date, 'n_time' => $time, 'n_delete_id' => 0,'n_draft_id' => 1,'visible' => $visible,'sub_visible' => $sub_visible ));

?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Notice has been saved in Draft Folder.
</div> 
<div class="modal-footer">
<a href="notice_draft" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php
}


}


function notice_board() 
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();
$s_society_id=$this->Session->read('society_id');
$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$wing=$this->Session->read('wing');
$q=$this->request->query('con');
$cat=$this->decode($q,'housingmatters');
$this->set('blue_cat',$cat);
$current_date = new MongoDate(strtotime(date("Y-m-d")));

$this->loadmodel('master_notice_category');
$this->set('result1', $this->master_notice_category->find('all'));
$this->loadmodel('notice');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'visible' =>1,'n_draft_id' =>0,'n_delete_id' =>0,'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'visible' =>2,'n_draft_id' =>0,'n_delete_id' =>0,'sub_visible' =>array('$in' => array($role_id)),'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'visible' =>3,'n_draft_id' =>0,'n_delete_id' =>0,'sub_visible' =>array('$in' => array($wing)),'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'visible' =>4,'n_draft_id' =>0,'n_delete_id' =>0,'sub_visible' =>$tenant,'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'visible' =>5,'n_draft_id' =>0,'n_delete_id' =>0,'sub_visible' =>$tenant,'n_expire_date' => array('$gte'=>$current_date))
));

$order=array('notice.notice_id'=>'DESC');

$this->set('result_notice_visible',$this->notice->find('all', array('conditions' => $conditions,'order' => $order)));


if(!empty($cat))
{
	
$this->set('red_cat',$cat);
$this->loadmodel('notice');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>1,'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>2,'sub_visible' =>array('$in' => array($role_id)),'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>3,'sub_visible' =>array('$in' => array($wing)),'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>4,'sub_visible' =>$tenant,'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>5,'sub_visible' =>$tenant,'n_expire_date' => array('$gte'=>$current_date))
));
$order=array('notice.notice_id'=>'DESC');
$this->set('result_notice_visible',$this->notice->find('all', array('conditions' => $conditions,'order' => $order)));
}
}

function notice_from_visible_to_notice($notice_id) 
{
$this->loadmodel('notice');
$conditions=array("notice_id" => $notice_id,"n_draft_id" => 0);
return $result=$this->notice->find('all',array('conditions'=>$conditions));
}

function notice_board_view() 
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();

$n_id=(int)$this->request->query['con'];
$this->set('n_id',$n_id);

$this->seen_notification(2,$n_id);

$this->loadmodel('notice');
$conditions=array("notice_id" => $n_id);
$this->set('result_view', $this->notice->find('all',array('conditions'=>$conditions)));

$this->loadmodel('notice_board_reply');
$conditions=array("notice_id" => $n_id);
$this->set('result_reply',$this->notice_board_reply->find('all',array('conditions'=>$conditions)));
}

function notice_publish_view() 
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();


$n_id=(int)$this->request->query['con'];
$this->set('n_id',$n_id);

$this->seen_notification(2,$n_id);
$this->seen_alert(2,$n_id);

$this->loadmodel('notice');
$conditions=array("notice_id" => $n_id);
$this->set('result_view', $this->notice->find('all',array('conditions'=>$conditions)));

$this->loadmodel('notice_board_reply');
$conditions=array("notice_id" => $n_id);
$this->set('result_reply',$this->notice_board_reply->find('all',array('conditions'=>$conditions)));
}

function notice_save_reply()
{
		$this->layout='blank';
		$reply=htmlentities($this->request->query('reply'));
		$rep=explode(' ',$reply);
		$r=$this->content_moderation_society($rep);
		
		

$n_id=(int)$this->request->query('n_id');

$s_user_id=$this->Session->read('user_id');


$date=date("d-m-Y");
$time=date('h:i:a',time());

$t=$this->autoincrement('notice_board_reply','reply_id');
$this->loadmodel('notice_board_reply');
$multipleRowData = Array( Array("reply_id" => $t, "reply" => $reply , "notice_id" => $n_id, "date" => $date,"time" => $time,"class" => "outt","user_id"=>$s_user_id));

if($r==0)
		{
			echo'<span style="color:red;font-size:14px;">You have enter wrong word.</span>';
		}
		else
		{
			$this->notice_board_reply->saveAll($multipleRowData); 
			
		}
$this->loadmodel('notice_board_reply');
$conditions=array("notice_id" => $n_id);
$order=array('notice_board_reply.notice_id'=>'ASC');
$this->set('result_reply',$this->notice_board_reply->find('all',array('conditions'=>$conditions,'order'=>$order)));

}

function notice_draft() 
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();
$q=$this->request->query('con');
$cat=$this->decode($q,'housingmatters');
$this->set('blue_cat',$cat);
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('master_notice_category');
$this->set('result1', $this->master_notice_category->find('all'));
$this->loadmodel('notice');
$conditions=array("n_draft_id" => 1, "n_delete_id" => 0,"society_id"=> $s_society_id);
$this->set('result_notice_draft',$this->notice->find('all',array('conditions'=>$conditions)));
	if(!empty($cat))
	{
		$this->set('red_cat',$cat);	
		$this->loadmodel('notice');
		$conditions1=array('n_draft_id'=>1,'n_delete_id'=>0,'society_id'=>$s_society_id,'n_category_id'=>$cat);
		$result=$this->notice->find('all',array('conditions'=>$conditions1));
		$this->set('result_notice_draft',$result);
	}
	
}


function notice_edit() 
{
$this->layout='session';
$this->ath();
$s_society_id=$this->Session->read('society_id');
$notice_id=(int)$this->request->query['n'];
$this->set('notice_id',$notice_id);
$this->loadmodel('notice');
$conditions=array("notice_id" => $notice_id);
$result5= $this->notice->find('all',array('conditions'=>$conditions));
$this->set('result_notices',$result5); 
$this->loadmodel('master_notice_category');
$this->set('result1', $this->master_notice_category->find('all'));
$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('role_result',$role_result);
$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
$this->set('wing_result',$wing_result);

foreach($result5 as $data)
{
$visible=$data['notice']['visible'];
$sub_visible=$data['notice']['sub_visible'];
$attachment=$data['notice']['n_attachment'];
$date=$data['notice']['n_date'];

}
if(isset($this->request->data['publish_d'])) 
{
	
$ip=$this->hms_email_ip();
	
$category_id=(int)$this->request->data['notice_category'];
$text=htmlentities($this->request->data['notice_subject']);
$sub = wordwrap($text, 25, " ", true);
$expire_date = new MongoDate(strtotime(date("Y-m-d", strtotime($this->request->data['notice_expire_date']))));
$message=$this->request->data['Editor3'];
$notice_att=$this->request->form['file']['name'];

if(empty($notice_att))
{
$notice_att=$attachment;
}
$target = "notice_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 
$this->notice->updateAll(array('n_draft_id'=>0,'n_category_id' => $category_id ,'n_subject' => $sub , 'n_expire_date' => $expire_date,'n_attachment'=>$notice_att),array('notice.notice_id'=>$notice_id));

if($visible==1)
{
/////////////////////////////////////////// All User mail functionality conditions //////////////////////////////////////////////////////

//$this->loadmodel('user');
//$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_user_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
}
//////////////////////////////// end mail ////////////////////////////////////////////////////////		



if($visible==4)
{
/////////////////////////////////////////// All Owner mail functionality conditions //////////////////////////////////////////////////////

//$this->loadmodel('user');
//$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_owner_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
//////////////////////////////// end mail ////////////////////////////////////////////////////////		

}
if($visible==5)
{
/////////////////////////////////////////// All Tenant mail functionality conditions //////////////////////////////////////////////////////

//$this->loadmodel('user');
//$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_tenant_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
//////////////////////////////// end mail ////////////////////////////////////////////////////////		
}
if($visible==2)
{
foreach ($role_result as $collection) 
{
$role_id=$collection["role"]["role_id"];
if(in_array($role_id,$sub_visible))
{

/////////////////////////////////////////// All role  functionality  conditions //////////////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_role_wise_deactive($role_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	

}

}
$da_to=array_unique($da_to);

}
if($visible==3)
{
foreach ($wing_result as $collection) 
{
$wing_id=$collection["wing"]["wing_id"];
if(in_array($wing_id,$sub_visible))
{

/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('wing'=>$wing_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_wing_wise_deactive($wing_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
//////////////////////////////// end mail ////////////////////////////////////////////////////////	
}
}
}

////////////////////////////////////////////// Email Code Start ////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
$this->loadmodel('email');
$conditions=array('auto_id'=>2);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$from_name="HousingMatters";
$reply="donotreply@housingmatters.in";
$category_name=$this->notice_category_name($category_id);
$society_result=$this->society_name($s_society_id);
foreach($society_result as $data)
{
$society_name=$data['society']['society_name'];
}

if($visible==1)
{
$send='All Users'; 
}
if($visible==2)
{
$send='Roll Wise'; 
}
if($visible==3)
{
$send='Wing Wise'; 
}

if($visible==4)
{
$send='All Owners'; 
}

if($visible==5)
{
$send='All Tenants'; 
}
for($k=0;$k<sizeof(@$da_to);$k++)
{
$to = @$da_to[$k];
$d_user_id = @$da_user_id[$k];	 
$user_name = @$da_user_name[$k];	
$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear  $user_name,</p>
<p>A new notice has been posted on your society Notice Board.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>Date</td>
<td>Subject</td>
<td>Category</td>
<td>Sent to</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$date</td>
<td>$sub</td>
<td>$category_name</td>
<td>$send</td>
</tr>
</table>
<div>
<p style='font-size:16px;'> <strong>Notice Description:</strong></p>
<p style='font-size:15px;'>$message</p><br/><br/>
<center><p>To view / respond
<a href='$ip".$this->webroot."hms' ><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'> Click Here </button></a></p></center><br/>
<p>For any software related queries, please contact <span style='color:#00A0E3;'> support@housingmatters.in </span></p>
www.housingmatters.co.in
</div>
</div>"; 
$this->loadmodel('notification_email');
$conditions7=array("module_id" =>1,"user_id"=>$d_user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
$n=sizeof($result5);
if($n>0)
{
@$subject.= ''. $society_name . '' .' New Notice '.'     '.''.$sub.'';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}
}
?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Notice has been Published.
</div> 
<div class="modal-footer">
<a href="notice_publish" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php
}


}


function notice_visible_role_check($role_id,$notice_id) 
{
$s_society_id=$this->Session->read('society_id'); 


$this->loadmodel('notice_visible');
$conditions=array("notice_id" => $notice_id,"visible" => 2,"sub_visible" => $role_id);
return $this->notice_visible->find('count',array('conditions'=>$conditions));
}

function notice_visible_wing_check($wing_id,$notice_id) 
{
$s_society_id=$this->Session->read('society_id'); 


$this->loadmodel('notice_visible');
$conditions=array("notice_id" => $notice_id,"visible" => 3,"sub_visible" => $wing_id);
return $this->notice_visible->find('count',array('conditions'=>$conditions));
}


function notice_archive()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
//$this->layout='session';
$this->ath();
$this->check_user_privilages();	
$s_society_id=$this->Session->read('society_id');
$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$wing=$this->Session->read('wing');
$q=$this->request->query('con');
$cat=$this->decode($q,'housingmatters');
$this->set('blue_cat',$cat);
$current_date = new MongoDate(strtotime(date("Y-m-d")));
$this->loadmodel('master_notice_category');
$this->set('result1', $this->master_notice_category->find('all'));
$this->loadmodel('notice');
$conditions=array("n_draft_id" => 2, "n_delete_id" => 0,"society_id"=> $s_society_id);
$order=array('notice_id'=>'DESC');
$this->set('result_notice_publish',$this->notice->find('all',array('conditions'=>$conditions,'order'=>$order)));	
if(!empty($cat))
{
	$this->set('red_cat',$cat);	
	$conditions=array("n_draft_id" => 2, "n_delete_id" => 0,"society_id"=> $s_society_id,'n_category_id'=>(int)$cat);
	$order=array('notice.notice_id'=>'DESC');
	$this->set('result_notice_publish',$this->notice->find('all',array('conditions'=>$conditions,'order'=>$order)));
}
}


function notice_move_archive()
{
	$this->layout='blank';	
	$notice_id=(int)$this->request->query('con');
	$this->loadmodel('notice');
	$this->notice->updateAll(array('n_draft_id'=>2),array('notice_id'=>$notice_id));
	$this->response->header('location','notice_archive');
	
}


function notice_publish() 
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();
$q=$this->request->query('con');
$cat=$this->decode($q,'housingmatters');
$this->set('blue_cat',$cat);
$s_society_id=$this->Session->read('society_id');
$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$this->set('role_id',$role_id);
$wing=$this->Session->read('wing');
$current_date = new MongoDate(strtotime(date("Y-m-d")));
$this->loadmodel('master_notice_category');
$this->set('result1', $this->master_notice_category->find('all'));
if($role_id==3)
{
$this->loadmodel('notice');
$conditions=array("n_draft_id" => 0, "n_delete_id" => 0,"society_id"=> $s_society_id);
$order=array('notice_id'=>'DESC');
$res_notice=$this->notice->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set('result_notice_publish',$res_notice);
$current_date=date("d-m-Y");

foreach($res_notice as $data)
{
$notice_id=$data['notice']['notice_id'];
$n_expire_date=$data['notice']['n_expire_date'];
$n_expire_date= date('d-m-Y', $n_expire_date->sec);
	if(strtotime($n_expire_date) < strtotime($current_date))
	{
		$this->loadmodel('notice');
		$this->notice->updateAll(array('n_draft_id'=>2),array('notice_id'=>$notice_id));
	}
	
}



if(!empty($cat))
{
$this->set('red_cat',$cat);	
$conditions=array("n_draft_id" => 0, "n_delete_id" => 0,"society_id"=> $s_society_id,'n_category_id'=>(int)$cat);
$order=array('notice.notice_id'=>'DESC');
$this->set('result_notice_publish',$this->notice->find('all',array('conditions'=>$conditions,'order'=>$order)));
}
}
else
{
$this->loadmodel('notice');
$conditions =array( '$or' => array( 
array('n_draft_id' => 0,'society_id' =>$s_society_id,'visible' =>1,'n_expire_date' => array('$gte'=>$current_date)),
array('n_draft_id' => 0,'society_id' =>$s_society_id,'visible' =>2,'sub_visible' =>array('$in' => array($role_id)),'n_expire_date' => array('$gte'=>$current_date)),
array('n_draft_id' => 0,'society_id' =>$s_society_id,'visible' =>3,'sub_visible' =>array('$in' => array($wing)),'n_expire_date' => array('$gte'=>$current_date)),
array('n_draft_id' => 0,'society_id' =>$s_society_id,'visible' =>4,'sub_visible' =>$tenant,'n_expire_date' => array('$gte'=>$current_date)),
array('n_draft_id' => 0,'society_id' =>$s_society_id,'visible' =>5,'sub_visible' =>$tenant,'n_expire_date' => array('$gte'=>$current_date))
));
$order=array('notice.notice_id'=>'DESC');
$this->set('result_notice_publish',$this->notice->find('all', array('conditions' => $conditions,'order' => $order)));
if(!empty($cat))
{
$this->set('red_cat',$cat);
$this->loadmodel('notice');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>1,'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>2,'sub_visible' =>array('$in' => array($role_id)),'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>3,'sub_visible' =>array('$in' => array($wing)),'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>4,'sub_visible' =>$tenant,'n_expire_date' => array('$gte'=>$current_date)),
array('society_id' =>$s_society_id,'n_category_id'=>(int)$cat,'visible' =>5,'sub_visible' =>$tenant,'n_expire_date' => array('$gte'=>$current_date))
));
$order=array('notice.notice_id'=>'DESC');
$this->set('result_notice_publish',$this->notice->find('all', array('conditions' => $conditions,'order' => $order)));
}

}

}
///////////////////////////////// End Notice board ////////////////////////////////

/////////////////////////////Start of Event//////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////
function event_add()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$s_result= $this->society_name($s_society_id);
foreach($s_result as $data)
{
	
	$society_name=$data['society']['society_name'];
	
}
$date = new MongoDate(strtotime(date('Y-m-d')));



$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('role_result',$role_result);

$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
$this->set('wing_result',$wing_result);

$this->loadmodel('user');
$conditions=array("society_id"=>$s_society_id,'deactive'=>0);
$this->set('result_users',$this->user->find('all',array('conditions'=>$conditions))); 

if (isset($this->request->data['create_event'])) 
{
$e_name=htmlentities($this->request->data['e_name']);
$day_type=(int)$this->request->data['day_type'];
$ip=$this->hms_email_ip();
if($day_type==2)
{
$date_from1=$this->request->data['date_from'];
$date_from=date("Y-m-d",strtotime($date_from1));
$date_from = new MongoDate(strtotime($date_from));
$date_to1=$this->request->data['date_to'];
$date_to=date("Y-m-d",strtotime($date_to1));
$date_to = new MongoDate(strtotime($date_to));
$date_email="from $date_from1 to $date_to1";
}

if($day_type==1)
{
$date_from1=$this->request->data['date_single'];
$date_from=date("Y-m-d",strtotime($date_from1));
$date_from = new MongoDate(strtotime($date_from));

$date_to1=$this->request->data['date_single'];
$date_to=date("Y-m-d",strtotime($date_to1));
$date_to = new MongoDate(strtotime($date_to));
$date_email="on $date_to1";
}




$location=htmlentities($this->request->data['location']);
$description=htmlentities($this->request->data['description']);
$visible=(int)$this->request->data['visible'];

if($visible==1)
{	
$visible=1;
$sub_visible[]=0;
/////////////////////////////////////////// All user ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_user_deactive();
foreach($result_user as $data)
{
$visible_user_id[]=$data['user']['user_id'];
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
}
/////////////////////////////////////////// All user ////////////////////////////
}

if($visible==4)
{	
$visible=4;
$sub_visible[]=0;
/////////////////////////////////////////// All Owners ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_owner_deactive();
foreach($result_user as $data)
{
$visible_user_id[]=$data['user']['user_id'];
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
}
/////////////////////////////////////////// All Owners ////////////////////////////
}

if($visible==5)
{
$visible=5;
$sub_visible[]=0;
/////////////////////////////////////////// All Tenant ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_tenant_deactive();
foreach($result_user as $data)
{
$visible_user_id[]=$data['user']['user_id'];
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
}
/////////////////////////////////////////// All Tenant ////////////////////////////
}


if($visible==2)
{
$visible=2;
foreach ($role_result as $collection) 
{
$role_id=$collection["role"]["role_id"];

$role_id=@(int)$this->request->data['role'.$role_id];
if(!empty($role_id))
{
$sub_visible[]=(int)$role_id;

/////////////////////////////////////////// Role Wise ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_role_wise_deactive($role_id);
foreach($result_user as $data)
{
$visible_user_id[]=$data['user']['user_id'];
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
}
/////////////////////////////////////////// Role Wise ////////////////////////////
}
}

}

if($visible==3)
{	
$visible=3;
foreach ($wing_result as $collection) 
{
$wing_id=$collection["wing"]["wing_id"];

$wing=@(int)$this->request->data['wing'.$wing_id];
if(!empty($wing))
{
$sub_visible[]=(int)$wing;

/////////////////////////////////////////// Wing Wise ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('wing'=>$wing,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_wing_wise_deactive($wing);
foreach($result_user as $data)
{
$visible_user_id[]=$data['user']['user_id'];
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
}
/////////////////////////////////////////// Wing Wise ////////////////////////////
}
}

}



if($visible==6)
{	
$visible=6;
$sub_visible[]=0;
/////////////////////////////////////////// Manually ////////////////////////////
$visible_user_id1=$this->request->data['multi'];
foreach($visible_user_id1 as $data_user)
{
	$d_u_id=(int)$data_user;
	$res_user=$this->profile_picture($d_u_id);
	foreach($res_user as $ddd)
	{
		$da_to[]=$ddd['user']['email'];
		$da_user_name[]=$ddd['user']['user_name'];
	}
	
  $visible_user_id[]=(int)$data_user;
}
/////////////////////////////////////////// Manually ////////////////////////////
}


///////// creator send email code //////////////////

$result_user=$this->profile_picture($s_user_id);
foreach($result_user as $data)
{
	 $c_email=$data['user']['email'];
	 $c_user_id=$data['user']['user_id'];
	 $c_user_name=$data['user']['user_name'];
	
}
$da_to[]=$c_email;
$da_user_name[]=$c_user_name;
$visible_user_id[]=$c_user_id;

$da_to=array_unique($da_to);
$da_user_name=array_unique($da_user_name);
$visible_user_id=array_unique($visible_user_id);

/////////////////////////  end code ////////////////////////////////

////////////////// Email Functionality code ////////////////////////

$from="Support@housingmatters.in";
$reply="Support@housingmatters.in";
$from_name="HousingMatters";
for($k=0;$k<sizeof($da_to);$k++)
{
$to = @$da_to[$k];
//$d_user_id = @$da_user_id[$k];	 
$user_name = @$da_user_name[$k];	

$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Hello $user_name </p>
<p>A new event has been created.</p>
<p><span>$e_name</span></p>
<p><span>$date_email</span></p>
<p><span>$location</span></p>
<div>
<br/>
<br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div>
</div>";
 @$subject.= ''. $society_name . '  ' .'     '.' '.$e_name.'';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";



}



////////////////// End Email code ////////////////////////////////////

$visible_user_id = array_unique($visible_user_id);

ksort($visible_user_id);
foreach($visible_user_id as $x=>$x_value)
{
$visible_user_id_new[]=$x_value;
}

$event_id=$this->autoincrement('event','event_id');
$this->loadmodel('event');
$this->event->saveAll(array('event_id' => $event_id,'e_name' => $e_name, 'user_id' => $s_user_id, 'society_id' => $s_society_id, 'date_from' => $date_from , 'date_to' => $date_to, 'day_type' => $day_type, 'location' => $location,'description' => $description,'visible' => $visible,'sub_visible' => $sub_visible,'visible_user_id' => $visible_user_id_new,'date' => $date));


?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Event has been created.
</div> 
<div class="modal-footer">
<a href="events" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php


}

}

function calendar()
{
$this->layout='blank';

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$m_y=@$this->request->query('m_y');
if(empty($m_y))
{ 
$m_y = date('m-Y');
}


$m_y_ex=explode('-',$m_y);
$m=$m_y_ex[0];
$y=$m_y_ex[1];

/////////////////
$start='1-'.$m_y;
$start = date("Y-m-d", strtotime($start));
$start = new MongoDate(strtotime($start));

$days_in_month = cal_days_in_month(CAL_GREGORIAN, $m, $y);

$end=$days_in_month.'-'.$m_y;
$end = date("Y-m-d", strtotime($end));
$end = new MongoDate(strtotime($end));

$event_info=array();
$this->loadmodel('event');
$conditions=array('date_from' => array('$gte'=>$start,'$lte'=>$end));
$result_event_info=$this->event->find('all',array('conditions'=>$conditions));
foreach($result_event_info as $data)
{
$date_from = date("Y-m-d", $data['event']['date_from']->sec);
$date_to = date("Y-m-d", $data['event']['date_to']->sec);
$event_info[]=array($data['event']['event_id'],$data['event']['e_name'],$date_from,$date_to);
}
if(sizeof($event_info)==0) { $event_info=array(); }
$this->set('event_info',$event_info);
/////////////////



$dateObj   = DateTime::createFromFormat('!m', $m);
$month_name = $dateObj->format('F'); // March

$this->set('month',$m);
$this->set('month_name',$month_name);
$this->set('year',$y);

}

function check_event($e_date)
{
$this->layout='blank';

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('event');
$conditions=array("date_from" =>$e_date);
$result_event_info=$this->event->find('all');

return $result_event_info;
}

function events()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');


$this->loadmodel('event');
$conditions=array("society_id" => $s_society_id,"visible_user_id" =>array('$in' => array($s_user_id)));
$order=array('event.event_id'=>'DESC');
$this->set('result_event',$this->event->find('all', array('conditions' => $conditions,'order' => $order)));
}

function events_calendar()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();

}

function event_info()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
$this->ath();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->set('s_user_id',$s_user_id);

$e_id=(int)$this->request->query('e');
$this->set('e_id',$e_id);

$this->seen_notification(6,$e_id);
$this->seen_alert(6,$e_id);

if (isset($this->request->data['sub_update'])) 
{
	

$title=htmlentities($this->request->data['title']);
$title=wordwrap($title, 25, " ", true);
$title_cat=$this->request->data['title_cat'];
$title_des=htmlentities($this->request->data['description']);


$this->loadmodel('event');
$conditions=array("event_id" => $e_id);
$event_result_update=$this->event->find('all', array('conditions' => $conditions));
$this->set('event_result_update',$event_result_update);
$update=@$event_result_update[0]['event']['updates'];
$e_name=@$event_result_update[0]['event']['e_name'];
$visible_user_id=@$event_result_update[0]['event']['visible_user_id'];

if(sizeof($update)==0)
{
$update[]=array("title"=>$title,"color"=>$title_cat,"des"=>$title_des);
}
else
{
$t=array("title"=>$title,"color"=>$title_cat,"des"=>$title_des);
array_push($update,$t);
}

//$updates=array("title"=>$title,"color"=>$title_cat,"des"=>$title_des);
$this->event->updateAll(array('updates'=>$update),array('event.event_id'=>$e_id));



}

if (isset($this->request->data['up_photo'])) 
{
$file=$this->request->form['file']['name'];


$file=$this->request->form['file']['name'];
if (!file_exists('event_file/event'.$e_id)) 
{
mkdir('event_file/event'.$e_id);
}
move_uploaded_file(@$this->request->form['file']['tmp_name'], "event_file/event".$e_id."/".$file);

$this->loadmodel('event');
$conditions=array("event_id" => $e_id);
$event_result_update=$this->event->find('all', array('conditions' => $conditions));
$this->set('event_result_update',$event_result_update);
$photo=@$event_result_update[0]['event']['photos'];

if(sizeof($photo)==0)
{
$photo[]=$file;
}
else
{
array_push($photo,$file);
}

$updates=array(array("title"=>"dfdgdf","color"=>"dfdgdf","des"=>"dfdgdf"));
$this->event->updateAll(array('photos'=>$photo),array('event.event_id'=>$e_id));

}

$this->loadmodel('event');
$conditions=array("event_id" => $e_id,"visible_user_id" => array('$in' => array($s_user_id)));
$result_event_detail=$this->event->find('all', array('conditions' => $conditions));
$this->set('result_event_detail',$result_event_detail);



}



function save_rsvp()
{
$this->layout='blank';

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$e=(int)$this->request->query('e');
$type=(int)$this->request->query('type');

	if($type==1)
	{
	$this->loadmodel('event');
	$conditions=array("event_id" => $e);
	$event_result=$this->event->find('all', array('conditions' => $conditions));
	$rsvp=@$event_result[0]['event']['rsvp'];
	if(sizeof($rsvp)==0)	{ $rsvp=array(); }
	
	if (!in_array($s_user_id, $rsvp))
	{
	
		if(sizeof($rsvp)==0)
		{
		$rsvp[]=$s_user_id;
		
		}
		else
		{
		$t=$s_user_id;
		array_push($rsvp,$t);
		}
		
		
		$this->event->updateAll(array('rsvp'=>$rsvp),array('event.event_id'=>$e));
	}
	echo "Thanks for voting.";
	}
	
	if($type==2)
	{
	$this->loadmodel('event');
	$conditions=array("event_id" => $e);
	$event_result=$this->event->find('all', array('conditions' => $conditions));
	@$not_in_rsvp=@$event_result[0]['event']['not_in_rsvp'];
	
	if(sizeof($not_in_rsvp)==0)	{ $not_in_rsvp=array(); }
	
	if (!in_array($s_user_id, $not_in_rsvp))
	{
	
		if(sizeof($not_in_rsvp)==0)
		{
		$not_in_rsvp[]=$s_user_id;
		
		}
		else
		{
		$t=$s_user_id;
		array_push($not_in_rsvp,$t);
		}
		
		
		$this->event->updateAll(array('not_in_rsvp'=>$not_in_rsvp),array('event.event_id'=>$e));
	}
	
	echo "Thanks for voting.";
	}
}


///////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////End of Event//////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////start of polls//////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////
function poll_add()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$s_role_id=$this->Session->read('role_id');



$this->loadmodel('master_notice_category');
$this->set('result1', $this->master_notice_category->find('all'));


$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('role_result',$role_result);

$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
$this->set('wing_result',$wing_result);

$this->loadmodel('user');
$conditions=array("society_id"=>$s_society_id);
$this->set('result_users',$this->user->find('all',array('conditions'=>$conditions))); 

$result_so=$this->society_name($s_society_id);
	foreach($result_so as $data)
	{
	  @$poll_society=$data['society']['poll'];
	}
	if($poll_society==1 && $s_role_id!=3 )
	{
		
		if (isset($this->request->data['create_poll'])) 
		{
			$question=htmlentities($this->request->data['question']);
			$question=wordwrap($question, 25, " ", true);
			$description=htmlentities($this->request->data['description']);
			$description=wordwrap($description, 25, " ", true);
			$poll_close_date=$this->request->data['poll_close_date'];
			$type=(int)$this->request->data['type'];
			$private=(int)@$this->request->data['private']; 
			if(empty($private)) { $private=0; }
			$choice_text_box=(int)$this->request->data['choice_text_box'];
			for($z=1;$z<=$choice_text_box;$z++)
			{
			$color=$this->rendom_color_new();
			$choice[]=array(htmlentities($this->request->data['choice'.$z]),$color);

			}
			$current_date = date('Y-m-d');
			$current_date = new MongoDate(strtotime($current_date));


			if(empty($poll_close_date)) 
			{ 
			$current_date_add=date('Y-m-d', strtotime(date('Y-m-d'). ' + 15 days'));
			$poll_close_date=$current_date_add;

			}
			$poll_close_date = date("Y-m-d", strtotime($poll_close_date));
			$close_date = new MongoDate(strtotime($poll_close_date));
			
			$file=$this->request->form['file']['name'];

			$target = "polls_file/";
			$target=@$target.basename( @$this->request->form['file']['name']);
			$ok=1;
			move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 


			$visible=(int)$this->request->data['visible'];
			
			if($visible==1)
			{	
			$visible=1;
			$sub_visible[]=0;
			}

			if($visible==4)
			{	
			$visible=4;
			$sub_visible=0;
			}

			if($visible==5)
			{
			$visible=5;
			$sub_visible=0;
			}
			if($visible==2)
					{	
						$visible=2;
						foreach ($role_result as $collection) 
						{
							$role_id=$collection["role"]["role_id"];

							$role_id=@(int)$this->request->data['role'.$role_id];
							if(!empty($role_id))
							{
							$sub_visible[]=(int)$role_id;
							}
						}
					}
					
					
					if($visible==3)
					{	
					 $visible=3;
						foreach ($wing_result as $collection) 
						{
							$wing_id=(int)$collection["wing"]["wing_id"];

							$wing=@(int)$this->request->data['wing'.$wing_id];
							if(!empty($wing))
							{
								$sub_visible[]=(int)$wing;
							}
						}
					}
					
					
					$poll_id=$this->autoincrement('poll','poll_id');
					$this->loadmodel('poll');
					$this->poll->saveAll(array('poll_id' => $poll_id,'question' => $question , 'des' => $description, 'type' => $type, 'choice' => $choice,'visible' => $visible,'sub_visible' => $sub_visible,'date' => $current_date,'close_date' => $close_date,'file' => $file,'society_id' => $s_society_id,'user_id' => $s_user_id,"deleted" => 4,"private" => $private));
				
				?>
		<!----alert-------------->
		<div class="modal-backdrop fade in"></div>
		<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
		<div class="modal-body" style="font-size:16px;">
		Polls are sent for approval.
		</div> 
		<div class="modal-footer">
		<a href="Polls" class="btn green">OK</a>
		</div>
		</div>
		<!----alert-------------->
		<?php

				
				
				
		}
	}
	else
	{
		
		if (isset($this->request->data['create_poll'])) 
		{
			$ip=$this->hms_email_ip();
		$question=htmlentities($this->request->data['question']);
		$question=wordwrap($question, 25, " ", true);
		$description=htmlentities($this->request->data['description']);
		$description=wordwrap($description, 25, " ", true);
		$poll_close_date=$this->request->data['poll_close_date'];
		$type=(int)$this->request->data['type'];
		$private=(int)@$this->request->data['private']; 
		if(empty($private)) { $private=0; }
		$choice_text_box=(int)$this->request->data['choice_text_box'];
		for($z=1;$z<=$choice_text_box;$z++)
		{
		$color=$this->rendom_color_new();
		$choice[]=array(htmlentities($this->request->data['choice'.$z]),$color);

		}
		$current_date = date('Y-m-d');
		$current_date = new MongoDate(strtotime($current_date));


		if(empty($poll_close_date)) 
		{ 
		$current_date_add=date('Y-m-d', strtotime(date('Y-m-d'). ' + 15 days'));
		$poll_close_date=$current_date_add;

		}
		$poll_close_date = date("Y-m-d", strtotime($poll_close_date));
		$close_date = new MongoDate(strtotime($poll_close_date));



		$s_message='Your Poll has been created.';

		$file=$this->request->form['file']['name'];

		$target = "polls_file/";
		$target=@$target.basename( @$this->request->form['file']['name']);
		$ok=1;
		move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 


		$visible=(int)$this->request->data['visible'];

		if($visible==1)
		{	
		$visible=1;
		$sub_visible[]=0;
		/////////////////////////////////////////// All user ////////////////////////////
		//$this->loadmodel('user');
		//$conditions=array('society_id'=>$s_society_id);
		//$result_user=$this->user->find('all',array('conditions'=>$conditions));
		$result_user=$this->all_user_deactive();
		foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}
		/////////////////////////////////////////// All user ////////////////////////////
		}

		if($visible==4)
		{	
		$visible=4;
		$sub_visible[]=0;
		/////////////////////////////////////////// All Owners ////////////////////////////
		//$this->loadmodel('user');
		//$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
		//$result_user=$this->user->find('all',array('conditions'=>$conditions));
		$result_user=$this->all_owner_deactive();
		foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}
		/////////////////////////////////////////// All Owners ////////////////////////////
		}

		if($visible==5)
		{
		$visible=5;
		$sub_visible[]=0;
		/////////////////////////////////////////// All Tenant ////////////////////////////
		//$this->loadmodel('user');
		//$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
		//$result_user=$this->user->find('all',array('conditions'=>$conditions));
		$result_user=$this->all_tenant_deactive();
		foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}
		/////////////////////////////////////////// All Tenant ////////////////////////////
		}


		if($visible==2)
		{
		$visible=2;
		foreach ($role_result as $collection) 
		{
		$role_id=$collection["role"]["role_id"];

		$role_id=@(int)$this->request->data['role'.$role_id];
		if(!empty($role_id))
		{
		$sub_visible[]=(int)$role_id;

		/////////////////////////////////////////// Role Wise ////////////////////////////
		//$this->loadmodel('user');
		//$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
		//$result_user=$this->user->find('all',array('conditions'=>$conditions));
		$result_user=$this->all_role_wise_deactive($role_id);
		foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}
		/////////////////////////////////////////// Role Wise ////////////////////////////
		}
		}

		}

		if($visible==3)
		{	
		$visible=3;
		foreach ($wing_result as $collection) 
		{
		$wing_id=$collection["wing"]["wing_id"];

		$wing=@(int)$this->request->data['wing'.$wing_id];
		if(!empty($wing))
		{
		$sub_visible[]=(int)$wing;

		/////////////////////////////////////////// Wing Wise ////////////////////////////
		//$this->loadmodel('user');
		//$conditions=array('wing'=>$wing,'society_id'=>$s_society_id);
		//$result_user=$this->user->find('all',array('conditions'=>$conditions));
		$result_user=$this->all_wing_wise_deactive($wing);
		foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}
		/////////////////////////////////////////// Wing Wise ////////////////////////////
		}
		}

		}


					///////// creator send email code //////////////////

					$result_user=$this->profile_picture($s_user_id);
					foreach($result_user as $data)
					{
					  $c_email=$data['user']['email'];
					
					}
					$visible_email[]=$c_email;
					
					/////////////////////////  end code ////////////////////////////////


		$visible_mobile = array_unique($visible_mobile);
		$visible_email = array_unique($visible_email);

		$visible_user_id = array_unique($visible_user_id);

		ksort($visible_user_id);
		foreach($visible_user_id as $x=>$x_value)
		{
		$visible_user_id_new[]=$x_value;
		}


		$poll_id=$this->autoincrement('poll','poll_id');
		$this->loadmodel('poll');
		$this->poll->saveAll(array('poll_id' => $poll_id,'question' => $question , 'des' => $description, 'type' => $type, 'choice' => $choice,'visible' => $visible,'sub_visible' => $sub_visible,'visible_user_id' => $visible_user_id_new,'date' => $current_date,'close_date' => $close_date,'file' => $file,'society_id' => $s_society_id,'user_id' => $s_user_id,"deleted" => 0,"private" => $private));




		$this->loadmodel('society');
		$conditions12=array('society_id'=>$s_society_id);
		$result12=$this->society->find('all',array('conditions'=>$conditions12));
		foreach($result12 as $data)
		{
			$s_name=$data['society']['society_name'];
		}
		$message_web="<div>
		<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
		<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
		<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
		</br>
		<p>A new poll has been created on your society poll booth.</p>

		<div style='border:solid 1px #ccc;padding:10px;'>
		<span style='color:#00A0E3;'>$question<span><br/>
		<span style='color:#000;font-size:12px;'>$description<span>
		<hr>";
		$message_web.="<ol Type='A' >";
		foreach($choice as $data)
		{
		$message_web.="<li ><span style='font-size:14px;'>".$data[0]."</span></li>";
		}
		$message_web.="</ol>";
		$message_web.="<center><p>To view / vote
		<a href='$ip".$this->webroot."hms' target='_blank'><button style='width:100px;height:30px;background-color:#00A0E3;color:white;'> Click Here </button></a></p></center>";
		$message_web.="</div>
		<br/>
		<br/>
		www.housingmatters.co.in
		</div >
		</div>";

		$reply="support@housingmatters.in";
		$subject="[".$s_name."]-".$question;
		$from_name="HousingMatters";
		$this->loadmodel('email');
		$conditions=array("auto_id" => 4);
		$result_email = $this->email->find('all',array('conditions'=>$conditions));
		foreach ($result_email as $collection) 
		{
		$from=$collection['email']['from'];
		}

		foreach($visible_email as $to)
		{
		  $this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
		}
		?>
		<!----alert-------------->
		<div class="modal-backdrop fade in"></div>
		<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
		<div class="modal-body" style="font-size:16px;">
		<?php echo $s_message; ?>
		</div> 
		<div class="modal-footer">
		<a href="Polls" class="btn green">OK</a>
		</div>
		</div>
		<!----alert-------------->
		<?php


		}
		
	}
	
}



function poll_approve_ajax()
{
	$this->layout="blank";	
	$s_society_id=$this->Session->read('society_id');
	 $poll_id=(int)$this->request->query('p_id');
	
	 $ip=$this->hms_email_ip();
	 $this->loadmodel('poll');
	$conditions=array('poll_id'=>$poll_id);
	$result=$this->poll->find('all',array('conditions'=>$conditions));
	
	foreach($result as $data)
	{
		 $user_id=$data['poll']['user_id'];
		 $visible=$data['poll']['visible'];
		 $sub_visible=$data['poll']['sub_visible'];
		 $question=$data['poll']['question'];
		 $choice=$data['poll']['choice'];
		 $description=$data['poll']['des'];
	}
	
	
if($visible==1)
{	
$visible=1;
$sub_visible[]=0;
/////////////////////////////////////////// All user ////////////////////////////
$result_user= $this->all_user_deactive();
foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}
/////////////////////////////////////////// All user ////////////////////////////
}

if($visible==4)
{	
$visible=4;
$sub_visible=1;
/////////////////////////////////////////// All Owners ////////////////////////////

$result_user=$this->all_owner_deactive();
foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}
/////////////////////////////////////////// All Owners ////////////////////////////
}

if($visible==5)
{
$visible=5;
$sub_visible=2;
/////////////////////////////////////////// All Tenant ////////////////////////////

$result_user=$this->all_tenant_deactive();
foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}
/////////////////////////////////////////// All Tenant ////////////////////////////
}


if($visible==2)
{	
$visible=2;
foreach ($sub_visible as $collection) 
{
$role_id=$collection;
/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////

$result_user=$this->all_role_wise_deactive($role_id);
foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	

}
$da_to=array_unique($da_to);
}



if($visible==3)
{	
$visible=3;
foreach ($sub_visible as $collection) 
{
$wing_id=$collection;

/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////

$result_user=$this->all_wing_wise_deactive($wing_id);
foreach($result_user as $data)
		{
		$visible_user_id[]=$data['user']['user_id'];
		$visible_mobile[]=$data['user']['mobile'];
		$visible_email[]=$data['user']['email'];
		
		}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	

}

}
	
$visible_user_id_new = array_unique($visible_user_id);	

/* $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br>
<p>A new poll has been created on your society poll booth.</p>

<div style='border:solid 1px #ccc;padding:10px;'>
<span style='color:#00A0E3;'>$question<span><br/>
<span style='color:#000;font-size:12px;'>$description<span>
<hr>";
$message_web.="<ol Type='A' >";
foreach($choice as $data)
{
$message_web.="<li ><span style='font-size:14px;'>".$data[0]."</span></li>";
}
$message_web.="</ol>";
$message_web.="<center><p>To view / vote
<a href='$ip".$this->webroot."hms' target='_blank'><button style='width:100px;height:30px;background-color:#00A0E3;color:white;'> Click Here </button></a></p></center>";
$message_web.="</div>
<br/>
<br/>
www.housingmatters.co.in
</div >
</div>";
*/

		 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> A new poll has been created on your society poll booth. </span>
									</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px; border: solid 1px #ccc;" width="100%">
										
										<span style="color:#00A0E3;">'.$question.'</span><br/>
										<p style="color:#000;font-size:12px;" align="justify">'.$description.'</p>
																			
										</td>
								
								
								</tr>
								
								<tr>
										<td style="padding:5px;border: solid 1px #ccc;" width="100%">';
											
										$message_web.="<ol Type='A' >";
										foreach($choice as $data)
										{
										$message_web.="<li ><span style='font-size:14px;'>".$data[0]."</span></li>";
										}
										$message_web.="</ol>";

																		
										$message_web.='</td>
								
								
								</tr>
								
								
								<tr>
										<td style="padding:10px;" width="100%" align="center">
										<a href="'.$ip.$this->webroot.'/Polls/polls" style="width: 100px; min-height: 30px; background-color: rgb(0, 142, 213); padding: 10px; font-family: Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif; white-space: nowrap; font-weight: bold; vertical-align: middle; font-size: 14px; line-height: 14px; color: rgb(255, 255, 255); border: 1px solid rgb(2, 106, 158); text-decoration: none;" target="_blank">view / vote on HousingMtters</a>
										</td>
								</tr>
					

								<tr>
								<td style="" width="100%" align="left">
								<p align="justify">	www.housingmatters.in </p>
								</td>
								</tr>

					
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

		$result1=$this->society_name($s_society_id);
		foreach($result1 as $data)
		{
			$s_name=$data['society']['society_name'];
			
		}
	  	$reply="donotreply@housingmatters.in";
		
		$subject="[".$s_name."]- New Poll: ".$question;
		$from_name="HousingMatters";
		$this->loadmodel('email');
		$conditions=array("auto_id" => 4);
		$result_email = $this->email->find('all',array('conditions'=>$conditions));
		foreach ($result_email as $collection) 
		{
		$from=$collection['email']['from'];
		}

		foreach($visible_email as $to)
		{
			if(!empty($to))
			{	
			  $this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
			}
		}
	
	////////////// notification code start ////////////////////
	
	
	

	
	//////// end notification code //////////////////////////
	
	
	
		$this->loadmodel('poll');
		$this->poll->updateAll(array("deleted" => 0,'visible_user_id' => $visible_user_id_new),array('poll_id'=>$poll_id));
		
}

function poll_approve_reject()
{
		$this->layout="blank";
		$poll_id=(int)$this->request->query("con");
		$this->loadmodel('poll');
		$this->poll->updateAll(array("deleted" => 5),array('poll_id'=>$poll_id));
		$this->response->header('location','poll_approve');
}

function poll_approve()
{
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}

	$this->check_user_privilages();
	$s_society_id=$this->Session->read('society_id');
	$s_user_id=$this->Session->read('user_id');
	$this->set('s_user_id',$s_user_id);
	$current_date=date("Y-m-d");
	$current_date = new MongoDate(strtotime($current_date));
	$this->loadmodel('poll');
	$conditions=array("society_id" => $s_society_id,"deleted" => 4,'close_date' => array('$gt' => $current_date));
	$order=array('poll.poll_id'=>'DESC');
	$result=$this->poll->find('all', array('conditions' => $conditions,'order' => $order));
			foreach($result as $dda)
			{
				$id=(int)$dda['poll']['poll_id'];
				$this->seen_notification(7,$id);

			}

	$this->set('result_poll',$result);
	
}



function polls()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();
//$this->seen_notification(1,$hd_id);
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->set('s_user_id',$s_user_id);

$current_date=date("Y-m-d");
$current_date = new MongoDate(strtotime($current_date));

$this->loadmodel('poll');
$conditions=array("society_id" => $s_society_id,"visible_user_id" =>array('$in' => array($s_user_id)),"deleted" => 0,'close_date' => array('$gt' => $current_date));
$order=array('poll.poll_id'=>'DESC');
$result_poll=$this->poll->find('all', array('conditions' => $conditions,'order' => $order));
$this->set('result_poll',$result_poll);

	foreach($result_poll as $poll)
	{
		$this->seen_alert(7,$poll["poll"]["poll_id"]);
	}
}

function my_polls()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->set('s_user_id',$s_user_id);

if (isset($this->request->data['edit_save'])) 
{
$p_id=(int)$this->request->data['poll_id'];
$poll_des=htmlentities($this->request->data['poll_des']);

$this->loadmodel('poll');
$this->poll->updateAll(array('des'=>$poll_des),array('poll.poll_id'=>$p_id));

}

if (isset($this->request->data['delete_save'])) 
{
$p_id=(int)$this->request->data['poll_id_d'];

$this->loadmodel('poll');
$this->poll->updateAll(array('deleted'=>1),array('poll.poll_id'=>$p_id));

}


$this->loadmodel('poll');
$conditions=array("user_id" => $s_user_id,"deleted" => 0);
$order=array('poll.poll_id'=>'DESC');
$this->set('result_poll',$this->poll->find('all', array('conditions' => $conditions,'order' => $order)));
}

function closed_polls()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->set('s_user_id',$s_user_id);

$current_date=date("Y-m-d");
$current_date = new MongoDate(strtotime($current_date));

$this->loadmodel('poll');
$conditions=array("society_id" => $s_society_id,"visible_user_id" =>array('$in' => array($s_user_id)),"deleted" => 0,'close_date' => array('$lt' => $current_date));
$order=array('poll.poll_id'=>'DESC');
$result_poll=$this->poll->find('all', array('conditions' => $conditions,'order' => $order));
$this->set('result_poll',$result_poll);


	foreach($result_poll as $poll)
	{
		$this->seen_alert(7,$poll["poll"]["poll_id"]);
	}
}

function polls_approve()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$this->ath();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->set('s_user_id',$s_user_id);


$this->loadmodel('poll');
$conditions=array("society_id" => $s_society_id,"approved" => 0,"deleted" => 0);
$order=array('poll.poll_id'=>'DESC');
$this->set('result_poll',$this->poll->find('all', array('conditions' => $conditions,'order' => $order)));
}

function poll_approve_reject_submit()
{
$this->layout='blank';
$this->ath();

$p_id=(int)$this->request->query('p_id');
$a_r=(int)$this->request->query('a_r');

if($a_r==1)
{	
$this->loadmodel('poll');
$this->poll->updateAll(array('approved'=>1),array('poll.poll_id'=>$p_id));
}

if($a_r==2)
{	
$comm=$this->request->query('comm');

$this->loadmodel('poll');
$this->poll->updateAll(array('approved'=>2,'reject_comm'=>$comm),array('poll.poll_id'=>$p_id));
echo $comm;
}

}

function poll_view()
{
$this->layout='blank';
$this->ath();

$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$p_id=(int)$this->request->query('id');

$this->loadmodel('poll');
$conditions=array("poll_id" => $p_id);
$this->set('result_poll_detail',$this->poll->find('all', array('conditions' => $conditions)));
}

function poll_save_vote()
{
$this->layout='blank';

$type=(int)$this->request->query('type');
$poll_id=(int)$this->request->query('poll_id');
$c_id=$this->request->query('c_id');

$s_user_id=$this->Session->read('user_id');
$this->set('s_user_id',$s_user_id);

if($type==1)
{
$c_id=(int)$c_id;

$this->loadmodel('poll');
$conditions=array("poll_id" => $poll_id);
$poll_vote=$this->poll->find('all', array('conditions' => $conditions));
$this->set('poll_vote',$poll_vote);
$vote=@$poll_vote[0]['poll']['result'];
if(sizeof($vote)==0)
{
$vote[]=array($s_user_id,$c_id);
}
else
{
$t=array($s_user_id,$c_id);
array_push($vote,$t);
}
$this->poll->updateAll(array('result'=>$vote),array('poll.poll_id'=>$poll_id));
}

if($type==2)
{
$choices_id=explode(",",$c_id);

$this->loadmodel('poll');
$conditions=array("poll_id" => $poll_id);
$poll_vote=$this->poll->find('all', array('conditions' => $conditions));
$this->set('poll_vote',$poll_vote);
$vote=@$poll_vote[0]['poll']['result'];

foreach($choices_id as $ch_id)
{
$ch_id=(int)$ch_id;
if(sizeof($vote)==0)
{
$vote[]=array($s_user_id,$ch_id);
}
else
{
$t=array($s_user_id,$ch_id);
array_push($vote,$t);
}
}

$this->poll->updateAll(array('result'=>$vote),array('poll.poll_id'=>$poll_id));
}
}

function poll_result_after_vote()
{
$this->layout='blank';

$type=(int)$this->request->query('type');
$poll_id=(int)$this->request->query('poll_id');
$c_id=(int)$this->request->query('c_id');

$s_user_id=$this->Session->read('user_id');
$this->set('s_user_id',$s_user_id);

$this->loadmodel('poll');
$conditions=array("poll_id" => $poll_id);
$poll_vote=$this->poll->find('all', array('conditions' => $conditions));
$this->set('poll_vote',$poll_vote);
}



function poll_edit()
{
$this->layout='blank';
$p_id=(int)$this->request->query('p_id');
$edit=(int)$this->request->query('edit');
$this->set('edit',$edit);
if($edit==1)
{
$des=$this->request->query('des');
$c_date=$this->request->query('c_date');

$c_date = date("Y-m-d", strtotime($c_date));
$c_date = new MongoDate(strtotime($c_date));

$this->loadmodel('poll');
$this->poll->updateAll(array('des'=>$des,'close_date'=>$c_date),array('poll.poll_id'=>$p_id));
}

if($edit==0)
{
$this->loadmodel('poll');
$conditions=array("poll_id" => $p_id);
$poll_result=$this->poll->find('all', array('conditions' => $conditions));
$this->set('poll_result',$poll_result);
}

}

function poll_delete()
{
$this->layout='blank';
$p_id=(int)$this->request->query('p_id');
$delete=(int)$this->request->query('delete');
$this->set('delete',$delete);
if($delete==1)
{


$this->loadmodel('poll');
$this->poll->updateAll(array('deleted'=>1),array('poll.poll_id'=>$p_id));
}

if($delete==0)
{
$this->set('poll_id',$p_id);
}

}


function resident_approve() 
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
//$this->check_user_privilages();
$society_id=(int)$this->Session->read('hm_society_id');
$user_id=(int)$this->Session->read('user_id');
$this->seen_notification(100,$user_id);

$this->loadmodel('user_temp');
$conditions=array("society_id"=>$society_id,"complete_signup"=>1,"reject"=>0,"role"=>2);
$result=$this->user_temp->find('all',array('conditions'=>$conditions));
$this->set('result_user_temp',$result);
}


function resident_approve_reply()
{
$this->layout='blank';
$subject=htmlentities($this->request->query('con1'));
$message=htmlentities($this->request->query('con2'));
$message=nl2br($message);
$to=htmlentities($this->request->query('con3'));
$user_id=(int)htmlentities($this->request->query('con4'));
$from_name="HousingMatters";
$from="Support@housingmatters.in";
$reply="Support@housingmatters.in";
$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

  $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)"> <p align="justify">'.$message.' </p> </span> 
										</td>
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
	



$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$this->loadmodel('user_temp');
$this->user_temp->updateAll(array('reply_mail'=>$message),array('user_temp.user_temp_id'=>$user_id));

}

function resident_approve_reject()
{
$this->layout='blank';
$email=$this->request->query('con');
$user_id=(int)$this->request->query('con1');
$this->loadmodel('user_temp');
$this->user_temp->updateAll(array('reject'=>1),array('user_temp.user_temp_id'=>$user_id));
$this->response->header('Location', 'resident_approve');


}


function resident_approve_mail() 
{
	$this->layout='blank';
	$user_temp_id=(int)$this->request->query('con');


// //////////////fetch data user_temp table  ////////////////////
$this->loadmodel('user_temp');
$conditions=array('user_temp_id'=>$user_temp_id);
$result_user_temp=$this->user_temp->find('all',array('conditions'=>$conditions));
foreach ($result_user_temp as $collection) 
{ 
$society_id=(int)$collection['user_temp']['society_id'];
$user_name=$collection['user_temp']['user_name'];
$date=$collection['user_temp']['date'];
$time=$collection['user_temp']['time'];
$mobile=$collection['user_temp']['mobile'];
$email=$collection['user_temp']['email'];
$wing=(int)$collection['user_temp']['wing'];
$flat=(int)$collection['user_temp']['flat'];
$committee=$collection['user_temp']['committee'];
$owner=$collection['user_temp']['owner'];
//$residing=(int)$collection['user_temp']['residing'];
 // @$login_id=(int)$collection['user_temp']['login_id'];
  //@$multiple_society=$collection['user_temp']['multiple_society'];
}
///////////end fetch data ////////////////////
if($owner == "yes"){ $type = "yes"; $role_new_id=3;	}else { $type = "no"; $role_new_id=4;  }

///// flat already exit checked code start ////////////////
$this->loadmodel('flat');
		$conditions=array("flat_id" =>$flat);
		$result_flat = $this->flat->find('all',array('conditions'=>$conditions));
		foreach($result_flat as $data_flat){
		 $flat_type = (int)$data_flat['flat']['noc_ch_tp'];	
		}
		
		if($flat_type == 1){
			if($owner == 'no'){
			 				   
				echo'<tr><td colspan="9">Flat is self Occupied.</td></tr>';
				exit;
			}
			
		}
		
		
$this->loadmodel('user_flat');
$conditions=array('flat'=>$flat,'society_id'=>$society_id,'exited'=>'no');
$result_user=$this->user_flat->find('all',array('conditions'=>$conditions));
$n5=sizeof($result_user);
if($n5==1){
	$tenant_database=$result_user[0]['user_flat']['owner'];
	if($tenant_database=='yes'){
		if($tenant_database==$owner){
			
			echo'<tr><td colspan="9">This flat is already exist owner.</td></tr>';
			exit;
		}
		
		
	}else{
		
		if($tenant_database==$owner){
			
			echo'<tr><td colspan="9">This flat is already exist tenant.</td></tr>';
			exit;
		}
		
		
		
	}
	
}
if($n5==2){
	echo'<tr><td colspan="9">This flat is already exist.</td></tr>';
			exit;
	
}

//////////////////////////////// end cod ///////////////////


$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

$random1=mt_rand(1000000000,9999999999);
$random2=mt_rand(1000000000,9999999999);
$random=$random1.$random2 ;

//////////////// insert data user table //////////////////////////
$this->loadmodel('user');
$i=$this->autoincrement('user','user_id');
$de_user_id=$this->encode($i,'housingmatters');
$random=$de_user_id.'/'.$random;



$this->user->saveAll(array('user_id' => $i, 'user_name' => $user_name,'email' => $email, 'mobile' => $mobile,  'society_id' => $society_id, 'date' => $date, 'time' => $time,'signup_random'=>$random,'active'=>'yes',"user_type"=>"member",'profile_pic'=>'blank.jpg'));

$this->loadmodel('user_role');
$auto_id=$this->autoincrement('user_role','auto_id');
$this->user_role->saveAll(array('auto_id' => $auto_id, 'user_id' => $i,'role_id' => $role_new_id,'default'=>'yes','society_id' => $society_id));
if($committee=="yes"){
	$auto_id=$this->autoincrement('user_role','auto_id');
	$this->user_role->saveAll(array('auto_id' => $auto_id, 'user_id' => $i,'role_id' => 2,'society_id' => $society_id));
}



$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>$society_id,'wing'=>$wing,'flat'=>$flat,'exited'=>'no','owner'=>$type));


//////////////// end insert code  //////////////////////////

///////////////  Insert code ledger Sub Accounts //////////////////////
if($owner=="yes"){
$this->loadmodel('ledger_sub_account');
$j=$this->autoincrement('ledger_sub_account','auto_id');
$this->ledger_sub_account->save(array('auto_id'=>$j,'ledger_id'=>34,'name'=>$user_name,'society_id' => $society_id,'user_flat_id'=>$user_flat_id,'exited'=>'no','user_id' => $i));
}
/////////////  End code ledger sub accounts //////////////////////////

///////////////////////////////////////////// approve mail functionality ///////////////////////////////////////

$to=$email;

  $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										
										  <p align=""> Dear '.$user_name.',</p>
										  <p align="">Congratulations! Welcome to HousingMatters...making life simpler for</p>
										  <p align="">managing your housing society affairs.</p>
										  <p align="">Your registration request has been successfully approved.</p>
										  <p align=""><a href="'.$ip.$this->webroot.'hms/send_sms_for_verify_mobile?q='.$random.'" style="width:100px; height:30px;">Click here</a> for one time verification of your mobile number and Login into HousingMatters </p>
										  <p align="">For any assistance, please email us on support@housingmatters.in</p>
										  <p align="">alternatively, feel free to get in touch via our online chat support.</p>
										 
										</td>
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
	
$subject="Welcome to HousingMatters";
$from_name="HousingMatters";
$reply="support@housingmatters.in";
$this->loadmodel('email');
$conditions=array('auto_id'=>4);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////Notification email user all checked code  //////////////////////////

$this->loadmodel('email');	
$conditions=array('notification_id'=>1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach($result_email as $data)
{
$auto_id = (int)$data['email']['auto_id'];
$this->loadmodel('notification_email');
$lo=$this->autoincrement('notification_email','notification_id');
$this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id , "user_id" => $i,'chk_status'=>0));
}

//////////////// End all checked code   //////////////////////////



//////////////// Remove entry user_temp table  //////////////////////////
$this->loadmodel('user_temp');
$conditions=array('user_temp_id'=>$user_temp_id);
$this->user_temp->deleteAll($conditions);
//$this->user_temp->deleteAll(array('user_temp.user_temp_id' => true), false);

//////////////// End Remove entry user_temp table  //////////////////////////

}


function resident_approve_resend_sms()
{
	
$this->layout='blank';
$user_temp_id=(int)$this->request->query('con');

$s_society_id=(int)$this->Session->read('hm_society_id');
$result_society=$this->society_name($s_society_id);
foreach($result_society as $dd)
{
  $society_name=$dd['society']['society_name'];
}

$s_n='';
$sco_na=$society_name;
$dd=explode(' ',$sco_na);
$first=$dd[0];
$two=@$dd[1];
$three=@$dd[2];
$s_n.=" $first $two $three ";

$this->loadmodel('user');
$conditions=array('user_id'=>$user_temp_id);
$result_user=$this->user->find('all',array('conditions'=>$conditions));
foreach($result_user as $data)
{
	 $mobile=$data['user']['mobile'];
	 $user_name=$data['user']['user_name'];
	
}
$user_name=$this->check_charecter_name($user_name);
$r_sms=$this->requestAction(array('controller'=>'Fns','action'=>'hms_sms_ip'));
$working_key=$r_sms->working_key;
$sms_sender=$r_sms->sms_sender; 
$sms_allow=(int)$r_sms->sms_allow; 
if($sms_allow==1){
$random=(string)mt_rand(1000,9999);
$sms="".$user_name.", Your housing society ".$s_n." has enrolled you in HousingMatters portal. Pls log into www.housingmatters.in One Time Password ".$random."";
$sms1=str_replace(" ", '+', $sms);
$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');

$this->loadmodel('user');
$this->user->updateAll(array('password'=>$random,'signup_random'=>$random),array('user_id'=>$user_temp_id)); 
 
}

}


function resident_approve_resend_mail() 
{
$this->layout='blank';
$user_temp_id=(int)$this->request->query('con');

$s_society_id=(int)$this->Session->read('hm_society_id');
// //////////////fetch data user_temp table  ////////////////////
$this->loadmodel('user');
$conditions=array('user_id'=>$user_temp_id);
$result_user_temp=$this->user->find('all',array('conditions'=>$conditions));
foreach ($result_user_temp as $collection) 
{ 
$society_id=(int)$collection['user']['society_id'];
$user_name=$collection['user']['user_name'];
$mobile=$collection['user']['mobile'];
$email=$collection['user']['email'];
$password=$collection['user']['password'];
//$wing=(int)$collection['user']['wing'];
//$flat=(int)$collection['user']['flat'];
//$tenant=(int)$collection['user']['tenant'];
//$residing=(int)$collection['user']['residing'];

}
///////////end fetch data ////////////////////

if(!empty($email) and !empty($mobile)){
		
	$page_name='send_sms_for_verify_mobile';		
	
}else{
	
	$page_name='set_new_password';
}




$random1=mt_rand(1000000000,9999999999);
$random2=mt_rand(1000000000,9999999999);
$random=$random1.$random2 ;

//////////////// insert data user table //////////////////////////

 $ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

$de_user_id=$this->encode($user_temp_id,'housingmatters');
$random=$de_user_id.'/'.$random;


$this->loadmodel('user');
$this->user->updateAll(array('signup_random'=>$random,'one_time_sms'=>0),array('user.user_id'=>$user_temp_id));



//////////////// end insert code  //////////////////////////

$this->loadmodel('society');
$conditions12=array('society_id'=>$s_society_id);
$result12=$this->society->find('all',array('conditions'=>$conditions12));
foreach($result12 as $data)
{
$s_name=$data['society']['society_name'];
}
///////////////////////////////////////////// approve mail functionality ///////////////////////////////////////
$special="'";
$to=$email;
 /* $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
<p style='color:green;'><strong>Reminder!</strong></p>
<p>Dear  $user_name,</p>
<p>'We at $s_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent &amp; smart management of housing society affairs.</p>
<p>As you are an owner/resident/staff of $s_name, we have added your email address in HousingMatters portal.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>

<li>log &amp; track complaints</li>
<li>start new discussions</li>
<li>check your maintenance dues</li>
<li>post classifieds</li>
<li>receive important SMS &amp; emails from your committee</li>
<li>and much more in the portal.</li>



<p><b><a href='$ip".$this->webroot."/hms/$page_name?q=$random' target='_blank'><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'>Click here</button></a> for one time verification of your mobile number and Login into HousingMatters  for making life simpler for all your housing matters!</b></p>


<p>Regards,</p>
<p>Administrator of $s_name</p>

<p>PS: add <a href='http://www.housingmatters.co.in' target='_blank'>www.housingmatters.co.in</a> in your favorite bookmarks for future use.</p>



</div >
</div>"; */


   $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
				
								
								<tr>
									<td colspan="2">
									<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
								<tbody>
								<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								<tr>
								<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td width="100%"><a href="#" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px" target="_blank"><span style="color:#00A0E3">Housing</span><span style="color:#777776">Matters</span></a></td>
								<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img  src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
									
								</td>
								</tr>
								<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								</tbody>
								</table>
									
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						

									<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> <p style="color:green;"><strong>Reminder!</strong></p> </span> 
										</td>
																
									</tr>
									<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Dear '.$user_name.', </span> 
										</td>
																
									</tr>

								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 '.$special.'We at '.$s_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$s_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
											<ul>
													<li>log &amp; track complaints</li>
													<li>start new discussions</li>
													<li>check your maintenance dues</li>
													<li>post classifieds</li>
													<li>receive important SMS &amp; emails from your committee</li>
													<li>and much more in the portal.</li>
											</ul>		
										</td>
																
								</tr>

									
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/'.$page_name.'?q='.$random.'" style="text-decoration:none;" > Click here </a> for one time verification of your mobile number and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$s_name.'<br/>
												PS: add <a href="http://www.housingmatters.in" target="_blank" style="text-decoration:none;">www.housingmatters.in</a> in your favorite bookmarks for future use.
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

$subject="[$s_name]";
$from_name="HousingMatters";
$reply="support@housingmatters.in";
$this->loadmodel('email');
$conditions=array('auto_id'=>4);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



}



function resend_email()
{
$this->layout='session';

$this->loadmodel('user');
$conditions=array('user.profile_status'=> array('$ne' => 2));
$this->set('result_not_login',$this->user->find('all',array('conditions'=>$conditions)));

}

function profile_email_verification_send($user_id=null,$email=null){
		$this->layout=null;		
	    $to=$email;
		$user_id=(int)$user_id;
		$this->loadmodel('user');
		$conditions=array('user_id'=>$user_id);
		$result_user=$this->user->find('all',array('conditions'=>$conditions));
		foreach($result_user as $data)
		{
		  $user_name=$data['user']['user_name'];
		  
		}
		$user_name=$this->check_charecter_name($user_name);
		$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));
		
		
		$random=(string)mt_rand(1000,9999);
		
		
		$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
				  <tbody>
					<tr>
						<td>
							<table width="100%" cellpadding="0" cellspacing="0">
								<tbody>
								
										<tr>
											<td colspan="2">
												<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
												<tbody>
												<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
												<tr>
												<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
												<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
												<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
												<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
													
												</td>
												</tr>
												<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
												</tbody>
												</table>
											</td>
										</tr>
																
										
								</tbody>
							</table>
							
							<table width="100%" cellpadding="0" cellspacing="0">
								<tbody>
								
										
										
										<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Hello '.$user_name.', </span> 
										</td>
																		
										</tr>
										
										
										<tr>
												<td style="padding:5px;" width="100%" align="left">
												<span style="color:rgb(100,100,99)" align="justify">This is to confirm that you are the secured user of this mail ID. Hence we have updated your mail address on HousingMatters. Here is the 4 digit otp code '.$random.' Kindly do not share												</span> 
												</td>
																		
										</tr>
										
										

										
										<tr>
											<td style="padding:5px;" width="100%" align="left">
													<span style="color:rgb(100,100,99)"> 
														Thank you.<br/>
														HousingMatters (Support Team)<br/>
														www.housingmatters.in
													</span>
											</td>
																		
										</tr>
							
							</table>
							
						</td>
					</tr>

				</tbody>
		</table>';
		
		 $from_name="HousingMatters";
		 $subject="Otp for email update";
		 $this->loadmodel('email');
		$conditions=array('auto_id'=>4);
		$result_email=$this->email->find('all',array('conditions'=>$conditions));
		foreach ($result_email as $collection){
			$from=$collection['email']['from'];
		}
		$reply=$from;
		$this->smtpmailer($to,$from,$from_name,$subject,$message_web,$reply);
		
		$this->loadmodel('user');
		$this->user->updateAll(array('signup_random'=>$random,'new_email'=>$email),array('user_id'=>$user_id)); 
		
		

}

function profile_mobile_verification_send($user_id=null,$mobile=null){
	$this->layout=null;		
	
		$user_id=(int)$user_id;
		
		$this->loadmodel('user');
		$conditions=array('user_id'=>$user_id);
		$result_user=$this->user->find('all',array('conditions'=>$conditions));
		foreach($result_user as $data)
		{
		  $user_name=$data['user']['user_name'];
			
		}
		$user_name=$this->check_charecter_name($user_name);
		$r_sms=$this->requestAction(array('controller'=>'Fns','action'=>'hms_sms_ip'));
		$working_key=$r_sms->working_key;
		$sms_sender=$r_sms->sms_sender; 
		$sms_allow=(int)$r_sms->sms_allow; 
		if($sms_allow==1){
		$random=(string)mt_rand(1000,9999);
		$sms="Your 4 digit random code is ".$random."";
		$sms1=str_replace(" ", '+', $sms);
		$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');

			$this->loadmodel('user');
			$this->user->updateAll(array('signup_random'=>$random,'new_mobile'=>$mobile),array('user_id'=>$user_id)); 
		 
		}

	
}

function profile_email_update($user_id=null,$otp_number=null){
$this->layout=null;		
$this->loadmodel('user');
$conditions=array("signup_random" => $otp_number,'user_id'=>(int)$user_id);
$result_user = $this->user->find('all',array('conditions'=>$conditions));
 $n4 = sizeof($result_user);
	if($n4>0){
		
		$new_email=$result_user[0]['user']['new_email'];
		$user_name=$result_user[0]['user']['user_name'];
		$email=$result_user[0]['user']['email'];
		$society_id=$result_user[0]['user']['society_id'];
		$mobile_old=$result_user[0]['user']['mobile'];
		date_default_timezone_set('Asia/Kolkata');
		$date=date("d-m-Y");
		$time = date(' h:i a', time());
		$op=$this->autoincrement('profile_log','profile_log_id');
		$this->loadmodel('profile_log');
		$this->profile_log->saveAll(array('profile_log_id'=>$op,'user_id'=>(int)$user_id,'society_id'=>$society_id,'email'=>$email,'mobile'=>$mobile_old,'new_email'=>$new_email,'new_mobile'=>'','date'=>$date,'time'=>$time,'user_name'=>$user_name,'new_user_name'=>''));
				
		$this->loadmodel('user');
		$this->user->updateAll(array("email"=>$new_email,"new_email"=>"","signup_random"=>""),array('user_id'=>(int)$user_id));
		
		echo"update";
	}else{

		echo"wrong";
	}	

	
}




function profile_mobile_update($user_id=null,$otp_number=null){
$this->layout=null;		
$this->loadmodel('user');
$conditions=array("signup_random" => $otp_number,'user_id'=>(int)$user_id);
$result_user = $this->user->find('all',array('conditions'=>$conditions));
 $n4 = sizeof($result_user);
	if($n4>0){
		
		$mobile=$result_user[0]['user']['new_mobile'];
		$user_name=$result_user[0]['user']['user_name'];
		$email=$result_user[0]['user']['email'];
		$society_id=$result_user[0]['user']['society_id'];
		$mobile_old=$result_user[0]['user']['mobile'];
		date_default_timezone_set('Asia/Kolkata');
		$date=date("d-m-Y");
		$time = date(' h:i a', time());
		$op=$this->autoincrement('profile_log','profile_log_id');
		$this->loadmodel('profile_log');
		$this->profile_log->saveAll(array('profile_log_id'=>$op,'user_id'=>(int)$user_id,'society_id'=>$society_id,'email'=>$email,'mobile'=>$mobile_old,'new_email'=>'','new_mobile'=>$mobile,'date'=>$date,'time'=>$time,'user_name'=>$user_name,'new_user_name'=>''));
				
		$this->loadmodel('user');
		$this->user->updateAll(array("mobile"=>$mobile,"new_mobile"=>"","signup_random"=>""),array('user_id'=>(int)$user_id));
		
		echo"update";
	}else{

		echo"wrong";
	}	

	
}

function profile_email_verification_already($user_id=null,$email=null){

$this->layout=null;	
$email=trim($email);

$this->loadmodel('user');
$conditions=array("email" => $email,'user_id'=>(int)$user_id);
$result4 = $this->user->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);
$e=$n4;
if ($e > 0) {
echo "true";
} else {
		$this->loadmodel('user_temp');
		$conditions=array("email" => $email,'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("email" => $email);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n4 = sizeof($result4);
		$e=$n3+$n4;

		if ($e > 0) {
		echo"false";
		} else {
		echo"true";
		}
	
}

	
	
	
}


function profile_mobile_verification_already($user_id=null,$mobile=null){
	
$this->layout=null;	

$this->loadmodel('user');
$conditions=array("mobile" => $mobile,'user_id'=>(int)$user_id);
$result4 = $this->user->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);
$e=$n4;
if ($e > 0) {
echo "true";
} else {
		$this->loadmodel('user_temp');
		$conditions=array("mobile" => $mobile,'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("mobile" => $mobile);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n4 = sizeof($result4);
		$e=$n3+$n4;

		if ($e > 0) {
		echo"false";
		} else {
		echo"true";
		}
	
}


	
}

function profile_email_verification($user_id=null){
	$this->layout=null;	
	
	$this->loadmodel('user');
	$conditions=array('user_id'=>(int)$user_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	$email=$result_user[0]['user']['email'];
	$this->set('email',$email);
	$this->set('user_id',$user_id);	
	
	
}

function profile_mobile_verification($user_id=null){
	$this->layout=null;	
	
	$this->loadmodel('user');
	$conditions=array('user_id'=>(int)$user_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	$mobile=$result_user[0]['user']['mobile'];
	$this->set('mobile',$mobile);
	$this->set('user_id',$user_id);
	
}

function verification_member_profile(){

$this->layout='without_session';
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);

$q=$this->request->query['q'];
$user_id=(int)$this->decode($q,'housingmatters');
$this->loadmodel('user');
$conditions=array('signup_random'=>$user_id);
$result_check=$this->user->find('all',array('conditions'=>$conditions));
$n= sizeof($result_check);
if($n>0){ 

		$new_email= $result_check[0]['user']['new_email'];
		$email= $result_check[0]['user']['email'];
		$mobile= $result_check[0]['user']['mobile'];
		$society_id= @$result_check[0]['user']['society_id'];

		date_default_timezone_set('Asia/Kolkata');
		$date=date("d-m-Y");
		$time = date(' h:i a', time());
		$op=$this->autoincrement('profile_log','profile_log_id');
		$this->loadmodel('profile_log');
		$this->profile_log->saveAll(array('profile_log_id'=>$op,'user_id'=>$user_id,'society_id'=>$society_id,'email'=>$email,'mobile'=>$mobile,'new_email'=>$new_email,'new_mobile'=>'','date'=>$date,'time'=>$time));

	$this->loadmodel('user');
	$this->user->updateAll(array('signup_random'=>'','new_email'=>'','email'=>$new_email),array('user.user_id'=>$user_id));

}
else
{
echo "Sorry, you have used this link.This link is one time login link.";	
exit;
}
}	

function set_new_password()
{


$this->layout='without_session';
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);
 $q=$this->request->query['q'];

$q_new=explode('/',$q);
$q_new[0];

$user_id=(int)$this->decode($q_new[0],'housingmatters');
$randm=$q_new[1];


		$result_user=$this->profile_picture($user_id);
		$tenant=@$result_user[0]['user']['tenant'];
		$old_password=@$result_user[0]['user']['password'];
		$society_id=@$result_user[0]['user']['society_id'];
		$result_society=$this->society_name($society_id);
		$access_tenant=@$result_society[0]['society']['access_tenant'];

		if($tenant==2 && $access_tenant==0){
			$this->redirect(array('action' => 'tenant_access'));

		 }

$this->loadmodel('user');
$conditions =array( '$or' => array( 
array('user_id'=> $user_id,'signup_random'=>$q),
array('user_id'=> $user_id,'signup_random'=>$randm),
array('user_id'=> $user_id,'password'=>$old_password),
));
$result_check=$this->user->find('all',array('conditions'=>$conditions));
$n= sizeof($result_check);

if($n>0)
{ 

}
else
{
echo "Sorry, you have used this link.This link is one time login link.";	
exit;
}

if($this->request->is('POST')) 
{
$pass=$this->request->data['pass'];
$pass=htmlentities($pass);

$this->loadmodel('user');
$conditions=array('user_id'=> $user_id); 
$result_user=$this->user->find('all',array('conditions'=>$conditions));
$n= sizeof($result_user);
if($n>0)
{ 
foreach ($result_user as $collection) 
{
$user_id=$collection['user']["user_id"];
$society_id=@$collection['user']["society_id"];
$user_name=$collection['user']["user_name"];
$user_type=$collection['user']["user_type"];
}
$user_flat_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'), array('pass' => array($user_id)));
	$user_flat_id=$user_flat_info[0]["user_flat"]["user_flat_id"]; 
	
	if($user_type=="third_party" or $user_type=="member" or $user_type=="family_member"){
					
		$role_id=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_role_via_user_id'), array('pass' => array($user_id)));
		$this->Session->write('role_id', $role_id);
	   }
	
	$this->Session->write('hm_user_id', $user_id);
	$this->Session->write('hm_user_flat_id', $user_flat_id);
	$this->Session->write('hm_society_id', $society_id);
$this->loadmodel('user');
$this->user->updateAll(array('password'=>$pass,'signup_random'=>'','validation_status'=>'done','verify_set_new_password'=>1),array('user.user_id'=>$user_id));
$this->redirect(array('action' => 'dashboard'));
}

}

}





function verify_email()
{
$var=1;	
$this->layout='without_session';
@$q=$this->request->query['q'];
$q_new=explode('/',$q);
$q_new[0];
$user_id=(int)$this->decode($q_new[0],'housingmatters');
$randm=$q_new[1];
$this->loadmodel('user');
$conditions=array('user_id'=> $user_id); 
$result_user=$this->user->find('all',array('conditions'=>$conditions));
foreach ($result_user as $collection) 
{
$email=$collection['user']["email"];
}
$this->set('email',$email);


if (isset($this->request->data['login'])) 
{
	$ip=$this->hms_email_ip();
$var=2;
$captch=htmlentities($this->request->data['name']);
$this->loadmodel('user');
$conditions=array("user_id" => $user_id,"password" => $captch);
$result2 = $this->user->find('all',array('conditions'=>$conditions));
$n2 = sizeof($result2);
if($n2>0)
{
	$this->response->header('Location', 'set_new_password?q='.$q.' ');
}
else
{
$this->set('error', '<label style="color:red;">you have entered incorrect code</label>');
}
}

$this->loadmodel('user');
$conditions=array('user_id'=> $user_id,'signup_random'=>$q);
$result_check=$this->user->find('all',array('conditions'=>$conditions));
$n= sizeof($result_check);
if($n>0)
{ 
$random_otp=(string)mt_rand(1000,9999);

if($var==1)
{
$this->loadmodel('user');
$this->user->updateAll(array('password'=>$random_otp),array('user.user_id'=>$user_id));
$from_name="HousingMatters";
$reply="support@housingmatters.in";
$to=$email;
$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$subject="Verification your email";
$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
<p>Hello! Please enter your code $random_otp  on the signup
screen to continue your HousingMatters
registration process.</p>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div >
</div>";
$this->smtpmailer($to,$from,$from_name,$subject,$message_web,$reply);
}
}
else
{
echo "Sorry, you have used this link.This link is one time login link.";	
exit;
}

}

function send_sms_for_verify_mobile(){
	$this->layout=null;
	$q=$this->request->query['q'];

	$q_new=explode('/',$q);
	$q_new[0];

	 $user_id=(int)$this->decode($q_new[0],'housingmatters');
	 $randm=$q_new[1];
	
	$this->loadmodel('user');
	$conditions=array('user_id'=> $user_id); 
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach ($result_user as $collection) 
	{
	$mobile=$collection['user']["mobile"];
	}
	
	$this->loadmodel('user');
	$conditions=array('user_id'=> $user_id,'signup_random'=>$q);
	
	$result_check=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_check as $data9)
	{
		$user_name=$data9['user']['user_name'];
		$active=@$data9['user']['active'];
		$one_time_sms=(int)@$data9['user']["one_time_sms"];
	}
	 $n= sizeof($result_check);
	if($n>0){ 
	$random_otp=(string)mt_rand(1000,9999);


	$user_name=$this->check_charecter_name($user_name);
	
	$user_name=ucfirst($user_name);
	$r_sms=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_sms_ip')); 
	$working_key=$r_sms->working_key;
	$sms_sender=$r_sms->sms_sender; 	
	$sms_allow=(int)$r_sms->sms_allow;
	if($sms_allow==1){	

	$sms='Hi ! '.$user_name.', Use '.$random_otp.' as one time passcode and continue your Housing Matters registration process. ';

	$sms1=str_replace(' ', '+', $sms);

	$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
	}
	$this->user->updateAll(array('password'=>$random_otp,'one_time_sms'=>1),array('user.user_id'=>$user_id));


	$this->response->header('Location', 'verify_mobile?q='.$q.' ');
	}
	else
	{
	echo "Sorry, you have used this link.This link is one time login link.";	
	exit;
	}

}
function verify_mobile()
{

$var=1;
$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path')); 
$this->set('webroot_path',$webroot_path);
$this->layout='without_session';
$q=$this->request->query['q'];

$q_new=explode('/',$q);
$q_new[0];

$user_id=(int)$this->decode($q_new[0],'housingmatters');

$randm=$q_new[1];
$this->set('user_id',$user_id);
$this->loadmodel('user');
$conditions=array('user_id'=> $user_id); 
$result_user=$this->user->find('all',array('conditions'=>$conditions));
foreach ($result_user as $collection) 
{
$mobile=$collection['user']["mobile"];
}
$this->set('mobb',@$mobile);

if (isset($this->request->data['login'])) 
{
$var=2;
$captch=htmlentities($this->request->data['name']);
$this->loadmodel('user');
$conditions=array("user_id" => $user_id,"password" => $captch);
$result2 = $this->user->find('all',array('conditions'=>$conditions));

$n2 = sizeof($result2);
if($n2>0)
{
	$this->response->header('Location', 'set_new_password?q='.$q.' ');

}
else
{
$this->set('error', '<label style="color:red;">you have entered incorrect code</label>');
}
}


}


function verify_mobile_ajax()
{
	
	$this->layout='blank';
	$id=(int)$this->request->query['con'];
	$this->loadmodel('user');
	$result=$this->user->find('all',array('conditions'=>array('user_id'=>$id)));
	foreach($result as $data)
	{
		 $mobile= $data['user']['mobile'];
		 $user= $data['user']['user_name'];
	}
	$user_name=$this->check_charecter_name($user);
	//$dd=explode(' ',$user);
	//$user_name=$dd[0];
	$user_name=ucfirst($user_name);
	$r_sms=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_sms_ip')); 

 $working_key=$r_sms->working_key;
 $sms_sender=$r_sms->sms_sender; 
 $random_otp=(string)mt_rand(1000,9999);
 $sms_allow=(int)$r_sms->sms_allow; 
if($sms_allow==1){

$sms='Hi ! '.$user_name.', Use '.$random_otp.' as one time passcode and continue your Housing Matters registration process. ';
$sms1=str_replace(' ', '+', $sms);
$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
}

$this->user->updateAll(array('password'=>$random_otp),array('user.user_id'=>$id));

}
///////////////////////////////// Start Society Approve ///////////////////////////////////////////
function society_approve()
{

if($this->RequestHandler->isAjax()){
	$this->layout='blank';
}else{
	$this->layout='session';
}
$this->ath();
$society_id=(int)$this->Session->read('hm_society_id');
$user_id=(int)$this->Session->read('hm_user_id');
$this->loadmodel('user_temp');
$conditions=array("complete_signup"=>1,"reject"=>0,"role"=>1);
$result=$this->user_temp->find('all',array('conditions'=>$conditions));
$this->set('result_user_temp',$result);
}


function new_society_enrollment()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
}else{
	$this->layout='session';
}
$this->ath();
if ($this->request->is('POST')) 
{
$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));
 $society_name=htmlentities($this->request->data['society_name']);
 $user_name=htmlentities($this->request->data['user_name']);
 $email=htmlentities($this->request->data['email']);
 $mobile=htmlentities($this->request->data['mobile']);
 $pin_code=htmlentities($this->request->data['pin_code']);
 $association=htmlentities($this->request->data['association']);
 $no_flat=htmlentities($this->request->data['no_flat']);
 $i=$this->autoincrement('user','user_id');
 $society_id=$this->autoincrement('society','society_id');  
 $random1=mt_rand(1000000000,9999999999);
$random2=mt_rand(1000000000,9999999999);
$random=$random1.$random2 ;	
$de_user_id=$this->encode($i,'housingmatters');
$random=$de_user_id.'/'.$random;
$log_i=$this->autoincrement('login','login_id');

//////////////////////////////////////// Insert society table ////////////////////////////////////////

$this->loadmodel('society');
$this->society->save(array('society_id' => $society_id, 'society_name' => $society_name, 
'association_formed' => $association, 'user_id' => $i,"aprvl_status"=>1,"pin_code"=>$pin_code,"flats"=>$no_flat));
 
/////////////////////////////////////// End code /////////////////////////////////////////////////
 
 
//////////////////////////////////////// Insert data user table ///////////////////// ///////////////////////////////////
date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$this->loadmodel('user');
$this->user->save(array('user_id' => $i, 'user_name' => $user_name,'email' => $email, 'password' =>'', 'mobile' => $mobile,'society_id' => $society_id,'date' => $date, 'time' => $time,'signup_random'=>$random,'active'=>'yes','user_type'=>'third_party','profile_pic'=>'blank.jpg'));

$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>$society_id,'exited'=>'no'));

$auro_id=$this->autoincrement('user_role','auto_id');
$this->user_role->saveAll(array('auto_id'=>$auro_id,'user_id'=>$i,'role_id'=>1,'default'=>'yes','society_id'=>$society_id));


 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Login-Id: '.$email.' </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)" align="justify"> <p> Password: <b>
											<a href="'.$ip.$this->webroot.'hms/send_sms_for_verify_mobile?q='.$random.'"> Click here </a> for one time verification of your mobile number and Login into HousingMatters for making life simpler for all your housing matters!</b></p>
											<p>Congratulations your registration request has been successfully approved  
											</p></span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

		
$from_name="HousingMatters";
$this->loadmodel('email');
$conditions=array('auto_id'=>4);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
$subject=$collection['email']['subject'];
}
$reply=$from;
$to=$email;
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);

///////////////////////////////// End Mail functionality //////////////////////////////////////////////////////////

////////////////////////////// Notification email checked code start////////////////////////////////////////////////////////
$this->loadmodel('email');	
$conditions=array('notification_id'=>1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach($result_email as $data)
{
$auto_id = (int)$data['email']['auto_id'];
$this->loadmodel('notification_email');
$lo=$this->autoincrement('notification_email','notification_id');
$this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id , "user_id" => $i,'chk_status'=>0));
}

//////////////////////// /////////////////// End code notification  ////////////////////////////////////////////////////////

///////////////////// login table insert //////////////////////////////////




//////////////////// end code login table ///////////////////////////////

//////////////// Role to assign code for Society  //////////////////////////
for($p=1;$p<=6;$p++)
{
if($p==1) { $d="Admin"; }
if($p==2) { $d="Committee member"; }
if($p==3) { $d="Owner"; }
if($p==4) { $d="Tenant"; }
if($p==5) { $d="Owner family member"; }
if($p==6) { $d="Tenant Family Member"; }

$this->loadmodel('role');
$k=$this->autoincrement('role','auto_id');
$this->role->saveAll(array("auto_id" => $k, "role_name" => $d, 'role_id'=>$p, "society_id" => $society_id));
}	
//////////////// Role to assign end   //////////////////////////


$this->redirect(array('action' => 'assign_default_modules_to_society/'.$society_id.''));
}
}


function society_approve_mail()
{
$this->layout='blank';
$user_temp_id=(int)htmlentities($this->request->query('con1'));
$this->loadmodel('user_temp');
$conditions=array('user_temp_id'=>$user_temp_id); 
$result_user_temp=$this->user_temp->find('all',array('conditions'=>$conditions));
foreach ($result_user_temp as $collection) 
{ 
$society_id=(int)$collection['user_temp']['society_id'];
$user_name=$collection['user_temp']['user_name'];
$date=$collection['user_temp']['date'];
$time=$collection['user_temp']['time'];
$mobile=$collection['user_temp']['mobile'];
$email=$collection['user_temp']['email'];
$password=@$collection['user_temp']['password'];
$user_type=$collection['user_temp']['user_type']; 
} 
$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

$i=$this->autoincrement('user','user_id'); 
$random1=mt_rand(1000000000,9999999999);
$random2=mt_rand(1000000000,9999999999);
$random=$random1.$random2 ;	
$de_user_id=$this->encode($i,'housingmatters');
$random=$de_user_id.'/'.$random;
 

/////////////////////////////////////// Mail functinality //////////////////////////////////////


 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Login-Id: '.$email.' </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)" align="justify"> <p> Password: <b>
											<a href="'.$ip.$this->webroot.'hms/send_sms_for_verify_mobile?q='.$random.'"> Click here </a> for one time verification of your mobile number and Login into HousingMatters for making life simpler for all your housing matters!</b></p>
											<p>Congratulations your registration request has been successfully approved  
											</p></span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

	
$from_name="HousingMatters";
$this->loadmodel('email');
$conditions=array('auto_id'=>4);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
$subject=$collection['email']['subject'];
}
$reply=$from;
$to=$email;
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);

//////////////////////////////////////// Insert data user table ///////////////////// ///////////////////////////////////



$this->loadmodel('user');
$this->user->save(array('user_id' => $i, 'user_name' => $user_name,'email' => $email, 'password' => $password, 'mobile' => $mobile,  'society_id' => $society_id,'date' => $date, 'time' => $time,"profile_pic"=>'blank.jpg','signup_random'=>$random,'active'=>'yes','user_type'=>$user_type,'profile_pic'=>'blank.jpg'));

$this->loadmodel('user_role');
$auto_id=$this->autoincrement('user_role','auto_id');
$this->user_role->saveAll(array('auto_id' => $auto_id, 'role_id' => 1,'user_id' => $i,'default'=>'yes'));

$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>$society_id,'exited'=>'no'));

//////////////////////// insert login table //////////////////////////////////////



////////////////////////// update approval status in society //////////////////////////////////////////
$this->loadmodel('society');
$this->society->updateAll(array('aprvl_status'=>1,'user_id'=>$i),array('society.user_id'=>$user_temp_id));

/////////////////////////////////////////////////////end code /////////////////////////////////////////////


////////////////////////////// Notification email checked code start////////////////////////////////////////////////////////
$this->loadmodel('email');	
$conditions=array('notification_id'=>1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach($result_email as $data)
{
$auto_id = (int)$data['email']['auto_id'];
$this->loadmodel('notification_email');
$lo=$this->autoincrement('notification_email','notification_id');
$this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id , "user_id" => $i,'chk_status'=>0));
}

//////////////////////// /////////////////// End code notification  ////////////////////////////////////////////////////////


//////////////// Remove entry user_temp table  //////////////////////////
$this->loadmodel('user_temp');
$conditions=array("user_temp_id" => $user_temp_id);
$this->user_temp->deleteAll($conditions);

//////////////// End Remove entry user_temp table  //////////////////////////


//////////////// Role to assign code for Society  //////////////////////////
for($p=1;$p<=6;$p++)
{
if($p==1) { $d="Admin"; }
if($p==2) { $d="Committee member"; }
if($p==3) { $d="Owner"; }
if($p==4) { $d="Tenant"; }
if($p==5) { $d="Owner family member"; }
if($p==6) { $d="Tenant Family Member"; }

$this->loadmodel('role');
$k=$this->autoincrement('role','auto_id');
$this->role->saveAll(array("auto_id" => $k, "role_name" => $d, 'role_id'=>$p, "society_id" => $society_id));

}	
//////////////// Role to assign end   //////////////////////////


}

function society_approve_reject()
{
$this->layout='blank';	
$email=htmlentities($this->request->query('con'));
$user_id=(int)htmlentities($this->request->query('con1'));
$this->loadmodel('user_temp');
$this->user_temp->updateAll(array('reject'=>1),array('user_temp.user_temp_id'=>$user_id));
$this->response->header('Location','society_approve');

}

function role_new_delete(){
	
$this->layout=null;	
$auto_id=(int)$this->request->query('con');	
$this->loadmodel('role');
$this->role->updateAll(array("delete_id"=>0),array("auto_id"=>$auto_id));
$this->redirect(array('action' => 'role_add'));
}

function role_add()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$this->ath();
$s_society_id=$this->Session->read('hm_society_id');

if (isset($this->request->data['add_role'])) 
{
$role_name=$this->request->data['role_name'];
$auto_id=$this->autoincrement('role','auto_id');
$role_id=$this->autoincrement_with_society('role','role_id');



$this->loadmodel('role');
$multipleRowData = Array( Array('auto_id'=>$auto_id,'role_id' => $role_id, 'role_name' => $role_name,'society_id' => $s_society_id,'delete_id'=>1));
$this->role->saveAll($multipleRowData); 
}

if (isset($this->request->data['update_data'])) 
{
	  $role_name=$this->request->data['edit_text'];
	  $update_id=(int)$this->request->data['update'];
	  $this->loadmodel('role');
	  $this->role->updateAll(array("role_name"=>$role_name),array("auto_id"=>$update_id));
}

$this->loadmodel('role');

$conditions =array('$or' => array( 
array("society_id" => $s_society_id,'role_id'=>array('$lte'=>6)),
array('society_id' =>$s_society_id,'delete_id' =>1)
));

$this->set('result_role',$this->role->find('all',array('conditions'=>$conditions)));


}



function asisgn_module_to_role(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$this->check_user_privilages();
	$s_society_id=$this->Session->read('hm_society_id');


	$this->loadmodel('role');
	$conditions=array("society_id" => $s_society_id);
	$result_r=$this->role->find('all',array('conditions'=>$conditions));
	$this->set('result_role',$result_r);
}

function assign_modules_to_role_ajax($role_id=null)
{
$this->layout='blank';
$this->ath();
$s_society_id=$this->Session->read('hm_society_id');

$this->set(compact("role_id"));

$role_name=$this->requestAction(array('controller' => 'Fns', 'action' => 'role_name_via_role_id'), array('pass' => array($role_id)));
$this->set(compact("role_name"));

$this->loadmodel('module_type');
$order=array('module_type.module_type_name'=>'ASC');		
$result_module_type=$this->module_type->find('all',array('order'=>$order));
$this->set(compact("result_module_type"));

}

function module_list_via_type_id($module_type_id=null){
$this->layout="blank";	

$this->loadmodel('main_module');
$conditions=array("mt_id" => (int)$module_type_id);
$order=array('main_module.module_name'=>'ASC');		
$main_modules=$this->main_module->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set(compact("main_modules"));
}

function save_role_privilage($module_id=null,$sub_module_id=null,$action=null,$role_id=null){
	$s_society_id=$this->Session->read('hm_society_id');
	
	if($action=="true"){
		$this->loadmodel('role_privilege');
		
		$conditions=array("society_id" => $s_society_id,'role_id'=>(int)$role_id,"module_id" => (int)$module_id,"sub_module_id" => (int)$sub_module_id);
		$this->role_privilege->deleteAll($conditions);
		
		$auto_id=$this->autoincrement('role_privilege','auto_id');
		$this->role_privilege->saveAll(array("auto_id" => $auto_id, "society_id" => $s_society_id,'role_id'=>(int)$role_id, "module_id" => (int)$module_id, "sub_module_id" => (int)$sub_module_id));
		echo "ok";
	}else{
		$this->loadmodel('role_privilege');
		$conditions=array("society_id" => $s_society_id,'role_id'=>(int)$role_id,"module_id" => (int)$module_id,"sub_module_id" => (int)$sub_module_id);
		$this->role_privilege->deleteAll($conditions);
		echo "ok";
	}
}

function sub_module_list_via_module_id($module_id=null,$role_id=null){
$this->layout="blank";	
$this->ath();
$this->set(compact("role_id"));
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('sub_module');
$conditions=array("module_id" => (int)$module_id);
$order=array('sub_module.sub_module_name'=>'ASC');		
$sub_modules=$this->sub_module->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set(compact("sub_modules"));
?>
<span style="font-weight: bold; color: rgb(92, 92, 92);">Sub-Modules</span>  <a href="#" role="button" id="select_all" >assign all</a> | <a href="#" role="button" id="deselect_all" >deassign all</a><br/>
<?php foreach($sub_modules as $data){
	$sub_module_id=(int)$data["sub_module"]["auto_id"];
	$sub_module_name=$data["sub_module"]["sub_module_name"];
	$module_id=$data["sub_module"]["module_id"];
	$this->loadmodel('role_privilege');
	$conditions=array("module_id" =>(int)$module_id,"sub_module_id" =>$sub_module_id,"role_id" =>(int)$role_id,"society_id" =>$s_society_id);
	$count=$this->role_privilege->find('count',array('conditions'=>$conditions));
	if($count==1){$check="checked";}else{$check="";}?>

	<li class="pqr" >
	<label><input type="checkbox" <?php echo $check; ?> module_id="<?php echo $module_id; ?>" sub_module_id="<?php echo $sub_module_id; ?>" /><?php echo $sub_module_name; ?></label></li>
<?php }
}


function fetch_main_module_name_hm($module_id)
{
$this->layout='blank';
$this->ath();

$this->loadmodel('main_module');
$conditions=array("mt_id" => $module_id);
return $result_main_module=$this->main_module->find('all',array('conditions'=>$conditions));
}



function fetch_main_module_name($module_id)
{
$this->layout='blank';
$this->ath();

$this->loadmodel('main_module');
$conditions=array("auto_id" => $module_id);
return $result_main_module=$this->main_module->find('all',array('conditions'=>$conditions));
}

function fetch_sub_module($main_module_id)
{
$this->layout='blank';
$this->ath();
$this->loadmodel('sub_modules');
$conditions=array("module_id" => $main_module_id);
return $result_sub_modules=$this->sub_modules->find('all',array('conditions'=>$conditions));
}

function fetch_hm_assign_module_hm($mt_id)
{
$this->layout='blank';
$this->ath();
$role_id=(int)$this->request->query('con');

$s_society_id=$this->Session->read('society_id');
$this->loadmodel('hm_modules_assign');
$conditions=array('mt_id'=>$mt_id);
return $this->hm_modules_assign->find('all',array('conditions'=>$conditions));
	
}

function fetch_hm_assign_module($mt_id)
{
	$this->layout='blank';
	$this->ath();

	$role_id=(int)$this->request->query('con');

	$s_society_id=$this->Session->read('society_id');
$this->loadmodel('hm_modules_assign');
$conditions=array("society_id" => $s_society_id,'mt_id'=>$mt_id);
return $this->hm_modules_assign->find('all',array('conditions'=>$conditions));

	
}
function fetch_role_privileges($sub_module_id)
{
$this->layout='blank';
$this->ath();

$role_id=(int)$this->request->query('con');

$s_society_id=$this->Session->read('society_id');

$this->loadmodel('role_privilege');
$conditions=array("sub_module_id" => $sub_module_id,"society_id" => $s_society_id,"role_id" => $role_id);
return $result_role_privileges=$this->role_privilege->find('count',array('conditions'=>$conditions));
}

function hm_assign_module()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$da_society_id=(int)$this->request->query('q');
if(!empty($da_society_id))
{	
	
	$result2=$this->society_name($da_society_id);
	foreach($result2 as $data)
	{
		$society_name=$data['society']['society_name'];
		$user_id=(int)$data['society']['user_id'];
		
	}
	$message= 'Society <b>'.$society_name.'</b> approved.<br/> Assign modules to the society';
	$this->set('mess',$message);
}
$this->loadmodel('society');
$result=$this->society->find('all',array('conditions'=>array('aprvl_status'=>1)));
$this->set('result_society',$result);
if ($this->request->is('post')) 
{

  $society_id=(int)$this->request->data['r_name'];
 
	$this->loadmodel('role_privilege');
	$conditions=array("society_id" => $society_id, "role_id" => 3 , "module_id" => 18,"sub_module_id" =>49);
	$result5=$this->role_privilege->find('all',array('conditions'=>$conditions));
	$num_count=sizeof($result5);
	if($num_count==0)
	{
	$this->loadmodel('role_privilege');
	$data_row =Array( Array("society_id" => $society_id, "role_id" => 3 , "module_id" => 18,"sub_module_id" =>49));
	$this->role_privilege->saveAll($data_row);
	}

$society_id=(int)$this->request->data['r_name'];

$this->loadmodel('main_module');
$result_main_module=$this->main_module->find('all');

foreach ($result_main_module as $collection) 
{		  
$module_id =(int)$collection['main_module']['auto_id'];
$mt_id =(int)$collection['main_module']['mt_id'];
$value =@$this->request->data[$module_id];
if($value==1)
{

$this->loadmodel('hm_modules_assign');
$conditions=array("society_id" => $society_id, "module_id" => $module_id);
$result1=$this->hm_modules_assign->find('all',array('conditions'=>$conditions));

$n = sizeof($result1);
if($n==0)
{
$this->loadmodel('hm_modules_assign');
$this->hm_modules_assign->saveAll(array("society_id" => $society_id, "module_id" => $module_id,'mt_id'=>$mt_id));
}   
}
else
{
$this->loadmodel('hm_modules_assign');
$conditions= array("society_id" => $society_id, "module_id" => $module_id);
$this->hm_modules_assign->deleteAll($conditions);
$this->loadmodel('role_privilege');
$conditions= array("society_id" => $society_id, "module_id" => $module_id);
$this->role_privilege->deleteAll($conditions);
}

}
$this->response->header('location','hm_assign_module');
}
}

function hm_society_view()
{
$this->layout='session';
$this->ath();
$this->check_housingmatters_privilages();
$this->loadmodel('society');
$result=$this->society->find('all');
$this->set('n',sizeof($result));
$this->set('result_society',$result);
}


function hm_resident_approve_resend_mail()
{
	$this->layout='blank';
	$user_temp_id=(int)$this->request->query('con');	
	$s_society_id=(int)$this->request->query('con2');		
$this->loadmodel('user');
$conditions=array('user_id'=>$user_temp_id);
$result_user_temp=$this->user->find('all',array('conditions'=>$conditions));
foreach ($result_user_temp as $collection) 
{ 
$society_id=(int)$collection['user']['society_id'];
$user_name=$collection['user']['user_name'];
$mobile=$collection['user']['mobile'];
$email=$collection['user']['email'];
$password=$collection['user']['password'];
$wing=(int)$collection['user']['wing'];
$flat=(int)$collection['user']['flat'];
$tenant=(int)$collection['user']['tenant'];
$residing=(int)$collection['user']['residing'];

}
///////////end fetch data ////////////////////

$random1=mt_rand(1000000000,9999999999);
$random2=mt_rand(1000000000,9999999999);
$random=$random1.$random2 ;

//////////////// insert data user table //////////////////////////
$ip=$this->hms_email_ip();
$de_user_id=$this->encode($user_temp_id,'housingmatters');
$random=$de_user_id.'/'.$random;


$this->loadmodel('user');
$this->user->updateAll(array('signup_random'=>$random,'one_time_sms'=>0),array('user.user_id'=>$user_temp_id));



//////////////// end insert code  //////////////////////////

$this->loadmodel('society');
$conditions12=array('society_id'=>$s_society_id);
$result12=$this->society->find('all',array('conditions'=>$conditions12));
foreach($result12 as $data)
{
$s_name=$data['society']['society_name'];
}
///////////////////////////////////////////// approve mail functionality ///////////////////////////////////////

$to=$email;
$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
<p style='color:green;'><strong>Reminder!</strong></p>
<p>Dear  $user_name,</p>
<p>'We at $s_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent &amp; smart management of housing society affairs.</p>
<p>As you are an owner/resident/staff of $s_name, we have added your email address in HousingMatters portal.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>

<li>log &amp; track complaints</li>
<li>start new discussions</li>
<li>check your maintenance dues</li>
<li>post classifieds</li>
<li>receive important SMS &amp; emails from your committee</li>
<li>and much more in the portal.</li>



<p><b><a href='$ip".$this->webroot."/hms/send_sms_for_verify_mobile?q=$random' target='_blank'><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'>Click here</button></a> for one time verification of your mobile number and Login into HousingMatters  for making life simpler for all your housing matters!</b></p>


<p>Regards,</p>
<p>Administrator of $s_name</p>

<p>PS: add <a href='http://www.housingmatters.co.in' target='_blank'>www.housingmatters.co.in</a> in your favorite bookmarks for future use.</p>



</div >
</div>";

$subject="[$s_name]";
$from_name="HousingMatters";
$reply="support@housingmatters.in";
$this->loadmodel('email');
$conditions=array('auto_id'=>4);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	
	
}


function hm_resident_approve_resend_sms()
{
	
		$this->layout='blank';
		$user_temp_id=(int)$this->request->query('con');	
		$s_society_id=(int)$this->request->query('con2');	
		$result_society=$this->society_name($s_society_id);
		foreach($result_society as $dd)
		{
		$society_name=$dd['society']['society_name'];
		}
		
		$s_n='';
		$sco_na=$society_name;
		$dd=explode(' ',$sco_na);
		$first=$dd[0];
		$two=$dd[1];
		$three=$dd[2];
		$s_n.=" $first $two $three ";
		
		$this->loadmodel('user');
		$conditions=array('user_id'=>$user_temp_id);
		$result_user=$this->user->find('all',array('conditions'=>$conditions));
		foreach($result_user as $data)
		{
		$mobile=$data['user']['mobile'];
		$user_name=$data['user']['user_name'];
		$login_id=(int)$data['user']['login_id'];
		}
			$r_sms=$this->hms_sms_ip();
			$working_key=$r_sms->working_key;
			$sms_sender=$r_sms->sms_sender; 
			$sms_allow=(int)$r_sms->sms_allow;
		$random=(string)mt_rand(1000,9999);
		if($sms_allow==1){
		$sms="".$user_name.", Your housing society ".$s_n." has enrolled you in HousingMatters portal. Pls log into www.housingmatters.co.in One Time Password ".$random."";
		$sms1=str_replace(" ", '+', $sms);
		$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
		}
		$this->loadmodel('user');
		$this->user->updateAll(array('password'=>$random,'signup_random'=>$random),array('user_id'=>$user_temp_id));
		$this->loadmodel('login');
		$this->login->updateAll(array('password'=>$random,'signup_random'=>$random),array('login_id'=>$login_id));


}


function hm_society_member_view()
{

$this->layout='session';
$this->ath();	
$this->loadmodel('society');	
$this->set('result_society',$this->society->find('all',array('conditions'=>array('aprvl_status'=>1))));
$this->loadmodel('user');
$order=array('user.user_name'=>'ASC');		
$result1=$this->user->find('all',array('conditions'=>array('deactive'=>0),'order'=>$order));	
$this->set('result_user',$result1);
$this->set('n',sizeof($result1));	

}


function society_count_user($society_id)
{
$this->loadmodel('user');
$conditions=array('society_id'=>$society_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
return sizeof($result);

}


function hm_assign_module_ajax()
{
$this->layout='blank';
$society_id=(int)$this->request->query('con');
/*$this->loadmodel('main_module');
$result=$this->main_module->find('all');
$this->set('result_main_module',$result);
$this->set('society_id',$society_id);
*/

$this->loadmodel('module_type');
$result=$this->module_type->find('all',array('order'=>array('module_type.module_type_name'=>'ASC')));
$this->set('result_main_module',$result);
$this->set('society_id',$society_id);


}
function count($module_id,$society_id)
{
$this->loadmodel('hm_modules_assign');
$conditions=array("society_id" => $society_id, "module_id" => $module_id); 
$result=$this->hm_modules_assign->find('all',array('conditions'=>$conditions)); 
return $n=sizeof($result);         
}	



function user_assign_role(){
	
	$s_society_id=(int)$this->Session->read('hm_society_id');
	$s_user_id=(int)$this->Session->read('hm_user_id');
		if($this->RequestHandler->isAjax()){
				$this->layout='blank';
			}else{
				$this->layout='session';
			}
	$this->ath();
	$this->check_user_privilages();
	/*$this->loadmodel('user');
	$conditions1=array('society_id'=>$s_society_id,'active'=>"yes");
	$order=array('user.user_name'=>'Asc');
	$result=$this->user->find('all',array('conditions'=>$conditions1,'order'=>$order));
	$this->set('result_user',$result); */
	
	$this->loadmodel('user');
	$conditions1=array('society_id'=>$s_society_id,'active'=>"yes");
	$order=array('user.user_name'=>'Asc');
	$userresults=$this->user->find('all',array('conditions'=>$conditions1,'order'=>$order));
	foreach($userresults as $userresult){
			@$user_id=@$userresult["user"]["user_id"];
			@$user_name=@$userresult["user"]["user_name"];
			@$email=@$userresult["user"]["email"];
			@$mobile=@$userresult["user"]["mobile"];
			$profile_pic=@$userresult["user"]["profile_pic"];
			
			$this->loadmodel('user_flat');
			$conditions=array("user_id"=>$user_id, "exited"=>"no");
			$result=$this->user_flat->find('all',array('conditions'=>$conditions));
			$flats=array();
			foreach($result as $data){
				$user_flat_id=$data["user_flat"]["user_flat_id"];
				$wing=@$data["user_flat"]["wing"];
				$flat=@$data["user_flat"]["flat"];
				
				$this->loadmodel('wing');
				$conditions=array("wing_id"=>$wing);
				$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
				@$wing_name=$wing_info[0]["wing"]["wing_name"];
				
				$this->loadmodel('flat');
				$conditions=array("flat_id"=>$flat);
				$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
				@$flat_name=ltrim($flat_info[0]["flat"]["flat_name"],'0');
				
				$flats[$user_flat_id]=$wing_name.'-'.$flat_name;
			}
			$result_member[]=array("user_name"=>$user_name,"wing_flat"=>$flats,"email"=>$email,"mobile"=>$mobile,"profile_pic"=>$profile_pic,'user_id'=>$user_id);
	}	
	
	$this->set('result_user',$result_member);
		
}

function user_assign_role_auto_save($chk=null,$role_id=null,$user_id=null){
	
	$this->layout=null;
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	
	$role_id=(int)$role_id;
	$user_id=(int)$user_id;
	if($chk=="true"){
			$count_role=$this->user_role($role_id,$user_id);
			if($count_role==0){
				
					$default_count=$this->user_role_default_find($user_id);
					if($default_count>0){ $default="" ; }else{  $default="yes" ; }
					$this->loadmodel('user_role');
					$auto_id=$this->autoincrement('user_role','auto_id');
					$this->user_role->saveAll(array('auto_id'=>$auto_id,'user_id'=>$user_id,'role_id'=>$role_id,"default"=>$default,'society_id'=>$s_society_id));	
				
			}
		
	}else{
		
		$this->loadmodel('user_role');
		$this->user_role->deleteAll(array('user_id'=>$user_id,'role_id'=>$role_id,'society_id'=>$s_society_id));
		
	}
	
	
}

function user_assign_role_ajax()
{
$this->layout='blank';
$user_id=(int)$this->request->query('con');
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('role');
$conditions=array('society_id'=>$s_society_id);	
$result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('result_role',$result);
$this->set('user_id',$user_id);
}

function user_role($role_id,$user_id)
{
$s_society_id=$this->Session->read('hm_society_id');	
$this->loadmodel('user_role');
$conditions=array("user_id" => $user_id, "role_id" => $role_id,"society_id"=>$s_society_id); 
$result=$this->user_role->find('all',array('conditions'=>$conditions)); 
return $n=sizeof($result);        
}

function user_role_default_find($user_id)
{
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('user_role');
$conditions=array("user_id" => $user_id, "default" =>"yes","society_id"=>$s_society_id); 
$result=$this->user_role->find('all',array('conditions'=>$conditions)); 
return $n=sizeof($result);        
}

////////////////////////////////////// Notification email and Sms Start ///////////////////////////////////////

function notification_email()
{

if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$user_id=$this->Session->read('user_id');	
$this->set('s_user_id',$user_id);
$s_society_id=$this->Session->read('society_id'); 
$this->loadmodel('email');	
$conditions=array('notification_id'=>1);
$result=$this->email->find('all',array('conditions'=>$conditions));
$this->set('result_email',$result);
if($this->request->is('post'))
{
foreach($result as $data)
{

$notification_id=(int)$data['email']['notification_id'];
$auto_id = (int)$data['email']['auto_id'];
$module_name = $data['email']['module_name']; 
$chk_email=@$this->request->data['check_email'.$auto_id];
$chk_sms=@$this->request->data['check_sms'.$auto_id];

if($chk_email==1)
{
$this->loadmodel('notification_email');
$conditions5=array('module_id'=>$auto_id,'user_id'=>$user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions5));
$n= sizeof($result5);
if($n==0)
{
$this->loadmodel('notification_email');
$i=$this->autoincrement('notification_email','notification_id');
$this->notification_email->saveAll(array("notification_id" => $i, "module_id" => $auto_id , "user_id" => $user_id,'chk_status'=>0));
}

}
else
{
$this->loadmodel('notification_email');
$conditions6=array('module_id'=>$auto_id,'user_id'=>$user_id,'chk_status'=>0);
$this->notification_email->deleteAll($conditions6);
}

if($chk_sms==1)
{
$this->loadmodel('notification_email');
$conditions5=array('module_id'=>$auto_id,'user_id'=>$user_id,'chk_status'=>1);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions5));
$n= sizeof($result5);
if($n==0)
{
$this->loadmodel('notification_email');
$i=$this->autoincrement('notification_email','notification_id');
$this->notification_email->saveAll(array("notification_id" => $i, "module_id" => $auto_id , "user_id" => $user_id,'chk_status'=>1));
}
}
else
{
$this->loadmodel('notification_email');
$conditions6=array('module_id'=>$auto_id,'user_id'=>$user_id,'chk_status'=>1);
$this->notification_email->deleteAll($conditions6);
}

}


}



}


function notification_count_email($auto_id,$user_id)
{
$this->loadmodel('notification_email');
$conditions=array('module_id'=>$auto_id,'user_id'=>$user_id,'chk_status'=>0);
$result=$this->notification_email->find('all',array('conditions'=>$conditions));
return  $n= sizeof($result);
}


function notification_count_sms($auto_id,$user_id)
{
$this->loadmodel('notification_email');
$conditions=array('module_id'=>$auto_id,'user_id'=>$user_id,'chk_status'=>1);
$result=$this->notification_email->find('all',array('conditions'=>$conditions));
return  $n= sizeof($result);
}

/////////////////////////////////// End notification  //////////////////






////////////////////////////////// Start Yellow Page /////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////



function yellow_registration()
{
$this->layout='session';	
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 	
$this->set('role_id',$s_role_id=$this->Session->read('role_id'));
$this->loadmodel('yellow_category');
$result_yellow=$this->yellow_category->find('all');	
$this->set('result_yellow_category',$result_yellow);	

if($this->request->is('post'))
{

$ip=$this->hms_email_ip();
$file=$this->request->form['file']['name'];
if(empty($file))
{
$file='blank.jpg';
}
$name=htmlentities($this->request->data['name']);
$address=htmlentities($this->request->data['address']);
$mobile=htmlentities($this->request->data['mobile']);
$to=htmlentities($this->request->data['email']);
$website=htmlentities($this->request->data['website']);
$message_web="Thank you. You have been enroll in HousingMatters";
$this->loadmodel('email');
$condition=array('auto_id'=>7);
$result4=$this->email->find('all',array('conditions'=>$condition));
foreach($result4 as $data)
{
$from=$data['email']['from'];

}
$from_name="HousingMatters";
$subject="HousingMatters";
$reply=$from;

$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
<br/><p>Thank you. You have been enroll in HousingMatters</p><br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div >
</div>";


$target = "yellow_page_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 
foreach($result_yellow as $data)
{
$id=(int)$data['yellow_category']['yellow_cat_id'];
$servies=$data['yellow_category']['yellow_cat_name'];
$check_id=(int)@$this->request->data[$id];
if(!empty($check_id))
{
$category[]=$check_id;
}
}
date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$i=$this->autoincrement('yellow_registration','yellowpage_id');
$this->loadmodel('yellow_registration');
$this->yellow_registration->saveAll(array("yellowpage_id" => $i, "yellowpage_attachment" => $file , "yellowpage_name" => $name,"yellowpage_date"=>$date,"yellowpage_category"=>$category,"user_id"=>$s_user_id,"society_id"=>$s_society_id,"yellowpage_time"=>$time,"yellowpage_delete"=>0,"yellowpage_website"=>$website,"yellowpage_address"=>$address,"yellowpage_email"=>$to,"yellowpage_mobile"=>$mobile));
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
//$this->smtpmailer($to,$from,$from_name,$subject,$message_web,$reply);


?>	

<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
<?php echo $name; ?> successfully registered in HousingMatters.
</div> 
<div class="modal-footer">
<a href="yellow_page" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->

<?php 		 

}

}

function yellow_page()
{
$this->layout='session';	
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 
$this->loadmodel('yellow_category');
$result_yellow=$this->yellow_category->find('all');	
$this->set('result_yellow_category',$result_yellow);
$this->loadmodel('yellow_registration');
$conditions=array('yellowpage_delete'=>0);
$result=$this->yellow_registration->find('all',array('conditions'=>$conditions));
$this->set('result_ye_registration',$result);

}


function yellow_category_name($category)
{
$this->loadmodel('yellow_category');
$conditions=array('yellow_cat_id'=>$category);
return $this->yellow_category->find('all',array('conditions'=>$conditions));

}

function yellow_page_view()
{
$this->layout='blank';

$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 	
$yellow_id=(int)$this->request->query('id');
$this->loadmodel('yellow_registration');
$conditions1=array('yellowpage_id'=>$yellow_id);
$this->set('result_yellow',$this->yellow_registration->find('all',array('conditions'=>$conditions1)));

}

function yellow_page_view_ajax()
{
$this->layout='blank';
$search_cat=(int)$this->request->query('con');
$this->set('search_value',$search_cat);
$this->loadmodel('yellow_registration');
$conditions=array('yellowpage_category'=>$search_cat);
$result= $this->yellow_registration->find('all',array('conditions'=>$conditions));
$this->set('count_yellow',sizeof($result));
$this->set('result_yellow',$result);

$this->loadmodel('yellow_registration');
$conditions1=array('yellowpage_delete'=>0);
$result1=$this->yellow_registration->find('all',array('conditions'=>$conditions1));
$this->set('result_ye_registration',$result1);


}


////////////////////////////  End Yellow Page //////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////



////////////////////////////////////////////////////////////////////////////////////////	
/////////////////////////////////////////////////////start Message//////////////////////
////////////////////////////////////////////////////////////////////////////////////////	
function message()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();

$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 

$this->loadmodel('user');
$conditions=array("society_id"=>$s_society_id,'user.mobile'=> array('$ne' => ""));
$this->set('result_users',$this->user->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('group');
$conditions=array("society_id"=>$s_society_id);
$result_group=$this->group->find('all',array('conditions'=>$conditions)); 
$this->set('result_group',$result_group); 

$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('role_result',$role_result);
$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
$this->set('wing_result',$wing_result);


$this->loadmodel('template');
$conditions=array("cat"=>1);
$this->set('result_template1',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>2);
$this->set('result_template2',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>3);
$this->set('result_template3',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>4);
$this->set('result_template4',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>5);
$this->set('result_template5',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>6);
$this->set('result_template6',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>7);
$this->set('result_template7',$this->template->find('all',array('conditions'=>$conditions))); 

if (isset($this->request->data['send'])) 
{
$radio=$this->request->data['radio'];
$s_date=$this->request->data['date'];
$d = explode("-", $s_date);
$s_date_ex0=$d[0];
$s_date_ex1=$d[1];
$s_date_ex2=$d[2];
$time_h=$this->request->data['time_h'];
$time_m=$this->request->data['time_m'];
//$time_m=30;

$date=date("d-m-y");
$time=date('h:i:a',time());

$massage=$this->request->data['massage'];
$massage_str=str_replace(' ', '+', $massage);

$result_user_info=$this->requestAction(array('controller' => 'hms', 'action' => 'profile_picture'), array('pass' => array($s_user_id)));
foreach ($result_user_info as $collection2) 
{
$name=$collection2["user"]["user_name"];
$wing=$collection2["user"]["wing"];
$flat=$collection2["user"]["flat"];
$sender_email=$collection2["user"]["email"];
}



$r_sms=$this->hms_sms_ip();
  $working_key=$r_sms->working_key;
 $sms_sender=$r_sms->sms_sender; 
$sms_allow=(int)$r_sms->sms_allow;
if($radio==1)
{
$multi=$this->request->data['multi'];
$multi[]=$sender_email;
for($i=0; $i<sizeof($multi); $i++)
{
$multi_new=$multi[$i];
$ex = explode(",", $multi_new);
$mobile[]=$ex[1];
$user[]=$ex[0];
}
$mobile_im=implode(",", $mobile);
//$user=implode(",", $user); 

$s_date_ex0.$s_date_ex1.$s_date_ex2.$time_h.$time_m;
if($sms_allow==1){
$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile_im.'&message='.$massage_str.'&time='.$s_date_ex0.$s_date_ex1.$s_date_ex2.$time_h.$time_m);

}


$sms_id=$this->autoincrement('sms','sms_id');
$this->loadmodel('sms');
$multipleRowData = Array( Array("sms_id" => $sms_id,"text"=>$massage,"user_id"=>$user,"date"=>$date,"time"=>$time,"society_id"=>$s_society_id,"type"=>1,"deleted"=>0));
$this->sms->saveAll($multipleRowData);
}

if($radio==2)
{
$user_new = array(); 
foreach ($result_group as $collection) 
{
$group_id=$collection["group"]["group_id"];

$g_id=@$this->request->data['grp'.$group_id];
if(!empty($g_id))
{
$groups_id[]=(int)$g_id;
$users=$collection["group"]["users"];
$user_new=array_merge($user_new,$users);
}
}
$result_user_unique = array_unique($user_new);


foreach ($result_user_unique as $data) 
{
$data=(int)$data;
$result_user_info=$this->requestAction(array('controller' => 'hms', 'action' => 'profile_picture'), array('pass' => array($data)));
foreach ($result_user_info as $collection2) 
{
$mobile[]=$collection2["user"]["mobile"];
}
}
$mobile_im=implode(",", $mobile);

$r_sms=$this->hms_sms_ip();
$working_key=$r_sms->working_key;
$sms_sender=$r_sms->sms_sender; 
$sms_allow=(int)$r_sms->sms_allow;
if($sms_allow==1){

$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile_im.'&message='.$massage_str.'&time='.$s_date_ex0.$s_date_ex1.$s_date_ex2.$time_h.$time_m);

}
$sms_id=$this->autoincrement('sms','sms_id');
$this->loadmodel('sms');
$multipleRowData = Array( Array("sms_id" => $sms_id,"text"=>$massage,"user_id"=>$result_user_unique,"date"=>$date,"time"=>$timd,"type"=>2,"society_id"=>$s_society_id,"deleted"=>0));	

$this->sms->saveAll($multipleRowData);
}



if($radio==3)
{
$visible=(int)$this->request->data['visible'];
	if($visible==1)
	{	
	$visible=1;
	$sub_visible[]=0;
	/////////////////////////////////////////// All user ////////////////////////////
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['mobile'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}
	/////////////////////////////////////////// All user ////////////////////////////
	}
	
	if($visible==4)
	{	
	$visible=4;
	$sub_visible[]=0;
	/////////////////////////////////////////// All Owners ////////////////////////////
	$this->loadmodel('user');
	$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['mobile'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}
	/////////////////////////////////////////// All Owners ////////////////////////////
	}
	
	if($visible==5)
	{
	$visible=5;
	$sub_visible[]=0;
	/////////////////////////////////////////// All Tenant ////////////////////////////
	$this->loadmodel('user');
	$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['mobile'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}
	/////////////////////////////////////////// All Tenant ////////////////////////////
	}
	
	if($visible==2)
	{	
	$visible=2;
	foreach ($role_result as $collection) 
	{
	$role_id=$collection["role"]["role_id"];

	$role_id=@(int)$this->request->data['role'.$role_id];
	if(!empty($role_id))
	{
	$sub_visible[]=(int)$role_id;

	/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////
	$this->loadmodel('user');
	$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['mobile'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}

	//////////////////////////////// end mail ////////////////////////////////////////////////////////	


	}
	}
	$da_user_id=array_unique($da_user_id);
	}
	
	if($visible==3)
	{	
	$visible=3;
	foreach ($wing_result as $collection) 
	{
	$wing_id=$collection["wing"]["wing_id"];

	$wing=@(int)$this->request->data['wing'.$wing_id];
	if(!empty($wing))
	{
	$sub_visible[]=(int)$wing;


	/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////
	$this->loadmodel('user');
	$conditions=array('wing'=>$wing_id,'society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
		if(!empty($data['user']['mobile']))
		{
			$da_to[]=$data['user']['mobile'];
			$da_user_name[]=$data['user']['user_name'];
			$da_user_id[]=$data['user']['user_id'];
		}
	
	}
	}
	}
	}
$da_to[]=$sender_email;
$da_user_id=array_unique($da_user_id);	
$da_to=array_unique($da_to);	
$da_to=array_filter($da_to);
$mobile_im=implode(',',$da_to);

$r_sms=$this->hms_sms_ip();
  $working_key=$r_sms->working_key;
 $sms_sender=$r_sms->sms_sender; 
$sms_allow=(int)$r_sms->sms_allow;
if($sms_allow==1){
$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile_im.'&message='.$massage_str.'&time='.$s_date_ex0.$s_date_ex1.$s_date_ex2.$time_h.$time_m);
}
$sms_id=$this->autoincrement('sms','sms_id');
$this->loadmodel('sms');
$multipleRowData = Array( Array("sms_id" => $sms_id,"text"=>$massage,"user_id"=>$da_user_id,"date"=>$date,"time"=>$time,"type"=>1,"society_id"=>$s_society_id,"deleted"=>0));	


$this->sms->saveAll($multipleRowData);

}

?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your SMS has been Sent.
</div> 
<div class="modal-footer">
<a href="message_view" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php	

}


}




function message_view()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 

$this->loadmodel('sms');
$conditions=array("society_id"=>$s_society_id,"deleted"=>0);
$order=array('sms.sms_id'=>'DESC');
$this->set('result_sms',$this->sms->find('all',array('conditions'=>$conditions,'order'=>$order))); 
}

function message_view_ajax()
{
$this->layout='blank';
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 

$id=(int)$this->request->query('id');

$this->loadmodel('sms');
$conditions=array("sms_id"=>$id);
$this->set('result_smsview',$this->sms->find('all',array('conditions'=>$conditions))); 

}

//////////////////////////////////////////////////////////////////////////////
///////////////////////////EMAIL///////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////
function email()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();

$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 


$this->loadmodel('user');
$conditions=array("society_id"=>$s_society_id,'user.email'=> array('$ne' => ""));
$this->set('result_users',$this->user->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('group');
$conditions=array("society_id"=>$s_society_id);
$result_group=$this->group->find('all',array('conditions'=>$conditions)); 
$this->set('result_group',$result_group); 

$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('role_result',$role_result);
$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
$this->set('wing_result',$wing_result);


$this->loadmodel('template');
$conditions=array("cat"=>1);
$this->set('result_template1',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>2);
$this->set('result_template2',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>3);
$this->set('result_template3',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>4);
$this->set('result_template4',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>5);
$this->set('result_template5',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>6);
$this->set('result_template6',$this->template->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('template');
$conditions=array("cat"=>7);
$this->set('result_template7',$this->template->find('all',array('conditions'=>$conditions))); 

if (isset($this->request->data['send'])) 
{
	$ip=$this->hms_email_ip();
$radio=$this->request->data['radio'];
$message_db=$this->request->data['email'];
$file=$this->request->form['file']['name'];


$this->loadmodel('society');
$conditions12=array('society_id'=>$s_society_id);
$result12=$this->society->find('all',array('conditions'=>$conditions12));
foreach($result12 as $data)
{
$s_name=$data['society']['society_name'];
}


$result_user_info=$this->requestAction(array('controller' => 'hms', 'action' => 'profile_picture'), array('pass' => array($s_user_id)));
foreach ($result_user_info as $collection2) 
{
$name=$collection2["user"]["user_name"];
$wing=$collection2["user"]["wing"];
$flat=$collection2["user"]["flat"];
$sender_email=$collection2["user"]["email"];
}
$wing_flat=$this->wing_flat($wing,$flat);
$result_society_info= $this->society_name($s_society_id);
foreach($result_society_info as $data_info)
{
	$society_name=$data_info['society']['society_name'];
}

$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
<br/>
<div>$message_db</div>
<br/>
<div style='color: #7B7B7B;'>Regards,</div>
<div style='color: #7B7B7B;'>$name&nbsp;&nbsp;$wing_flat</div>
<div style='color: #7B7B7B;'>$society_name</div>
</div >
</div>";


if(!empty($file))
{
$message_web.='<br/><a href="'.$ip.'/'.$this->webroot.'email_file/'.$file.'" download>Download attachment</a>';
}


$subject="[".$s_name."]-";
$subject.=htmlentities($this->request->data['subject']);



$target = "email_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 

$date=date("d-m-y");
$time=date('h:i:a',time());

if($radio==1)
{
$multi=$this->request->data['multi'];
$multi[]=$sender_email;

foreach($multi as $data)
{

$ex = explode(",", $data);
$user[]=$ex[0];
$to=$ex[1];
//echo $email[$i];
$this->send_email($to,'support@housingmatters.in','HousingMatters',$subject,$message_web,'support@housingmatters.in');
}




$email_id=$this->autoincrement('email_communication','email_id');
$this->loadmodel('email_communication');
$multipleRowData = Array( Array("email_id" => $email_id,"message_web"=>$message_web,"user_id"=>$user,"date"=>$date,"time"=>$time,"society_id"=>$s_society_id,"subject"=>$subject,"type"=>1,"file"=>$file,"deleted"=>0));
$this->email_communication->saveAll($multipleRowData); 
}

if($radio==2)
{
$user_new = array(); 
foreach ($result_group as $collection) 
{
$group_id=$collection["group"]["group_id"];

$g_id=@$this->request->data['grp'.$group_id];
if(!empty($g_id))
{
$groups_id[]=(int)$g_id;
$users=$collection["group"]["users"];
$user_new=array_merge($user_new,$users);
}
}
$result_user_unique = array_unique($user_new);

foreach ($result_user_unique as $data) 
{
$data=(int)$data;
$result_user_info=$this->requestAction(array('controller' => 'hms', 'action' => 'profile_picture'), array('pass' => array($data)));
foreach ($result_user_info as $collection2) 
{
$to=$collection2["user"]["email"];
$this->send_email($to,'support@housingmatters.in','HousingMatters',$subject,$message_web,'support@housingmatters.in');
}
}




$email_id=$this->autoincrement('email_communication','email_id');
$this->loadmodel('email_communication');
$multipleRowData = Array( Array("email_id" => $email_id,"message_web"=>$message_web,"user_id"=>$result_user_unique,"date"=>$date,"time"=>$time,"society_id"=>$s_society_id,"subject"=>$subject,"groups_id"=>$groups_id,"type"=>2,"file"=>$file,"deleted"=>0));
$this->email_communication->saveAll($multipleRowData); 
}

if($radio==3)
{
$visible=(int)$this->request->data['visible'];
	if($visible==1)
	{	
	$visible=1;
	$sub_visible[]=0;
	/////////////////////////////////////////// All user ////////////////////////////
	$this->loadmodel('user');
	$conditions=array('society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['email'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}
	/////////////////////////////////////////// All user ////////////////////////////
	}
	
	if($visible==4)
	{	
	$visible=4;
	$sub_visible[]=0;
	/////////////////////////////////////////// All Owners ////////////////////////////
	$this->loadmodel('user');
	$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['email'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}
	/////////////////////////////////////////// All Owners ////////////////////////////
	}
	
	if($visible==5)
	{
	$visible=5;
	$sub_visible[]=0;
	/////////////////////////////////////////// All Tenant ////////////////////////////
	$this->loadmodel('user');
	$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['email'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}
	/////////////////////////////////////////// All Tenant ////////////////////////////
	}
	
	if($visible==2)
	{	
	$visible=2;
	foreach ($role_result as $collection) 
	{
	$role_id=$collection["role"]["role_id"];

	$role_id=@(int)$this->request->data['role'.$role_id];
	if(!empty($role_id))
	{
	$sub_visible[]=(int)$role_id;

	/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////
	$this->loadmodel('user');
	$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['email'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}

	//////////////////////////////// end mail ////////////////////////////////////////////////////////	


	}
	}
	$da_user_id=array_unique($da_user_id);
	}
	
	if($visible==3)
	{	
	$visible=3;
	foreach ($wing_result as $collection) 
	{
	$wing_id=$collection["wing"]["wing_id"];

	$wing=@(int)$this->request->data['wing'.$wing_id];
	if(!empty($wing))
	{
	$sub_visible[]=(int)$wing;


	/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////
	$this->loadmodel('user');
	$conditions=array('wing'=>$wing_id,'society_id'=>$s_society_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result_user as $data)
	{
	$da_to[]=$data['user']['email'];
	$da_user_name[]=$data['user']['user_name'];
	$da_user_id[]=$data['user']['user_id'];
	}
	}
	}
	}
$da_to[]=$sender_email;
$da_user_id=array_unique($da_user_id);	
$da_to=array_unique($da_to);
$da_to=array_filter($da_to);


foreach($da_to as $data)
{

$ex = explode(",", $data);
if(!empty($ex[0])) { $to=$ex[0]; }


//echo $email[$i];
$this->send_email($to,'support@housingmatters.in','HousingMatters',$subject,$message_web,'support@housingmatters.in');
}




$email_id=$this->autoincrement('email_communication','email_id');
$this->loadmodel('email_communication');
$multipleRowData = Array( Array("email_id" => $email_id,"message_web"=>$message_web,"user_id"=>$da_user_id,"date"=>$date,"time"=>$time,"society_id"=>$s_society_id,"subject"=>$subject,"type"=>1,"file"=>$file,"deleted"=>0));
$this->email_communication->saveAll($multipleRowData); 

}


?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Email has been sent.
</div> 
<div class="modal-footer">
<a href="email_view" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php	

}
}


function email_view()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 

$this->loadmodel('email_communication');
$conditions=array("society_id"=>$s_society_id,"deleted"=>0);
$order=array('email_communication.email_id'=>'DESC');
$this->set('result_email',$this->email_communication->find('all',array('conditions'=>$conditions,'order'=>$order))); 
}



function email_view_ajax()
{
$this->layout='blank';
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 


$this->loadmodel('society');
$conditions12=array('society_id'=>$s_society_id);
$result12=$this->society->find('all',array('conditions'=>$conditions12));
foreach($result12 as $data)
{
$this->set('s_name',$data['society']['society_name']);
}


$id=(int)$this->request->query('id');

$this->loadmodel('email_communication');
$conditions=array("email_id"=>$id);
$this->set('result_eamilview',$this->email_communication->find('all',array('conditions'=>$conditions))); 

}

function email_delete()
{
$this->layout='blank';

$id=(int)$this->request->query('id');

$this->loadmodel('email_communication');
$this->email_communication->updateAll(array("deleted" => 1),array("email_id" => $id));

$this->response->header('Location', 'email_view');
}

function sms_delete()
{
$this->layout='blank';

$id=(int)$this->request->query('id');

$this->loadmodel('sms');
$this->sms->updateAll(array("deleted" => 1),array("sms_id" => $id));

$this->response->header('Location', 'message_view');
}


function testing_pdf(){
	
}
function email_view_pdf()
{
//$this->layout = 'pdf'; //this will use the pdf.ctp layout 
$this->ath(); 

$con=(int)$this->request->query('con');
$this->set('con',$con);

$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 


$this->loadmodel('email_communication');
$conditions=array("email_id"=>$con);
$this->set('result_eamilview',$this->email_communication->find('all',array('conditions'=>$conditions))); 
}

function sms_view_pdf()
{
//$this->layout = 'pdf'; //this will use the pdf.ctp layout 
$this->ath(); 

$con=(int)$this->request->query('con');
$this->set('con',$con);

$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 


$this->loadmodel('sms');
$conditions=array("sms_id"=>$con);
$this->set('result_smsview',$this->sms->find('all',array('conditions'=>$conditions))); 
}

//////////////////////////// Discussion fourm Approval /////////////////////////////

function discussion_forum_approval()
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
	$this->check_user_privilages();	
	$s_society_id=$this->Session->read('society_id');
	
	$this->loadmodel('discussion_post');
	$conditions=array('delete_id'=>4,'society_id'=>$s_society_id);
	$order=array('discussion_post.discussion_post_id'=>'DESC');
	$result=$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order));
	foreach($result as $dda)
	{
		 $id=(int)$dda['discussion_post']['discussion_post_id'];
		$this->seen_notification(3,$id);
		
	}
	
	$this->set('result_discussion',$result);
}

function discussion_forum_app_view()
{
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
		}else{
		$this->layout='session';
		}
			
		 $discu_id=(int)$this->request->query['con'];
		 $this->loadmodel('discussion_post');
		 $conditions=array('discussion_post_id'=>$discu_id);
		 $result_discussion=$this->discussion_post->find('all',array('conditions'=>$conditions));
	    $this->set('result_discussion',$result_discussion);
}


function discussion_forum_app_ajax()
{
	
		$this->layout='session';
		$ip=$this->hms_email_ip();
		$s_society_id=$this->Session->read('society_id');
		$discu_id=(int)$this->request->query('con');
		$this->loadmodel('discussion_post');
		$conditions=array('discussion_post_id'=>$discu_id);
		$result_discussion=$this->discussion_post->find('all',array('conditions'=>$conditions));
		foreach($result_discussion as $data)
		{
			$topic=$data['discussion_post']['topic'];
			$user_id=$data['discussion_post']['user_id'];
			$description=$data['discussion_post']['description'];
			$date=$data['discussion_post']['date'];
			   $newDate = date("d-m-y", strtotime($date));
			   $newDate1 = date("d-m-Y", strtotime($newDate));
			
			$time=$data['discussion_post']['time'];
			$visible=(int)$data['discussion_post']['visible'];
			$sub_visible=$data['discussion_post']['sub_visible'];
		}
		
			if($visible==1)
			{	
			$visible=1;
			$sub_visible[]=0;
			/////////////////////////////////////////// All user ////////////////////////////
			$result_user= $this->all_user_deactive();
			foreach($result_user as $data)
			{
			$da_to[]=$data['user']['email'];
			$da_user_name[]=$data['user']['user_name'];
			$da_user_id[]=$data['user']['user_id'];
			}
			/////////////////////////////////////////// All user ////////////////////////////
			}
			
			if($visible==4)
			{	
			$visible=4;
			$sub_visible=1;
			/////////////////////////////////////////// All Owners ////////////////////////////

			$result_user=$this->all_owner_deactive();
			foreach($result_user as $data)
			{
			$da_to[]=$data['user']['email'];
			$da_user_name[]=$data['user']['user_name'];
			$da_user_id[]=$data['user']['user_id'];
			}
			/////////////////////////////////////////// All Owners ////////////////////////////
			}
			if($visible==5)
			{
			$visible=5;
			$sub_visible=2;
			/////////////////////////////////////////// All Tenant ////////////////////////////

			$result_user=$this->all_tenant_deactive();
			foreach($result_user as $data)
			{
			$da_to[]=$data['user']['email'];
			$da_user_name[]=$data['user']['user_name'];
			$da_user_id[]=$data['user']['user_id'];
			}
			/////////////////////////////////////////// All Tenant ////////////////////////////
			}
			
			
			if($visible==2)
			{	
			$visible=2;
			foreach ($sub_visible as $collection) 
			{
			$role_id=$collection;
			/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////

			$result_user=$this->all_role_wise_deactive($role_id);
			foreach($result_user as $data)
			{
			$da_to[]=$data['user']['email'];
			$da_user_name[]=$data['user']['user_name'];
			$da_user_id[]=$data['user']['user_id'];
			}

			//////////////////////////////// end mail ////////////////////////////////////////////////////////	

			}
				$da_to=array_unique($da_to);
				$da_user_id=array_unique($da_user_id);
			}
				if($visible==3)
				{	
				$visible=3;
				foreach ($sub_visible as $collection) 
				{
				$wing_id=$collection;

				/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////

				$result_user=$this->all_wing_wise_deactive($wing_id);
				foreach($result_user as $data)
				{
				$da_to[]=$data['user']['email'];
				$da_user_name[]=$data['user']['user_name'];
				$da_user_id[]=$data['user']['user_id'];
				}

				//////////////////////////////// end mail ////////////////////////////////////////////////////////	

				}

				}
				$this->loadmodel('email');
				$conditions=array('auto_id'=>10);
				$result_email=$this->email->find('all',array('conditions'=>$conditions));
				foreach ($result_email as $collection) 
				{
				 $from=$collection['email']['from'];
				}
				
				$reply="donotreply@housingmatters.in";
				$from_name="HousingMatters";
				$sub=$topic;
				$result= $this->society_name($s_society_id);
				foreach($result as $data)
				{
				 $society_name=$data['society']['society_name'];
				 $dis_email_setting=@$data['society']['discussion_forum_email'];

				}
				
				$result_user=$this->profile_picture($user_id);
				foreach($result_user as $data1)
				{
				 $user_name_post=$data1['user']['user_name'];
				 $wing=$data1['user']['wing'];
				 $flat=$data1['user']['flat'];
				 $profile_pic=$data1['user']['profile_pic'];

				}
				$wing_flat=$this->wing_flat($wing,$flat);
		if($dis_email_setting==1)
		{				
		for($k=0;$k<sizeof($da_to);$k++)
		{				
			$to = @$da_to[$k];
			$d_user_id = @$da_user_id[$k];	 
			$user_name = @$da_user_name[$k];	
			
/* $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Hello  $user_name </p>
<p>A new topic is posted in your society Discussion Forum.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>New Discussion Topic</td>
<td>Posted by</td>
<td>Flat #</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$topic</td>
<td>$user_name_post</td>
<td>$wing_flat</td>
</tr>
</table>
<div>
<br/>
<center><p>To view or post response
<a href='$ip".$this->webroot."hms' ><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'> Click Here </button></a></p></center><br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div>
</div>"; 

	
	 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td width="40%" style="padding: 10px 0px 0px 10px;"><img src="'.$ip.$this->webroot.'as/hm/hm-logo.png" style="max-height: 60px; " height="50px" width="150" /></td>
									<td width="60%" align="right" valign="middle"  style="padding: 7px 10px 0px 0px;">
									<a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/fb.png"></a>
									<a href="#" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/tw.png"></a>
									<a href=""><img src="'.$ip.$this->webroot.'as/hm/ln.png" class="test" style="margin-left:5px;"></a>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Hello '.$user_name.' </span> <br>
										</td>
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> A new topic is posted in your society Discussion Forum. </span>
									</td>
																
								</tr>
								
								
								<tr>
									<td>
									
										<table  cellpadding="5" cellspacing="0" width="100%;"border="1" style="border:1px solid #e5e5e5;">
						
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >New Discussion Topic</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$topic.'</td>
										</tr>
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Posted by</td>
										<td align="left" style="background-color:#f8f8f8;"  >'.$user_name_post.'</td>
										</tr>
										
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;">Flat #</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$wing_flat.'</td>
										</tr>
										
										
									
										</table> 
									
									</td>
								
								
								
								</tr>
								
								
					
								<tr>
										<td style="padding:5px;" width="100%" align="center">
										<span style="color:rgb(100,100,99)">To view or post response  <a href="'.$ip.$this->webroot.'" style="width:100px; height:30px;"><span style="background-color:#00A0E3;color:white;"><button style="width:100px; height:30px;  background-color:#00A0E3;color:white" id="bg_color_m"> Click Here </button> </span></a> </span>
										</td>
								</tr>
					

								<tr>
								<td style="" width="100%" align="left">
								<p>Thank you. <br/> HousingMatters (Support Team)</p>
								<p align="justify">	www.housingmatters.co.in </p>
								</td>
								</tr>

					
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

*/

 $message_web='<div style="margin:0;padding:0" dir="ltr" bgcolor="#ffffff">
	<table style="border-collapse:collapse" border="0" cellpadding="0" cellspacing="0" width="100%;">
		<tbody>
			<tr>
				<td style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;background:#ffffff">
					<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
						<tbody>
							<tr>
								<td style="line-height:20px" colspan="3" height="20">&nbsp;</td>
							</tr>
							<tr>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td>
								<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
								<tbody>
								<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								<tr>
								<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td width="100%"><a href="#" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px" target="_blank"><span style="color:#00A0E3">Housing</span><span style="color:#777776">Matters</span></a></td>
								<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img  src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
									
								</td>
								</tr>
								<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								</tbody>
								</table>
								</td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
							</tr>
							<tr>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="line-height:28px" height="28">&nbsp;</td></tr><tr><td><span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:16px;line-height:21px;color:#141823">Hello  '.$user_name.'<br/>A new topic created in Discussion Forum</span></td></tr><tr><td style="line-height:14px" height="14">&nbsp;</td></tr><tr><td><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;border:solid 1px #e5e5e5;border-radius:2px;display:block"><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="padding:5px 10px;background:#269ABC;border-top:#cccccc 1px solid;border-bottom:#cccccc 1px solid"><span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:16px;line-height:19px;color:#FFF">'.$topic.'</span></td></tr><tr>
								<td style="padding:5px;">
								<table style="border-collapse:collapse" cellpadding="0" cellspacing="0"><tbody><tr><td style="padding-right:10px;font-size:0px" valign="middle"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img  src="'.$ip.$this->webroot.'profile/'.$profile_pic.'" style="border:0" height="50" width="50"></a></td>
								<td style="width:100%" valign="middle">
								<table style="border-collapse:collapse" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="2">
								<span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:16px;line-height:21px;color:#141823">'.$user_name_post.' '.$wing_flat.'</span><br/><span style="color:#ADABAB;font-size: 12px;">'.$newDate1.'&nbsp;&nbsp;'.$time.'</span></td></tr><tr><td style="line-height:10px" colspan="2" height="10">&nbsp;</td></tr><tr><td width="100%"></td></tr></tbody></table>
								</td>
								</tr></tbody></table>
								</td>
							</tr>
							<tr>
								<td style="padding:5px;" height="10">'.$description.'</td>
							</tr>
						</tbody>
					</table></td></tr></tbody></table></td></tr><tr><td style="line-height:14px" height="14">&nbsp;</td></tr></tbody></table></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
</tr>						<tr>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td>
									<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="line-height:2px" colspan="3" height="2">&nbsp;</td></tr><tr><td><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="border-collapse:collapse;border-radius:2px;text-align:center;display:block;border:1px solid #026A9E;background:#008ED5;padding:7px 16px 11px 16px"><a href="'.$ip.$this->webroot.'Discussions/index/'.$discu_id.'/0" style="color:#3b5998;text-decoration:none;display:block" target="_blank"><center><font size="3"><span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;white-space:nowrap;font-weight:bold;vertical-align:middle;color:#ffffff;font-size:14px;line-height:14px">View on HousingMatters</span></font></center></a></td></tr></tbody></table></a></td><td style="display:block;width:10px" width="10">&nbsp;&nbsp;&nbsp;</td><td><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="border-collapse:collapse;border-radius:2px;text-align:center;display:block;border:solid 1px #c9ccd1;background:#f6f7f8;padding:7px 16px 11px 16px"><a href="'.$ip.$this->webroot.'Discussions/index/'.$discu_id.'/0" style="color:#3b5998;text-decoration:none;display:block" target="_blank"><center><font size="3"><span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;white-space:nowrap;font-weight:bold;vertical-align:middle;color:#525252;font-size:14px;line-height:14px">Comment</span></font></center></a></td></tr></tbody></table></a></td><td width="100%"></td></tr><tr><td style="line-height:32px" colspan="3" height="32">&nbsp;</td></tr></tbody></table>
								</td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
							</tr>
							
							<tr>
								<td  width="15">&nbsp;&nbsp;&nbsp;</td>
						<td>
						<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
							<tbody>
								
								<tr>
								<td  align="left" valign="middle" width="">
								Thank you <br/>HousingMatters (Support Team)<br/>www.housingmatters.in
								
								</td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								
								
								</tr>
								
								</tbody>
						</table>
						</td>
								
					</tr>
							
						</tbody>
					</table>
				</td>
			</tr>
		</tbody>
	</table>
</div>';
		
$this->loadmodel('notification_email');
$conditions7=array("module_id" =>10,"user_id"=>$d_user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
$n=sizeof($result5);
	if($n>0)
	{
	@$subject.= 'Discussion: ['. $society_name . ']' .'  -   '.'New Discussion: '.$sub.'';
	$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
	$subject="";
	
	}	



}

}

////////// start code notification ///////////////////////////////





////////// end code notification ///////////////////////////////

$this->loadmodel('discussion_post');
$this->discussion_post->updateAll(array('delete_id'=>0,'users'=>$da_user_id),array('discussion_post_id'=>$discu_id));
$this->response->header('location','discussion_forum_approval');

	
}



function discussion_forum_app_reject()
{
	
	$this->layout="blank";
	$descussion_p_id=(int)$this->request->query('con');
	$this->loadmodel('discussion_post');
	$this->discussion_post->updateAll(array('delete_id'=>5),array('discussion_post_id'=>$descussion_p_id));
	$this->response->header('location','discussion_forum_approval');
}
//////////////////////// End Discussion fourm approval ///////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////	
/////////////////////////////////////////////////////start discussion//////////////////////
////////////////////////////////////////////////////////////////////////////////////////	
function discussion_forum()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
$t=(int)$this->request->query('t');
$this->set('t',$t);
$list=(int)$this->request->query('list');
$this->set('list',$list);
$new=(int)$this->request->query('new');
$this->set('new',$new);

$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id');
$this->set('s_user_id',$s_user_id);
$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$wing=$this->Session->read('wing');

$this->seen_notification(3,$t);

//////////////////////current user info///////////////
$result_self=$this->profile_picture($s_user_id);
foreach($result_self as $data3)
{
$this->set('user_name',$data3["user"]["user_name"]);
$wing=$data3["user"]["wing"];
$flat=$data3["user"]["flat"];
}
$this->set('flat_info',$this->wing_flat($wing,$flat));
//////////////////////current user info///////////////

$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('role_result',$role_result);

$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
$this->set('wing_result',$wing_result);



///////////////////////start new topic//////////////////////////////////

$result_soc=$this->society_name($s_society_id);
	foreach($result_soc as $data)
	{
		@$discussion_forum1=$data['society']['discussion_forum'];
		//@$s_duser_id=$data['society']['user_id'];
	}
if($discussion_forum1==1 && $s_role_id!=3)
{
	if ($this->request->is('post')) 
	{
		
		 $text=htmlentities($this->request->data['topic']);
		$topic = wordwrap($text, 25, " ", true);

		$text12=htmlentities($this->request->data['description']);
		 $description = nl2br(wordwrap($text12, 25, " ", true));

		$file=$this->request->form['file']['name'];

		$target = "discussion_file/";
		$target=@$target.basename( @$this->request->form['file']['name']);
		$ok=1;
		move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 

		$date=date("d-m-y");
		 $time=date('h:i:a',time());
		$visible=(int)$this->request->data['visible'];
			if($visible==1)
			{	
			$visible=1;
			$sub_visible[]=0;
			}

			if($visible==4)
			{	
			$visible=4;
			$sub_visible[]=0;
			}

			if($visible==5)
			{
			$visible=5;
			$sub_visible[]=0;
			}
			if($visible==2)
					{	
						$visible=2;
						foreach ($role_result as $collection) 
						{
							$role_id=$collection["role"]["role_id"];

							$role_id=@(int)$this->request->data['role'.$role_id];
							if(!empty($role_id))
							{
							$sub_visible[]=(int)$role_id;
							}
						}
					}
		
			if($visible==3)
					{	
					 $visible=3;
						foreach ($wing_result as $collection) 
						{
							$wing_id=(int)$collection["wing"]["wing_id"];

							$wing=@(int)$this->request->data['wing'.$wing_id];
							if(!empty($wing))
							{
								$sub_visible[]=(int)$wing;
							}
						}
					}
					
					
 $discussion_post_id=$this->autoincrement('discussion_post','discussion_post_id');
$this->loadmodel('discussion_post');
$multipleRowData = Array( Array("discussion_post_id" => $discussion_post_id, "user_id" => $s_user_id , "society_id" => $s_society_id, "topic" => $topic,"description" => $description, "file" =>$file,"delete_id" =>4, "date" =>$date, "time" => $time, "visible" => $visible, "sub_visible" => $sub_visible));
$this->discussion_post->saveAll($multipleRowData); 
					
	?>
                

				<!----alert-------------->
				<div class="modal-backdrop fade in"></div>
				<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
				<div class="modal-body" style="font-size:16px;">
				Discussion Forum are sent for approval.
				</div> 
				<div class="modal-footer">
				<a href="discussion_forum" class="btn green">OK</a>
				</div>
				</div>
				<!----alert-------------->
								
                
                
                
   <?php						
		
		
		
	}
}
else
{
	
	
if($this->request->is('post')) 
{
	
	$ip=$this->hms_email_ip();
$text=htmlentities($this->request->data['topic']);
$topic = wordwrap($text, 25, " ", true);

$text12=htmlentities($this->request->data['description']);
$description = nl2br(wordwrap($text12, 25, " ", true));

$file=$this->request->form['file']['name'];

$target = "discussion_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 

$date=date("d-m-y");
$time=date('h:i:a',time());

$visible=(int)$this->request->data['visible'];
if($visible==1)
{	
$visible=1;
$sub_visible[]=0;
/////////////////////////////////////////// All user ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_user_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All user ////////////////////////////
}

if($visible==4)
{	
$visible=4;
$sub_visible[]=0;
/////////////////////////////////////////// All Owners ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_owner_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Owners ////////////////////////////
}

if($visible==5)
{
$visible=5;
$sub_visible[]=0;
/////////////////////////////////////////// All Tenant ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_tenant_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Tenant ////////////////////////////
}


if($visible==2)
{	
$visible=2;
foreach ($role_result as $collection) 
{
$role_id=$collection["role"]["role_id"];

$role_id=@(int)$this->request->data['role'.$role_id];
if(!empty($role_id))
{
$sub_visible[]=(int)$role_id;

/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_role_wise_deactive($role_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	


}
}
$da_to=array_unique($da_to);
}

if($visible==3)
{	
$visible=3;
foreach ($wing_result as $collection) 
{
$wing_id=$collection["wing"]["wing_id"];

$wing=@(int)$this->request->data['wing'.$wing_id];
if(!empty($wing))
{
$sub_visible[]=(int)$wing;


/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('wing'=>$wing_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_wing_wise_deactive($wing_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	



}
}

}

///////////////////// send email creator code start ///////////////////////

$result_user=$this->profile_picture($s_user_id);

	foreach($result_user as $data)
	{
		 $c_email=$data['user']['email'];
		 $c_user_id=$data['user']['user_id'];
		 $c_user_name=$data['user']['user_name'];
		
	}
	$da_to[]=$c_email;
	$da_user_name[]=$c_user_name;
	$da_user_id[]=$c_user_id;

	$da_to=array_unique($da_to);
	$da_user_name=array_unique($da_user_name);
	$da_user_id=array_unique($da_user_id);

//////////////////  End Code //////////////////////////////////////////




$discussion_post_id=$this->autoincrement('discussion_post','discussion_post_id');
$this->loadmodel('discussion_post');
$multipleRowData = Array( Array("discussion_post_id" => $discussion_post_id, "user_id" => $s_user_id , "society_id" => $s_society_id, "topic" => $topic,"description" => $description, "file" =>$file,"delete_id" =>0, "date" =>$date, "time" => $time, "visible" => $visible, "sub_visible" => $sub_visible,"users"=>$da_user_id));
$this->discussion_post->saveAll($multipleRowData); 
$this->response->header('Location', 'discussion_delete_topic');



////////////////////////////////////////////// Email Code Start ////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////


$this->loadmodel('email');
$conditions=array('auto_id'=>10);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$reply="donotreply@housingmatters.in";
$from_name="HousingMatters";
$sub="New Topic";
$result= $this->society_name($s_society_id);
foreach($result as $data)
{
	$society_name=$data['society']['society_name'];
	$dis_email_setting=$data['society']['discussion_forum_email'];

}

$result_user=$this->profile_picture($s_user_id);
foreach($result_user as $data1)
{
$user_name_post=$data1['user']['user_name'];
$wing=$data1['user']['wing'];
$flat=$data1['user']['flat'];

}
$wing_flat=$this->wing_flat($wing,$flat);
if($dis_email_setting==1)
{
for($k=0;$k<sizeof($da_to);$k++)
{
$to = @$da_to[$k];
$d_user_id = @$da_user_id[$k];	 
$user_name = @$da_user_name[$k];	

$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Hello  $user_name </p>
<p>A new topic is posted in your society Discussion Forum.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>New Discussion Topic</td>
<td>Posted by</td>
<td>Flat #</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$topic</td>
<td>$user_name_post</td>
<td>$wing_flat</td>
</tr>
</table>
<div>
<br/>
<center><p>To view or post response
<a href='$ip".$this->webroot."hms' ><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'> Click Here </button></a></p></center><br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div>
</div>";
$this->loadmodel('notification_email');
$conditions7=array("module_id" =>10,"user_id"=>$d_user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
$n=sizeof($result5);
if($n>0)
{
@$subject.= ''. $society_name . '  ' .'     '.' '.$sub.'';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}	
}
}


////////////////////////////////////////////End Mail Functionality //////////////////////////////////////
///////////////////////////////////////////////////////////////////////////


}
	
	
	
}



///////////////////////End start new topic//////////////////////////////////


$this->loadmodel('discussion_post');

if($list==0 or empty($list))
{
	$conditions =array( '$or' => array( 
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>1),
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>4),
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>5)
	));
}
if($list==1)
{
	$conditions =array( '$or' => array( 
	array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>1),
	array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
	array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
	array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>4),
	array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>5)
	));
}
if($list==2)
{
	$conditions =array( '$or' => array( 
	array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>1),
	array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
	array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
	array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>4),
	array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>5)
	));
}

$order=array('discussion_post.discussion_post_id'=>'DESC');
$this->set('result_discussion',$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order)));   


$this->loadmodel('discussion_post');
if(empty($t)){
	$conditions =array( '$or' => array( 
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>1),
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>4),
	array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>5)
	));
}
else{
	$this->loadmodel('discussion_post');
	$conditions=array('discussion_post_id' =>$t,'users' =>array('$in' => array($s_user_id)));
	$count=$this->discussion_post->find('count',array('conditions'=>$conditions));
	if($count>0){	$conditions=array('discussion_post_id' =>$t);	}
	else{
		
		$conditions =array( '$or' => array( 
		array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>1),
		array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
		array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
		array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>4),
		array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>5)
		));
	
	}
}

$order=array('discussion_post.discussion_post_id'=>'DESC');
$result_discussion_last=$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1));
foreach($result_discussion_last as $data2)
{
$discussion_post_id=(int)$data2["discussion_post"]["discussion_post_id"];
}
$this->set('result_discussion_last',$result_discussion_last);
$this->set('last_discussion_post_id',@$discussion_post_id); 	

$this->loadmodel('discussion_comment');
$conditions =array( '$or' => array( 
array('discussion_post_id' =>@$discussion_post_id,'delete_id' =>0),array('discussion_post_id' =>@$discussion_post_id,'delete_id' =>2)));
//$conditions=array("discussion_post_id"=>@$discussion_post_id,"delete_id"=>0);
$this->set('result_comment_last',$this->discussion_comment->find('all',array('conditions'=>$conditions))); 
}

function discussion()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	 clearCache();
$this->ath(); 
$this->check_user_privilages();

$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id');
$this->set('s_user_id',$s_user_id);
$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$wing=$this->Session->read('wing');

//////////////////////current user info///////////////
$result_self=$this->profile_picture($s_user_id);
foreach($result_self as $data3)
{
$this->set('user_name',$data3["user"]["user_name"]);
$wing=$data3["user"]["wing"];
$flat=$data3["user"]["flat"];
}
$this->set('flat_info',$this->wing_flat($wing,$flat));
//////////////////////current user info///////////////

$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->set('role_result',$role_result);

$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
$this->set('wing_result',$wing_result);



///////////////////////start new topic//////////////////////////////////
if ($this->request->is('post')) 
{
	$ip=$this->hms_email_ip();
$text=htmlentities($this->request->data['topic']);
$topic = wordwrap($text, 25, " ", true);

$text12=htmlentities($this->request->data['description']);
$description = nl2br(wordwrap($text12, 25, " ", true));

$file=$this->request->form['file']['name'];

$target = "discussion_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 

$date=date("d-m-y");
$time=date('h:i:a',time());

$visible=(int)$this->request->data['visible'];
if($visible==1)
{	
$visible=1;
$sub_visible[]=0;
/////////////////////////////////////////// All user ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_user_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All user ////////////////////////////
}

if($visible==4)
{	
$visible=4;
$sub_visible[]=0;
/////////////////////////////////////////// All Owners ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_owner_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Owners ////////////////////////////
}

if($visible==5)
{
$visible=5;
$sub_visible[]=0;
/////////////////////////////////////////// All Tenant ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_tenant_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Tenant ////////////////////////////
}


if($visible==2)
{	
$visible=2;
foreach ($role_result as $collection) 
{
$role_id=$collection["role"]["role_id"];

$role_id=@(int)$this->request->data['role'.$role_id];
if(!empty($role_id))
{
$sub_visible[]=(int)$role_id;

/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_role_wise_deactive($role_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	


}
}
$da_to=array_unique($da_to);
}

if($visible==3)
{	
$visible=3;
foreach ($wing_result as $collection) 
{
$wing_id=$collection["wing"]["wing_id"];

$wing=@(int)$this->request->data['wing'.$wing_id];
if(!empty($wing))
{
$sub_visible[]=(int)$wing;


/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('wing'=>$wing_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_wing_wise_deactive($wing_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	



}
}

}

$discussion_post_id=$this->autoincrement('discussion_post','discussion_post_id');
$this->loadmodel('discussion_post');
$multipleRowData = Array( Array("discussion_post_id" => $discussion_post_id, "user_id" => $s_user_id , "society_id" => $s_society_id, "topic" => $topic,"description" => $description, "file" =>$file,"delete_id" =>0, "date" =>$date, "time" => $time, "visible" => $visible, "sub_visible" => $sub_visible));
$this->discussion_post->saveAll($multipleRowData); 
$this->response->header('Location', 'discussion_delete_topic');



////////////////////////////////////////////// Email Code Start ////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////


$this->loadmodel('email');
$conditions=array('auto_id'=>10);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$reply="donotreply@housingmatters.in";
$from_name="HousingMatters";
$sub="New Topic";
$result= $this->society_name($s_society_id);
foreach($result as $data)
{
	$society_name=$data['society']['society_name'];
	$dis_email_setting=$data['society']['discussion_forum_email'];

}

$result_user=$this->profile_picture($s_user_id);
foreach($result_user as $data1)
{
$user_name_post=$data1['user']['user_name'];
$wing=$data1['user']['wing'];
$flat=$data1['user']['flat'];

}
$wing_flat=$this->wing_flat($wing,$flat);
if($dis_email_setting==1)
{
for($k=0;$k<sizeof($da_to);$k++)
{
$to = @$da_to[$k];
$d_user_id = @$da_user_id[$k];	 
$user_name = @$da_user_name[$k];	

$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Hello  $user_name </p>
<p>A new topic is posted in your society Discussion Forum.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>New Discussion Topic</td>
<td>Posted by</td>
<td>Flat #</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$topic</td>
<td>$user_name_post</td>
<td>$wing_flat</td>
</tr>
</table>
<div>
<br/>
<center><p>To view or post response
<a href='$ip".$this->webroot."hms' ><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'> Click Here </button></a></p></center><br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div>
</div>";
$this->loadmodel('notification_email');
$conditions7=array("module_id" =>10,"user_id"=>$d_user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
$n=sizeof($result5);
if($n>0)
{
@$subject.= ''. $society_name . '  ' .'     '.' '.$sub.'';
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}	
}
}


////////////////////////////////////////////End Mail Functionality //////////////////////////////////////
///////////////////////////////////////////////////////////////////////////


}
///////////////////////End start new topic//////////////////////////////////


$this->loadmodel('discussion_post');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>1),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>4),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>5)
));
$order=array('discussion_post.discussion_post_id'=>'DESC');
$this->set('result_discussion',$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order)));   


$this->loadmodel('discussion_post');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>1),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>4),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>5)
));
$order=array('discussion_post.discussion_post_id'=>'DESC');
$result_discussion_last=$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1));
foreach($result_discussion_last as $data2)
{
$discussion_post_id=(int)$data2["discussion_post"]["discussion_post_id"];
}
$this->set('result_discussion_last',$result_discussion_last);
$this->set('last_discussion_post_id',@$discussion_post_id); 	

$this->loadmodel('discussion_comment');
$conditions =array( '$or' => array( 
array('discussion_post_id' =>@$discussion_post_id,'delete_id' =>0),array('discussion_post_id' =>@$discussion_post_id,'delete_id' =>2)));
//$conditions=array("discussion_post_id"=>@$discussion_post_id,"delete_id"=>0);
$this->set('result_comment_last',$this->discussion_comment->find('all',array('conditions'=>$conditions))); 
}


function discussion_pdf()
{
$this->layout = 'pdf'; //this will use the pdf.ctp layout 
$this->ath(); 

$con=(int)$this->request->query('con');
$this->set('con',$con);

$s_user_id=$this->Session->read('user_id'); 
$this->set('s_user_id',$s_user_id);
$s_society_id=$this->Session->read('society_id'); 


$this->loadmodel('discussion_post');
$conditions=array("discussion_post_id"=>$con);
$this->set('result_topic_view',$this->discussion_post->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('discussion_comment');
$conditions=array("discussion_post_id"=>$con,"delete_id"=>0);
$order=array('discussion_comment.discussion_comment_id'=>'ASC');
$this->set('result_comment',$this->discussion_comment->find('all',array('conditions'=>$conditions,'order'=>$order))); 

}



function discussion_delete_topic()
{
$this->layout='blank';
$s_society_id=$this->Session->read('society_id'); 

$con=(int)$this->request->query('con');
if($con==0) { $this->response->header('Location', 'discussion_forum'); }

$this->loadmodel('discussion_post');
$this->discussion_post->updateAll(array("delete_id" =>1),array("discussion_post_id" => $con));
$this->response->header('Location', 'discussion_forum');
}

function discussion_comment_delete_ajax()
{
$this->layout='blank';

$s_society_id=$this->Session->read('society_id'); 

$c_id=(int)$this->request->query('c_id');

$this->loadmodel('discussion_comment');
$this->discussion_comment->updateAll(array("delete_id" =>1),array("discussion_comment_id" => $c_id));
//$this->response->header('Location', 'discussion');
}



function discussion_delete_topic_archive()
{
	$this->layout='blank';
	$s_society_id=$this->Session->read('society_id'); 
	$con=(int)$this->request->query('con');
	if($con==0) { $this->response->header('Location', 'discussion'); }
	$this->loadmodel('discussion_post');
	$this->discussion_post->updateAll(array("delete_id" =>2),array("discussion_post_id" => $con));
	$this->response->header('Location', 'discussion');
	
}


function discussion_my_topic()
{
$this->layout='blank';
$s_user_id=$this->Session->read('user_id');
$this->set('s_user_id',$s_user_id);
$s_society_id=$this->Session->read('society_id'); 

$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$wing=$this->Session->read('wing');

$q=(int)$this->request->query('q');
$this->set('q',$q);

if($q==1)
{
$this->loadmodel('discussion_post');
$conditions =array( '$or' => array( 
array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>1),
array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>4),
array('user_id' =>$s_user_id,'delete_id' =>0,'visible' =>5)
));
$order=array('discussion_post.discussion_post_id'=>'DESC');
$this->set('result_my_topic',$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order)));   
}

if($q==2)
{
$this->loadmodel('discussion_post');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>1),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>4),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>5)
));
$order=array('discussion_post.discussion_post_id'=>'DESC');
$this->set('result_all_topic',$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order)));   
}

if($q==3)
{
$this->loadmodel('discussion_post');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>1),
array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>4),
array('society_id' =>$s_society_id,'delete_id' =>1,'visible' =>5)
));
$order=array('discussion_post.discussion_post_id'=>'DESC');
$this->set('result_deleted_topic',$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order)));   
}
}

function discussion_search_topic()
{
$this->layout='blank';
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id');

$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$wing=$this->Session->read('wing');

$s=$this->request->query('s');
$regex = new MongoRegex("/.*$s.*/i");


$this->loadmodel('discussion_post');
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>1,'topic' =>$regex),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>2,'topic' =>$regex,'sub_visible' =>array('$in' => array($role_id))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>3,'topic' =>$regex,'sub_visible' =>array('$in' => array($wing))),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>4,'topic' =>$regex),
array('society_id' =>$s_society_id,'delete_id' =>0,'visible' =>5,'topic' =>$regex)
));
$order=array('discussion_post.discussion_post_id'=>'DESC');
$this->set('result_all_topic',$this->discussion_post->find('all',array('conditions'=>$conditions,'order'=>$order))); 

}

function topic_view()
{
$this->layout='blank';
$s_user_id=$this->Session->read('user_id'); 
$this->set('s_user_id',$s_user_id);
$s_society_id=$this->Session->read('society_id'); 
$t=(int)$this->request->query('t');
$this->set('t',$t);

$this->loadmodel('discussion_post');
$conditions=array("discussion_post_id"=>$t);
$this->set('result_topic_view',$this->discussion_post->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('discussion_comment');
//$conditions=array("discussion_post_id"=>$t,"delete_id"=>0);
$conditions =array( '$or' => array( 
array('discussion_post_id' =>$t,'delete_id' =>0),array('discussion_post_id' =>$t,'delete_id' =>2)));

$order=array('discussion_comment.discussion_comment_id'=>'ASC');
$this->set('result_comment',$this->discussion_comment->find('all',array('conditions'=>$conditions,'order'=>$order))); 
}

function discussion_comment_refresh()
{
$this->layout='blank';
$s_user_id=$this->Session->read('user_id'); 
$this->set('s_user_id',$s_user_id);
$s_society_id=$this->Session->read('society_id'); 
$t_id=(int)$this->request->query('con');
$this->set('t_id',$t_id);

$this->loadmodel('discussion_comment');
//$conditions=array("discussion_post_id"=>$t_id,"delete_id"=>0);
$conditions =array( '$or' => array( 
array('discussion_post_id' =>$t_id,'delete_id' =>0),array('discussion_post_id' =>$t_id,'delete_id' =>2)));
$order=array('discussion_comment.discussion_comment_id'=>'ASC');
$this->set('result_comment_ref',$this->discussion_comment->find('all',array('conditions'=>$conditions,'order'=>$order)));
}


function discussion_offensive_delete_ajax()
{
$this->layout='blank';
$s_society_id=$this->Session->read('society_id'); 
$co_id=(int)$this->request->query('c_id');
$c_u_id=(int)$this->request->query('c_u_id');
$this->loadmodel('discussion_comment');
$conditions=array('discussion_comment_id' => $co_id);
$result= $this->discussion_comment->find('all',array('conditions'=>$conditions));
foreach($result as $data)
{
$r=$data['discussion_comment']['offensive_user'];	
}
if(!empty($r))
{
array_push($r,$c_u_id);
}
else
{
$r=array($c_u_id);
}
$this->loadmodel('discussion_comment');
$this->discussion_comment->updateAll(array("delete_id" =>2,'offensive_user'=>$r),array("discussion_comment_id" => $co_id));

}

function discussion_offensive_view()
{
$this->layout="session";
$s_society_id=$this->Session->read('society_id'); 
$this->loadmodel('discussion_comment');
$conditions=array('society_id'=>$s_society_id,'delete_id'=>2);
$result=$this->discussion_comment->find('all',array('conditions'=>$conditions));
$this->set('result_discussion_comment',$result);	
}


function discussion_offensive_delete_ajax1()
{
$this->layout="blank";
$co_id=(int)$this->request->query('con');
$this->loadmodel('discussion_comment');
$this->discussion_comment->updateAll(array("delete_id" =>3),array("discussion_comment_id" => $co_id));
$this->response->header('Location', 'discussion_offensive_view');

}


function topic_view_deleted()
{
$this->layout='blank';
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 
$t=(int)$this->request->query('t');
$this->set('t',$t);

$this->loadmodel('discussion_post');
$conditions=array("discussion_post_id"=>$t);
$this->set('result_topic_view',$this->discussion_post->find('all',array('conditions'=>$conditions))); 

$this->loadmodel('discussion_comment');
$conditions=array("discussion_post_id"=>$t,"delete_id"=>0);
$this->set('result_comment',$this->discussion_comment->find('all',array('conditions'=>$conditions))); 
}


function discussion_save_comment()
{
$this->layout='blank';
$this->ath(); 
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 
$tid=(int)$this->request->query('tid');
$g=$this->request->query('c');
$c=htmlentities(wordwrap($g, 25, " ", true));
$c_mod=explode(' ',$g);
$c=nl2br($c);
$date=date("d-m-y");
$time=date('h:i:a',time());
$r=$this->content_moderation_society($c_mod);

if($r==0)
{
echo $word='You have enter wrong word  <br/> ';
exit;
	
}
else
{
	
$this->loadmodel('discussion_comment');
$conditions=array("delete_id"=>0);
$order=array('discussion_comment.discussion_comment_id'=>'DESC');
$cursor_last_color=$this->discussion_comment->find('all',array('conditions'=>$conditions,'order'=>$order,'limit'=>1));
foreach ($cursor_last_color as $collection_color) 
{
$last_color=$collection_color["discussion_comment"]["color"];
}
if(sizeof($cursor_last_color)==0) {  $last_color='blue'; }
$color_in=$this->rendom_color($last_color);
//////////////////end color///////////////////

$discussion_comment_id=$this->autoincrement('discussion_comment','discussion_comment_id');
$this->loadmodel('discussion_comment');
$multipleRowData = Array( Array("discussion_comment_id" => $discussion_comment_id, "user_id" => $s_user_id , "society_id" => $s_society_id, "comment" => $c,"discussion_post_id" => $tid, "delete_id" =>0, "date" =>$date, "time" => $time, "color" => $color_in));
$this->discussion_comment->saveAll($multipleRowData); 

	
}


 //////////////// Moderation content check start ///////////////////////////
/*
$this->loadmodel('society');
$conditions=array('society_id'=>$s_society_id);
$result1=$this->society->find('all',array('conditions'=>$conditions));
foreach($result1 as $data)
{
  $content=$data['society']['content_moderation'];

}


foreach($c_mod as $c_moda)
{
if(in_array($c_moda,$content))
{
echo $word='You have enter wrong word  <br/> ';
exit;
}
}
*/
//////////////////color///////////////////




////////////////// Modaration content check End ///////////////////////


}

function count_comment_of_topic($id)
{
	$this->layout='blank';
	$id=(int)$this->decode($id,'housingmatters');
	$this->loadmodel('discussion_comment');
	$conditions =array( '$or' => array( 
	array('discussion_post_id' =>$id,'delete_id' =>0),array('discussion_post_id' =>$id,'delete_id' =>2)));
	return $this->discussion_comment->find('count',array('conditions'=>$conditions)); 

}

///////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////end of discussion forum//////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////  ALL  Repotr start /////////////////////////////////////


function all_report()
{

$this->layout='session';	




}

function contact_report()
{
$this->layout='session';
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('user');
$conditions=array('society_id'=>$s_society_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
$this->set('result_user',$result);


}

function log_user($da_user_id)
{
	
$this->loadmodel('log');
$conditions=array('user_id'=>$da_user_id);
return $result=$this->log->find('all',array('conditions'=>$conditions));	

}


function log_all_report()
{
	$this->layout='session';
	$id=(int)$this->request->query('con');
	$this->loadmodel('log');
	$conditions=array('user_id'=>$id,'status'=>0);
	$order=array('log.log_id'=> 'DESC');
	$result=$this->log->find('all',array('conditions'=>$conditions,'order'=>$order));
	$this->set('result_log',$result);
}


function login_report_user()
{
$this->layout='session';
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('user');
$conditions=array('society_id'=>$s_society_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
$this->set('result_user',$result);
}

function exited_member_report(){
$this->layout='session';
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('user_flat');
$conditions=array('society_id'=>$s_society_id,'exited'=>"yes");
$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions));
$this->set('result_user_flat',$result_user_flat);

}

function profile_report()
{

$this->layout='session';
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('user');
$conditions=array('society_id'=>$s_society_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
$this->set('result_user',$result);


}

function profile_log($id)
{
	
$this->loadmodel('profile_log');
$conditions=array('user_id'=>$id);
return $result=$this->profile_log->find('all',array('conditions'=>$conditions));

}

function profile_all_report()
{
	$this->layout='session';
	$id=(int)$this->request->query('con');
	$this->loadmodel('profile_log');
	$conditions=array('user_id'=>$id);
	$order=array('profile_log.profile_log_id'=> 'DESC');
	$result=$this->profile_log->find('all',array('conditions'=>$conditions,'order'=>$order));
	$this->set('result_profile_log',$result);
	
}
function login_report_unit()
{

$this->layout='session';
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('user');
$conditions=array('society_id'=>$s_society_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
$this->set('result_user',$result);
}

function financial_year_log(){

$this->ath();
	$this->layout='session';
	$s_society_id=$this->Session->read('hm_society_id');
    $s_user_id=$this->Session->read('hm_user_id');
	$this->loadmodel('financial_year_log');
	$conditions=array("society_id" => $s_society_id);
	$result_financial_year_log = $this->financial_year_log->find('all',array('conditions'=>$conditions));
	
	$this->set(compact('result_financial_year_log'));
}

function complaint_closed_report()
{

$this->layout="session";	
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');
$this->loadmodel('help_desk');
$conditions=array("help_desk_status" =>1,"society_id" => $s_society_id);
$order=array('help_desk.ticket_id'=> 'DESC');
$result=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order));
$this->set('result_help_desk',$result);



}


function complaint_open_report()
{
$this->layout="session";
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');
$this->loadmodel('help_desk');
$conditions=array("help_desk_status" => 0,"society_id" => $s_society_id);
$order=array('help_desk.ticket_id'=> 'DESC');
$result_help_desk=$this->help_desk->find('all',array('conditions'=>$conditions,'order' =>$order));
$this->set('result_help_desk',$result_help_desk);

}



function sp_performance_report()
{
$this->layout="session";
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');


if($this->request->is('post')) 
{
 $this->set('date1',$this->request->data['from']);
 $this->set('date2',$this->request->data['to']);
 
 $this->loadmodel('help_desk');
$conditions=array('society_id'=>$s_society_id,'help_desk.help_desk_service_provider_id'=> array('$ne' => 0));
$result12=$this->help_desk->find('all',array('conditions'=>$conditions));
$this->set('result_help_desk',$result12);
	
}

}


function sp_performance_report_pdf()
{

$this->layout="pdf";
$this->layout="session";
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');
 $date1=$this->request->query('con');
 $date2=$this->request->query('con2');

$this->loadmodel('help_desk');
$conditions=array('society_id'=>$s_society_id,'help_desk.help_desk_service_provider_id'=> array('$ne' => 0));
$result12=$this->help_desk->find('all',array('conditions'=>$conditions));
$this->set('result_help_desk',$result12);
App::import('Vendor','xtcpdf');  
$tcpdf = new XTCPDF(); 
$textfont = 'freesans'; // looks better, finer, and more condensed than 'dejavusans' 
$tcpdf->SetAuthor("KBS Homes & Properties at http://kbs-properties.com"); 
$tcpdf->SetAutoPageBreak( true ); 
//$tcpdf->setHeaderFont(array($textfont,'',40)); 
$tcpdf->xheadercolor = array(255,255,255); 
$tcpdf->xheadertext = ''; 
$tcpdf->xfootertext = 'HousingMatters'; 
$tcpdf->AddPage(); 
$tcpdf->SetTextColor(0, 0, 0); 
$tcpdf->SetFont($textfont,'N',12);
$html='
<div style="background-color:#EFEFEF; border-top:1px solid #e6e6e6; border-bottom:1px solid #e6e6e6; padding:10px; box-shadow:5px; font-size:16px; color:#006;">
Service Provider Performance Report
</div>
<br>
<table><tr><th><b>Sr No.</b></th>
<th><b>Ticket</b></th>
<th><b>Service Provider</b></th>
<th><b>Assigned Date</b></th>
<th><b>Closure Date</b></th>
<th><b>Average</b></th></tr>';
$i=0;
foreach($result12 as $data)
{
 $avg='';
$assign_date=$data['help_desk']['help_desk_assign_date'];
$close_date=@$data['help_desk']['help_desk_close_date'];
$help_desk_date=$data['help_desk']['help_desk_date'];
$sp_id=$data['help_desk']['help_desk_service_provider_id'];
$ticket_id=$data['help_desk']['ticket_id'];
 $help_desk_date1=date("d-m-Y", strtotime($help_desk_date));
 $help_desk_date2 = date("Y-m-d", strtotime($help_desk_date1));
 $help_desk_date3 = date("d-m-Y", strtotime($help_desk_date2));

if(!empty($assign_date) && !empty($close_date))
{
$newDate = date("d-m-Y", strtotime($assign_date));
$newDate1 = date("Y-m-d", strtotime($newDate));
$newDate2 = date("d-m-Y", strtotime($close_date));
$newDate3 = date("Y-m-d", strtotime($newDate2));
$datetime1 = date_create($newDate1);
$datetime2 = date_create($newDate3);
$interval = date_diff($datetime1, $datetime2);
$avg= $interval->format('%R%a days');
}
$sp=$this->fetch_service_provider_info_via_vendor_id($sp_id);
foreach($sp as $data)
{
	$sp_name=$data['service_provider']['sp_name'];
	
}
if(strtotime($date1)<=strtotime($help_desk_date3) && strtotime($date2)>=strtotime($help_desk_date3))
{
$i++;
$html.='
<tr>
<td>'.$i .'</td>
<td>'.$ticket_id.'</td>
<td>'.$sp_name.'</td>
<td>'.$assign_date.'</td>
<td>'.$close_date.'</td>
<td>'.$avg.'</td></tr>
';
} }
$html.="</table>";
$tcpdf->writeHTML($html);
echo $tcpdf->Output('sp_report.pdf', 'D'); 
}

////////////////////////////////////////////  End Report  ////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////



//Start Resource//
function resource_add()
{
	$this->layout='session';
	$this->ath();
	$this->check_user_privilages();
	$s_society_id=$this->Session->read('hm_society_id');
	$s_role_id=$this->Session->read('hm_role_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$this->set('role_id',$s_role_id=$this->Session->read('role_id')); 
	$this->loadmodel('resource_category');
	$this->set('result_resource_category',$this->resource_category->find('all'));  
	$this->loadmodel('role');
	$conditions=array("society_id" => $s_society_id);
	$role_result=$this->role->find('all',array('conditions'=>$conditions));
	$this->set('role_result',$role_result);
	$this->loadmodel('wing');
	$wing_result=$this->wing->find('all');
	$this->set('wing_result',$wing_result);


	$result=$this->society_name($s_society_id);
	foreach($result as $data)
	{
	@$document=$data['society']['document'];

	}
	if($document==1 && $s_role_id!=3 )
	{		

				
			if($this->request->is('post'))
			{
				$resource_title= $this->request->data['title'];
				$resource_cat= (int)$this->request->data['sel'];
				$resource_att=$this->request->form['file']['name'];
				$i=$this->autoincrement('resource','resource_id');
				$visible=(int)$this->request->data['visible'];
				
				
					if($visible==1)
					{	
					$visible=1;
					$sub_visible[]=0;
					}
					
					if($visible==4)
					{	
					$visible=4;
					$sub_visible=1;
					}
					
					if($visible==5)
					{
					$visible=5;
					$sub_visible=2;
					}
					
					if($visible==2)
					{	
						$visible=2;
						foreach ($role_result as $collection) 
						{
							$role_id=$collection["role"]["role_id"];

							$role_id=@(int)$this->request->data['role'.$role_id];
							if(!empty($role_id))
							{
							$sub_visible[]=(int)$role_id;
							}
						}
					}
					
						
					if($visible==3)
					{	
					 $visible=3;
						foreach ($wing_result as $collection) 
						{
							$wing_id=(int)$collection["wing"]["wing_id"];

							$wing=@(int)$this->request->data['wing'.$wing_id];
							if(!empty($wing))
							{
								$sub_visible[]=(int)$wing;
							}
						}
					}
					
							
				$date=date("d-m-Y");
				$time=date('h:i:a',time());
				$target = "resource_file/";
				$target=@$target.basename( @$this->request->form['file']['name']);
				$ok=1;
				move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 
					
				$this->loadmodel('resource');
				$this->resource->saveAll(array("resource_id" => $i, "resource_attachment" => $resource_att , "resource_title" => $resource_title,"resource_date"=>$date,"resource_category"=>$resource_cat,"user_id"=>$s_user_id,"society_id"=>$s_society_id,"resource_time"=>$time,"resource_delete"=>4,"visible"=>$visible,"sub_visible"=>$sub_visible));	
				?>
                

				<!----alert-------------->
				<div class="modal-backdrop fade in"></div>
				<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
				<div class="modal-body" style="font-size:16px;">
				Documents are sent for approval
				</div> 
				<div class="modal-footer">
				<a href="resource_view" class="btn green">OK</a>
				</div>
				</div>
				<!----alert-------------->
								
                
                
                
                <?php		
			
			
			
			}
	}
	else
	{
	
	
if($this->request->is('post'))
{
	
	$ip=$this->hms_email_ip();
$resource_title= $this->request->data['title'];
$resource_cat= (int)$this->request->data['sel'];
$resource_att=$this->request->form['file']['name'];
$i=$this->autoincrement('resource','resource_id');
$visible=(int)$this->request->data['visible'];	
$date=date("d-m-Y");
$time=date('h:i:a',time());
$target = "resource_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 

if($visible==1)
{	
$visible=1;
$sub_visible[]=0;
/////////////////////////////////////////// All user ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user= $this->all_user_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All user ////////////////////////////
}


if($visible==4)
{	
$visible=4;
$sub_visible=1;
/////////////////////////////////////////// All Owners ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_owner_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Owners ////////////////////////////
}

if($visible==5)
{
$visible=5;
$sub_visible=2;
/////////////////////////////////////////// All Tenant ////////////////////////////
//$this->loadmodel('user');
//$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_tenant_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Tenant ////////////////////////////
}


if($visible==2)
{	
$visible=2;
foreach ($role_result as $collection) 
{
$role_id=$collection["role"]["role_id"];

$role_id=@(int)$this->request->data['role'.$role_id];
if(!empty($role_id))
{
$sub_visible[]=(int)$role_id;

/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_role_wise_deactive($role_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	


}
}
$da_to=array_unique($da_to);
}

if($visible==3)
{	
$visible=3;
foreach ($wing_result as $collection) 
{
$wing_id=(int)$collection["wing"]["wing_id"];

$wing=@(int)$this->request->data['wing'.$wing_id];
if(!empty($wing))
{
$sub_visible[]=(int)$wing;


/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////
//$this->loadmodel('user');
//$conditions=array('wing'=>$wing_id,'society_id'=>$s_society_id);
//$result_user=$this->user->find('all',array('conditions'=>$conditions));
$result_user=$this->all_wing_wise_deactive($wing_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	



}
}

}

///////// creator send email code //////////////////

$result_user=$this->profile_picture($s_user_id);
foreach($result_user as $data)
{
	 $c_email=$data['user']['email'];
	 $c_user_id=$data['user']['user_id'];
	 $c_user_name=$data['user']['user_name'];
	
}
$da_to[]=$c_email;
$da_user_name[]=$c_user_name;
$da_user_id[]=$c_user_id;

$da_to=array_unique($da_to);
$da_user_name=array_unique($da_user_name);
$da_user_id=array_unique($da_user_id);

//end code//
$this->loadmodel('resource');
$this->resource->saveAll(array("resource_id" => $i, "resource_attachment" => $resource_att , "resource_title" => $resource_title,"resource_date"=>$date,"resource_category"=>$resource_cat,"user_id"=>$s_user_id,"society_id"=>$s_society_id,"resource_time"=>$time,"resource_delete"=>0,"visible"=>$visible,"sub_visible"=>$sub_visible));	
//Email Code Start//

$this->loadmodel('email');
$conditions=array('auto_id'=>6);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$from_name="HousingMatters";
$reply="donotreply@housingmatters.in";
$category_name=$this->resource_category_name($resource_cat);
$society_result=$this->society_name($s_society_id);
foreach($society_result as $data)
{
$society_name=$data['society']['society_name'];
}
if($visible==1)
{
$send='All Users'; 
}
if($visible==2)
{
$send='Roll Wise'; 
}
if($visible==3)
{
$send='Wing Wise'; 
}

if($visible==4)
{
$send='All Owners'; 
}

if($visible==5)
{
$send='All Tenants'; 
}
if(sizeof(@$da_to)==0) { $da_to=array(); }
for($k=0;$k<sizeof($da_to);$k++)
{
	
$to = @$da_to[$k];
$d_user_id = @$da_user_id[$k];	 
$user_name = @$da_user_name[$k];


 $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear  $user_name,</p>
<p>A new document has been uploaded in your society Resource section.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>Date</td>
<td>Category</td>
<td>Title</td>
<td>Attention</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$date</td>
<td>$category_name</td>
<td>$resource_title</td>
<td>$send</td>
</tr>
</table>
<div>
<center><p>To view document 
<a href='$ip".$this->webroot."hms' ><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'> Click Here </button></a></p></center><br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div >
</div>";
$this->loadmodel('notification_email');
$conditions7=array("module_id" =>6,"user_id"=>$d_user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
$n=sizeof($result5);
if($n>0)
{
@$subject.= ''. $society_name . ''.'-' . 'New Document upload'.  '    ' .$resource_title;
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}	
}



?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Resources are published
</div> 
<div class="modal-footer">
<a href="resource_view" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php

}

}

}




function resource_category_name($category_id){
$this->loadmodel('resource_category');
$conditions=array("resource_cat_id" =>(int)$category_id);
$result_category=$this->resource_category->find('all',array('conditions'=>$conditions));
foreach ($result_category as $collection){
return $resource_cat_name=$collection['resource_category']['resource_cat_name'];
}
}

function resource_approval()
{

	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->check_user_privilages();	
$this->ath();	
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('resource');
$conditions=array('society_id'=>$s_society_id,'resource_delete'=>4);	
$order=array('resource.resource_id'=>'DESC');
$result=$this->resource->find('all',array('conditions'=>$conditions,'order'=>$order));
foreach($result as $dda)
	{
		 $id=(int)$dda['resource']['resource_id'];
		$this->seen_notification(4,$id);
		
	}
	
$this->set('result_resource',$result);	
	
}
function resource_reject()
{
	$this->layout="blank";	
	$id=(int)$this->request->query('con');
	$this->loadmodel('resource');
	$this->resource->updateAll(array('resource_delete'=>5),array('resource_id'=>$id));
	$this->response->header('location','resource_approval');	
}	
function resource_approve_ajax()
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$s_society_id=$this->Session->read('society_id');
	$id=(int)$this->request->query('t');
	$ip=$this->hms_email_ip();
	$this->loadmodel('resource');
	$conditions=array('resource_id'=>$id);
	$result_resource=$this->resource->find('all',array('conditions'=>$conditions));
	foreach($result_resource as $data)
	{
		$title=$data['resource']['resource_title'];
		$user_id=$data['resource']['user_id'];
		$date=$data['resource']['resource_date'];
		$resource_category=$data['resource']['resource_category'];
		$visible=(int)$data['resource']['visible'];
		$sub_visible=$data['resource']['sub_visible'];
	}
	
if($visible==1)
{	
$visible=1;
$sub_visible[]=0;
/////////////////////////////////////////// All user ////////////////////////////
$result_user= $this->all_user_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All user ////////////////////////////
}

if($visible==4)
{	
$visible=4;
$sub_visible=1;
/////////////////////////////////////////// All Owners ////////////////////////////

$result_user=$this->all_owner_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Owners ////////////////////////////
}

if($visible==5)
{
$visible=5;
$sub_visible=2;
/////////////////////////////////////////// All Tenant ////////////////////////////

$result_user=$this->all_tenant_deactive();
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
/////////////////////////////////////////// All Tenant ////////////////////////////
}


if($visible==2)
{	
$visible=2;
foreach ($sub_visible as $collection) 
{
$role_id=$collection;
/////////////////////////////////////////// All role  functionality  conditions /////////////////////////////////////////////

$result_user=$this->all_role_wise_deactive($role_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	

}
$da_to=array_unique($da_to);
}



if($visible==3)
{	
$visible=3;
foreach ($sub_visible as $collection) 
{
$wing_id=$collection;

/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////

$result_user=$this->all_wing_wise_deactive($wing_id);
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	

}

}

$this->loadmodel('email');
$conditions=array('auto_id'=>6);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$from_name="HousingMatters";
$reply="donotreply@housingmatters.in";
$category_name=$this->resource_category_name($resource_category);

$society_result=$this->society_name($s_society_id);
foreach($society_result as $data)
{
$society_name=$data['society']['society_name'];
}
if($visible==1)
{
$send='All Users'; 
}
if($visible==2)
{
$send='Roll Wise'; 
}
if($visible==3)
{
$send='Wing Wise'; 
}

if($visible==4)
{
$send='All Owners'; 
}

if($visible==5)
{
$send='All Tenants'; 
}
if(sizeof(@$da_to)==0) { $da_to=array(); }
for($k=0;$k<sizeof($da_to);$k++)
{
$to = @$da_to[$k];
$d_user_id = @$da_user_id[$k];	 
$user_name = @$da_user_name[$k];


/* $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear  $user_name,</p>
<p>A new document has been uploaded in your society Resource section.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>Date</td>
<td>Category</td>
<td>Title</td>
<td>Attention</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$date</td>
<td>$category_name</td>
<td>$title</td>
<td>$send</td>
</tr>
</table>
<div>
<center><p>To view document 
<a href='$ip".$this->webroot."hms' ><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'> Click Here </button></a></p></center><br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div >
</div>";*/

$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$user_name.' </span> <br>
										</td>
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> A new document has been uploaded in your society Resource section. </span>
									</td>
																
								</tr>
								
								
								<tr>
									<td>
									
										<table  cellpadding="5" cellspacing="0" width="100%;"border="1" style="border:1px solid #e5e5e5;">
						
										<tr>
										<td align="left" style="background-color:#00A0E3;color:white;" >Date</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$date.'</td>
										</tr>
										

										
										
										<tr>
										<td align="left" style="background-color:#00A0E3;color:white;" >Category</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$category_name.'</td>
										</tr>
										
										<tr>
										<td align="left" style="background-color:#00A0E3;color:white;" >Title	</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$title.'</td>
										</tr>
										
										
										<tr>
										<td align="left" style="background-color:#00A0E3;color:white;" >Attention</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$send.'</td>
										</tr>
									
										</table> 
									
									</td>
								
								
								
								</tr>
								

					
								<tr>
										<td style="padding:5px;" width="100%" align="center">
										<a href="'.$ip.$this->webroot.'Documents/resource_view" style="width: 100px; min-height: 30px; background-color: rgb(0, 142, 213); padding: 10px; font-family: Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif; white-space: nowrap; font-weight: bold; vertical-align: middle; font-size: 14px; line-height: 14px; color: rgb(255, 255, 255); border: 1px solid rgb(2, 106, 158); text-decoration: none;" target="_blank">view / on HousingMatters</a>
										</td>
								</tr>
					

								<tr>
								<td style="" width="100%" align="left">
									Thank you.<br/>
									HousingMatters (Support Team)<br/>
									www.housingmatters.in 
								</td>
								</tr>

					
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

$this->loadmodel('notification_email');
$conditions7=array("module_id" =>6,"user_id"=>$d_user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
$n=sizeof($result5);
if($n>0)
{
@$subject.= '['. $society_name . ']'.'-' . 'New Document :'.  '    ' .$title;
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}	
}



$this->loadmodel('resource');
$this->resource->updateAll(array('resource_delete'=>0),array('resource_id'=>$id));	

}

function resource_view()
{
$this->layout='session';
$this->ath();
$this->check_user_privilages();
$s_society_id=$this->Session->read('society_id');
$tenant=$this->Session->read('tenant');
$role_id=$this->Session->read('role_id');
$wing=$this->Session->read('wing');
$s_user_id=$this->Session->read('user_id');
$this->set('role_id',$role_id); 
$this->loadmodel('resource');
//$conditions=array('society_id'=>$s_society_id);
$conditions =array( '$or' => array( 
array('society_id' =>$s_society_id,'visible' =>1,'resource_delete'=>0),
array('society_id' =>$s_society_id,'resource_delete'=>0,'visible' =>2,'sub_visible' =>array('$in' => array($role_id))),
array('society_id' =>$s_society_id,'resource_delete'=>0,'visible' =>3,'sub_visible' =>array('$in' => array($wing))),
array('society_id' =>$s_society_id,'resource_delete'=>0,'visible' =>4,'sub_visible' =>$tenant),
array('society_id' =>$s_society_id,'visible' =>5,'sub_visible' =>$tenant,'resource_delete'=>0)
));
$order=array('resource.resource_id'=>'DESC');
$result=$this->resource->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set('result_resource',$result);

	foreach($result as $resource)
	{
		$this->seen_notification(4,$resource["resource"]["resource_id"]);
	}
}

function resource_sm_delete()
{
$this->layout='blank';
$a=(int)$this->request->query('con');
$this->loadmodel('resource');
$this->resource->updateAll(array("resource_delete" =>1),array("resource_id" => $a));
$this->response->header('Location', 'resource_view');
}
function resource_category_name_edit($category_id)
{
$this->loadmodel('resource_category');
$conditions=array("resource_cat_id" => $category_id);
return $result=$this->resource_category->find('all',array('conditions'=>$conditions));

}

function resource_edit()
{
$this->layout='session';
$s_society_id=$this->Session->read('society_id');
$res_id=(int)$this->request->query('con');
$this->loadmodel('resource');
$conditions=array("resource_id"=> $res_id);
$result=$this->resource->find('all',array('conditions'=>$conditions));

foreach($result as $data)
{
$attachment=$data['resource']['resource_attachment'];
//$visible=$data['resource']['r_visible_id'];
//$sub_visible=$data['resource']['r_sub_visible_id'];
$resource_date=$data['resource']['resource_date'];
}

$this->set('result_resource',$this->resource->find('all',array('conditions'=>$conditions))); 
$this->loadmodel('resource_category');
$this->set('result_cat',$this->resource_category->find('all'));
$this->loadmodel('role');
$conditions=array("society_id" => $s_society_id);
$role_result=$this->role->find('all',array('conditions'=>$conditions));
$this->loadmodel('wing');
$wing_result=$this->wing->find('all');
if($this->request->is('post'))
{

$resource_title= $this->request->data['title'];
$resource_cat= (int)$this->request->data['sel'];
$resource_att=$this->request->form['file']['name'];
if(empty($resource_att))
{
$resource_att=$attachment;
}
$target = "resource_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target); 
/*
if($visible==1)
{
if(in_array(1,$sub_visible))
{
/////////////////////////////////////////// All Owner mail functionality conditions //////////////////////////////////////////////////////

$this->loadmodel('user');
$conditions=array('tenant'=>1,'society_id'=>$s_society_id);
$result_user=$this->user->find('all',array('conditions'=>$conditions));
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
//////////////////////////////// end mail ////////////////////////////////////////////////////////		

}
if(in_array(2,$sub_visible))
{

/////////////////////////////////////////// All Tenant mail functionality conditions //////////////////////////////////////////////////////

$this->loadmodel('user');
$conditions=array('tenant'=>2,'society_id'=>$s_society_id);
$result_user=$this->user->find('all',array('conditions'=>$conditions));
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}
//////////////////////////////// end mail ////////////////////////////////////////////////////////					


}


}

if($visible==2)
{
foreach ($role_result as $collection) 
{
$role_id=$collection["role"]["role_id"];
if(in_array($role_id,$sub_visible))
{

/////////////////////////////////////////// All role  functionality  conditions //////////////////////////////////////////////////////
$this->loadmodel('user');
$conditions=array('role_id'=>$role_id,'society_id'=>$s_society_id);
$result_user=$this->user->find('all',array('conditions'=>$conditions));
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////	 


}

}
$da_to=array_unique($da_to);
}

if($visible==3)
{

foreach($wing_result as $collection)
{

$wing_id=$collection['wing']['wing_id'];

if(in_array($wing_id,$sub_visible))
{

/////////////////////////////////////////// All wing wise  functionality conditions //////////////////////////////////////////////////////
$this->loadmodel('user');
$conditions=array('wing'=>$wing_id,'society_id'=>$s_society_id);
$result_user=$this->user->find('all',array('conditions'=>$conditions));
foreach($result_user as $data)
{
$da_to[]=$data['user']['email'];
$da_user_name[]=$data['user']['user_name'];
$da_user_id[]=$data['user']['user_id'];
}

//////////////////////////////// end mail ////////////////////////////////////////////////////////		

}

}

}




////////////////////////////////////////////// Email Code Start ////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
$this->loadmodel('email');
$conditions=array('auto_id'=>6);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$from_name="HousingMatters";
$reply="donotreply@housingmatters.in";
$category_name=$this->resource_category_name($resource_cat);

$society_result=$this->society_name($s_society_id);
foreach($society_result as $data)
{
$society_name=$data['society']['society_name'];
}
if($visible==1)
{
$send='All Users'; 
}
if($visible==2)
{
$send='Roll Wise'; 
}
if($visible==3)
{
$send='Wing Wise'; 
}

for($k=0;$k<sizeof(@$da_to);$k++)
{
$to = @$da_to[$k];
$d_user_id = @$da_user_id[$k];	 
$user_name = @$da_user_name[$k];
$message_web="<div>
<img src='http://123.63.2.150:8080".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear  $user_name,</p>
<p>A new document has been uploaded in your society Resource section.</p>
<table  cellpadding='10' width='100%;' border='1' bordercolor='#e1e1e1'  >
<tr class='tr_heading' style='background-color:#00A0E3;color:white;'>
<td>Date</td>
<td>Category</td>
<td>Title</td>
<td>Attention</td>
</tr>
<tr class='tr_content' style=background-color:#E9E9E9;'>
<td>$resource_date</td>
<td>$category_name</td>
<td>$resource_title</td>
<td>$send</td>
</tr>
</table>
<div>
<center><p>To view document 
<a href='http://123.63.2.150:8080".$this->webroot."hms' ><button style='width:100px; height:30px;  background-color:#00A0E3;color:white'> Click Here </button></a></p></center><br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div >
</div>";
$this->loadmodel('notification_email');
$conditions7=array("module_id" =>6,"user_id"=>$d_user_id,'chk_status'=>0);
$result5=$this->notification_email->find('all',array('conditions'=>$conditions7));
$n=sizeof($result5);
if($n>0)
{
@$subject.= ''. $society_name . ''.'-' . 'New Document upload'.  '    ' .$resource_title;
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
$subject="";
}	
}
*/


$this->loadmodel('resource');
$this->resource->updateAll( array("resource_attachment" => $resource_att,"resource_title"=>$resource_title,'resource_category'=> $resource_cat),array("resource_id" => $res_id));
$this->response->header('Location', 'resource_view');
}

}


////////////////////////////////////////////////////Resource End /////////////////////////////////////////////////////////////////////



///////////////////////////////////////////////////Classified Start //////////////////////////////////////////////////////////////////

function classified_select_category()
{	
$this->layout='session';
$this->loadmodel('master_classified_category');
$this->set('result_select_category',$this->master_classified_category->find('all'));


}


function classified_category_name($main_category)
{	
$this->loadmodel('master_classified_category');
$conditions=array("category_id" => $main_category);
$resut_category=$this->master_classified_category->find('all',array('conditions'=>$conditions));
	foreach ($resut_category as $collection)
	{
	return $collection['master_classified_category']['category_name'];
	}	
}

function classified_subcategory_name($subcategory)
{	
$this->loadmodel('master_classified_subcategories');
$conditions=array("subcategory_id" => $subcategory);
$resut_category=$this->master_classified_subcategories->find('all',array('conditions'=>$conditions));
	foreach ($resut_category as $collection)
	{
	return $collection['master_classified_subcategories']['subcategory_name'];
	}	
}





function master_classified_subcategory($classified_category_id)
{
$this->loadmodel('master_classified_subcategory');
$conditions=array('category_id' => $classified_category_id);
return $this->master_classified_subcategory->find('all',array('conditions'=>$conditions));
}



function classified_post_ad()
{
$this->ath();
$this->layout='session';
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$post_category_id = (int)$this->request->query('a');
$post_sub_category_id = (int)$this->request->query('b');
if(isset($this->request->data['pub'])) 
{

date_default_timezone_set('Asia/Kolkata');
$date=date("d-m-Y");
$time = date(' h:i a', time());
$title=htmlentities($this->request->data['title']);
$description=htmlentities($this->request->data['description']);
$price=$this->request->data['price'];
$offer_up_to_date=$this->request->data['offer'];
if(empty($offer_up_to_date))
{
$offer_up_to_date_s=date('Y-m-d', strtotime($date. ' +30 days'));
$offer_up_to_date=date('d-m-Y', strtotime($offer_up_to_date_s));
}
$price_type=(int)$this->request->data['optionsRadios1'];
$condition=(int)$this->request->data['condition'];
$sell=(int)$this->request->data['sell'];
$photo_name =$this->request->form['photo_upload']['name'];
$target = "classified_photos/";
$target=@$target.basename( @$this->request->form['photo_upload']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['photo_upload']['tmp_name'],@$target); 
$this->loadmodel('classified');
$i=$this->autoincrement('classified','classified_id');
$this->classified->saveAll(array('classified_id' => $i, 'user_id' => $s_user_id, 'society_id' => $s_society_id, 'classified_title' => $title ,
'classified_attachment' => $photo_name , 'classified_price' => $price, 'classified_price_type' => $price_type , 'classified_type_ad' => $sell ,'classified_condition' => $condition ,'classified_description' => $description, 'classified_offer_up_to_date' => $offer_up_to_date, 'classified_post_category_id' => $post_category_id, 'classified_post_sub_category_id' => $post_sub_category_id, 'classified_date' => $date , 'classified_time' => $time , 'classified_delete_id' => 0,'c_status'=>1));
?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Post Classified Ads is Publish
</div> 
<div class="modal-footer">
<a href="classified" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php

}


if(isset($this->request->data['draft'])) 
{


date_default_timezone_set('Asia/Kolkata');
$date=date("d-m-Y");
$time = date(' h:i a', time());
$title=htmlentities($this->request->data['title']);
$description=htmlentities($this->request->data['description']);
$price=$this->request->data['price'];
$offer_up_to_date=$this->request->data['offer'];
$price_type=(int)$this->request->data['optionsRadios1'];
$condition=(int)$this->request->data['condition'];
$sell=(int)$this->request->data['sell'];
$photo_name =$this->request->form['photo_upload']['name'];
$target = "classified_photos/";
$target=@$target.basename( @$this->request->form['photo_upload']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['photo_upload']['tmp_name'],@$target); 
$this->loadmodel('classified');
$i=$this->autoincrement('classified','classified_id');
$this->classified->saveAll(array('classified_id' => $i, 'user_id' => $s_user_id, 'society_id' => $s_society_id, 'classified_title' => $title ,
'classified_attachment' => $photo_name , 'classified_price' => $price, 'classified_price_type' => $price_type , 'classified_type_ad' => $sell ,'classified_condition' => $condition ,'classified_description' => $description, 'classified_offer_up_to_date' => $offer_up_to_date, 'classified_post_category_id' => $post_category_id, 'classified_post_sub_category_id' => $post_sub_category_id, 'classified_date' => $date , 'classified_time' => $time , 'classified_delete_id' => 0,'c_status'=>0 ));

?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Post Classified Ads is Draft
</div> 
<div class="modal-footer">
<a href="classified_draft" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php

}
}


function classified()
{	
$this->layout='session';
$this->ath();

$cat1=(int)@$this->request->query('cat');
$this->set('cat',$cat1);

$this->loadmodel('master_classified_category');
$order=array('master_classified_category.category_name'=>'ASC');
$this->set('result_classified',$this->master_classified_category->find('all',array('order'=>$order)));
$this->loadmodel('classified');
if(empty($cat1)) 
{
$condition1=array("classified_delete_id" => 0,"c_status" =>1);
$this->set('resut_cat',$this->classified->find('all',array('conditions'=>$condition1)));
}

if(!empty($cat1)) 
{
$condition1=array("classified_delete_id" => 0,"classified_post_category_id" => $cat1,"c_status" =>1);
$this->set('resut_cat',$this->classified->find('all',array('conditions'=>$condition1)));
}

}

function classified_detail()
{
$this->ath();
$this->layout='session';
$id=(int)@$this->request->query('con');
$this->loadmodel('classified');
$conditions=array("classified_id" => $id);
$this->set('result_cate',$this->classified->find('all',array('conditions'=>$conditions)));

}

function mail_post_ad()
{
$this->layout='session';
$to=@$this->request->query('r');
$this->set('title',@$this->request->query('con'));

if($this->request->is('post'))
{
$subject=htmlentities($this->request->data['subject']);
$message_web=htmlentities($this->request->data['message']);
$from_name="HousingMatters";
$this->loadmodel('email');
$conditions=array("auto_id" => 3);
$res=$this->email->find('all',array('conditions'=>$conditions));
foreach ($res as $collection)
{ 
$from = $collection['email']['from'];
}
$reply=$from;
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
}

}


function classified_draft()
{

$this->ath();
$this->layout='session';
$s_user_id=$this->Session->read('user_id');
$cat1=(int)@$this->request->query('cat');
$this->set('cat',$cat1);
$this->loadmodel('master_classified_category');
$order=array('master_classified_category.category_name'=>'ASC');
$this->set('result_classified_draft',$this->master_classified_category->find('all',array('order'=>$order)));
$this->loadmodel('classified');
$condition1=array("classified_delete_id" => 0,"c_status" =>0,"user_id" =>$s_user_id);
$this->set('resut_cat',$this->classified->find('all',array('conditions'=>$condition1)));



}

function classified_my_post()
{
$this->ath();
$this->layout='session';
$s_user_id=$this->Session->read('user_id');
$cat1=(int)@$this->request->query('cat');
$this->set('cat',$cat1);
$this->loadmodel('master_classified_category');
$order=array('master_classified_category.category_name'=>'ASC');
$this->set('result_classified_my_post',$this->master_classified_category->find('all',array('order'=>$order)));
$this->loadmodel('classified');
$condition1=array("classified_delete_id" => 0,"c_status" =>1,"user_id" =>$s_user_id);
$this->set('resut_cat',$this->classified->find('all',array('conditions'=>$condition1)));

}


function classified_detail_mypost()
{
$this->ath();
$this->layout='session';
$id=(int)@$this->request->query('con');
$this->loadmodel('classified');
$conditions=array("classified_id" => $id);
$this->set('result_cate',$this->classified->find('all',array('conditions'=>$conditions)));

}

function classified_post_draft_edit()
{
$this->ath();
$this->layout='session';
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$get_id = (int)$this->request->query('e');
$this->loadmodel('master_classified_category');
$this->set('result1',$this->master_classified_category->find('all'));
$this->loadmodel('master_classified_subcategory');
$this->set('result1',$this->master_classified_category->find('all'));
$this->loadmodel('classified');
$conditions=array("classified_id" => $get_id);
$result= $this->classified->find('all',array('conditions'=>$conditions));
foreach($result as $collection)
{
$view_attachment = $collection['classified']['classified_attachment'];
}

$this->set('result_classified',$result); 


if(isset($this->request->data['sub'])) 
{
date_default_timezone_set('Asia/Kolkata');
$date=date("d-m-Y");
$time = date(' h:i a', time());
$title=htmlentities($this->request->data['title']);
$description=htmlentities($this->request->data['description']);
$price=$this->request->data['price'];
$offer_up_to_date=$this->request->data['offer'];
$price_type=(int)$this->request->data['optionsRadios1'];
$condition_ad=(int)$this->request->data['condition'];
$sell_ad=(int)$this->request->data['sell'];
$photo_name =$this->request->form['photo_upload']['name'];
$cat_main=(int)$this->request->data['class_main'];
$cat_sub=(int)$this->request->data['class_sub'];
if(empty($photo_name))
{
$photo_name = $view_attachment;
}
$target = "classified_photos/";
$target=@$target.basename( @$this->request->form['photo_upload']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['photo_upload']['tmp_name'],@$target); 
$this->loadmodel('classified');
$this->classified->updateAll(array('user_id' => $s_user_id, 'society_id' => $s_society_id, 'classified_title' => $title ,
'classified_attachment' => $photo_name , 'classified_price' => $price, 'classified_price_type' => $price_type ,  'classified_type_ad' => $sell_ad ,'classified_condition' => $condition_ad ,'classified_description' => $description, 'classified_offer_up_to_date' => $offer_up_to_date, 'classified_date' => $date , 'classified_time' => $time , 'classified_delete_id' => 0,'classified_post_category_id'=>$cat_main,'classified_post_sub_category_id'=>$cat_sub,'c_status' =>0),array('classified_id'=> $get_id));

?>

<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Post Classified Ads is Draft
</div> 
<div class="modal-footer">
<a href="classified_draft" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php




}

if(isset($this->request->data['pub'])) 
{

date_default_timezone_set('Asia/Kolkata');
$date=date("d-m-Y");
$time = date(' h:i a', time());
$title=htmlentities($this->request->data['title']);
$description=htmlentities($this->request->data['description']);
$price=$this->request->data['price'];
$offer_up_to_date=$this->request->data['offer'];
$price_type=(int)$this->request->data['optionsRadios1'];
$condition_ad=(int)$this->request->data['condition'];
$sell_ad=(int)$this->request->data['sell'];
$photo_name =$this->request->form['photo_upload']['name'];
$cat_main=(int)$this->request->data['class_main'];
$cat_sub=(int)$this->request->data['class_sub'];

if(empty($photo_name))
{
$photo_name = $view_attachment;
}
$target = "classified_photos/";
$target=@$target.basename( @$this->request->form['photo_upload']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['photo_upload']['tmp_name'],@$target); 
$this->loadmodel('classified');
$this->classified->updateAll(array('user_id' => $s_user_id, 'society_id' => $s_society_id, 'classified_title' => $title ,
'classified_attachment' => $photo_name , 'classified_price' => $price, 'classified_price_type' => $price_type ,  'classified_type_ad' => $sell_ad ,'classified_condition' => $condition_ad ,'classified_description' => $description,'classified_offer_up_to_date' => $offer_up_to_date,'classified_date' => $date , 'classified_time' => $time ,'classified_delete_id' => 0,'classified_post_category_id'=>$cat_main,'classified_post_sub_category_id'=>$cat_sub,'c_status' =>1),array('classified_id'=> $get_id));

?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your Post Classified Ads is Publish
</div> 
<div class="modal-footer">
<a href="classified" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php

}






}

function classified_cat_subcategory_ajax()
{

$this->layout='blank';
$this->set('category_id',(int)$this->request->query('con1'));

}

///////////////////////////////////////////////// Classified End /////////////////////////////////////////////////////////////////////




////////////////////////////////// /////////////////////////// Profile  Start //////////////////////////////////////////////////

function flat($c_wing_id)
{
$this->loadmodel('flat');
$conditions=array("wing_id" => $c_wing_id);
return $this->flat->find('all',array('conditions'=>$conditions));

}
/*
function hms_email_ip()
{
	
	$this->loadmodel('user');
	$conditions=array('society_id'=>0);
	$result=$this->user->find('all',array('conditions'=>$conditions));
	foreach($result as $data)
	{
		return @$data['user']['email_ip'];
	}

}


function hms_sms_ip()
{
	
	$this->loadmodel('user');
	$conditions=array('society_id'=>0);
	$result=$this->user->find('all',array('conditions'=>$conditions));
	
	foreach($result as $data)
	{
		$w= $data['user']['sms_working_key'];
		$s= $data['user']['sms_sender'];
		$alow= @$data['user']['sms_allow'];
		
		return $sms=(object)array("working_key"=>$w,"sms_sender"=>$s,"sms_allow"=>$alow);
		
	}
}
*/

function hobbies_category_fetch($id){
	
$this->loadmodel('hobbies_category');
$conditions=array('hobbies_id'=>$id);	
$result_hobbies_cat=$this->hobbies_category->find('all',array('conditions'=>$conditions));
	foreach($result_hobbies_cat as $data){
		
		return $data['hobbies_category']['hobbies_name'];
	}
}
	


function profile_test(){
	
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
		}else{
		$this->layout='session';
		}
	$this->ath();
 $s_society_id=$this->Session->read('hm_society_id');
 $s_user_id=$this->Session->read('hm_user_id');

$r=$this->request->query('try');

$this->seen_alert(101,$s_user_id);
$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

if(!empty($r)){
$this->loadmodel('user');
$this->user->updateAll(array('profile_status'=>2),array('user_id'=>$s_user_id));
$this->redirect(array('action' => 'profile'));
}

	

$result_user_profile = $this->requestAction(array('controller' => 'Fns', 'action' => 'user_profile_info_via_user_id'),array('pass'=>array($s_user_id)));
$profile=@$result_user_profile[0]['user_profile']['profile_pic'];

			$this->loadmodel('user_flat');
			$conditions=array('user_id'=>$s_user_id);
			$result=$this->user_flat->find('all',array('conditions'=>$conditions));
			foreach($result as $data){
				$tenant=@$data['user_flat']['owner'];
			}

		$result_member_type= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_user_type_via_user_id'),array('pass'=>array($s_user_id)));
		$this->set('owner',$tenant);
		$this->set('member_type',$result_member_type);

	$result_society=$this->society_name($s_society_id);
		foreach($result_society as $data){
			$society_name2=$data['society']['society_name'];
			@$family_member=$data['society']['family_member'];
			@$family_member_tenant=$data['society']['family_member_tenant'];
		}
		$this->set('family_member',$family_member);
		$this->set('family_member_tenant',$family_member_tenant);	
		
$this->loadmodel('hobbies_category');
$this->set('hobbies_category',$this->hobbies_category->find('all'));
if($this->request->is('post')){
	echo"hello"; exit;
	
}
$this->loadmodel('user');
	$conditions=array("user_id" => $s_user_id);
	$this->set('result_user',$this->user->find('all',array('conditions'=>$conditions)));  	
}



function profile() 
{
		if($this->RequestHandler->isAjax()){
		$this->layout='blank';
		}else{
		$this->layout='session';
		}
	$this->ath();
 $s_society_id=$this->Session->read('hm_society_id');
 $s_user_id=$this->Session->read('hm_user_id');

$r=$this->request->query('try');

$this->seen_alert(101,$s_user_id);
$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

if(!empty($r)){
$this->loadmodel('user');
$this->user->updateAll(array('profile_status_user'=>1),array('user_id'=>$s_user_id));
$this->redirect(array('action' => 'profile'));
}
			$this->loadmodel('user_flat');
			$conditions=array('user_id'=>$s_user_id);
			$result=$this->user_flat->find('all',array('conditions'=>$conditions));
			foreach($result as $data){
				$tenant=@$data['user_flat']['owner'];
			}

		$result_member_type= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_user_type_via_user_id'),array('pass'=>array($s_user_id)));
		$this->set('owner',$tenant);
		$this->set('member_type',$result_member_type);

	$result_society=$this->society_name($s_society_id);
		foreach($result_society as $data){
			$society_name2=$data['society']['society_name'];
			@$family_member=$data['society']['family_member'];
			@$family_member_tenant=$data['society']['family_member_tenant'];
		}
		$this->set('family_member',$family_member);
		$this->set('family_member_tenant',$family_member_tenant);	
		
$this->loadmodel('hobbies_category');
$this->set('hobbies_category',$this->hobbies_category->find('all'));


if($this->request->is('post')){
 @$name=htmlentities($this->request->data['name']);	
 @$medical=htmlentities($this->request->data['medical']);	
 @$mobile=htmlentities($this->request->data['mobile1']); 
 @$email=htmlentities($this->request->data['email']);
 @$sex=(int)htmlentities($this->request->data['sex']);
 @$age=htmlentities($this->request->data['age']);
 @$per_address=htmlentities($this->request->data['per_address']);
 @$com_address=htmlentities($this->request->data['com_address']);
 @$hob=$this->request->data['hob'];
 @$photo_name =$this->request->form['profile_photo']['name'];
 @$blood_group=htmlentities($this->request->data['blood_group']);
 @$contact_emergency=htmlentities($this->request->data['contact_emergency1']);	
 @$private_or_public=$this->request->data['sel_private'];
	
if($blood_group==1){
$b_group="A+";
}
if($blood_group==2){
$b_group="B+";
}
if($blood_group==3){
$b_group="AB+";
}
if($blood_group==4){
$b_group="O+";
}
if($blood_group==5){
$b_group="A-";
}
if($blood_group==6){
$b_group="B-";
}
if($blood_group==7){
$b_group="AB-";
}
if($blood_group==8){
$b_group="O-";
}
if($medical==1){
 $med_pro="Yes";
}
if($medical==2){
 $med_pro="No";
}
if($age==1){
$age_group="18-24";
}
if($age==2){
$age_group="25-34";
}
if($age==3){
$age_group="35-44";
}
if($age==4){
$age_group="45-54";
}
if($age==5){
$age_group="55-64";
}
if($age==6){
$age_group="65+";
}


 $result_user=$this->profile_picture($s_user_id);
 foreach($result_user as $data){
	  $email1=$data['user']['email'];
	  $mobile1=$data['user']['mobile'];
	  $profile=@$data['user']['profile_pic'];
 }
 
 
$from_name="HousingMatters";
$subject='['.$society_name2.']-Profile Update';
$this->loadmodel('email');
$conditions=array('auto_id'=>4);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$reply=$from;

 
 /*
 if(!empty($email) && $email!=$email1){
		
		
		
		$de_user_id=$this->encode($s_user_id,'housingmatters');
		$random=$de_user_id;
		 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								
							
								
								
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/verification_member_profile?q='.$random.'"> Click here </a> for one time verification of your email have updated  </b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name2.'<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';


$this->loadmodel('user');	
$this->user->updateAll(array('signup_random'=>$s_user_id,'new_email'=>$email),array('user_id'=>$s_user_id));
$this->smtpmailer($email,$from,$from_name,$subject,$message_web,$reply);


} */
 
if(empty($photo_name)){
$photo_name=$profile;
}

	$target = "profile/";
	$target=@$target.basename( @$this->request->form['profile_photo']['name']);
	$ok=1;
	move_uploaded_file(@$this->request->form['profile_photo']['tmp_name'],@$target); 
	$this->loadmodel('user_profile');
	$conditions=array('user_id'=>$s_user_id);
	$result_user_profile=$this->user_profile->find('count',array('conditions'=>$conditions));
	if($result_user_profile>0){
		
			$this->user_profile->updateAll(array('gender'=>$sex,'age'=>$age,'per_address'=>$per_address,'comm_address'=>$com_address,'hobbies'=>$hob,'blood_group'=>$blood_group,'medical_pro'=>$medical,'contact_emergency'=>$contact_emergency),array("user_id" => $s_user_id));
			
			$this->loadmodel('user');
			$this->user->updateAll(array('profile_pic'=>$photo_name),array("user_id" => $s_user_id));
		
	}else{
			$user_profile_id=$this->autoincrement('user_profile','user_profile_id');
			$this->user_profile->saveAll(array('gender'=>$sex,'age'=>$age,'per_address'=>$per_address,'comm_address'=>$com_address,'hobbies'=>$hob,'blood_group'=>$blood_group,'medical_pro'=>$medical,'contact_emergency'=>$contact_emergency,'user_profile_id'=>$user_profile_id,'user_id'=>$s_user_id,'society_id'=>$s_society_id));
			
			$this->loadmodel('user');
			$this->user->updateAll(array('profile_pic'=>$photo_name),array("user_id" => $s_user_id));
	}
	
$to=$email;

  @$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
									<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
								<tbody>
								<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								<tr>
								<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td width="100%"><a href="#" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px" target="_blank"><span style="color:#00A0E3">Housing</span><span style="color:#777776">Matters</span></a></td>
								<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img  src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
									
								</td>
								</tr>
								<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								</tbody>
								</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Your profile is successfully update. </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify">  Name : '.$name.'  </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Mobile : '.$mobile.'  </span> 
										</td>
																
								</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify">  Email : '.$email.' </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Age group : '.$age_group.'</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Contact number emergency : '.$contact_emergency .'</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Permanent address : '.$per_address.'</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Communication address : '.$com_address.' </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Hobbies : '.$hob.' </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Blood group : '.$b_group.' </span> 
										</td>
																
								</tr>
								
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Medical professional : '.@$med_pro.' </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left"><br/>
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

	$this->smtpmailer($to,$from,$from_name,$subject,$message_web,$reply);
	$this->Session->write('profile_status', 1);
	$this->response->header('Location', $this->webroot.'Hms/dashboard');
}
	$this->loadmodel('user');
	$conditions=array("user_id" => $s_user_id);
	$this->set('result_user',$this->user->find('all',array('conditions'=>$conditions)));            
	$this->loadmodel('wing');
	$this->set('result1',$this->wing->find('all'));   
}

function profile_flat_ajax()
{
$this->layout='blank';	
$wing_id=(int)$this->request->query['con'];
$this->loadmodel('flat');
$conditions=array("wing_id" => $wing_id);
$result = $this->flat->find('all',array('conditions'=>$conditions));
$this->set('result3',$result);
}


function profile_check_private($update=null,$field=null)
{
$this->layout=null;
$s_user_id=$this->Session->read('hm_user_id');
	if($field=='mobile'){
	$this->loadmodel('user');	
	$this->user->updateAll(array('mobile_privacy'=>$update,),array("user_id" => $s_user_id));	
	}
	if($field=='email'){
	$this->loadmodel('user');	
	$this->user->updateAll(array('email_privacy'=>$update,),array("user_id" => $s_user_id));	
	}
	if($field=='gender'){
	$this->loadmodel('user_profile');	
	$this->user_profile->updateAll(array('gender_privacy'=>$update,),array("user_id" => $s_user_id));	
	}
	if($field=='age'){
	$this->loadmodel('user_profile');	
	$this->user_profile->updateAll(array('age_privacy'=>$update,),array("user_id" => $s_user_id));	
	}
	if($field=='contact_num_emergency'){
	$this->loadmodel('user_profile');	
	$this->user_profile->updateAll(array('contact_num_emergency_privacy'=>$update,),array("user_id" => $s_user_id));	
	}
	if($field=='per_address'){
	$this->loadmodel('user_profile');	
	$this->user_profile->updateAll(array('per_address_privacy'=>$update,),array("user_id" => $s_user_id));	
	}
	if($field=='communication_address'){
	$this->loadmodel('user_profile');	
	$this->user_profile->updateAll(array('communication_address_privacy'=>$update,),array("user_id" => $s_user_id));	
	}
	if($field=='hob'){
	$this->loadmodel('user_profile');	
	$this->user_profile->updateAll(array('hob_privacy'=>$update,),array("user_id" => $s_user_id));	
	}
	if($field=='blood_group'){
	$this->loadmodel('user_profile');	
	$this->user_profile->updateAll(array('blood_group_privacy'=>$update,),array("user_id" => $s_user_id));	
	}


}
//End Profile//
//start Content modaration//
function society_detail_auto_save_file_upload(){
	$this->layout=null;
	$this->ath();
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$post_data=$this->request->data;
	
	if($post_data['field']=="society_logo"){
		
		if(!empty($_FILES["file"]["name"])){
				$file_name=@$_FILES["file"]["name"];
				$target = "logo/";
				$target = $target . basename( $_FILES['file']['name']) ;
				move_uploaded_file($_FILES['file']['tmp_name'], $target);
				$this->loadmodel('society');
				$this->society->updateAll(array('logo'=>$file_name),array('society_id'=>$s_society_id));
		}else{
			$this->loadmodel('society');
			$this->society->updateAll(array('logo'=>''),array('society_id'=>$s_society_id));
			
		}
	}
	
	if($post_data['field']=="society_signature"){
		
		if(!empty($_FILES["file"]["name"])){
			$file_name=@$_FILES["file"]["name"];
			$target = "sig/";
			$target = $target.basename($_FILES['file']['name']) ;
			move_uploaded_file($_FILES['file']['tmp_name'], $target);
			$this->loadmodel('society');
			$this->society->updateAll(array('signature'=>$file_name),array('society_id'=>$s_society_id));
		}else{
			$this->loadmodel('society');
			$this->society->updateAll(array('signature'=>''),array('society_id'=>$s_society_id));
		}
		
	}
	
}

function society_detail_auto_save(){
	
$this->layout=null;	
$s_society_id=$this->Session->read('hm_society_id');
	$field=$this->request->query('field');
	$update=$this->request->query('update');
	
		if($field=="society_pan"){
			$this->loadmodel('society');
			$this->society->updateAll(array('pan'=>$update),array('society_id'=>$s_society_id));
		}	
		if($field=="society_reg_no"){
			$this->loadmodel('society');
			$this->society->updateAll(array('society_reg_num'=>$update),array('society_id'=>$s_society_id));
		}		
	

		if($field=="society_add"){
			$this->loadmodel('society');
			$this->society->updateAll(array('society_address'=>$update),array('society_id'=>$s_society_id));
		}
		if($field=="society_ser_tax"){
			$this->loadmodel('society');
			$this->society->updateAll(array('tex_number'=>$update),array('society_id'=>$s_society_id));
		}
		if($field=="society_ph_num"){
			$this->loadmodel('society');
			$this->society->updateAll(array('society_phone'=>$update),array('society_id'=>$s_society_id));
		}
		if($field=="society_email"){
			$this->loadmodel('society');
			$this->society->updateAll(array('society_email'=>$update),array('society_id'=>$s_society_id));
		}
		if($field=="society_title"){
			$this->loadmodel('society');
			$this->society->updateAll(array('sig_title'=>$update),array('society_id'=>$s_society_id));
		}
}


function society_details()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
$this->ath();
$this->check_user_privilages();

//$webroot_path=$this->requestAction(array('controller' => 'Hms', 'action' => 'webroot_path'));
//$this->set('webroot_path',$webroot_path);


	$s_society_id=$this->Session->read('hm_society_id'); 
	$sco_n=$this->society_name($s_society_id);
	foreach($sco_n as $data){
		$sco= $data['society']['society_name'];
		@$logo_data= @$data['society']['logo'];
		@$logo_data= @$data['society']['logo'];
	}
	$this->set('society_name',$sco);
	if($this->request->is('post'))
	{
	$pan=$this->request->data['pan'];
	$s_tax=$this->request->data['s_tax'];
	$s_number=$this->request->data['s_number'];
	$address=$this->request->data['address'];
	$society_phone = @$this->request->data['society_phone'];
    $society_email = @$this->request->data['society_email'];	
    $sig_title = @$this->request->data['title'];
	
	$logo=$_FILES['logo']['name'];
    $sig=$_FILES['sig']['name'];	
	
if(!empty($logo) && !empty($sig)){	
			$target = "logo/";
			$target = $target . basename( $_FILES['logo']['name']) ;
			move_uploaded_file($_FILES['logo']['tmp_name'], $target);

			$target = "sig/";
			$target = $target . basename($_FILES['sig']['name']) ;
			move_uploaded_file($_FILES['sig']['tmp_name'], $target);	

	$this->loadmodel('society');
	$this->society->updateAll(array('pan'=>$pan,'tex_number'=>$s_tax,'society_address'=>$address,'society_reg_num'=>$s_number,"society_phone"=>$society_phone,"society_email"=>$society_email,"signature"=>@$sig,"logo"=>$logo,"sig_title"=>$sig_title),array('society_id'=>$s_society_id));			
		
}else if(!empty($sig) && empty($logo)){
	
	$target = "sig/";
	$target = $target . basename($_FILES['sig']['name']) ;
	move_uploaded_file($_FILES['sig']['tmp_name'], $target);	

	$this->loadmodel('society');
	$this->society->updateAll(array('pan'=>$pan,'tex_number'=>$s_tax,'society_address'=>$address,'society_reg_num'=>$s_number,"society_phone"=>$society_phone,"society_email"=>$society_email,"signature"=>@$sig,"sig_title"=>$sig_title),array('society_id'=>$s_society_id));	

}else if(!empty($logo) && empty($sig)){
			$target = "logo/";
			$target = $target . basename( $_FILES['logo']['name']) ;
			move_uploaded_file($_FILES['logo']['tmp_name'], $target);	

		$this->loadmodel('society');
		$this->society->updateAll(array('pan'=>$pan,'tex_number'=>$s_tax,'society_address'=>$address,'society_reg_num'=>$s_number,"society_phone"=>$society_phone,"society_email"=>$society_email,"logo"=>@$logo,"sig_title"=>$sig_title),array('society_id'=>$s_society_id));	
}
else if(empty($logo) && empty($sig)){
		$this->loadmodel('society');
		$this->society->updateAll(array('pan'=>$pan,'tex_number'=>$s_tax,'society_address'=>$address,'society_reg_num'=>$s_number,"society_phone"=>$society_phone,"society_email"=>$society_email,"sig_title"=>$sig_title),array('society_id'=>$s_society_id));
	
}	

	$this->Session->write('society_detail',1);
		
}
$this->loadmodel('society');
$conditions=array('society_id'=>$s_society_id);
$result=$this->society->find('all',array('conditions'=>$conditions));
$this->set('result_society',$result);
}

function content_moderation()
{
	$this->layout='session';
	$s_society_id=$this->Session->read('society_id'); 
	$this->loadmodel('society');
	$conditions=array('society_id'=>$s_society_id);
	$result=$this->society->find('all',array('conditions'=>$conditions));
	$this->set('result_society',$result);
	if($this->request->is('post'))
	{
		
	     $id=$this->request->data['text_name'];
		 
		if(!empty($id))
		{
			$content=$this->request->data['name'];
			echo $content ;
			$r=explode(',',$content);
			
			if(!empty($r))
			{
				
				$this->loadmodel('society');
				$this->society->updateAll(array('content_moderation'=>$r),array('society_id'=>$s_society_id));
			}
		}
		else
		{
			
		 $content[]=$this->request->data['name'];
		foreach($result as $data)
		{
			 $con=@$data['society']['content_moderation'];
		}
		if(!empty($con))
		{
		 $content=$this->request->data['name'];
		array_push($con,$content);	
		$this->loadmodel('society');
		$this->society->updateAll(array('content_moderation'=>$con),array('society_id'=>$s_society_id));
		
		}
		else
		{
			$this->loadmodel('society');
		   $this->society->updateAll(array('content_moderation'=>$content),array('society_id'=>$s_society_id));
		   
		}
		}
		$this->response->header('location','content_moderation');
		
	}
}


function content_moderation_delete()
{
	
	 $id=(int)$this->request->query('con');
	 $this->loadmodel('moderation');
	 $this->moderation->updateAll(array('c_m_delete'=>1),array('auto_id'=>$id));
	 $this->response->header('location','content_moderation');
	
}

///////////////////////// End Contant Modaration  /////////////////////////////////

/////////////////// Start Contact Handbook ////////////////////////////


function contact_handbook_export()
{
	
$this->layout="";
$s_society_id=$this->Session->read('hm_society_id');
$result_society=$this->society_name($s_society_id);
$society_name=$result_society[0]['society']['society_name'];
$filename=$society_name.'_contact_handbook_';
$filename = str_replace(' ', '_', $filename);


$filename='Contact Handbook';
header ("Expires: 0");
header ("border: 1");
header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
header ("Cache-Control: no-cache, must-revalidate");
header ("Pragma: no-cache");
header ("Content-type: application/vnd.ms-excel");
header ("Content-Disposition: attachment; filename=".$filename.".xls");
header ("Content-Description: Generated Report" );
$export="<div align='center'> 
<span style='font-size:16px;'>".$society_name." <span>
<br/>
<span>contact handbook<span>
</div>";
$export.="<table border='1'>
<tr>
<th>Sr no.</th>
<th>Service Provider/ Vendor</th>
<th>Services offered</th>
<th>Mobile</th>
<th>Email</th>
<th>Website</th>

</tr>
";	
$i=0;
$this->loadmodel('contact_handbook');
$conditions=array('society_id'=>$s_society_id,'c_h_delete'=>0);
$result=$this->contact_handbook->find('all',array('conditions'=>$conditions));
	foreach($result as $collection)
	{
		$i++;
		$c_h_id=$collection['contact_handbook']["c_h_id"];
		$mobile=$collection['contact_handbook']["c_h_mobile"];
		$user_id=(int)$collection['contact_handbook']['user_id'];
		$name=$collection['contact_handbook']["c_h_name"];
		$email=$collection['contact_handbook']["c_h_email"];
		$web=$collection['contact_handbook']["c_h_web"];
		$service=$collection['contact_handbook']["c_h_service"];
		$result_user=$this->profile_picture($user_id);
		foreach($result_user as $data)
		{
			 $user_name=$data['user']['user_name'];

		}	
		
				$service_name="";
				if(!empty($service)){
				foreach($service as $data){
				$result_contact_handbook_service=$this->requestAction(array('controller' => 'hms', 'action' => 'contact_handbook_service'),array('pass'=>array($data)));	
				$service_name.=$result_contact_handbook_service.',';
				}
				}
		
		$export.="<tr>
		<td>".$i."</td>
		<td>".$name."</td>
		<td>".$service_name."</td>
		<td>".$mobile."</td>
		<td>".$email."</td>
		<td>".$web."</td>
		 </tr>";
		
	}
	 $export.="</table>" ;
	 echo $export ;
}

function contact_handbook_service($ser_id){
	
 	
$this->loadmodel('contact_handbook_service');
$conditions=array('contact_handbook_service_id'=>(int)$ser_id);
$result_contact_handbook=$this->contact_handbook_service->find('all',array('conditions'=>$conditions));	

	foreach($result_contact_handbook as $data){
		return $data['contact_handbook_service']['contact_handbook_service_name'];
		
	}
}

function contact_handbook_edit(){
	
	$this->layout="blank";	
	$id=(int)$this->request->query('id');
	
$this->loadmodel('contact_handbook');
$conditions=array('c_h_id'=>$id);
$result_contact_handbook=$this->contact_handbook->find('all',array('conditions'=>$conditions));
$this->set('result_contact_handbook',$result_contact_handbook);

$this->loadmodel('contact_handbook_service');
$result_contact_handbook_service=$this->contact_handbook_service->find('all');	
$this->set('contact_handbook_service',$result_contact_handbook_service);	

}

function contact_handbook()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$s_user_id=$this->Session->read('hm_user_id'); 
$s_society_id=$this->Session->read('hm_society_id'); 	
$this->set('s_user_id',$s_user_id);
$this->loadmodel('contact_handbook');
$conditions=array('society_id'=>$s_society_id,'c_h_delete'=>0);
$result=$this->contact_handbook->find('all',array('conditions'=>$conditions));


$this->loadmodel('contact_handbook_service');
$result_contact_handbook_service=$this->contact_handbook_service->find('all');	
$this->set('contact_handbook_service',$result_contact_handbook_service);	

$this->set('result_contact_handbook',$result);	
if($this->request->is('post'))
{
 $id=(int)$this->request->data['text_id'];
 $name=htmlentities($this->request->data['name']);
 $mobile=htmlentities($this->request->data['mobile']);
 $email=htmlentities($this->request->data['email']);
 $web=htmlentities($this->request->data['web']);
 $service=@$this->request->data['service'];
 
 if(!empty($web)){
 if (!preg_match("~^(?:f|ht)tps?://~i", $web)) {
        $web = "http://" . $web;
    }
 }	
	


if(!empty($id))
{
	$this->loadmodel('contact_handbook');
	$this->contact_handbook->updateAll(array('c_h_name'=>$name,'c_h_mobile'=>$mobile,'c_h_email'=>$email,'c_h_web'=>$web,'c_h_service'=>$service),array('c_h_id'=>$id));
	$this->response->header('location','contact_handbook');
}
else
{
	
date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$i=$this->autoincrement('contact_handbook','c_h_id');
$this->loadmodel('contact_handbook');
$this->contact_handbook->saveAll(array("c_h_id" => $i, "c_h_name" => $name,"c_h_date"=>$date,"user_id"=>$s_user_id,"society_id"=>$s_society_id,"c_h_time"=>$time,"c_h_mobile"=>$mobile,'c_h_email'=>$email,'c_h_web'=>$web,'c_h_service'=>$service,'c_h_delete'=>0));


$result_user=$this->all_user_deactive();
foreach($result_user as $data)
{
$visible_user_id[]=$data['user']['user_id'];
}

$this->Session->write('contact_create',1);


$this->response->header('location','contact_handbook');

}



}

}

function contact_handbook_delete()
{
	$this->layout='blank';
	$id=(int)$this->request->query('con');
	$this->loadmodel('contact_handbook');
	$this->contact_handbook->updateAll(array('c_h_delete'=>1),array('c_h_id'=>$id));
	$this->response->header('location','contact_handbook');
}

function contact_handbook_view()
{
$this->layout='session';	
$s_society_id=$this->Session->read('society_id'); 
$this->loadmodel('contact_handbook');
$conditions=array('society_id'=>$s_society_id);
$result=$this->contact_handbook->find('all',array('conditions'=>$conditions));
$this->set('result_contact_handbook',$result);
}


function contact_handbook_view_page()
{
$this->layout='blank';
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 	
$this->set('role_id',$s_role_id=$this->Session->read('role_id'));
$this->set('s_user_id',$s_user_id);
$c_h_id=$this->request->query('con');

$this->set('search_value',$c_h_id);
$regex = new MongoRegex("/.*$c_h_id.*/i"); 

$this->loadmodel('contact_handbook_service');
$condition1=array('contact_handbook_service_name'=>$regex);

$result_contact_handbook_service=$this->contact_handbook_service->find('all',array('conditions'=>$condition1));
$service=@$result_contact_handbook_service[0]['contact_handbook_service']['contact_handbook_service_id'];

$this->loadmodel('contact_handbook');
$conditions =array( '$or' => array( 
array('c_h_name' =>$regex,'society_id'=>$s_society_id,'c_h_delete'=>0),
array('c_h_mobile' =>$regex,'society_id'=>$s_society_id,'c_h_delete'=>0),
array('c_h_email' =>$regex,'society_id'=>$s_society_id,'c_h_delete'=>0),
array('c_h_web' =>$regex,'society_id'=>$s_society_id,'c_h_delete'=>0),
array('c_h_service' =>''.$service.'','society_id'=>$s_society_id,'c_h_delete'=>0)));

$result=$this->contact_handbook->find('all',array('conditions'=>$conditions));

$this->set('result_contact_handbook',$result);
$this->set('count_yellow',sizeof($result));	

}

//End Contact handbook//
function resident_directory(){
	if($this->RequestHandler->isAjax()){
			$this->layout='blank';
		}else{
			$this->layout='session';
		}
	$this->ath();
	$this->check_user_privilages();	
	$s_society_id=$this->Session->read('hm_society_id');

	$arranged_users=array();
	
	$this->loadmodel('user');
	$conditions=array("society_id"=>$s_society_id,"active"=>"yes");
	$order=array('user.user_name'=>'ASC');	
	$users=$this->user->find('all',array('conditions'=>$conditions,'order'=>$order));
	foreach($users as $user_info){
		$user_id=$user_info["user"]["user_id"];
		$user_name=$user_info["user"]["user_name"];
		$profile_pic=@$user_info["user"]["profile_pic"];
		$g_profile_pic=@$user_info["user"]["g_profile_pic"];
		$f_profile_pic=@$user_info["user"]["f_profile_pic"];
		$user_type=$user_info["user"]["user_type"];
		$mobile=$user_info["user"]["mobile"];
		$email=$user_info["user"]["email"];
		$validation_status=@$user_info["user"]["validation_status"];
		$date=$user_info["user"]["date"];

		if($user_type=="member" or $user_type=="family_member"){
			
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'),array('pass'=>array($user_id)));
			$flats=array();
			foreach($user_flat_info as $user_flat){
				$user_flat_id=$user_flat["user_flat"]["user_flat_id"];
				$wing=$user_flat["user_flat"]["wing"];
				$flat=$user_flat["user_flat"]["flat"];
				$exited=$user_flat["user_flat"]["exited"];
				if($exited=="no"){
					$this->loadmodel('wing');
					$conditions=array("wing_id"=>$wing);
					$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
					$wing_name=@$wing_info[0]["wing"]["wing_name"];
					
					$this->loadmodel('flat');
					$conditions=array("flat_id"=>$flat);
					$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
					$flat_name=ltrim(@$flat_info[0]["flat"]["flat_name"],'0');
					
					$flats[$user_flat_id]=$wing_name.' - '.$flat_name;
				}
				
			} 
				
			$arranged_users[$user_id]=array("user_name"=>$user_name,"wing_flat"=>$flats,"mobile"=>$mobile,"email"=>$email,"profile_pic"=>$profile_pic, "g_profile_pic"=>$g_profile_pic,"f_profile_pic"=>$f_profile_pic,"date"=>$date,"user_flat_id"=>$user_flat_id);
			
		}
	}
	$this->set(compact("arranged_users"));
}

function member_profile($user_flat_id=null){
	
	if($this->RequestHandler->isAjax()){
			$this->layout='blank';
		}else{
			$this->layout='session';
		}
		$this->ath();
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$result_society=$this->society_name($s_society_id);
	$society_name=	$result_society[0]['society']['society_name'];
	$this->set(compact("society_name"));
	$this->set(compact("s_user_id"));
	$this->set(compact("user_flat_id"));
}

function resident_directory_view()
{
$this->layout="blank";
$this->ath();
$s_role_id=$this->Session->read('role_id');	
$s_society_id=$this->Session->read('society_id');	
$this->set('role_id',$s_role_id);
$this->set('s_society_id',$s_society_id);
$this->set('user_id',$this->Session->read('user_id'));
$user_id=(int)$this->request->query('id');
$this->set('user_flat',$this->request->query('user_flat_id')); 
$this->loadmodel('user');
$conditions=array("user_id" => $user_id);
$result=$this->user->find('all',array('conditions'=> $conditions));
$this->set('result_user1',$result);



}
function resident_directory_count_wing(){
	
$this->layout=null;
$this->ath();
$search_wing=(int)$this->request->query('id'); 
if($search_wing!=0){
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('user');
$conditions=array("society_id" => $s_society_id,'wing'=>$search_wing,'deactive'=>0);
echo $result_user=$this->user->find('count',array('conditions'=> $conditions));
}else{
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('user_flat');
$conditions=array("society_id" => $s_society_id,'active'=>0);
echo $result_user=$this->user_flat->find('count',array('conditions'=> $conditions));
	
}
}


function resident_directory_search_wing_ajax()
{
$this->layout="blank";
$this->ath();
$search_wing=(int)$this->request->query('con');
$this->set('search_value',$search_wing);
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('user');
$order=array('user.user_name'=> 'ASC');
$conditions=array("society_id" => $s_society_id,'wing'=>$search_wing,'deactive'=>0);
$result1=$this->user->find('all',array('conditions'=> $conditions,'order'=>$order));
$n=sizeof($result1);
$this->set('result_user2',$result1);
$this->set('count_user2',$n);

$this->loadmodel('user');
$conditions=array("society_id" => $s_society_id,'deactive'=>0);
$order1=array('user.user_name'=> 'ASC');
$result2=$this->user->find('all',array('conditions'=> $conditions,'order'=>$order1));
$this->set('result_user3',$result2);

}


function resident_directory_search_name()
{
	
$this->layout="blank";
$this->ath();
$s_society_id=$this->Session->read('society_id');
$search=$this->request->query('con');
$flat=$search;
$this->loadmodel('flat'); 
$conditions=array("society_id"=>$s_society_id,"flat_name"=> new MongoRegex('/^' .  $flat . '$/i'));
$result_flat=$this->flat->find('all',array('conditions'=>$conditions));
foreach($result_flat as $data)
{
	$flat_id=$data['flat']['flat_id'];
	$this->set('flat_search',@$flat_id);
	$this->loadmodel('user_flat');	
	$conditions=array('flat_id'=>$flat_id,'active'=>0);
	$result_user=$this->user_flat->find('all',array('conditions'=>$conditions));
	
	foreach($result_user as $dda)
	{
		@$da_user_id[]=@$dda['user_flat']['user_id'];
	}
}

if(!empty($da_user_id))
{
$this->set('result_usser_flat',@$da_user_id);
}
$this->set('search_value',$search);
$regex = new MongoRegex("/.*$search.*/i");  
$this->loadmodel('user');
$conditions=array('user_name'=>$regex,'society_id'=>$s_society_id,'deactive'=>0);
$result=$this->user->find('all',array('conditions'=>$conditions));
$this->set('result_user',$result); 
$n=sizeof($result);
$this->set('count_user2',$n);
$this->loadmodel('user');
$conditions=array("society_id" => $s_society_id,'deactive'=>0);
$order1=array('user.user_name'=> 'ASC');
$result2=$this->user->find('all',array('conditions'=> $conditions,'order'=>$order1));
$this->set('result_user3',$result2);
}


////////////////////////////////////////////////////   Resident Directory End ////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


	
///////////////////  Start Family member functionality //////////////////////



function dob_check()
{
	
	$this->layout='blank';
	$dob=$this->request->query['dob'];
	date_default_timezone_set('Asia/kolkata');
	$date=date("d-m-Y");
	$newDate = date("d-m-Y", strtotime($date));
	$newDate1 = date("Y-m-d", strtotime($newDate));
	$newDate2 = date("d-m-Y", strtotime($dob));
	$newDate3 = date("Y-m-d", strtotime($newDate2));
	$datetime1 = date_create($newDate1);
	$datetime2 = date_create($newDate3);
	$interval = date_diff($datetime2, $datetime1);
	 $years = $interval->y;
	 if($years>=13)
	 {
		echo'true';
	 }
	 else
	 {
		echo'false'; 
	 }
}


function family_member_check_mobile(){
	
$this->layout=null;
$mobile=$this->request->data['mobile1'];
$s_user_id=(int)$this->request->data['society'];


$this->loadmodel('user');
$conditions=array("mobile" => $mobile,'user_id'=>$s_user_id);
$result4 = $this->user->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);
$e=$n4;
if ($e > 0) {
echo "true";
} else {
		$this->loadmodel('user_temp');
		$conditions=array("mobile" => $mobile,'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("mobile" => $mobile);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n4 = sizeof($result4);
		$e=$n3+$n4;

		if ($e > 0) {
		echo"false";
		} else {
		echo"true";
		}
	
}	


	
}


function family_member_check_email(){
	
$this->layout=null;
$email=$this->request->data['email1'];
$s_user_id=(int)$this->request->data['society'];
$this->loadmodel('user');
$conditions=array("email" => $email,'user_id'=>$s_user_id);
$result4 = $this->user->find('all',array('conditions'=>$conditions));
$n4 = sizeof($result4);
$e=$n4;
if ($e > 0) {
echo "true";
} else {

		$this->loadmodel('user_temp');
		$conditions=array("email" => $email,'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("email" => $email);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n5 = sizeof($result4);	
		$e1=$n3+$n5;
		if ($e1 > 0) {
		echo "false";
		} else {
		echo "true";	
		}

	}
	
	
}


function family_member_add_ajax()
{
	
	if($this->RequestHandler->isAjax()){
			$this->layout='blank';
		}else{
			$this->layout='session';
		}
	$id=(int)$this->request->query('con');
	$s_society_id=$this->Session->read('hm_society_id'); 
	$result_user=$this->profile_picture($id);
	$this->set('result_user',$result_user);
	$old_email=$result_user[0]['user']['email'];
	$old_mobile=$result_user[0]['user']['mobile'];
	$user_name=$result_user[0]['user']['user_name'];
	if($this->request->is("post"))
	{
		    $name=$this->request->data['name1'];
		    $email=$this->request->data['email1'];
		    $mobile=$this->request->data['mobile1'];
		    $dob=$this->request->data['dob1'];
		    $blood_group=$this->request->data['blood_group1'];
		    $relation=$this->request->data['relation1'];
			
			//// Email 
			
			$random1=mt_rand(1000000000,9999999999);
			$random2=mt_rand(1000000000,9999999999);
			$random=$random1.$random2 ;	
			$de_user_id=$this->encode($id,'housingmatters');
			$random=$de_user_id.'/'.$random;
			
			$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));
			
			
			$res_society=$this->society_name($s_society_id);
			foreach($res_society as $data){
				$society_name=$data['society']['society_name'];
			 } 

			$from_name="HousingMatters";
			$reply="support@housingmatters.in";
			$to=$email;
			$this->loadmodel('email');
			$conditions=array("auto_id" => 4);
			$result_email = $this->email->find('all',array('conditions'=>$conditions));
			foreach ($result_email as $collection) 
			{
			 $from=$collection['email']['from'];
			}
			 $subject="Welcome to ".$society_name." portal ";
			
				
			
			if(!empty($email) and !empty($mobile)){
				if($email!=$old_email and $mobile!=$old_mobile){
					
					
						$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
						  <tbody>
							<tr>
								<td>
									<table width="100%" cellpadding="0" cellspacing="0">
										<tbody>
										
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/send_sms_for_verify_mobile?q='.$random.'"> Click here </a> for one time verification of your mobile number and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
											</span>
														</td>
																					
													</tr>
										
										</table>
										
									</td>
								</tr>

							</tbody>
					</table>';
		$this->loadmodel('user');
		$this->user->updateAll(array("signup_random"=>$random,"password"=>$random),array("user_id"=>$id));
		$this->send_email($to,$from,$from_name,$subject,@$message_web,$reply);		
		

		
}elseif($email!=$old_email){
					
					$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
					  <tbody>
						<tr>
							<td>
								<table width="100%" cellpadding="0" cellspacing="0">
									<tbody>
									
											<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/set_new_password?q='.$random.'"> Click here </a> for one time verification of your mobile number and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
															</span>
													</td>
																				
												</tr>
									
									</table>
									
								</td>
							</tr>

						</tbody>
				</table>';
			
	$this->loadmodel('user');
	$this->user->updateAll(array("signup_random"=>$random,"password"=>$random),array("user_id"=>$id));
	$this->send_email($to,$from,$from_name,$subject,@$message_web,$reply);		
			
 }
				
			}
			
			
		$this->loadmodel('user');
		$this->user->updateAll(array("user_name"=>$name,'relationship'=>$relation,'email'=>$email,'mobile'=>$mobile),array("user_id"=>$id));
		$this->loadmodel('user_profile');
		$this->user_profile->updateAll(array("blood_group"=>$blood_group,"age"=>$dob),array("user_id"=>$id));
			
			?>
			
			
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your family details have been updated successfully.
</div> 
<div class="modal-footer">
<a href="family_member_view" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->

			
			
			
			<?php
			
	}
	
}

function family_member_deactive()
{
	$this->layout="blank";
	$id=(int)$this->request->query('con');
	$this->loadmodel("user");
	$this->user->updateAll(array('active'=>'no'),array('user_id'=>$id));
	$this->response->header("location","family_member_view");
	
}
function family_member_view()
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	 $s_user_id=$this->Session->read('hm_user_id'); 
	 $s_society_id=$this->Session->read('hm_society_id'); 
	 $s_role_id=$this->Session->read('role_id');
	 $this->set('s_role_id',$s_role_id);
	$this->loadmodel('user_flat');
	$conditions=array('user_id'=>$s_user_id);
	$result=$this->user_flat->find('all',array('conditions'=>$conditions));
	foreach($result as $data)
	{
	$tenant=@$data['user_flat']['owner'];
	$wing=(int)@$data['user_flat']['wing'];
	$flat=(int)@$data['user_flat']['flat'];
	

	}
	$result_member_type= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_user_type_via_user_id'),array('pass'=>array($s_user_id)));
	$this->set('owner',$tenant);
	$this->set('member_type',$result_member_type);
	$result_society=$this->society_name($s_society_id);	
	foreach($result_society as $data)
	{
	 $society_name=$data['society']['society_name'];
	 @$family_member=$data['society']['family_member'];
	  @$family_member_tenant=$data['society']['family_member_tenant'];
	  @$s_duser_id=$data['society']['user_id'];
	}
	$this->set('family_member',$family_member);
	$this->set('family_member_tenant',$family_member_tenant);	
	
	
	
    $this->loadmodel('user');
	$conditions=array('family_main_member'=>$s_user_id,'active'=>'yes');
	$result_family_member=$this->user->find('all',array('conditions'=>$conditions));
	$this->set('result_user',$result_family_member);	
	
	
}

function family_member()
{
	
$this->layout="session";	
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id'); 
$this->loadmodel('user');
$conditions=array('user_id'=>$s_user_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
foreach($result as $data)
{
	$tenant=(int)$data['user']['tenant'];
	$wing=(int)$data['user']['wing'];
	$flat=(int)$data['user']['flat'];
	$residing=(int)$data['user']['residing'];
	
}
$result_society=$this->society_name($s_society_id);	
foreach($result_society as $data)
{
	 $society_name=$data['society']['society_name'];
	 @$family_member=$data['society']['family_member'];
}

if($this->request->is('post'))
	$ip=$this->hms_email_ip();
		{
		if($family_member==1)
		{			
			date_default_timezone_set('Asia/kolkata');
			$date=date("d-m-Y");
			$time=date('h:i:a',time());
			$name=$this->request->data['name'];
			$email=$this->request->data['email'];
			$mobile=$this->request->data['mobile'];
			$this->loadmodel('user');	
			$i=$this->autoincrement('user','user_id');	
			$random1=mt_rand(1000000000,9999999999);
			$random2=mt_rand(1000000000,9999999999);
			$random=$random1.$random2 ;	
			$de_user_id=$this->encode($i,'housingmatters');
			$random=$de_user_id.'/'.$random;
			$dob=$this->request->data['dob'];
			$relation=$this->request->data['relation'];
			$blood_group=$this->request->data['blood_group'];
			$log_i=$this->autoincrement('login','login_id');
			
////////////////////////// insert user table //////////////////////////
		
$this->user->save(array('user_id' => $i, 'user_name' => $name,'email' => $email, 'password' =>'', 'mobile' => $mobile,  'society_id' => $s_society_id, 'tenant' => $tenant, 'wing' => $wing, 'flat' => $flat,'residing' => $residing, 'date' => $date, 'time' => $time,"profile_pic"=>'blank.jpg','sex'=>'','role_id'=>2,'default_role_id'=>2,'signup_random'=>$random,'family_member'=>$s_user_id,'dob'=>$dob,'relation'=>$relation,'login_id'=>$log_i,'s_default'=>1,'blood_group'=>$blood_group));

////////////////////// End user table ///////////////////////////////////////////////////

////////////////////////////////// insert login table /////////////////////////////////////

$this->loadmodel('login');
$this->login->save(array('login_id'=>$log_i,'user_name'=>$email,'password'=>$random,'signup_random'=>$random,'mobile'=>$mobile));

/////////////////////////  End login table /////////////////////////////////////////

 $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $name,</p>
<p>'We at $society_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.</p>
<p>As you are an owner/resident/staff of $society_name, we have added your email address in HousingMatters portal.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>
<p>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</p>
<p>You can receive important SMS & emails from your committee.</p>
<br/>				
<p><b><a href='$ip".$this->webroot."/hms/send_sms_for_verify_mobile?q=$random'>Click here</a> for one time verification of your mobile number and Login into HousingMatters  for making life simpler for all your housing matters!</b></p>
<br/>
<p>Pls add www.housingmatters.co.in in your favorite bookmarks for future use.</p>
<p>Regards,</p>	
<p>Administrator of $society_name</p><br/><br/>
www.housingmatters.co.in
</div >
</div>";
$from_name="HousingMatters";
$reply="support@housingmatters.in";
$to=$email;
$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$subject="Welcome to ".$society_name." portal ";
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);

?>

<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Your family details have been updated.
</div> 
<div class="modal-footer">
<a href="" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->

<?php
		}
		else
		{
			?>

<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Administrator has not allowed family member login into the portal.
</div> 
<div class="modal-footer">
<a href="" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->

<?php
			
		}
	}
	
}



//////////////////////////// End  family member //////////////////////////////

function committee_metters_view()
{

$this->layout='session';
$this->ath();	
$s_user_id=$this->Session->read('user_id'); 
$s_society_id=$this->Session->read('society_id');	
$this->loadmodel('committee_metter');
$conditions=array('society_id'=>$s_society_id);
$result=$this->committee_metter->find('all',array('conditions'=>$conditions));
$this->set('result_com',$result);
}


//////////////////////////////////// Committee_metters end  //////////////////////////////////	



////////////////////////////////////////////// Society Report view start //////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////

function fetch_user_flat_active($id){
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('user_flat');	
$conditions=array('user_id'=>$id,'active'=>0);	
return $this->user_flat->find('all',array('conditions'=>$conditions));
	
}

function fetch_user_flat_deactive($id){
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('user_flat');	
$conditions=array('user_id'=>$id,'active'=>1);	
return $this->user_flat->find('all',array('conditions'=>$conditions));
	
}

function fetch_user_flat($id){
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('user_flat');	
$conditions=array('user_id'=>$id);	
return $this->user_flat->find('all',array('conditions'=>$conditions));

}
function check_due_payment(){
	
$s_society_id=$this->Session->read('society_id');	
$user_flat_id=(int)$this->request->query('user_flat');
$this->loadmodel('user_flat');	
$conditions=array('user_flat_id'=>$user_flat_id,'status'=>1);	
$result_user_flat= $this->user_flat->find('all',array('conditions'=>$conditions));
  $n=sizeof($result_user_flat);
		if($n>0){
				$flat_id=$result_user_flat[0]['user_flat']['flat_id'];
				$user_id=$result_user_flat[0]['user_flat']['user_id'];
				
			   
			   
			   
				$result_new_regular_bill = $this->requestAction(array('controller' => 'Incometrackers', 
				'action' => 'fetch_last_bill_info_via_flat_id'),array('pass'=>array($flat_id)));
				if(sizeof($result_new_regular_bill)>0){
					foreach($result_new_regular_bill as $data){
					//$bill_no=$data["bill_no"];
					$bill_start_date=$data["bill_start_date"];
					$due_date=$data["due_date"];
					$due_for_payment=$data["due_for_payment"];
					
					 $last_bill_one_time_id=$data["one_time_id"];
					//$flat_id22 = (int)$data["flat_id"];
					$result_new_cash_bank = $this->requestAction(array('controller' => 'Incometrackers', 'action' => 'fetch_last_receipt_info_via_flat_id'),array('pass'=>array($flat_id,$last_bill_one_time_id)));
					
					$total_amount=0;
							foreach($result_new_cash_bank as $data2){
							$amount=$data2["new_cash_bank"]["amount"];
							 $total_amount+=$amount;
							}
					} 
				
					$total=$due_for_payment-$total_amount;
					
					if($total>0){
					
							$result_user=$this->profile_picture($user_id);
							$user_name=$result_user[0]['user']['user_name'];
							$result_flat = $this->requestAction(array('controller' => 'hms', 'action' => 'fetch_wing_id_via_flat_id'),array('pass'=>array($flat_id)));
							foreach($result_flat as $data2){

							$wing_id=$data2['flat']['wing_id'];
							}
							$wing_flat = $this->requestAction(array('controller' => 'hms', 'action' => 'wing_flat'),array('pass'=>array($wing_id,$flat_id)));
						    
						 $msg="Payment of &#8377; ".$total." is due from ".$user_name." (".$wing_flat.")" ;
						$output = json_encode(array('report_type'=>'due', 'text' => $msg));
						die($output);
						
					}else{
						
						$output = json_encode(array('report_type'=>'done', 'text' => ''));
						die($output);
					}
				}else{
					$output = json_encode(array('report_type'=>'done', 'text' => ''));
						die($output);
				}
			
		}else{
						$output = json_encode(array('report_type'=>'done', 'text' => ''));
						die($output);
			
		}
}


function society_member_view(){
	if($this->RequestHandler->isAjax()){
			$this->layout='blank';
		}else{
			$this->layout='session';
		}
	$this->ath();
	$this->check_user_privilages();	
	$s_society_id=$this->Session->read('hm_society_id');
	
	$this->loadmodel('society');
	$conditions=array("society_id"=>$s_society_id);
	$result_society=$this->society->find('all',array('conditions'=>$conditions));
	$result_society_name=$result_society[0]['society']['society_name'];
	
	$main_admin_user_id=$result_society[0]['society']['user_id'];
	
	
	$this->set(compact("result_society_name"));
	$this->set(compact("main_admin_user_id"));
	$arranged_users=array();
	
	
	$this->loadmodel('user');
	$conditions=array("society_id"=>$s_society_id,"active"=>"yes");
	$order=array('user.user_name'=>'ASC');	
	$users=$this->user->find('all',array('conditions'=>$conditions,'order'=>$order));
	foreach($users as $user_info){
		$user_id=$user_info["user"]["user_id"];
		$user_name=$user_info["user"]["user_name"];
		$user_type=$user_info["user"]["user_type"];
		$mobile=$user_info["user"]["mobile"];
		$email=$user_info["user"]["email"];
		$validation_status=@$user_info["user"]["validation_status"];
		$date=$user_info["user"]["date"];
		
		if($user_type=="member" or $user_type=="family_member"){
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'),array('pass'=>array($user_id)));
			$flats=array(); $resident=array();	$flats1=array();
			foreach($user_flat_info as $user_flat){
				$user_flat_id=$user_flat["user_flat"]["user_flat_id"];
				
			// represntive code
				$this->loadmodel('ledger_sub_account');
				$conditions=array("society_id" => $s_society_id,"representative" => "yes","user_flat_id"=>$user_flat_id);
				$ledger_sub_accounts=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
			
				$representator=@$ledger_sub_accounts[0]["ledger_sub_account"]["representator"];

				$representator_info = $this->requestAction(array('controller' => 'Fns', 'action' => 'member_info_via_ledger_sub_account_id'),array('pass'=>array($representator)));
				
			/// end 	
			
				$wing=$user_flat["user_flat"]["wing"];
				$flat=$user_flat["user_flat"]["flat"];
				$owner=@$user_flat["user_flat"]["owner"];
				$exited=$user_flat["user_flat"]["exited"];
				if($exited=="no"){
					$this->loadmodel('wing');
					$conditions=array("wing_id"=>$wing);
					$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
					$wing_name=@$wing_info[0]["wing"]["wing_name"];
					
					$this->loadmodel('flat');
					$conditions=array("flat_id"=>$flat);
					$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
					$flat_name=ltrim(@$flat_info[0]["flat"]["flat_name"],'0');
					$flat_name_new=@$flat_info[0]["flat"]["flat_name"];
					$flats[$user_flat_id]=$wing_name.'-'.$flat_name;
					$flats1[$user_flat_id]=$wing_name.'-'.$flat_name_new;
					if($owner=="yes" && (!empty($wing) && !empty($flat))){
								$this->loadmodel('flat');
								$conditions=array("wing_id"=>$wing,"flat_id"=>$flat);
								$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
								
								$noc_status=@$flat_info[0]["flat"]["noc_ch_tp"];
								if($noc_status==1){
									$resident[$user_flat_id]=1;
								}
							}elseif($owner=="no" && (!empty($wing) && !empty($flat))){
								$resident[$user_flat_id]=1;
							}
					
					
					
					
					
				}
				
			} 
		}else{
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'),array('pass'=>array($user_id)));
			$user_flat_id=$user_flat_info[0]["user_flat"]["user_flat_id"];
			$flats=array();
			$flats1=array();
			$resident=array();
		}
		
		$this->loadmodel('user_role');
		$conditions=array("user_id"=>$user_id,"society_id"=>$s_society_id);
		$user_role_info=$this->user_role->find('all',array('conditions'=>$conditions));
		$roles=array(); $count_member_owner=0;
		$count_member_tenant=0; $count_member_family=0;$count_member_family_owner=0;$count_member_family_tenant=0;
		
		$x=0;$z=0;$y=0;$f=0;
		foreach($user_role_info as $user_role){
			$role_id=$user_role["user_role"]["role_id"];
			
			$this->loadmodel('role');
			$conditions=array("role_id"=>$role_id);
			$role_info=$this->role->find('all',array('conditions'=>$conditions));
			$roles[]=$role_info[0]["role"]["role_name"];
			
			if($role_id==3){
				$x++;
				$count_member_owner+=$x;
			}
			
			if($role_id==4){
				$z++;
				$count_member_tenant+=$z;
			}
			
			if($role_id==5){
				$f++;
				$count_member_family_owner+=$f;
			}
			if($role_id==6){
				$y++;
				$count_member_family_tenant+=$y;
			}
		}
		$roles=implode(',',$roles);
		
		$arranged_users[$user_id]=array("user_name"=>$user_name,"wing_flat"=>$flats,"roles"=>$roles,"mobile"=>$mobile,"email"=>$email,"validation_status"=>$validation_status,"date"=>$date,"user_flat_id"=>$user_flat_id,"count_member_owner"=>$count_member_owner,"count_member_tenant"=>$count_member_tenant,"count_member_family_owner"=>$count_member_family_owner,"count_member_family_tenant"=>$count_member_family_tenant,'resident_member'=>$resident,'user_id'=>$user_id,'flat_asc'=>$flats1,'representator_info'=>$representator_info);
	}
	
	$this->set(compact("arranged_users"));
}

function update_member_info($user_id=null){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->set(compact("user_id"));
	$this->ath();
	$this->check_user_privilages();	
	$s_society_id=$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$user_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'member_info_via_user_id'),array('pass'=>array((int)$user_id)));
	
	$this->set(compact("user_info"));
	
	if (isset($this->request->data['sub'])) {
		$name=$this->request->data['name'];
		$email=$this->request->data['email'];
		$mobile=$this->request->data['mobile'];
		
	//Store history code
	
	
	    $user_name_old=$user_info['user_name'];

		$email_old=$user_info['email'];
		$mobile_old=$user_info['mobile'];
		date_default_timezone_set('Asia/Kolkata');
		$date=date("d-m-Y");
		$time = date(' h:i a', time());
		$op=$this->autoincrement('profile_log','profile_log_id');
		if($user_name_old!=$name){
			$new_user_name=$name;
		}else{
			$new_user_name='';
		}
		if($email!=$email_old and $mobile!=$mobile_old){
			 $new_email=$email;
			 $new_mobile=$mobile;
		}elseif($email!=$email_old){
			  $new_email=$email;
			  $new_mobile='';
		}elseif($mobile!=$mobile_old){
			$new_email='';
			$new_mobile=$mobile;
		}else{
			 $new_email='';
			 $new_mobile='';
		}
		
		$this->loadmodel('profile_log');
		$this->profile_log->saveAll(array('profile_log_id'=>$op,'user_id'=>(int)$user_id,'society_id'=>$s_society_id,'email'=>$email_old,'mobile'=>$mobile_old,'new_email'=>$new_email,'new_mobile'=>$new_mobile,'date'=>$date,'time'=>$time,'updated_by'=>$s_user_id,'user_name'=>$user_name_old,'new_user_name'=>$new_user_name));
		
	//// end 
		
		$this->loadmodel('user');
		$this->user->updateAll(array('user_name'=>$name,'email'=>$email,'mobile'=>$mobile),array('user.user_id'=>(int)$user_id));
		$this->redirect(array('action' => 'society_member_view'));
	}
}

function validate_for_member_info_update(){
	$this->layout="";
	$s_society_id=$this->Session->read('hm_society_id');
	
	$email=$this->request->query('email');
	$user_id=(int)$this->request->query('user_id');
	
	$this->loadmodel('user'); 
	$conditions=array("society_id"=>(int)$s_society_id,"email"=>$email,"user_id"=>array('$ne'=>$user_id));
	$count=$this->user->find('count',array('conditions'=>$conditions));
	if($count>0){
		echo "no";
	}else{
		echo "";
	}
	
}

function validate_for_member_info_update_mobile(){
	$this->layout="";
	$s_society_id=$this->Session->read('hm_society_id');
	
	$mobile=$this->request->query('mobile');
	$user_id=(int)$this->request->query('user_id');
	
	$this->loadmodel('user'); 
	$conditions=array("society_id"=>(int)$s_society_id,"mobile"=>$mobile,"user_id"=>array('$ne'=>$user_id));
	$count=$this->user->find('count',array('conditions'=>$conditions));
	if($count>0){
		echo "no";
	}else{
		echo "";
	}
	
}

function society_member_excel()
{
$this->layout="";
$s_society_id=$this->Session->read('society_id');

$filename='user_list';
@header("Expires: 0");
@header("border: 1");
@header("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
@header("Cache-Control: no-cache, must-revalidate");
@header("Pragma: no-cache");
@header("Content-type: application/vnd.ms-excel");
@header("Content-Disposition: attachment; filename=".$filename.".xls");
@header("Content-Description: Generated Report");

$this->ath();
	
$s_society_id=$this->Session->read('hm_society_id');
$this->loadmodel('society');	
$conditions=array('society_id'=>$s_society_id);	
$this->set('result_society',$this->society->find('all',array('conditions'=>$conditions)));

$arranged_users=array();
	
	$this->loadmodel('user');
	$conditions=array("society_id"=>$s_society_id,"active"=>"yes");
	$order=array('user.user_name'=>'ASC');	
	$users=$this->user->find('all',array('conditions'=>$conditions,'order'=>$order));
	foreach($users as $user_info){
		$user_id=$user_info["user"]["user_id"];
		$user_name=$user_info["user"]["user_name"];
		$user_type=$user_info["user"]["user_type"];
		$mobile=$user_info["user"]["mobile"];
		$email=$user_info["user"]["email"];
		$validation_status=@$user_info["user"]["validation_status"];
		$date=$user_info["user"]["date"];
		
		if($user_type=="member" or $user_type=="family_member"){
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'),array('pass'=>array($user_id)));
			$flats=array();
			foreach($user_flat_info as $user_flat){
				$user_flat_id=$user_flat["user_flat"]["user_flat_id"];
				
				// represntive code
				$this->loadmodel('ledger_sub_account');
				$conditions=array("society_id" => $s_society_id,"representative" => "yes","user_flat_id"=>$user_flat_id);
				$ledger_sub_accounts=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
			
				$representator=@$ledger_sub_accounts[0]["ledger_sub_account"]["representator"];

				$representator_info = $this->requestAction(array('controller' => 'Fns', 'action' => 'member_info_via_ledger_sub_account_id'),array('pass'=>array($representator)));
				
			/// end 	
				
				
				$wing=$user_flat["user_flat"]["wing"];
				$flat=$user_flat["user_flat"]["flat"];
				$exited=$user_flat["user_flat"]["exited"];
				if($exited=="no"){
					$this->loadmodel('wing');
					$conditions=array("wing_id"=>$wing);
					$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
					$wing_name=@$wing_info[0]["wing"]["wing_name"];
					
					$this->loadmodel('flat');
					$conditions=array("flat_id"=>$flat);
					$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
					$flat_name=ltrim(@$flat_info[0]["flat"]["flat_name"],'0');
					
					$flats[$user_flat_id]=$wing_name.' - '.$flat_name;
				}
				
			} 
		}else{
			$user_flat_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'),array('pass'=>array($user_id)));
			$user_flat_id=$user_flat_info[0]["user_flat"]["user_flat_id"];
			$flats=array();
		}
		
		$this->loadmodel('user_role');
		$conditions=array("user_id"=>$user_id,"society_id"=>$s_society_id);
		$user_role_info=$this->user_role->find('all',array('conditions'=>$conditions));
		$roles=array();
		foreach($user_role_info as $user_role){
			$role_id=$user_role["user_role"]["role_id"];
			
			$this->loadmodel('role');
			$conditions=array("role_id"=>$role_id);
			$role_info=$this->role->find('all',array('conditions'=>$conditions));
			$roles[]=$role_info[0]["role"]["role_name"];
		}
		$roles=implode(',',$roles);
		
		$arranged_users[$user_id]=array("user_name"=>$user_name,"wing_flat"=>$flats,"roles"=>$roles,"mobile"=>$mobile,"email"=>$email,"validation_status"=>$validation_status,"date"=>$date,"user_flat_id"=>$user_flat_id,'representator_info'=>$representator_info);
	}
	$this->set(compact("arranged_users"));

}



////////////////////////////////////////////End Society member view /////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////// multiple society ///////////////////

function multi_society_enrollment()
{
	
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$this->ath();	
	
$this->loadmodel('society');
$conditions=array("aprvl_status"=>1);
$result_society=$this->society->find('all',array("conditions"=>$conditions));	
$this->set('result_society',$result_society);	

$this->loadmodel('user');
$conditions=array("active"=>"yes");
$result_user=$this->user->find('all',array("conditions"=>$conditions));
$this->set("result_user",$result_user);

	if($this->request->is('post')){
		date_default_timezone_set('Asia/kolkata');
		$date=date("d-m-Y");
		$time=date('h:i:a',time());
		
		$society_id=(int)$this->request->data['society'];
		$user_id=(int)$this->request->data['user'];
		$wing=(int)$this->request->data['wing_name'];
		$flat=(int)$this->request->data['flat_name'];
		$owner=$this->request->data['tenant'];
		
		$user_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'user_info_via_user_id'),array('pass'=>array((int)$user_id)));
		 $da_society_id=$user_info[0]['user']['society_id'];
		 $name=$user_info[0]['user']['user_name'];
			
		if($owner=="yes"){
			$committee=$this->request->data['committe'];
			$role_new_id=3;
		}else{
			$committee="no";
			$role_new_id=4;
		}
		
		if(is_array($da_society_id)){
			array_push($da_society_id,$society_id);
			
		}else{
			$da_society_id=array($da_society_id,$society_id);
			
		}
	
	$this->loadmodel('user');
	$this->user->updateAll(array("society_id"=>$da_society_id),array('user_id'=>$user_id));
	$this->loadmodel('user_role');
	$auto_id=$this->autoincrement('user_role','auto_id');
	$this->user_role->saveAll(array('auto_id' => $auto_id, 'user_id' => $user_id,'role_id' =>$role_new_id,'default'=>'yes','society_id' => $society_id));
	
	if($committee=="yes"){
		$auto_id=$this->autoincrement('user_role','auto_id');
		$this->user_role->saveAll(array('auto_id' => $auto_id, 'user_id' => $user_id,'role_id' => 2,'society_id' => $society_id,'default'=>''));
	}	
	
	
	$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
	$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$user_id,'society_id'=>$society_id,'wing'=>$wing,'flat'=>$flat,'exited'=>'no','owner'=>$owner));
	
	if($owner=="yes"){
		$this->loadmodel('ledger_sub_account');
		$j=$this->autoincrement('ledger_sub_account','auto_id');
		$this->ledger_sub_account->save(array('auto_id'=>$j,'ledger_id'=>34,'name'=>$name,'society_id' => $society_id,'user_flat_id'=>$user_flat_id,'exited'=>'no','user_id' => $user_id));
	}
		
 }
	
}

function society_member_valid($society_id=null,$user_id=null){
	
	$this->loadmodel('user');
	$conditions=array("user_id"=>(int)$user_id,"society_id"=>(int)$society_id);
	$result_user=$this->user->find('count',array("conditions"=>$conditions));
	if($result_user==1){
		echo"false";
	}else{
		echo"true";
	}
}

function society_wise_member_list($society_id=null,$type=null,$wing=null){
	
$this->set("type",$type);	
$this->loadmodel('user');
$conditions=array("society_id"=>(int)$society_id,"active"=>"yes");
$result_user=$this->user->find('all',array("conditions"=>$conditions));
$this->set("result_user",$result_user);

$this->loadmodel('wing');
$conditions=array("society_id"=>(int)$society_id);
$result_wing=$this->wing->find('all',array("conditions"=>$conditions));
$this->set("result_wing",$result_wing);

$this->loadmodel('flat');
$conditions=array("society_id"=>(int)$society_id,"wing_id"=>(int)$wing);
$result_flat=$this->flat->find('all',array("conditions"=>$conditions));
$this->set("result_flat",$result_flat);

}

////////////////////////////////////////////////////////


///////////////////////////////////////// New User Enrollment ///////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function hm_new_user_enrollment()
{
$this->layout="session";
$this->ath();	
$this->loadmodel('society');
$result=$this->society->find('all',array('conditions'=>array('aprvl_status'=>1)));	
$this->set('result_society',$result);
if($this->request->is('post')) 
{

$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip')); 
date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$society_id=(int)$this->request->data['society'];
$result_society=$this->society_name($society_id);
foreach($result_society as $data)
{
	 $society_name=$data['society']['society_name'];
}

$s_n='';
$sco_na=$society_name;
$dd=explode(' ',$sco_na);
$first=$dd[0];
@$two=$dd[1];
@$three=$dd[2];
$s_n.=" $first $two $three ";

$name=$this->request->data['name'];
$email=$this->request->data['email'];
$mobile=$this->request->data['mobile'];
$wing=(int)$this->request->data['wing'];
$flat=(int)$this->request->data['flat'];

$owner=$this->request->data['owner'];

	$this->loadmodel('flat');
	$conditions=array("flat_id" =>$flat);
	$result_flat = $this->flat->find('all',array('conditions'=>$conditions));
	foreach($result_flat as $data_flat){
	  $flat_type = (int)$data_flat['flat']['noc_ch_tp'];	
	}
	if($flat_type == 1)
		{
			if($owner == 'no')
			{
			 	
			   $this->set('tenant_allow','Flat is self Occupied');
				goto a;
			}
			
		}
		

$this->loadmodel('user_flat');
$conditions2=array('flat'=>$flat,'society_id'=>$society_id,'exited'=>'no');
 $result_user=$this->user_flat->find('all',array('conditions'=>$conditions2));
  $n5=sizeof($result_user); 
if($n5==1){
	 $tenant_database=$result_user[0]['user_flat']['owner'];
	if($tenant_database=='yes'){
		if($tenant_database==$owner){
			
			$this->set('tenant_allow','Flat is Already Exist owner.');
			goto a;
			
		}
		
		
	}else{
		
		if($tenant_database==$owner){
			
			$this->set('tenant_allow','Flat is Already Exist tenant.');
			goto a;
			
		}
		
		
		
	}
	
}
if($n5==2){
	$this->set('tenant_allow','Flat is Already Exist.');
	goto a;
	
}

if($owner=="yes"){
	$committee=$this->request->data['committe'];
	$role_new_id=3;
	}else{
		$committee="no";
		$role_new_id=4;
	}


$this->loadmodel('user');
$i=$this->autoincrement('user','user_id');
$random1=mt_rand(1000000000,9999999999);
$random2=mt_rand(1000000000,9999999999);
$random=$random1.$random2 ;	
$de_user_id=$this->encode($i,'housingmatters');
$random=$de_user_id.'/'.$random;


if(!empty($mobile)){ if(empty($email)) {

	$random=(string)mt_rand(1000,9999);

	$r_sms=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_sms_ip'));
	$working_key=$r_sms->working_key;
	$sms_sender=$r_sms->sms_sender; 	
	$sms_allow=(int)$r_sms->sms_allow;
	if($sms_allow==1){
	
		$user_name_short=$this->check_charecter_name($name);

		$sms="".$user_name_short.", Your housing society  ".$s_n." has enrolled  you in HousingMatters portal. Pls log into www.housingmatters.in One Time Password ".$random."";
		 $sms1=str_replace(" ", '+', $sms);
		$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
   }
 }
}

$this->user->saveAll(array('user_id' => $i, 'user_name' => $name,'email' => $email, 'mobile' => $mobile,  'society_id' => $society_id, 'date' => $date, 'time' => $time,'signup_random'=>$random,'active'=>'yes',"user_type"=>"member",'profile_pic'=>'blank.jpg'));
 
$this->loadmodel('user_role');
$auto_id=$this->autoincrement('user_role','auto_id');
$this->user_role->saveAll(array('auto_id' => $auto_id, 'user_id' => $i,'role_id' =>$role_new_id,'default'=>'yes','society_id' => $society_id));

if($committee=="yes"){
$auto_id=$this->autoincrement('user_role','auto_id');
$this->user_role->saveAll(array('auto_id' => $auto_id, 'user_id' => $i,'role_id' => 2,'society_id' => $society_id));
}



$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>$society_id,'wing'=>$wing,'flat'=>$flat,'exited'=>'no','owner'=>$owner));
 
if($owner=="yes"){
$this->loadmodel('ledger_sub_account');
$j=$this->autoincrement('ledger_sub_account','auto_id');
$this->ledger_sub_account->save(array('auto_id'=>$j,'ledger_id'=>34,'name'=>$name,'society_id' => $society_id,'user_flat_id'=>$user_flat_id,'exited'=>'no','user_id' => $i));
}
		 
///////////////  Insert code ledger Sub Accounts //////////////////////

/////////////  End code ledger sub accounts //////////////////////////
$special="'";	

	
if(!empty($email) && !empty($mobile)){
$login_user=$email;

 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 '.$special.'We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/send_sms_for_verify_mobile?q='.$random.'"> Click here </a> for one time verification of your mobile number and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

	

}
		
if(!empty($email) && empty($mobile)){


$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 '.$special.'We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/set_new_password?q='.$random.'"> Click here </a> for one time verification of your email and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

}
$from_name="HousingMatters";
$reply="support@housingmatters.in";
$to=$email;
$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$subject="Welcome to ".$society_name." portal ";
if(!empty($email))
{
$this->send_email($to,$from,$from_name,$subject,@$message_web,$reply);
}

////////////////Notification email user all checked code  //////////////////////////
$this->loadmodel('email');	
$conditions=array('notification_id'=>1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach($result_email as $data)
{
$auto_id = (int)$data['email']['auto_id'];
$this->loadmodel('notification_email');
$lo=$this->autoincrement('notification_email','notification_id');
$this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id , "user_id" => $i,'chk_status'=>0));
}

//////////////// End all checked code   //////////////////////////



?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
New member registered into your society successfully.
</div> 
<div class="modal-footer">
<a href="hm_new_user_enrollment" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php
a:
} 
}


function new_user_enrollment(){
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();
$s_society_id=$this->Session->read('hm_society_id');

$this->loadmodel('wing');
$conditions=array("society_id" => $s_society_id);
$order=array('wing.wing_name'=>'ASC');	
$wings = $this->wing->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set(compact("wings"));
}

function new_user_enrollment2()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
//$this->check_user_privilages();
$this->ath();
$s_society_id=(int)$this->Session->read('hm_society_id');

$this->loadmodel('wing');
$conditions=array("society_id" => $s_society_id);
$result_wing = $this->wing->find('all',array('conditions'=>$conditions));
$this->set('result_wing',$result_wing);
}

function import_flat_configuration()
{
	$this->layout="blank";
	$this->ath();
	$s_society_id=$this->Session->read('society_id');
	
	$this->loadmodel('wing');
	$conditions=array("society_id" => $s_society_id);
	$result_wing = $this->wing->find('all',array('conditions'=>$conditions));
	$this->set('result_wing',$result_wing);
	
	$this->loadmodel('flat_type_name');
	$result_flat_type = $this->flat_type_name->find('all');
	$this->set('result_flat_type',$result_flat_type);
	
	if(isset($_FILES['file'])){
		 $file_name=$_FILES['file']['name'];
		
		$file_tmp_name =$_FILES['file']['tmp_name'];
		$target = "csv_file/";
		$target=@$target.basename($file_name);
		move_uploaded_file($file_tmp_name,@$target);
		
		$f = fopen('csv_file/'.$file_name, 'r') or die("ERROR OPENING DATA");
		
		$batchcount=0;
		$records=0;
		while (($line = fgetcsv($f, 4096, ';')) !== false) {
		// skip first record and empty ones
		 $numcols = count($line);

		$test[]=$line;

		//echo $col = $line[0];
		//echo $batchcount++.". ".$col."\n";


		++$records;
		}

		fclose($f);
		$records;
	}
	
	$i=0;
	foreach($test as $child){ 
		if($i>0){
			
					 $child_ex=explode(',',$child[0]);
					 $wing_name=$child_ex[0];
					 $flat_name=$child_ex[1];
					 $flat_type=$child_ex[2];
					 @$flat_area=$child_ex[3];
			if(!empty($flat_type))
            {			
			$this->loadmodel('wing'); 
			$conditions=array("society_id"=>$s_society_id,"wing_name"=> new MongoRegex('/^' .  $wing_name . '$/i'));
			$result_wing=$this->wing->find('all',array('conditions'=>$conditions));
			 $result_wing_count=sizeof($result_wing);

			$wing_id=0;
			$flat_id=0;
			if($result_wing_count>0){
			  $wing_id=$result_wing[0]['wing']['wing_id'];
				
				//$this->loadmodel('flat'); 
				//$conditions=array("wing_id"=>$wing_id,"flat_name"=> new MongoRegex('/^' .  $flat_name . '$/i'));
				//$result_flat=$this->flat->find('all',array('conditions'=>$conditions));
				//$result_flat_count=sizeof($result_flat);

				//if($result_flat_count>0){
					//$flat_id=$result_flat[0]['flat']['flat_id'];	
				//}
			
			}
			
			$this->loadmodel('flat_type_name'); 
			$conditions=array("flat_name"=> new MongoRegex('/^' .  $flat_type . '$/i'));
			$result_flat_type_name=$this->flat_type_name->find('all',array('conditions'=>$conditions));
			 $result_f_t_count=sizeof($result_flat_type_name);
				if($result_f_t_count>0){
					$flat_type_id=@$result_flat_type_name[0]['flat_type_name']['auto_id'];	
				}else{
					$flat_type_id=0;
				}	 
					
					 $table[]=array($wing_id,$flat_name,$flat_type_id,@$flat_area);
			}
		} $i++;
	}
	
	$this->set('table',$table);
	
}

function import_user_ajax()
{
	$this->layout="blank";
	$this->ath();
	 
	$s_society_id=$this->Session->read('hm_society_id');
	$this->loadmodel('wing');
	$conditions=array("society_id" => $s_society_id);
	$result_wing = $this->wing->find('all',array('conditions'=>$conditions));
	$this->set('result_wing',$result_wing);
	

	if(isset($_FILES['file'])){
		$file_name=$_FILES['file']['name'];
		$file_tmp_name =$_FILES['file']['tmp_name'];
		$target = "csv_file/";
		$target=@$target.basename($file_name);
		move_uploaded_file($file_tmp_name,@$target);
		
		$f = fopen('csv_file/'.$file_name, 'r') or die("ERROR OPENING DATA");
		$batchcount=0;
		$records=0;
		while (($line = fgetcsv($f, 4096, ';')) !== false) {
		// skip first record and empty ones
		$numcols = count($line);

		$test[]=$line;

		//echo $col = $line[0];
		//echo $batchcount++.". ".$col."\n";


		++$records;
		}

		fclose($f);
		$records;
	}
	
	
	$i=0;
	
	foreach($test as $child){
		if($i>0){
			$child_ex=explode(',',$child[0]);
			$name=trim($child_ex[0]);
			$wing_name=trim($child_ex[1]);
			$flat_name=trim($child_ex[2]);
			$email=trim($child_ex[3]);
			$mobile=trim($child_ex[4]);
			$owner=trim($child_ex[5]);
			$committee=trim($child_ex[6]);
			//$noc=$child_ex[7];
			
			$this->loadmodel('wing'); 
			$conditions=array("society_id"=>$s_society_id,"wing_name"=> new MongoRegex('/^' .  $wing_name . '$/i'));
			$result_wing=$this->wing->find('all',array('conditions'=>$conditions));
			$result_wing_count=sizeof($result_wing);

			$wing_id=0;
			$flat_id=0;
			if($result_wing_count>0){
				$wing_id=$result_wing[0]['wing']['wing_id'];
				
				$this->loadmodel('flat'); 
				$conditions=array("wing_id"=>$wing_id,"flat_name"=>(int)$flat_name);
				$result_flat=$this->flat->find('all',array('conditions'=>$conditions));
				$result_flat_count=sizeof($result_flat);

				if($result_flat_count>0){
					$flat_id=$result_flat[0]['flat']['flat_id'];	
				}
			}
			
			$owner_id=0;
			$committee_id=0;
			$noc_id=0;
			if(!empty($owner)){
				$result_owner_yes = strcasecmp($owner, 'yes');
				$result_owner_no = strcasecmp($owner, 'no');
				if ($result_owner_yes == 0){
				$owner_id=1;
				}
				if ($result_owner_no == 0){
				$owner_id=2;
				}
			}
			
			if(!empty($committee)){
				$result_committee_yes = strcasecmp($committee, 'yes');
				$result_committee_no = strcasecmp($committee, 'no');
				if ($result_committee_yes == 0){
				$committee_id=1;
				}
				if ($result_committee_no == 0){
				$committee_id=2;
				}
			}
			
			/*if(!empty($noc)){
				$result_noc_yes = strcasecmp($noc, 'yes');
				$result_noc_no = strcasecmp($noc, 'no');
				if ($result_noc_yes == 0){
				$noc_id=1;
				}
				if ($result_noc_no == 0){
				$noc_id=2;
				}
			} */
			
			
			
			$table[]=array($name,$wing_id,$flat_id,$email,$mobile,$owner_id,$committee_id);
		}
		$i++;
	}
	$this->set('table',$table);
	
	
	
}

function user_enrollment_ajax_add_row()
{
$this->layout="blank";
$h=(int)$this->request->query('q');
$this->set('h',$h);
$s_society_id=$this->Session->read('hm_society_id');

$this->loadmodel('wing');
$conditions=array("society_id" => $s_society_id);
$result_wing = $this->wing->find('all',array('conditions'=>$conditions));
$this->set('result_wing',$result_wing);
}



function new_user_enrollment12345()
{
$this->layout="session";
$this->ath();
$this->check_user_privilages();
App::import('', 'sendsms.php');
$s_society_id=$this->Session->read('society_id');
$this->loadmodel('wing');
$conditions=array('society_id'=>$s_society_id);
$result=$this->wing->find('all',array('conditions'=>$conditions));
$this->set('result_wing',$result);
$res_society=$this->society_name($s_society_id);
foreach($res_society as $data)
{
 $society_name=$data['society']['society_name'];

}
$s_n='';
$sco_na=$society_name;
$dd=explode(' ',$sco_na);
 $first=$dd[0];
 $two=$dd[1];
 $three=$dd[2];
$s_n.=" $first $two $three ";



if($this->request->is('post')) 
{
date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$name=$this->request->data['name'];
$email=$this->request->data['email'];
$mobile=$this->request->data['mobile'];
$wing=(int)$this->request->data['wing'];
$flat=(int)$this->request->data['flat'];
$residing=(int)$this->request->data['residing'];
$tenant=(int)$this->request->data['tenant'];
if($tenant==1)
{
$committee=(int)$this->request->data['committe'];
}
else
{
$committee=2;
}
$role_id[]=2;
$default_role_id=2;
if($committee==1)
{
$role_id[]=1;
}

$this->loadmodel('user');
$i=$this->autoincrement('user','user_id');
$log_i=$this->autoincrement('login','login_id');
$random1=mt_rand(1000000000,9999999999);
$random2=mt_rand(1000000000,9999999999);
$random=$random1.$random2 ;	
$de_user_id=$this->encode($i,'housingmatters');
$random=$de_user_id.'/'.$random;
if(!empty($mobile))
{
if(empty($email))
{
$r_sms=$this->hms_sms_ip();
$working_key=$r_sms->working_key;
$sms_sender=$r_sms->sms_sender; 
$sms_allow=(int)$r_sms->sms_allow;

$login_user=$mobile;
$random=(string)mt_rand(1000,9999);
if($sms_allow==1){
$sms="".$name.", Your housing society ".$s_n." has enrolled you in HousingMatters portal. Pls log into www.housingmatters.co.in One Time Password ".$random."";
$sms1=str_replace(" ", '+', $sms);
$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
}
}
}

$this->user->save(array('user_id' => $i, 'user_name' => $name,'email' => $email, 'password' => @$random, 'mobile' => $mobile,  'society_id' => $s_society_id, 'tenant' => $tenant, 'wing' => $wing, 'flat' => $flat,'residing' => $residing, 'date' => $date, 'time' => $time,"profile_pic"=>'blank.jpg','sex'=>'','role_id'=>$role_id,'default_role_id'=>$default_role_id,'signup_random'=>$random,'deactive'=>0,'login_id'=>$log_i,'s_default'=>1));




///////////////  Insert code ledger Sub Accounts //////////////////////

$this->loadmodel('ledger_sub_account');
$j=$this->autoincrement('ledger_sub_account','auto_id');
$this->ledger_sub_account->save(array('auto_id'=>$j,'ledger_id'=>34,'name'=>$name,'society_id' => $s_society_id,'user_id'=>$i,'deactive'=>0));

/////////////  End code ledger sub accounts //////////////////////////

	
	
if(!empty($email) && !empty($mobile))
{
$login_user=$email;	
	
$message_web="<div>
<img src='http://123.63.2.150:8080".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $name,</p>
<p>'We at $society_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.</p>
<p>As you are an owner/resident/staff of $society_name, we have added your email address in HousingMatters portal.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>
<p>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</p>
<p>You can receive important SMS & emails from your committee.</p>
<br/>				
<p><b>
<a href='http://123.63.2.150:8080".$this->webroot."/hms/send_sms_for_verify_mobile?q=$random'>Click here</a> for one time verification of your mobile number and Login into HousingMatters  for making life simpler for all your housing matters!</b></p>
<br/>
<p>Pls add www.housingmatters.co.in in your favorite bookmarks for future use.</p>
<p>Regards,</p>	
<p>Administrator of $society_name</p><br/>
www.housingmatters.co.in
</div >
</div>";
}
		
if(!empty($email) && empty($mobile))
{
	$login_user=$email;	
$message_web="<div>
<img src='http://123.63.2.150:8080".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='http://123.63.2.150:8080".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $name,</p>
<p>'We at $society_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.</p>
<p>As you are an owner/resident/staff of $society_name, we have added your email address in HousingMatters portal.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>
<p>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</p>
<p>You can receive important SMS & emails from your committee.</p>
<br/>				
<p><b><a href='http://123.63.2.150:8080".$this->webroot."/hms/set_new_password?q=$random'>Click here</a> for one time verification of your email and Login into HousingMatters  for making life simpler for all your housing matters!</b></p>
<br/>
<p>Pls add www.housingmatters.co.in in your favorite bookmarks for future use.</p>
<p>Regards,</p>	
<p>Administrator of $society_name</p><br>
www.housingmatters.co.in
</div >
</div>";
}
$from_name="HousingMatters";
$reply="support@housingmatters.in";
$to=$email;
$this->loadmodel('email');
$conditions=array("auto_id" => 4);
$result_email = $this->email->find('all',array('conditions'=>$conditions));
foreach ($result_email as $collection) 
{
$from=$collection['email']['from'];
}
$subject="Welcome to ".$society_name." portal ";
if(!empty($email))
{
$this->send_email($to,$from,$from_name,$subject,@$message_web,$reply);
}
////////////////Notification email user all checked code  //////////////////////////
$this->loadmodel('email');	
$conditions=array('notification_id'=>1);
$result_email=$this->email->find('all',array('conditions'=>$conditions));
foreach($result_email as $data)
{
$auto_id = (int)$data['email']['auto_id'];
$this->loadmodel('notification_email');
$lo=$this->autoincrement('notification_email','notification_id');
$this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id , "user_id" => $i,'chk_status'=>0));
}

//////////////// End all checked code   //////////////////////////

////////////////////  insert login table  ///////////////////

$this->loadmodel('login');
$this->login->save(array('login_id'=>$log_i,'user_name'=>$login_user,'password'=>$random,'signup_random'=>$random,'mobile'=>$mobile));

//////////////////////////////////////////////////////////////////


?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
New member registered into your society successfully.
</div> 
<div class="modal-footer">
<a href="society_member_view" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php
}
}




/////////////////////////////////// End  new User Enrolment ////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



////////////////////////////////////////////////////////// New Tenant Enrollment Start //////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



function new_tenant_edit($id=null){
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$id=(int)$id;
	$s_society_id=$this->Session->read('hm_society_id');
	$this->ath();
	$this->loadmodel('tenant');	
		
	$conditions1=array('user_id'=>$id);
	$result1=$this->tenant->find('all',array('conditions'=>$conditions1));	

	$this->set('result_tenant',$result1);
	
if($this->request->is('post')){
	
	date_default_timezone_set('Asia/kolkata');
	$date=date("d-m-Y");
	$time=date('h:i:a',time());
	$name_tenant=$this->request->data['name_tenant'];
	$address=$this->request->data['address'];
	$start_date=$this->request->data['start_date'];
	$end_date=$this->request->data['end_date'];
	$verification=$this->request->data['verification'];
	$ten_age=(int)@$this->request->data['ten_agr'];
	$pol_ver=(int)@$this->request->data['pol_ver'];

	$this->loadmodel('tenant');
	$this->tenant->updateAll(array("t_start_date"=>$start_date,"t_end_date"=>$end_date,"t_address"=>$address,"verification"=>$verification,'t_agreement'=>$ten_age,'t_police'=>$pol_ver),array("user_id" => $id));
?>


	<!----alert-------------->
	<div class="modal-backdrop fade in"></div>
	<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
	<div class="modal-body" style="font-size:16px;">
	Successfully Update.
	</div> 
	<div class="modal-footer">
	<a href="<?php echo $this->webroot; ?>Hms/new_tenant_enrollment_view" class="btn green">OK</a>
	</div>
	</div>
	<!----alert-------------->
	<?php

	
		
}
	
}


function new_tenant_enrollment(){
	
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	
			$this->ath();
			$this->check_user_privilages();
			$s_society_id=$this->Session->read('hm_society_id');

			$this->loadmodel('user_flat');
			$conditions=array("society_id"=>$s_society_id, "owner"=>"no");
			$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions));
				foreach($result_user_flat as $data){
					$user_id=(int)$data["user_flat"]["user_id"];
					$wing=$data["user_flat"]["wing"];
					$flat=$data["user_flat"]["flat"];
					$owner=$data["user_flat"]["owner"];
					
					$this->loadmodel('wing');
					$conditions=array("wing_id"=>$wing);
					$wing_info=$this->wing->find('all',array('conditions'=>$conditions));
					$wing_name=$wing_info[0]["wing"]["wing_name"];

					$this->loadmodel('flat');
					$conditions=array("flat_id"=>$flat);
					$flat_info=$this->flat->find('all',array('conditions'=>$conditions));
					$flat_name=ltrim($flat_info[0]["flat"]["flat_name"],'0');

					$flats=$wing_name.' - '.$flat_name;

					$this->loadmodel('user');
					$conditions=array("user_id"=>$user_id);
					$result_user=$this->user->find('all',array('conditions'=>$conditions));

					$this->loadmodel('tenant');
					$conditions=array("user_id"=>$user_id);
					$result_user_tenant=$this->tenant->find('all',array('conditions'=>$conditions));
					
					
					
					
					$result_tenant_info[]=array("wing_name"=>$flats,"result_user"=>$result_user,"result_user_tenant"=>$result_user_tenant);
				}
		
			if(!empty($result_tenant_info)){
				$this->set('result_tenant_info',$result_tenant_info);
			}
}

function new_tenant_enrollment_ajax()
{
$this->layout='blank';
$s_society_id=$this->Session->read('society_id');
$t=(int)$this->request->query('con');
$this->loadmodel('tenant');	
$conditions1=array('user_id'=>$t);
$result1=$this->tenant->find('all',array('conditions'=>$conditions1));	
$this->set('result_tenant',$result1);
$this->loadmodel('user');	
$conditions2=array('user_id'=>$t);
$result2=$this->user->find('all',array('conditions'=>$conditions2));	
$this->set('result_user',$result2);
$this->loadmodel('wing');
$conditions=array('society_id'=>$s_society_id);
$result3=$this->wing->find('all',array('conditions'=>$conditions));
$this->set('result_wing',$result3);

}

function new_tenant_data_fetch($id){
	
	$s_society_id=(int)$this->Session->read('society_id');
	$this->loadmodel('tenant');
	$conditions=array('user_id'=>$id,'society_id'=>$s_society_id);
	return $this->tenant->find('all',array('conditions'=>$conditions));
}
function new_tenant_file_upload(){
	
	$this->layout=null;
	$this->ath();
	$s_role_id=$this->Session->read('role_id');
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('hm_user_id');
	$post_data=$this->request->data;
	$tenant_id=(int)$post_data['tenant_id'];
	$file_name=@$_FILES["file"]["name"];
				if(!empty($file_name)){
					$file_name=$_FILES["file"]["name"];
					$file_tmp_name =$_FILES['file']['tmp_name'];
					$target = "tenant_upload/";
					$target=@$target.basename($file_name);
					move_uploaded_file($file_tmp_name,@$target);
				}
			$this->loadmodel('tenant');
			$this->tenant->updateAll(array("t_file"=>$file_name),array("user_id" => $tenant_id));
}

function new_tenant_enrollment_ajax1(){
	$this->layout=null;
	$this->ath();
	 $s_society_id=(int)$this->Session->read('hm_society_id');
	  $t_id=(int)$this->request->query('con');
	  $update_field=$this->request->query('con2');
	  $whichplace=$this->request->query('con3');
	  $file_name=@$_FILES[$update_field]["name"];
	
	$this->loadmodel('tenant');
	$conditions=array('user_id'=>$t_id,'society_id'=>$s_society_id);
	$result_tenant=$this->tenant->find('all',array('conditions'=>$conditions));
	$n=sizeof($result_tenant);
	if($n==0){
		$date=date("d-m-Y");
		$time=date('h:i:a',time());
		$result_user=$this->profile_picture($t_id);
		$user_name=$result_user[0]['user']['user_name'];
		$mobile=$result_user[0]['user']['mobile'];
		
			if($whichplace=='permanet_address'){
				
				$i=$this->autoincrement('tenant','tenant_id');
				$this->loadmodel('tenant');
				$this->tenant->saveAll((array("tenant_id" => $i, "name" => $user_name , "user_id" => $t_id,"society_id"=>$s_society_id,"t_time"=>$time,"t_mobile"=>$mobile,"t_address"=>$update_field)));

				
			}
			if($whichplace=='tenancy_start'){
				
				$i=$this->autoincrement('tenant','tenant_id');
				$this->loadmodel('tenant');
				$this->tenant->saveAll((array("tenant_id" => $i, "name" => $user_name , "user_id" => $t_id,"society_id"=>$s_society_id,"t_time"=>$time,"t_mobile"=>$mobile,"t_start_date"=>$update_field)));

				
			}
			
			if($whichplace=='tenancy_end'){
				
				$i=$this->autoincrement('tenant','tenant_id');
				$this->loadmodel('tenant');
				$this->tenant->saveAll((array("tenant_id" => $i, "name" => $user_name , "user_id" => $t_id,"society_id"=>$s_society_id,"t_time"=>$time,"t_mobile"=>$mobile,"t_end_date"=>$update_field)));

				
			}
			
			if($whichplace=='verification'){
				
				$i=$this->autoincrement('tenant','tenant_id');
				$this->loadmodel('tenant');
				$this->tenant->saveAll((array("tenant_id" => $i, "name" => $user_name , "user_id" => $t_id,"society_id"=>$s_society_id,"t_time"=>$time,"t_mobile"=>$mobile,"verification"=>$update_field)));

				
			}
			
			if($whichplace=='tenancy_agreement'){
				
				$i=$this->autoincrement('tenant','tenant_id');
				$this->loadmodel('tenant');
				$this->tenant->saveAll((array("tenant_id" => $i, "name" => $user_name , "user_id" => $t_id,"society_id"=>$s_society_id,"t_time"=>$time,"t_mobile"=>$mobile,"t_agreement"=>$update_field)));

				
			}
			
			if($whichplace=='police_verification'){
				
				$i=$this->autoincrement('tenant','tenant_id');
				$this->loadmodel('tenant');
				$this->tenant->saveAll((array("tenant_id" => $i, "name" => $user_name , "user_id" => $t_id,"society_id"=>$s_society_id,"t_time"=>$time,"t_mobile"=>$mobile,"t_police"=>$update_field)));

				
			}
			
			
		
	}else{
			if($whichplace=='permanet_address'){
			$this->loadmodel('tenant');
			$this->tenant->updateAll(array("t_address"=>$update_field),array("user_id" => $t_id));
			}
			if($whichplace=='tenancy_start'){
			$this->loadmodel('tenant');
			$this->tenant->updateAll(array("t_start_date"=>$update_field),array("user_id" => $t_id));
			}
			if($whichplace=='tenancy_end'){
			$this->loadmodel('tenant');
			$this->tenant->updateAll(array("t_end_date"=>$update_field),array("user_id" => $t_id));
			}
			
			if($whichplace=='verification'){
			$this->loadmodel('tenant');
			$this->tenant->updateAll(array("verification"=>$update_field),array("user_id" => $t_id));
			}
			
			if($whichplace=='tenancy_agreement'){
			$this->loadmodel('tenant');
			$this->tenant->updateAll(array("t_agreement"=>$update_field),array("user_id" => $t_id));
			}
			
			if($whichplace=='police_verification'){
			$this->loadmodel('tenant');
			$this->tenant->updateAll(array("t_police"=>$update_field),array("user_id" => $t_id));
			}
				
						
		}

}



function new_tenant_enrollment_view()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();
$s_society_id=(int)$this->Session->read('hm_society_id');
$this->loadmodel('tenant');
$condition=array('society_id'=>$s_society_id);
$result=$this->tenant->find('all',array('conditions'=>$condition)); 
$this->set('user_tenant',$result);
}

function tenant_excel(){
	
	$this->layout="";
	$s_society_id=$this->Session->read('hm_society_id');
	$result_society=$this->society_name($s_society_id);
	$society_name=$result_society[0]['society']['society_name'];
	$this->loadmodel('tenant');
	$condition=array('society_id'=>$s_society_id);
	$result=$this->tenant->find('all',array('conditions'=>$condition)); 
	$this->set('user_tenant',$result);
	$this->set(compact('society_name'));
}


////////////////////////////////////////////////////////////////End new Tenant enrollment //////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////// Start  Feedback functionality ///////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function feedback_category_name($category)
{
$this->loadmodel('feedback_category');
$conditions=array('feedback_cat_id'=>$category);
$result=$this->feedback_category->find('all',array('conditions'=>$conditions));
foreach($result as $data)
{
return $category_name=$data['feedback_category']['feedback_cat_name'];

}

}

function feedback()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');
$this->loadmodel('user');
$conditions=array('user_id'=>$s_user_id);
$result=$this->user->find('all',array('conditions'=>$conditions));
foreach($result as $data)
{
$user=$data['user']['user_name'];
$mobile=$data['user']['mobile'];
$email=$data['user']['email'];	
}
$this->set('user_name',$user);

$this->loadmodel('feedback_category');
$this->set('result_fed_cat',$this->feedback_category->find('all'));

if($this->request->is('post')) 
{
	
$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));
$feedback_cat_id=(int)$this->request->data['sel'];
$subject= htmlentities($this->request->data['subject']);
$message= htmlentities($this->request->data['mess']);
$feedback_cat_name=$this->feedback_category_name($feedback_cat_id);
$result_society=$this->society_name($s_society_id);
foreach ($result_society as $collection) 
{ 
$society_name=$collection['society']["society_name"];
}
$to = "Support@housingmatters.in";
$from="Support@housingmatters.in";
$reply="Support@housingmatters.in";
$from_name="HousingMatters"; 
 
 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
									
											<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
											<tbody>
											<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
											<tr>
											<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
											<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
											<td width="100%"><a href="#" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px" target="_blank"><span style="color:#00A0E3">Housing</span><span style="color:#777776">Matters</span></a></td>
											<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img  src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
												
											</td>
											</tr>
											<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
											</tbody>
											</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Dear Administrator, </span> 
										</td>
								
								
								</tr>
								
								
								
								
								<tr>
									<td>
									
										<table  cellpadding="5" cellspacing="0" width="100%;"border="1" style="border:1px solid #e5e5e5;">
						
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" width="200" >Name</td>
										<td align="left" style="background-color:#f8f8f8;" width="600" >'.$user.'</td>
										</tr>
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Category</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$feedback_cat_name.'</td>
										</tr>
										
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Society Name</td>
										<td align="left" style="background-color:#f8f8f8;" >'.$society_name.'</td>
										</tr>
										
										<tr>
										<td align="center" style="background-color:#00A0E3;color:white;" >Details</td>
										<td align="left" style="background-color:#f8f8f8;" >
										<p>User Email-Id: &nbsp; '.$email.'</p>
										<p>Mobile No: &nbsp; '.$mobile.' </p></td>
										</tr>
									
										</table> 
									
									</td>
								
								
								
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span> 
												<p style="font-size:16px;"> <strong>Message Description:</strong></p>
												<p>'.$message.'</p>
											</span>
									</td>
																
								</tr>
								
								<tr>
									<td style="padding:10px;" width="100%" align="center">
	<span> 
	 <a href="'.$ip.$this->webroot.'" style="width:100px;min-height:30px;background-color:rgb(0,142,213);padding:7px;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;white-space:nowrap;font-weight:bold;vertical-align:middle;font-size:14px;line-height:14px;color:rgb(255,255,255);border:1px solid rgb(2,106,158);text-decoration:none" target="_blank">View / response on HousingMatters</a>							
	</span>
									</td>
																
								</tr>
								
								
					
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>

								

					
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';



date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());
$i=$this->autoincrement('feedback','feedback_id');
$this->loadmodel('feedback');
$this->feedback->saveAll(array("feedback_id" => $i,"feedback_subject" => $subject,"feedback_date"=>$date,"feedback_category"=>$feedback_cat_id,"user_id"=>$s_user_id,"feedback_time"=>$time,"feedback_message"=>$message_web,"society_id"=>$s_society_id,"feedback_des"=>$message,'delete_id'=>0));
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);

$this->Session->write('feedback_status',1);
$this->response->header('Location', $this->webroot.'Hms/dashboard');		
	
?>     



<!----alert--------------
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Thank you for getting in touch with us. <br> We shall Respond to you within 24 hours. 
</div> 
<div class="modal-footer">
<a href="dashboard" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php


}

}


function feedback_view()
{

$this->layout='session';	
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');
$this->loadmodel('feedback');
$order=array('feedback.feedback_id'=>'DESC');
$conditions=array('delete_id'=>0);
$result=$this->feedback->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set('result_feedback',$result);	
}

function feedback_view1()
{

$this->layout='session';	
$feedback_id=(int)$this->request->query('con');
$this->loadmodel('feedback');	
$conditions=array('feedback_id'=>$feedback_id);	
$result=$this->feedback->find('all',array('conditions'=>$conditions));	
$this->set('result_feedback',$result);
if($this->request->is('post'))
{
	$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));
	 $feedback_reply=$this->request->data['feedback_reply'];
	
	foreach($result as $collection)
	{
		$da_user_id=(int)$collection['feedback']['user_id'];
		$reply_fed=@$collection['feedback']['reply'];
	}
	if(sizeof($reply_fed)==0)	{ $reply_fed=array(); }
	
	if(sizeof($reply_fed)==0)
		{
		$reply_fed[]=$feedback_reply;
		
		}
		else
		{
		$t=$feedback_reply;
		array_push($reply_fed,$t);
		}
	
	
	$result_user=$this->profile_picture($da_user_id);
	foreach($result_user as $data)
	{
		 $user_name=$data['user']['user_name'];
		 $to=$data['user']['email'];
	} 
	
	$from="Support@housingmatters.in";
	$reply="Support@housingmatters.in";
	$from_name="HousingMatters"; 
	$subject='HousingMatters';


 $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
									<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
								<tbody>
								<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								<tr>
								<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td width="100%"><a href="#" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px" target="_blank"><span style="color:#00A0E3">Housing</span><span style="color:#777776">Matters</span></a></td>
								<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img  src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
									
								</td>
								</tr>
								<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								</tbody>
								</table>
									
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span>
											<p style="font-size:16px;"> <strong>Message:</strong></p>';
											foreach($reply_fed as $data){
												$message_web.=$data;
											}
											
										$message_web.='</span> 
										</td>
																
								</tr>
								
								
								

								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span style="color:rgb(100,100,99)"> 
												Thank you.<br/>
												HousingMatters (Support Team)<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

$this->loadmodel('feedback');
$this->feedback->updateAll(array('reply'=>$reply_fed),array('feedback_id'=>$feedback_id));
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);		
?>

<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Successfully reply.
</div> 
<div class="modal-footer">
<a href="feedback_view" class="btn green">OK</a>
</div>
</div>
<!----alert-------------->



<?php	
}

	
}

function feedback_delete()
{
	$this->layout="blank";
	$fed_id=(int)$this->request->query('con');
	$this->loadmodel('feedback');
	$this->feedback->updateAll(array('delete_id'=>1),array('feedback_id'=>$fed_id));
	$this->response->header('Location','feedback_view');
	
}

/////////////////////////////////////// End Feedback functionality /////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////// Start Invitation Member ////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////

function invite_member()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$this->check_user_privilages();
$s_society_id=(int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
if(isset($this->request->data['sub'])) 
{
	$ip=$this->hms_email_ip();
date_default_timezone_set('Asia/Kolkata');
$date=date("d-m-Y");
$time = date(' h:i a', time());
$from_name="HousingMatters";
$reply="Support@housingmatters.in";
$from="alerts@housingmatters.in";
$this->loadmodel('society');
$condition=array('society_id'=>$s_society_id);
$result_society=$this->society->find('all',array('conditions'=>$condition));
foreach($result_society as $data)
{
$society_name=$data['society']['society_name'];
}
$result_user=$this->profile_picture($s_user_id);
foreach($result_user as $dd)
{
	$user_name=$dd['user']['user_name'];
	$role_id=$dd['user']['role_id'];
	$wing=$dd['user']['wing'];
	$flat=$dd['user']['flat'];
}
if(in_array(3,$role_id))
{
	 $role='Admin';
}

if(!in_array(3,$role_id))
{
	 $role=$this->wing_flat($wing,$flat);
	
}
 @$radio=$this->request->data['committe'];
if($radio==1)
{
  $subject="".$society_name." - Invitation to HousingMatters"; 
}
if($radio==0)
{

 $subject="".$user_name." - Invites you to HousingMatters "; 
}

$r=$this->request->data['hid_name'];
for($i=2;$i<=$r;$i++)
{
$to=$this->request->data['email'.$i];
$name_user=$this->request->data['name_user'.$i];
if($radio==1)
{
/* $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $name_user,</p>
<p>We at $society_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.</p>
<p>As you are an owner/resident/staff of $society_name, I have added your email address in HousingMatters portal.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>
<ul type='disc'>
<li>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</li>
<li>You can receive important SMS & emails from your committee.</li>
</ul>
<p>Signup today to <a href='$ip".$this->webroot."/hms/sign_up''>HousingMatters </a> for making life simpler for all your housing matters!</p>
<p>Regards,<br/>
$user_name $role  <br/>
www.housingmatters.co.in
</div >
</div>"; */

  $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
				
								
								<tr>
									<td colspan="2">
									<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
								<tbody>
								<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								<tr>
								<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td width="100%"><a href="#" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px" target="_blank"><span style="color:#00A0E3">Housing</span><span style="color:#777776">Matters</span></a></td>
								<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img  src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
									
								</td>
								</tr>
								<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								</tbody>
								</table>
									
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						

									
									<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Dear '.$name_user.', </span> 
										</td>
																
									</tr>

								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
											<ul type="disc">
											<li>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</li>
											<li>You can receive important SMS & emails from your committee.</li>
											</ul>		
										</td>
																
								</tr>

									
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> 
											Signup today to <a href="'.$ip.$this->webroot.'hms/sign_up" style="text-decoration:none;" > HousingMatters </a> for making life simpler for all your housing matters!
																					
											</span> 
										</td>
																
								</tr>
								
								
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												'.$user_name.' '. $role .' <br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';



}

if($radio==0)
{
 /* $message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $name_user,</p>
<p>We at $society_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>
<ul type='disc'>
<li>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</li>
<li>You can receive important SMS & emails from your committee.</li>
</ul>
<p>Signup today to <a href='$ip".$this->webroot."/hms/sign_up''>HousingMatters </a> for making life simpler for all your housing matters!</p>
<p>Regards,<br/>
$user_name <br/>
www.housingmatters.co.in
</div >
</div>"; */

  $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
				
								
								<tr>
									<td colspan="2">
									<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
								<tbody>
								<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								<tr>
								<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td width="100%"><a href="#" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px" target="_blank"><span style="color:#00A0E3">Housing</span><span style="color:#777776">Matters</span></a></td>
								<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img  src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
									
								</td>
								</tr>
								<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								</tbody>
								</table>
									
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						

									
									<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Dear '.$name_user.', </span> 
										</td>
																
									</tr>

								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
											<ul type="disc">
											<li>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</li>
											<li>You can receive important SMS & emails from your committee.</li>
											</ul>		
										</td>
																
								</tr>

									
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> 
											Signup today to <a href="'.$ip.$this->webroot.'hms/sign_up" style="text-decoration:none;" > HousingMatters </a> for making life simpler for all your housing matters!
																					
											</span> 
										</td>
																
								</tr>
								
								
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												'.$user_name.'  <br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';



}

$this->loadmodel('invitation');
$j= $this->autoincrement('invitation','invite_id');
$this->invitation->saveAll(array('invite_id'=>$j,'name'=>$name_user,'email'=>$to,'user_id'=>$s_user_id,'society_id'=>$s_society_id,'date'=>$date,'time'=>$time,'subject'=>$subject));
$this->send_email($to,$from,$from_name,$subject,$message_web,$reply); 
}
$this->Session->write('invite_status', 1);
}
}


function invite_member_view()
{
if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$this->check_user_privilages();
$s_society_id=(int)$this->Session->read('society_id');
$this->loadmodel('invitation');
$condition=array('society_id'=>$s_society_id);
$order=array('invitation.date'=>'DESC');
$result=$this->invitation->find('all',array('conditions'=>$condition,'order'=>$order));
$this->set('result_invitation',$result);
}
function invitation_remainder()
{
$this->layout='session';
$ip=$this->hms_email_ip();
$s_society_id=(int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->loadmodel('invitation');
$result= $this->invitation->find('all');
foreach($result as $data)
{
$check_email=$data['invitation']['email'];
 $check_date=$data['invitation']['date'];
$name_user=$data['invitation']['name'];
$subject=$data['invitation']['subject'];
$society_id=(int)$data['invitation']['society_id'];
$this->loadmodel('user');
$condition1=array('email'=>$check_email);
$result1=$this->user->find('all',array('conditions'=>$condition1));
$n=sizeof($result1);

if($n==0)
{
date_default_timezone_set('Asia/Kolkata');
$current_date=date("d-m-Y");

$r_date= date('d-m-Y', strtotime($check_date. ' + 7 days'));

if(strtotime($r_date)<strtotime($current_date))
{
  $to=$check_email;
	
$from_name="HousingMatters";
$reply="donotreply@housingmatters.in";
$from="alerts@housingmatters.in";
$this->loadmodel('society');
$condition=array('society_id'=>$society_id);
$result_society=$this->society->find('all',array('conditions'=>$condition));
foreach($result_society as $data)
{
$society_name=$data['society']['society_name'];
}
/*$message_web="<div>
<img src='$ip".$this->webroot."/as/hm/hm-logo.png'/><span  style='float:right; margin:2.2%;'>
<span class='test' style='margin-left:5px;'><a href='https://www.facebook.com/HousingMatters.co.in' target='_blank' ><img src='$ip".$this->webroot."/as/hm/fb.png'/></a></span>
<a href='#' target='_blank'><img src='$ip".$this->webroot."/as/hm/tw.png'/></a><a href'#'><img src='$ip".$this->webroot."/as/hm/ln.png'/ class='test' style='margin-left:5px;'></a></span>
</br><p>Dear $name_user,</p>
<p>We at $society_name use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.</p>
<p>As you are an owner/resident/staff of $society_name, I have added your email address in HousingMatters portal.</p>
<p>Here are some of the important features related to our portal on HousingMatters:</p>
<ul type='disc'>
<li>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</li>
<li>You can receive important SMS & emails from your committee.</li>
</ul>
<p>Signup today to <a href='$ip".$this->webroot."/hms/sign_up''>HousingMatters </a> for making life simpler for all your housing matters!</p>
<p>Regards,<br/>
Administrator of $society_name <br/>
<a href='http://www.housingmatters.co.in''>www.housingmatters.co.in </a>
</p><br/>
Thank you.<br/>
HousingMatters (Support Team)<br/><br/>
www.housingmatters.co.in
</div >
</div>"; */


$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
				
								
								<tr>
									<td colspan="2">
									<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
								<tbody>
								<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								<tr>
								<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#" style="color:#3b5998;text-decoration:none" target="_blank"><img src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
								<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
								<td width="100%"><a href="#" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px" target="_blank"><span style="color:#00A0E3">Housing</span><span style="color:#777776">Matters</span></a></td>
								<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img  src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
									
								</td>
								</tr>
								<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
								</tbody>
								</table>
									
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						

									
									<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span  align="justify"> Dear '.$name_user.', </span> 
										</td>
																
									</tr>

								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
											<ul type="disc">
											<li>You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.</li>
											<li>You can receive important SMS & emails from your committee.</li>
											</ul>		
										</td>
																
								</tr>

									
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> 
											Signup today to <a href="'.$ip.$this->webroot.'hms/sign_up" style="text-decoration:none;" > HousingMatters </a> for making life simpler for all your housing matters!
																					
											</span> 
										</td>
																
								</tr>
								
								
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.' <br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';

$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
}
}
}

}
////////////////////////////End Invitation Member ///////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////// Governance_designation ////////////////////////////////////////
/*

function governance_designation()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
$this->ath();
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$this->loadmodel('governance_designation');
$condition=array('society_id'=>$s_society_id);
$result=$this->governance_designation->find('all',array('conditions'=>$condition)); 
$this->set('result_governance_designation',$result);

}
function designation_edit()
{
	$this->layout='blank';
	$designation_id=(int)$this->request->query('d_id');
	 $edit=(int)$this->request->query('edit');
	 $this->set('edit',$edit);
	if($edit==0)
	{
	$this->loadmodel('governance_designation');
	$conditions=array("governance_designation_id" => $designation_id);
	$des_result=$this->governance_designation->find('all', array('conditions' => $conditions));
	$this->set('des_result',$des_result);
	}
	if($edit==1)
	{
	$des=$this->request->query('des');	
		
	}
	
}
function governance_designation_ajax()
{
	$this->layout=null;	
	$post_data=$this->request->data;
	$s_society_id=$this->Session->read('society_id');
	$s_user_id=$this->Session->read('user_id');
	$date=date('d-m-Y');
	$time = date(' h:i a', time());	
	$designation = htmlentities($post_data['designation']);
	$report = array();
	if(empty($designation)){
	$report[]=array('label'=>'win', 'text' => 'Please Fill designation Name');
	}
				
	if(sizeof($report)>0)
	{
	$output=json_encode(array('report_type'=>'error','report'=>$report));
	die($output);
	}
	
	
	$this->loadmodel('governance_designation');
	$governance_designation_id=$this->autoincrement('governance_designation','governance_designation_id');
	$this->governance_designation->saveAll(array('governance_designation_id'=>$governance_designation_id,'society_id'=>$s_society_id,'user_id'=>$s_user_id,'date'=>$date,'time'=>$time,'designation_name'=>$designation));

$output=json_encode(array('report_type'=>'publish','report'=>'Designation Inserted Successfully'));
die($output);
	
}
*/
//////////////////////////  end deginations ////////////////////////////////////////////



///////////////////////////////////////////////// Society Setup //////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function master_sm_wing_ajax()
{
$this->layout='blank';




$s_society_id=(int)$this->Session->read('hm_society_id');
$wing=$this->request->query['wing_name'];
$this->loadmodel('wing');
$conditions=array("wing_name" => $wing,'society_id'=>$s_society_id);
$result3 = $this->wing->find('all',array('conditions'=>$conditions));
$n3 = sizeof($result3);
if ($n3 > 0) {
echo "false";
} else {
echo "true";
}
}
 /////////////////// Start Master Sm wing////////////////////////////////////// 

function master_sm_wing()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}

	
$this->ath();
$this->check_user_privilages();	
	
 $s_society_id=$this->Session->read('hm_society_id');  
if(isset($this->request->data['sub'])) 
{
echo $wing_name=htmlentities($this->request->data['wing_name']);
exit;
//$no_of_flat = (int)$this->request->data['nu'];
$this->loadmodel('wing');
$i=$this->autoincrement('wing','wing_id');
$this->wing->saveAll(array("wing_id" => $i,"society_id"=> $s_society_id,"wing_name"=>$wing_name));


}
$this->loadmodel('wing');
$condition=array('society_id'=>$s_society_id);
$order=array('wing.wing_name'=> 'ASC');
$result=$this->wing->find('all',array('conditions'=>$condition,'order'=>$order)); 
$this->set('user_wing',$result);


}

function delete_wing($wing_id=null){
	$this->loadmodel('flat');
	$conditions=array("wing_id"=>(int)$wing_id);
	$count= $this->flat->find('count',array('conditions'=>$conditions));
	if($count==0){
		$this->loadmodel('wing');
		$this->wing->deleteAll(array("wing_id" => (int)$wing_id));
	}
	$this->redirect(array('action' => 'master_sm_wing'));
}
 /////////////////////////////////////////// End Master Sm wing ////////////////////////////////////////////////// 


/////////////////////////////// Start Master Sm Flat//////////////////////////////////////
function master_sm_flat()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
$this->ath();
$s_society_id= (int)$this->Session->read('hm_society_id');
$nnn = 0;

if(isset($this->request->data['sssbbb']))
{
$valll = $this->request->data['arra_typpp'];

$this->loadmodel('society');
$this->society->updateAll(array("area_scale" => $valll),array('society_id'=> $s_society_id));	
}


if(isset($this->request->data['flat_add']))
{
$count = $this->request->data['xyz'];

for($j=1; $j<=$count; $j++)
{
$wing_id = (int)$this->request->data['wing_name'.$j];
$flat_id = (int)$this->request->data['flat_no'.$j];
$flat_type_id = (int)$this->request->data['flat_type'.$j];
$area = (int)$this->request->data['area'.$j];
$noc_type = (int)$this->request->data['noctp'.$j];

$mmm = 5;
$this->loadmodel('flat_type');
$condition=array('society_id'=>$s_society_id,"flat_type_id"=>$flat_type_id);
$cursor = $this->flat_type->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$auto_id = (int)@$collection['flat_type']['auto_id'];
$no_of_flat = (int)@$collection['flat_type']['number_of_flat'];
$mmm = 55;
}
if($mmm == 5)
{
$no_of_flat = 1;
$this->loadmodel('flat_type');
$p=$this->autoincrement('flat_type','auto_id');
$this->flat_type->saveAll(array("auto_id" => $p,"flat_type_id"=> $flat_type_id,"number_of_flat"=>$no_of_flat,"status"=>0,"society_id"=>$s_society_id));


$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$area,"noc_ch_type"=>$noc_type,"flat_type_id"=>$p),array("flat_id"=>$flat_id));



}
else if($mmm == 55)
{
$no_of_flat++;
$this->loadmodel('flat_type');
$this->flat_type->updateAll(array("number_of_flat"=>$no_of_flat),array("auto_id"=>$auto_id));

$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$area,"noc_ch_type"=>$noc_type,"flat_type_id"=>$auto_id),array("flat_id"=>$flat_id));

}



}
?>
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-header">
<center>
<h3 id="myModalLabel3" style="color:#999;"><b>Flat Number</b></h3>
</center>
</div>
<div class="modal-body">
<center>
<h3><b>Record Inserted Successfully</b></h3>
</center>
</div>
<div class="modal-footer">
<a href="master_sm_flat" class="btn blue">OK</a>
</div>
</div>
<?php

}
//$this->loadmodel('flat');
//$i=$this->autoincrement('flat','flat_id');
//$this->flat->saveAll(array("flat_id" => $i,"wing_id"=> $wing_id,"flat_name"=>$flat_name));



$this->loadmodel('wing');
$condition=array('society_id'=>$s_society_id);
$result_wing=$this->wing->find('all',array('conditions'=>$condition)); 
$this->set('user_wing',$result_wing);

$this->loadmodel('flat_type');
$condition=array('society_id'=>$s_society_id);
$result2=$this->flat_type->find('all',array('conditions'=>$condition)); 
$this->set('cursor2',$result2);

$this->loadmodel('flat');
$condition=array('society_id'=>$s_society_id);
$cursor1 = $this->flat->find('all',array('conditions'=>$condition)); 
$this->set('cursor1',$cursor1);

$this->loadmodel('society');
$condition=array('society_id'=>$s_society_id);
$cursor11 = $this->society->find('all',array('conditions'=>$condition)); 
$this->set('cursor11',$cursor11);


$this->loadmodel('flat_type_name');
$cursor4 = $this->flat_type_name->find('all'); 
$this->set("cursor4",$cursor4);

$this->loadmodel('noc_type');
$cursor3 = $this->noc_type->find('all'); 
$this->set('cursor3',$cursor3);

}

/////////////////////////////// End Master Sm Flat////////////////////////////////////////

function master_sm_flat_ajax()
{
$this->layout='blank';
$flat=$this->request->query['con1'];
$res=(int)$this->request->query['con2'];
$this->set('r',$res);
$this->loadmodel('flat');
$conditions=array("flat_name" => $flat,'wing_id'=>$res);
$result3 = $this->flat->find('all',array('conditions'=>$conditions));
$n = sizeof($result3);
$this->set('n3',$n);
}

function society_setting()
{
$this->layout='session';

}

////////////////////////////////////////// End Society Setup //////////////////////

////////////////////////////// Start ledger_sub_account by Flat id ///////////////////////////////////

function ledger_SubAccount_dattta_by_flat_id($flat_id)
{
$s_society_id = $this->Session->read('society_id');

$this->loadmodel('ledger_sub_account');
$conditions=array("flat_id" => $flat_id,"society_id"=>$s_society_id);
return $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
}

////////////////////////////// Start ledger_sub_account by Flat id ///////////////////////////////////

//////////////////////////////// Start Rgular Bill Fetch (Accounts)///////////////////////////////
function new_regular_bill_detail_via_flat_id($flat_id)
{
$this->loadmodel('new_regular_bill');
$conditions=array("flat_id" => $flat_id,"approval_status"=>1);
return $this->new_regular_bill->find('all',array('conditions'=>$conditions));
}
///////////////////// End Rgular Bill Fetch (Accounts)///////////////////////////////////////


///////////////////////////////////////////////////////////Start Function Fetch Amount Income heads(Accounts)///////////////////////////////////////////
function fetch_amount($data_d) 
{
$this->loadmodel('ledger_account');
$conditions=array("auto_id" => $data_d);
return $this->ledger_account->find('all',array('conditions'=>$conditions));
}

//////////////////End Function Fetch Amount Income heads (Accounts)/////////////////////

//////////////////////////////////////////// Start Petty Cash Payment Ajax(amount_cal_p)(Accounts) //////////////////////////////////////////////////////
function amount_cal_p()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->set('s_role_id',$s_role_id);	

$tds = (int)$this->request->query('data');
$amount = $this->request->query('amount');

$this->set('tds',$tds);
$this->set('amount',$amount);



}

//////////////////////////////////////////// End Petty Cash Payment Ajax(amount_cal_p)(Accounts) ////////////////////////////////////////////////////////

///////////////////////////////////////// Start Fetch tds (Accounts) ////////////////////////////////////////////////////////////////////////////////////
function fetch_tds($auto_id)
{
$this->loadmodel('master_tds');
$conditions=array("auto_id" => $auto_id);
return $this->master_tds->find('all',array('conditions'=>$conditions));	

}
///////////////////////////////////////// End Fetch tds (Accounts) ////////////////////////////////////////////////////////////////////////////////////





//////////////////////////////////Start Fix Deposit Add (Accounts) ////////////////////////////////////////////////////
function fix_deposit_add()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->set('s_role_id',$s_role_id);


}

/////////////////////////////////////End Fix Deposit Add (Accounts) //////////////////////////////////////////////////////
















////////////////// Start Expense Tracker View History (Accounts)//////////////////////

function expense_tracker_view_history()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->set('s_role_id',$s_role_id);
$vendor_id = (int)$this->request->query['b'];

$this->set('vendor_id',$vendor_id);


$this->loadmodel('ledger_sub_account');
$conditions=array("auto_id" => $vendor_id);
$cursor1=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
foreach($cursor1 as $collection)
{
$vendor_name = $collection['ledger_sub_account']['name'];
}
$this->set('vendor_name',$vendor_name);


$this->loadmodel('expense_tracker');
$conditions=array("party_head" => $vendor_id);
$cursor2=$this->expense_tracker->find('all',array('conditions'=>$conditions));
$this->set('cursor2',$cursor2);




}

/////////////////////////////////////////////// End Expense Tracker View History (Accounts)//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////Start Expense Tracker View History Approver Fetch (Accounts) ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function approver($user_id)
{
$this->loadmodel('user');
$conditions=array("user_id" => $user_id);
return $this->user->find('all',array('conditions'=>$conditions));
}
/////////////////////////////////////// End Expense Tracker View History Approver Fetch (Accounts)////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////// Start Expense Tracker View History Expense Head (Accounts) /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function fetch_expense_tracker($element_id){
	
$this->loadmodel('expense_tracker');	
$conditions=array('expense_tracker_id'=>$element_id);	
return $this->expense_tracker->find('all',array('conditions'=>$conditions));	
	
}

function fetch_fix_asset_table($id){

$this->loadmodel('fix_asset');	
$conditions=array('fix_asset_id'=>$id);	
return $this->fix_asset->find('all',array('conditions'=>$conditions));	
	
}


function supplimentry_bill_detail_via_supplimentry_bill_id($supplimentry_bill_id){

$this->loadmodel('supplimentry_bill');	
$conditions=array('supplimentry_bill_id'=>$supplimentry_bill_id);	
return $this->supplimentry_bill->find('all',array('conditions'=>$conditions));	
	
}


function fetch_journal_table($element_id){
	
$this->loadmodel('journal');	
$conditions=array('journal_id'=>$element_id);	
return $this->journal->find('all',array('conditions'=>$conditions));	
	
}

function expense_head($expense_head)
{
$this->loadmodel('ledger_account');
$conditions=array("auto_id" => $expense_head);
return $this->ledger_account->find('all',array('conditions'=>$conditions));
}
///////////////////////////////////////// End Expense Tracker View History Expense Head Fetch (Accounts) /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////// Start report_excel_expense_tracker (Accounts)////////////////////////////////////////////////////////////////////
function report_excel_expense_tracker()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->set('s_role_id',$s_role_id);

$vendor_id = (int)$this->request->query['c'];
$this->set('vendor_id',$vendor_id);



$this->loadmodel('ledger_sub_account');
$conditions=array("auto_id" => $vendor_id);
$cursor1=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);



$this->loadmodel('expense_tracker');
$conditions=array("party_head" => $vendor_id);
$cursor2=$this->expense_tracker->find('all',array('conditions'=>$conditions));
$this->set('cursor2',$cursor2);
}
//End report_excel_expense_tracker (Accounts)//
//Start Fix Asset View (Accounts)//
function fix_asset_view(){
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}

$this->ath();
$this->check_user_privilages();	

$s_role_id=$this->Session->read('hm_role_id');
$s_society_id = $this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');

$result_society=$this->society_name($s_society_id);
$society_name = $result_society[0]['society']['society_name'];
$this->set('society_name',$society_name);

$this->loadmodel('fix_asset');
$order=array('fix_asset.purchase_date'=> 'ASC');
$conditions=array("society_id" => $s_society_id);
$result_fix_asset=$this->fix_asset->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set('result_fix_asset',$result_fix_asset);
}
//End Fix Asset View (Accounts)//
//Start Fix Asset Add (Accounts)//
function fix_asset_add()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
$s_role_id=$this->Session->read('hm_role_id');
$s_society_id = $this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');

$this->ath();
$this->check_user_privilages();	
$this->set('s_role_id',$s_role_id);
$this->loadmodel('ledger_account');
$conditions=array("group_id" => 4,'delete_id'=>0);
$result_ledger_account=$this->ledger_account->find('all',array('conditions'=>$conditions));
$this->set('result_ledger_account',$result_ledger_account);


$this->loadmodel('ledger_sub_account');
$conditions=array("ledger_id" => 15,"society_id"=>$s_society_id);
$result_ledger_sub_account=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
$this->set('result_ledger_sub_account',$result_ledger_sub_account);

}

function fix_assets_add_row()
{
$this->layout='blank';
$s_society_id = (int)$this->Session->read('hm_society_id');
$s_user_id = (int)$this->Session->read('user_id');

$this->ath();

$count = (int)$this->request->query('con');
$this->set('count',$count);	
	
$this->loadmodel('ledger_account');
$conditions=array("group_id" => 4,'delete_id'=>0);
$result_ledger_account=$this->ledger_account->find('all',array('conditions'=>$conditions));
$this->set('result_ledger_account',$result_ledger_account);


$this->loadmodel('ledger_sub_account');
$conditions=array("ledger_id" => 15,"society_id"=>$s_society_id);
$result_ledger_sub_account=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
$this->set('result_ledger_sub_account',$result_ledger_sub_account);
	
}


////////////////////////////////////End Fix Asset Add (Accounts)////////////////////////////////////////// ////////////////////////////////////////////

////////////////////////////////////////// Start Fix Asset Show Ajax (Accounts) /////////////////////////////////////////////////////////////////////////

function fix_asset_show_ajax()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->set('s_role_id',$s_role_id);

$from = $this->request->query('date1');
$to = $this->request->query('date2');
$this->set('from',$from);
$this->set('to',$to);


$this->loadmodel('fix_asset');
$conditions=array("society_id" => $s_society_id);
$cursor1=$this->fix_asset->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);


$this->loadmodel('fix_asset');
$conditions=array("society_id" => $s_society_id);
$cursor2=$this->fix_asset->find('all',array('conditions'=>$conditions));
$this->set('cursor2',$cursor2);

}


////////////////////////////////// Start Create Purchase Order//////////////////////////////////////////////////////
function create_purchase_order()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}

$this->ath();
$this->check_user_privilages();	

$s_society_id=$this->Session->read('society_id'); 
$s_role_id=$this->Session->read('role_id');
$s_user_id=$this->Session->read('user_id');


}
////////////////////////////////// End Create Purchase Order//////////////////////////////////////////////////////

/////////////////////////////////// Start Fix asset Json //////////////////////////////////////////////////////
function fix_asset_json(){
$this->layout='blank';
	
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id = (int)$this->Session->read('hm_user_id');
	$post_data=$this->request->data;

     $this->ath();

$q=$post_data['myJsonString'];
$myArray = json_decode($q, true);

$c=0;
foreach($myArray as $child)
{
$c++;


	if(empty($child[0])){
		$output = json_encode(array('type'=>'error', 'text' => 'Asset Category is Required in row '.$c));
		die($output);
		}	
		
		
			if(empty($child[1])){
		$output = json_encode(array('type'=>'error', 'text' => 'Date of Purchase is Required in row '.$c));
		die($output);
		}	
		
		
		$TransactionDate = $child[1];
		$this->loadmodel('financial_year');
		$conditions=array("society_id" => $s_society_id,"status"=>1);
		$cursor = $this->financial_year->find('all',array('conditions'=>$conditions));
		$abc = 555;
		foreach($cursor as $collection){
				$from = $collection['financial_year']['from'];
				$to = $collection['financial_year']['to'];
				$from1 = date('Y-m-d',$from);
				$to1 = date('Y-m-d',$to);
				$from2 = strtotime($from1);
				$to2 = strtotime($to1);
				$transaction1 = date('Y-m-d',strtotime($TransactionDate));
				$transaction2 = strtotime($transaction1);
					if($transaction2 <= $to2 && $transaction2 >= $from2){
					$abc = 5;
					break;
					}	
		}
	if($abc == 555){
		$output=json_encode(array('type'=>'error','text'=>'Date of Purchase Should be in Open Financial Year in row '.$c));
		die($output);
	}
		
		
		
		
		
		
		
		
			if(empty($child[2])){
		$output = json_encode(array('type'=>'error', 'text' => 'Name of Supplier is Required in row '.$c));
		die($output);
		}	
		
		
			if(empty($child[3])){
		$output = json_encode(array('type'=>'error', 'text' => 'Rupees is Required in row '.$c));
		die($output);
		}	
		
		
		if(empty($child[4])){
		$output = json_encode(array('type'=>'error', 'text' => 'Asset Name is Required in row '.$c));
		die($output);
		}	
		
		
		if(!empty($child[5]) && !empty($child[6]))
		{
		$frmm = date('Y-m-d',strtotime($child[5]));
		$tttm = date('Y-m-d',strtotime($child[6]));
		$frmm2 = strtotime($frmm);
		$tttm2 = strtotime($tttm);
		if($tttm2 < $frmm2)
		{
		$output = json_encode(array('type'=>'error', 'text' => 'Warranty Period To can not be Small Than Warranty Period From  in row '.$c));
		die($output);	
			
		}
		}	
		
		
}

$rrrr = array();
$z=0;
foreach($myArray as $child)
{
 $z++;
 $asset_category_id = (int)$child[0];
 $purchase_date = $child[1];
 $assert_supplier_id = (int)$child[2];
 $cost_of_purchase = $child[3];
 $asset_name = htmlspecialchars($child[4]);
 $warranty_from = $child[5];
 $warranty_to = $child[6];
 $description = htmlspecialchars($child[7]);
 $maintanance_schedule = htmlspecialchars($child[8]); 
 $current_date = date('d-m-Y');
 
 $file_name=@$_FILES["file".$z]["name"];
		if(!empty($file_name)){
		$file_name=$_FILES["file".$z]["name"];
		$file_tmp_name =$_FILES['file'.$z]['tmp_name'];
		$target = "fix_assets/";
		$target=@$target.basename($file_name);
		move_uploaded_file($file_tmp_name,@$target);
		}

 
 
 
 
 
 
$purchase_date2 = date('Y-m-d',strtotime($purchase_date));
 
 
	$fix_asset_id=$this->autoincrement('fix_asset','fix_asset_id');
	$fix_receipt_id=$this->autoincrement_with_society_ticket('fix_asset','fix_receipt_id');
	$this->loadmodel('fix_asset');
	$multipleRowData = Array( Array("fix_asset_id" => $fix_asset_id, "fix_receipt_id" => $fix_receipt_id,
	"asset_category_id" => $asset_category_id,"asset_name" => $asset_name, "description" => $description, 
	"purchase_date" => strtotime($purchase_date2), "cost_of_purchase" => $cost_of_purchase, 
	"asset_supplier_id" => $assert_supplier_id,"warranty_period_from" => $warranty_from,
	"warranty_period_to" => $warranty_to, "maintanance_schedule" => $maintanance_schedule, 
	"society_id" => $s_society_id,'user_id'=>$s_user_id,"file_name"=>$file_name,"current_date"=>$current_date));
	$this->fix_asset->saveAll($multipleRowData);   
    $rrrr[] = $fix_receipt_id;


$auto_id=$this->autoincrement('ledger','auto_id');
$this->ledger->saveAll(array("auto_id" => $auto_id,"ledger_account_id" => $asset_category_id,
"ledger_sub_account_id" => null,"debit"=>$cost_of_purchase,"credit"=>null,
"table_name"=>"fix_asset","element_id"=>$fix_asset_id,"society_id"=>$s_society_id,
"transaction_date"=>strtotime($purchase_date2)));

$auto_id=$this->autoincrement('ledger','auto_id');
$this->ledger->saveAll(array("auto_id" => $auto_id,"ledger_account_id" => 15,
"ledger_sub_account_id" => $assert_supplier_id,"debit"=>null,"credit"=>$cost_of_purchase,
"table_name"=>"fix_asset","element_id"=>$fix_asset_id,"society_id"=>$s_society_id,
"transaction_date"=>strtotime($purchase_date2)));

}


		$voc=sizeof($rrrr);
		if($voc>1){
			$first = reset($rrrr);
			$last = end($rrrr);
			$voucher=$first.' to '.$last;
		}else{
			$voucher= $first = reset($rrrr);	
		}
		
		$show_vouc=array(1,$voucher);

$this->Session->write('fix_asst',$show_vouc);
$fix_receipt_id = implode(',',$rrrr);

$output=json_encode(array('type'=>'success','text'=>'Fixed Asset Voucher No. #'.$fix_receipt_id.' is generated successfully'));
die($output);   

}
//End Fix asset Json//
//Start Fix Asset Excel//
function fix_asset_excel()
{
	$this->layout=null;
		$this->ath();
			$s_role_id=$this->Session->read('role_id');
				$s_society_id = $this->Session->read('hm_society_id');
					$s_user_id=$this->Session->read('hm_user_id');
						$result_society=$this->society_name($s_society_id);
							$society_name = $result_society[0]['society']['society_name'];
	$this->set('society_name',$society_name);

$this->loadmodel('fix_asset');
	$order=array('fix_asset.purchase_date'=> 'ASC');
		$conditions=array("society_id" => $s_society_id);
			$result_fix_asset=$this->fix_asset->find('all',array('conditions'=>$conditions,'order'=>$order));
				$this->set('result_fix_asset',$result_fix_asset);
}
//End Fix Asset Excel//
//Start Ledger Sub Account Fetch (Accounts)//
function ledger_sub_account_fetch($value) 
{
$s_society_id = $this->Session->read('hm_society_id');

$this->loadmodel('ledger_sub_account');
$conditions=array("auto_id" => $value,"society_id" => $s_society_id);
return $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
}

/////////////////////////////// End Ledger Sub Account Fetch (Accounts)/////////////////////////////////////////////

//////////////////////////////////////// Start Ledger Sub Account Fetch (Accounts)///////////////////////////////////////////////////////////////////////
function ledger_sub_account_fetch3($flat_id) 
{
$this->loadmodel('ledger_sub_account');
$conditions=array("flat_id" => (int)$flat_id);
return $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
}

//////////////////////////////////////// End Ledger Sub Account Fetch (Accounts)///////////////////////////////////////////////////////////////////////







/////////////////////////////////////////////// Start Module Fetch (Accounts)////////////////////////////////////////////////////////////////////////////
function module_fetch($module_id) 
{

$this->loadmodel('account_category');
$conditions=array("ac_id" => $module_id);
return $this->account_category->find('all',array('conditions'=>$conditions));
}

/////////////////////////////// End Module Fetch (Accounts)//////////////////////////////////////////

////////////////////// Start Module Name Fetch Date (Accounts)////////////////////////////////////
function module_main_fetch($module_name,$receipt_id) 
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel($module_name);
$order = array('$or' => array( array($module_name.'posting_date'=> 'ASC'),array($module_name.'transaction_date'=> 'ASC')));
$conditions=array("receipt_id" => $receipt_id, "society_id" => $s_society_id);
return $this->$module_name->find('all',array('conditions'=>$conditions,'order' =>$order));
}

function module_main_fetch5($module_name,$receipt_id,$module_id)
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel($module_name);
$order=array($module_name.'transaction_date'=> 'ASC');
$conditions=array("receipt_id" => $receipt_id,"society_id" => $s_society_id,"module_id"=>$module_id);
return $this->$module_name->find('all',array('conditions'=>$conditions,'order' =>$order));
}

function module_main_fetch10($module_name,$receipt_id) 
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel($module_name);
$order=array($module_name.'date'=> 'ASC');
$conditions=array("receipt_id" => $receipt_id, "society_id" => $s_society_id, "approve_status" => 2);
return $this->$module_name->find('all',array('conditions'=>$conditions,'order' =>$order));
}

////////////////////// End Module Name Fetch Date (Accounts)///////////////////////////////////////


/////////////////////////////////// Start Module Fetch (Accounts) //////////////////////////////////

function module_main_fetch2($module_name) 
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');


$this->loadmodel($module_name);
$conditions=array("society_id" => $s_society_id);
return $this->$module_name->find('all',array('conditions'=>$conditions));
}

//////////////////////////// End Module Fetch (Accounts) ///////////////////////////////////////////

//////////////////////////////////////////Start Trial Balance Module Fetch(Accounts)///////////////////////////////////////////////////////////////////

function module_main_fetch3($module_name,$receipt_id) 
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');


$this->loadmodel($module_name);
$conditions=array("society_id" => $s_society_id, "receipt_id" => $receipt_id);
return $this->$module_name->find('all',array('conditions'=>$conditions));
}





//////////////////////////////////////////End Trial Balance Module Fetch(Accounts)///////////////////////////////////////////////////////////////////

//////////////////////////////////////////////// Start Amount Category Fetch (Accounts)/////////////////////////////////////////////////////////////////
function amount_category($amount_category_id) 
{
$this->loadmodel('amount_category');
$conditions=array("amount_category_id" => $amount_category_id);
return $this->amount_category->find('all',array('conditions'=>$conditions));
}

//////////////////////////////////////////////// End Amount Category Fetch (Accounts)/////////////////////////////////////////////////////////////////

///////////////////////////////////////////////// Start Accounts Group Fetch (Accounts) ///////////////////////////////////////////////////////////////
function accounts_group($group_id) 
{
$this->loadmodel('accounts_group');
$conditions=array("auto_id" => $group_id);
return $this->accounts_group->find('all',array('conditions'=>$conditions));
}


///////////////////////////////////////////////// End Accounts Group Fetch (Accounts) ///////////////////////////////////////////////////////////////////













/////////////////// Start Income Head Fetch Regular Bill (Accounts)//////////////////
function it_income_head_fetch($user_id,$date1,$date2)
{

$this->loadmodel('regular_bill');
$conditions=array("bill_daterange_from" => array('$gt' => $date1),"bill_daterange_to" => array('$lte' => $date2),"bill_for_user"=>$user_id);
return $this->regular_bill->find('all',array('conditions'=>$conditions));
}
////////////////////// End Income Head Fetch Regular Bill (Accounts)///////////////


////////////////// Start Income Head Amount Fetch (Accounts)/////////////////////////////

function income_head_amount($inhe)
{

$this->loadmodel('ledger_account');
$conditions=array("auto_id" =>$inhe);
return $this->ledger_account->find('all',array('conditions'=>$conditions));


}

/////////////////////// End Income Head Amount Fetch (Accounts)///////////////////////



/////////////////// Start Supplimentry Bill View(Accounts)////////////////////////////
function supplimentry_bill_view()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$auto_id = (int)$this->request->query('bill');


$this->loadmodel('adhoc_bill');
$conditions=array("adhoc_bill_id"=>$auto_id,"society_id" => $s_society_id);
$cursor=$this->adhoc_bill->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$bill_html = $collection['adhoc_bill']['bill_html'];	
}

$this->set('bill_html',$bill_html);

}
///////////////////////////////////////////////////////// End Supplimentry Bill View(Accounts)///////////////////////////////////////////////////////////

//////////////////////////////////////////////////////// Start Regular Bill View (Accounts)//////////////////////////////////////////////////////////////
function regular_bill_view()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$auto_id = (int)$this->request->query('bill');

$this->loadmodel('regular_bill');
$conditions=array("regular_bill_id"=>$auto_id,"society_id" => $s_society_id);
$cursor=$this->regular_bill->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$bill_html = $collection['regular_bill']['bill_html'];	
}

$this->set('bill_html',$bill_html);

}
////////////////////////////////// End Regular Bill View (Accounts)//////////////////////////////////////////


////////////////////////////////////Start It Due date /////////////////////////////////////////////////

function it_due_date()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$this->loadmodel('regular_bill');
$conditions=array("society_id" => $s_society_id);
$order = array('regular_bill.one_time_id'=> 'ASC');
$cursor1=$this->regular_bill->find('all',array('conditions'=>$conditions,'order'=>$order));
$this->set('cursor1',$cursor1);


if(isset($this->request->data['sub']))
{
$day = (int)$this->request->data['due_day'];


$this->loadmodel('regular_bill');
$this->regular_bill->updateAll(array("due_days" => $day),array("update_id" => 5));	
?>

<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Due Days updated successfully
</div> 
<div class="modal-footer">
<a href="it_due_date"   class="btn green">OK</a>
</div>
</div>
<!----alert-------------->

<?php

}
}

/////////////////End It Due date /////////////////////////////////////////////////////////










////////////////////////// Start Master Opening Balance (Accounts)///////////////////
function master_opening_balance()
{
$this->layout = 'session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	


$this->loadmodel('ledger_account');
$cursor1=$this->ledger_account->find('all');
$this->set('cursor1',$cursor1);



if(isset($this->request->data['sub']))
{
$year = $this->request->data['year'];
$la_id = (int)$this->request->data['le_ac'];
$opening_bal = $this->request->data['balance'];

if($la_id == 15 || $la_id == 33 || $la_id == 34 || $la_id == 35)
{
$lsa_id = (int)$this->request->data['su_le_ac'];

$opening_balance_id=$this->autoincrement('opening_balance','opening_balance_id');
$this->loadmodel('opening_balance');
$this->opening_balance->saveAll(array('opening_balance_id' => $opening_balance_id,'year' => $year,'account_type'=> 1, 'account_id' => $lsa_id,'opening_balance_amount' => $opening_bal,
"society_id" => $s_society_id));

}
else
{

$opening_balance_id=$this->autoincrement('opening_balance','opening_balance_id');
$this->loadmodel('opening_balance');
$this->opening_balance->saveAll(array('opening_balance_id' => $opening_balance_id,'year' => $year,'account_type'=> 2, 'account_id' => $la_id,'opening_balance_amount' => $opening_bal,"society_id" => $s_society_id));


}

?>
<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Record Inserted successfully
</div> 
<div class="modal-footer">
<a href="master_opening_balance"   class="btn green">OK</a>
</div>
</div>
<!----alert-------------->
<?php
}


}
////////////////////////// End Master Opening Balance (Accounts)/////////////////////////////



/////////////////////// Start Opening Balance Ajax (Accounts)/////////////////////////////////
function opening_balance_ajax()
{
$this->layout = 'blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$value1 = (int)$this->request->query('value1');
$this->set('value1',$value1);

}


/////////////////////// End Opening Balance Ajax (Accounts)////////////////////////////////////



////////////////////////// Start Opening Balance Report (Account)//////////////////////////////
function opening_balance_report()
{
$this->layout = 'session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('ledger_account');
$cursor1=$this->ledger_account->find('all');
$this->set('cursor1',$cursor1);

}
////////////////////////// Start Opening Balance Report (Account)//////////////////////////////



////////////////////////// Start Opening Balance Report Ajax (Accounts)///////////////////////
function opening_balance_report_ajax()
{
$this->layout = 'blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$value1 = (int)$this->request->query('ff');

$this->loadmodel('ledger_sub_account');
$conditions=array("society_id" => $s_society_id, "ledger_id" => $value1);
$cursor1=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);



}
////////////////////////// End Opening Balance Report Ajax (Accounts)/////////////////////////


//////////////////////////// Start Opening Balance Show Ajax (Accounts)////////////////////////
function opening_balance_show_ajax()
{
$this->layout = 'blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$year = $this->request->query('year');
$le_ac = (int)$this->request->query('le_ac');

$this->set('le_ac',$le_ac);
$this->set('year',$year);

if($le_ac == 15 || $le_ac == 33 || $le_ac == 34 || $le_ac == 35)
{
$ls_ac = (int)$this->request->query('ls_ac');

$this->loadmodel('opening_balance');
$conditions=array("society_id" => $s_society_id, "year" => $year, "account_type" => 1,"account_id" => $ls_ac);
$cursor =$this->opening_balance->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$op_ba = $collection['opening_balance']['opening_balance_amount'];
}

$this->loadmodel('ledger_sub_account');
$conditions=array("auto_id" => $ls_ac, "society_id" => $s_society_id);
$cursor =$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$subl_name = $collection['ledger_sub_account']['name'];
}

$this->set('subl_name',$subl_name);
$this->set('op_ba',$op_ba);
}
else
{
$this->loadmodel('opening_balance');
$conditions=array("society_id" => $s_society_id, "year" => $year, "account_type" => 2,"account_id" => $le_ac);
$cursor =$this->opening_balance->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$op_ba = $collection['opening_balance']['opening_balance_amount'];
}
$this->loadmodel('ledger_account');
$conditions=array("auto_id" => $le_ac);
$cursor =$this->ledger_account->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$ledger_ac_name = $collection['ledger_account']['ledger_name'];
}
$this->set('le_ac_name',$ledger_ac_name);
$this->set('op_ba',$op_ba);

}
}
//////////////////////////// End Opening Balance Show Ajax (Accounts)//////////////










//////////////////////////////////////////////// Start Master Flat Rent (Accounts) //////////////////////////////////////////////////////////////////////
function master_flat_rent()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	



if(isset($this->request->data['sub']))
{
$user_id = (int)$this->request->data['user_id'];
$type = $this->request->data['flat_type'];

if($type == 1)
{
$size = $this->request->data['flat_size_s'];

$this->loadmodel('user');
$this->user->updateAll(array("flat_type" => $type, "flat_size" => $size),array("user_id" => $user_id));	
}

if($type == 2)
{
$size_id = (int)$this->request->data['flat_size'];

$this->loadmodel('user');
$this->user->updateAll(array("flat_type" => $type, "flat_size" => $size_id),array("user_id" => $user_id));	
}
?>

<!----alert-------------->
<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-body" style="font-size:16px;">
Record Updated
</div> 
<div class="modal-footer">
<a href="master_flat_rent"   class="btn green">OK</a>
</div>
</div>
<!----alert-------------->

<?php

}

$this->loadmodel('user');
$conditions=array("society_id"=>$s_society_id);
$cursor1=$this->user->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);	

$this->loadmodel('flat_rent');
$conditions=array("flat_type" => 2);
$cursor2=$this->flat_rent->find('all',array('conditions'=>$conditions));
$this->set('cursor2',$cursor2);	






}

//////////////////////////////////////////////// End Master Flat Rent (Accounts) //////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////// Start Flat Assign Ajax (Accounts) ////////////////////////////////////////////////////////////////////
function flat_assign_ajax()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$user_id = (int)$this->request->query('user_id');
$this->set('user_id',$user_id);











}
////////////////////////////////////////////////// End Flat Assign Ajax (Accounts) ////////////////////////////////////////////////////////////////////






////////////////////////////////////// Start Accounts Group Fetch (Accounts)////////////////////////////////////////////////////////////////////////////
function accounts_group_fetch($auto_id) 
{
$this->loadmodel('accounts_group');
$conditions=array("accounts_id" => $auto_id);
return $this->accounts_group->find('all',array('conditions'=>$conditions));
}

////////////////////////////////////// End Accounts Group Fetch (Accounts)//////////////////////////////////////////////////////////////////////////////
/////////////////// Start accounts_group_fetch2 //////////////////////////////////

function accounts_group_fetch2($auto_id) 
{
$this->loadmodel('accounts_group');
$conditions=array("auto_id" => $auto_id);
return $this->accounts_group->find('all',array('conditions'=>$conditions));
}

/////////////////// End accounts_group_fetch2 //////////////////////////////////



/////////////////////// Start Ledger Account Fetch (Accounts)////////////////////////////////////////////////////////////////////////
function service_provider_detail($auto_id) 
{
$this->loadmodel('service_provider');
$conditions=array("sp_id" => $auto_id);
return $this->service_provider->find('all',array('conditions'=>$conditions));
}

/////////////////////// Start Ledger Account Fetch (Accounts)////////////////////////////////////////////////////////////////////////
function ledger_account_fetch($auto_id) 
{
	$s_society_id = (int)$this->Session->read('hm_society_id');
	
$this->loadmodel('ledger_account');
$conditions =array( '$or' => array( 
	array('group_id' =>$auto_id,'society_id'=>0),
	array('group_id' =>$auto_id,'society_id'=>$s_society_id)
	));
$order=array("ledger_account.ledger_name"=>"ASC");
return $this->ledger_account->find('all',array('conditions'=>$conditions,'order'=>$order));
}





/////////////////// End Ledger Account Fetch (Accounts)///////////////////////////////

function ledger_fetch_new($sub_id)
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');		

$this->loadmodel('ledger');
$conditions=array("society_id" => $s_society_id,"account_id" => $sub_id);
return $this->ledger->find('all',array('conditions'=>$conditions));

}



//////////////////////////////////////////////Start Ledger Fetch1 (Accounts)/ ///////////////////////////////////////////////////////////////////////////
function ledger_fetch1($sub_id)
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');		

$this->loadmodel('ledger');
$conditions=array("society_id" => $s_society_id, "account_type" => 1, "account_id" => $sub_id);
return $this->ledger->find('all',array('conditions'=>$conditions));

}
//////////////////////////////////////////////End Ledger Fetch1 (Accounts)///////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////// Start Ledger Fetch2 (Accounts)//////////////////////////////////////////////////////////////////////////////

function ledger_fetch2($sub_id)
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');		


$this->loadmodel('ledger');
$conditions=array("society_id" => $s_society_id, "account_type" => 2, "account_id" => $sub_id);
return $this->ledger->find('all',array('conditions'=>$conditions));

}


//////////////////////////////////////////// End Ledger Fetch2 (Accounts)//////////////////////////////////////////////////////////////////////////////


/////////////////////////////////// Start Ledger Sub Account Fetch (Accounts)///////////////////////
function ledger_sub_account_fetch2($auto_id) 
{

$this->loadmodel('ledger_sub_account');
$conditions=array("ledger_id" => $auto_id);
return $this->ledger_sub_account->find('all',array('conditions'=>$conditions));

}

//End Ledger Sub Account Fetch (Accounts)//

function subledger_fetch_by_auto_id($auto_id) 
{
$this->loadmodel('ledger_sub_account');
$conditions=array("auto_id" => $auto_id);
return $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
}
//Start Master Ledger Account Hm (Accounts)//
function master_ledger_account_hm()
{
	$this->layout='session';
	$s_role_id=$this->Session->read('hm_role_id');
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id= (int)$this->Session->read('hm_user_id');	
	$this->set('s_user_id',$s_user_id);

	$del_id = (int)$this->request->query('con');
	$this->set('del_id',$del_id);

	
	$this->loadmodel('ledger_account');
	$cursor=$this->ledger_account->find('all');
		foreach ($cursor as $collection) 
		{
		$auto_id = (int)$collection['ledger_account']['auto_id']; 
			if(isset($this->request->data['sub'.$auto_id]))
			{
			
			//$ledger_name = $this->request->data['cat'.$auto_id];
			//$gr_id = (int)$this->request->data['gr_id'.$auto_id];
			$this->loadmodel('ledger_account');
			$this->ledger_account->updateAll(array("society_id"=>0),array("auto_id" => $auto_id));	
			}
	} 

	if(isset($this->request->data['sub']))
	{
		$main_id = (int)$this->request->data['main_id'];
		$name = $this->request->data['cat_name'];

		$this->loadmodel('ledger_account');
		$order=array('ledger_account.auto_id'=> 'ASC');
		$cursor=$this->ledger_account->find('all',array('order' =>$order));
		foreach ($cursor as $collection) 
		{
		$last=$collection['ledger_account']["auto_id"];
		}
		if(empty($last))
		{
		$i=0;
		}	
		else
		{	
		$i=$last;
		}
		$i++;
		$this->loadmodel('ledger_account');
		$multipleRowData = Array( Array("auto_id" => $i, "group_id" => $main_id, "ledger_name" => $name,"delete_id"=>0, "edit_user_id"=>$s_user_id,"society_id"=>0));
		$this->ledger_account->saveAll($multipleRowData);	

	}

	$this->loadmodel('accounts_group');
	$cursor1=$this->accounts_group->find('all');
	$this->set('cursor1',$cursor1);	

	$this->loadmodel('ledger_account');
	$conditions=array("delete_id" => 0);
	$cursor2=$this->ledger_account->find('all',array('conditions'=>$conditions));
	$this->set('cursor2',$cursor2);	


	$this->loadmodel('accounts_group');
	$conditions=array("delete_id" => 0);
	$cursor3=$this->accounts_group->find('all',array('conditions'=>$conditions));
	$this->set('cursor3',$cursor3);

}
//////////////////////// End Master Ledger Account Hm (Accounts)/////////////////////

//////////////////////////// Start Accounts Category Fetch (Accounts) //////////////////////
function accounts_category($accounts_id) 
{
$this->loadmodel('accounts_category');
$conditions=array("auto_id" => $accounts_id);
return $this->accounts_category->find('all',array('conditions'=>$conditions));

}
//////////////////////////End Accounts Category Fetch (Accounts) ////////////////////

//////////////////////////// Start Accounts Category Fetch (Accounts) //////////////////////
function accounts_group_via_accounts_id($accounts_id) 
{
$this->loadmodel('accounts_group');
$order = array('accounts_group.group_name'=>'ASC');
$conditions=array("accounts_id" => $accounts_id,'delete_id'=>0);
return $this->accounts_group->find('all',array('conditions'=>$conditions,'order'=>$order));

}
//////////////////////////End Accounts Category Fetch (Accounts) ////////////////////


//////////////////////////// Start Accounts Category Fetch (Accounts) //////////////////////
function ledger_account_via_group_id($accounts_id) 
{
$s_society_id = (int)$this->Session->read('society_id');
$this->loadmodel('ledger_account');
$order = array('ledger_account.ledger_name'=>'ASC');
$conditions = array('$or' => array(array('society_id' =>$s_society_id),array('society_id' =>0)),'group_id'=>$accounts_id);
return $this->ledger_account->find('all',array('conditions'=>$conditions,'order'=>$order));
}
//////////////////////////End Accounts Category Fetch (Accounts) ////////////////////









//////////////////////Start Master Ledger Sub Account Ajax  (Accounts)/////////////////////
function master_ledger_sub_account_ajax()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$value = (int)$this->request->query('value');
$this->set('value',$value);

}
///////////////////////////////////////End Master Ledger Sub Account Ajax (Accounts)/////////////////////////////////////////////////////////////////////

////////////////////////////////////////// Start Ledger Account Fetch (Accounts)/////////////////////////////////////////////////////////////////////////
function ledger_account($ledger_id) 
{
$this->loadmodel('ledger_account');
$conditions=array("auto_id" => $ledger_id);
return $this->ledger_account->find('all',array('conditions'=>$conditions));

}
////////////////////////////////////////// End Ledger Account Fetch (Accounts)///////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////Start Ledger Account Fetch2 (Accounts)////////////////////////////////////////////////////////////////////////
function ledger_account2($group_id) 
{

$this->loadmodel('ledger_account');
$conditions=array("group_id" => $group_id);
return $this->ledger_account->find('all',array('conditions'=>$conditions));

}

///////////////////////////////////////////End Ledger Account Fetch2 (Accounts)////////////////////////////////////////////////////////////////////////

//////////////////////Start Master Accounts Category Hm (Accounts)///////////////////////
function master_accounts_category_hm()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	
$del_id = (int)$this->request->query('con');
$this->set('del_id',$del_id);

if(isset($this->requet->data['delc']))
{
$del = (int)$this->request->data['del_id'];
$this->loadmodel('accounts_category');
$this->accounts_category->updateAll(array("delete_id" => 1),array("auto_id" => $del));	
?>
<script>
window.location.href="master_accounts_category_hm";
</script>
<?php
}
$this->loadmodel('accounts_category');
$order=array('accounts_category.auto_id'=> 'ASC');
$cursor=$this->accounts_category->find('all',array('order' =>$order));
foreach ($cursor as $collection) 
{
$auto_id = (int)$collection['accounts_category']['auto_id'];
if(isset($this->request->data['sub'.$auto_id]))
{
$cata22 = $this->request->data['cat'.$auto_id];
$this->loadmodel('accounts_category');
$this->accounts_category->updateAll(array("category_name" => $cata22),array("auto_id" => $auto_id));	
}
}
if(isset($this->request->data['sub']))
{
$name = $this->request->data['cat_name'];

$this->loadmodel('accounts_category');
$iii=$this->autoincrement('accounts_category','auto_id');
$this->accounts_category->saveAll(array("auto_id" => $iii, "category_name"=>$name,"delete_id" => 0));
		
}

$this->loadmodel('accounts_category');
$conditions=array("delete_id" => 0);
$cursor1=$this->accounts_category->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);
}

//////////////////// End Master Accounts Category Hm (Accounts)//////////////////////

/////////////// Start Master Accounts Group Hm (Accounts) ////////////////////////////

function master_accounts_group_hm()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$del_id = (int)@$this->request->query['con'];
$this->set('del_id',$del_id);

if(isset($this->request->data['delc']))
{
$del = (int)$this->request->data['del_id'];

$this->loadmodel('accounts_group');
$this->accounts_group->updateAll(array("delete_id" => 1),array("auto_id" => $del));
?>
<script>
window.location.href="master_accounts_group_hm";
</script>
<?php
}
$this->loadmodel('accounts_group');
$order=array('accounts_group.auto_id'=> 'ASC');
$cursor=$this->accounts_group->find('all',array('order' =>$order));
foreach ($cursor as $collection) 
{
$auto_id = (int)$collection['accounts_group']['auto_id'];
if(isset($this->request->data['sub'.$auto_id]))
{
$group_name = $this->request->data['cat'.$auto_id];
$this->loadmodel('accounts_group');
$this->accounts_group->updateAll(array("group_name" => $group_name),array("auto_id" => $auto_id));	
}
}

if(isset($this->request->data['sub']))
{
$main_id = $this->request->data['main_id'];
$name = $this->request->data['cat_name'];

$start_number=$main_id*10;
$this->loadmodel('accounts_group');
$order=array('accounts_group.number'=> 'ASC');
$cursor=$this->accounts_group->find('all',array('order' =>$order));
foreach($cursor as $data10){
	$numbers[]=$data10["accounts_group"]["number"];
}
for($i=$start_number;$i<=($start_number+10);$i++){
	if(!in_array($i,$numbers)){
		$g_number=$i;
		break;
	}
}


$this->loadmodel('accounts_group');
$order=array('accounts_group.auto_id'=> 'ASC');
$cursor=$this->accounts_group->find('all',array('order' =>$order,'limit'=>1));
foreach ($cursor as $collection) 
{
$last=$collection['accounts_group']["auto_id"];
}
if(empty($last))
{
$i=0;
}	
else
{	
$i=$last;
}
$i++;
$this->loadmodel('accounts_group');
$multipleRowData = Array( Array("auto_id" => $i, "accounts_id" => $main_id, "number" => $g_number, "group_name" => $name,"delete_id" => 0));
$this->accounts_group->saveAll($multipleRowData);	
}

$this->loadmodel('accounts_group');
$conditions=array("delete_id" => 0);
$cursor1=$this->accounts_group->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);

$this->loadmodel('accounts_category');
$conditions=array("delete_id" => 0);
$cursor2=$this->accounts_category->find('all',array('conditions'=>$conditions));
$this->set('cursor2',$cursor2);
}

//////////////// End Master Accounts Group Hm (Accounts) //////////////////////////////


/////////////////////////////////////////// Start Master Flat Type (Accounts) ///////////////////////////////////////////////////////////////////////////
function master_flat_type()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	


if(isset($this->request->data['sub']))
{
$flat_type = (int)$this->request->data['flat_type'];

if($flat_type == 1)
{
$square_rs = $this->request->data['rs_feet'];	

$this->loadmodel('flat_rent');
$this->flat_rent->updateAll(array("rs" => $square_rs),array("flat_type" => 1));	
}

if($flat_type == 2)
{
$flat_cat = (int)$this->request->data['flat_cat'];
$rs = $this->request->data['rs'];
if($flat_cat == 1)
{
$name = "1 BHK";	
}
else if($flat_cat == 2)
{
$name ="2 BHK";	
}
else if($flat_cat == 3)
{
$name ="3 BHK";	
}
else if($flat_cat == 4)
{
$name ="4 BHK";	
}
else if($flat_cat == 5)
{
$name ="5 BHK";	
}
else if($flat_cat == 6)
{
$name ="6 BHK";	
}
$this->loadmodel('flat_rent');
$this->flat_rent->updateAll(array("rs" => $rs),array("name" => $name));	

}
}
}
/////////////////////////////////////////// End Master Flat Type (Accounts) ///////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////Start Master Flat Assign ///////////////////////////////////////////////////////////////////////////////////
function master_flat_assign()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

if(isset($this->request->data['sub']))
{
$this->loadmodel('flat');
$cursor=$this->flat->find('all');
foreach($cursor as $collection)
{	
$flat_id = (int)$collection['flat']['flat_id'];	

$type = (int)$this->request->data['flat_type'.$flat_id];

$this->loadmodel('flat');
$this->flat->updateAll(array("flat_type_id" => $type, "sqr_feet" => null),array("flat_id" => $flat_id));

}
}

$this->loadmodel('flat');
$cursor1=$this->flat->find('all');
$this->set('cursor1',$cursor1);	
}
/////////////////////////////////////////////End Master Flat Assign /////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////Start Master Flat Assign Second ///////////////////////////////////////////////////////////////////////////
function master_flat_assign2()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

if(isset($this->request->data['sub']))
{
$type = (int)$this->request->data['type'];
if($type == 1)
{
$this->loadmodel('flat');
$conditions=array("flat_type_id" => 0);
$cursor = $this->flat->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$flat_id = (int)$collection['flat']['flat_id'];	

$sq_feet = (int)$this->request->data['sq_feet'.$flat_id];

$this->loadmodel('flat');
$this->flat->updateAll(array("sqr_feet" => $sq_feet),array("flat_id" => $flat_id));
}
}
if($type == 2)
{
$this->loadmodel('flat');
$conditions=array("flat_type_id" => 2);
$cursor = $this->flat->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$flat_id = (int)$collection['flat']['flat_id']; 

$bhk_id = (int)$this->request->data['bhk'.$flat_id];

$this->loadmodel('flat');
$this->flat->updateAll(array("flat_type_id" => $bhk_id),array("flat_id" => $flat_id));




}
}
}







}
//////////////////////////////////////////////End Master Flat Assign Second /////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////// Start Master Flat Assign2 Ajax /////////////////////////////////////////////////////////////////////////////
function master_flat_assign2_ajax()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$value = (int)$this->request->query('value1');
$this->set('value',$value);

$this->loadmodel('flat');
$conditions=array("flat_type_id" => 0);
$cursor1=$this->flat->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);

$this->loadmodel('flat');
$conditions=array("flat_type_id" => 2);
$cursor2=$this->flat->find('all',array('conditions'=>$conditions));
$this->set('cursor2',$cursor2);


$this->loadmodel('flat_rent');
$cursor3=$this->flat_rent->find('all');
$this->set('cursor3',$cursor3);

}
/////////////////////////////////// End Master Flat Assign2 Ajax /////////////////////////////////////////

////////////////////////////////// Start Expense History Pdf (Accounts)//////////////////////////////////////////
function expense_history_pdf()
{
$this->layout = 'pdf'; //this will use the pdf.ctp layout 
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$auto_id = (int)$this->request->query('a');
$this->set('auto_id',$auto_id);

$this->loadmodel('expense_tracker');
$conditions=array("auto_id" => $auto_id);
$cursor1=$this->expense_tracker->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);

$this->loadmodel('society');
$conditions=array("society_id" => $s_society_id);
$cursor2=$this->society->find('all',array('conditions'=>$conditions));
$this->set('cursor2',$cursor2);



}
/////////////////////////////////// End Expense History Pdf (Accounts)/////////////////////////////////////

///////////////////////////////// Start Regular Bill Pdf(Accounts)///////////////////////////////////////
function regular_bill_pdf()
{
$this->layout = 'pdf'; //this will use the pdf.ctp layout 
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$bill_id = (int)$this->request->query('p');
$this->set('bill_id',$bill_id);

$this->loadmodel('regular_bill');
$conditions=array("regular_bill_id" => $bill_id);
$cursor1=$this->regular_bill->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);

$this->loadmodel('society');
$conditions=array("society_id" => $s_society_id);
$cursor=$this->society->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$society_name=$collection['society']["society_name"];
$so_reg_no = $collection['society']['society_reg_num'];
$so_address = $collection['society']['society_address'];	
}
$this->set("society_name",$society_name);
$this->set("so_reg_no",$so_reg_no);
$this->set("so_address",$so_address);

}
//////////////////////////////////////////// End Regular Bill Pdf(Accounts)/////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////// Start Supplimentry Bill Pdf (Accounts)////////////////////////////////////////////////////////////////////
function supplimentry_bill_pdf()
{
$this->layout = 'pdf'; //this will use the pdf.ctp layout 
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$bill_id = (int)$this->request->query('p');
$this->set('bill_id',$bill_id);

$this->loadmodel('adhoc_bill');
$conditions=array("adhoc_bill_id" => $bill_id);
$cursor1=$this->adhoc_bill->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);



}
//////////////////////////////////////////// End Supplimentry Bill Pdf (Accounts)///////////////////////////////////////////////////////////////////////



/////////////////////////////////////////// Start Function Convert Rupee ///////////////////////////////////////////////////////////////////////////////
function n2www($num){
$numbers10 = array('ten','twenty','thirty','fourty','fifty','sixty','seventy','eighty','ninety');
$numbers01 = array('one','two','three','four','fife','six','seven','eight','nine','ten',
    'eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen');
$string="";

if($num == 0) {
    $string.="zero ";
}

echo $thousands = floor($num/1000);

if($thousands != 0) {
	echo $thousands-1;
    $string.= $numbers01[$thousands-1] . " thousand "; 
    $num -= $thousands*1000;
	echo  $string; exit;
}

$hundreds = floor($num/100);
if($hundreds != 0) {
    $string.= $numbers01[$hundreds-1] . " hundred ";
    $num -= $hundreds*100;
}

if($num < 20) {
    if($num != 0) {
        $string.= $numbers01[$num-1];
    }
} else {
	
    $tens = floor($num/10);
    $string.= $numbers10[$tens-1] . " ";
    $num -= $tens*10;

    if($num != 0) {
		
        $string.= $numbers01[$num-1];
		
    }
	
}
return $string; 
}


function serial_no($number)
{

$str_lenth=strlen($number);
if($str_lenth==1)
{
$number='000'.$number;
}
else if($str_lenth==2)
{
$number='00'.$number;
}

else if($str_lenth==3)
{
$number='0'.$number;
}
$string.= $number;

echo $string;
}







/////////////////////////////////////////// End Function Convert Rupee ///////////////////////////////////////////////////////////////////////////////





/////////////////////// Start Flat Fetch(Accounts)//////////////////////////////////////////

function flat_fetch($flat_id) 
{
$s_society_id = (int)$this->Session->read('hm_society_id');

$this->loadmodel('flat');
$conditions=array("flat_id" => $flat_id,"society_id"=>$s_society_id);
return $this->flat->find('all',array('conditions'=>$conditions));
}

/////////////////////// End Flat Fetch(Accounts)//////////////////////////////////////////////



//////////////////// Start Flat Rent Fetch(Accounts)//////////////////////////////////////////

function flat_rent_fetch($auto_id) 
{
$this->loadmodel('flat_rent');
$conditions=array("auto_id" => $auto_id);
return $this->flat_rent->find('all',array('conditions'=>$conditions));
}

///////////////////////End Flat Rent Fetch (Accounts)//////////////////////////////////////////


/////////////// Start Terms Conditions Fetch (Accounts)///////////////////////////////////////

function terms_fetch($auto_id) 
{
$this->loadmodel('terms_condition');
$conditions=array("terms_conditions_id" => $auto_id);
return $this->terms_condition->find('all',array('conditions'=>$conditions));
}
/////////////// End Terms Conditions Fetch (Accounts)//////////////////////////////////////////

/////////////// Start Bank receipt Fetch (Accounts)///////////////////////////////////////

function bank_receipt_fetch2($receipt_id) 
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
	
$this->loadmodel('cash_bank');
$conditions=array("receipt_id"=>$receipt_id,"society_id"=>$s_society_id,"module_id"=>1);
return $this->cash_bank->find('all',array('conditions'=>$conditions));
}
/////////////// End Terms Conditions Fetch (Accounts)//////////////////////////////////////////



/////////////// Start Bank receipt Fetch (Accounts)///////////////////////////////////////

function bank_receipt_fetch($user_id,$receipt_id) 
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
	
$this->loadmodel('cash_bank');
$conditions=array("bill_reference"=>$receipt_id,"user_id"=>$user_id,"society_id"=>$s_society_id,"module_id"=>1);
return $this->cash_bank->find('all',array('conditions'=>$conditions));
}
/////////////// End Terms Conditions Fetch (Accounts)//////////////////////////////////////////

/////////////// Start Petty Cash receipt Fetch (Accounts)///////////////////////////////////////

function petty_cash_receipt_fetch($user_id,$receipt_id) 
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
	
$this->loadmodel('cash_bank');
$conditions=array("bill_reference"=>$receipt_id,"user_id"=>$user_id,"society_id"=>$s_society_id,"module_id"=>3);
return $this->cash_bank->find('all',array('conditions'=>$conditions));
}
/////////////// End Terms Conditions Fetch (Accounts)//////////////////////////////////////////

////////////////// Start Regular Bill Fetch(Accounts)/////////////////////////////////////////
function regular_bill_fetch7($receipt_id) 
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('regular_bill');
$conditions=array("receipt_id" => $receipt_id,"society_id"=>$s_society_id);
return $this->regular_bill->find('all',array('conditions'=>$conditions));
}

////////////////// End Regular Bill Fetch(Accounts)/////////////////////////////////////////


////////////////// Start Regular Bill Fetch10(Accounts)/////////////////////////////////////////
function regular_bill_fetch10($user_id,$flat_id) 
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('regular_bill');
$conditions=array("bill_for_user" => $user_id, "status" => 0, "society_id"=>$s_society_id,"flat_id"=>$flat_id);
return $this->regular_bill->find('all',array('conditions'=>$conditions));
}

////////////////// End Regular Bill Fetch10(Accounts)/////////////////////////////////////////





////////////////// Start Regular Bill Fetch(Accounts)/////////////////////////////////////////
function regular_bill_fetch($user_id) 
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('regular_bill');
$conditions=array("bill_for_user" => $user_id, "status" => 0, "society_id"=>$s_society_id);
return $this->regular_bill->find('all',array('conditions'=>$conditions));
}

//End Regular Bill Fetch(Accounts)//
//Start Ledger Account Fetch(Accounts)//
function ledger_account_fetch2($auto_id) 
{
$this->loadmodel('ledger_account');
$conditions=array("auto_id"=>$auto_id);
return $this->ledger_account->find('all',array('conditions'=>$conditions));
}
//End Ledger Account Fetch(Accounts)//
//Start Profit And Loss Report//
function profit_loss_report()
{
$this->layout = 'session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');


}
////////////////////////// End Profit And Loss Report//////////////////////////////////////////

//////////////////////////Start Profit Loss Report Show Ajax(Accounts)/////////////////////////
function profit_loss_report_show_ajax()
{
$this->layout = 'blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');


$date1 = $this->request->query('date1');
$date2 = $this->request->query('date2');
$this->set('date1',$date1);
$this->set('date2',$date2);

$this->loadmodel('accounts_category');
$cursor1=$this->accounts_category->find('all');
$this->set('cursor1',$cursor1);


}
//////////////////////////End Profit Loss Report Show Ajax(Accounts)//////////////////////////

/////////////////////// Start ledger  Fetch1 (Accounts)///////////////////////////////////////
function ledger_fetch($auto_id)
{
$this->loadmodel('ledger');
$conditions=array("auto_id" => $auto_id, "account_type" => 1);
return $this->ledger->find('all',array('conditions'=>$conditions));
}

/////////////////////// End ledger  Fetch1 (Accounts)///////////////////////////////////////

/////////////////////// Start ledger  Fetch2 (Accounts)///////////////////////////////////////
function ledger_fetch3($auto_id)
{
$this->loadmodel('ledger');
$conditions=array("auto_id" => $auto_id, "account_type" => 2);
return $this->ledger->find('all',array('conditions'=>$conditions));
}

/////////////////////// End ledger  Fetch2 (Accounts)///////////////////////////////////////

/////////////////////////////// Start My Flat (Accounts)//////////////////////////////////////
function my_flat()
{
$this->layout = 'session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

}
/////////////////////////////// End My Flat (Accounts)//////////////////////////////////////

///////////////////////////// Start My Flat Ajax(Accounts)///////////////////////////

function my_flat_ajax()
{
$this->layout = 'blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');

$this->loadmodel('user');
$conditions=array("society_id" => $s_society_id, "user_id"=>$s_user_id);
$cursor = $this->user->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$flat_id = (int)$collection['user']['flat'];
$wing_id = (int)$collection['user']['wing'];
}

$this->loadmodel('wing');
$conditions=array("society_id" => $s_society_id, "wing_id"=>$wing_id);
$cursor = $this->wing->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$wing_name = $collection['wing']['wing_name'];
}
$this->loadmodel('flat');
$conditions=array("society_id" => $s_society_id, "flat_id"=>$flat_id);
$cursor = $this->flat->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$flat_name = $collection['flat']['flat_name'];
$flat_mas_id = (int)$collection['flat']['flat_master_id'];
$flat_tp_id = (int)$collection['flat']['flat_type_id'];
}

$this->loadmodel('flat_master');
$conditions=array("society_id" => $s_society_id, "auto_id"=>$flat_mas_id);
$cursor = $this->flat_master->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$flat_area = $collection['flat_master']['flat_area'];
}

$this->loadmodel('flat_type');
$conditions=array("society_id" => $s_society_id, "auto_id"=>$flat_tp_id);
$cursor = $this->flat_type->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$flat_type = $collection['flat_type']['flat_name'];
}
$this->set('wing_name',$wing_name);
$this->set('flat_name',$flat_name);
$this->set('flat_area',$flat_area);
$this->set('flat_type',$flat_type);




$this->loadmodel('society');
$conditions=array("society_id" => $s_society_id);
$cursor = $this->society->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$society_name = $collection['society']['society_name'];
}
$this->set('society_name',$society_name);













$this->loadmodel('ledger_sub_account');
$conditions=array("society_id" => $s_society_id, "user_id"=>$s_user_id);
$cursor = $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$account_id = (int)$collection['ledger_sub_account']['auto_id'];
$name = $collection['ledger_sub_account']['name'];
$ledger_id = (int)$collection['ledger_sub_account']['ledger_id'];
}
$this->set('account_id',@$account_id);
$this->set('name',@$name);
$this->set('ledger_id',@$ledger_id);










$date1 = $this->request->query('date1');
$date2 = $this->request->query('date2');

$this->set('from',$date1);
$this->set('to',$date2);


$this->loadmodel('financial_year');
$conditions=array("society_id" => $s_society_id);
$cursor = $this->financial_year->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$from = $collection['financial_year']['from'];
$to = $collection['financial_year']['to'];
}
$cm = date('m');
$fm = date('m',strtotime($to));

if($cm <= $fm)
{
$year = date('Y');
$year = $year-1;
}
else
{
$year = date('Y');
}
$from1 = $from.'-'.$year; 

$year = $year-1;
$from2 = $from.''.$year;


$nv = 1;
$op_deb = 0;
$op_cred = 0;
while($nv < 3)
{
if($nv == 1)
{
$datefrom = date('Y-m-d',strtotime($from1));
$datefrom = new MongoDate(strtotime($datefrom));
}
else
{
$datefrom = date('Y-m-d',strtotime($from2));
$datefrom = new MongoDate(strtotime($datefrom));
}
$this->loadmodel('ledger'); 
$conditions=array("op_date"=>$datefrom,"account_type"=> 1,"account_id"=>
@$account_id,"receipt_id"=>"O_B","society_id"=>$s_society_id);
$cursor=$this->ledger->find('all',array('conditions'=>$conditions));

foreach($cursor as $collection)
{
$amount_type2 = (int)$collection['ledger']['amount_category_id'];
$amount2 = $collection['ledger']['amount'];
}
if(@$amount_type2 == 1)
{
$op_deb = $op_deb + $amount2;
}
else if(@$amount_type2 == 2)
{
$op_cred = $op_cred + $amount2;
}
$nv ++;
}
$this->set('op_deb',$op_deb);
$this->set('op_cred',$op_cred);




$this->loadmodel('ledger');
$conditions=array("society_id" => $s_society_id, "account_id"=>@$account_id,"account_type"=>1);
$cursor1 = $this->ledger->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);

}

///////////////////////////// End My Flat Ajax(Accounts)////////////////////////////





////////////////////////// start master sm flat add row /////////////////////////////////////
function master_sm_flat_add_row()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('user_id');	

$t = $this->request->query('con');
$this->set('t',$t);

$this->loadmodel('wing');
$condition=array('society_id'=>$s_society_id);
$result=$this->wing->find('all',array('conditions'=>$condition)); 
$this->set('user_wing',$result);

$this->loadmodel('flat_type');
$condition=array('society_id'=>$s_society_id);
$result2=$this->flat_type->find('all',array('conditions'=>$condition)); 
$this->set('cursor2',$result2);

$this->loadmodel('flat_type_name');
$result4=$this->flat_type_name->find('all'); 
$this->set('cursor4',$result4);


$this->loadmodel('noc_type');
$cursor3 = $this->noc_type->find('all'); 
$this->set('cursor3',$cursor3);


}
////////////////////////// End master sm flat add row /////////////////////////////////////



////////////////////// Start Flat Fetch (Accounts)///////////////////////////////////
function flat_fetch2($flat,$wing)
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');


$this->loadmodel('flat');
$conditions=array("society_id" => $s_society_id, "flat_id" => $flat, "wing_id" => $wing);
return $this->flat->find('all',array('conditions'=>$conditions));

}
////////////////////// End Flat Fetch (Accounts)///////////////////////////////////////////

//////////////////////// Start Flat Master Fetch(Accounts)//////////////////////////////////
function flat_master_fetch($auto_id)
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('flat_master');
$conditions=array("auto_id" => $auto_id);
return $this->flat_master->find('all',array('conditions'=>$conditions));

}
/////////////////////////// End Flat master fetch (accounts)///////////////////////////////

///////////////////////// Start Flat Type fetch(Accounts)/////////////////////////////////
function flat_type_fetch($auto_id)
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('flat_type');
$conditions=array("society_id" => $s_society_id, "flat_type_id" => $auto_id);
return $this->flat_type->find('all',array('conditions'=>$conditions));
}

/////////////////////////End Flat Type Fetch (Accounts)/////////////////////////////////////

//////////////////// Start regular Bill Fetch(Accounts)/////////////////////////////////////
function regular_bill_fetch3($date1,$date2)
{
$s_role_id = (int)$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');

$this->loadmodel('regular_bill');
$order=array('regular_bill.regular_bill_id'=>'ASC');
$conditions=array("date" => array('$gt' => $date1),"bill_daterange_to" => array('$lte' => $date2),"society_id"=>$s_society_id);
return $this->regular_bill->find('all',array('conditions'=>$conditions,'order'=>$order));
}
//////////////////// End regular Bill Fetch(Accounts)/////////////////////////////

////////////////// Start user Fetch(Accounts)////////////////////////////////////////////
function user_fetch($user_id)
{
$s_role_id = (int)$this->Session->read('hm_role_id');
$s_society_id = (int)$this->Session->read('hm_society_id');
$s_user_id = (int)$this->Session->read('hm_user_id');

$this->loadmodel('user');
$conditions=array("user_id" => $user_id,"society_id"=>$s_society_id);
return $this->user->find('all',array('conditions'=>$conditions));
}
////////////////////////////////////// End user Fetch(Accounts)///////////////////////

////////////////// Start user Fetch(Accounts)////////////////////////////////////////////
function user_fetch5($wing,$flat)
{
$s_role_id = (int)$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');

$this->loadmodel('user');
$conditions=array("wing" => $wing,"flat"=>$flat,"society_id"=>$s_society_id);
return $this->user->find('all',array('conditions'=>$conditions));
}
////////////////////////////////////// End user Fetch(Accounts)///////////////////////












//////////////////////Start User fetch2///////////////////////////////////////////////
function user_fetch4()
{
$s_role_id = (int)$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');

$this->loadmodel('user');
$order=array('user.user_id'=> 'ASC');
$conditions=array("society_id" => $s_society_id, "tenant" => 1,"deactive"=>0);
return $this->user->find('all',array('conditions'=>$conditions));
}
/////////////////////End User fetch2////////////////////////////////////////////////////

///////////////////////// Start User fetch 3/////////////////////////////////////////////
function user_fetch3($wing)
{
$s_role_id = (int)$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');

$this->loadmodel('user');
$order=array('user.user_id'=> 'ASC');
$conditions=array("society_id" => $s_society_id, "tenant" => 1,"deactive"=>0,"wing"=>$wing);
return $this->user->find('all',array('conditions'=>$conditions));
}
///////////////////////// End User fetch 3/////////////////////////////////////////////



//////////////////////// Start terms Condition fetch(Accounts)//////////////////////
function terms_condition_fetch($auto_id) 
{

$this->loadmodel('terms_condition');
$conditions=array("terms_conditions_id" => $auto_id);
return $this->terms_condition->find('all',array('conditions'=>$conditions));

}

//End terms Condition fetch(Accounts) (Accounts)//
//Start Flat Type//
function flat_type()
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$this->ath();
	$this->check_user_privilages();

$s_society_id = (int)$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');	


$this->loadmodel('wing');
$condition=array('society_id'=>$s_society_id);
$order=array('wing.wing_name'=>'ASC');
$wings=$this->wing->find('all',array('conditions'=>$condition,'order'=>$order));
$this->set('wings',$wings);
$units=array();
foreach($wings as $data){
	$wing_id=$data["wing"]["wing_id"];
	$wing_name=$data["wing"]["wing_name"];
		$this->loadmodel('flat');
		$condition=array('society_id'=>$s_society_id,'wing_id'=>$wing_id);
		$order=array('flat.flat_name'=>'ASC');
		$flats=$this->flat->find('all',array('conditions'=>$condition,'order'=>$order));
		
		
		foreach($flats as $data2){
			$flat_id=$data2["flat"]["flat_id"];
			$flat_name=$data2["flat"]["flat_name"];
				
			$units[]=array("wing_id"=>$wing_id,"wing_name"=>$wing_name,"flat_id"=>$flat_id,"flat_name"=>$flat_name);	
		}
}

$this->set('units',$units);		
		
}
//End Flat Type//
//Start Flat Import//
function save_import_flat(){
	$this->layout=null ;
	$s_society_id = (int)$this->Session->read('hm_society_id');
	
	$q=$this->request->query('q'); 
	$myArray = json_decode($q, true);
	
	$c=0;
	$report=array();
	$array1 = array();
	foreach($myArray as $child){
		$c++;
		if(empty($child[0])){
			$report[]=array('tr'=>$c,'td'=>1, 'text' => 'Required');
		}
		if(empty($child[1])){
		$report[]=array('tr'=>$c,'td'=>2, 'text' => 'Required');
		}
		
if(sizeof($report) == 0)
{		
$wing = (int)$child[0];
$flat_name = $child[1];	
$flat_name = str_pad($flat_name,10,"0",STR_PAD_LEFT);   
$nnn = 555;
$this->loadmodel('flat');
$conditions=array("society_id"=>$s_society_id);
$cursor3 = $this->flat->find('all',array('conditions'=>$conditions));
foreach($cursor3 as $collection)
{	
$wing_id2 = (int)$collection['flat']['wing_id'];
$flat_nu2 = $collection['flat']['flat_name'];	
if($wing_id2 == $wing && $flat_nu2 == $flat_name)
{
$nnn = 55;	
}	
}	
if($nnn == 55)
{	
$output=json_encode(array('report_type'=>'already','text'=>'Same Wing and Flat Already Exist in row '.$c));
die($output);
}	

foreach($array1 as $cmp)
{
$w = (int)$cmp[0];
$f = $cmp[1];
if($w == $wing && $f == $flat_name)
{
$output = json_encode(array('report_type'=>'repeat', 'text' => 'Repeatation of Flat Number in row '.$c.''));
die($output);
}
}
$array1[] = array($wing,$flat_name);

}
}
if(sizeof($report)>0){
$output=json_encode(array('report_type'=>'error','report'=>$report));
die($output);
}
	
if($child[2]=="yes")
{
foreach($myArray as $child)
{

$wing = (int)$child[0];
$flat_name = $child[1];	
$this->loadmodel('flat');
$order=array('flat.flat_id'=> 'DESC');
$cursor=$this->flat->find('all',array('order' =>$order,'limit'=>1));
foreach ($cursor as $collection) 
{
$last=$collection['flat']["flat_id"];
}
if(empty($last))
{
$k=0;
}	
else
{	
$k=$last;
}
$k++;
$flat_name = str_pad($flat_name,10,"0",STR_PAD_LEFT);	
$this->loadmodel('flat');
$multipleRowData = Array( Array("flat_id"=>$k, "wing_id"=>$wing, "flat_name"=>$flat_name, "society_id"=>$s_society_id,'noc_ch_tp'=>1));
$this->flat->saveAll($multipleRowData);	

}

$output=json_encode(array('report_type'=>'done','text'=>'Record Inserted Successfully'));
die($output);

}

	
}
/////////////////////////// End Flat Import ////////////////////////////////////////////// 
function import_flat_ajax(){
	
	$this->layout=null ;
	$this->ath();
	 
	$s_society_id=$this->Session->read('hm_society_id');
	$this->loadmodel('wing');
	$conditions=array("society_id" => $s_society_id);
	$result_wing = $this->wing->find('all',array('conditions'=>$conditions));
	$this->set('result_wing',$result_wing);

	if(isset($_FILES['file'])){
		$file_name=$_FILES['file']['name'];
		$file_tmp_name =$_FILES['file']['tmp_name'];
		$target = "csv_file/unit/";
		$target=@$target.basename($file_name);
		move_uploaded_file($file_tmp_name,@$target);
		
		$f = fopen('csv_file/unit/'.$file_name, 'r') or die("ERROR OPENING DATA");
		$batchcount=0;
		$records=0;
		while (($line = fgetcsv($f, 4096, ';')) !== false) {
		// skip first record and empty ones
		$numcols = count($line);
		$test[]=$line;
		++$records;
		}

		fclose($f);
		$records;
	}
	
	$i=0;
	foreach($test as $child){
		if($i>0){
			$child_ex=explode(',',$child[0]);
			$wing_name=$child_ex[0];
			$flat_name=$child_ex[1];
			
			
			$this->loadmodel('wing'); 
			$conditions=array("society_id"=>$s_society_id,"wing_name"=> new MongoRegex('/^' .  $wing_name . '$/i'));
			$result_wing=$this->wing->find('all',array('conditions'=>$conditions));
			$result_wing_count=sizeof($result_wing);
			
			$wing_id=0;
			if($result_wing_count>0){
				$wing_id=$result_wing[0]['wing']['wing_id'];
			}
			
			$table[]=array($wing_id,$flat_name);
		}
		
		$i++;
	}
	$this->set('table',$table);
}



////////// End Flat Import/////////////

///////////////////// End Flat Type ////////////////////////////////////////////////

///////////////////////// Start Flat No. Ajax (Accounts)////////////////////////////
function flat_no_ajax()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$flat_type_id = (int)$this->request->query('con');
$t = (int)$this->request->query('t2');
$this->set('t',$t);



$this->loadmodel('flat_type');
$conditions=array("society_id" => $s_society_id, "auto_id"=>$flat_type_id);
$cursor1 = $this->flat_type->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);

}
///////////////////////// End Flat No. Ajax (Accounts)/////////////////////////////////////

/////////////// Start Flat Show Ajax ///////////////////////////////////////////////////////////
function flat_show_ajax()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$wing_id = (int)$this->request->query('con');
$t = (int)$this->request->query('t2');
$this->set('t',$t);
$this->set("wing_id",$wing_id);
$this->loadmodel('flat');
$conditions=array("society_id" => $s_society_id, "wing_id"=>$wing_id);
$cursor1 = $this->flat->find('all',array('conditions'=>$conditions));

$this->set('cursor1',$cursor1);

}
/////////////// End Flat Show Ajax ///////////////////////////////////////////////////////////

////////////////// Start Regular Bill Fetch2(Accounts)///////////////////////////
function regular_bill_fetch33($user_id) 
{
$s_society_id = (int)$this->Session->read('society_id');
$flat_id = (int)$user_id;
$this->loadmodel('new_regular_bill');
$order=array('new_regular_bill.bill_start_date'=> 'ASC');
$conditions=array("flat_id" => $user_id,"approval_status"=>1,"society_id"=>$s_society_id);
return $this->new_regular_bill->find('all',array('conditions'=>$conditions,'order'=>$order));
}
////////////////// End Regular Bill Fetch2(Accounts)//////////////////////////////



////////////////// Start Regular Bill Fetch2(Accounts)///////////////////////////
function regular_bill_fetch2($user_id) 
{
$this->loadmodel('regular_bill');
$conditions=array("bill_for_user" => $user_id);
return $this->regular_bill->find('all',array('conditions'=>$conditions));
}
////////////////// End Regular Bill Fetch2(Accounts)//////////////////////////////

////////////////// Start Flat type name fetch(Accounts)///////////////////////////
function flat_type_name_fetch($auto_id) 
{
$this->loadmodel('flat_type_name');
$conditions=array("auto_id" => $auto_id);
return $this->flat_type_name->find('all',array('conditions'=>$conditions));
}
////////////////// End Flat type name fetch(Accounts)//////////////////////////////

///////////////////////// Start user fetch2(Accounts)/////////////////////////////
function user_fetch2($flat_id) 
{
$s_society_id=(int)$this->Session->read('society_id');


$this->loadmodel('user');
$conditions=array("flat" => $flat_id,"society_id" => $s_society_id);
return $this->user->find('all',array('conditions'=>$conditions));
}
///////////////////////// End user fetch2(Accounts)/////////////////////////////////////

/////////////////////Start Financial Vali Ajax(Accounts)//////////////////////////////
function regular_vali()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$cc = (int)$this->request->query('ss');
$this->set('cc',$cc);

}
/////////////////////End Financial Vali Ajax(Accounts)//////////////////////////////

////////////////////// Start Supplimentry Vali (Accounts)////////////////////////////////
function supplimentry_vali()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$cc = (int)$this->request->query('ss');
$this->set('cc',$cc);
}
////////////////////// End Supplimentry Vali (Accounts)////////////////////////////////

/////////////////// Start Cash Bank Vali (Accounts) ////////////////////////////////////
function cash_bank_vali()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$cc = (int)$this->request->query('ss');
$this->set('cc',$cc);
}
/////////////////// End Cash Bank Vali (Accounts) ////////////////////////////////////////

////////////////////// Start it due tax (Accounts) //////////////////////////////////////

function it_due_tax()
{
$this->layout='session';
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');	

$this->loadmodel('bill_period');
$conditions=array("society_id" => $s_society_id,"status"=>1);
$cursor1 = $this->bill_period->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);


if(isset($this->request->data['taxp']))
{
$type = (int)$this->request->data['type'];
$per = (int)$this->request->data['tax_p'];

$cur_date = date('Y-m-d');
$cur_date = new MongoDate(strtotime($cur_date));

$this->loadmodel('bill_period');
$this->bill_period->updateAll(array('tax' => $per),array('auto_id' => $type,"society_id" => $s_society_id,"status"=>1));

}
}


////////////////////// End it due tax (Accounts) //////////////////////////////////////

////////////////// Start Due Tax (Accounts)///////////////////////////////////////////////
function due_tax_fetch() 
{
$s_society_id=(int)$this->Session->read('society_id');

$this->loadmodel('due_tax');
$conditions=array("society_id" => $s_society_id, "status" => 1);
return $this->due_tax->find('all',array('conditions'=>$conditions));
}
////////////////// End Due Tax Fetch2(Accounts)///////////////////////////////////////////

/////////////////////// Start Wing Fetch(Accounts) //////////////////////////////////
function wing_fetch($wing) 
{
$s_society_id = $this->Session->read('hm_society_id');

$this->loadmodel('wing');
$conditions=array("wing_id" => $wing,"society_id"=>$s_society_id);
return $this->wing->find('all',array('conditions'=>$conditions));
}
/////////////////////// End Wing Fetch(Accounts)/////////////////////////////////////

/////////////////////// Start Flat Type Fetch(Accounts) ////////////////////////////
function flat_type_fetch2($tp) 
{
$s_society_id = $this->Session->read('society_id');

$this->loadmodel('flat_type');
$conditions=array("auto_id" => $tp,"society_id"=>$s_society_id);
return $this->flat_type->find('all',array('conditions'=>$conditions));
}
/////////////////////// End  Flat Type Fetch(Accounts)//////////////////////////////

/////////////////////// Start Flat Master Fetch (Accounts) ////////////////////////////
function flat_master_fetch2($flm) 
{
$s_society_id = $this->Session->read('society_id');

$this->loadmodel('flat_master');
$conditions=array("auto_id" => $flm,"society_id"=>$s_society_id);
return $this->flat_master->find('all',array('conditions'=>$conditions));
}
/////////////////////// End Flat Master Fetch (Accounts)//////////////////////////////

/////////////////////// Start bill Period Fetch Fetch (Accounts)/////////////////
function bill_period_fetch($auto_id) 
{
$s_society_id = $this->Session->read('society_id');

$this->loadmodel('bill_period');
$conditions=array("auto_id" => $auto_id,"society_id" => $s_society_id,"status"=>1);
return $this->bill_period->find('all',array('conditions'=>$conditions));
}
/////////////////////// End bill Period Fetch Fetch (Accounts)//////////////////////



//////////////// Start Income Head Fetch2(Accounts)/////////////////////////
function income_heads_fetch2() 
{
$s_society_id = $this->Session->read('society_id');

$this->loadmodel('income_head');
$conditions=array("society_id" => $s_society_id);
$order=array('income_head.auto_id'=> 'ASC');
return $this->income_head->find('all',array('conditions'=>$conditions,'order' =>$order));
}
/////////////////// End Income Head Fetch2(Accounts)////////////////////

///////////////////// Start Income Heads Fetch(Accounts)/////////////////////////
function income_head_fetch($auto_id) 
{
$this->loadmodel('income_head');
$conditions=array("auto_id" => $auto_id);
return $this->income_head->find('all',array('conditions'=>$conditions));
}

/////////////////////End Income Heads Fetch(Accounts)//////////////////////////

////////////////////// Start Flat master Fetch2 (Accounts)/////////////////////////
function flat_master_fetch3($flat_type_id)
{
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$this->loadmodel('flat_master');
$conditions=array("society_id" => $s_society_id, "flat_type_id" => $flat_type_id);
return $this->flat_master->find('all',array('conditions'=>$conditions));
}
////////////////////// End Flat Master Fetch2 (Accounts)///////////////////////////





///////////////////////////// Start add_ac_field //////////////////////////////////

function add_ac_field()
{
 $this->ath();
 $this->layout=null;
  $s_society_id = $this->Session->read('hm_society_id'); 
 // ledger posting check code//
	
		$this->loadmodel('regular_bill');
		$conditions=array('edited'=>'no','society_id'=>$s_society_id);
		$result_regular_bill=$this->regular_bill->find('all',array('conditions'=>$conditions,'order'=>array('auto_id'=>'ASC')));	
//pr($result_regular_bill); 
		foreach($result_regular_bill as $data){
			$element_id=$data['regular_bill']['auto_id'];
			$bill_number=$data['regular_bill']['bill_number'];
			$society_id=$data['regular_bill']['society_id'];
			$start_date=$data['regular_bill']['start_date'];
			$quarter_bill= date("d-m-Y",$start_date); 
			
			$this->loadmodel('society');
			$result_society=$this->society->find('all',array('conditions'=>array('society_id'=>$society_id)));
			$society_name=$result_society[0]['society']['society_name'];
			
			$this->loadmodel('ledger');
			$conditions=array('element_id'=>$element_id,'table_name'=>'regular_bill','society_id'=>$society_id);
			$ledger_posting=$this->ledger->find('count',array('conditions'=>$conditions));

			if($ledger_posting==0){
				
					$this->loadmodel('regular_ledger_posting');
					$conditions=array('element_id'=>$element_id,'table_name'=>'regular_bill','society_id'=>$society_id);
					$regular_ledger_posting=$this->regular_ledger_posting->find('count',array('conditions'=>$conditions));
						if($regular_ledger_posting==0){	
							$this->loadmodel('regular_ledger_posting');
							$auto_id=$this->autoincrement('regular_ledger_posting','auto_id');
							$this->regular_ledger_posting->saveAll(Array( Array("auto_id" => $auto_id, "table_name" => "regular_bill","society_id" => $society_id,"bill_number" => $bill_number, "quarter_bill"=>$quarter_bill,"element_id" =>$element_id,"status"=>"NO",'society_name'=>$society_name))); 
						}
			}
				
			
		}
		
 echo"done";
}

////////////////////////////// End add_ac_field //////////////////////////////////





























//////////////////////////// Start Flat type edit ///////////////////////////////////////////////
function flat_type_edit()
{
$this->layout="session";
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');	

if(isset($this->request->data['update']))
{
$tp_id2 = (int)$this->request->data['tp'];

$area = array();
$this->loadmodel('flat');
$condition=array('society_id'=>$s_society_id,"status"=>0,"flat_type_id"=>$tp_id2);
$cursor = $this->flat->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$flat_id = (int)$collection['flat']['flat_id'];
$area2 = (int)$this->request->data['area'.$flat_id];
//if(in_array($area2, $area))
//{
//$vali = "Flat Area Should not be Same";
//$nnn = 55;
//break;
//}
//else
//{
//$vali = "";
$nnn = 5;
$area[] = $area2;

}
if($nnn == 55)
{
$this->set('vali',$vali);
}
else
{
$x=0;
$this->loadmodel('flat');
$condition=array('society_id'=>$s_society_id,"status"=>0,"flat_type_id"=>$tp_id2);
$cursor = $this->flat->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$auto_id2 = (int)$collection['flat']['flat_id'];
$area3 = $area[$x];
$this->loadmodel('flat');
$this->flat->updateAll(array('flat_area'=>$area3),array('flat_id'=>$auto_id2,"society_id"=>$s_society_id));
$x++;
}
?>


<div class="modal-backdrop fade in"></div>
<div   class="modal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
<div class="modal-header">
<center>
<h3 id="myModalLabel3" style="color:#999;"><b>Flat Type Update</b></h3>
</center>
</div>
<div class="modal-body">
<center>
<h3><b>Record Updated Successfully</b></h3>
</center>
</div>
<div class="modal-footer">
<a href="flat_type"   class="btn blue">OK</a>
</div>
</div>

<?php
}
}


$fl_tp_id = (int)$this->request->query('e');
$this->set('fl_tp_id',$fl_tp_id);

$this->loadmodel('flat_type_name');
$cursor1 = $this->flat_type_name->find('all'); 
$this->set('cursor1',$cursor1);

$this->loadmodel('flat');
$condition=array('society_id'=>$s_society_id,"status"=>0,"flat_type_id"=>$fl_tp_id);
$cursor2 = $this->flat->find('all',array('conditions'=>$condition)); 
$this->set('cursor2',$cursor2);

}
//////////////////////////// End Flat type edit ///////////////////////////////////////////////

////////////////////////////// Start Flat Excel ///////////////////////////////////////////////
function flat_excel()
{
$this->layout="";
$filename="Flat";
header ("Expires: 0");
header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
header ("Cache-Control: no-cache, must-revalidate");
header ("Pragma: no-cache");
header ("Content-type: application/vnd.ms-excel");
header ("Content-Disposition: attachment; filename=".$filename.".xls");
header ("Content-Description: Generated Report" );

$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');	

$this->loadmodel('society');
$condition=array('society_id'=>$s_society_id);
$cursor = $this->society->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$society_name = $collection['society']['society_name'];
$valllll = (int)@$collection['society']['area_scale'];
}

$excel="<table border='1'>
<tr>
<th colspan='6' style='text-align:center;'>$society_name</th></tr>
<tr>
<th>Sr No.</th>
<th>Wing</th>
<th>Unit Number</th>
<th>Unit Type</th>
<th>Unit Area"; if(@$vallll == 0) { $excel.="(Sq. Ft.)"; } else {  $excel.="(Sq. Mtr.)";  } $excel.="</th>
<th>Status</th>
</tr>";

$q = 0;
$this->loadmodel('flat');
$condition=array('society_id'=>$s_society_id);
$cursor = $this->flat->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$q++;						
$wing_id = (int)$collection['flat']['wing_id'];
$flat_name = $collection['flat']['flat_name'];
$flat_type_id = (int)@$collection['flat']['flat_type_id'];
$sqfeet = (int)@$collection['flat']['flat_area'];
$noc_type = (int)@$collection['flat']['noc_ch_tp'];


$wing_fetch = $this->requestAction(array('controller' => 'hms', 'action' => 'wing_fetch'),array('pass'=>array($wing_id)));	
foreach($wing_fetch as $collection)
{							
$wing_name = $collection['wing']['wing_name'];							
}

$fl_tp = $this->requestAction(array('controller' => 'hms', 'action' => 'flat_type_name_fetch'),array('pass'=>array($flat_type_id)));		
foreach($fl_tp as $collection)
{
$flat_type = @$collection['flat_type_name']['flat_name'];
}

if($noc_type == 1)
{
$noc_type_name="Self Occupied";
}
else if($noc_type == 2)
{
$noc_type_name="Leased";
}

$excel.="<tr>
<td>$q</td>
<td>$wing_name</td>
<td>$flat_name</td>
<td>";
if($sqfeet == 0) { $excel.="null"; } else { $excel.="$flat_type"; } $excel.="</td>
<td>";
if($sqfeet == 0) { $excel.="null"; } else { $excel.="$sqfeet"; } $excel.="</td><td>";
if($noc_type == 0) { $excel.="not defined"; } else { $excel.="$noc_type_name"; } $excel.="</td>";
$excel.="</tr>";
}
$excel.="</table>";


echo $excel;
}
/////////////////////////// End Flat Excel/////////////////////////////////////////////////////////

//////////////////////// Start Flat Nu Import ///////////////////////////////////////////////////////
function flat_nu_import()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
$this->ath();
$s_society_id=(int)$this->Session->read('society_id');


if($this->request->is('post')) 
{
$array1 = array();
$array2 = array();

$file=$this->request->form['file']['name'];
$dir='C:\xampp\htdocs\cakephp\app\webroot\csv_file';
$target = "csv_file/";
$target=@$target.basename( @$this->request->form['file']['name']);
$ok=1;
move_uploaded_file(@$this->request->form['file']['tmp_name'],@$target);

$f = fopen('csv_file/'.$file, 'r') or die("ERROR OPENING DATA");
$batchcount=0;
$records=0;
while (($line = fgetcsv($f, 4096, ';')) !== false) {
$numcols = count($line);
$test[]=$line;
++$records;
}

fclose($f);
$records;
$total_debit = 0;
$total_credit = 0;
$arr[] = array('0','0');
for($i=1;$i<sizeof($test);$i++)
{
$row_no=$i+1;
$r=explode(',',$test[$i][0]);
$wing_name = trim($r[0]);
$flat_number = trim($r[1]);
$flat_type = trim($r[2]);
$flat_area = trim($r[3]);

$count2 = 0;
$count1 = 0;

if(!empty($wing_name)) 
{	
$ok=2; 
}
else 
{ 
$ok=1; $error_msg[]="Wing should not be empty in row ".$row_no.".";	break;
}
if(!empty($flat_number))
{
$ok=2; 
if(is_numeric($flat_number))
{

}
else
{
$ok = 1;
$error_msg[]="flat number should be numeric in row".$row_no.".";	break;
}
}
else 
{ 
$ok=1; $error_msg[]="Flat Number should not be empty in row ".$row_no.".";	
break;
}

if(!empty($flat_type))
{
$ok=2; 
}
else{ $ok=1; $error_msg[]="Flat Type should not be empty in row ".$row_no.".";	break;}
if(!empty($flat_area))
{
$ok=2; 
if(is_numeric($flat_area))
{

}
else
{
$ok = 1;
$error_msg[]="flat area should be numeric".$row_no.".";	break;
}
}
else 
{ 
$ok=1; $error_msg[]="Flat Area should not be empty in row ".$row_no.".";	break;
}

$this->loadmodel('wing');
$condition=array('society_id'=>$s_society_id);
$cursor = $this->wing->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$wing_name_flat = $collection['wing']['wing_name'];
if(strcasecmp($wing_name_flat,$wing_name) == 0);
{
$count1=5;
break;
}
}
$this->loadmodel('flat');
$condition=array('society_id'=>$s_society_id,"flat_name"=>$flat_number);
$cursor = $this->flat->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$count2 = 5;
}
if($count2 == 5 and $count1 == 5)
{
$ok=1; $error_msg[]="same wing and flat exist please select another wing or flat".$row_no.".";	break;
}

for($s=0; $s<sizeof(@$array2); $s++)
{
$arr_wing = $array2[$s];
$arr_flat_num = $array1[$s];
if($arr_wing == $wing_name and $flat_number == $arr_flat_num)
{
$ok=1; $error_msg[]="repeatation of same wing and flat".$row_no.".";	break;
}
}
$array2[]= $wing_name;
$array1[]= $flat_number;
}


$this->set('error_msg',@$error_msg);
$this->set('ok',$ok);

if($ok == 2)
{
for($i=1;$i<sizeof($test);$i++)
{
$nnn = 5;
$row_no=$i+1;
$r=explode(',',$test[$i][0]);
$wing_name = trim($r[0]);
$flat_number = trim($r[1]);
$flat_type = trim($r[2]);
$flat_area = trim($r[3]);

$this->loadmodel('wing');
$condition=array('society_id'=>$s_society_id);
$cursor = $this->wing->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$wing_id = (int)$collection['wing']['wing_id'];
$str1 = $collection['wing']['wing_name'];
if (strcasecmp($str1, $wing_name) == 0) 
{
$wing = (int)$wing_id;
}
}

$this->loadmodel('flat_type_name');
$cursor = $this->flat_type_name->find('all'); 
foreach($cursor as $collection)
{
$fl_tp_id = (int)$collection['flat_type_name']['auto_id'];
$fl_name = $collection['flat_type_name']['flat_name'];
if (strcasecmp($fl_name, $flat_type) == 0) 
{
$flat_type_id = (int)$fl_tp_id;
}
}

$this->loadmodel('flat_type');
$condition=array('society_id'=>$s_society_id);
$cursor = $this->flat_type->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$flat_type_id2 = (int)$collection['flat_type']['flat_type_id'];
$no_of_flat = $collection['flat_type']['number_of_flat'];
if($flat_type_id2 == $flat_type_id)
{
$nnn = 55;
$no_of_flat++;
$this->loadmodel('flat_type');
$this->flat_type->updateAll(array('number_of_flat' => $no_of_flat),array('flat_type_id' => $flat_type_id2,"society_id"=>$s_society_id));
}
}
if($nnn == 5)
{
$x=$this->autoincrement('flat_type','auto_id');
$this->loadmodel('flat_type');
$this->flat_type->saveAll(array("auto_id" => $x,"flat_type_id"=>$flat_type_id,"society_id"=>$s_society_id,"number_of_flat"=>1,"status"=>1));
}

$z = $this->autoincrement('flat','flat_id');
$this->loadmodel('flat');
$this->flat->saveAll(array("flat_id" => $z,"wing_id"=>$wing,"flat_name"=>$flat_number,"society_id"=>$s_society_id,"flat_type_id"=>$flat_type_id,"flat_area"=>$flat_area));
$this->set('sucess','Csv Imported successfully.'); 
}
}
}
}
//////////////////////// End Flat Nu Import ///////////////////////////////////////////////////////

////////////////////// Start Accounts Category Excel HM/////////////////////////////////////////////////
function accounts_category_excel_hm()
{
$this->layout="";
$filename="Accounts Category";
header ("Expires: 0");
header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
header ("Cache-Control: no-cache, must-revalidate");
header ("Pragma: no-cache");
header ("Content-type: application/vnd.ms-excel");
header ("Content-Disposition: attachment; filename=".$filename.".xls");
header ("Content-Description: Generated Report" );

$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');	


$excel="<table border='1'>
<tr>
<th style='text-align:center;' colspan='2'>Accounts Category</th>
</tr>
<tr>
<th style='text-align:left;'>Sr. No.</th>
<th style='text-align:left;'>Accounts Category</th>
</tr>";
$n = 1;
$this->loadmodel('accounts_category');
$conditions=array("delete_id" => 0);
$cursor = $this->accounts_category->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$name = $collection['accounts_category']['category_name'];
$auto_id = (int)$collection['accounts_category']['auto_id'];
$excel.="<tr>
<td style='text-align:left;'>$n</td>
<td style='text-align:left;'>$name</td>";
$n++;
}
$excel.="</table>";


echo $excel;
}
////////////////////// End Accounts Category Excel HM/////////////////////////////////////////////////

///////////////////////// Start accounts gruo excel hm ////////////////////////////////////////////////
function accounts_group_excel_hm()
{
$this->layout="";
$filename="Accounts Group";
header ("Expires: 0");
header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
header ("Cache-Control: no-cache, must-revalidate");
header ("Pragma: no-cache");
header ("Content-type: application/vnd.ms-excel");
header ("Content-Disposition: attachment; filename=".$filename.".xls");
header ("Content-Description: Generated Report" );

$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');	

$excel="<table border='1'>
<tr>
<th colspan='2' style='text-align:center;'>Accounts Group</th>
</tr>
<tr>
<th style='text-align:left;'>Sr. No.</th>
<th style='text-align:left;'>Accounts Group</th>
</tr>";
$n = 1;
$this->loadmodel('accounts_group');
$conditions=array("delete_id" => 0);
$cursor = $this->accounts_group->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$name = $collection['accounts_group']['group_name'];
$auto_id = (int)$collection['accounts_group']['auto_id'];

$excel.="
<tr>
<td style='text-align:left;'>$n</td>
<td style='text-align:left;'>$name</td>
</tr>
";
}
$excel.="</table>";

echo $excel;
}
///////////////////////// End accounts gruo excel hm //////////////////////////////////////////////////

/////////////////////// Start Ledger Account Excel Hm ///////////////////////////////////////////////////
function ledger_account_excel_hm()
{
$this->layout="";
$filename="Ledger Accounts";
header ("Expires: 0");
header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
header ("Cache-Control: no-cache, must-revalidate");
header ("Pragma: no-cache");
header ("Content-type: application/vnd.ms-excel");
header ("Content-Disposition: attachment; filename=".$filename.".xls");
header ("Content-Description: Generated Report" );

$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');	

$excel="<table border='1'>
<tr>
<th colspan='4'>Ledger Accounts</th>
</tr>
<tr>
<th style='text-align:left;'>Sr. No.</th>
<th style='text-align:left;'>Accounts Category</th>
<th style='text-align:left;'>Accounts Group</th>
<th style='text-align:left;'>Ledger Accounts</th>
</tr>";
$n = 1;
$this->loadmodel('ledger_account');
$conditions=array("delete_id" => 0);
$cursor = $this->ledger_account->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$auto_id5 = (int)$collection['ledger_account']['auto_id'];
$sub_id = (int)$collection['ledger_account']['group_id'];
$name = $collection['ledger_account']['ledger_name'];
$edit_id = (int)$collection['ledger_account']['edit_user_id'];

$result_ag = $this->requestAction(array('controller' => 'hms', 'action' => 'accounts_group'),array('pass'=>array($sub_id)));
foreach ($result_ag as $collection) 
{
$accounts_id = (int)$collection['accounts_group']['accounts_id'];	
$group_name = $collection['accounts_group']['group_name'];	
}

$result_ac = $this->requestAction(array('controller' => 'hms', 'action' => 'accounts_category'),array('pass'=>array($accounts_id)));		   
foreach ($result_ac as $collection) 
{
$main_name = $collection['accounts_category']['category_name'];	
}
$excel.="<tr>
<td style='text-align:left;'>$n</td>
<td style='text-align:left;'>$main_name</td>
<td style='text-align:left;'>$group_name</td>
<td style='text-align:left;'>$name</td>
</tr>";
$n++;
}	
$excel.="</table>";

echo $excel;

}
/////////////////////// End Ledger Account Excel Hm ///////////////////////////////////////////////////

/////////////////////////// Start Nov View2 ///////////////////////////////////////////////////////////
function noc_view2()
{
$this->layout="session";
$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');

$show_arr2 = $this->request->query('arr');
$this->set("show_arr2",$show_arr2);

if(isset($this->request->data['sub']))
{
$this->loadmodel('flat_type');
$order=array('flat_type.auto_id'=>'ASC');
$condition=array('society_id'=>$s_society_id);
$cursor1 = $this->flat_type->find('all',array('conditions'=>$condition,'order' => $order)); 
foreach($cursor1 as $collection)
{
$auto_id1 = (int)$collection['flat_type']['auto_id'];
$type_id = (int)$this->request->data['tp'.$auto_id1];
if($type_id == 4)
{
$arr = array($type_id);
}
else
{
$amt = $this->request->data['amt'.$auto_id1];
$arr = array($type_id,$amt);
}

$this->loadmodel('flat_type');
$this->flat_type->updateAll(array('noc_charge' => $arr),array('auto_id' => $auto_id1));
}
$this->response->header('Location', 'master_noc_view');
}

$this->loadmodel('flat_type');
$order=array('flat_type.auto_id'=>'ASC');
$condition=array('society_id'=>$s_society_id);
$cursor1 = $this->flat_type->find('all',array('conditions'=>$condition,'order' => $order)); 
$this->set('cursor1',$cursor1);
}
/////////////////////////// End Nov View2 ///////////////////////////////////////////////////////////


function update_wing_flat()
{
	$this->layout="session";
	$s_society_id = (int)$this->Session->read('society_id');
	
	/*$this->loadmodel('user');
	$result_user_acc=$this->user->find('all',array('conditions'=>array('society_id'=>$s_society_id),'role_id' =>array('$in' => array(2))));
	foreach($result_user_acc as $data_acc)
	{
		$user_name=$data_acc["user"]["user_name"];
		$user_id=$data_acc["user"]["user_id"];
		$deactive=$data_acc["user"]["deactive"];
		
		$this->loadmodel('ledger_sub_account');
		$k=$this->autoincrement('ledger_sub_account','auto_id');
		$this->ledger_sub_account->saveAll(array("auto_id" => $k, "ledger_id" =>34, 'name'=>$user_name,"society_id" => $s_society_id,"deactive" => $deactive,"user_id" => $user_id));
	}*/
	
	
	if(isset($this->request->data['update']))
	{
		$user=(int)$this->request->data['user'];
		$wing=(int)$this->request->data['wing'];
		$flat=(int)$this->request->data['flat'];
		
		$this->loadmodel('user');
		$this->user->updateAll(array('wing'=>$wing,'flat'=>$flat),array('user_id'=>$user));
		
	}
	
	$this->loadmodel('user');
	$this->set('result_user',$this->user->find('all',array('conditions'=>array('society_id'=>$s_society_id))));
	
	$this->loadmodel('wing');
	$this->set('result_wing',$this->wing->find('all',array('conditions'=>array('society_id'=>$s_society_id))));
}

function update_wing_flat_ajax()
{
	$this->layout="blank";
	$w=(int)$this->request->query('w');
	$s_society_id = (int)$this->Session->read('society_id');
	$this->loadmodel('flat');
	$this->set('result_flat',$this->flat->find('all',array('conditions'=>array('wing_id'=>$w))));
}

function family_member_valid()
{

$this->layout='blank';
$q=$this->request->query('q');
 $q = html_entity_decode($q);
 $myArray = json_decode($q, true);

$s_society_id=$this->Session->read('hm_society_id'); 
$s_role_id=$this->Session->read('role_id');
$s_user_id=$this->Session->read('hm_user_id');
	

			date_default_timezone_set('Asia/kolkata');
			$date=date("d-m-Y");
			$time=date('h:i:a',time());
			$result_user = $this->requestAction(array('controller' => 'Fns', 'action' => 'user_info_via_user_id'),array('pass'=>array($s_user_id)));
			$user_name_by= $result_user[0]['user']['user_name'];
			$result_user_flat = $this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id'),array('pass'=>array($s_user_id)));
			foreach($result_user_flat as $data){
			$tenant=@$data['user_flat']['owner'];
			$wing=(int)@$data['user_flat']['wing'];
			$flat=(int)@$data['user_flat']['flat'];
			}
	@$wing_flat=$this->wing_flat($wing,$flat);
	$result_society=$this->society_name($s_society_id);	
	foreach($result_society as $data)
	{
	   $society_name=$data['society']['society_name'];
	   @$family_member=$data['society']['family_member'];
	   @$family_member_tenant=$data['society']['family_member_tenant'];
	  
	}

	
	$s_n='';
	$sco_na=$society_name;
	$dd=explode(' ',$sco_na);
	$first=$dd[0];
	@$two=$dd[1];
	@$three=$dd[2];
	$s_n.=" $first $two $three ";

foreach($myArray as $child){
	
	
	if(empty($child[0])){
		$output = json_encode(array('type'=>'error', 'text' => 'Please enter a name'));
        die($output);
	}
	
	
	if (!filter_var($child[4], FILTER_VALIDATE_EMAIL) && !empty($child[4])) {
	  $output = json_encode(array('type'=>'error', 'text' => 'Invalid email format'));
        die($output);
	}elseif(!empty($child[4])){
		$this->loadmodel('user_temp');
		$conditions=array("email" => $child[4],'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("email" => $child[4]);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n4 = sizeof($result4);
		$e=$n3+$n4;
		if ($e > 0) {
			$output = json_encode(array('type'=>'error', 'text' => 'Email already exist.'));
			die($output);
		}
	}
	
	if (!preg_match ( '/^\\d{10}$/',$child[5]) && !empty($child[5])) {
	  $output = json_encode(array('type'=>'error', 'text' => 'Invalid mobile format'));
        die($output);
	}elseif(!empty($child[5])){
		$this->loadmodel('user_temp');
		$conditions=array("mobile" => $child[5],'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("mobile" => $child[5]);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n4 = sizeof($result4);
		$e=$n3+$n4;
		if ($e > 0) {
			$output = json_encode(array('type'=>'error', 'text' => 'Mobile already exist.'));
			die($output);
		}
	}
	
	
	
	
	if(empty($child[1])){
		$output = json_encode(array('type'=>'error', 'text' => 'Please select age group'));
        die($output);
	}
	
	/*if(!empty($child[1]) && $child[1]< 13){
		
		$output = json_encode(array('type'=>'error', 'text' => 'Your age should be above 13'));
        die($output);
		
	}*/
	if(empty($child[3])){
		$output = json_encode(array('type'=>'error', 'text' => 'Please enter a relation'));
        die($output);
	}
	
	
	
	if (!empty($child[4])) {
	  $email_addrs1[]=$child[4];
	  $email_addrs2[]=$child[4];
	}
	if (!empty($child[5])) {
	  $mobile_no1[]=$child[5];
	  $mobile_no2[]=$child[5];
	}
	
	
	
	
	
}

if((sizeof(@$email_addrs1)>0) && (sizeof(@$email_addrs2)>0)){
	$email_addrs1 = array_unique($email_addrs1);
	if(sizeof(@$email_addrs1)!=sizeof(@$email_addrs2)){
	$output = json_encode(array('type'=>'error', 'text' => 'Email should not be same in two or more rows.'));
        die($output);
}
}

if((sizeof(@$mobile_no1)>0) && (sizeof(@$mobile_no2)>0)){
	$mobile_no1 = array_unique($mobile_no1);
	if(sizeof(@$mobile_no1)!=sizeof(@$mobile_no2)){
	$output = json_encode(array('type'=>'error', 'text' => 'mobile should not be same in two or more rows.'));
        die($output);
}
}

if($tenant=='yes'){
		$type="owner";
		$role_new_id=5;
	}
	if($tenant=='no'){
		$type="tenant";
		$role_new_id=6;
	}


if(($type=="owner" && $family_member==1) || ($type=="tenant" && $family_member_tenant==1))
{

	$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip'));

		foreach($myArray as $child)
		{
			$name=$child[0];
			$email=$child[4];
			$mobile=$child[5];
			$dob=$child[1];
			$relation=$child[3];
			$blood_group=$child[2];
			$gender=$child[6];
			
			$this->loadmodel('user');	
			$i=$this->autoincrement('user','user_id');	
			$random1=mt_rand(1000000000,9999999999);
			$random2=mt_rand(1000000000,9999999999);
			$random=$random1.$random2 ;	
			$de_user_id=$this->encode($i,'housingmatters');
			$random=$de_user_id.'/'.$random;
			$log_i=$this->autoincrement('login','login_id');

				if(!empty($mobile) && empty($email))
				{
					 $r_sms=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_sms_ip'));
					
					 $working_key=$r_sms->working_key;
					 $sms_sender=$r_sms->sms_sender; 
					 $sms_allow=(int)$r_sms->sms_allow;
					$random=(string)mt_rand(1000,9999);
					if($sms_allow==1){
					$sms="".$name.", Your housing society ".$s_n." has enrolled you in HousingMatters portal. Pls log into www.housingmatters.co.in One Time Password ".$random."";
					$sms1=str_replace(" ", '+', $sms);
					$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
					}
				}

			
			
		  			
			////////////////////////// insert user table //////////////////////////
$this->loadmodel('user');
$this->user->saveAll(array('user_id' => $i,'user_name' => $name,'email' => $email, 'password' => @$random, 'mobile' => $mobile,'society_id' => $s_society_id,'date' => $date, 'time' => $time,'signup_random'=>$random,'active'=>'yes','user_type'=>'family_member','is_family_member'=>'yes','family_main_member'=>$s_user_id,'relationship'=>$relation));			
			
$this->loadmodel('user_profile');	
$user_profile_id=$this->autoincrement('user_profile','user_profile_id');		
$this->user_profile->saveAll(array('user_profile_id'=>$user_profile_id,'gender'=>$gender,'age'=>$dob,'blood_group'=>$blood_group,'user_id'=>$i,'society_id'=>$s_society_id));

$this->loadmodel('user_role');
$auto_role_id=$this->autoincrement('user_role','auto_id');
$this->user_role->saveAll(array('auto_id'=>$auto_role_id,'user_id'=>$i,'role_id'=>$role_new_id,'default'=>'yes','society_id' => $s_society_id));	

			////////////////////// End user table ///////////////////////////////////////////////////
$this->loadmodel('user_flat');
$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>$s_society_id,'exited'=>'no','wing'=>$wing,'flat'=>$flat));

if(!empty($email) && !empty($mobile))
		{
		
    $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify">As a family member, you have been added to '.$society_name.' online portal by '.$user_name_by.' '.@$wing_flat.' </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/send_sms_for_verify_mobile?q='.$random.'"> Click here </a> for one time verification of your mobile number and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
			
		}
			
		
		if(!empty($email) && empty($mobile))
		{
			
			
			$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify">As a family member, you have been added to '.$society_name.' online portal by '.$user_name_by.' '.@$wing_flat.' </span> 
										</td>
																
								</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an owner/resident/staff of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/set_new_password?q='.$random.'"> Click here </a> for one time verification of your email and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
			
			
		}
			
		
		
			
			$from_name="HousingMatters";
			$reply="support@housingmatters.in";
			$to=$email;
			$this->loadmodel('email');
			$conditions=array("auto_id" => 4);
			$result_email = $this->email->find('all',array('conditions'=>$conditions));
			foreach ($result_email as $collection) 
			{
			$from=$collection['email']['from'];
			}
			$subject="Welcome to ".$society_name." portal ";
			if(!empty($email))
			{
			$this->send_email($to,$from,$from_name,$subject,$message_web,$reply);
			}

			
			////////////////////////////////// insert login table /////////////////////////////////////


			/////////////////////////  End login table /////////////////////////////////////////

			
			////////////////Notification email user all checked code  //////////////////////////
				$this->loadmodel('email');	
				$conditions=array('notification_id'=>1);
				$result_email=$this->email->find('all',array('conditions'=>$conditions));
				foreach($result_email as $data)
				{
				$auto_id = (int)$data['email']['auto_id'];
				$this->loadmodel('notification_email');
				$lo=$this->autoincrement('notification_email','notification_id');
				$this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id , "user_id" => $i,'chk_status'=>0));
				}

				//////////////// End all checked code   //////////////////////////
			
			
			

		}
				
		$output = json_encode(array('type'=>'add_tr', 'text' => 'Your family member will get further communication to complete their enrollment process.'));
		die($output);



}
else
{
	
	
	$output = json_encode(array('type'=>'sucess', 'text' => 'Administrator has not allowed family member login into the portal.'));
    die($output);
	
}



}
//Start Check Email Already Exist//
function check_email_already_exist()
{
$this->layout='blank';
$q=$this->request->query('q'); 

$s_society_id=$this->Session->read('hm_society_id');

$res_society=$this->society_name($s_society_id);
foreach($res_society as $data)
{
 $society_name=$data['society']['society_name'];
 $access_tenant=(int)@$data['society']['access_tenant'];

} 
$s_n='';
$sco_na=$society_name;
$dd=explode(' ',$sco_na);
 $first=$dd[0];
 @$two=$dd[1];
 @$three=$dd[2];
 $s_n.=" $first $two $three ";

 date_default_timezone_set('Asia/kolkata');
 $date=date("d-m-Y");
 $time=date('h:i:a',time());





$myArray = json_decode($q, true);
$c=0;
$report=array();

foreach($myArray as $child){
	$c++;
	
	
	if(empty($child[0])){
		$report[]=array('tr'=>$c,'td'=>1, 'text' => 'Required');
	}
	if(empty($child[1])){
        $report[]=array('tr'=>$c,'td'=>2, 'text' => 'Required');
	}
	if(empty($child[2])){
        $report[]=array('tr'=>$c,'td'=>3, 'text' => 'Required');
	}
	if (!filter_var($child[3], FILTER_VALIDATE_EMAIL) && !empty($child[3])) {
		$report[]=array('tr'=>$c,'td'=>4, 'text' => 'Invalid');
	}elseif(!empty($child[3])){
		$this->loadmodel('user_temp');
		$conditions=array("email" => $child[3],'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("email" => $child[3]);
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n4 = sizeof($result4);
		$e=$n3+$n4;
		if ($e > 0) {
			$report[]=array('tr'=>$c,'td'=>4, 'text' => 'already exist');
		}
	}
	if (!preg_match ( '/^\\d{10}$/',$child[4]) && !empty($child[4])) {
		$report[]=array('tr'=>$c,'td'=>5, 'text' => 'Invalid');
	}elseif(!empty($child[4])){
		$this->loadmodel('user_temp');
		$conditions=array("mobile" => $child[4],'reject'=>0);
		$result3 = $this->user_temp->find('all',array('conditions'=>$conditions));
		$n3 = sizeof($result3);
		$this->loadmodel('user');
		$conditions=array("mobile" => $child[4],'user_id'=>array('$ne'=>1));
		$result4 = $this->user->find('all',array('conditions'=>$conditions));
		$n4 = sizeof($result4);
		$e=$n3+$n4;
		if ($e > 0) {
			$report[]=array('tr'=>$c,'td'=>5, 'text' => 'already exist');
		}
	}
	if (empty($child[5])) {
		$report[]=array('tr'=>$c,'td'=>6, 'text' => 'Required');
	}else{
			if ($child[5]==1){
					if (empty($child[6])){
						$report[]=array('tr'=>$c,'td'=>7, 'text' => 'Required');
					}
					
					
			}
	}
	
	if($child[5] == 1)
	{
	$tenant2="yes";	
	}
	else
	{
	$tenant2="no";	
	}
	
	
	if(!empty($child[2])) {
		
		
		$this->loadmodel('flat');
		$conditions=array("flat_id" => (int)$child[2]);
		$result66 = $this->flat->find('all',array('conditions'=>$conditions));
		foreach($result66 as $dataa)
		{
		$flat_type = (int)$dataa['flat']['noc_ch_tp'];	
		}
		
		if($flat_type == 1)
		{
			if($tenant2 == 'no')
			{
			 $report[]=array('tr'=>$c,'td'=>3, 'text' => 'Flat is self Occupied');	
			}
			
		}
		
		$this->loadmodel('user_flat');
		$conditions=array("flat" => (int)$child[2],"owner"=>array('$ne'=>null),"exited"=>"no");
		$result4 = $this->user_flat->find('all',array('conditions'=>$conditions));
			
		$n4 = sizeof($result4); 
		if($n4==1){
			
			$tenant=$result4[0]['user_flat']['owner'];
			if($tenant=='yes'){
				if($tenant==$tenant2){
					
					$report[]=array('tr'=>$c,'td'=>3, 'text' => 'already exist owner');	
					
				}
				
				
			}else{
				
				if($tenant==$tenant2){
					
					$report[]=array('tr'=>$c,'td'=>3, 'text' => 'already exist tenant');	
					
				}
				
				
				
			}
			
			
		}
			if($n4==2){	
				$report[]=array('tr'=>$c,'td'=>3, 'text' => 'already exist');
			
			}
		
		}
	
	
	if(!empty($child[2])) {
		
		
			$flat_id1[]=$child[2];
			 $flat_id2[]=$child[2];
	}
	

	
	if (!empty($child[3])) {
	  $email_addrs1[]=$child[3];
	  $email_addrs2[]=$child[3];
	}
	if (!empty($child[4])) {
	  $mobile_no1[]=$child[4];
	  $mobile_no2[]=$child[4];
	}
	
	
	if((sizeof(@$email_addrs1)>0) && (sizeof(@$email_addrs2)>0)){
	$email_addrs1 = array_unique($email_addrs1);
	if(sizeof(@$email_addrs1)!=sizeof(@$email_addrs2)){
	$output = json_encode(array('report_type'=>'already_error', 'text' => 'Email should not be same in two or more rows.'));
        die($output);
		}
	  }
if((sizeof(@$mobile_no1)>0) && (sizeof(@$mobile_no2)>0)){
	$mobile_no1 = array_unique($mobile_no1);
	if(sizeof(@$mobile_no1)!=sizeof(@$mobile_no2)){
	$output = json_encode(array('report_type'=>'already_error', 'text' => 'mobile should not be same in two or more rows.'));
        die($output);
		}
	 }
$owner_tenant_set[]=$child[2].'-'.$child[5];
}

if(sizeof($report)>0){
	$output=json_encode(array('report_type'=>'error','report'=>$report));
	die($output);
}

$owner_tenant_set=array_count_values($owner_tenant_set);
foreach($owner_tenant_set as $data){
		if($data>=2){
			
			$output = json_encode(array('report_type'=>'already_error', 'text' => 'Flat should not be same owner and tenant in two or more rows.'));
			die($output);
		}
	}
	
$ip=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_email_ip')); 

/*------code here insert start -------*/



foreach($myArray as $child)
{
	$name=$child[0];
	$email=$child[3];
	$mobile=$child[4];
	$wing=(int)$child[1];
	$flat=(int)$child[2];
	$residing=(int)$child[7];
	$tenant=(int)$child[5];

	if($tenant==1){
	 $type = "yes";
	 $type_owner="Owner";
	 $committee=(int)$child[6];
	 $role_new_id=3;
	 $email_content="owner/resident/staff";
	}
	else{
		$type = "no";
		$type_owner="Tenant";
		$committee=2;
	    $role_new_id=4;
		$email_content="Tenant/resident/staff";
	}

		$this->loadmodel('flat');
		$conditions=array("flat_id" =>$flat);
		$result_flat = $this->flat->find('all',array('conditions'=>$conditions));
		foreach($result_flat as $data_flat){
		 $flat_type = (int)$data_flat['flat']['noc_ch_tp'];	
		}
		
	
	
	
	$this->loadmodel('user');
	$i=$this->autoincrement('user','user_id');
	$log_i=$this->autoincrement('login','login_id');

	$random1=mt_rand(1000000000,9999999999);
	$random2=mt_rand(1000000000,9999999999);
	$random=$random1.$random2 ;	
	$de_user_id=$this->encode($i,'housingmatters');
	$random=$de_user_id.'/'.$random;
	
if(($access_tenant==1 && $type_owner=="Tenant") || $type_owner=="Owner"){
		if(!empty($mobile) && empty($email))
		{
			$r_sms=$this->requestAction(array('controller' => 'Fns', 'action' => 'hms_sms_ip')); 
			
			$working_key=$r_sms->working_key;
			$sms_sender=$r_sms->sms_sender;
			$sms_allow=(int)$r_sms->sms_allow;

		$login_user=$mobile;
		$random=(string)mt_rand(1000,9999);
		if($sms_allow==1){
			
			$user_name_short=$this->check_charecter_name($name);
			$sms="".$user_name_short.", Your housing society ".$s_n." has enrolled you in HousingMatters portal. Pls log into www.housingmatters.in One Time Password ".$random."";
			$sms1=str_replace(" ", '+', $sms);
			$payload = file_get_contents('http://alerts.sinfini.com/api/web2sms.php?workingkey='.$working_key.'&sender='.$sms_sender.'&to='.$mobile.'&message='.$sms1.'');
			}
		}
}
		
		
$this->user->saveAll(array('user_id' => $i,'user_name' => $name,'email' => $email, 'password' => @$random, 'mobile' => $mobile,'society_id' => $s_society_id,'date' => $date, 'time' => $time,'signup_random'=>$random,'active'=>'yes','user_type'=>'member','profile_pic'=>'blank.jpg'));
 

$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>$s_society_id,'wing'=>$wing,'flat'=>$flat,'exited'=>'no','owner'=>$type));

$auto_id=$this->autoincrement('user_role','auto_id');
$this->user_role->saveAll(array('auto_id'=>$auto_id,'user_id'=>$i,'role_id'=>$role_new_id,'default'=>'yes','society_id'=>$s_society_id));	 
 
 if($committee==1){
			$auto_id=$this->autoincrement('user_role','auto_id');
			$this->user_role->saveAll(array('auto_id'=>$auto_id,'user_id'=>$i,'role_id'=>2,'society_id'=>$s_society_id));
	}


 
if($tenant==1){
$this->loadmodel('ledger_sub_account');
$j=$this->autoincrement('ledger_sub_account','auto_id');
$this->ledger_sub_account->saveAll(array('auto_id'=>$j,'ledger_id'=>34,'name'=>$name,'society_id' => $s_society_id,'user_id'=>$i,'user_flat_id'=>$user_flat_id,'exited'=>'no'));
}
	
		$special="'";
		if(!empty($email) && !empty($mobile))
		{
		$login_user=$email;	

		$message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 '.$special.'We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an '.$email_content.' of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/send_sms_for_verify_mobile?q='.$random.'"> Click here </a> for one time verification of your mobile number and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
		
		}
		
		if(!empty($email) && empty($mobile))
		{
			
			$login_user=$email;	
		
			
			
			
  $message_web='<table  align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
          <tbody>
			<tr>
                <td>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
									<td colspan="2">
										<table style="border-collapse:collapse" cellpadding="0" cellspacing="0" width="100%">
										<tbody>
										<tr><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										<tr>
										<td style="height:32;line-height:0px" align="left" valign="middle" width="32"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/HM-LOGO-small.jpg" style="border:0" height="50" width="50"></a></td>
										<td style="display:block;width:15px" width="15">&nbsp;&nbsp;&nbsp;</td>
										<td width="100%"><a href="#150d7894359a47c6_" style="color:#3b5998;text-decoration:none;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:19px;line-height:32px"><span style="color:#00a0e3">Housing</span><span style="color:#777776">Matters</span></a></td>
										<td align="right"><a href="https://www.facebook.com/HousingMatters.co.in" target="_blank"><img class="CToWUd" src="'.$ip.$this->webroot.'as/hm/SMLogoFB.png" style="max-height:30px;min-height:30px;width:30px;max-width:30px" height="30px" width="30px"></a>
											
										</td>
										</tr>
										<tr style="border-bottom:solid 1px #e5e5e5"><td style="line-height:16px" colspan="4" height="16">&nbsp;</td></tr>
										</tbody>
										</table>
									</td>
								</tr>
								
									
								
						</tbody>
					</table>
					
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tbody>
						
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span style="color:rgb(100,100,99)" align="justify"> Dear '.$name.', </span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										 '.$special.'We at '.$society_name.' use HousingMatters - a dynamic web portal to interact with all owners/residents/staff for transparent & smart management of housing society affairs.
										
										
										
										
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										As you are an '.$email_content.' of '.$society_name.', we have added your email address in HousingMatters portal.
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												Here are some of the important features related to our portal on HousingMatters:
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
												You can log & track complaints, start new discussions, check your dues, post classifieds and many more in the portal.
										</td>
																
								</tr>

									<tr>
									<td style="padding:5px;" width="100%" align="left">
									You can receive important SMS & emails from your committee.
									</td>

									</tr>
								<tr>
										<td style="padding:5px;" width="100%" align="left"><br/>
											<span  align="justify"> <b>
											<a href="'.$ip.$this->webroot.'hms/set_new_password?q='.$random.'"> Click here </a> for one time verification of your email and Login into HousingMatters for making life simpler for all your housing matters!</b>
											</span> 
										</td>
																
								</tr>
								
								<tr>
										<td style="padding:5px;" width="100%" align="left">
										<span align="justify"> Pls add www.housingmatters.in in your favorite bookmarks for future use. </span> 
										</td>
																
								</tr>
								
								<tr>
									<td style="padding:5px;" width="100%" align="left">
											<span > 
												Regards,<br/>
												Administrator of '.$society_name.'<br/>
												www.housingmatters.in
											</span>
									</td>
																
								</tr>
					
					</table>
					
				</td>
			</tr>

        </tbody>
</table>';
			
		}

			$from_name="HousingMatters";
			$reply="support@housingmatters.in";
			$to=$email;
			$this->loadmodel('email');
			$conditions=array("auto_id" => 4);
			$result_email = $this->email->find('all',array('conditions'=>$conditions));
			foreach ($result_email as $collection) 
			{
			 $from=$collection['email']['from'];
			}
			 $subject="Welcome to ".$society_name." portal ";
			if(($access_tenant==1 && $type_owner=="Tenant") || $type_owner=="Owner"){
				if(!empty($email)){	
				
						$this->send_email($to,$from,$from_name,$subject,@$message_web,$reply);
					}
			}
			

				////////////////Notification email user all checked code  //////////////////////////
				$this->loadmodel('email');	
				$conditions=array('notification_id'=>1);
				$result_email=$this->email->find('all',array('conditions'=>$conditions));
				foreach($result_email as $data)
				{
				$auto_id = (int)$data['email']['auto_id'];
				$this->loadmodel('notification_email');
				$lo=$this->autoincrement('notification_email','notification_id');
				$this->notification_email->saveAll(array("notification_id" => $lo, "module_id" => $auto_id , "user_id" => $i,'chk_status'=>0));
				}

				//////////////// End all checked code   //////////////////////////

			
			
		

}
$output = json_encode(array('report_type'=>'success', 'text' => 'New members registered into your society successfully.'));
die($output);



}
//End Check Email Already Exist// 
//Start Function expense Tracker Add Fetch2 (Accounts)//
function expense_tracker_fetch2($auto_id) 
{
	$s_society_id = (int)$this->Session->read('hm_society_id');
$this->loadmodel('ledger_account');
$conditions =array('$or'=>array(array("group_id"=>(int)$auto_id,'society_id' =>$s_society_id),array("society_id" => 0,"group_id"=>$auto_id)));
return $this->ledger_account->find('all',array('conditions'=>$conditions));
}
//End Function Fetch expense Tracker Add Fetch2 (Accounts)//
//Start Expense Tracker View History Expense Head (Accounts)//
function expense_tracker_fetch($auto_id)
{
$this->loadmodel('expense_tracker');
$conditions=array("auto_id" => $auto_id);
return $this->expense_tracker->find('all',array('conditions'=>$conditions));
}
//End Expense Tracker View History Expense Head Fetch (Accounts)//

//Start Flat type Validation//
function flat_type_validation()
{
	$this->layout='blank';
	$q=$this->request->query('q');
	$q = html_entity_decode($q);
	$wing = $this->request->query('b');
	$wing = html_entity_decode($wing);

	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id  = (int)$this->Session->read('user_id');

	$wing = json_decode($wing, true);
	$myArray = json_decode($q, true);

	if(empty($wing))
	{
	$output = json_encode(array('type'=>'error', 'text' => 'Select Wing'));
	die($output);
	}
$c=0;
$array1 = array();
foreach($myArray as $data)
{
$c++;
	if(empty($data[0]))
	{
	$output = json_encode(array('type'=>'error', 'text' => 'Insert Flat Number in textbox'.$c.''));
	die($output);
	}
	
		$unit_name = $data[0];
		$result = preg_match('/\s/',$unit_name);
		if($result != 0)
		{
		$output = json_encode(array('type'=>'error', 'text' => 'There Should be no Space in Unit Name in textbox '.$c.''));
		die($output);
		}

	$result2 = preg_match('/[^a-z0-9 _]+/i', $unit_name);
	if($result2 != 0)
	{
	$output = json_encode(array('type'=>'error', 'text' => 'There Should be no Special Character in Unit Name in textbox '.$c.''));
	die($output);
	}
   
   
	
	
	
$nnn = 555;
$this->loadmodel('flat');
$conditions=array("society_id"=>$s_society_id);
$cursor3 = $this->flat->find('all',array('conditions'=>$conditions));
foreach($cursor3 as $collection)
{	
$wing_id2 = (int)$collection['flat']['wing_id'];
$flat_nu2 = $collection['flat']['flat_name'];	
if($wing_id2 == $wing && $flat_nu2 == $data[0])
{
$nnn = 55;
break;	
}	
}	
if($nnn == 55)
{	
$output = json_encode(array('type'=>'error', 'text' => 'The Flat Number is Already Exist in textbox'.$c.''));
die($output);
}	

foreach($array1 as $child)
{
if($child == $data[0])
{
$output = json_encode(array('type'=>'error', 'text' => 'Repeatation of Flat Number in textbox'.$c.''));
die($output);
}
}
$array1[] = $data[0];
}

foreach($myArray as $data)
{
$flat_number = $data[0];
$flat_number = trim($flat_number);

//$len = strlen($flat_number);	
//$val = 10-$len;	
$flat_number2 = str_pad($flat_number,10,"0",STR_PAD_LEFT);	

$wing = (int)$wing;
$this->loadmodel('flat');
$order=array('flat.flat_id'=> 'DESC');
$cursor=$this->flat->find('all',array('order' =>$order,'limit'=>1));
foreach ($cursor as $collection) 
{
$last=$collection['flat']["flat_id"];
}
if(empty($last))
{
$k=0;
}	
else
{	
$k=$last;
}
$k++;
$this->loadmodel('flat');
$multipleRowData = Array( Array("flat_id"=>$k, "wing_id"=>$wing, "flat_name"=>$flat_number2, "society_id"=>$s_society_id,'noc_ch_tp'=>1));
$this->flat->saveAll($multipleRowData);

}
$output = json_encode(array('type'=>'succ', 'text' => 'Record Inserted Successfully'));
die($output);

}
////////////////////////////// End Flat type Validation //////////////////////////////////////////////////////////

//////////////////////////////////////// Start Insert query /////////////////////////////////////////////////////////
function query_insert()
{
$this->layout='blank';
$s_society_id=$this->Session->read('society_id'); 
$s_role_id=$this->Session->read('role_id');
$s_user_id=$this->Session->read('user_id');


$this->loadmodel('user');
$cursor = $this->user->find('all');
foreach($cursor as $collection)
{
$user_id = (int)$collection['user']['user_id'];
$deactive = (int)$collection['user']['deactive'];
$society_id = (int)$collection['user']['society_id'];
$name = $collection['user']['user_name'];
$role = $collection['user']['role_id'];

for($r=0; $r<sizeof($role); $r++)
{
$role_id = (int)$role[$r];
if($role_id == 2)
{
$k = (int)$this->autoincrement('ledger_sub_account','auto_id');
$this->loadmodel('ledger_sub_account');
$multipleRowData = Array( Array("auto_id"=>$k,"ledger_id"=>34,"delete_id"=>0,"society_id"=>$society_id,"name"=>$name,"user_id"=>$user_id,"deactive"=>$deactive));
$this->ledger_sub_account->saveAll($multipleRowData);
}
}


}
}
///////////////////////////////// End Insert Query /////////////////////////////////////////////////////////////////

//////////////////////////////// Start Master Sm Flat Vali //////////////////////////////////////////////////
function master_sm_flat_vali()
{
$s_society_id = (int)$this->Session->read('hm_society_id');
$s_user_id  = (int)$this->Session->read('user_id');
$s_role_id = (int)$this->Session->read('role_id');

$res_society=$this->society_name($s_society_id);
foreach($res_society as $data)
{
$society_name=$data['society']['society_name'];
}

$q=$this->request->query('q');
$q = html_entity_decode($q);

$s_n='';
$sco_na=$society_name;
$dd=explode(' ',$sco_na);
$first=$dd[0];
@$two=$dd[1];
@$three=$dd[2];
$s_n.=" $first $two $three ";

date_default_timezone_set('Asia/kolkata');
$date=date("d-m-Y");
$time=date('h:i:a',time());

$myArray = json_decode($q, true);

$c=0;

foreach($myArray as $child)
{
$c++;

if(empty($child[0])){
$output = json_encode(array('type'=>'error', 'text' => 'Please Select Wing in row'.$c));
die($output);
}	

if(empty($child[1])){
$output = json_encode(array('type'=>'error', 'text' => 'Please Select Flat Number in row'.$c));
die($output);
}	

$this->loadmodel('flat');
$conditions=array("society_id"=>$s_society_id);
$cursor3 = $this->flat->find('all',array('conditions'=>$conditions));
foreach($cursor3 as $collection)
{
$wing_id = $collection['flat']['wing_id'];
$flat_nu = $collection['flat']['flat_id'];
$flat_area = @$collection['flat']['flat_area'];

if($wing_id == $child[0] and $flat_nu == $child[1] and !empty($flat_area))
{
$nnn = 55;
break;
}
else
{
$nnn = 555;
}
}
if($nnn == 55)
{
$output = json_encode(array('type'=>'error', 'text' => 'The Flat Number is Already Exist, Please Select Another Flat Number in row'.$c));
die($output);
}


$wing_id1 = (int)$child[0];
$flat_id = (int)$child[1];

for($j=0; $j<sizeof(@$fl_arr); $j++)
{
$sub_arr2 = $fl_arr[$j];
$wing_id2 = (int)$sub_arr2[0];
$flat_id2 = (int)$sub_arr2[1];

if($wing_id2 == $wing_id1 and $flat_id2 == $flat_id)
{
$mmm = 55;
break;
}
else
{
$mmm = 555;
}
}

if(@$mmm == 55)
{
$output = json_encode(array('type'=>'error', 'text' => 'Repeatation of Same Wing and Flat Number, Please Select Another Wing or Flat in row'.$c));
die($output);
}
$sub_arr = array($wing_id1,$flat_id);
$fl_arr[] = $sub_arr;

if(empty($child[2])){
$output = json_encode(array('type'=>'error', 'text' => 'Please Select Flat Type in row'.$c));
die($output);
}	

if(!empty($child[3]))
{
if(is_numeric($child[3]))
{
}
else
{
$output = json_encode(array('type'=>'error', 'text' => 'Please Fill Numeric Area of the Flat in row'.$c));
die($output);
}
}

}

foreach($myArray as $child)
{
$wing_id5 = (int)$child[0];
$flat_id5 = (int)$child[1];
$flat_type5 = (int)$child[2];
$flat_area5 = (float)$child[3];

///////////////////////////
$qqq = 5;
$this->loadmodel('flat_type');
$condition=array('society_id'=>$s_society_id,"flat_type_id"=>$flat_type5);
$cursor = $this->flat_type->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$auto_id = (int)@$collection['flat_type']['auto_id'];
$no_of_flat = (int)@$collection['flat_type']['number_of_flat'];
$qqq = 55;
}
if($qqq == 5)
{

$no_of_flat = 1;
$this->loadmodel('flat_type');
$p=$this->autoincrement('flat_type','auto_id');
$this->flat_type->saveAll(array("auto_id" => $p,"flat_type_id"=> $flat_type5,"number_of_flat"=>$no_of_flat,"status"=>0,"society_id"=>$s_society_id));

$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$flat_area5,"flat_type_id"=>$flat_type5),array("flat_id"=>$flat_id5));
}
else if($qqq == 55)
{
$no_of_flat++;
$this->loadmodel('flat_type');
$this->flat_type->updateAll(array("number_of_flat"=>$no_of_flat),array("auto_id"=>$auto_id));

$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$flat_area5,"flat_type_id"=>$flat_type5),array("flat_id"=>$flat_id5));
}

}

$output = json_encode(array('type'=>'succ', 'text' => 'Record Inserted Successfully.'));
die($output);

}
//////////////////////////////// End Master Sm Flat Vali //////////////////////////////////////////////////







//////////////////////////// Start purchase order json ////////////////////////////////////////////////////////////
function purchase_order_json()
{
$this->layout=null;
$post_data=$this->request->data;
$this->ath();
$s_society_id=$this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');
$date=date('d-m-Y');
$time = date(' h:i a', time());


$date = $post_data['date'];
$date2 = $post_data['date2'];
$quat = $post_data['quta'];
$item = $post_data['itm'];
$unit = $post_data['unt'];
$qty = $post_data['qty'];
$desc = $post_data['desc'];
$po_issue = $post_data['poiss'];
$po_desc = $post_data['pdesc'];
$sent = $post_data['sent'];

$report = array();

if(empty($date)){
$report[]=array('label'=>'dat', 'text' => 'Please select R&Q Date');
}	

if(empty($date2)){
$report[]=array('label'=>'dat2', 'text' => 'Please select Required Date');
}	

if(empty($quat)){
$report[]=array('label'=>'qut', 'text' => 'Please Select Quatation');
}	

if(empty($item)){
$report[]=array('label'=>'itm', 'text' => 'Please Select Item');
}	

if(empty($unit)){
$report[]=array('label'=>'unt', 'text' => 'Please Select Unit of Measurement');
}	

if(empty($qty)){
$report[]=array('label'=>'qty', 'text' => 'Please Fill Price');
}	


if(empty($desc)){
$report[]=array('label'=>'des', 'text' => 'Please Fill Description');
}

if($po_issue == "undefined"){
$report[]=array('label'=>'poiss', 'text' => 'Please Select PO Issue');
}	
if($po_issue == 1)
{
if(empty($po_desc)){
$report[]=array('label'=>'pdes', 'text' => 'Please select Expense Head');
}	
}

if(empty($sent))
{
$report[]=array('label'=>'sen', 'text' => 'Please Fill Sent To');
}

$date4 = date("Y-m-d", strtotime($date));
$date4 = new MongoDate(strtotime($date4));

$this->loadmodel('financial_year');
$conditions=array("society_id" => $s_society_id);
$cursor=$this->financial_year->find('all',array('conditions'=>$conditions));
foreach($cursor as $collection)
{
$from = $collection['financial_year']['from'];
$to = $collection['financial_year']['to'];
if($from <= $date4 && $to >= $date4)
{
$abc = 55;
break;
}
else
{
$abc = 555; 
}
}

if(!empty($date))
{
if($abc == 555)
{
$report[]=array('label'=>'dat', 'text' => 'The Date is not in Open Financial Year, Please Select another Date');
}
}

if(!empty($qty))
{
if(is_numeric($qty))
{
}
else
{
$report[]=array('label'=>'qty', 'text' => 'Pleaes Fill Numeric Value');
}
}

if(sizeof($report)>0)
{
$output=json_encode(array('report_type'=>'error','report'=>$report));
die($output);
}

$date11 = date("Y-m-d", strtotime($date));
$date11 = new MongoDate(strtotime($date11));

$date12 = date("Y-m-d", strtotime($date2));
$date12 = new MongoDate(strtotime($date12));

$current_date = date('Y-m-d');
$current_date = new MongoDate(strtotime($current_date));


$this->loadmodel('purchase_order');
$order=array('purchase_order.auto_id'=> 'DESC');
$cursor=$this->purchase_order->find('all',array('order' =>$order,'limit'=>1));
foreach ($cursor as $collection) 
{
$last=$collection['purchase_order']["auto_id"]; 
}
if(empty($last))
{
$k=1000;
}	
else
{	
$k=$last;
}
$k++;
$this->loadmodel('purchase_order');
$multipleRowData = Array( Array("auto_id" => $k,"purchase_order_date" => $date11, "required_date" => $date12, "quatation_id" => $quat, "item_id" => $item, "unit_of_measurement" => $unit,"price" => $qty, "description" => $desc,"po_issue"=>$po_issue,"po_description"=>$po_desc,"society_id"=>$s_society_id,"prepaired_by"=>$s_user_id,"sent_to"=>$sent));
$this->purchase_order->saveAll($multipleRowData);   


$output=json_encode(array('report_type'=>'publish','report'=>'Purchase Order Created Successfully'));
die($output);

}
//////////////////////////// End purchase order json ////////////////////////////////////////////////////////////

///////////////////////////// Start purchase order view ///////////////////////////////////////////////////////////
function purchase_order_view()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}

$this->ath();
$this->check_user_privilages();	




}
///////////////////////////// End purchase order view ///////////////////////////////////////////////////////////

/////////////////////////////// Start Purchase Order Show Ajax //////////////////////////////////////////////////////
function purchase_order_show_ajax()
{
$this->layout='blank';
$s_role_id=$this->Session->read('role_id');
$s_society_id = $this->Session->read('society_id');
$s_user_id=$this->Session->read('user_id');

$from = $this->request->query('date1');
$to = $this->request->query('date2');
$this->set('from',$from);
$this->set('to',$to);

$this->loadmodel('purchase_order');
$conditions=array("society_id" => $s_society_id);
$cursor1 = $this->purchase_order->find('all',array('conditions'=>$conditions));
$this->set('cursor1',$cursor1);




}



/////////////////////////////// End Purchase Order Show Ajax //////////////////////////////////////////////////////
/////////////////////////////////// Start Wing Json//////////////////////////////////////////////////////////////
function wing_json()
{
$this->layout=null;
$post_data=$this->request->data;
$this->ath();
$s_society_id=$this->Session->read('hm_society_id');
$s_user_id=$this->Session->read('hm_user_id');
$date=date('d-m-Y');
$time = date(' h:i a', time());

$wing = htmlentities($post_data['wing']);
$wing=trim($wing);
$report = array();
if(empty($wing)){
$report[]=array('label'=>'win', 'text' => 'Please Fill Wing Name');
}

			$this->loadmodel('wing'); 
			$conditions=array("society_id"=>$s_society_id,"wing_name"=> new MongoRegex('/^' .  $wing . '$/i'));
			$result_wing=$this->wing->find('all',array('conditions'=>$conditions));
			
if(sizeof($result_wing)>0)
{

$output = json_encode(array('report_type'=>'already_error', 'text' => 'Wing Name is already exist .'));
        die($output);
}

			
			
if(sizeof($report)>0)
{
$output=json_encode(array('report_type'=>'error','report'=>$report));
die($output);
}


$this->loadmodel('wing');
$i=$this->autoincrement('wing','wing_id');
$this->wing->saveAll(array("wing_id" => $i,"society_id"=> $s_society_id,"wing_name"=>$wing));

$output=json_encode(array('report_type'=>'publish','report'=>'Wing Inserted Successfully'));
die($output);

}
/////////////////////////////////// End Wing Json//////////////////////////////////////////////////////////////

/////////////////////////////////// Start Save Flat Imp /////////////////////////////////////////////////////
function save_flat_imp()
{
$this->layout='blank';
$s_society_id = (int)$this->Session->read('society_id');
	
$q=$this->request->query('q'); 
$myArray = json_decode($q, true);

$c=1;
$report=array();
//$array1 = array();
foreach($myArray as $child){

$c++;
if(empty($child[0])){
$report[]=array('tr'=>$c,'td'=>1, 'text' => 'Required');
}
if(empty($child[1])){
$report[]=array('tr'=>$c,'td'=>2, 'text' => 'Required');
}

if(empty($child[2])){
$report[]=array('tr'=>$c,'td'=>3, 'text' => 'Required');
}


}
if(sizeof($report)>0){
$output=json_encode(array('report_type'=>'error','report'=>$report));
die($output);
}

$t=0;
foreach($myArray as $child)
{
$t++;
$wing_id = (int)$child[0];
$flat_num = $child[1];
$area = $child[3];


$this->loadmodel('flat');
$conditions=array("society_id" => $s_society_id);
$cursor1 = $this->flat->find('all',array('conditions'=>$conditions));
foreach($cursor1 as $collection)
{
$wing_id2 = (int)$collection['flat']['wing_id'];
$flat_name2 = $collection['flat']['flat_name'];
if($wing_id2 == $wing_id && $flat_name2 == $flat_num)
{ 
$nnn = 55;
break;
}
else
{
$nnn = 555;
}
}
if($nnn == 55)
{
$output=json_encode(array('report_type'=>'vali','text'=>'Wing and Flat Already Exist in row '.$t));
die($output);
}

if(!empty($area))
{
if(is_numeric($area))
{
}
else
{
$output=json_encode(array('report_type'=>'vali','text'=>'Flat Area Should be Numeric in row '.$t));
die($output);
}
}

}
$bbbb = "pp";
 
foreach($myArray as $child)
{
$wing_id5 = $child[0];
$flat_name = trim($child[1]);
$flat_type = (int)$child[2];
$area = (float)$child[3];
$insert = (int)$child[4];


$this->loadmodel('wing');
$conditions=array("wing_name" => $wing_id5,"society_id" => $s_society_id);
$cursor1wing = $this->wing->find('all',array('conditions'=>$conditions));
$q_wing_id=$cursor1wing[0]["wing"]["wing_id"];

$ww = 5;
$this->loadmodel('flat');
$conditions=array("society_id" => $s_society_id);
$cursor1 = $this->flat->find('all',array('conditions'=>$conditions));

foreach($cursor1 as $collection)
{
$wing_id2 = (int)$collection['flat']['wing_id'];
$flat_name2 = $collection['flat']['flat_name'];
$flat_id = (int)$collection['flat']['flat_id'];
$flat_area = (int)@$collection['flat']['flat_area'];
$flat_ttt_ppp = (int)@$collection['flat']['flat_type_id'];

if($flat_name2 == $flat_name && $q_wing_id==$wing_id2)
{ 
$wing_id5 = (int)$wing_id2;
$flat_id5 = (int)$flat_id;
$flat_tttdd = (int)$flat_ttt_ppp;
if($flat_area == 0)
{
$ww = 555;
}
}
}
if($insert == 2)
{
$mmm = 5;
$this->loadmodel('flat_type');
$condition=array('society_id'=>$s_society_id,"flat_type_id"=>$flat_type);
$cursor = $this->flat_type->find('all',array('conditions'=>$condition)); 

foreach($cursor as $collection)
{
$auto_id = (int)@$collection['flat_type']['auto_id'];
$no_of_flat = (int)@$collection['flat_type']['number_of_flat'];
$mmm = 55;
}

if($ww == 555)
{
if($mmm == 5)
{
$no_of_flat = 1;
$this->loadmodel('flat_type');
$p=$this->autoincrement('flat_type','auto_id');
$this->flat_type->saveAll(array("auto_id" => $p,"flat_type_id"=> $flat_type,"number_of_flat"=>$no_of_flat,"status"=>0,"society_id"=>$s_society_id));

$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$area,"flat_type_id"=>$flat_type),array("flat_id" => $flat_id5,"society_id"=>$s_society_id));		
}
else if($mmm == 55)
{
$no_of_flat++;
$this->loadmodel('flat_type');
$this->flat_type->updateAll(array("number_of_flat"=>$no_of_flat),array("auto_id"=>$auto_id));

$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$area,"flat_type_id"=>$flat_type),array("flat_id" => $flat_id5,"society_id"=>$s_society_id));	
}
}
else if($ww == 5)
{
if($flat_tttdd != $flat_type)
{
$ggg = 5;
$this->loadmodel('flat_type');
$condition=array('society_id'=>$s_society_id,"flat_type_id"=>$flat_tttdd);
$cursor = $this->flat_type->find('all',array('conditions'=>$condition)); 
foreach($cursor as $collection)
{
$auto_id22 = (int)@$collection['flat_type']['auto_id'];
$no_of_flat22 = (int)@$collection['flat_type']['number_of_flat'];
}
if($bbbb != $auto_id22)
{
$bbbb = (int)$auto_id22;
$auto_id2 = (int)$auto_id22;
$no_of_flat2 = (int)$no_of_flat22;
}
}
else
{
$ggg = 555;
}

$no_of_flat2 = @$no_of_flat2 - 1;
if($no_of_flat2 == 0)
{
$this->loadmodel('flat_type');
$conditions=array('flat_type.auto_id'=>$auto_id2);
$this->flat_type->deleteAll($conditions);
}
else
{
$this->loadmodel('flat_type');
$this->flat_type->updateAll(array("number_of_flat"=>@$no_of_flat2),array("auto_id"=>@$auto_id2));
}


if($mmm == 5)
{
$no_of_flat = 1;
$this->loadmodel('flat_type');
$p=$this->autoincrement('flat_type','auto_id');
$this->flat_type->saveAll(array("auto_id" => $p,"flat_type_id"=> $flat_type,"number_of_flat"=>$no_of_flat,"status"=>0,"society_id"=>$s_society_id));

$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$area,"flat_type_id"=>$flat_type),array("flat_id" => $flat_id5,"society_id"=>$s_society_id));		
}
else if($mmm == 55)
{
if($ggg == 5)
{
$no_of_flat++;
$this->loadmodel('flat_type');
$this->flat_type->updateAll(array("number_of_flat"=>$no_of_flat),array("auto_id"=>$auto_id));
}
$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$area,"flat_type_id"=>$flat_type),array("flat_id" => $flat_id5,"society_id"=>$s_society_id));	
}
}

}
}

$output=json_encode(array('report_type'=>'done','text'=>'Flat Area Should be Numeric in row '));
die($output);
}
/////////////////////////////////// End Save Flat Imp /////////////////////////////////////////////////////






///////////////start flash message////////////////////

function flash_message(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$this->loadmodel('flash');
	$conditions=array("flash_id" => 1);
	$result_cursor1=$this->flash->find('all',array('conditions'=>$conditions));
	$this->set('result_cursor1',$result_cursor1);
}

function submit_flash_message(){
	$this->layout=null;
	$title=$_POST["title"];
	$description=$_POST["description"];
	$theme=$_POST["theme"];
	$active=(int)$_POST["active"];
	 
	$this->loadmodel('flash');
	$this->flash->updateAll(array("title"=> $title,"description"=>$description,"theme"=>$theme,"active"=>$active),array("flash_id"=>1));
	echo "success";
}

function flash_output(){
	$this->layout=null;
	$this->loadmodel('flash');
	$conditions=array("flash_id" => 1);
	$result_cursor1=$this->flash->find('all',array('conditions'=>$conditions));
	$this->set('result_cursor1',$result_cursor1);
}



function set_ledger_sub_acc_users(){
			$this->layout=null;
	
	$this->loadmodel('user');
	$conditions=array("society_id" => 2);
	$result_cursor1=$this->user->find('all',array('conditions'=>$conditions));
		foreach($result_cursor1 as $data){
			$user_id = (int)$data['user']['user_id'];
			$user_name = $data['user']['user_name'];
			
			
			
			
			
		$auto_id = (int)$this->autoincrement('ledger_sub_accounts','auto_id');
		$this->loadmodel('ledger_sub_accounts');
		$this->ledger_sub_accounts->saveAll(array("auto_id" => $auto_id,"ledger_id"=> 34,"name"=>$user_name,"society_id"=>2,"user_id"=>$user_id,"deactive"=>0));
		}
		
		
		
	}

//////////////end flash mesage////////////////////////

function convert_number_to_words($number){
	

   $no = round($number);
   $point = round($number - $no, 2) * 100;
   $hundred = null;
   $digits_1 = strlen($no);
   $i = 0;
   $str = array();
   $words = array('0' => '', '1' => 'one', '2' => 'two',
    '3' => 'three', '4' => 'four', '5' => 'five', '6' => 'six',
    '7' => 'seven', '8' => 'eight', '9' => 'nine',
    '10' => 'ten', '11' => 'eleven', '12' => 'twelve',
    '13' => 'thirteen', '14' => 'fourteen',
    '15' => 'fifteen', '16' => 'sixteen', '17' => 'seventeen',
    '18' => 'eighteen', '19' =>'nineteen', '20' => 'twenty',
    '30' => 'thirty', '40' => 'forty', '50' => 'fifty',
    '60' => 'sixty', '70' => 'seventy',
    '80' => 'eighty', '90' => 'ninety');
   $digits = array('', 'hundred', 'thousand', 'lakh', 'crore');
   while ($i < $digits_1) {
     $divider = ($i == 2) ? 10 : 100;
     $number = floor($no % $divider);
     $no = floor($no / $divider);
     $i += ($divider == 10) ? 1 : 2;
     if ($number) {
        $plural = (($counter = count($str)) && $number > 9) ? 's' : null;
        $hundred = ($counter == 1 && $str[0]) ? ' and ' : null;
        $str [] = ($number < 21) ? $words[$number] .
            " " . $digits[$counter] . $plural . " " . $hundred
            :
            $words[floor($number / 10) * 10]
            . " " . $words[$number % 10] . " "
            . $digits[$counter] . $plural . " " . $hundred;
     } else $str[] = null;
  }
  $str = array_reverse($str);
  $result = implode('', $str);
  $points = ($point) ?
    "." . $words[$point / 10] . " " . 
          $words[$point = $point % 10] : '';
  return $result ;	
	
	
}

function convert_number_to_words1($number) {
            $hyphen      = '-';
            $conjunction = ' and ';
            $separator   = '  ';
            $negative    = 'negative ';
            $decimal     = ' point ';
            $dictionary  = array(
                0                   => 'zero',
                1                   => 'one',
                2                   => 'two',
                3                   => 'three',
                4                   => 'four',
                5                   => 'five',
                6                   => 'six',
                7                   => 'seven',
                8                   => 'eight',
                9                   => 'nine',
                10                  => 'ten',
                11                  => 'eleven',
                12                  => 'twelve',
                13                  => 'thirteen',
                14                  => 'fourteen',
                15                  => 'fifteen',
                16                  => 'sixteen',
                17                  => 'seventeen',
                18                  => 'eighteen',
                19                  => 'nineteen',
                20                  => 'twenty',
                30                  => 'thirty',
                40                  => 'fourty',
                50                  => 'fifty',
                60                  => 'sixty',
                70                  => 'seventy',
                80                  => 'eighty',
                90                  => 'ninety',
                100                 => 'hundred',
                1000                => 'thousand',
                100000             => 'lakh',
                1000000             => 'million',
                1000000000          => 'billion',
                1000000000000       => 'trillion',
                1000000000000000    => 'quadrillion',
                1000000000000000000 => 'quintillion'
            );
            
            if (!is_numeric($number)) {
                return false;
            }
            
            if (($number >= 0 && (int) $number < 0) || (int) $number < 0 - PHP_INT_MAX) {
                // overflow
                trigger_error(
                    'convert_number_to_words only accepts numbers between -' . PHP_INT_MAX . ' and ' . PHP_INT_MAX,
                    E_USER_WARNING
                );
                return false;
            }

            if ($number < 0) {
			
			$rupee= abs($number); 
                return $this->convert_number_to_words($rupee);
            }
            
            $string = $fraction = null;
            
            if (strpos($number, '.') !== false) {
                list($number, $fraction) = explode('.', $number);
            }
            
            switch (true) {
                case $number < 21:
                    $string = $dictionary[$number];
                    break;
                case $number < 100:
                    $tens   = ((int) ($number / 10)) * 10;
                    $units  = $number % 10;
                    $string = $dictionary[$tens];
                    if ($units) {
                        $string .= $hyphen . $dictionary[$units];
                    }
                    break;
                case $number < 1000:
                    $hundreds  = $number / 100;
                    $remainder = $number % 100;
                    $string = $dictionary[$hundreds] . ' ' . $dictionary[100];
                    if ($remainder) {
                        $string .= $conjunction . $this->convert_number_to_words($remainder);
                    }
                    break;
					
                default:
                    $baseUnit = pow(1000, floor(log($number, 1000)));
                    $numBaseUnits = (int) ($number / $baseUnit);
                    $remainder = $number % $baseUnit;
                    $string = $this->convert_number_to_words($numBaseUnits) . ' ' . $dictionary[$baseUnit];
                    if ($remainder) {
                        $string .= $remainder < 100 ? $conjunction : $separator;
                        $string .= $this->convert_number_to_words($remainder);
                    }
                    break;
					}
					if (null !== $fraction && is_numeric($fraction)) {
					$string .= $decimal;
					$words = array();
					foreach (str_split((string) $fraction) as $number) {
					$words[] = $dictionary[$number];
					}
					$string .= implode(' ', $words);
					}
					return $string;
					}
////////////////////// Start Unit Config  Excel Export ///////////////////////////////////////////////////////////
function unit_config()
{
$this->layout="";
$filename="Unit_Configuration_Import";
header ("Expires: 0");
header ("Last-Modified: " . gmdate("D,d M YH:i:s") . " GMT");
header ("Cache-Control: no-cache, must-revalidate");
header ("Pragma: no-cache");
header ("Content-type: application/vnd.ms-excel");
header ("Content-Disposition: attachment; filename=".$filename.".csv");
header ("Content-Description: Generated Report" );

$s_role_id=$this->Session->read('role_id');
$s_society_id = (int)$this->Session->read('society_id');
$s_user_id = (int)$this->Session->read('user_id');


$excel = "Wing,Flat Number,Flat Type,Flat Area (Sq. Ft.) \n";


$this->loadmodel('wing');
$conditions=array("society_id" => $s_society_id);
$result_wing = $this->wing->find('all',array('conditions'=>$conditions));
foreach($result_wing as $wing){
	$wing_id = $wing['wing']['wing_id'];
	$wing_name = $wing['wing']['wing_name'];
	
	$this->loadmodel('flat');
	$conditions=array("wing_id" => $wing_id);
	$order=array("flat.flat_name" => "ASC");
	$result_flat = $this->flat->find('all',array('conditions'=>$conditions,'order'=>$order));
	foreach($result_flat as $flat){
		$flat_name = $flat['flat']['flat_name'];
		$excel.= "$wing_name,$flat_name  \n";
	}

}
echo $excel;


}
////////////////////// End Unit Config Excel Export ///////////////////////////////////////////////////////////		
	function callback_url_google(){
		$this->layout=null;
		echo $facebook = $this->Session->read('FacebookAuthenticate');
	
	}
	
	function login_user_to_app($user_email){
		$this->layout=null;
		$this->loadmodel('login');
		$conditions=array("user_name" => $user_email);
		$result_login = $this->login->find('all',array('conditions'=>$conditions));	
		if(sizeof($result_login)==0){
			echo 0;
		}else{
			$login_id=$result_login[0]["login"]["login_id"];
			
			$this->loadmodel('user');
			 $conditions1=array('s_default'=>1,'login_id'=>$login_id,'deactive'=>0);
			 $result_user=$this->user->find('all',array('conditions'=>$conditions1));
			 $n=sizeof($result_user);
			 if($n>0)
			 {
				foreach($result_user as $data)
				{
				
				$user_id=$data['user']['user_id'];
				$society_id=$data['user']['society_id'];
				$user_name=$data['user']['user_name'];
				$wing=$data['user']['wing'];
				$tenant=$data['user']['tenant'];
				$role_id=$data['user']['default_role_id'];
				$profile=@$data['user']['profile_status'];
				}
				 
					date_default_timezone_set('Asia/kolkata');
					$date=date("d-m-Y");
					$time=date('h:i:a',time());
					$this->loadmodel('log');
					$i=$this->autoincrement('log','log_id');
					$this->log->save(array('log_id'=>$i,'user_id'=>$user_id,'society_id'=>$society_id,'date'=>$date,'time'=>$time,'status'=>0));
				    $this->Session->write('user_id', $user_id);
					$this->Session->write('login_id', $login_id);
					$this->Session->write('role_id', $role_id);
					$this->Session->write('society_id', $society_id);
					$this->Session->write('user_name', $user_name);
					$this->Session->write('wing', $wing);
					$this->Session->write('tenant', $tenant);
					echo 1;
				 
			 }
		}
	}
	
	
	
	function smtpmailer($to,$from, $from_name, $subject, $message_web,$reply, $is_gmail=true)
	{
	App::import('Vendor', 'PhpMailer', array('file' => 'phpmailer' . DS . 'class.phpmailer.php')); 

		global $error;
		
		$mail = new PHPMailer();
		$mail->IsSMTP();
		$mail->CharSet = 'UTF-8';
		$mail->SMTPAuth = true;
		$mail->SMTPSecure = 'ssl'; 
		$mail->Host = 'email-smtp.us-west-2.amazonaws.com';
		$mail->Port = 465;  
		$mail->Username = 'AKIAI7T4AF3TM3UDL2HA';  
		$mail->Password = 'AhrW2AEFouYGi1f1M3rB7tGhnsoJfr+2iU2eUuWT/hKz';
		$mail->SMTPDebug = 1; 
		$mail->From = $from;
		$HTML = true;	 
		$mail->WordWrap = 50; // set word wrap
		$mail->IsHTML($HTML);

		
		$mail->FromName= $from_name;

	$mail->Subject = $subject;
	$mail->Body = $message_web;
	if(!empty($reply))
	{
		$mail->AddReplyTo($reply ,"HousingMatters");
	}
	$mail->addAddress($to);

		if(!$mail->Send()) {
			$error = 'Mail error: '.$mail->ErrorInfo;
			return false;
		} else {
			$error = 'Message sent!';
			return true;
		}
		
	}
	
	function check_slide_show_displayed_or_not(){
		$this->layout=null;
		$s_user_id = (int)$this->Session->read('user_id');
		$this->loadmodel('user');
		$conditions=array("user_id" => $s_user_id);
		$result_user = $this->user->find('all',array('conditions'=>$conditions));
		$slide_show=(int)@$result_user[0]["user"]["slide_show"];
		if($slide_show==0){
			echo 0;
		}
		elseif($slide_show==1){
			echo 1;
		}
		elseif($slide_show==2){
			echo 2;
		}
	}
	
	function have_seen_slide_show(){
		$this->layout=null;
		$s_user_id = (int)$this->Session->read('user_id');
		$this->loadmodel('user');
		$this->user->updateAll(array('slide_show'=>1),array('user_id'=>$s_user_id));
	}
	
	function update_slide_show_me_later(){
		$this->layout=null;
		$s_user_id = (int)$this->Session->read('user_id');
		$this->loadmodel('user');
		$this->user->updateAll(array('slide_show'=>2),array('user_id'=>$s_user_id));
	}
	
	function fetch_slide_1(){
		$this->layout=null;
		$this->set("ip",$this->hms_email_ip());
		$s_user_id = (int)$this->Session->read('user_id');
		$this->loadmodel('user');
		$conditions=array("user_id" => $s_user_id);
		$result_user = $this->user->find('all',array('conditions'=>$conditions));
	}
	
	function fetch_slide_2(){
		$this->layout=null;
		$this->set("ip",$this->hms_email_ip());
		$s_user_id = (int)$this->Session->read('user_id');
		$this->loadmodel('user');
		$conditions=array("user_id" => $s_user_id);
		$result_user = $this->user->find('all',array('conditions'=>$conditions));
	}
	
	function fetch_slide_3(){
		$this->layout=null;
		$this->set("ip",$this->hms_email_ip());
		$s_user_id = (int)$this->Session->read('user_id');
		$this->loadmodel('user');
		$conditions=array("user_id" => $s_user_id);
		$result_user = $this->user->find('all',array('conditions'=>$conditions));
	}
	
	function fetch_slide_4(){
		$this->layout=null;
		$this->set("ip",$this->hms_email_ip());
		$s_user_id = (int)$this->Session->read('user_id');
		$this->loadmodel('user');
		$conditions=array("user_id" => $s_user_id);
		$result_user = $this->user->find('all',array('conditions'=>$conditions));
	}
	
	function fetch_slide_5(){
		$this->layout=null;
		$this->set("ip",$this->hms_email_ip());
		$s_user_id = (int)$this->Session->read('user_id');
		$this->loadmodel('user');
		$conditions=array("user_id" => $s_user_id);
		$result_user = $this->user->find('all',array('conditions'=>$conditions));
	}
	
	function check_session_destroy_or_not(){
		$this->layout=null;
		$s_user_id = (int)$this->Session->read('user_id');
		if(empty($s_user_id)){
			echo 0;
		}else{
			echo 1;
		}
	}

//////////////////////// Start fix_assets_add_row ///////////////////////////////////////

//End fix_assets_add_row//
//Start Resident drop down//
function resident_drop_down()
{
$s_society_id=(int)$this->Session->read('hm_society_id');
$current_date = date('Y-m-d');
$current_date2 = strtotime($current_date);
$this->loadmodel('financial_year');
$conditions=array("society_id"=>$s_society_id);
$financial_data = $this->financial_year->find('all',array('conditions'=>$conditions));
foreach($financial_data as $financial_dataaa)
{
$from = $financial_dataaa['financial_year']['from'];	
$to = $financial_dataaa['financial_year']['to'];
$from2 = date('Y-m-d',$from->sec);
$to2 = date('Y-m-d',$to->sec);	
$from3 = strtotime($from2);
$to3 = strtotime($to2);
if($current_date2 >= $from3 && $current_date2 <= $to3)
{
$financial_year_from = $from3;
$financial_year_to = $to3;
}
}
?>
<select class="m-wrap medium chosen resident_drop_down" name="resident[]">
<option value="" style="display:none;">Select Sub Ledger A/c</option>
	<?php
	$this->loadmodel('ledger_sub_account');
	$conditions=array("ledger_id" => 34,"society_id"=>$s_society_id);
	$cursor = $this->ledger_sub_account->find('all',array('conditions'=>$conditions));
    foreach($cursor as $data)
	{
	$ledger_sub_account_id = $data['ledger_sub_account']['auto_id'];
	$flat_id = $data['ledger_sub_account']['flat_id'];
	$name = $data['ledger_sub_account']['name'];
    $exit_date = $data['ledger_sub_account']['exit_date']; 
	$deactive = $data['ledger_sub_account']['deactive']; 
	$wing_detailll = $this->requestAction(array('controller' => 'hms', 'action' => 'fetch_wing_id_via_flat_id'),array('pass'=>array($flat_id)));
	foreach($wing_detailll as $wing_dataaa)
	{
	$wing_idddd = (int)$wing_dataaa['flat']['wing_id'];	
	}

$wing_flat= $this->requestAction(array('controller' => 'hms', 'action' => 'wing_flat_new'),array('pass'=>array($wing_idddd,$flat_id)));
if(($financial_year_from <= $exit_date && $financial_year_to >= $exit_date && $deactive == 1) || ($deactive == 0))
{
?>		
<option value="<?php echo $ledger_sub_account_id; ?>"><?php echo $name; ?> <?php echo $wing_flat; ?></option>
<?php }} ?>
</select>
<?php
}
//End Resident drop down//	
	
	
function menus_as_per_user_rights(){
	$this->layout=null;
	$webroot_path=$this->requestAction(array('controller' => 'Fns', 'action' => 'webroot_path'));
	$s_user_id=$this->Session->read('hm_user_id');
	$s_user_flat_id=$this->Session->read('hm_user_flat_id');
	$s_society_id=$this->Session->read('hm_society_id');
	$user_type= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_user_type_via_user_id'),array('pass'=>array($s_user_id)));
	
	if($user_type=="third_party" or $user_type=="member" or $user_type=="family_member"){
		
	$default_role= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_role_via_user_id'),array('pass'=>array($s_user_id)));
		
		$this->loadmodel('role_privilege');
		$conditions=array('society_id'=>$s_society_id,'role_id'=>$default_role);
		$main_modules=$this->role_privilege->find('all',array('conditions'=>$conditions));
		
			if(sizeof($main_modules)>0){
			foreach($main_modules as $main_module){
			$assigned_modules[]=$main_module["role_privilege"]["module_id"];
			$assigned_sub_modules[]=$main_module["role_privilege"]["sub_module_id"];
			}
			
			$assigned_modules = array_unique($assigned_modules);
			$assigned_sub_modules = array_unique($assigned_sub_modules);
			$this->loadmodel('module_type');
			$order=array("module_type.order" => "ASC");
			$module_types=$this->module_type->find('all',array('order'=>$order));
			foreach($module_types as $data){
				$module_type_id=$data["module_type"]["module_type_id"];
				$menus_array[$module_type_id]=array();
				
				$this->loadmodel('main_module');
				$conditions=array("mt_id" => $module_type_id);
				$order=array("main_module.module_name" => "ASC");
				$main_modules=$this->main_module->find('all',array('conditions'=>$conditions,'order'=>$order));
				foreach($main_modules as $data2){
				$module_id=$data2["main_module"]["auto_id"];
				if (in_array($module_id, $assigned_modules)){
				$menus_array[$module_type_id][]=array($module_id);
				}
				}
			}
			
		foreach($menus_array as $module_type_id=>$modules_data){
		if(sizeof($modules_data)>0){
		$module_type_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_module_type_info_via_module_type_id'),array('pass'=>array($module_type_id)));
		$module_type_name=$module_type_info[0]["module_type"]["module_type_name"];
		$icon=$module_type_info[0]["module_type"]["icon"];
		?>
					<li class="has-sub">
							<a href="javascript:;" class=""><i class="<?php echo $icon; ?>"></i> <?php echo $module_type_name; ?>
							<span class="arrow"></span></a>
							<ul class="sub">
					<?php
					foreach($modules_data as $data4){
						$module_id=$data4[0]; 
						$module_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_module_info_via_module_id'),array('pass'=>array($module_id)));
						$module_name=$module_info[0]["main_module"]["module_name"];
						$icon=$module_info[0]["main_module"]["icon"];
						
						$page_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_page_info_via_module_id'),array('pass'=>array($module_id,$default_role)));
						
						$controller=$page_info[0]["page"]["controller"];
						$page_name=$page_info[0]["page"]["page_name"];
						?>
								<li><a class="" rel='tab' role="button" href="<?php echo $webroot_path.$controller.'/'.$page_name; ?>"><i class="<?php echo $icon; ?>"></i> <?php echo $module_name; ?></a></li>
					<?php }	?>
							</ul>
					</li>
					<?php
				}
			}?>
			<li>
				<a href="<?php echo $webroot_path; ?>Hms/feedback" rel='tab'>
				<i class="icon-phone"></i> Feedback
				</a>					
			</li>
			
			<!--<li>
				<a href="<?php echo $webroot_path; ?>Hms/bank_reconciliation" rel='tab'>
				<i class="icon-phone"></i> Bank Reconciliation
				</a>					
			</li>-->
			
			<?php
		
		}else{
			echo '<li style="color:#FFF; padding: 5px;">There is no any module assigned to you.</li>';
		}
		
	}
	if($user_type=="hm"){
		?>
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/hm_assign_module">
			<i class="icon-home"></i> Assign Modules
			</a>					
		</li>

		<li>
			<a href="<?php echo $webroot_path; ?>Hms/new_society_enrollment">
			<i class="icon-home"></i> New Enrollment
			</a>					
		</li>
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/society_approve">
			<i class="icon-home"></i> Approve Society
			</a>					
		</li>

		<li>
			<a href="<?php echo $webroot_path; ?>Hms/feedback_view">
			<i class="icon-home"></i> Feedback
			</a>					
		</li>	

		<li>
			<a href="<?php echo $webroot_path; ?>Hms/hm_society_member_view">
			<i class="icon-home"></i> Society View
			</a>					
		</li>	
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/master_accounts_category_hm">
			<i class="icon-home"></i>Charts Of Account
			</a>					
		</li>
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/update_default_package">
			<i class="icon-home"></i>Package of modules
			</a>					
		</li>
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/create_login">
			<i class="icon-home"></i>Logins
			</a>					
		</li>
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/multi_society_enrollment">
			<i class="icon-home"></i>Register more society
			</a>					
		</li>
		<li>
			<a href="<?php echo $webroot_path; ?>app/webroot/backup_db.php">
			<i class="icon-home"></i>Backup
			</a>					
		</li>
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/trial_balance_report_society_wise">
			<i class="icon-home"></i> Trial Balance Report
			</a>					
		</li>
		
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/hm_sms_allow_society">
			<i class="icon-home"></i> Sms allow society
			</a>					
		</li>
		<li>
			<a href="<?php echo $webroot_path; ?>Hms/member_search">
			<i class="icon-home"></i> Member Search
			</a>					
		</li>
		<?php
	}
	if($user_type=="hm_child")
	{
	$default_role= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_role_via_user_id_hm'),array('pass'=>array($s_user_id)));	
	
		$this->loadmodel('role_privilege_hm');
		$conditions=array('role_id'=>(int)$default_role);
		$main_modules=$this->role_privilege_hm->find('all',array('conditions'=>$conditions));
		if(sizeof($main_modules)>0){
		foreach($main_modules as $main_module){
		$assigned_modules[]=$main_module["role_privilege_hm"]["module_id"];
		$assigned_sub_modules[]=$main_module["role_privilege_hm"]["sub_module_id"];
		}
			
		$assigned_modules = array_unique($assigned_modules);
		$assigned_sub_modules = array_unique($assigned_sub_modules);

		$this->loadmodel('module_type');
		$order=array("module_type.order" => "ASC");
		$module_types=$this->module_type->find('all',array('order'=>$order));
		foreach($module_types as $data){
		$module_type_id=$data["module_type"]["module_type_id"];
		$menus_array[$module_type_id]=array();
				
				$this->loadmodel('main_module');
				$conditions=array("mt_id" => $module_type_id);
				$order=array("main_module.module_name" => "ASC");
				$main_modules=$this->main_module->find('all',array('conditions'=>$conditions,'order'=>$order));
				foreach($main_modules as $data2){
				$module_id=$data2["main_module"]["auto_id"];
				if (in_array($module_id, $assigned_modules)){
				$menus_array[$module_type_id][]=array($module_id);
				}
				}
		}
			
		foreach($menus_array as $module_type_id=>$modules_data){
		if(sizeof($modules_data)>0){
		$module_type_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_module_type_info_via_module_type_id'),array('pass'=>array($module_type_id)));
		$module_type_name=$module_type_info[0]["module_type"]["module_type_name"];
		$icon=$module_type_info[0]["module_type"]["icon"];
		?>
			<li class="has-sub">
			<a href="javascript:;" class=""><i class="<?php echo $icon; ?>"></i> <?php echo $module_type_name; ?>
			<span class="arrow"></span></a>
			<ul class="sub">
		<?php
		foreach($modules_data as $data4){
		$module_id=$data4[0]; 
		$module_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_module_info_via_module_id'),array('pass'=>array($module_id)));
		$module_name=$module_info[0]["main_module"]["module_name"];
		$icon=$module_info[0]["main_module"]["icon"];
						
	$page_info= $this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_page_info_via_module_id_for_hm'),array('pass'=>array($module_id)));
	$controller=$page_info[0]["page"]["controller"];
	$page_name=$page_info[0]["page"]["page_name"];
		
		?>
		<li><a class="" rel='tab' role="button" href="<?php echo $webroot_path.$controller.'/'.$page_name; ?>"><i class="<?php echo $icon; ?>"></i> <?php echo $module_name; ?></a></li>
		
		<?php }	?>
			</ul>
			</li>
	<?php
		    }
			}
		}
	}
}

function assign_default_modules_to_society($society_id=null){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	$society_id=(int)$society_id;
	
	$this->loadmodel('hm_modules_assign');
	$conditions=array("society_id" => $society_id);
	$this->hm_modules_assign->deleteAll($conditions);
		
	$this->loadmodel('main_module');
	$conditions=array('society'=>"yes");
	$main_modules=$this->main_module->find('all',array('conditions'=>$conditions));
	foreach($main_modules as $module_data){
		$module_id=$module_data["main_module"]["auto_id"];
		
		$this->loadmodel('hm_modules_assign');
		$auto_id=$this->autoincrement('hm_modules_assign','auto_id');
		$this->hm_modules_assign->saveAll(array("auto_id" => $auto_id, "module_id" => $module_id , "society_id" => $society_id));
	}
	
	$this->loadmodel('sub_module');
	$sub_modules=$this->sub_module->find('all');
	foreach($sub_modules as $sub_module_data){
		$module_id=$sub_module_data["sub_module"]["module_id"];
		$sub_module_id=$sub_module_data["sub_module"]["auto_id"];
		$admin=@$sub_module_data["sub_module"]["admin"];
		$owner=@$sub_module_data["sub_module"]["owner"];
		$tenant=@$sub_module_data["sub_module"]["tenant"];
		$owner_family=@$sub_module_data["sub_module"]["owner_family"];
		$tenant_family=@$sub_module_data["sub_module"]["tenant_family"];
		if($admin=="yes"){
			$this->loadmodel('role_privileges');
			$auto_id=$this->autoincrement('role_privileges','auto_id');
			$this->role_privileges->saveAll(array("auto_id" => $auto_id, "society_id" => $society_id , "role_id" => 1,"module_id" => $module_id,"sub_module_id" => $sub_module_id));
		}
		if($owner=="yes"){
			$this->loadmodel('role_privileges');
			$auto_id=$this->autoincrement('role_privileges','auto_id');
			$this->role_privileges->saveAll(array("auto_id" => $auto_id, "society_id" => $society_id , "role_id" => 3,"module_id" => $module_id,"sub_module_id" => $sub_module_id));
		}
		if($tenant=="yes"){
			$this->loadmodel('role_privileges');
			$auto_id=$this->autoincrement('role_privileges','auto_id');
			$this->role_privileges->saveAll(array("auto_id" => $auto_id, "society_id" => $society_id , "role_id" => 4,"module_id" => $module_id,"sub_module_id" => $sub_module_id));
		}
		if($owner_family=="yes"){
			$this->loadmodel('role_privileges');
			$auto_id=$this->autoincrement('role_privileges','auto_id');
			$this->role_privileges->saveAll(array("auto_id" => $auto_id, "society_id" => $society_id , "role_id" => 5,"module_id" => $module_id,"sub_module_id" => $sub_module_id));
		}
		if($tenant_family=="yes"){
			$this->loadmodel('role_privileges');
			$auto_id=$this->autoincrement('role_privileges','auto_id');
			$this->role_privileges->saveAll(array("auto_id" => $auto_id, "society_id" => $society_id , "role_id" => 6,"module_id" => $module_id,"sub_module_id" => $sub_module_id));
		}
	}
}

function update_default_package(){
	if($this->RequestHandler->isAjax()){
		$this->layout='blank';
	}else{
		$this->layout='session';
	}
	$this->ath();
	
	$this->loadmodel('main_module');
	$order=array('main_module.module_name'=>'ASC');
	$main_modules=$this->main_module->find('all', array('order' => $order));
	$this->set("main_modules",$main_modules);
	 
}

function sub_module_list_table($module_id=null){
	$this->ath();
	$this->set(compact("module_id"));
	
	$this->loadmodel('main_module');
	$conditions=array('auto_id'=>(int)$module_id);
	$main_modules=$this->main_module->find('all', array('conditions' => $conditions));
	$society=@$main_modules[0]["main_module"]["society"];
	$this->set(compact("society"));
}

function update_default_module_by_hm_ajax($module_id,$status){
	$this->layout=null;
	$this->loadmodel('main_module');
	$this->main_module->updateAll(array('society'=>$status),array('main_module.auto_id'=>(int)$module_id));
	
	if($status=="no"){
		$this->loadmodel('sub_module');
		$conditions=array('module_id'=>(int)$module_id);
		$this->sub_module->updateAll(array('admin'=>"no",'owner'=>"no",'tenant'=>"no",'owner_family'=>"no",'tenant_family'=>"no"),array('sub_module.module_id'=>(int)$module_id));
	}
}

function update_default_sub_module_by_hm_ajax($sub_module_id,$role,$status){
	$this->layout=null;
	
	$sub_module_ids = explode(",", $sub_module_id);
	
	foreach($sub_module_ids as $sub_module_id){
		if($role=="admin"){
			$this->loadmodel('sub_module');
			$this->sub_module->updateAll(array('admin'=>$status),array('sub_module.auto_id'=>(int)$sub_module_id));
		}elseif($role=="owner"){
			$this->loadmodel('sub_module');
			$this->sub_module->updateAll(array('owner'=>$status),array('sub_module.auto_id'=>(int)$sub_module_id));
		}
		elseif($role=="tenant"){
			$this->loadmodel('sub_module');
			$this->sub_module->updateAll(array('tenant'=>$status),array('sub_module.auto_id'=>(int)$sub_module_id));
		}
		elseif($role=="owner_family"){
			$this->loadmodel('sub_module');
			$this->sub_module->updateAll(array('owner_family'=>$status),array('sub_module.auto_id'=>(int)$sub_module_id));
		}
		elseif($role=="tenant_family"){
			$this->loadmodel('sub_module');
			$this->sub_module->updateAll(array('tenant_family'=>$status),array('sub_module.auto_id'=>(int)$sub_module_id));
		}
	}
	
	
}

function login_third_party(){
	if($this->RequestHandler->isAjax()){
			$this->layout='blank';
		}else{
			$this->layout='session';
		}	
	
		$this->ath();
		$s_society_id = $this->Session->read('hm_society_id');
		$s_user_id=$this->Session->read('hm_user_id');	
		 date_default_timezone_set('Asia/kolkata');
		$date=date("d-m-Y");
		$time=date('h:i:a',time());
		if(isset($this->request->data['sub'])){
			
				$name = $this->request->data['name'];
				$title = $this->request->data['title']; 
				$email = @$this->request->data['email'];
				$mobile = @$this->request->data['mobile'];
				$password = $this->request->data['password'];

				$this->loadmodel('user');
				$i=$this->autoincrement('user','user_id');
				$this->user->saveAll(array('user_id' => $i, 'user_name' => $name,'email'=>$email,'mobile'=>$mobile,'society_id' =>$s_society_id,'signup_random'=>"",'active'=>'yes',"user_type"=>"third_party","password"=>$password,'date' => $date, 'time' => $time,'profile_pic'=>'blank.jpg','created_by'=>$s_user_id,'degination_title'=>$title));

				$this->loadmodel('user_flat');
				$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
				$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>$s_society_id,'exited'=>'no'));
				
	}
		$this->loadmodel('user');
		$conditions=array('active'=>'yes',"user_type"=>"third_party","society_id"=>$s_society_id);
		$result_user=$this->user->find('all',array('conditions'=>$conditions));
		$this->set('result_user',$result_user);
}




//Start create_login//
function create_login()
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$this->ath();
	$s_society_id = $this->Session->read('hm_society_id');
	$s_user_id=$this->Session->read('user_id');	

if(isset($this->request->data['sub'])){
$name = $this->request->data['name'];
$email = @$this->request->data['email'];
$mobile = @$this->request->data['mobile'];
$password = $this->request->data['password'];


$this->loadmodel('user');
$i=$this->autoincrement('user','user_id');
$this->user->saveAll(array('user_id' => $i, 'user_name' => $name,'email'=>$email,'mobile'=>$mobile,'society_id' =>null,'signup_random'=>"",'active'=>'yes',"user_type"=>"hm_child","password"=>$password,'profile_pic'=>'blank.jpg'));

$this->loadmodel('user_flat');
$user_flat_id=$this->autoincrement('user_flat','user_flat_id');
$this->user_flat->saveAll(array('user_flat_id'=>$user_flat_id,'user_id'=>$i,'society_id'=>null,'exited'=>'no'));
}

	$this->loadmodel('user');
	$conditions=array('active'=>'yes',"user_type"=>"hm_child");
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	$this->set('result_user',$result_user);
	
}
//End create_login//
//Start hm_create_role//
function hm_create_role()
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
		$this->ath();
		$s_society_id = (int)$this->Session->read('hm_society_id');
		$s_user_id=(int)$this->Session->read('user_id');		
	

if(isset($this->request->data['sub']))
{
$role_name = $this->request->data['role'];

$this->loadmodel('hms_role');
$i=$this->autoincrement('hms_role','auto_id');
$this->hms_role->saveAll(array('auto_id'=>$i,'role_name'=>$role_name));
}

$this->loadmodel('hms_role');
$result_hms_role=$this->hms_role->find('all');
$this->set('result_hms_role',$result_hms_role);

}
////////////////// End hm_create_role //////////////////////////////////////	
////////////////// Start assign_module_to_role_hm /////////////////////////
function assign_module_to_role_hm()
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
	$this->ath();
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id=(int)$this->Session->read('user_id');

	
if(isset($this->request->data['add_role'])) 
{
$role_id=(int)$this->request->data['role_name'];	


$this->loadmodel('main_module');
$result_main_modules=$this->main_module->find('all');
foreach($result_main_modules as $dataa)
{
$module_id = (int)$dataa['main_module']['auto_id'];
	
$this->loadmodel('sub_modules');
$conditions=array("module_id" => $module_id);
$result_sub_modules=$this->sub_modules->find('all',array('conditions'=>$conditions));
foreach($result_sub_modules as $data)
{
$sub_module_id=(int)$data["sub_modules"]["auto_id"];
$sub_module_name=$data["sub_modules"]["sub_module_name"];

$check_box=@$this->request->data['ch'.$sub_module_id];

if($check_box>0)
{
$this->loadmodel('role_privilege_hm');
$conditions=array("role_id"=>$role_id,"sub_module_id"=>$sub_module_id,"module_id" => $module_id);
$n=$this->role_privilege_hm->find('count',array('conditions'=>$conditions));

if($n==0)
{
$this->loadmodel('role_privilege_hm');
$data_row = Array( Array("role_id" =>$role_id,"module_id" =>$module_id,"sub_module_id" => $sub_module_id));
$this->role_privilege_hm->saveAll($data_row); 
}
}
else
{
$this->loadmodel('role_privilege_hm');
$conditions=array("role_id" => $role_id,"sub_module_id"=>$sub_module_id);
$n=$this->role_privilege_hm->deleteall($conditions);
}
}	
}	
}	
	
$this->loadmodel('hms_role');
$result_hms_role=$this->hms_role->find('all');
$this->set('result_hms_role',$result_hms_role);
}
//////////////////// End assign_module_to_role_hm //////////////////////////
////////////////////// Start assign_modules_to_role_ajax_hm ////////////////////
function assign_modules_to_role_ajax_hm()
{
$this->layout='blank';
$this->ath();

$s_society_id=$this->Session->read('society_id');
$s_role_id=$this->Session->read('role_id');	

$this->loadmodel('module_type');
$order=array('module_type.module_type_name'=>'ASC');		
$this->set('result_module_type',$this->module_type->find('all',array('order'=>$order)));
	
}
//End assign_modules_to_role_ajax_hm //
//Start asign_role_to_user//
function asign_role_to_user($user_id=null)
{
if($this->RequestHandler->isAjax()){
$this->layout='blank';
}else{
$this->layout='session';
}
	$this->ath();
	$s_society_id = (int)$this->Session->read('hm_society_id');
	$s_user_id=(int)$this->Session->read('user_id');	
	$user_id_via_query=(int)$user_id;
	$this->set('user_id_via_query',$user_id_via_query);
if(isset($this->request->data['sub']))
{
$user_id = (int)$this->request->data['user_id_name'];
$society_id = (int)$this->request->data['society'];
$role_id = (int)$this->request->data['role'];

$this->loadmodel('hms_rights');
$conditions=array("user_id"=>$user_id);
$n=$this->hms_rights->find('count',array('conditions'=>$conditions));

	if($n>0){
		$this->loadmodel('hms_rights');
		$auto_id=$this->autoincrement('hms_rights','auto_id');
		$data_row=Array(Array("auto_id"=>$auto_id,"user_id"=>$user_id,"society_id"=>$society_id,'role_id'=>$role_id));
		$this->hms_rights->saveAll($data_row);	
	}
	else
	{
		$this->loadmodel('hms_rights');
		$auto_id=$this->autoincrement('hms_rights','auto_id');
		$data_row=Array(Array("auto_id"=>$auto_id,"user_id"=>$user_id,"society_id"=>$society_id,'role_id'=>$role_id,"default"=>"yes"));
		$this->hms_rights->saveAll($data_row);	
	}
}

$this->loadmodel('hms_right');
$conditions=array("user_id"=>$user_id_via_query);
$hms_rights_result=$this->hms_right->find('all',array('conditions'=>$conditions));
$this->set('hms_rights_result',$hms_rights_result);
	
$this->loadmodel('society');
$result_society=$this->society->find('all',array('conditions'=>array('aprvl_status'=>1)));
$this->set('result_society',$result_society);

$this->loadmodel('hms_role');
$result_hm_role=$this->hms_role->find('all');
$this->set('result_hm_role',$result_hm_role);


$this->loadmodel('user');
$conditions=array("user_type" => "hm_child");
$result_user=$this->user->find('all',array('conditions'=>$conditions));
$this->set('result_user',$result_user);
}
//End asign_role_to_user//
//Start auto_save_unit_config//
function auto_save_unit_config($record_id=null,$field=null,$value=null)
{
$this->layout=null;

$this->ath();
$s_society_id = $this->Session->read('society_id');
$record_id=(int)$record_id;	
	
if($field=="flat_type"){
	
$this->loadmodel('flat');
$this->flat->updateAll(array("flat_type_id"=>(int)$value),array("flat_id" => $record_id));




}
		
if($field=="flat_area"){
$this->loadmodel('flat');
$this->flat->updateAll(array("flat_area"=>$value),array("flat_id" => $record_id));

}	
echo "F";	
}
////////////////////// End auto_save_unit_config ///////////////////////////////
function exit_user($user_flat_id=null){
	
	$s_user_id=(int)$this->Session->read('hm_user_id');
	$s_society_id=(int)$this->Session->read('hm_society_id');
	$this->loadmodel('user_flat');
	$conditions=array('user_flat_id'=>(int)$user_flat_id);
	$user_flat_info=$this->user_flat->find('all',array('conditions'=>$conditions));
	$user_id=$user_flat_info[0]["user_flat"]["user_id"];
	$owner=$user_flat_info[0]["user_flat"]["owner"];
	
	$this->loadmodel('user');
	$conditions=array('user_id'=>(int)$user_id);
	$user_info=$this->user->find('all',array('conditions'=>$conditions));
	$user_type=$user_info[0]["user"]["user_type"];
	$net_bal=0;
	if($user_type=="member" and $owner=="yes"){
		$this->loadmodel('ledger_sub_account');
		$conditions=array('user_flat_id'=>(int)$user_flat_id);
		$ledger_sub_account_info=$this->ledger_sub_account->find('all',array('conditions'=>$conditions));
		$ledger_sub_account_id=$ledger_sub_account_info[0]["ledger_sub_account"]["auto_id"];
		
		$this->loadmodel('user_flat');
		$conditions=array('user_flat_id'=>(int)$user_flat_id);
		$user_flat_info=$this->user_flat->find('all',array('conditions'=>$conditions));
		$wing=$user_flat_info[0]["user_flat"]["wing"];
		$flat=(int)$user_flat_info[0]["user_flat"]["flat"];
		$user_id=(int)$user_flat_info[0]["user_flat"]["user_id"];
		$this->loadmodel('flat');
		$this->flat->updateAll(array('noc_ch_tp'=>null),array("society_id" => (int)$s_society_id,"flat_id"=>$flat));
		
		
		
		
		$this->loadmodel('ledger');
		$conditions=array('ledger_sub_account_id'=>$ledger_sub_account_id);
		$ledger_info=$this->ledger->find('all',array('conditions'=>$conditions));
		$total_dr=0; $total_cr=0; 
		foreach($ledger_info as $ledger){
			$total_dr+=$ledger["ledger"]["debit"];
			$total_cr+=$ledger["ledger"]["credit"];
		}
		$net_bal=$total_dr-$total_cr;
	}
	

	if($net_bal==0){
		
				date_default_timezone_set('Asia/Kolkata');	
				$date=date("d-m-Y");
				$time=date('h:i:a',time());
		
		$this->loadmodel('user_flat');
		$this->user_flat->updateAll(array('exited'=>"yes",'exited_date'=>$date,'exited_time'=>$time,'exited_by_user'=>$s_user_id),array('user_flat.user_flat_id'=>(int)$user_flat_id));
		
		$this->loadmodel('ledger_sub_account');
		$this->ledger_sub_account->updateAll(array('exited'=>"yes"),array('ledger_sub_account.user_flat_id'=>(int)$user_flat_id));
		
		$this->loadmodel('user_flat');
		$conditions=array('user_id'=>$user_id,'exited'=>"no");
		$count=$this->user_flat->find('count',array('conditions'=>$conditions));
		if($count==0){
			$this->loadmodel('user');
			$this->user->updateAll(array('active'=>"no"),array('user.user_id'=>$user_id));
			
			$this->loadmodel('user');
			$conditions=array('family_main_member'=>(int)$user_id,"is_family_member"=>"yes");
			$user_family=$this->user->find('all',array('conditions'=>$conditions));
			foreach($user_family as $family_mem){
				$user_id=$family_mem["user"]["user_id"];
				
				$this->loadmodel('user');
				$this->user->updateAll(array('active'=>"no"),array('user.user_id'=>$user_id));
				
				$this->loadmodel('user_flat');
				$this->user_flat->updateAll(array('exited'=>"yes"),array('user_flat.user_id'=>$user_id));
			}
		}
		echo '<div class="modal-backdrop fade in"></div>
		<div style="display: block;" class="modal hide fade in">
			<div class="modal-body">
				<p>User exited successfully.</p>
			</div>
			<div class="modal-footer">
				<button class="btn blue" id="close" user_flat_id='.$user_flat_id.' exited="yes">OK</button>
			</div>
		</div>';
	}else{
		echo '<div class="modal-backdrop fade in"></div>
		<div style="display: block;" class="modal hide fade in">
			<div class="modal-body">
				<p>User can not exit because of due -'.$net_bal.'</p>
			</div>
			<div class="modal-footer">
				<button class="btn blue" id="close" user_flat_id='.$user_flat_id.' exited="no">OK</button>
			</div>
		</div>';
	}
	
}


///// Group Start

function groups_new()
{
if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
$this->ath();
$this->check_user_privilages();
$s_user_id=$this->Session->read('hm_user_id'); 
$s_society_id=$this->Session->read('hm_society_id'); 
$current_date=date("d-m-Y");
if (isset($this->request->data['add'])) 
{
	$group_name=$this->request->data['group_name'];

	$this->loadmodel('group');
	$conditions=array("society_id"=>$s_society_id,"group_name"=>$group_name);
	$group_duplicate=$this->group->find('count',array('conditions'=>$conditions));

	
	if(!empty($group_name) and ($group_duplicate==0))
	{
		$group_id=$this->autoincrement('group','group_id');
		$this->loadmodel('group');
		$multipleRowData = Array( Array("group_id" => $group_id,"delete_id"=>0,"group_name"=>$group_name,"society_id"=>$s_society_id,"users"=>array(),'update_by'=>$s_user_id,'update_on'=>$current_date));
		$this->group->saveAll($multipleRowData); 
		$this->response->header('Location', 'groupview/'.$group_id);
		
		$this->Session->write('group_status', 1);
	}
	else{
		$this->set('error_addgroup','Group name should not be duplicate.');
	}
}

$this->loadmodel('group');
$conditions=array("society_id"=>$s_society_id,'delete_id'=>0);
$order=array('group.group_id'=>'DESC');
$this->set('result_group',$this->group->find('all',array('conditions'=>$conditions,'order'=>$order))); 
}


function groupview($gid=null) 
{
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	
	$this->ath();
	//$this->check_user_privilages();
	$s_user_id=$this->Session->read('hm_user_id'); 
	$s_society_id=$this->Session->read('hm_society_id'); 
	$gid=(int)$gid;
	$this->set('gid',$gid);
	$group_name=$this->fetch_group_name_from_gruop_id($gid);
	$this->set('group_name',$group_name);
	
	if (isset($this->request->data['update_members'])) 
	{
		$this->loadmodel('user');
		$conditions=array("society_id"=>$s_society_id,"active"=>"yes");
		$order=array('user.user_name'=> 'ASC');
		$all_users=$this->user->find('all',array('conditions'=>$conditions,'order'=>$order));
		
		$members=array();
		foreach($all_users as $user)
		{
		
			$value=@$this->request->data['user'.$user['user']['user_id']];
			if(!empty($value)) { $members[]=$user['user']['user_id']; }
		}
		
		$this->loadmodel('group');
		$this->group->updateAll(array("users" =>$members),array("group_id" => $gid));
	}
	
	$this->loadmodel('group');
	$conditions=array("group_id" => $gid);
	$result_group_info=$this->group->find('all',array('conditions'=>$conditions));
	
	$result_group_info=$result_group_info[0]['group']['users'];
	/*$this->loadmodel('user');
	$conditions=array("society_id"=>$s_society_id,"active"=>"yes");
	$order=array('user.user_name'=> 'ASC');
	$users=$this->user->find('all',array('conditions'=>$conditions,'order'=>$order));*/
	 
	$this->set('result_group_info',$result_group_info);
	
	
	// asending order wing  wise 
	
		$this->loadmodel('wing');
		$condition=array('society_id'=>$s_society_id);
		$order=array('wing.wing_name'=>'ASC');
		$result_wing=$this->wing->find('all',array('conditions'=>$condition,'order'=>$order));
		foreach($result_wing as $data){
			$wing_id = (int)$data['wing']['wing_id'];	
			$wing_name = $data['wing']['wing_name'];
			$this->loadmodel('flat');
			$conditions=array("wing_id" => $wing_id,'society_id'=>$s_society_id);
			$order=array('flat.flat_name'=> 'ASC');
			$result5= $this->flat->find('all',array('conditions'=>$conditions,'order' =>$order));
			
			foreach($result5 as $data){
					@$flat_name=ltrim(@$data["flat"]["flat_name"],'0');
					$flat_id=(int)@$data["flat"]["flat_id"];
					$flats=$wing_name.'-'.$flat_name;
					$this->loadmodel('user_flat');
					$conditions=array('society_id'=>$s_society_id,'flat'=>$flat_id,'exited'=>'no');
					$result_user_flat= $this->user_flat->find('all',array('conditions'=>$conditions));
					$user_id=(int)@$result_user_flat[0]['user_flat']['user_id'];
					$result_user = $this->requestAction(array('controller' => 'Fns', 'action' => 'user_info_via_user_id'),array('pass'=>array($user_id)));
					$user_name=@$result_user[0]['user']['user_name'];
					$profile_pic=@$result_user[0]['user']['profile_pic'];
					
					$resulr_member[]=array("user_name"=>$user_name,"wing_flat"=>$flats,"user_id"=>$user_id,"profile_pic"=>$profile_pic);
		  }
		}
	$this->set('all_users',$resulr_member);
	
}

function group_delete(){
	
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$id=$this->request->query('con'); 
	$this->ath();
	$s_user_id=$this->Session->read('hm_user_id'); 
	$s_society_id=$this->Session->read('hm_society_id'); 
	$this->loadmodel('group');
	$this->group->updateAll(array('delete_id'=>1),array("group_id" => (int)$id));
	$this->response->header('Location', 'groups_new');
	
}

function fetch_group_name_from_gruop_id($group_id)
{


$this->loadmodel('group');
$conditions=array("group_id" => $group_id);
$result_group_name=$this->group->find('all',array('conditions'=>$conditions));

foreach ($result_group_name as $collection) 
{
return $group_name=$collection['group']['group_name'];
}
}

//End group//
//Start user_enrolment_validation_with_table//
function user_enrolment_validation_with_table($email=null)
{
	$s_society_id=$this->Session->read('hm_society_id');
	$result="not_match";
		$this->loadmodel('user');
		$result_user=$this->user->find('all');
		foreach($result_user as $data){
				$email_id=$data['user']['email'];
                  if($email_id==$email){
					$result="match";
					break;					
				  }					  
		}
		
	$email_array=array();
	$this->loadmodel('user_enrollment_csv_converted'); 
	$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
	$conditions=array("society_id"=>(int)$s_society_id);
	$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'order'=>$order));
	 foreach($user_enrollment_csv_converted as $data){
		$email_idd=$data['user_enrollment_csv_converted']['email']; 
		if($email_idd==""){
		}else{
		$email_array[]=$email_idd;	
		}
	 }	
		$n=0;
		for($k=0; $k<sizeof($email_array); $k++){
		$email_from_array=$email_array[$k];
			if($email_from_array==$email){
				$n++;
			}
			
		}	
  if($n>1){
	 $result="match_overlap"; 
  }		
		
		
		
		
		
		
echo $result;	
}
//End user_enrolment_validation_with_table//
//Start mobile_validation_with_table// 
function mobile_validation_with_table($mobile=null)
{
	 $s_society_id=$this->Session->read('hm_society_id');
$result="not_match";
		$this->loadmodel('user');
		$result_user=$this->user->find('all');
		foreach($result_user as $data){
				$mobile_number=$data['user']['mobile'];
                  if($mobile_number==$mobile){
					$result="match";
					break;					
				  }					  
		}
		
	$mobile_array=array();
	$this->loadmodel('user_enrollment_csv_converted'); 
	$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
	$conditions=array("society_id"=>(int)$s_society_id);
	$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'order'=>$order));
	 foreach($user_enrollment_csv_converted as $data){
		$mobile_no=$data['user_enrollment_csv_converted']['mobile']; 
		if($mobile_no==""){
		}else{
		$mobile_array[]=$mobile_no;	
		}
	 }	
		$n=0;
		for($k=0; $k<sizeof($mobile_array); $k++){
		$mobil_from_array=$mobile_array[$k];
			if($mobil_from_array==$mobile){
				$n++;
			}
			
		}	
  if($n>1){
	 $result="match_overlap"; 
  }

		 if(is_numeric($mobile)){ 
		 } 
         else{
			 $result="not_numeric";  
		 }       
		
echo $result;	
}
//End mobile_validation_with_table//
//Start email_overlap_validation//
function email_overlap_validation($email=null)
{
    $s_society_id = $this->Session->read('hm_society_id');
    $email_array=array();
	$result="not_match";
	$this->loadmodel('user_enrollment_csv_converted'); 
	$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
	$conditions=array("society_id"=>(int)$s_society_id);
	$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'order'=>$order));
	 foreach($user_enrollment_csv_converted as $data){
		$email_id=$data['user_enrollment_csv_converted']['email']; 
		if($email_id==""){
		}else{
		$email_array[]=$email_id;	
		}
	 }	
		$n=0;
		for($k=0; $k<sizeof($email_array); $k++){
		$email_from_array=$email_array[$k];
			if($email_from_array==$email){
				$n++;
			}
			
		}	
  if($n>1){
	 $result="match"; 
  }	
echo $result;
	
}
//End email_overlap_validation//
//Start mobile_overlap_validation//
function mobile_overlap_validation($mobile=null)
{
 $s_society_id = $this->Session->read('hm_society_id');
    $mobile_array=array();
	$result="not_match";
	$this->loadmodel('user_enrollment_csv_converted'); 
	$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
	$conditions=array("society_id"=>(int)$s_society_id);
	$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'order'=>$order));
	 foreach($user_enrollment_csv_converted as $data){
		$mobile_no=$data['user_enrollment_csv_converted']['mobile']; 
		if($mobile_no==""){
		}else{
		$mobile_array[]=$mobile_no;	
		}
	 }	
		$n=0;
		for($k=0; $k<sizeof($mobile_array); $k++){
		$mobil_from_array=$mobile_array[$k];
			if($mobil_from_array==$mobile){
				$n++;
			}
			
		}	
  if($n>1){
	 $result="match"; 
  }	
echo $result;	
}
//End mobile_overlap_validation//
//Start wing_flat_validation//
function wing_flat_validation($wing_flat=null,$owner_type=null)
{
 $result="not_match";
 $s_society_id = $this->Session->read('hm_society_id');	
 $wing_flat_explode=explode(',',$wing_flat);
 $wing=(int)$wing_flat_explode[0];
 $flat=(int)$wing_flat_explode[1];
  
		$this->loadmodel('flat');
		$conditions=array("flat_id"=>$flat);
		$result_flat=$this->flat->find('all',array('conditions'=>$conditions));
			foreach($result_flat as $dataa){
				$flat_type=(int)$dataa['flat']['noc_ch_tp'];	
			}
			if($flat_type == 1){
				if($owner_type=='no'){
				$result="self_occupied";	//only owner can take this flat
				}
		}
		$this->loadmodel('user_flat');
		$conditions=array("flat"=>$flat,"owner"=>array('$ne'=>null),"exited"=>"no");
		$result_user_flat=$this->user_flat->find('all',array('conditions'=>$conditions));
		
		 $n4 = sizeof($result_user_flat); 
		if($n4==1){
			$tenant=$result_user_flat[0]['user_flat']['owner'];
			if($tenant=='yes'){
				if($tenant==$owner_type){
				 $result="owner_already";	
			}
			}else{
				if($tenant==$owner_type){
                 $result="tenant_already";
				}
			}
		}
        if($n4==2)
		{
		  $result="already_exist";	
		}
		
	$wing_flat_array=array();
	$this->loadmodel('user_enrollment_csv_converted'); 
	$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
	$conditions=array("society_id"=>(int)$s_society_id);
	$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'order'=>$order));
	 foreach($user_enrollment_csv_converted as $data){
		$wingg=(int)$data['user_enrollment_csv_converted']['wing']; 
		$flatt=(int)$data['user_enrollment_csv_converted']['flat']; 
		$wing_flat_arrayy[]=array($wingg,$flatt);
	 }	
	
		$wing_flat_explodee=explode(',',$wing_flat);
		 $wing_idd=(int)$wing_flat_explodee[0];
		 $flat_idd=(int)$wing_flat_explodee[1];
        $n=0;
		for($k=0; $k<sizeof($wing_flat_arrayy); $k++){
	       $wing_flat_sub_array=$wing_flat_arrayy[$k];
		   $wing_id_from_array=(int)$wing_flat_sub_array[0];
		   $flat_id_from_array=(int)$wing_flat_sub_array[1];
		   if($wing_id_from_array==$wing_idd && $flat_id_from_array==$flat_idd){
			 $n++;  
		   }
		}
	if($n>1){
	$result="match_overlap";	
	}

echo $result;
}
//End wing_flat_validation//
//Start wing_flat_overlap_validation//
function wing_flat_overlap_validation($wing_flat=null,$owner_type=null)
{
	$s_society_id = $this->Session->read('hm_society_id');
    $wing_flat_array=array();
	$result="not_match";
	$this->loadmodel('user_enrollment_csv_converted'); 
	$order=array('user_enrollment_csv_converted.auto_id'=>'ASC');
	$conditions=array("society_id"=>(int)$s_society_id);
	$user_enrollment_csv_converted=$this->user_enrollment_csv_converted->find('all',array('conditions'=>$conditions,'order'=>$order));
	 foreach($user_enrollment_csv_converted as $data){
		$wing=(int)$data['user_enrollment_csv_converted']['wing']; 
		$flat=(int)$data['user_enrollment_csv_converted']['flat']; 
		$wing_flat_array[]=array($wing,$flat);
	 }	
	
		$wing_flat_explode=explode(',',$wing_flat);
		$wing_id=(int)$wing_flat_explode[0];
		$flat_id=(int)$wing_flat_explode[1];
        $n=0;
		for($k=0; $k<sizeof($wing_flat_array); $k++){
	       $wing_flat_sub_array=$wing_flat_array[$k];
		   $wing_id_from_array=(int)$wing_flat_sub_array[0];
		   $flat_id_from_array=(int)$wing_flat_sub_array[1];
		   if($wing_id_from_array==$wing_id && $flat_id_from_array==$flat_id){
			 $n++;  
		   }
		}
	if($n>1){
	$result="match";	
	}
	
echo $result;	
}
//End wing_flat_overlap_validation//

function switch_society(){
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$this->ath();
	$s_user_id=$this->Session->read('hm_user_id'); 
	$s_society_id = $this->Session->read('hm_society_id');
	$this->set("s_user_id",$s_user_id);
	$this->set("s_society_id",$s_society_id);
	
	if(isset($this->request->data['submit'])){ 
		$society_id=(int)$this->request->data["society_id"];
		$this->Session->write('hm_society_id', $society_id);
		$this->redirect(array('action' => 'Dashboard'));
	}
	
	$this->loadmodel('hms_right');
	$conditions =array('user_id' =>(int)$s_user_id);
	$hms_rights=$this->hms_right->find('all',array('conditions'=>$conditions));
	$this->set("hms_rights",$hms_rights);
}


function switch_society_member(){
	if($this->RequestHandler->isAjax()){
	$this->layout='blank';
	}else{
	$this->layout='session';
	}
	$this->ath();
	$s_user_id=$this->Session->read('hm_user_id'); 
	$s_society_id = $this->Session->read('hm_society_id');
	$this->set("s_user_id",$s_user_id);
	$this->set("s_society_id",$s_society_id);
	
	if(isset($this->request->data['submit'])){ 
		$society_id=(int)$this->request->data["society_id"];
		$user_flat_info=$this->requestAction(array('controller' => 'Fns', 'action' => 'user_flat_info_via_user_id_and_society_id'), array('pass' => array($s_user_id,$society_id)));
		$user_flat_id=$user_flat_info[0]["user_flat"]["user_flat_id"]; 
		$role_id=$this->requestAction(array('controller' => 'Fns', 'action' => 'fetch_default_role_via_user_id_and_society_id'), array('pass' => array($s_user_id,$society_id))); 
		$this->Session->write('role_id', $role_id);
		$this->Session->write('hm_user_id', $s_user_id);
		$this->Session->write('hm_user_flat_id', $user_flat_id);
		$this->Session->write('hm_society_id', $society_id);
		$this->redirect(array('action' => 'Dashboard'));
	}
	
	$this->loadmodel('user');
	$conditions =array('user_id' =>(int)$s_user_id);
	$result_user=$this->user->find('all',array('conditions'=>$conditions));
	$result_society=$result_user[0]['user']['society_id'];
	$this->set("result_society",$result_society);
	
}


}
?>
